this.JST=this.JST||{},this.JST["common/attachment-view-attachment-container"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="attachment-container" title="'+__e(title)+'"><div class="attachment-icon svg-common '+__e(name)+'"></div><div class="attachment-title"><p class="attachment-title-name">'+__e(fileName)+'</p><p class="attachment-title-type">'+__e(fileType)+'</p></div><div class="attachment-size">'+(null==(__t=size)?"":__t)+'</div><div class="attachment-download svg-common"></div><div class="attachment-mask" draggable="'+__e(!!draggable)+'"><div class="attachment-icon svg-common '+__e(name)+'"></div><div class="attachment-title"><p class="attachment-title-name">'+__e(fileName)+'</p><p class="attachment-title-type">'+__e(fileType)+'</p></div><div class="attachment-size">'+(null==(__t=size)?"":__t)+'</div><div class="attachment-download svg-common"></div></div></div>';return __p},this.JST["common/catalogue_view"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="catalogue-header cannot-edit"><div class="catalogue-refresh" title="刷新"><i class="svg-common src--svg--catalogue-refresh"></i></div><div class="catalogue-delete" title="删除"><i class="svg-common src--svg--catalogue_remove"></i></div></div><div class="para-text"></div>';return __p},this.JST["common/color_picker"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="color-picker-panel" tabindex="0"><div class="color-picker-panel-inner"><div class="color-picker-panel-board"><div class="color-picker-panel-board-hsv" style="background-color: rgb(255, 0, 0);"><div class="color-picker-panel-board-value"></div><div class="color-picker-panel-board-saturation"></div></div><span style="left: 126px; top: 93.5px;"></span></div><div class="color-picker-panel-wrap"><div class="color-picker-panel-wrap-ribbon"><div class="color-picker-panel-ribbon"><span style="left: 0%;"></span></div></div><div class="color-picker-panel-wrap-alpha"><div class="color-picker-panel-alpha"><div class="color-picker-panel-alpha-bg" style="background: linear-gradient(to right, rgba(57, 57, 57, 0), rgb(57, 57, 57));"></div><span style="left: 100%;"></span></div></div><div class="color-picker-panel-wrap-preview"><div class="color-picker-panel-preview"><span style="background-color: rgb(57, 57, 57); opacity: 1;"></span></div></div></div><div class="color-picker-panel-wrap" style="height: 40px; margin-top: 6px;"><div class="color-picker-panel-params"><div class="color-picker-panel-params-input"><input type="text" class="color-picker-panel-params-hex" maxlength="6" value="393939"><input type="number" value="57"><input type="number" value="57"><input type="number" value="57"><input type="number" value="100"></div><div class="color-picker-panel-params-lable"><label class="color-picker-panel-params-lable-hex">HEX</label><label class="color-picker-panel-params-lable-number">R</label><label class="color-picker-panel-params-lable-number">G</label><label class="color-picker-panel-params-lable-number">B</label><label class="color-picker-panel-params-lable-alpha">A</label></div></div></div></div></div></div>';return __p},this.JST["common/handwrite-view-container"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="handwrite-container"><img  src="'+(null==(__t=src)?"":__t)+'"/></div><p class="handwrite-copy-hack">select me</p>';return __p},this.JST["common/header-footer"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="header-footer-input" contenteditable="'+(null==(__t=readonly?"false":"true")?"":__t)+'"></div>';return __p},this.JST["common/high_light_item"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="high-light-item" style="left: '+(null==(__t=left)?"":__t)+"px; top: "+(null==(__t=top)?"":__t)+"px; height: "+(null==(__t=height)?"":__t)+"px; width: "+(null==(__t=width)?"":__t)+'px;"></div>';return __p},this.JST["common/image-title-input"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="image-title-input" contenteditable="true"style="position: absolute; left: '+__e(left)+"px; top: "+__e(top)+"px; width: "+__e(width)+"px; text-align: "+__e(textAlign)+"; min-height: "+__e(height)+'px;">'+__e(title)+'</div><div class="image-title-placeholder"style="position: absolute; left: '+__e(left)+"px; top: "+__e(top)+"px; width: "+__e(width)+"px; text-align: "+__e(textAlign)+"; min-height: "+__e(height)+'px;">输入标题</div>';return __p},this.JST["common/image-view-image-container"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="image-container"><img ',(width||height)&&(__p+=' class="filter-blur" '),__p+=' src="'+(null==(__t=src)?"":__t)+'"',width&&height?__p+=' style="width: '+__e(width)+"px; height: "+__e(height)+'px;"':width&&(__p+=' style="width: '+__e(width)+'px; height: auto;"'),__p+='/><div class="resize-handle" data-corner="0"></div><div class="resize-handle" data-corner="1"></div><div class="resize-handle" data-corner="2"></div><div class="resize-handle" data-corner="3"></div><div class="menu-wrapper"><div class="yne-button-group"><div class="yne-button-item yne-last" data-button-name="menu" title="快捷菜单"><span class="yne-button svg-common">快捷菜单</span><span class="yne-arrow-down svg-common"></span></div><div class="yne-clear"></div></div><ul class="yne-popup-menu"><li class="yne-popup-item" data-cm-name="image-title"><span>标题</span></li><li class="yne-popup-item" data-cm-name="float-left"><span>左浮动</span></li><li class="yne-popup-item" data-cm-name="float-right"><span>右浮动</span></li><li class="yne-popup-item" data-cm-name="clear-float"><span>清除浮动</span></li><li class="yne-popup-item" data-cm-name="clear-resize"><span>清除缩放</span></li>',hasOCR&&(__p+='<li class="yne-popup-item" data-cm-name="image-ocr"><span>文本识别OCR</span></li>'),__p+='<li class="yne-popup-item yne-popup-split"></li><li class="yne-popup-item" data-cm-name="delete"><span>删除图片</span></li><li class="yne-popup-item" data-cm-name="download"><span>另存为</span></li></ul></div></div><div class="image-title"></div><div class="image-split"></div><p class="image-copy-hack">select me</p>';return __p},this.JST["common/link_view"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="hover-menu hover-menu-show-link"><div class="hover-menu-before"></div><div class="hover-menu-body"><a href="'+(null==(__t=link)?"":__t)+"\" target='_blank'><span>"+(null==(__t=link)?"":__t)+"</span></a>",isReadOnly||(__p+='<div class="link-button"><span class="link-modify-button">编辑</span><span class="link-split">|</span><span class="link-remove-button">移除</span></div>'),__p+='</div></div><div class="hover-menu hover-menu-modify-link"><div class="hover-menu-before"></div><div class="hover-menu-body"><span class="link-label">链接</span><input class="link-input" type="text" name="link" value="'+(null==(__t=link)?"":__t)+'" /><div class="link-confirm-button"><span class="link-button-text">确定</span></div></div></div>';return __p},this.JST["common/list_item_view"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)isOrdered?__p+='<ol class="li-box"><li><div class="para-text"></div></li></ol>':__p+='<ul class="li-box"><li><div class="para-text"></div></li></ul>';return __p},this.JST["common/page_break_view"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="page-break"><span class="spanMark topSpan"></span><span class="spanMark middleSpan"></span><span class="spanMark bottomSpan"></span></div>';return __p},this.JST["common/paragraph_view"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="para-text"></div>';return __p},this.JST["common/table_cell_edit"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="cell-edit-box" contenteditable="true"></div>';return __p},this.JST["common/table_cell_resize"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="resize-up"></div><div class="resize-right"></div><div class="resize-down"></div><div class="resize-left"></div>';return __p},this.JST["common/table_view"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="table-layout"><div class="table-layout-inner" contentEditable="false"><div class="table-wrapper"><table><colgroup></colgroup><tbody></tbody></table><div class="row-resize-line"></div><div class="col-resize-line"></div></div></div></div>';return __p},this.JST["common/todo"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="todo-content"><label class="todo-mark" contenteditable="false"><span class="todo-inner"></span></label><div class="todo-input para-text"></div></div>';return __p},this.JST["pc/float-modifiers-li"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)for(index in allAttendees)__p+='<li id="'+(null==(__t=allAttendees[index].SID)?"":__t)+'" class="attendee"><span class="phote">',allAttendees[index].portrait?__p+='<i class="portrait" style="background-image:url('+(null==(__t=allAttendees[index].portrait)?"":__t)+');"></i>':__p+='<i class="portrait" style="background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAAGvZ15GAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUMzMzk1NzA1NDNFMTFFNTk5MURCMjJEMUNENUZFOTUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUMzMzk1NkY1NDNFMTFFNTk5MURCMjJEMUNENUZFOTUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RUNCQThDMTFDNDhBMTFERjg4MThCMUU5Rjk4RDBCMjQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RUNCQThDMTJDNDhBMTFERjg4MThCMUU5Rjk4RDBCMjQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4YtSJRAAAGIUlEQVR42lSKQQrAMAgEay1+IuBB//8l8eYnEhNLQqEDe9jZBTO7/tyV3jsittbmnEdVZ2YiEpGjAGDvm6dS3d3rm5mvGmOo6neJiCWAGNFsBOoAmfX7929ubm4mMIAaz87OLiYmJi8vj3DXfzCAMKA2Ai2CmAjRyMLKygp0N9z4hw8fAgQgg4xRAAZCIIghjY0/EO7/z7L0AdYZMJhcYnEcy6KzK/+Mn2Hb2T94OyhvK1WVmU8PXQVXxsGo6jRxjEqLEbGhiGwmmM3szbvW6iB3PK64+2COD5FlJLsEYJSMVSAGgSB6iIWIlVaKjeD//5SV2Aq292CPDYQLdxbBJOPM7Iw/phNF8/pjXdNZa9HKOaeUJHJyuTxJTtSDCf4550II2ODYPYJSymXCmFqrMj16gvgL095bpXmOMe5MWKEpQmfDEGst9pq41TxYVAFCRkNLcVaL45bjV75yxc45c86PHO9o996lKaEB6r1vrYkBAz+IpxljjIDeApBSBisMg0AQBcm1eBL//+dCLp5E0Fzalw4YWaWldA/BtHF2HWfmuzI/Fz2ZxXXB/F/bDM9BMCcyDSF0NlU5ZxgnE87zhEZ5fgHEH8JSgoizEevxLtKBTiOKlYn2YD6h9F+MmWOMMyduJq+1ZrqZD7h2M+liIp1u3/dlsPBMKR3HwUSm2YIjiQ958pSvNCZMq5lQzEQWCHbYz5qF955ghTKNwxon1VphWglmI/x+2TaSST7p34EuRpiO1Os3gA5KKffeywLO0YQU4RTjZc1XNhaR37PyAlEWMTYozx8LlyJaSeElAPPlsqsgEATRaPgASPj/v2NN2LvwOAfLEXEI8S7uJCboOD39qKpufuVaxPHPuPb/DG1xZO2VGJ6HYUCb+bosCyCiMtQI6j+S8g7ubpMzscO/x3GE6NkCRBQIpYZoQBQT4Lam7g7X7ExiKvOA7YV2lcMt0oILtjEBgjPEeGAdLLoOHNoWWoa8VjFPc9nc76hwQFoPpO19xV6JbmNrRyEPlyZq6u8nG6FoWLmVZbttJRu3qXF9uZnOA9eIkgOp5R/gbZ7n5D5Z93C2WlIbc+CYY5Qvai2gp2nyWRX7qpDr+Fq8WMoC3FCEkBXZFPQz2d1naCZSiCP4TJ5OGnEk0G2FhglJBLgDcSdsFBqjBIjdeuzZZz8m0H/ga9vJFr/QVIgUp8g3nrZy1Pc9tNRcXfLXKFzGLGQAi7TJt/ITCwGr/+vIVNFVvy7PFT2gArw1mDJVbO2ZeA6tLycXmmWzfKSVD5kjfst0alENzvqKcbVHq6enBb/IMQvv7gK0Y0YrDcRAFJVSHwTf+///ty2lTyIoHnPqJSTbZbNW8cEBl1WT7M1k5s6d3KeufUeCRv96HruHP2b/gIbqfq9fm6qjtKR0k5S0PCRVf+gMhmYgG3gQ+cpE4p1nKKfn+lWADDE7P8mBF3oTKCZcyx+9v0h7Jmk+FWMk2TxNE/RsyRVTaHMMkAgslsyXG7E4z6UjtU2TYHUMs5A0lEi4VKYMAw/HkH2YX5KpRKMP4vOMaa4WHCPpwsmQLiNxWH8DsRZQzQ08lX8zmuGr257VMXKdheCxWLOBLVkmjUZEjGZNakr207d4awHpIWPI/NrCK7vrTVpuRpY3tgrQa7F6xSFjLtre6R5Zc+5rAb0VY4sENc3m+Xy+hem9WBOCRi6uvVwup9OJRerLmy08VDsWKKzLRskXiK6molxp1imtzIQY2YZXHgteWQXIHeeizWRhaRQVaMAEXyM2TJxABx8gXorxoriRsZo1hwFlZs4ixM9X/WRyONowv0bR19PrFYaZutbYyRQMxzRysm4D8+7TKnEVOsVEsyWGoulV+RwNWpmCyjE1m0uQ9u0oc5X0PL3OktVY5BaPLMVQ2gZw5Ph6V/c4ahKyN7d0AMuuww5/DNDhcGAfuTFMoV4m/tn6Iykw97kYaMBEzs4Dsj+Sciw9eMXcnu3Xh6pHkrT2q+KE3SIBAJebPoNkb03eF+OF0wEN/lyIu7sYruIrx+MRb5k3ItubCMSdUhCNIbX8gv7HSXwOL6TSfQLiB22gWDHQ+J+XUz8NiKgwQ3nx1DilD+SpF4rN641ZAAAAAElFTkSuQmCC);"></i>',__p+='<i class="color-bg"></i><i class="color" style="background-color:'+(null==(__t=allAttendees[index].color)?"":__t)+';"></i></span><span class="nickname">'+(null==(__t=allAttendees[index].nickname)?"":__t)+"</span></li>";return __p},this.JST["pc/float-modifiers"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div id="attendee-dialog"><div id="attendee-hint"><i id="attendee-icon"></i><span id="attendee-num"><span id="attend-num-span">1</span><span>人正在编辑</span></span></div><ul id="attendee-list"></ul></div>';return __p},this.JST["pc/presenter_article"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<h1 style="text-align: center; font-size: 48px; margin-top: 100px; margin-bottom: 100px;">'+(null==(__t=title)?"":__t)+'</h1><article class="editor-area"ng-mouseover="over()"ng-mouseleave="leave()"style="padding: 10px 0 10px 0;">'+(null==(__t=content)?"":__t)+"</article>";return __p},this.JST["pc/presenter_page"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="demo-page"><iframe frameborder="none" class="note-content"></iframe><div class="tool-bar" ng-class="{show : inDemoArea}"><div><i class="demo-mode-icon zoom-in-icon" title="放大" data-action="zoom-in"></i></div><div><i class="demo-mode-icon zoom-out-icon" title="缩小" data-action="zoom-out"></i></div><div><i class="demo-mode-icon esc-icon" title="退出" data-action="esc"></i></div></div></div>';return __p},this.JST["pc/toolbar-button-template"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="button-wrapper button-wrapper-'+(null==(__t=name)?"":__t)+'" title="'+(null==(__t=label)?"":__t)+'"><div class="button button-'+(null==(__t=name)?"":__t)+' svg-common"></div><div class="button-text" ',text||(__p+=' style="display:none;" '),__p+=" >"+(null==(__t=text)?"":__t)+"</div></div>";return __p},this.JST["pc/toolbar-combo-box-align"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span>',text&&(__p+='<span class="combo-text combo-text-'+(null==(__t=name)?"":__t)+'">'+__e(text)+"</span>"),__p+='</div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'"><span class="combo-item-icon-'+(null==(__t=name)?"":__t)+" "+(null==(__t=key)?"":__t)+' svg-common">&nbsp;</span><span class="combo-item-span-'+(null==(__t=name)?"":__t)+'">'+(null==(__t=items[key])?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["pc/toolbar-combo-box-back-color"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value svg-common combo-value-'+(null==(__t=name)?"":__t)+'"><span class="combo-value-buttom-color"></span></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'"><div class="color-section color-section-default combo-item" data-value="'+(null==(__t=defaultValue)?"":__t)+'"><div class="color-cell combo-item back-color-cell-default" data-value="'+(null==(__t=defaultValue)?"":__t)+'" style="background-color:'+(null==(__t=defaultValue)?"":__t)+';"></div><div class="color-label color-label-default">默认无背景色</div></div><hr class="color-section-split"><div class="color-section color-section-theme"><div class="color-label color-label-theme">主题颜色</div><div class="color-row">';for(key in items.theme)__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.theme[key])?"":__t)+'" style="background-color:'+(null==(__t=items.theme[key])?"":__t)+';"></div>';__p+='</div><div class="color-row-split"></div><div class="color-part-theme">';for(row in items.other){__p+='<div class="color-row">';for(key in items.other[row])__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.other[row][key])?"":__t)+'" style="background-color:'+(null==(__t=items.other[row][key])?"":__t)+';"></div>';__p+="</div>"}__p+='</div></div><hr class="color-section-split"><div class="color-section color-section-standard"><div class="color-label color-label-standard">推荐颜色</div><div class="color-row">';for(key in items.standard)__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.standard[key])?"":__t)+'" style="background-color:'+(null==(__t=items.standard[key])?"":__t)+';"></div>';__p+='</div></div><hr class="color-section-split"><div class="color-section color-section-other combo-item"><div class="color-img-other"></div><div class="color-label color-label-other">其他颜色</div><div></div></div>'}return __p},this.JST["pc/toolbar-combo-box-color"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"><span class="combo-value-buttom-color"></span></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'"><div class="color-section color-section-default combo-item" data-value="'+(null==(__t=defaultValue)?"":__t)+'"><div class="color-cell combo-item color-cell-default" data-value="'+(null==(__t=defaultValue)?"":__t)+'" style="background-color:'+(null==(__t=defaultValue)?"":__t)+';"></div><div class="color-label color-label-default">默认颜色</div></div><hr class="color-section-split"><div class="color-section color-section-theme"><div class="color-label color-label-theme">主题颜色</div><div class="color-row">';for(key in items.theme)__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.theme[key])?"":__t)+'" style="background-color:'+(null==(__t=items.theme[key])?"":__t)+';"></div>';__p+='</div><div class="color-row-split"></div><div class="color-part-theme">';for(row in items.other){__p+='<div class="color-row">';for(key in items.other[row])__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.other[row][key])?"":__t)+'" style="background-color:'+(null==(__t=items.other[row][key])?"":__t)+';"></div>';__p+="</div>"}__p+='</div></div><hr class="color-section-split"><div class="color-section color-section-standard"><div class="color-label color-label-standard">推荐颜色</div><div class="color-row">';for(key in items.standard)__p+='<div class="color-cell combo-item" data-value="'+(null==(__t=items.standard[key])?"":__t)+'" style="background-color:'+(null==(__t=items.standard[key])?"":__t)+';"></div>';__p+='</div></div><hr class="color-section-split"><div class="color-section color-section-other combo-item"><div class="color-img-other"></div><div class="color-label color-label-other">其他颜色</div><div></div></div>'}return __p},this.JST["pc/toolbar-combo-box-font-family"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(font in items)__p+='<li class="combo-item" data-value="'+(null==(__t=items[font].singleValue)?"":__t)+'"><span style="font-family:'+(null==(__t=items[font].fullValue)?"":__t)+';">'+(null==(__t=items[font].name)?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["pc/toolbar-combo-box-font-size"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'"><span>'+(null==(__t=items[key])?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["pc/toolbar-combo-box-heading"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+'"></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'"><span style="font-size: '+(null==(__t=items[key]["font-size"])?"":__t)+'px">'+(null==(__t=items[key].name)?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["pc/toolbar-combo-box-insert-link"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="combo-display-wrapper combo-link-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper combo-value-wrapper-'+(null==(__t=name)?"":__t)+'"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span><span class="combo-text" ',text||(__p+=' style="display:none;" '),__p+=" >"+(null==(__t=text)?"":__t)+'</span></div></div><div class="combo-menu-wrapper  wrapper-'+(null==(__t=name)?"":__t)+'"><div class="combo-menu-'+(null==(__t=name)?"":__t)+'"><span class="link-label">链接</span><input class="link-input" type="text" name="link" placeholder="输入链接" /><div class="link-button"><span class="link-button-text">确定</span></div></div></div>';return __p},this.JST["pc/toolbar-combo-box-line-height"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(idx in items)__p+='<li class="combo-item" data-value="'+(null==(__t=items[idx].key)?"":__t)+'"><span class="combo-item-icon-'+(null==(__t=name)?"":__t)+" line-height-"+(null==(__t=idx)?"":__t)+'">&nbsp;</span><span class="combo-item-span-'+(null==(__t=name)?"":__t)+'">'+(null==(__t=items[idx].value)?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["pc/toolbar-combo-box-set-background"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span><span class="combo-text combo-text-'+(null==(__t=name)?"":__t)+'">纸张背景</span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'"><div class="background-section-top">';for(row in items.normalUser){__p+='<div class="background-row">';for(key in items.normalUser[row])"NoBackground"===items.normalUser[row][key]?__p+='<div class="background-cell combo-item" data-value="'+(null==(__t=items.normalUser[row][key])?"":__t)+'"><svg class="background-cell-check-mark" xmlns="http://www.w3.org/2000/svg" viewBox="-16 -16 52 52"><path d="M1.05584113,8.97696545 C0.884930054,8.78831051 0.877161369,8.59965557 1.03253508,8.41100063 L1.52196226,7.7742902 C1.6617986,7.56991402 1.84047836,7.53847153 2.05800155,7.67996273 L6.39292802,10.6748599 C6.79689966,10.9421211 7.19310261,10.9185392 7.58153688,10.6041143 L19.1180347,0.982712344 C19.3044832,0.825499894 19.4831629,0.833360516 19.654074,1.00629421 L19.9104406,1.26569475 C20.0813517,1.43862845 20.0813517,1.61942277 19.9104406,1.80807771 L7.53492477,14.5187043 C7.17756524,14.880293 6.8279744,14.8881536 6.48615224,14.5422862 L1.05584113,8.97696545 Z"/></svg></div>':__p+='<div class="background-cell combo-item" data-value="'+(null==(__t=items.normalUser[row][key])?"":__t)+'" style="background-image:url(\''+(null==(__t=items.normalUser[row][key])?"":__t)+'\');"><svg class="background-cell-check-mark" xmlns="http://www.w3.org/2000/svg" viewBox="-16 -16 52 52"><path d="M1.05584113,8.97696545 C0.884930054,8.78831051 0.877161369,8.59965557 1.03253508,8.41100063 L1.52196226,7.7742902 C1.6617986,7.56991402 1.84047836,7.53847153 2.05800155,7.67996273 L6.39292802,10.6748599 C6.79689966,10.9421211 7.19310261,10.9185392 7.58153688,10.6041143 L19.1180347,0.982712344 C19.3044832,0.825499894 19.4831629,0.833360516 19.654074,1.00629421 L19.9104406,1.26569475 C20.0813517,1.43862845 20.0813517,1.61942277 19.9104406,1.80807771 L7.53492477,14.5187043 C7.17756524,14.880293 6.8279744,14.8881536 6.48615224,14.5422862 L1.05584113,8.97696545 Z"/></svg></div>';__p+="</div>"}__p+='</div><hr class="background-section-split"><div class="background-section-bottom"><div class="background-label background-label-vip">会员特权</div>';for(row in items.VIP){__p+='<div class="background-row">';for(key in items.VIP[row])"NoBackground"===items.VIP[row][key]?__p+='<div class="background-cell combo-item" data-value="'+(null==(__t=items.VIP[row][key])?"":__t)+'"><svg class="background-cell-check-mark" xmlns="http://www.w3.org/2000/svg" viewBox="-16 -16 52 52"><path d="M1.05584113,8.97696545 C0.884930054,8.78831051 0.877161369,8.59965557 1.03253508,8.41100063 L1.52196226,7.7742902 C1.6617986,7.56991402 1.84047836,7.53847153 2.05800155,7.67996273 L6.39292802,10.6748599 C6.79689966,10.9421211 7.19310261,10.9185392 7.58153688,10.6041143 L19.1180347,0.982712344 C19.3044832,0.825499894 19.4831629,0.833360516 19.654074,1.00629421 L19.9104406,1.26569475 C20.0813517,1.43862845 20.0813517,1.61942277 19.9104406,1.80807771 L7.53492477,14.5187043 C7.17756524,14.880293 6.8279744,14.8881536 6.48615224,14.5422862 L1.05584113,8.97696545 Z"/></svg></div>':__p+='<div class="background-cell combo-item" data-value="'+(null==(__t=items.VIP[row][key])?"":__t)+'" style="background-image:url(\''+(null==(__t=items.VIP[row][key])?"":__t)+'\');"><svg class="background-cell-check-mark" xmlns="http://www.w3.org/2000/svg" viewBox="-16 -16 52 52"><path d="M1.05584113,8.97696545 C0.884930054,8.78831051 0.877161369,8.59965557 1.03253508,8.41100063 L1.52196226,7.7742902 C1.6617986,7.56991402 1.84047836,7.53847153 2.05800155,7.67996273 L6.39292802,10.6748599 C6.79689966,10.9421211 7.19310261,10.9185392 7.58153688,10.6041143 L19.1180347,0.982712344 C19.3044832,0.825499894 19.4831629,0.833360516 19.654074,1.00629421 L19.9104406,1.26569475 C20.0813517,1.43862845 20.0813517,1.61942277 19.9104406,1.80807771 L7.53492477,14.5187043 C7.17756524,14.880293 6.8279744,14.8881536 6.48615224,14.5422862 L1.05584113,8.97696545 Z"/></svg></div>';__p+="</div>"}__p+="</div></div></div>"}return __p},this.JST["pc/toolbar-combo-box-show-more"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="toolbar-more-split"></div><div class="combo-display-wrapper combo-showmore-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper combo-value-wrapper-'+(null==(__t=name)?"":__t)+'"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common">更多</span><span class="combo-expand-gray svg-common"></span></div></div><div class="combo-menu-wrapper  wrapper-'+(null==(__t=name)?"":__t)+'"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'"></div></div>';return __p},this.JST["pc/toolbar-combo-box-table"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper combo-display-wrapper-'+(null==(__t=name)?"":__t)+'" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper combo-value-wrapper-'+(null==(__t=name)?"":__t)+'"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span><span class="combo-text" ',text||(__p+=' style="display:none;" '),__p+=" >"+(null==(__t=text)?"":__t)+'</span></div></div><div class="combo-menu-wrapper"><div class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(var i=0;i<maxRows;i++)for(var j=0;j<maxCols;j++)__p+='<span class="combo-item" data-row="'+(null==(__t=i)?"":__t)+'" data-col="'+(null==(__t=j)?"":__t)+'"></span>';__p+='<div class="combo-menu-label-'+(null==(__t=name)?"":__t)+'">插入表格</div></div></div>'}return __p},this.JST["pc/toolbar-combo-box-template"]=function(obj){obj||(obj={});var __t,__p="",__e=_.escape;with(obj)__p+='<div class="combo-display-wrapper"><div class="combo-value-wrapper"></div><div class="combo-expand-wrapper"></div></div><div class="combo-menu-wrapper"></div>';return __p},this.JST["pc/toolbar-combo-box-zoom"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj){__p+='<div class="combo-display-wrapper" title="'+(null==(__t=label)?"":__t)+'"><div class="combo-value-wrapper"><span class="combo-value combo-value-'+(null==(__t=name)?"":__t)+' svg-common"></span></div><div class="combo-expand-wrapper"><span class="combo-expand svg-common"></span></div></div><div class="combo-menu-wrapper"><ul class="combo-menu combo-menu-'+(null==(__t=name)?"":__t)+'">';for(key in items)__p+='<li class="combo-item" data-value="'+(null==(__t=key)?"":__t)+'"><span>'+(null==(__t=items[key])?"":__t)+"</span></li>";__p+="</ul></div>"}return __p},this.JST["pc/toolbar_view"]=function(obj){function print(){__p+=__j.call(arguments,"")}obj||(obj={});var __t,__p="",__e=_.escape,__j=Array.prototype.join;with(obj)__p+='<div class="toolbar-container">',
_.each(items,function(a,b){"button"===a.type?__p+='<button class="'+(null==(__t=b)?"":__t)+'" action="'+(null==(__t=a.action)?"":__t)+'" name="'+(null==(__t=a.name)?"":__t)+'" type="button" data-yne-is-block="'+(null==(__t=!!a.block)?"":__t)+'">'+(null==(__t=a.label)?"":__t)+"</button>":"select"===a.type&&(__p+='<select class="'+(null==(__t=b)?"":__t)+'" action="'+(null==(__t=a.action)?"":__t)+'" name="'+(null==(__t=a.name)?"":__t)+'" data-yne-is-block="'+(null==(__t=!!a.block)?"":__t)+'">',_.each(a.options,function(a,b){__p+='<option value="'+(null==(__t=b)?"":__t)+'">'+(null==(__t=a)?"":__t)+"</option>"}),__p+="</select>")}),__p+="</div>";return __p};var yne_jtk_core_L,yne_backbone,yne_underscore,yne_jquery,yne_common_constants,yne_jtk_core_Class,yne_common_key_keyCodeMap,yne_common_key_KeyMonitor,yne_common_selection_BlockRange,yne_common_data_blockTypes,yne_common_util_platform,yne_common_selection_AttachmentRange,yne_common_selection_ImageRange,yne_common_util_freeze,yne_common_data_xmlBlockStyleConfig,yne_common_data_supportedBlockStyles,yne_collaboration_collabUtils,yne_common_data_Block,yne_jtk_core_assert,yne_common_util_schemaVersion,yne_common_data_xmlFont,yne_tinycolor,yne_common_data_xmlInlineStyleConfig,yne_common_data_supportedInlineStyles,yne_common_util_unknownInlineStyles,yne_common_util_codePointAt,yne_common_util_clearString,yne_common_util_toCharArrayByCodePoint,yne_common_data_RichText,yne_common_fontMaps,yne_common_data_inlineStyleToCss,yne_common_util_xssFilter,yne_common_data_Rich2HtmlConvertor,yne_common_util_unknownTree,yne_common_util_blockStyles,yne_common_util_convertPlain,yne_common_util_countText,yne_common_data_Paragraph,yne_underscorestring,yne_common_data_listItemMarker,yne_common_data_List,yne_common_data_ListItem,yne_common_selection_ParagraphRange,yne_common_selection_HeaderFooterRange,yne_common_selection_HandWriteRange={},yne_common_util_rect,yne_jtk_web_dom_nodeType,yne_common_data_table_tableCellType,yne_common_data_table_Resource,yne_common_util_parseImgSource,yne_common_util_xml,yne_jtk_web_dom_parseHTML,yne_common_util_formatLocalSource,yne_common_data_table_AttachmentResource,yne_common_data_table_ImageResource,yne_common_data_table_Lines,yne_common_data_table_tableCellUtil,yne_common_data_table_tableRenderer,yne_common_data_table_resourceClassMap,yne_common_data_table_blockStyleConfig,yne_common_data_table_supportedBlockStyles,yne_common_data_Todo,yne_common_data_table_TableCell,yne_common_data_table_constantConfig,yne_common_data_table_tableUtil,yne_common_data_tableDataCheck_createBlankCell,yne_common_data_tableDataCheck_createBlankTable,yne_common_data_tableDataCheck_size,yne_common_data_tableDataCheck_cellValue,yne_common_data_tableDataCheck_mergeDefaults,yne_common_data_tableDataCheck_mergeCells,yne_common_data_tableDataCheck_checkAndFix,yne_common_util_forEachTimes,yne_common_data_Table,yne_common_selection_table_RectRange,yne_common_selection_TableRange,yne_common_selection_HrRange,yne_common_selection_UnknownRange,yne_common_selection_blockRangeUtil,yne_common_selection_NoteRangeWalker,yne_common_selection_NoteRange,yne_common_selection_nativeSelection,yne_common_selection_CatalogueRange,yne_common_selection_HeadingRange,yne_common_selection_ListItemRange,yne_common_selection_TodoRange,yne_common_selection_BlockRangeMap,yne_common_jst,yne_common_views_PageBreakView,yne_common_views_BlockView,yne_tooltipster,yne_common_util_userAgent,yne_common_util_attachmentParse,yne_common_views_AttachmentView,yne_common_util_noteLink,yne_common_views_ParagraphView,yne_common_commands_link_LinkMatch,yne_common_views_CatalogueView,yne_common_views_HandWriteView={},yne_common_views_HeadingView,yne_common_views_HrView,yne_common_util_autoAdjustMenu,yne_common_util_uniqueSuffix,yne_common_util_httpsConvert,yne_common_util_parseImageResourceId={},yne_common_views_ImageView,yne_common_views_ListItemView,yne_common_util_events,yne_jtk_core_Base,yne_common_util_Draggable,yne_jtk_web_dom_remove,yne_common_views_table_SelectionView,yne_common_key_KeyHandlerManager,yne_common_views_table_ChangeMonitor,yne_parser_html_handlers_tagHandlers,yne_parser_html_utils_convertColor,yne_parser_html_handlers_styleHandlers,yne_parser_html_handlers_BaseHandler,yne_common_util_headingMaps,yne_common_data_Heading,yne_parser_html_utils_handleParagraphSpaces,yne_common_data_Catalogues,yne_common_data_Catalogue,yne_parser_html_handlers_ParagraphHandler,yne_parser_html_handlers_DocumentHandler,yne_parser_html_handlers_UnknownHandler,yne_cssom,yne_specificity,yne_parser_html_cssParser_CSSParser,yne_parser_html_Parser,yne_parser_html_mathTags,yne_parser_html_svgTags,yne_parser_html_handlers_AnchorHandler,yne_parser_html_handlers_InlineHandler,yne_parser_html_handlers_BreakHandler,yne_common_data_Hr,yne_parser_html_handlers_HrHandler,yne_common_data_Image,yne_common_data_Attachment,yne_common_data_HandWrite={},yne_parser_html_handlers_ImageHandler,yne_parser_html_handlers_ListHandler,yne_parser_html_handlers_ListItemHandler,yne_parser_html_utils_isWhiteColor,yne_parser_html_handlers_TableHandler,yne_parser_html_handlers_TodoHandler,yne_parser_html_handlers_handlerMap,yne_parser_html_tagConfig,yne_parser_html_mso_ListHandler,yne_parser_html_convert,yne_common_views_table_cellEdit_Commander,yne_common_views_table_cellEdit_CmdBall,yne_common_views_table_cellEditCmds_fontSize,yne_common_views_table_cellEditCmds_applyInlineStyle,yne_common_views_table_cellEditCmds_styleCmdMap,yne_common_views_table_cellEditCmds_applyInlineStyles,yne_common_commands_utils_href,yne_common_views_table_cellEditCmds_insertLink,yne_common_views_table_cellEditCmds_undo,yne_common_views_table_cellEditCmds_redo,yne_common_views_table_cellEdit_createCommander,yne_common_views_table_cellEdit_toolbarAdapter,yne_common_views_table_cellEdit_cellLink,yne_common_views_table_cellEdit_jsonRange,yne_common_views_table_cellEdit_History,yne_common_views_table_cellEditKey_enter,yne_common_views_table_cellEditKey_altEnter,yne_common_views_table_cellEditKey_esc,yne_common_views_table_cellEditKey_editInlineStyle,yne_common_views_table_cellEditKey_undo,yne_common_views_table_cellEditKey_redo,yne_common_views_table_cellEditKey_save,yne_common_views_table_cellEditKey_keyConfig,yne_common_views_table_CellEditView,yne_common_views_table_HiddenInputView,yne_common_util_direction,yne_common_views_table_CellResizeView,yne_common_data_table_resourceRenderer,yne_parser_plain_createRichText,yne_parser_plain_parseLine,yne_parser_plain_convert,yne_parser_json_createBlock,yne_parser_json_convert,yne_parser_ocr_convert,yne_parser_Parser,yne_jtk_core_str_base64,yne_common_util_DataTransfer,yne_common_util_ClipboardData,yne_common_views_table_key_toggleInlineStyle,yne_common_views_table_key_directions,yne_common_views_table_key_clearSelection,yne_common_views_table_key_save,yne_common_views_table_key_selectAll,yne_common_views_table_key_undoRedo,yne_common_views_table_key_preventedKeys,yne_common_views_table_key_paste,yne_common_views_table_key_keyConfig,yne_common_views_TableView,yne_common_views_TodoView,yne_common_views_UnknownView,yne_common_views_BlockViewMapper,yne_common_views_HighlightView,yne_common_data_HeaderFooter,yne_common_util_insertTextAtCursor,yne_common_views_HeaderFooterView,yne_common_views_NoteView,yne_pc_views_NoteView,yne_common_data_Unknown,yne_common_data_blockMap,yne_common_util_ListItemNode,yne_common_data_Note,yne_common_selection_SelectionChangeEvent,yne_common_selection_NoteSelection,yne_common_commands_Command,yne_common_selection_rangeUtil,yne_common_commands_CompositeCommand,yne_common_commands_commandClassMap,yne_common_commands_ManagerAdapter,yne_common_commands_CommandManager,yne_common_commands_SimpleCommand,yne_common_commands_atomicCommands_DeleteBlockText,yne_common_data_blockUtils,yne_common_commands_atomicCommands_DeleteBlocks,yne_common_commands_atomicCommands_InsertBlocks,yne_common_commands_atomicCommands_InsertBlockText,yne_common_commands_atomicCommands_SetInlineStyle,yne_common_commands_atomicCommands_SetBlockStyle,yne_common_commands_atomicCommands_table_SetTableCellInlineStyle,yne_common_commands_atomicCommands_table_SetTableCellBlockStyle,yne_common_commands_atomicCommands_table_SetTableCellAttr,yne_common_commands_utils_CompCmdUtils,yne_common_commands_compCommands_AppendBlank,yne_common_commands_compCommands_ApplyStyles,yne_common_commands_abstractCommands_DeleteNoteRange,yne_common_commands_compCommands_DeleteNoteRange,yne_common_commands_compCommands_DragBlocks,yne_common_commands_compCommands_FormatPainter,yne_common_commands_atomicCommands_SetListItemLevel,yne_common_commands_compCommands_IndentOutdent,yne_common_commands_abstractCommands_InsertResource,yne_common_commands_atomicCommands_table_SetTableCellContent,yne_common_commands_compCommands_InsertAttachment,yne_common_commands_compCommands_InsertBlocks,yne_common_commands_compCommands_InsertCatalogue,yne_common_commands_compCommands_InsertHeading,yne_common_commands_compCommands_InsertHorizontalRule,yne_common_commands_compCommands_InsertImage,yne_common_commands_atomicCommands_SetCatalogueHref,yne_common_commands_compCommands_InsertLink,yne_common_commands_atomicCommands_SetListType,yne_common_commands_compCommands_InsertList,yne_common_commands_compCommands_InsertTable,yne_common_commands_compCommands_InsertTodo,yne_common_commands_compCommands_KeyBackspace,yne_common_commands_compCommands_KeyDelete,yne_common_commands_compCommands_KeyEnter,yne_common_commands_compCommands_KeyTab,yne_common_commands_compCommands_KeyTextInput,yne_common_commands_compCommands_RemoveFormat,yne_common_commands_atomicCommands_SetResourceProps,yne_common_commands_compCommands_ReplaceResource,yne_common_commands_compCommands_RefreshCatalogue,yne_common_commands_compCommands_SetHeaderFooter,yne_common_commands_atomicCommands_SetBlockProps,yne_common_commands_compCommands_SetBlockProps,yne_common_commands_atomicCommands_table_SetTableCellSize,yne_common_commands_compCommands_table_SetTableCellsSize,yne_common_commands_atomicCommands_table_InsertTableRowCol,yne_common_commands_compCommands_table_InsertTableRowCol,yne_common_commands_atomicCommands_table_DeleteTableRowCol,yne_common_commands_compCommands_table_DeleteTableRowCol,yne_common_commands_compCommands_table_SetTableCellContent,yne_common_commands_compCommands_table_ToggleMergeTableCell,yne_common_commands_compCommands_table_SetTableCellBlockStyle,yne_common_commands_compCommands_table_InsertTableCells,yne_common_commands_compCommands_table_SetTableCellInlineStyle,yne_common_commands_exportCommands,yne_common_commands_CommandFactory,yne_common_util_base64Helper,yne_common_key_backspace,yne_common_key_del,yne_common_key_down,yne_common_key_enter,yne_common_key_esc,yne_common_key_space,yne_common_key_tab,yne_common_key_up,yne_common_key_shortcut_bold,yne_common_key_shortcut_insertDate,yne_common_key_shortcut_italic,yne_common_key_shortcut_redo,yne_common_key_shortcut_reloadPage,yne_common_key_shortcut_save,yne_common_key_shortcut_underline,yne_common_key_shortcut_undo,yne_common_key_shortcut_selectAll,yne_common_key_shortcut_copy_cut,yne_common_key_shortcut_paste,yne_common_key_shortcut_find,yne_common_key_shortcut_shiftTab,yne_common_key_shortcut_zoomIn,yne_common_key_shortcut_zoomOut,yne_common_key_shortcut_modBackspace,yne_common_key_shortcut_modDel,yne_common_key_shortcut_deleteToEnd,yne_common_key_shortcut_deleteForward,yne_common_key_shortcut_insertHeading,yne_common_key_shortcut_strike,yne_common_key_shortcut_insertList,yne_common_key_shortcut_insertTodo,yne_common_key_shortcut_insertHR,yne_common_key_keyConfig,yne_common_core_Controller,yne_pc_util_convertHtmlWithResMap,yne_pc_core_PcController,yne_pc_toolbar_Panel,yne_pc_toolbar_CommonButton,yne_jtk_core_fn_noop,yne_pc_toolbar_BaseSplit,yne_pc_toolbar_BaseButton,yne_pc_toolbar_TextButton,yne_pc_toolbar_FullScreenButton,yne_pc_toolbar_ToggleTabButton,yne_pc_toolbar_ToggleAllItems,yne_pc_toolbar_BaseComboBox,yne_pc_toolbar_block_BaseBlockComboBox,yne_pc_toolbar_block_Align,yne_pc_toolbar_block_Indent,yne_pc_toolbar_block_LineHeight,yne_pc_toolbar_block_BaseBlockButton,yne_pc_toolbar_block_OrderedList,yne_pc_toolbar_block_Outdent,yne_pc_toolbar_block_UnorderedList,yne_pc_toolbar_config_colors,yne_pc_toolbar_BaseColorComboBox,yne_pc_toolbar_inline_BaseInlineColorComboBox,yne_pc_toolbar_inline_BackColor,yne_pc_toolbar_inline_BaseInlineButton,yne_pc_toolbar_inline_Bold,yne_pc_toolbar_inline_Color,yne_pc_toolbar_inline_BaseInlineComboBox,yne_pc_toolbar_inline_FontFamily,yne_common_fontSize,yne_pc_toolbar_inline_FontSize,yne_pc_toolbar_inline_Italic,yne_pc_toolbar_inline_Strike,yne_pc_toolbar_inline_Underline,yne_pc_toolbar_insert_BaseInsertButton,yne_pc_toolbar_insert_InsertAttachment,yne_pc_toolbar_insert_InsertHorizontalRule,yne_pc_toolbar_insert_InsertImage,yne_pc_toolbar_insert_InsertLink,yne_pc_toolbar_insert_InsertTable,yne_pc_toolbar_insert_InsertHeading,yne_pc_toolbar_insert_InsertCatalogue,yne_pc_toolbar_insert_InsertTodo,yne_pc_toolbar_other_ExportPdf,yne_pc_toolbar_other_ExportWord,yne_pc_toolbar_other_DownloadOriginFile,yne_common_util_FormatPainterManager,yne_pc_toolbar_other_FormatPainter,yne_pc_toolbar_other_PageMode,yne_pc_toolbar_other_Redo,yne_pc_toolbar_other_RemoveFormat,yne_pc_toolbar_other_SaveAndSync,yne_pc_toolbar_other_SnapScreen,yne_pc_toolbar_other_Undo,yne_pc_toolbar_other_showMore,yne_pc_toolbar_other_Zoom,yne_common_util_typeConverter,yne_pc_toolbar_other_SetBackground,yne_pc_toolbar_textButton_Edit,yne_pc_toolbar_textButton_Insert,yne_pc_toolbar_textButton_More,yne_pc_toolbar_textButton_View,yne_pc_toolbar_textButton_Export,yne_pc_toolbar_table_Justify,yne_pc_toolbar_table_Wrap,yne_pc_toolbar_table_OperateTable,yne_pc_toolbar_table_TableSplit,yne_pc_toolbar_table_MergeCell,yne_pc_toolbar_other_NotTableSplit,yne_pc_toolbar_buttonClassMap,yne_pc_toolbar_ToolPanel,yne_pc_toolbar_TabHead,yne_pc_toolbar_buttonStateMap,yne_pc_toolbar_EditPanel,yne_pc_toolbar_InsertPanel,yne_pc_toolbar_MorePanel,yne_pc_toolbar_ViewPanel,yne_pc_toolbar_ExportPanel,yne_pc_toolbar_TabBody,yne_pc_toolbar_BigToolbar,yne_common_contextMenu_ContextMenuItem,yne_common_contextMenu_ContextMenu,yne_common_contextMenu_split,yne_pc_contextMenu_undo,yne_pc_contextMenu_redo,yne_pc_contextMenu_removeNoteLink,yne_common_contextMenu_cut,yne_common_contextMenu_copy,yne_pc_contextMenu_paste,yne_pc_contextMenu_pasteNoteLink,yne_pc_contextMenu_pasteAsText,yne_common_contextMenu_ImageTitle,yne_common_util_imgSize,yne_common_contextMenu_ImageZoomMenuItem,yne_pc_contextMenu_imageZoom,yne_pc_contextMenu_imageClearZoom,yne_common_contextMenu_ImageRotationMenuItem,yne_pc_contextMenu_imageLeftRotation,yne_pc_contextMenu_imageRightRotation,yne_common_contextMenu_AttachmentFloatMenuItem,yne_pc_contextMenu_attachmentFloat,yne_common_contextMenu_selectAll,yne_common_contextMenu_removeFormat,yne_common_contextMenu_recogOCR,yne_pc_contextMenu_attachmentSaveAs,yne_pc_contextMenu_imageSaveAs,yne_pc_contextMenu_share,yne_pc_contextMenu_insertDate,yne_common_contextMenu_countWords,yne_common_contextMenu_table_insertRowUp,yne_common_contextMenu_table_insertRowDown,yne_common_contextMenu_table_deleteRow,yne_common_contextMenu_table_insertColLeft,yne_common_contextMenu_table_insertColRight,yne_common_contextMenu_table_deleteCol,yne_common_contextMenu_table_toggleMergeCell,yne_common_contextMenu_table_deleteTable,yne_pc_contextMenu_config,yne_YEvent={},yne_DataTypes_ICollabJSON={},yne_DataTypes_DataTypes={},yne_ExternalLibs={},yne_YEventNames={},yne_Utils={},yne_CollabKeyTranslator={},yne_CmdCollabPropsHandler={},yne_WebSocketClient={},yne_NonDataCmdHandler={},yne_CollabSessionHandler={},yne_BlockLockHandler={},yne_CmdMergeHandler={},yne_CollabConflictHandler={},yne_RedoUndoHandler={},yne_DataCmdHandler={},yne_CollabEngine={},yne_collaboration_editorCollabExtension,yne_common_core_Editor,yne_common_contextMenu_queryCache,yne_common_util_attachmentPresentProcess,yne_pc_presenter_Presenter,yne_common_views_LinkView,yne_common_views_ColorPicker,yne_common_views_ImageTitleInputView,yne_common_views_StyleViewMapper,yne_common_views_InlineStyleViewMapper,yne_pc_views_inlineStyleViewMapper,yne_ProgressBar,yne_pc_core_PcEditor,yne_common_util_plainizeBlockList,yne_common_util_isXml,yne_common_util_addPrintStyle,yne_collaboration_collabAPI,yne_common_io_editorApi,yne_pc_io_editorApi,yne_common_io_eventList,yne_pc_io_eventList,yne_pc_BulbEditor,yne_pc_io_nativeApiInterface,yne_pc_io_Bridge,yne_pc_io_ImageSaver,yne_pc_init_pc;yne_jtk_core_L=function(){for(var a,b=this,c=b.DEBUG||null!=b.logLevel,d=b.console,e={},f=function(){},g="log warn error time timeEnd profile profileEnd".split(" "),h=g.length;--h>=0;)a=g[h],c&&d[a]?e[a]=d[a].bind(d):e[a]=f;return c&&b.alert?e.debugAlert=function(a){b.alert(a)}:e.debugAlert=e.error,e.DEBUG=c,e}(),yne_backbone=function(){var a=window.Backbone;if(!a&&window.require&&(a=window.require("Backbone")||window.require("backbone")),!a)throw"no `backbone` library";return a}(),yne_underscore=function(){var a=window._;if(!a&&window.require&&(a=window.require("underscore")),!a)throw"no `underscore` library";return a}(),yne_jquery=function(){var a=window.jQuery||window.$;if(!a&&window.require&&(a=window.require("jQuery")||window.require("jquery")),!a)throw"no `jQuery` library";return a}(),yne_common_constants=function(){return{COMPAT:"compat",DEFAULT_BACKGROUND:"NoBackground",INTERM:"interm",INDENT_WIDTH:28,MAX_LIST_ITEM_LEVEL:9,LINE_BREAK:/Windows/.test(window.navigator.userAgent)?"\r\n":"\n",IS_MAC:/Mac|iPod|iPhone|iPad/.test(window.navigator.platform),PLATFORM_LINE_HEIGHT:1.75,PAGE_TYPE_A4:"A4",PAGE_TYPE_B5:"B5",PAGE_TYPE_NONE:"NONE",PAGE_TYPE_TEST:"TEST",PAGE_HEIGHT_A4:1123,PAGE_HEIGHT_B5:945,PAGE_HEIGHT_NONE:Number.MAX_VALUE,PAGE_HEIGHT_TEST:100,PAGE_WIDTH_A4:792,PAGE_WIDTH_B5:663,PAGE_WIDTH_NONE:Number.MAX_VALUE,PAGE_WIDTH_TEST:792,PAGE_SPLIT_BLANK_HEIGHT:70,PAGE_SPLIT_MIDDLE_HEIGHT:10,TOLERABLE_HEIGHT_CHANGE:3,PAGE_CLASS_A4:"page-A4",PAGE_CLASS_B5:"page-B5",PAGE_CLASS_TEST:"page-TEST",WSClientStatusCode:{Connecting:0,Open:1,Closing:2,Closed:3,Ready:5,Disabled:10,Intializing:11},WSEVENTID_HOST_CLOSE:4500,MAX_MESSAGE_SIZE:5e3,MAX_UNDO_STACK_SIZE:20,MAX_CMD_DELAY_MILLIS:4e3,MAX_INIT_DELAY_MILLIS:2e3,MAX_LOCAL_CMD_COUNT_PER_SEC:20,REGULAR_CMD_SENT_MILLIS:2e3,LATENCY_TO_SHOW_SET_CONTENT_PROGRESS:2e3,CJSON_ACTION:"action",CJSON_COMMANDID:"cmdId",CJSON_COMMANDOWNER:"cmdOwner",CJSON_COLLABCOMMANDS:"collabCmds",CJSON_COLLAB_NOTE_READY:"collabNoteReady",CJSON_COLLAB_VERSION:"collabVersion",CJSON_DATA_CMD_ERROR:"dataCmdError",CJSON_ENDVERSION:"endVersion",CJSON_ERROR_TO_CLOSE:"errToClose",CJSON_FINALVERSION:"finalVersion",CJSON_INITIALIZE_COLLABSTARTED:"collabStarted",CJSON_INITIALIZE_DONE:"done",CJSON_INITIALIZE_RESULT:"initResult",CJSON_IS_HISTORY_SAVE:"isHistorySave",CJSON_IS_SERVER_CMD:"isServerCmd",CJSON_LOCKCOLOR:"lockColor",CJSON_LOCK_BLOCK_ID:"lockedBlkId",CJSON_MODIFIERS:"modifiers",CJSON_NICKNAME:"nickname",CJSON_NONDATACOMMANDS:"nondataCmds",CJSON_NOTEVERSIONUPDATE:"versionUpdate",CJSON_PORTRAIT:"portraitUrl",CJSON_READONLY:"readOnly",CJSON_SESSIONID:"sessionId",CJSON_SESSIONPROPERTY:"sessionProp",CJSON_STARTVERSION:"startVersion",NONDATACMD_BLOCKSELECTION:"nb_BlkSelection",NONDATACMD_CLINTPONG:"nb_clientPong",NONDATACMD_COLLABCLOSE:"nb_CollabClose",NONDATACMD_COLLABINFO:"nb_CollabInfo",NONDATACMD_DATACMDFAILED:"nb_dataCmdFailed",NONDATACMD_GETMODIFIERS:"nb_getModifiers",NONDATACMD_NOTESAVE:"nb_noteSave",NONDATACMD_LOCKRELEASE:"nb_lockRelease",NONDATACMD_SESSIONINITIALIZED:"nb_sessionInitialized",NONDATACMD_SEVERPING:"nb_serverPing",OPTIONS_COLLABID:"collabId",OPTIONS_NICKNAME:"nickname",OPTIONS_NOTEVERSION:"noteVersion",OPTIONS_PORTRAIT:"portraitUrl",OPTIONS_SESSIONTYPE:"sessionType",OPTIONS_SESSIONID:"sessionId",OPTIONS_USERID:"userId",OPTIONS_BUILDVERSION:"buildVersion",OPTIONS_RECONNECT:"reconn",ERRORID_FAILED_RECEIVE_COLLAB_CMD:4001,ERRORID_FAILED_SEND_LOCAL_CMD:4002,ERRORID_COLLAB_ENGINE_NULL:4003,CONNECTION_FAILED_SEND:"发送协同命令失败：",CONNECTION_NO_CONNECTED:"当前没有与协同服务器连接",CONNECTION_REFUSED:"协同服务器连接被拒绝",CONNECTION_SERVER_CLOSED:"协同服务器已经关闭",ERROR_CODE:"错误编码：",ERROR_CONFLICT_EXECUTION:"编辑区域冲突",ERROR_FAILED_SEND_LOCAL_CMD:"发送本地已执行命令失败",ERROR_FAILED_RECEIVE_COLLAB_CMD:"接收协同命令超时",ERROR_EXCEPTION:"未知错误：",ERROR_REASON:"原因：",ERROR_UNMATCHED_VERSION:"本地笔记版本与服务器端不匹配，本地/服务器：",INVALIDACTION_BLANK_NOTE:"笔记还没有加载",INVALIDACTION_BLOCKS_DIRTY:"目标段落已经被人修改过",INVALIDACTION_COLLAB_NOT_READY:"笔记内容不满足协同的要求",INVALIDACTION_EDIT_READ_ONLY:"只读模式下不可以编辑",INVALIDACTION_EDIT_NOT_READY:"笔记还没有进入编辑状态，如果此状态持续数秒，请刷新页面",INVALIDACTION_FINALVERSION_NOTREADY:"被撤销命令正在同步中，请稍后再试",INVALIDACTION_EMPTY_CMDJSON:"空协同操作指令，将被忽略",INVALIDACTION_EMPTY_LOCALCMD:"空本地操作指令，将被忽略",INVALIDACTION_INVALID_LOCALCMD:"无效的本地命令",INVALIDACTION_FAILED_COLLABCMD:"协同命令执行失败",INVALIDACTION_FAILED_LOCALCMD:"本地命令执行失败",INVALIDACTION_INVALID_CMD_VERSION:"被撤销命令版本无效，丢弃此命令",INVALIDACTION_INVALID_RANGE:"命令所操作区域已经被删除或者无效",INVALIDACTION_TOO_MANY_CMD:"命令操作过快，请稍候，等待处理命令个数：",INVALIDACTION_TOO_LARGE_MESSAGE:"操作所含数据过多，请减少操作数据：",INVALIDACTION_UNSUPPORTED_CMD:"不支持的操作指令：",INVALIDACTION_WORK_ON_LOCKED_BLOCK:"当前或相邻的段落或目标段落被锁定或删除，请稍后操作",LOADING_IMAGE_PATH:"http://note.youdao.com/editor/collab/loading.gif?47",INSERT_BLANK_CATALOGUE_TEXT:"目录为空，请插入标题（字体左侧）后点击刷新按钮"}}(),yne_jtk_core_Class=function(a){function b(a){var b=this;b.options=c.extend({},a),b.initialize.apply(b,arguments)}var c=yne_underscore,d=function(a,b){var d,e,f=this;return d=a&&c.has(a,"constructor")?a.constructor:function(){return f.apply(this,arguments)},c.extend(d,f,b),e=function(){this.constructor=d},e.prototype=f.prototype,d.prototype=new e,a&&c.extend(d.prototype,a),d.__super__=f.prototype,d};return b.prototype.initialize=function(){},b.extend=d,b}(),yne_common_key_keyCodeMap=function(a){var b=yne_underscore,c=yne_common_constants,d={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"ins",46:"del",106:"*",107:"+",109:"-",110:".",111:"/",144:"numlock",186:";",189:"-",187:"=",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},e=c.IS_MAC?{3:"enter",91:"meta",93:"meta",224:"meta"}:{91:"win",92:"win",93:"menu",224:"win",229:"ime"},f=function(a,c,d){return b.some(a,function(a,b){return a===c&&parseInt(b,10)===d})},g={},h="A".charCodeAt(0),i="Z".charCodeAt(0);for(h;h<=i;h++)d[h]=String.fromCharCode(h).toLowerCase();for(h=1;h<20;++h)d[111+h]="f"+h;for(h=0;h<=9;h++)d[48+h]=h+"";for(h=0;h<=9;++h)d[h+96]=h+"";return{isMatch:function(a,b){var c=a+"-"+b,h=g[c];return null==h&&(h=f(e,a,b)||f(d,a,b),g[c]=h),h},getKey:function(a){if(b.isNumber(a))return a+="",d[a]||e[a]}}}(),yne_common_key_KeyMonitor=function(a){var b=yne_jtk_core_Class,c=yne_jquery,d=yne_underscore,e=yne_common_constants,f=yne_common_key_keyCodeMap,g=["shift","alt","ctrl","meta"],h={return:"enter",escape:"esc",plus:"+"},i={mod:e.IS_MAC?"meta":"ctrl",option:"alt",command:"meta"};return b.extend({initialize:function(a){var b=this;a=a||{},a.el&&(d.bindAll(b,"_onKeyDown"),b.el=a.el,b._beforeMatch=a.beforeMatch,b._afterMatch=a.afterMatch,b._hasBindEvents=!1)},_bindEvents:function(){var a=this;a._hasBindEvents||(c(a.el).on("keydown",a._onKeyDown),a._hasBindEvents=!0)},_unbindEvents:function(){var a=this;a._hasBindEvents&&(c(a.el).off("keydown",a._onKeyDown),a._hasBindEvents=!1)},_prepareForBindKey:function(){var a=this;a._hasBindEvents||a._bindEvents(),a._keyMap||(a._keyMap={}),a._matchCache||(a._matchCache={})},_formatKey:function(a){a=c.trim(a),a=a.toLowerCase(),a=a.replace(/\s+/g,""),d.each(i,function(b,c){a=a.replace(c+"+",b+"+")});var b={},e=a.split(/\+/),f=d.last(e),j=[];return f=h[f]||f,b.key=f,d.each(g,function(c){a.indexOf(c)>-1&&(b[c]=!0,j.push(c))}),j.push(f),b.mark=j.join("-"),b},isEventMatchKey:function(a,b){var c=this._extractEventInfo(a),d=this._formatKey(b);return this._isMatch(c,d)},_extractEventInfo:function(a){var b={},c=[];return d.each(g,function(d){a[d+"Key"]&&(b[d]=!0,c.push(d))}),c.push(a.keyCode),b.keyCode=a.keyCode,b.mark=c.join("-"),b},_isMatch:function(a,b){return!(!b||!event)&&(d.every(g,function(c){return b[c]===a[c]})&&f.isMatch(b.key,a.keyCode))},_onKeyDown:function(a){var b,c,e=this,f=e._keyMap,g=e._extractEventInfo(a),h=g.mark,i=e._matchCache,j=i[h];e._beforeMatch&&e._beforeMatch(a),j||(j=i[h]={eventInfo:g},b={},c=!1,d.each(f,function(a,d){e._isMatch(g,a.keyInfo)&&(b[d]=a,c=!0)}),c&&(j.handlers=b)),d.each(j.handlers,function(b){b.callback.apply(null,[a])}),e._afterMatch&&e._afterMatch(a,c)},bind:function(a,b){var c,e,f=this,g=f._formatKey(a);g&&(f._prepareForBindKey(),e=f._keyMap["key-"+a]={keyInfo:g,callback:b},c=f._matchCache,d.each(c,function(a){if(a&&a.eventInfo){var b,c=a.handlers;c?b=!0:(c={},b=!1),f._isMatch(a.eventInfo,g)&&(c[g.mark]=e,b=!0),b&&(a.handlers=c)}}))},unbind:function(a){var b=this,c=b._keyMap,e=b._matchCache,f="key-"+a;c&&c[f]&&delete c[f],d.each(e,function(a){var b=a.handlers;b&&b[f]&&delete b[f]})},unbindAll:function(){var a=this;a._unbindEvents(),a._keyMap={},a._matchCache={}},clearCache:function(){this._matchCache={}}})}(),yne_common_selection_BlockRange=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=b.extend({_type:"block",block:null,initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){c.error("isCollapsed () should be implemented by subclass")},getType:function(){return this._type},clone:function(){c.error("Every subclass of BlockRange should implement the `clone` method")},collapse:function(){c.error("Every subclass of BlockRange should implement the `collapse` method")},expandToStart:function(){},expandToEnd:function(){},getDataAsJSON:function(){c.error("toJSON() should be implemented by subclass!")},getDataAsHtml:function(){c.error("toHtml() should be implemented by subclass!")},getDataAsPlain:function(){c.error("toPlain() should be implemented by subclass!")},canDrawedByNative:function(){c.error("canDrawedByNative() should be implemented by subclass!")},toNativeRange:function(a){if(!a||!a.getBlockViewByBlock)return void c.error("note view is unvalid!");var b=this,d=a.getBlockViewByBlock(b.block);return d?d.convertToNativeRange(b):void c.warn("No blockView")},extendToBlockEnd:function(){c.warn('Show sub block range do! "extendToBlockEnd"')},extendToBlockStart:function(){c.warn('Show sub block range do! "extendToBlockStart"')},getBlockId:function(){var a=this,b=null;return a.block&&(b=a.block.getId()),b},toCollabJSON:function(){var a=this,b={};return b.rangeType=a._type,b.blockId=a.block.getId(),b}},{getBlockById:function(a,b){var d=b.getBlockById(a);return d||c.warn("Failed to find block",a),d},fromCollabJSON:function(a,b){var c=d.getBlockById(a.blockId,b);if(c)return new d({block:c})}});return d}(),yne_common_data_blockTypes=function(a){var b=yne_underscore,c={ATTACHMENT:"attachment",BLOCK:"block",CATALOGUE:"catalogue",HANDWRITE:"handwrite",HEADER_FOOTER:"header-footer",HEADING:"heading",HR:"horizontal-line",IMAGE:"image",LIST_ITEM:"list-item",PARAGRAPH:"paragraph",TABLE:"table",TODO:"todo",UNKNOWN:"unknown"},d={getAllBlockTypes:function(){return b.values(c)},getType:function(a){if(a&&a.getType)return a.getType()},isParagraph:function(a){var b=this;return b.getType(a)===b.PARAGRAPH},isParagraphCluster:function(a){var b=this,c=b.getType(a);return c===b.PARAGRAPH||c===b.LIST_ITEM||c===b.HEADING||c===b.CATALOGUE||c===b.TODO},isListItem:function(a){var b=this;return b.getType(a)===b.LIST_ITEM},isAttachment:function(a){var b=this;return b.getType(a)===b.ATTACHMENT},isHeaderFooter:function(a){return this.getType(a)===this.HEADER_FOOTER},isTable:function(a){var b=this;return b.getType(a)===b.TABLE},isImage:function(a){var b=this;return b.getType(a)===b.IMAGE},isHr:function(a){var b=this;return b.getType(a)===b.HR},isUnknown:function(a){return this.getType(a)===this.UNKNOWN},isHeading:function(a){var b=this;return b.getType(a)===b.HEADING},isCatalogue:function(a){var b=this;return b.getType(a)===b.CATALOGUE},isTodo:function(a){return this.getType(a)===this.TODO},isTextBlock:function(a){return this.isParagraphCluster(a)},isTextOrTableBlock:function(a){var b=this;return b.isTextBlock(a)||b.isTable(a)},isHandWrite:function(a){return this.getType(a)===this.HANDWRITE}};return b.extend(d,c),d}(),yne_common_util_platform=function(a){var b=yne_underscore,c=yne_jtk_core_L,d=new RegExp(/^\/yws\/res\/|^https?:\/\/note.youdao.com\/yws\/res/),e=new RegExp(/^\/yws\/api\/group|^https?:\/\/note.youdao.com\/yws\/api\/group/),f={UNKNOWN:-1,WEB_NOTE:1,WEB_GROUP:2,PC:3,IPHONE:4,ANDROID:5,MAC:6},g=window.YNE_PLATFORM||f.UNKNOWN,h=b.keys(f),i={};return f.name=g,b.each(h,function(a){var b=a.toLowerCase(),c=g[a];f["IS_"+a]=g===c||g===b}),g.IS_UNKNOWN&&c.error("The platform is unknown!"),i.isFromWebNote=function(a){return d.test(a)},i.isFromWebGroup=function(a){return e.test(a)},b.extend(f,i),f}(),yne_common_selection_AttachmentRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes,d=yne_jtk_core_L,e=yne_common_util_platform,f=b.extend({_type:c.ATTACHMENT,initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){return!1},clone:function(){return new f({block:this.block})},collapse:function(){},getDataAsJSON:function(){var a=this,b=a.block.toJSON();return(e.IS_WEB_NOTE||e.IS_WEB_GROUP)&&b.resource&&!/^http/i.test(b.resource)&&(b.resource=location.protocol+"//"+location.hostname+b.resource),b},getDataAsHtml:function(a){return this.block.toHtml(null,null,a)},getDataAsPlain:function(){return this.block.toPlain()},canDrawedByNative:function(){return!1}},{fromCollabJSON:function(a,e){var g,h=a.rangeType;return h!==c.ATTACHMENT?void d.error("wrong block range type:",h):(g=b.getBlockById(a.blockId,e),g?new f({block:g}):void 0)}});return f}(),yne_common_selection_ImageRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes,d=yne_jtk_core_L,e=b.extend({_type:c.IMAGE,initialize:function(a){var b=this;a=a||{},b.block=a.block},isCollapsed:function(){return!1},clone:function(){return new e({block:this.block})},collapse:function(){},getDataAsJSON:function(){return this.block.toJSON()},getDataAsHtml:function(a){return this.block.toHtml(null,null,a)},getDataAsPlain:function(){return this.block.toPlain()},canDrawedByNative:function(){return!1}},{fromCollabJSON:function(a,f){var g,h=a.rangeType;return h!==c.IMAGE?void d.error("wrong block range type:",h):(g=b.getBlockById(a.blockId,f),g?new e({block:g}):void 0)}});return e}(),yne_common_util_freeze=function(a){var b=yne_underscore,c=function(a){var d=b.keys(a);return b.each(d,function(b){var d=a[b];"object"==typeof d&&null!==d&&c(d)}),Object.freeze(a)};return function(a,b){return a&&"object"==typeof a?(b=!1!==b,Object.freeze?b?c(a):Object.freeze(a):a):a}}(),yne_common_data_xmlBlockStyleConfig=function(a){var b=yne_common_data_blockTypes,c=yne_jtk_core_L,d=yne_underscore,e=yne_common_util_freeze,f={align:{type:"Enum",possible:{left:!0,right:!0,center:!0,justify:!0},default:"left"},"line-height":{type:"Number",default:1.75},indent:{type:"Number",default:0},"text-indent":{type:"Number",default:0},width:{type:"Number",default:null},float:{type:"Enum",possible:{none:!0,left:!0,right:!0},default:"none"},height:{type:"Number",default:1},color:{type:"String",default:"#999999"}},g={},h={},i={};return g[b.HR]={width:{type:"Number",default:100}},h[b.PARAGRAPH]=["align","indent","text-indent","line-height"],h[b.LIST_ITEM]=["align","indent","text-indent","line-height"],h[b.HEADING]=["align","indent","text-indent","line-height"],h[b.CATALOGUE]=["align","indent","text-indent","line-height"],h[b.TODO]=["align","indent","text-indent","line-height"],h[b.IMAGE]=["align","width","float","height"],h[b.ATTACHMENT]=["align","float"],h[b.HR]=["align","width","height","color"],d.each(b.getAllBlockTypes(),function(a){h[a]||c.warn("no block style config for block["+a+"]")}),
d.each(b.getAllBlockTypes(),function(a){var b={},e=h[a]||[],j=g[a];d.each(e,function(a){j&&j[a]?b[a]=j[a]:f[a]?b[a]=f[a]:c.error("no config for style named ["+a+"]")}),i[a]=b}),c.log("xml block style config",i),e(i)}(),yne_common_data_supportedBlockStyles=function(a){var b,c=yne_underscore,d=yne_common_data_xmlBlockStyleConfig,e=yne_common_data_blockTypes,f=yne_jtk_core_L,g={};return{getConfigsOfBlock:function(a,b){if(!a)return void f.error("parameter is not valid",a);var e=d[a],h={};return b=!1!==b,c.each(e,function(d,e){var f=c.clone(d);b&&g[a]&&null!=g[a][e]&&(f.default=g[a][e]),h[e]=f}),h},getConfig:function(a,b,c){return(this.getConfigsOfBlock(b,c)||{})[a]},isSupport:function(a,b){var c=this.getConfigsOfBlock(b)||{},d=c[a];return d&&null!=d.type},getStyleNamesOfBlock:function(a){var b=this.getConfigsOfBlock(a);return b?c.keys(b):[]},getAllStyleNames:function(){return b||(b=[],c.each(d,function(a){var d=c.keys(a);c.each(d,function(a){-1===b.indexOf(a)&&b.push(a)})})),[].concat(b)},getDefault:function(a,b,c){if(!a||!b)return void f.error("parameter is not valid",a,b);var d=this.getConfigsOfBlock(b,c)||{},e=d[a];return e&&null!=e.default?e.default:void 0},getDefaultsOfBlock:function(a,b){var d=this.getConfigsOfBlock(a,b),e={};return c.each(d,function(a,b){e[b]=a.default}),e},setDefault:function(a,b,d){a&&null!=b||f.error("parameter is not valid",a,b);var h=[];d?h.push(d):h=e.getAllBlockTypes(),c.each(h,function(c){g[c]||(g[c]={}),g[c][a]=b})},reset:function(){g={}}}}(),yne_collaboration_collabUtils=function(){return{newGUID:function(){var a="";return a+=(Math.floor(100*Math.random())+"00").substr(0,2),a+=(Math.floor(100*Math.random())+"00").substr(0,2),a+="-",a+=Date.now().toString()},isCollabCommand:function(a){var b=!1;return null!=a&&null!=a.collabProperties&&(b=a.collabProperties.isCollabCmd),b},isInlineStateSetCommand:function(a){return null!=a.isInlineStateSet&&!0===a.isInlineStateSet()},isGUID:function(a){return!!a&&/^[\w\-]+$/.test(a)}}}(),yne_common_data_Block=function(a){var b,c,d,e=yne_underscore,f=yne_jquery,g=yne_backbone,h=yne_jtk_core_Class,i=yne_common_data_blockTypes,j=yne_common_data_supportedBlockStyles,k=yne_jtk_core_L,l=yne_common_util_platform,m=yne_collaboration_collabUtils;return b={_type:i.BLOCK,_styles:null,_extraInfo:null,_blockId:null,_locked:!1,unknownTree:null,_resourceIds:null,_xmlNodeName:null,_validForCollab:!0,_isReadOnly:!1,initialize:function(){var a=this;a._styles={},null==a._blockId&&(a._blockId=m.newGUID()),a.unknownTree={}},isSupportedBlockStyle:function(a){return j.isSupport(a,this._type)},isEmptyContent:function(){return!1},isEmpty:function(){return!1},setBlockStyle:function(a,b){var c=this,d=j.getConfig(a,c._type);d&&("Enum"===d.type?d.possible[b]||(b=d.default):"Number"!==d.type||e.isNumber(b)?"Boolean"!==d.type||e.isBoolean(b)?e["is"+d.type]&&(e["is"+d.type](b)||(b=b.default)):b="true"===b:(b=null===b||""===b?NaN:Number(b),!isNaN(b)&&b||(b=d.default)),b=b||d.default,c._styles[a]=b,k.log("style-change "+a+": "+b),c.trigger("style-change",a,b))},setBlockStyles:function(a){var b=this;a&&e.each(a,function(a,c){b.setBlockStyle(c,a)})},getBlockStyles:function(){return e.clone(this._styles)},getBlockStyle:function(a,b){var c=this,d=j.getConfig(a,c._type);return d?!0===b?c._styles[a]:c._styles[a]||d.default:null},getDefaultBlockStyles:function(){return j.getDefaultsOfBlock(this._type)},removeBlockStyles:function(){var a=this;a._styles={},a.trigger("styles-reset")},removeAllStyles:function(){this.removeBlockStyles()},toXml:function(a){var b,c,e,f=this,g=f.getId();return null==g?void k.debugAlert("The block has NO id",f):(b=a.createElement(f._xmlNodeName),c=a.createElement(d.TAG_ID_NAME),e=a.createTextNode(g),c.appendChild(e),b.appendChild(c),b)},getType:function(){return this._type},_getChildByTagName:function(a,b){if(a)for(var c=a.childNodes[0];c;){if(c.nodeName&&c.nodeName===b)return c;c=c.nextSibling}},parseIdFromXml:function(a){var b,c,e=this;b=e._getChildByTagName(a,d.TAG_ID_NAME),b&&(c=b.textContent),c||l.IS_ANDROID||(b=e._getChildByTagName(a,d.LEGACY_TAG_ID_NAME))&&(c=b.textContent),null==c?e._validForCollab=!1:e._blockId=c},toJSON:function(){var a=this;return{blockType:a._type,styles:a.getBlockStyles(),blockId:a.getId()}},toHtml:function(){k.error("toHtml() should be implemented by subclass!")},toPlain:function(){k.error("toPlain() should be implemented by subclass!")},countWords:function(){k.error("countWords() should be implemented by subclass!")},setResourceIds:function(a){var b=this;a&&a.length&&(b._resourceIds=a)},getResourceIds:function(){return this._resourceIds},getExtraInfo:function(a){var b,c=this;return c.trigger("get-extra-info",a,function(a){b=a}),b},getDefaultSetFont:function(){var a;return this.trigger("get-default-set-font",function(b){a=b}),a},highlight:function(a,b,c){this.trigger("high-light",a,b,c)},getId:function(){var a=this,b=a._blockId;return null==b&&k.debugAlert("The blockId should NOT be null"),b},setId:function(a){var b=this;if(null==a)return void k.debugAlert("The param blockId should NOT be null");b._blockId=a},setLocked:function(a,b){var c=this;c._locked===a&&b&&!b.lockUpdated||(c._locked=a,c.trigger("locked-change",b))},isLocked:function(){return this._locked},isValidForCollab:function(){return this._validForCollab},resetLockState:function(){this._locked=!1},toCollabJSON:function(){return this.toJSON()},setReadOnly:function(a){this._isReadOnly=!!a},isReadOnly:function(){return this._isReadOnly}},c={TAG_ID_NAME:"coId",LEGACY_TAG_ID_NAME:"id",fromXml:function(){k.error("The fromXml should be implemented by subclass!")},parseResourceList:function(a){var b=[];return f(a).find(">resource-list>resource-mono>res-id").each(function(a,c){var d=f(c).text();(d=f.trim(d))&&b.push(d)}),b}},e.extend(b,g.Events),d=h.extend(b,c)}(),yne_jtk_core_assert=function(){var a=this,b=a.DEBUG,c=a.console,d=function(){};return b&&c.assert?c.assert.bind(c):d}(),yne_common_util_schemaVersion=function(a){var b=yne_underscore,c={major:1,minor:0,revision:3},d=function(a){a=a||"";var b=parseInt(a+"",10);return isNaN(b)?0:b},e={GRETER:1,EQUAL:0,LESS:-1},f=function(a,b){return a===b?e.EQUAL:a>b?e.GRETER:e.LESS};return{getDefaultAsString:function(){return c.major+"."+c.minor+"."+c.revision},parse:function(a){if(a){var b=(a+"").split(".");return{major:d(b[0]),minor:d(b[1]),revision:d(b[2])}}},_compare:function(a,c){var d=e.EQUAL;return b.some(["major","minor","revision"],function(b){var g=f(a[b]||0,c[b]||0);if(g!==e.EQUAL)return d=g,!0}),d},isLessThanDefault:function(a){if(!a)return!0;var b=this,d=b.parse(a);return b._compare(d,c)===e.LESS},isCompatible:function(a){if(!(a=a||"")||"true"===a)return!0;var b=this,d=b.parse(a);return b._compare(c,d)!==e.LESS}}}(),yne_common_data_xmlFont=function(a){return yne_common_util_freeze({DEFAULT_FONT:"Microsoft YaHei"})}(),yne_tinycolor=function(){var a=window.tinycolor;if(!a&&window.require&&(a=window.require("tinycolor")),!a)throw"no `tinycolor` library";return a}(),yne_common_data_xmlInlineStyleConfig=function(a){var b=yne_common_util_freeze,c=yne_common_data_xmlFont,d=yne_tinycolor,e={COLOR:"#000000",BACK_COLOR:"transparent"};return b({bold:{key:"b",default:!1,type:"Boolean"},italic:{key:"i",default:!1,type:"Boolean"},underline:{key:"u",default:!1,type:"Boolean"},strike:{key:"s",default:!1,type:"Boolean"},"font-family":{key:"ff",default:c.DEFAULT_FONT,type:"String"},"font-size":{key:"fs",default:14,type:"Number"},color:{key:"cl",default:e.COLOR,type:"String",equalDefault:function(a){return a===e.COLOR||d.equals(a,e.COLOR)}},"back-color":{key:"bc",default:e.BACK_COLOR,type:"String",equalDefault:function(a){return a===e.BACK_COLOR||d.equals(a,e.BACK_COLOR)}},href:{key:"href",default:"",type:"String"}})}(),yne_common_data_supportedInlineStyles=function(a){var b=yne_underscore,c=yne_common_data_xmlInlineStyleConfig,d={};return{getConfig:function(a){var e=c[a],f=d[a];return e&&f&&(e=b.clone(e),e.default=f),e},isSupport:function(a){return null!=c[a]},getAllConfig:function(a){var c=this,d=c.getStyleNames(a),e={};return b.each(d,function(a){e[a]=c.getConfig(a)}),e},getAllDefault:function(a){var c=this,d=c.getStyleNames(a),e={};return b.each(d,function(a){e[a]=c.getDefault(a)}),e},getStyleNames:function(a){var d=b.keys(c);return a&&a.length?b.difference(d,a):d},getDefault:function(a){var b;return null!=(b=d[a])?b:(b=c[a],b?b.default:void 0)},setDefault:function(a,b){var c=this,e=c.getDefault(a);null!=b&&b!==e&&(d[a]=b)},reset:function(){d={}}}}(),yne_common_util_unknownInlineStyles=function(a){var b=yne_underscore,c=yne_common_data_supportedInlineStyles,d=[];return{add:function(a){a&&!c.isSupport(a)&&(b.contains(d,a)||d.push(a))},get:function(){return d},reset:function(){d=[]}}}(),yne_common_util_codePointAt=function(a,b){if(String.prototype.codePointAt)return String.prototype.codePointAt.call(a,b);if(null===a||void 0===a)throw new TypeError("codePointAt第一个参数必须为String");a=String(a);var c,d,e=a.length,f=isNaN(b)?0:Number(b);if(!(f<0||f>=e))return c=a.charCodeAt(f),c>=55296&&c<=56319&&e>f+1&&(d=a.charCodeAt(f+1))>=56320&&d<=57343?1024*(c-55296)+d-56320+65536:c},yne_common_util_clearString=function(a){function b(a){var b,c,f=a.length;if(!d.isString(a))return!1;for(b=0;b<f;b++)if(!(9===(c=e(a,b))||10===c||13===c||c>=32&&c<=55295||c>=57344&&c<=65533)){if(!(c>=65536&&c<=1114111))return!1;b++}return!0}function c(a){var b,c,f="",g=a.length;if(!d.isString(a))return a;for(b=0;b<g;b++)c=e(a,b),9===c||10===c||13===c||c>=32&&c<=55295||c>=57344&&c<=65533?f+=a[b]:c>=65536&&c<=1114111&&(f+=a[b],b++,f+=a[b]);return f}var d=yne_underscore,e=yne_common_util_codePointAt;return{checkValid:b,clear:c}}(),yne_common_util_toCharArrayByCodePoint=function(a){var b=yne_common_util_codePointAt;return function(a){var c,d=[];for(c=0;c<a.length;c++)b(a,c)>65535?(d.push(a.slice(c,c+2)),c++):d.push(a[c]);return d}}(),yne_common_data_RichText=function(a){var b,c=yne_underscore,d=yne_jquery,e=yne_jtk_core_Class,f=yne_jtk_core_assert,g=yne_jtk_core_L,h=yne_common_constants,i=yne_common_util_schemaVersion,j=yne_common_data_supportedInlineStyles,k=yne_common_util_unknownInlineStyles,l=yne_common_util_clearString,m=function(a){f(l.checkValid(a)),this.char=a,this.length=a.length,this.styles={}},n=function(a){var b,c=a.length,d=new Array(c);for(b=0;b<c;++b)d[b]=a[b].clone();return d},o=yne_common_util_toCharArrayByCodePoint,p=function(a){var b=a.indexOf("|");return-1===b?{value:a}:{compat:a.substring(0,b),value:a.substring(b+1)}};return m.prototype.toString=function(){return this.char},m.prototype.setStyle=function(a,b){var d=this.styles,e=j.getConfig(a);if(!e)return void g.warn("The RichText does not support `"+a+"` style!");if(b&&!c["is"+e.type](b))switch(e.type){case"Number":b=Number(b),b=isNaN(b)?e.default:b;break;case"Boolean":b=b+""=="true";break;default:g.warn("The value `"+b+"` of `"+a+"` is not valid type!"),b=null}!b||(e.equalDefault?e.equalDefault(b):b===e.default)?delete d[a]:d[a]=b},m.prototype.setUnknownStyle=function(a,b){var c=this;if(j.isSupport(a))return void g.warn("The RichText supports `"+a+"` style!");c.unknownStyles||(c.unknownStyles={}),c.unknownStyles[a]=b},m.prototype.getStyle=function(a,b){var d,e=j.getConfig(a);return e?(d=this.styles[a],b=!1!==b,null==d?b?e.default:null:(c["is"+e.type](d)||(g.warn("The value `"+d+"` of `"+a+"` is not valid type!"),d=null),b?null==d?e.default:d:d===e.default?null:d)):null},m.prototype.getUnknownStyle=function(a){var b=this,c=b.unknownStyles;if(c)return c[a]},m.prototype.getStyles=function(){var a=this,b={},d=j.getAllConfig();return c.each(d,function(c,d){b[d]=a.getStyle(d)}),b},m.prototype.removeStyles=function(){this.styles={}},m.prototype.clone=function(){var a=this,b=new m(a.char);return b.styles=c.clone(a.styles),a.unknownStyles&&(b.unknownStyles=c.clone(a.unknownStyles)),b},m.prototype.isLineBreak=function(){return"\r"===this.char||"\n"===this.char},m.prototype.toJSON=function(){var a=this,b={char:a.char},d={},e=!1,f=j.getAllConfig();return c.each(f,function(b,c){var f=a.getStyle(c,!1);f&&(d[c]=f,e=!0)}),e&&(b.styles=d),b},m.fromJSON=function(a){if(a&&a.char){var b=new m(a.char);return c.each(a.styles,function(a,c){b.setStyle(c,a)}),b}},b=e.extend({_data:null,initialize:function(a){a=c.defaults(a||{},{text:"",keepLineBreak:!0});var b=this,d=a.text||"",e=b._data=[];b._keepLineBreak=a.keepLineBreak,delete b.options,d=l.clear(d),b._keepLineBreak||(d=d.replace(/[\r\n]/g,"")),c.each(o(d),function(a){e.push(new m(a))})},getLength:function(a){var b,c=this._data,e=c.length;if(a)for(b=0;b<c.length;b++)d.trim(c[b].toString())||e--;return e},indexOf:function(a,b,c){var d,e,f,g,h,i=a.getReadOnlyData(),j=i.length,k=this.getReadOnlyData(),l=k.length;if(j>l)return-1;for(e=b;e<l;e++){for(d=!0,f=0;f<j;f++){if(g=k[e+f],h=i[f],!g){d=!1;break}if((!0!==c||g.char.toLowerCase()!==h.char.toLowerCase())&&g.char!==h.char){d=!1;break}}if(d)return e}return-1},isEmpty:function(){return this.getLength()<=0},getClonedData:function(){return n(this._data)},getReadOnlyData:function(){return this._data},toString:function(){return this._data.join("")},setStyle:function(a,b,d,e){if(d&&null!=e){var f,g=this,h=g._data,i=c.isArray(e);for(b=Math.min(b,h.length),f=a;f<b;++f)h[f].setStyle(d,i?e[f-a]:e)}},setUnknownStyle:function(a,b,d,e){var f,g=this,h=g._data,i=c.isArray(e);for(b=Math.min(b,h.length),f=a;f<b;++f)h[f].setUnknownStyle(d,i?e[f-a]:e)},getStyle:function(a,b,c){var d,e,h,i=this,j=i._data;if(f(a>=0),f(a<=b),f(b<=j.length),void 0===a||a<0||void 0===b||a>b||b>j.length)return g.error("unexpected params:",a,b,j.length),null;for(h=new Array(b-a),d=a;d<b;++d)e=j[d].getStyle(c),h[d-a]=e;return h},setStyles:function(a,b,d){var e=this;d&&c.each(d,function(c,d){e.setStyle(a,b,d,c)})},getStylesAtIndex:function(a){var b=this._data,c=b.length;return a<0||a>=c?void g.warn("invlid index of the text",a,b):b[a].getStyles()},getCommonStyle:function(a,b,c,d){var e,f,i=this,k=i._data,l=null;if(i.isEmpty())return j.getDefault(c);if(a<0)return void g.warn("start should not be less than 0",a);if(a>b)return void g.warn("start should not greater than end",a,b);if(b>k.length)return void g.warn("end should not geater than data.length",b,k);if(a===b)0===a&&k[0]?l=k[0].getStyle(c):k[a-1]&&(l=k[a-1].getStyle(c));else for(e=a;e<b;++e)if(k&&k[e]){if(f=k[e].getStyle(c),null===l)l=f;else if(l!==f)return d?null:h.INTERM}else g.warn("unexpected undefine in data",k);return!d||l!==h.INTERM&&l!==j.getDefault(c)?l:null},getCommonStyles:function(a,b,d){var e=this,f={},g=j.getAllConfig();return c.each(g,function(c,g){var h=e.getCommonStyle(a,b,g,d);null!=h&&(f[g]=h)}),f},removeStyles:function(){var a,b=this,c=b._data,d=c.length;for(a=0;a<d;++a)c[a].removeStyles()},slice:function(a,c,d){var e=this,f=e._data.slice(a,c),g=new b;return!1!==d&&(f=n(f)),g.appendRichChars(f),g},isKeepLineBreak:function(){return this._keepLineBreak},setKeepLineBreak:function(a){a=!!a;var b=this;a!==b._keepLineBreak&&(b._keepLineBreak=a,!1===b._keepLineBreak&&b.removeLineBreak())},_removeLineBreak:function(a){return a&&0!==a.length?a=c.filter(a,function(a){return!1===a.isLineBreak()}):[]},removeLineBreak:function(){var a=this;a._data=a._removeLineBreak(a._data)},clone:function(){var a=this,c=new b({text:"",keepLineBreak:a.isKeepLineBreak()});return c.appendRichChars(a.getClonedData()),c},append:function(a){a&&a.getClonedData||g.warn("no richText"),this.appendRichChars(a.getClonedData())},appendRichChars:function(a){if(!a||0===a.length)return void g.warn("richChars is not valid",a);var b=this;b.isKeepLineBreak()||(a=b._removeLineBreak(a)),b._data=b._data.concat(a)},insert:function(a,b){if(a&&a.getClonedData){var c=this,d=c._data,e=d.splice(b),f=a.getClonedData();g.log("insert ...",a,b),!1===c.isKeepLineBreak()&&!0===a.isKeepLineBreak()&&(f=c._removeLineBreak(f)),c._data=d.concat(f,e)}},getReadOnlyStylesList:function(a){var b=this,d=b._data,e=[],f=j.getAllConfig();return a=!1!==a,c.each(d,function(b){var d={};c.each(f,function(c,e){var f=b.getStyle(e,a);(a||!a&&null!=f)&&(d[e]=f)}),e.push(d)}),e},getStyleRanges:function(a,b){if(a){if(b=!0===b,j.isSupport(a))b=!1;else if(!b)return;var d,e,f,g,h=this,i=h._data,k=i.length,l=[],m=!1;for(d=0;d<k;d++)e=i[d],f=b?e.getUnknownStyle(a):e.getStyle(a,!1),f?(g=c.last(l),!m&&g&&g.value===f?g.to=d+1:l.push({from:d,to:d+1,value:f}),m=!1):m=!0;return l}},_handleStyleRangesForXML:function(a,b,d,e,f){e&&e.length&&c.each(e,function(c){if(c&&c.value){var e,g,i,j=a.createElement(d),k=a.createElement("from"),l=a.createElement("to"),m=a.createElement("value");k.appendChild(a.createTextNode(c.from)),j.appendChild(k),l.appendChild(a.createTextNode(c.to)),j.appendChild(l),f?(e=p(c.value),i=e.compat,i&&j.setAttribute(h.COMPAT,i),g=e.value):g=c.value,m.appendChild(a.createTextNode(g)),j.appendChild(m),b.appendChild(j)}})},_handleStyleRangesForJSON:function(a,b,d,e){d&&d.length&&c.each(d,function(c){if(c&&c.value){var d,f,g=a[b];g||(g=a[b]=[]),e?(d=p(c.value),f=d.value):f=c.value,g.push({from:c.from,to:c.to,value:f})}})},toXml:function(a){var b,d=this,e=a.createElement("inline-styles"),f=j.getAllConfig();return c.each(f,function(b,c){var f=d.getStyleRanges(c,!1);d._handleStyleRangesForXML(a,e,c,f,!1)}),b=k.get(),c.each(b,function(b){var c=d.getStyleRanges(b,!0);d._handleStyleRangesForXML(a,e,b,c,!0)}),e},_toSimplifyJSON:function(){var a,b,d=this,e={},f=j.getAllConfig();return c.each(f,function(a,b){var c=d.getStyleRanges(b,!1);d._handleStyleRangesForJSON(e,b,c,!1)}),a=k.get(),c.each(a,function(a){var b=d.getStyleRanges(a,!0);d._handleStyleRangesForJSON(e,a,b,!0)}),b={text:d.toString(),keepLineBreak:d.isKeepLineBreak()},c.isEmpty(e)||(b.inlineStyles=e),b},toJSON:function(a){var b,d=this;return!0===a?d._toSimplifyJSON():(b=c.map(d._data,function(a){return a.toJSON()}),{isRichText:!0,keepLineBreak:d.isKeepLineBreak(),data:b})},toCollabJSON:function(){return this.toJSON(!0)}},{create:function(a,c){return new b({text:a,keepLineBreak:!1!==c})},createBlank:function(a){return b.create("",a)},fromXml:function(a){var c=d(a),e=new b({text:c.find("text").text()});return c.find("inline-styles").children().each(function(a,b){var c,f,g=b.nodeName.toLowerCase(),l=d(b),m=parseInt(l.find("from").text()),n=parseInt(l.find("to").text()),o=l.find("value");0!==o.length&&(c=o.text(),j.isSupport(g)?e.setStyle(m,n,g,c):(f=l.attr(h.COMPAT),i.isCompatible(f)&&(k.add(g),c=f+"|"+c,e.setUnknownStyle(m,n,g,c))))}),e},fromJSON:function(a){if(a&&a.isRichText&&a.data){var d,e=[];return c.each(a.data,function(a){var b=m.fromJSON(a);b&&e.push(b)}),d=new b({text:"",keepLineBreak:a.keepLineBreak}),d.appendRichChars(e),d}},fromCollabJSON:function(a){if(!a||!a.text)return b.createBlank(!0);var d=b.create(a.text,a.keepLineBreak);return c.each(a.inlineStyles,function(a,b){c.each(a,function(a){j.isSupport(b)?d.setStyle(a.from,a.to,b,a.value):d.setUnknownStyle(a.from,a.to,b,a.value)})}),d}})}(),yne_common_fontMaps=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_L,e=yne_common_data_xmlFont,f={"微软雅黑":[e.DEFAULT_FONT,"STXihei"],"宋体":["SimSun","STSong"],"新宋体":["NSimSun"],"仿宋":["FangSong_GB2312","FangSong","STFangsong"],"楷体":["KaiTi_GB2312","KaiTi","STKaiti"],"黑体":["SimHei","STHeiti"],Arial:["Arial"],"Arial Black":["Arial Black"],"Times New Roman":["Times New Roman"],"Courier New":["Courier New"],Tahoma:["Tahoma"],Verdana:["Verdana"]},g=function(a,c){return b.some(a,function(a){return(a+"").toLowerCase()===c})};return Object.freeze(f),{DEFAULT_FONT:e.DEFAULT_FONT,getFontMap:function(){return f},getFont:function(a){var c,d,e=this;if((a=(a||"").toLowerCase())&&(d=e.splitFontFamily(a)))return b.some(d,function(a){if(b.some(f,function(b,d){if(d.toLowerCase()===a||g(b,a))return c=d,!0}),c)return!0}),c},getFontFirstValue:function(a){var b,c=this.getFont(a);if(b=f[c])return b[0]},getAllValueByFont:function(a){var b=this.getFont(a);if(b)return f[b].join(",");d.warn("Font does not exit in Font Maps: "+a)},getNames:function(){return b.keys(f)},getItems:function(){var a=[];return b.each(f,function(b,c){a.push({singleValue:b[0],fullValue:b.join(","),name:c})}),a},splitFontFamily:function(a){var d,e=[];return(a=c.trim(a||""))?(d=a.split(","),b.each(d,function(a){a=a||"",(a=c.trim(a.replace(/["']/g,"")))&&e.push(a)}),e):[]}}}(),yne_common_data_inlineStyleToCss=function(a){var b=yne_underscore,c=yne_common_fontMaps,d={"font-size":function(a){var b=a["font-size"];if(null!=b)return b+"px"},"font-family":function(a){var b=a["font-family"];return b=c.getAllValueByFont(b)||b},color:function(a){return a.color},"background-color":function(a){return a["back-color"]},"font-weight":function(a){return{true:"bold",false:"normal"}[a.bold+""]},"font-style":function(a){return{true:"italic",false:"normal"}[a.italic+""]},"text-decoration":function(a){if(!1===a.underline&&!1===a.strike)return"none";var b=[];return a.underline&&b.push("underline"),a.strike&&b.push("line-through"),(b=b.join(" "))||""}};return{getRules:function(a){var c=a?b.clone(a):{};return b.defaults(c,d),c},convertToCssStyle:function(a,c,d){var e=this,f={},g=e.getRules(d);return b.isArray(c)&&(g=b.pick(g,c)),b.isObject(a)&&b.each(g,function(b,c){f[c]=b(a)}),f}}}(),yne_common_util_xssFilter=function(){function a(a){return a.replace(o,"&lt;").replace(p,"&gt;")}function b(a){return a=i(a),v.lastIndex=0,v.test(a)?"":a=j(a)}function c(a,b){if(b=i(b),"href"===a||"src"===a){if("#"===(b=b.trim(b)))return"#";if("http://"!==b.substr(0,7)&&"https://"!==b.substr(0,8)&&"mailto:"!==b.substr(0,7)&&"#"!==b[0]&&"/"!==b[0])return""}else if("background"===a){if(v.lastIndex=0,v.test(b))return""}else if("style"===a){if(w.lastIndex=0,w.test(b))return"";if(x.lastIndex=0,x.test(b)&&(v.lastIndex=0,v.test(b)))return""}return b=j(b)}function d(a){return a.replace(q,"&quot;")}function e(a){return a.replace(r,'"')}function f(a){return a.replace(s,function(a,b){return"x"===b[0]||"X"===b[0]?String.fromCharCode(parseInt(b.substr(1),16)):String.fromCharCode(parseInt(b,10))})}function g(a){return a.replace(t,":").replace(u," ")}function h(a){for(var b="",c=0,d=a.length;c<d;c++)b+=a.charCodeAt(c)<32?" ":a.charAt(c);return b.trim()}function i(a){return a=e(a),a=f(a),a=g(a),a=h(a)}function j(b){return b=d(b),b=a(b)}function k(){return""}function l(a,b){function c(b){return!!d||-1!==a.indexOf(b)}"function"!=typeof b&&(b=function(){});var d=!Array.isArray(a),e=[],f=!1;return{onIgnoreTag:function(a,d,g){if(c(a)){if(g.isClosing){var h="[/removed]",i=g.position+h.length;return e.push([!1!==f?f:g.position,i]),f=!1,h}return f||(f=g.position),"[removed]"}return b(a,d,g)},remove:function(a){var b="",c=0;return e.forEach(function(d){b+=a.slice(c,d[0]),c=d[1]}),b+=a.slice(c)}}}function m(a){return a.replace(y,"")}function n(a){var b=a.split("");return b=b.filter(function(a){var b=a.charCodeAt(0);return 127!==b&&(!(b<=31)||(10===b||13===b))}),b.join("")}var o=/</g,p=/>/g,q=/"/g,r=/&quot;/g,s=/&#([a-zA-Z0-9]*);?/gim,t=/&colon;?/gim,u=/&newline;?/gim,v=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a)\:/gi,w=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,x=/u\s*r\s*l\s*\(.*/gi,y=/<!--[\s\S]*?-->/g,z={};return z.safeAttrValue=c,z.safeHref=b,z.escapeHtml=a,z.escapeQuote=d,z.unescapeQuote=e,z.escapeHtmlEntities=f,z.escapeDangerHtml5Entities=g,z.clearNonPrintableCharacter=h,z.friendlyAttrValue=i,z.escapeAttrValue=j,z.onIgnoreTagStripAll=k,z.StripTagBody=l,z.stripCommentTag=m,z.stripBlankChar=n,z}(),yne_common_data_Rich2HtmlConvertor=function(a){var b=yne_underscore,c=yne_jquery,d=yne_common_data_RichText,e=yne_common_data_supportedInlineStyles,f=yne_common_data_inlineStyleToCss,g=yne_common_util_xssFilter,h=function(a,c){var d,e=document.createElement("span");return b.each(c,function(b,c){var d=b(a);(d||0===d)&&(e.style[c]=d)}),d=e.outerHTML,d=d.replace(/<\/span>$/i,"")},i=function(){return"</span>"},j=function(a){return a+="",'<a href="'+g.safeHref(a)+'">'},k=function(){return"</a>"},l=function(a,c,d){b.isEmpty(c)||a.push(h(c,d))},m=function(a,b){b&&a.push(j(b))},n=function(a,c){b.isEmpty(c)||a.push(i(c))},o=function(a,b){b&&a.push(k(b))},p=e.getStyleNames(),q=function(a,b){if(!a||!b)return!1;var c,d=p.length;for(c=0;c<d;c++)if(a[p[c]]!==b[p[c]])return!1;return!0},r={},s={};return{setCssRules:function(a){var c=this;b.each(a,function(a,d){b.isFunction(a)&&(r[d]=a,c.resetInlineStyleDefaultForHtml(d))})},getCssRule:function(a){return r[a]},resetCssRules:function(){var a=this;r={},a.resetInlineStyleDefaultForHtml()},getDefaultForHtml:function(a){var b,c,d,f=this,g=s[a];return null==g&&(b=f.getCssRule(a),c=e.getDefault(a),b?(d={},d[a]=c,g=b(d)):g=c,s[a]=g),g},resetInlineStyleDefaultForHtml:function(a){a?(a+="",delete s[a]):s={}},rich2html:function(a,c){var d,e,g,h,i,j,k=a.getReadOnlyData(),p=k.length,s=[],t="";if(c=b.defaults(c||{},{withDefault:!0,styleRules:null}),0===p)return"<br>";for(d=a.getReadOnlyStylesList(c.withDefault),c.styleRules?(j=b.clone(c.styleRules),b.defaults(j,r)):j=r,j=f.getRules(j),e=0;e<p;++e)g=k[e],i=d[e],q(h,i)||(n(s,h),t!==i.href&&(o(s,t),m(s,i.href)),l(s,i,j)),s.push(b.escape(g.toString())),h=i,t=i.href;return n(s,h),o(s,t),s=s.join("")},html2rich:function(a){return new d(c(a).text())}}}(),yne_common_util_unknownTree=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_L,e=yne_common_constants,f=yne_common_util_schemaVersion;return{appendToTree:function(a,b){if(!a||!b)return void d.error("arguments are not valid!");var g=c(b).attr(e.COMPAT);f.isCompatible(g)&&(a.unknown||(a.unknown=[]),a.unknown.push(b.cloneNode(!0)))},appendToXml:function(a,e){if(!a||!e)return void d.error("arguments are not valid!");a.unknown&&a.unknown.length&&b.each(a.unknown,function(a){var b,f;a&&a.cloneNode&&(f=a.nodeName,b=c(e).find(">"+f).length>0,b?d.error("unknown node <"+f+"> has already exist!"):e.appendChild(a.cloneNode(!0)))})}}}(),yne_common_util_blockStyles=function(a){var b=yne_common_util_unknownTree,c=yne_common_data_supportedBlockStyles,d=yne_jquery,e=yne_underscore;return{toXml:function(a,d,f){var g=a.getBlockStyles(),h=a.getType(),i=c.getStyleNamesOfBlock(h);e.each(i,function(a){var b=g[a],e=c.getConfig(a,h,!1);if(null!=b&&b!==e.default){var i=f.createElement(a),j=f.createTextNode(b);i.appendChild(j),d.appendChild(i)}}),a.unknownTree&&a.unknownTree.styles&&b.appendToXml(a.unknownTree.styles,d)},fromXml:function(a,f){var g=a.unknownTree,h=a.getType(),i=c.getStyleNamesOfBlock(h),j=[];d(f).children().each(function(c,e){var f,h=e.nodeName;a.isSupportedBlockStyle(h)?(f=d(e).text(),a.setBlockStyle(h,f),j.push(h)):(g.styles||(g.styles={}),b.appendToTree(g.styles,e))}),e.each(i,function(b){var d;-1===j.indexOf(b)&&(d=c.getConfig(b,h,!1),a.setBlockStyle(b,d.default))})}}}(),yne_common_util_convertPlain=function(a){var b=/\xA0/g;return a.replace(b," ")},yne_common_util_countText=function(a){var b,c=0;return a?(b="string"==typeof a?a:a.toString(),c=b.replace(/(\s)/g,"").length):c},yne_common_data_Paragraph=function(a){var b,c,d,e=yne_underscore,f=yne_jquery,g=yne_common_data_Block,h=yne_common_data_Rich2HtmlConvertor,i=yne_common_data_blockTypes,j=yne_common_constants,k=yne_common_data_RichText,l=yne_jtk_core_L,m=yne_common_util_unknownTree,n=yne_common_util_blockStyles,o=yne_common_data_supportedBlockStyles,p=yne_common_data_supportedInlineStyles,q=yne_common_util_convertPlain,r=yne_common_util_countText;return b={_type:i.PARAGRAPH,_richText:null,_styles:null,_inlineStylesForEmpty:null,initialize:function(){var a=this;a.options.id&&a.setId(a.options.id),a.options.text?a.setText(a.options.text):a.setText(""),g.prototype.initialize.apply(a,arguments)},isEmptyContent:function(){return 0===this.getLength(!1)},setText:function(a){a instanceof k||(e.isString(a)||(a=String(a)),a=new k({text:a}));var b=this;b._richText=a,b.trigger("content-change",b)},getText:function(){return this._richText.slice(0)},getReadOnlyText:function(){return this._richText},getStartOffset:function(){return 0},getEndOffset:function(){return this.getLength()},getLength:function(a){return this._richText.getLength(a)},isEmpty:function(){return this._richText.isEmpty()},getRangeText:function(a){if(a&&null!=a.start){return this.sliceText(a.start,a.end)}},sliceText:function(a,b,c){return this._richText.slice(a,b,c)},append:function(a){this._richText.append(a)},insertText:function(a,b){var c=this;return l.log("insert Text",a,b),c._richText.insert(b,a),l.log(c._richText),c.trigger("content-change"),!0},deleteText:function(a,b){e.isObject(a)&&!e.isUndefined(a.start)&&(b=a.end,a=a.start);var c=this,d=c._richText,f=d.slice(0,a),g=new k,h=new k;b>=0&&(g=d.slice(b)),h.append(f),h.append(g),c.setText(h)},setTextStyle:function(a,b,c,d){var f=this,g=f._richText;e.isObject(c)&&null!=c.start&&(d=c.end,c=c.start),g.setStyle(c,d,a,b),f.trigger("content-change")},getTextStyle:function(a,b,c){var d=this,f=d._richText;return e.isObject(b)&&null!=b.start&&(c=b.end,b=b.start),f.getStyle(b,c,a)},getTextStylesAtIndex:function(a){return this._richText.getStylesAtIndex(a)},getCommonInlineStyle:function(a,b){var c,d,e=this;return b?(c=b.start,d=b.end):(c=e.getStartOffset(),d=e.getEndOffset()),e._richText.getCommonStyle(c,d,a)},getCommonInlineStyles:function(a){var b,c,d=this,e=d._richText;return a?(b=a.start,c=a.end):(b=d.getStartOffset(),c=d.getEndOffset()),e.getCommonStyles(b,c)},removeAllStyles:function(){var a=this;g.prototype.removeAllStyles.apply(a,arguments),a._richText.removeStyles(),a.trigger("content-change",a)},setInlineStylesForEmpty:function(a){this._inlineStylesForEmpty=a},getInlineStylesForEmpty:function(a){var b=this,c=b._inlineStylesForEmpty;return a&&(c=c||p.getAllDefault()),c=e.clone(c),c||(c=b.getDefaultSetFont()),c},getDefaultInlineStyles:function(){return p.getAllDefault()},getInlineStyleForEmpty:function(a,b){return(this.getInlineStylesForEmpty(b)||{})[a]},getStyleRanges:function(a,b){return this._richText.getStyleRanges(a,b)},toXml:function(a){var b,c,e=this,f=d.__super__.toXml.apply(e,[a]),g=a.createElement("text"),h=e._richText.toString(),i=a.createTextNode(h);return g.appendChild(i),f.appendChild(g),c=e._richText.toXml(a),c&&f.appendChild(c),b=a.createElement("styles"),n.toXml(e,b,a),f.appendChild(b),m.appendToXml(e.unknownTree,f),f},toJSON:function(a,b){a=a||0;var c=this,e=c.sliceText(a,b,!1),f=d.__super__.toJSON.apply(c);return f.richText=e.toJSON(),f},toHtml:function(a,b,c){var d,e,g,i=this,j=document.createElement("div"),k=f(j);return c=!0===c,k.attr("yne-bulb-block","paragraph").css("white-space","pre-wrap"),i._applyBlockStylesOnElement(k),a=a||0,b=null==b?i.getEndOffset():b,d=i.sliceText(a,b,!1),e=h.rich2html(d,{withDefault:c}),k.html(e),g=j.outerHTML,j=k=null,g},_applyBlockStylesOnElement:function(a,b){var c,d=this,f=d.getBlockStyles(),g={};e.each(f,function(a,e){switch(e){case"align":g["text-align"]=a;break;case"indent":case"text-indent":b?(a=d.getBlockStyle("indent")+d.getBlockStyle("text-indent"),c="text-indent"):(a=a>0?a:0,c="indent"===e?"margin-left":"text-indent"),g[c]=a*j.INDENT_WIDTH||"";break;case"line-height":a>0&&(g["line-height"]=String(a));break;default:l.warn("unknown block style: "+e)}}),g["line-height"]||(c=o.getDefault("line-height",i.PARAGRAPH),g["line-height"]=c),c=h.getDefaultForHtml("font-size"),g["font-size"]=c,a.css(g)},toPlain:function(a,b){var c,d,e=this;return a=a||0,c=e.sliceText(a,b,!1),d=c.toString(),d=q(d)},countWords:function(a){var b,c=this,d=0,e=c._richText;return j.IS_MOBILE||!a?d=r(e):(b=c.getRangeText(a))&&(d=r(b)),d},getHighlight:function(a,b){if(a&&a.length){var c=this,d=c._richText,f=[];return e.each(a,function(a){for(var c=a.getLength(),e=0,g=d.indexOf(a,e,b.ignoreCase);-1!==g;)f[g]={start:g,end:g+c},g=d.indexOf(a,g+c,b.ignoreCase)}),f=e.compact(f),f.length?f:null}},toCollabJSON:function(){var a=this,b=d.__super__.toJSON.apply(a);return b.richText=a._richText.toCollabJSON(),b}},c={fromXml:function(a){var b=new d;return b.parseIdFromXml(a),b.setText(k.fromXml(a)),f(a).children().each(function(a,c){switch(c.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"text":case"inline-styles":break;case"styles":n.fromXml(b,c);break;default:
m.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){return this._generalFromJSON(a,!1)},fromCollabJSON:function(a){return this._generalFromJSON(a,!0)},_generalFromJSON:function(a,b){if(!a||!a.blockType||a.blockType!==i.PARAGRAPH||!a.richText)return void l.warn("jsonObj is not valid!");var c,f=new d;return c=b?k.fromCollabJSON(a.richText):k.fromJSON(a.richText),f.setText(c),e.each(a.styles,function(a,b){f.setBlockStyle(b,a)}),a.blockId&&f.setId(a.blockId),f},createBlank:function(a){var b=new d;return!0===a&&j.PLATFORM_LINE_HEIGHT&&j.PLATFORM_LINE_HEIGHT!==o.getDefault("line-height",i.PARAGRAPH)&&b.setBlockStyle("line-height",j.PLATFORM_LINE_HEIGHT),b}},d=g.extend(b,c)}(),yne_underscorestring=function(){var a,b=window._;if(!b&&window.require&&(b=window.require("underscore")),!b)throw"no `underscore` library";if(a=b.string||b.str||window.s,!a&&window.require&&(a=window.require("underscore.string")),!a)throw"no `underscore.string` library";return a}(),yne_common_data_listItemMarker=function(a){function b(a){if(isNaN(a))return"";for(var b=[["","i","ii","iii","iv","v","vi","vii","viii","ix"],["","x","xx","xxx","xl","l","lx","lxx","lxxx","xcc"],["","c","cc","ccc","cd","d","dc","dcc","dcc","cm"]],c="",d=0,e=0,f=1e3;e<3;e++,f/=10)d=Math.floor(a%f/(f/10)),c+=b[2-e][d];return c}function c(a){if(isNaN(a))return"";var b="a".charCodeAt(0),c="z".charCodeAt(0),d=c-b+1,e="";for(a--;a>=0;)e=String.fromCharCode(a%d+b)+e,a=Math.floor(a/d)-1;return e}var d=yne_jtk_core_L,e=yne_underscore,f=yne_common_data_inlineStyleToCss,g=["lower-roman","decimal","lower-alpha"],h=["square","disc","circle"];return{SUPPORTED_STYLES:["font-size","font-family","color","bold","italic"],isSupportedStyle:function(a){return this.SUPPORTED_STYLES.indexOf(a)>-1},convertToCssStyle:function(a,b){if(a){var c=this,d=e.pick(a,c.SUPPORTED_STYLES);return b&&e.each(d,function(a,c){null!=a&&(d[c]=b.valueToView(c,a))}),f.convertToCssStyle(d)}},makeHtmlMarker:function(a){if(!a)return void d.warn("Failed to create marker",a);var b,c,e=this,f=a.getLevel(),i=a.getText();return b=a.isOrdered()?g[f%3]:h[f%3],i.getLength()&&(c=e.convertToCssStyle(i.getStylesAtIndex(0))),{listStyleType:b,markerStyles:c}},makePlainMarker:function(a,e){if(!a)return d.warn("Failed to create marker",a),"";e=!1!==e;var f,g="",h=a.getLevel();if(a.isOrdered()){switch(f=a.getIndex(),h%3){case 0:g=b(f);break;case 2:g=c(f);break;default:case 1:g=f}g+="."}else switch(h%3){case 0:g="■";break;case 2:g="○";break;default:case 1:g="●"}return e&&(g+=" "),g}}}(),yne_common_data_List=function(a){var b,c=yne_jtk_core_Class,d=yne_backbone.Events,e=yne_underscore,f=yne_jquery,g=yne_jtk_core_assert,h=yne_jtk_core_L;return b=c.extend(e.extend({_id:null,_type:null,_items:null,unknownAttrs:null,initialize:function(a){var c=this;c._id=a.listId,c._type=a.type,c._items=[],c._type!==b.ORDERED&&c._type!==b.UNORDERED&&(h.error("type should be ORDERED or UNORDERED",c._type),c._type=b.UNORDERED),c.unknownAttrs=[]},getId:function(){return this._id},isOrdered:function(){return this._type===b.ORDERED},isUnordered:function(){return this._type===b.UNORDERED},getType:function(){return this._type},setType:function(a){g(a===b.ORDERED||a===b.UNORDERED),a!==this._type&&(this._type=a,this.updateIndexes(!0),this.trigger("type-change"))},getLength:function(){return this._items.length},getItems:function(){return this._items},updateIndexes:function(a){var b,c,d,e=this,f=e._items,g=f.length,h=0,i={};for(b=0;b<g;++b)c=f[b],d=c.getLevel(),d>h?i[d]=1:i[d]?i[d]++:i[d]=1,h=d,c.setIndex(i[d]),a&&c.updateListType()},insertItem:function(a,b){var c=this,d=c._items;return g(a>0||a<=d.length),g(!(b in d)),d.splice(a,0,b),c.updateIndexes(),a},addItem:function(a){var b=this;a&&(b._items.push(a),b.updateIndexes())},insertAfter:function(a,b){var c=this,d=c._items,e=b?d.indexOf(b):-1;c.insertItem(e+1,a)},removeItem:function(a){var b=this,c=b._items,d=c.indexOf(a);return d>=0&&(c.splice(d,1),b.updateIndexes()),d},toCollabJSON:function(){var a=this,b={};return b.id=a._id,b.type=a._type,b}},d),{ORDERED:"ordered",UNORDERED:"unordered",fromXml:function(a){var c=f(a),d=c.attr("id"),g=c.attr("type"),h=new b({listId:d,type:g});return e.each(a.attributes,function(a){switch(a.nodeName){case"id":case"type":break;default:h.unknownAttrs.push(a.cloneNode(!0))}}),h},fromCollabJSON:function(a){return new b({type:a.type,listId:a.id})}})}(),yne_common_data_ListItem=function(a){var b,c=yne_common_data_Paragraph,d=yne_common_data_RichText,e=yne_common_data_blockTypes,f=yne_common_data_Rich2HtmlConvertor,g=yne_jquery,h=yne_underscore,i=yne_underscorestring,j=yne_jtk_core_L,k=yne_common_util_unknownTree,l=yne_common_util_blockStyles,m=yne_jtk_core_assert,n=yne_common_data_listItemMarker,o=yne_common_util_convertPlain,p=yne_common_data_Block,q=yne_common_data_List,r=yne_common_constants,s=yne_collaboration_collabUtils;return b=c.extend({_type:e.LIST_ITEM,_level:null,_ownerList:null,_index:null,listId:null,listType:null,initialize:function(a){var b=this,d=a.level||1;c.prototype.initialize.call(b,a),b.setLevel(d),b.setIndex(1),a.list&&(b._ownerList=a.list,b.listId=b._ownerList.getId(),b.listType=b._ownerList.getType()),!b.listId&&a.listId&&(b.listId=a.listId),!b.listType&&a.listType&&(b.listType=a.listType),a.id&&b.setId(a.id),a.text&&b.setText(a.text),b.on("attached",b._onAttached.bind(b)),b.on("detached",b._onDetached.bind(b))},setLevel:function(a){h.isNumber(a)&&(a=Math.max(a,1),a=Math.min(a,r.MAX_LIST_ITEM_LEVEL),this._level=a,this._ownerList&&this._ownerList.updateIndexes(),this.trigger("level-change",a))},getLevel:function(){return this._level},setIndex:function(a){h.isNumber(a)&&a>0&&(this._index=a,this.trigger("index-change",a))},getIndex:function(){return this._index},setOwnerList:function(a){var b=this;b._ownerList=a,b._ownerList&&(b.listId=b._ownerList.getId(),b.listType=b._ownerList.getType())},getOwnerList:function(){return this._ownerList},isOrdered:function(){return this._ownerList.isOrdered()},_onAttached:function(a){var c,d,f=this,g=f.getOwnerList(),h=a.getAllBlocks(),i=a.getBlockIndex(f),j=null;if(m(i>=0,"Block not attached yet.",i,f),!g&&f.listId&&(g=b.getOrCreateListById(h,d.getListId(),d.getListType())),0===g.getLength())g.insertAfter(f,null);else{for(c=i-1;c>=0;--c)if(d=h[c],e.isListItem(d)&&d.getOwnerList()===g){j=d;break}g.insertAfter(f,j)}},_onDetached:function(){this.getOwnerList().removeItem(this)},toXml:function(a){var c,d=this,e=d.getOwnerList();return e?(c=b.__super__.toXml.apply(d,[a]),c.setAttribute("level",d.getLevel()),c.setAttribute("list-id",d.listId),{listId:d.listId,listType:e.getType(),ownerList:e,listItem:c}):void j.error("The list item has no owner list!")},toJSON:function(a,b){return this._generalToJSON(a,b,!1)},toCollabJSON:function(){return this._generalToJSON(null,null,!0)},_generalToJSON:function(a,c,d){var e,f=this;return e=d?b.__super__.toCollabJSON.apply(f):b.__super__.toJSON.apply(f,[a,c]),e.level=f.getLevel(),e.index=f.getIndex(),f.listId&&(e.listId=f.listId),f.listType&&(e.listType=f.listType),e},toHtml:function(a,b,c){var d,e,h,i,j=this,k=document.createElement("li"),l=g(k);return c=!0===c,j._applyBlockStylesOnElement(l),l.css("list-style-position","inside").css("white-space","pre-wrap"),i=n.makeHtmlMarker(j),i&&i.listStyleType&&l.css("list-style-type",i.listStyleType),i&&i.markerStyles&&l.css(i.markerStyles),a=a||0,d=j.sliceText(a,b,!1),e=f.rich2html(d,{withDefault:c}),k.innerHTML=e,h=k.outerHTML,k=l=null,h},toPlain:function(a,b){var c,d,e=this,f=e.getLevel()||1;return a=a||0,c=e.sliceText(a,b,!1),d=c.toString(),d=o(d),d=n.makePlainMarker(e)+d,d=i.repeat(" ",4*f-2)+d},getListId:function(){var a=this;return a._ownerList?a._ownerList.getId():a.listId},getListType:function(){var a=this;return a._ownerList?a._ownerList.getType():a.listType},updateListType:function(){var a=this;a._ownerList&&(a.listType=a._ownerList.getType())}},{fromXml:function(a){var c,e=g(a),f=parseInt(e.attr("level"))||1;return c=new b({level:f}),c.setText(d.fromXml(a)),c.parseIdFromXml(a),g(a).children().each(function(a,b){switch(b.nodeName){case p.TAG_ID_NAME:case p.LEGACY_TAG_ID_NAME:case"text":case"inline-styles":break;case"styles":l.fromXml(c,b);break;default:k.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){return this._generalFromJSON(a,!1)},fromCollabJSON:function(a){return this._generalFromJSON(a,!0)},getOrCreateListById:function(a,b,c){var d,f,g=null,h=b;for(f=a.length-1;f>=0;--f)if(d=a[f],e.isListItem(d)&&d.getOwnerList()&&d.getOwnerList().getId()===b){d.getOwnerList().getType()===c?g=d.getOwnerList():h=s.newGUID();break}return g||(g=new q({type:c,listId:h})),g},_generalFromJSON:function(a,c){var f,g,i,k;return a&&a.blockType&&a.blockType===e.LIST_ITEM?(a.listType&&(i=a.listType),a.listId&&(g=a.listId),a.blockId&&(k=a.blockId),f=new b({level:a.level,listId:g,listType:i,id:k}),a.index&&f.setIndex(a.index),c?f.setText(d.fromCollabJSON(a.richText)):f.setText(d.fromJSON(a.richText)),h.each(a.styles,function(a,b){f.setBlockStyle(b,a)}),f):void j.warn("jsonObj is not valid!")}})}(),yne_common_selection_ParagraphRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes,d=yne_jtk_core_L,e=b.extend({_type:c.PARAGRAPH,start:0,end:0,initialize:function(a){var b=this;a=a||{},b.start=a.start||0,b.end=a.end||0,b.block=a.block},isCollapsed:function(){var a=this;return a.start===a.end},clone:function(){var a=this;return e.create({start:a.start,end:a.end,block:a.block})},collapse:function(a){var b=this;!1===a?b.start=b.end:b.end=b.start},expandToStart:function(){var a=this,b=a.block.getStartOffset();a.start=b},expandToEnd:function(){var a=this,b=a.block.getEndOffset();a.end=b},getDataAsJSON:function(){var a=this;return a.block.toJSON(a.start,a.end)},getDataAsHtml:function(a){var b=this;return b.block.toHtml(b.start,b.end,a)},getDataAsPlain:function(){var a=this;return a.block.toPlain(a.start,a.end)},getContent:function(){var a=this;return a.block.sliceText(a.start,a.end)},canDrawedByNative:function(){return!0},getBlockId:function(){var a=this,b=null;return a.block&&(b=a.block.getId()),b},toCollabJSON:function(){var a=this,b=e.__super__.toCollabJSON.apply(a);return b.startPosition=a.start,b.endPosition=a.end,b}},{create:function(a){return new e(a)},fromCollabJSON:function(a,f){var g,h;if((h=a.rangeType)!==c.PARAGRAPH)return void d.error("wrong block range type:",h);if(g=b.getBlockById(a.blockId,f)){var i={block:g,start:a.startPosition,end:a.endPosition};return e.create(i)}}});return e}(),yne_common_selection_HeaderFooterRange=function(a){var b=yne_common_selection_BlockRange,c=b.extend({_type:"header-footer",block:null,start:0,end:0,initialize:function(a){var b=this;a=a||{},b.start=a.start||0,b.end=a.end||0,b.block=a.block},collapse:function(a){var b=this;!1===a?b.end=b.start:b.start=b.end},isCollapsed:function(){var a=this;return a.start===a.end},clone:function(){var a=this;return new c({block:a.block,start:a.start,end:a.end})},getDataAsPlain:function(){},canDrawedByNative:function(){return!0},toNativeRange:function(){},getBlockId:function(){return this.block.getId()},toCollabJSON:function(){var a=this.block.toCollabJSON();return a.rangeType=this._type,a.blockId=this.block.getId(),a},countWords:function(){var a=this;return a.end-a.start}},{isHeaderFooterRange:function(a){return a._type===c.prototype._type}});return c}();var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}();yne_common_selection_HandWriteRange=function(a,b,c,d){var e=function(a){function e(){var b=null!==a&&a.apply(this,arguments)||this;return b._type=c.HANDWRITE,b}return __extends(e,a),e.prototype.initialize=function(a){var c=this;b.prototype.initialize.apply(c,arguments),c._rangeProps={block:a.block}},e.prototype.canDrawedByNative=function(){return!1},e.prototype.clone=function(){return new g({block:this._rangeProps.block})},e.prototype.collapse=function(){},e.prototype.getDataAsJSON=function(){var a=this,b=a._rangeProps.block.toJSON();return(d.IS_WEB_NOTE||d.IS_WEB_GROUP)&&b.resource&&!/^http/i.test(b.resource)&&(b.resource=location.protocol+"//"+location.hostname+b.resource),b},e.prototype.getDataAsHtml=function(a){return this._rangeProps.block.toHtml(null,null,a)},e.prototype.getDataAsPlain=function(){return this._rangeProps.block.toPlain()},e.prototype.isCollapsed=function(){return!1},e}(b),f=function(){function a(){}return a.fromXml=function(a){throw"HandWrite do NOT support fromXml till now"},a}();delete e.prototype.constructor;var g=b.extend(e.prototype,f);return g}(0,yne_common_selection_BlockRange,yne_common_data_blockTypes,yne_common_util_platform),yne_common_util_rect={contains:function(a,b){if(!a||!b)return!1;var c=a.left+a.width,d=a.top+a.height,e=b.left+b.width,f=b.top+b.height;return a.left<=b.left&&a.top<=b.top&&c>=e&&d>=f},union:function(a,b){if(a&&b){var c=Math.min(a.left,b.left),d=Math.min(a.top,b.top);return a={left:c,top:d,width:Math.max(a.left+a.width,b.left+b.width)-c,height:Math.max(a.top+a.height,b.top+b.height)-d}}}},yne_jtk_web_dom_nodeType=function(a){var b=yne_underscore;return{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,getType:function(a){if(a&&a.nodeType)return a.nodeType},isNode:function(a){var c=this,d=c.getType(a);return b.isNumber(d)&&d>=c.ELEMENT_NODE&&d<=c.NOTATION_NODE},isElement:function(a){return this.getType(a)===this.ELEMENT_NODE},isAttribute:function(a){return this.getType(a)===this.ATTRIBUTE_NODE},isText:function(a){return this.getType(a)===this.TEXT_NODE},isCDataSection:function(a){return this.getType(a)===this.CDATA_SECTION_NODE},isEntityReference:function(a){return this.getType(a)===this.ENTITY_REFERENCE_NODE},isEntity:function(a){return this.getType(a)===this.ENTITY_NODE},isProcessingInstruction:function(a){return this.getType(a)===this.PROCESSING_INSTRUCTION_NODE},isComment:function(a){return this.getType(a)===this.COMMENT_NODE},isDocument:function(a){return this.getType(a)===this.DOCUMENT_NODE},isDocumentType:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isDocumentFragment:function(a){return this.getType(a)===this.DOCUMENT_TYPE_NODE},isNotation:function(a){return this.getType(a)===this.NOTATION_NODE}}}(),yne_common_data_table_tableCellType={TEXT:"text",IMAGE:"image",ATTACHMENT:"attachment"},yne_common_data_table_Resource=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L;return b.extend({_type:null,_resId:null,getType:function(){return this._type},isType:function(a){return this._type===a},getResId:function(){return this._resId||c.error("No resId"),this._resId},toHtml:function(){c.error("toHtml() should be implemented by sub-class")},toPlain:function(){c.error("toPlain() should be implemented by sub-class")},toXml:function(){c.error("toXml() should be implemented by sub-class")},toJSON:function(){c.error("toJSON() should be implemented by sub-class")},toCollabJSON:function(){c.error("toCollabJSON() should be implemented by sub-class")}},{fromXml:function(){c.error("fromXml() should be implemented by sub-class")},fromCollabJSON:function(){c.error("fromCollabJSON() should be implemented by sub-class")},TYPE_IMAGE:"image",TYPE_ATTACHMENT:"attachment"})}(),yne_common_util_parseImgSource={parseImgSource:function(a){var b=a.split("?")[0].replace(/^\//,"").split("/");return{resId:b[b.length-1]}}},yne_common_util_xml=function(a){var b=yne_jtk_core_L;return{appendText:function(a,c,d,e){if(!(a&&c&&d&&e))return void b.warn("unvalid parameters");var f=a.createElement(d),g=a.createTextNode(e);f.appendChild(g),c.appendChild(f)}}}(),yne_jtk_web_dom_parseHTML=function(){var a=function(a,b){var c,d,e;if(b.implementation&&b.implementation.createHTMLDocument)return c=b.implementation.createHTMLDocument("title"),c.body.innerHTML=a,c;if(e=b.defaultView||window,e.DOMParser){d=new e.DOMParser;try{c=d.parseFromString("","text/html")}catch(a){}if(c)return c.body.innerHTML=a,c}};return function(b,c,d,e){if(e=!0===e,b||e){c=c||document;var f,g,h,i,j=a(b,c);if(j){if(!1!==d)return j.body;for(h=j.body.childNodes,f=h.length,i=[],g=0;g<f;g++)i.push(h[g]);return i}}}}(),yne_common_util_formatLocalSource=function(a){if(!a||/^http/i.test(a))return a;var b,c=a.lastIndexOf("\\");return-1===c?a:(b=a.substring(c+1),a.substring(0,c+1)+encodeURIComponent(b))},yne_common_data_table_AttachmentResource=function(a){var b,c=yne_common_data_table_Resource,d=yne_common_util_parseImgSource,e=yne_jtk_core_L,f=yne_jquery,g=yne_underscore,h=yne_common_util_xml,i=yne_jtk_web_dom_parseHTML,j=yne_common_util_formatLocalSource,k=yne_common_util_platform;return b=c.extend({_type:c.TYPE_ATTACHMENT,initialize:function(a){var b=this;a=a||{},b._resId=a.resId||d.parseImgSource(a.resource).resId,b._source=a.source,b._resource=a.resource,b._fileLength=a.fileLength,b._fileName=a.fileName,delete b.options},getSource:function(a){var b=this,c=b._source;return a&&a[c]&&(c=a[c]),c},getResource:function(a){var b=this,c=b._resource;return a&&a[c]&&(c=a[c]),c},getInfo:function(){return{source:this._source,resource:this._resource,fileLength:this._fileLength,fileName:this._fileName}},getFileName:function(){return this._fileName},toPlain:function(){return""},toXml:function(a,b){var c=this,d=a.createElement("resource-mono"),e=a.createElement("attach"),f=c.getInfo();h.appendText(a,d,"res-id",c.getResId()),h.appendText(a,e,"source",f.source),h.appendText(a,e,"resource",f.resource),h.appendText(a,e,"filename",f.fileName),h.appendText(a,e,"filelength",f.fileLength),d.appendChild(e),b.appendChild(d)},toJSON:function(){return{resId:this.getResId()}},toCollabJSON:function(){var a,b=this;return a=b.getInfo(),a.resId=b._resId,a},toHtml:function(a){var b,c,d=this,e=i("",document,!0,!0),h=e.ownerDocument,l=f(h.createElement("img"));return a=g.defaults(a||{},{resourceMap:null}),c=d.getSource(a.resourceMap)||"",k.IS_PC&&(c=j(c)),l.attr({"data-media-type":"attachment",src:c,path:d.getResource(),filelength:d._fileLength,title:d._fileName,alt:d._fileName,filename:d._fileName}),b=l.get(0).outerHTML,h=l=null,b}},{create:function(a){return a&&a.source&&a.resource&&null!=a.fileLength&&a.fileName?(a.resId||e.warn("Will create resId by url!"),new b(a)):void e.warn("Failed to create AttachmentResource",a)},fromXml:function(a,c){var d=f(c),e=d.children("source:first").text(),g=d.children("resource:first").text(),h=d.children("filename:first").text(),i=d.children("filelength:first").text();return i&&(i=parseInt(i,10)),b.create({resId:a,source:e,resource:g,fileName:h,fileLength:i})},fromJSON:function(a,b){a.resId&&b&&b.attachMap||e.error("jsonObj or resourceList is wrong, ",a,b);var c=this,d=b.attachMap[a.resId];return d||e.error("resourceList is wrong"),c.fromCollabJSON(g.extend(a,d))},fromCollabJSON:function(a){return a.fileLength&&a.fileName&&a.resId&&a.resource&&a.source||e.error("jsonObj is wrong, ",a),b.create({resId:a.resId,source:a.source,resource:a.resource,fileName:a.fileName,fileLength:a.fileLength})}})}(),yne_common_data_table_ImageResource=function(a){var b,c=yne_common_data_table_Resource,d=yne_common_util_parseImgSource,e=yne_jtk_core_L,f=yne_jquery,g=yne_underscore,h=yne_common_util_xml,i=yne_common_util_formatLocalSource,j=yne_common_util_platform,k=yne_jtk_web_dom_parseHTML;return b=c.extend({_type:c.TYPE_IMAGE,_source:null,_width:null,_height:null,initialize:function(a){var b=this;a=a||{},b._resId=a.resId||d.parseImgSource(a.source).resId,b._source=a.source,b._width=a.width,b._height=a.height,delete b.options},getSource:function(a){var b=this,c=b._source;return a&&a[c]&&(c=a[c]),c},getSize:function(){return{width:this._width||null,height:this._height||null}},getInfo:function(){var a=this,b=a.getSize();return null===b.width&&null===b.height&&(b=null),g.extend({source:this.getSource()},b)},toPlain:function(){return""},toXml:function(a,b){var c=this,d=a.createElement("resource-mono"),e=a.createElement("image"),f=c.getSize();h.appendText(a,d,"res-id",c.getResId()),h.appendText(a,e,"source",c.getSource()),f&&g.each(["width","height"],function(a){var b=f[a];b&&h.appendText(e,a,b+"")}),d.appendChild(e),b.appendChild(d)},toJSON:function(){return{resId:this.getResId()}},toCollabJSON:function(){var a=this,b={};return b.source=a.getSource(),b.width=a._width||null,b.height=a._height||null,b.resId=a._resId,b},toHtml:function(a){var b,c,d=this,e=k("",document,!0,!0),h=e.ownerDocument,l=f(h.createElement("img"));return a=g.defaults(a||{},{resourceMap:null}),c=d.getSource(a.resourceMap)||"",j.IS_PC&&(c=i(c)),l.attr({"data-media-type":"image",src:c,width:"100%",height:"auto"}),b=l.get(0).outerHTML,h=l=null,b}},{create:function(a){return a&&a.source?(a.resId&&e.warn("Will create resId by url!"),new b(a)):void e.warn("Failed to create ImageResource",a)},fromXml:function(a,c){var d=f(c),e=d.children("source:first").text(),g=d.children("width:first").text(),h=d.children("height:first").text();return g&&(g=parseInt(g,10)),h&&(h=parseInt(h,10)),b.create({resId:a,source:e,width:g,height:h})},fromJSON:function(a,b){a.resId&&b&&b.imageMap||e.error("jsonObj is or resourceList wrong , ",a,b);var c=this,d=b.imageMap[a.resId];return d||e.error("resourceList wrong"),c.fromCollabJSON(g.extend(a,d))},fromCollabJSON:function(a){return a.resId&&a.source||e.error("jsonObj is wrong , ",a),b.create({resId:a.resId,source:a.source,width:a.width,height:a.height})}})}(),yne_common_data_table_Lines=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L,f=yne_common_data_Rich2HtmlConvertor,g=yne_common_data_RichText,h=yne_common_constants;return b=c.extend({initialize:function(a){var b=this;a=d.defaults(a||{},{richText:null}),delete b.options,b._richTextList=[],b.appendRichText(a.richText)},appendRichText:function(a){var c=this,d=b.splitRichText(a);d&&d.length&&(c._richTextList=c._richTextList.concat(d))},getAsRichTextList:function(){return[].concat(this._richTextList)},appendLines:function(a){if(a){var b=this;b._richTextList=b._richTextList.concat(a.getAsRichTextList())}},getCount:function(){return this._richTextList.length},isEmpty:function(){var a=this._richTextList;return!a||!a.length||d.every(a,function(a){return a&&a.isEmpty()})},_walkLinesRange:function(a,b){var c,d,e,f,g=this,h=g.getCount(),i=a.startLine,j=a.endLine;for(c=i;c<j&&c<h;c++)c===i?(d=g._richTextList[c],e=a.startChar,f=d.getLength()):c===j?(e=0,f=Math.min(d.getLength(),a.endChar)):(e=0,f=d.getLength()),b(d,e,f)},setStyle:function(a,b){var c,e=this;d.isArray(b)?(c=b,d.each(e._richTextList,function(b,d){var e=c[d];b.setStyle(0,b.getLength(),a,e)})):d.each(e._richTextList,function(c){c.setStyle(0,c.getLength(),a,b)})},getStyle:function(a){var b=this,c=[];return d.each(b._richTextList,function(b){var d=b.getStyle(0,b.getLength(),a);c.push(d)}),c},getCommonStyles:function(a,b,c){var d=this,e=d.toRichText();return a=a||0,b=b||e.getLength(),e.getCommonStyles(a,b,c)},getCommonStyle:function(a){var b,c=this;return d.some(c._richTextList,function(c){if(c&&!c.isEmpty()){var d=c.getCommonStyle(0,c.getLength(),a,!0);if(null==b)null!=d&&(b=d);else if(b!==d)return b=h.INTERM,!0}}),b===h.INTERM&&(b=null),b},toRichText:function(){var a,b=this,c=b.getCount(),d=b._richTextList,e=g.create("",!0);for(a=0;a<c;a++)e.append(d[a]),a<c-1&&e.append(g.create("\n",!0));return e},toString:function(){return this.toRichText().toString()},toPlain:function(){return d.map(this._richTextList,function(a){return a?a.toString():""})},toHtml:function(a){a=d.defaults(a||{},{handleLineWrapper:function(a){a.className="table-cell-line"}});var b=this,c=a.styleRules,e=d.map(b._richTextList,function(b,d){var e=f.rich2html(b,{styleRules:c}),g=document.createElement("div");return a.handleLineWrapper(g,b,d),g.innerHTML=e,g.outerHTML});return e=e.join("")},toJSON:function(){return d.map(this._richTextList,function(a){return a.toJSON()})},toCollabJSON:function(){return d.map(this._richTextList,function(a){return a.toCollabJSON()})}},{create:function(a){return a&&a.richText?new b(a):void e.warn("Failed to create Lines",a)},createBlank:function(a){return a?b.create({richText:g.createBlank(!1)}):new b({})},splitRichText:function(a){if(a){if(0===a.getLength()||!a.isKeepLineBreak())return[a];var b,c=a.getReadOnlyData(),e=[],f=[],h=0;for(h=0;h<c.length;h++)b=c[h],b.isLineBreak()?(e.push(f),f=[]):f.push(b);return f.length&&e.push(f),e=d.map(e,function(a){var b=g.create("",!1);return b.appendRichChars(a),b})}},fromJSON:function(a){var c=b.createBlank();return d.map(a,function(a){c.appendRichText(g.fromJSON(a))}),c},fromCollabJSON:function(a){var c=b.createBlank();return d.map(a,function(a){c.appendRichText(g.fromCollabJSON(a))}),c}})}(),yne_common_data_table_tableCellUtil=function(a){var b=yne_common_data_table_tableCellType,c=yne_jtk_core_L,d=yne_underscore,e=yne_common_data_table_Resource,f=yne_common_data_table_AttachmentResource,g=yne_common_data_table_ImageResource,h=yne_common_data_table_Lines;return{contentToPlain:function(a,b){if(!a)return"";var d;return a instanceof h?(d=a.toPlain(),d.join(b?"\n":"")):a instanceof g?a.toPlain():a instanceof f?a.toPlain():(c.warn("unvalid content",a),"")},contentToHtml:function(a,b){return a?a instanceof h||a instanceof g||a instanceof f?a.toHtml({resourceMap:b}):(c.warn("unvalid content",a),""):""},contentToJSON:function(a,c){c=!0===c;var d,f=b.TEXT;if(a){if(a.getType)switch(a.getType()){case e.TYPE_IMAGE:f=b.IMAGE;break;case e.TYPE_ATTACHMENT:f=b.ATTACHMENT}return d=c?a.toCollabJSON():a.toJSON(),{type:f,data:d}}},contentToCollabJSON:function(a){return this.contentToJSON(a,!0)},contentFromJSON:function(a,d,e){if(a){var i,j=a.type,k=a.data;switch(j){case b.IMAGE:i=d?g.fromCollabJSON(k):g.fromJSON(k,e);break;case b.ATTACHMENT:i=d?f.fromCollabJSON(k):f.fromJSON(k,e);break;case b.TEXT:i=d?h.fromCollabJSON(k):h.fromJSON(k);break;default:c.error("do not support type",j)}return i}},contentFromCollabJSON:function(a){return this.contentFromJSON(a,!0)},oldStyleNameMap:{bold:"bold",italic:"italic",underline:"underline",lineThrough:"strike",fontName:"font-family",fontSize:"font-size",textColor:"color",link:"href"},inlineStyle2oldCell:function(a){var b=this,c=this.oldStyleNameMap,e={};return d.map(c,function(c,d){if(null!=a[c])return void(e[d]=b.boolean2string(a[c]))}),e},blockStyle2oldCell:function(a){var b=this,c={};return d.map(a,function(a,d){c[d]=b.boolean2string(a)}),c},boolean2string:function(a){return d.isBoolean(a)?String(a):a}}}(),yne_common_data_table_tableRenderer=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_L,e=yne_common_data_table_tableCellUtil;return{_table:null,_tableEl:null,_setCellStyles:function(a,b,c){c=!1!==c;var d;d=b.textAlign,a.style.textAlign="center"===d||"right"===d||"left"===d?d:"",d=b.verticalAlign,a.style.verticalAlign="top"===d||"middle"===d||"bottom"===d?d:"",c||"true"===b.wrap?a.style.whiteSpace="pre-wrap":a.style.whiteSpace="nowrap",d=b.backColor,a.style.backgroundColor=d&&"inherit"!==d&&"transparent"!==d?d:""},_handleMergePointIfNeeded:function(a,b){if(b.isMergePoint()){var c=b.getMergePointAttr();c.width>0&&a.setAttribute("colspan",c.width),c.height>0&&a.setAttribute("rowspan",c.height)}},_renderCell:function(a,d,f,g){f=f||document.createElement("td"),c(f).css({"font-size":14,color:"#393939",border:"1px solid #a7a7a7",overflow:"hidden","vertical-align":"middle","word-wrap":"break-word","background-color":"rgba(255, 255, 255, 0.3)"}),g=b.defaults(g||{},{withCellId:!0,resourceMap:null});var h,i=this,j=i._table.getCell(a,d),k=j.getContent();return g.withCellId&&f.setAttribute("data-cell-id",j.getCellId()),i._handleMergePointIfNeeded(f,j),i._setCellStyles(f,j.getBlockStyles(),!0),h=e.contentToHtml(k,g.resourceMap),f.innerHTML=h,f},_createTableEl:function(){var a=document,b=a.createElement("table");return b.innerHTML="<colgroup></colgroup><tbody></tbody>",b},_renderColumns:function(a){var b=this,c=b._table;if(!a)return void d.warn("parameter is not valid",a);a.innerHTML="",c.forEachColumn(function(b){var d=c.getColumnWidth(b),e=document.createElement("col");e.style.width=d+"px",a.appendChild(e)})},renderTable:function(a,b,d){var e,f,g,h,i,j=this,k=a.getRowCount(),l=a.getColumnCount();for(b=b||j._createTableEl(),e=b.querySelector("tbody"),j._table=a,j._tableEl=b,h=0;h<k;h++){for(f=document.createElement("tr"),i=0;i<l;i++)g=a.getCell(h,i),g.isMergedCell()||f.appendChild(j._renderCell(h,i,null,{resourceMap:d}));f.style.height=a.getRowHeight(i)+"px",e.appendChild(f)}return j._renderColumns(b.querySelector("colgroup")),j._table=null,j._tableEl=null,c(b).css({"border-collapse":"collapse","table-layout":"fixed","white-space":"nowrap",width:0}),b}}}(),yne_common_data_table_resourceClassMap=function(a){return{image:yne_common_data_table_ImageResource,attach:yne_common_data_table_AttachmentResource}}(),yne_common_data_table_blockStyleConfig=function(a){return yne_common_util_freeze({textAlign:{type:"Enum",possible:{left:!0,right:!0,center:!0,justify:!0},default:"left"},verticalAlign:{type:"Enum",possible:{top:!0,middle:!0,bottom:!0},default:"left"},wrap:{type:"Boolean",default:!1},backColor:{type:"String",default:{BACK_COLOR:"transparent"}.BACK_COLOR}})}(),yne_common_data_table_supportedBlockStyles=function(a){var b=yne_underscore,c=yne_common_data_table_blockStyleConfig,d=b.keys(c)||[];return{isSupport:function(a){return d.indexOf(a)>-1},getConfig:function(a){var b,d=this;return d.isSupport(a)&&(b=c[a]),b},getDefault:function(a){return(this.getConfig(a)||{}).default},getAllDefaults:function(){var a=this,c={};return b.each(d,function(b){c[b]=a.getDefault(b)}),c},getAllStyleNames:function(){return[].concat(d)},bulbStyles2TableStyles:function(a){return a.align&&(a.textAlign=a.align,delete a.align),a},tableStyles2BulbStyles:function(a){return a.textAlign&&(a.align=a.textAlign,delete a.textAlign),a}}}(),yne_common_data_Todo=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_Paragraph,i=yne_common_data_blockTypes,j=yne_jtk_core_L,k=yne_common_util_unknownTree,l=yne_common_util_blockStyles,m=yne_common_data_Rich2HtmlConvertor,n=yne_common_data_RichText,o=yne_common_util_convertPlain;return b={_type:i.TODO,_checked:!1,_legacyResId:null,initialize:function(a){h.prototype.initialize.apply(this,arguments),null!=a.checked&&(this._checked=a.checked),null!=a.legacyResId&&(this._legacyResId=a.legacyResId)},setChecked:function(a){a!==this._checked&&(this._checked=a,this.trigger("checked-change",a))},getChecked:function(){return this._checked},isFromOldTodo:function(){return!!this._legacyResId},getLegacyResId:function(){return this._legacyResId},toXml:function(a){var b,c,e=this;return c=d.__super__.toXml.apply(e,[a]),b=a.createElement("checked"),b.appendChild(a.createTextNode(e.getChecked())),c.appendChild(b),k.appendToXml(e.unknownTree,c),c.setAttribute("compat","true"),c},toJSON:function(){var a=this,b=d.__super__.toJSON.apply(a,arguments);return b.checked=a.getChecked(),b},toHtml:function(a,b,c){var d,f=document.createElement("div"),g=e(document.createElement("div")),h=e(document.createElement("div")),i=this.getChecked(),j=e(f);return j.attr("yne-bulb-block","todo").attr("yne-bulb-checked",i).attr("id",this.getId()).css("display","table"),g.css({display:"inline-flex",position:"relative","line-height":"1",border:"1px solid #bbb",width:"1em",height:"1em"}),i&&(g.css({"background-repeat":"no-repeat","background-position":"center","background-size":"100%",
"background-image":"url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgdmlld0JveD0iMCAwIDUwIDUwIiBzdHlsZT0iaGVpZ2h0OiAxMDAlO3dpZHRoOiAxMDAlO3N0cm9rZS13aWR0aDogMjtzdHJva2U6IGJsYWNrO3RvcDogMDtsZWZ0OiAwO3Bvc2l0aW9uOiBhYnNvbHV0ZTsiICB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIj4KICAgIDxwYXRoIGZpbGw9Im5vbmUiIGQ9Ik0xNC4xIDI3LjJsNy4xIDcuMiAxNi43LTE2LjgiPjwvcGF0aD4KPC9zdmc+)"}),j.css("text-decoration","line-through")),this._applyBlockStylesOnElement(j),a=a||0,b=null==b?this.getEndOffset():b,d=this.sliceText(a,b,!1),h.html(m.rich2html(d,{withDefault:c})),h.attr("yne-bulb-todo-content","").css({display:"table-cell","word-break":"break-word","padding-left":"8px",width:"100%"}),j.append(g),j.append(h),f.outerHTML},toPlain:function(a,b){a=a||0;var c=this,e=d.getMarker(c),f=c.sliceText(a,b,!1);return e+o(f.toString())},countWords:function(){return this.content.length},toCollabJSON:function(){var a=d.__super__.toCollabJSON.call(this);return a.checked=this.getChecked(),a}},c={CHECKED_MARKER:"✔",UNCHEKED_MARKER:"☐",getMarker:function(a){if(!a)return"";var b=a.getChecked()?d.CHECKED_MARKER:d.UNCHEKED_MARKER;return b+=" "},fromXml:function(a){var b=e(a),c="true"===b.find("> checked:first").text(),f=new d({checked:c});return f.setText(n.fromXml(a)),f.parseIdFromXml(a),b.children().each(function(a,b){switch(b.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"checked":case"text":case"inline-styles":break;case"styles":l.fromXml(f,b);break;default:k.appendToTree(f.unknownTree,b)}}),f},fromJSON:function(a){return c._generalFromJSON(a,!1)},fromCollabJSON:function(a){return c._generalFromJSON(a,!0)},_generalFromJSON:function(a,b){if(!a||!a.blockType||a.blockType!==i.TODO)return void j.warn("jsonObj or jsonObj.content does NOT exist!");var c,e=new d({checked:a.checked});return a.blockId&&e.setId(a.blockId),c=b?n.fromCollabJSON(a.richText):n.fromJSON(a.richText),e.setText(c),f.each(a.styles,function(a,b){e.setBlockStyle(b,a)}),e}},d=h.extend(b,c)}(),yne_common_data_table_TableCell=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_underscorestring,f=yne_jtk_core_L,g=yne_common_data_table_Resource,h=yne_common_data_table_supportedBlockStyles,i=yne_common_data_RichText,j=yne_common_data_table_Lines,k=yne_common_data_table_tableCellUtil,l=yne_common_data_table_tableCellType,m=yne_common_data_listItemMarker,n=yne_common_data_Todo,o=yne_collaboration_collabUtils,p=["mergeWidth","mergeHeight","mergePointDX","mergePointDY"],q=yne_common_data_blockTypes,r=yne_common_data_table_ImageResource,s=yne_common_data_table_AttachmentResource;return b=c.extend({_cellId:null,_content:null,_mergeWidth:null,_mergeHeight:null,_mergePointDX:null,_mergePointDY:null,_styles:null,_locked:!1,_unknown:null,_stylesForEmpty:null,initialize:function(a){var b=this;a=a||{},b._styles={},b._cellId=a.cellId||o.newGUID(),b.setContent(a.content),b.setBlockStyles(a.styles),b.setMergePointAttr(a.mergeWidth,a.mergeHeight),b.setMergedCellAttr(a.mergePointDX,a.mergePointDY),b.setUnknown(a.unknown),b._stylesForEmpty={},delete b.options},getCellId:function(){return this._cellId},_setCellId:function(a){a&&(this._cellId=a)},setBlockStyle:function(a,b){var c=this,e=h.getConfig(a);e&&(c.isLocked()||("Enum"===e.type?e.possible[b]||(b=e.default):"Number"!==e.type||d.isNumber(b)?"Boolean"!==e.type||d.isBoolean(b)?d["is"+e.type]&&(d["is"+e.type](b)||(b=b.default)):b="true"===b:(b=null===b||""===b?NaN:Number(b),!isNaN(b)&&b||(b=e.default)),b=b||e.default,c._styles[a]=b,f.log("style-change "+a+": "+b)))},clearStyles:function(){this._styles={}},getBlockStyles:function(){return this._styles},getBlockStylesAsBulb:function(){var a=d.clone(this._styles);return h.tableStyles2BulbStyles(a)},getContent:function(){return this._content},setContent:function(a){var b=this,c=!1;if(!b.isLocked())return a instanceof j?(b._content=a,c=!0,b.isTextNoEmptyCell()&&b.clearStylesForEmpty()):a instanceof g&&(b._content=a,c=!0),c},setBlockStyles:function(a){var b=this;if(!b.isLocked())return a?(d.each(a,function(a,c){b.setBlockStyle(c,a,!1)}),!0):void 0},setInlineStyles:function(a){if(a&&this.isTextNoEmptyCell()){var b=this.getContent();d.each(a,function(a,c){b.setStyle(c,a)})}},getInlineStyles:function(a){if(this.isTextNoEmptyCell()){var b=this.getContent(),c={};return a.forEach(function(a){c[a]=b.getStyle(a)}),c}},getType:function(){var a=this,b=l.TEXT,c=a.getContent();if(c&&c.getType)switch(c.getType()){case g.TYPE_IMAGE:b=l.IMAGE;break;case g.TYPE_ATTACHMENT:b=l.ATTACHMENT}return b},isTextNoEmptyCell:function(){var a=this.getContent();return!!a&&(this.getType()===b.TYPE_TEXT&&!a.isEmpty())},isAttachmentCell:function(){return this.getType()===l.ATTACHMENT},isImageCell:function(){return this.getType()===l.IMAGE},clearMergePointAttr:function(){delete this._mergeWidth,delete this._mergeHeight},clearMergedCellAttr:function(){delete this._mergePointDX,delete this._mergePointDY},getMergePointAttr:function(){var a=this;return{width:a._mergeWidth||0,height:a._mergeHeight||0}},getMergedCellAttr:function(){var a=this;return{dx:a._mergePointDX||0,dy:a._mergePointDY||0}},setMergePointAttr:function(a,b){var c=this;return!(!a&&!b)&&(a>=1&&!b&&(f.warn("No valid mergeHeight, will set 1"),b=1),b>=1&&!a&&(f.warn("No valid mergeWidth, will set 1"),a=1),c._mergeWidth=a,c._mergeHeight=b,c.clearMergedCellAttr(),!0)},setMergedCellAttr:function(a,b){var c=this;if(null!=a&&null!=b&&a>=0&&b>=0&&(a>0||b>0))return c._mergePointDX=a,c._mergePointDY=b,c.clearMergePointAttr(),!0},isMergePoint:function(){var a=this.getMergePointAttr();return a.width>1||a.height>1},isMergedCell:function(){var a=this.getMergedCellAttr();return a.dx>=1||a.dy>=1},setUnknown:function(a){a&&(this._unknown=a)},isLocked:function(){return this._locked},setLocked:function(a){this._locked=!0===a},isEmpty:function(){var a=this,b=a.getType(),c=a._content;return b===l.TEXT&&(!c||c.isEmpty())},getCommonInlineStyle:function(a){var b=this,c=b.getContent();return b.isTextNoEmptyCell()&&c.getCommonStyle?c.getCommonStyle(a):b._stylesForEmpty[a]},getCommonInlineStyles:function(){var a=this,b=a.getContent();return a.isTextNoEmptyCell()&&b.getCommonStyles?b.getCommonStyles():a._stylesForEmpty},setStylesForEmpty:function(a){f.log("setStylesForEmpty",a),d.extend(this._stylesForEmpty,a)},getStylesForEmpty:function(a){var b,c=this;return a?(b={},d.each(a,function(a){b[a]=c._stylesForEmpty[a]}),b):c._stylesForEmpty},clearStylesForEmpty:function(){this._stylesForEmpty={}},toPlain:function(a){var b=this;return b.isMergedCell()?"":k.contentToPlain(b._content,a)},toHtml:function(){f.erro("Should not call TabelCell.toHtml()")},toJSON:function(a){var b,c=this,e={},f={};return c.isMergedCell()&&(e=d.extend(e,c.getMergedCellAttr()),d.extend(f,{mergePointDX:e.dx,mergePointDY:e.dy})),c.isMergePoint()&&(e=d.extend(e,c.getMergePointAttr()),d.extend(f,{mergeWidth:e.width,mergeHeight:e.height})),c.isTextNoEmptyCell()&&(f.value=c._content.toString(),a&&(b=c._content.getCommonStyles(null,null,!0),d.extend(f,k.inlineStyle2oldCell(b)))),a?d.extend(f,k.blockStyle2oldCell(c._styles)):d.extend(f,{cellId:c.getCellId(),content:k.contentToJSON(c._content)},k.blockStyle2oldCell(c._styles)),f},toCollabJSON:function(){var a,b=this,c={};return b.isMergedCell()&&(c=d.extend(c,b.getMergedCellAttr())),b.isMergePoint()&&(c=d.extend(c,b.getMergePointAttr())),a={cellId:b.getCellId(),styles:d.extend({},b._styles),content:k.contentToCollabJSON(b._content)},d.isEmpty(c)||(a.attr=c),a},toXml:function(a,b,c){var e,g,h,i,j,k,m=this,n={};if(m.isMergedCell())return e=m.getMergedCellAttr(),{value:"",mergePointDX:e.dx,mergePointDY:e.dy};switch(m.isMergePoint()&&(e=m.getMergePointAttr(),n={mergeWidth:e.width,mergeHeight:e.height}),g=m.getType(),h=m.getContent(),d.isEmpty(m._styles)||d.extend(n,m._styles),d.isEmpty(m._unknown)||d.extend(n,m._unknown),g){case l.TEXT:i=h.toRichText(),j=i.toJSON(!0),n.value=j.text,j.inlineStyles&&(n.inlineStyles=j.inlineStyles);break;case l.IMAGE:case l.ATTACHMENT:k=h.getResId(),n.value="",n.resource=k,k&&!0===c[k]?f.warn("resource has already in <resource-list>",k,h):(h.toXml(a,b),c[k]=!0);break;default:f.error("unvalid type",g)}return n}},{TYPE_TEXT:"text",TYPE_IMAGE:"image",TYPE_ATTACHMENT:"attachment",create:function(a){if(!a||!a.content)return void f.warn("Failed to create TableCell",a);var c=a.content;return c instanceof j||c instanceof g?new b(a):void f.warn("Failed to create TableCell",a)},makeCellId:function(a,b,c){return[a,"cell",b,c].join("-")},createByTable:function(a,c,d,e){var f=a.getId(),g=b.makeCellId(f,c,d);return b.create({cellId:g,content:e})},_richTextFromJSON:function(a){if(a&&a.value){var b=a.value,c=new i({text:b}),e=k.oldStyleNameMap,f=c.getLength();return d.each(e,function(b,e){var g=b,h=a[e];null!=h&&("font-size"===g&&d.isString(h)&&(h=h.replace("px","")),c.setStyle(0,f,g,h))}),a.inlineStyles&&d.each(a.inlineStyles,function(a,b){d.each(a,function(a){c.setStyle(a.from,a.to,b,a.value)})}),c}},_linesFromJSON:function(a){var c=b._richTextFromJSON(a);return c?j.create({richText:c}):j.createBlank()},_resourceFromJSON:function(a,b){if(a&&a.resource){var c=a.resource,d=b[c];return d&&d.getResId&&d.getResId()===c?d:void 0}},fromJSON:function(a,c,e){a||f.error("Bad json data!");var g={};return g.styles=d.pick(a,h.getAllStyleNames()),d.extend(g,d.pick(a,p),{cellId:a.cellId,content:k.contentFromJSON(a.content,!1,e)||j.createBlank()}),c&&delete g.cellId,b.create(g)},fromCollabJSON:function(a){var c={cellId:a.cellId,styles:a.styles,content:k.contentFromCollabJSON(a.content)};return a.attr&&(c.mergeWidth=a.attr.width,c.mergeHeight=a.attr.height,c.mergePointDX=a.attr.dx,c.mergePointDY=a.attr.dy),b.create(c)},fromXml:function(a){if(!a||!a.tableBlockId||null==a.rowIndex||null==a.colIndex)return void f.warn("Failed to create TableCell from JSON",a);var c,e=this,g=b.makeCellId(a.tableBlockId,a.rowIndex,a.colIndex),i={cellId:g},l=a.cellRawData,m=a.resourceMap,n=e._resourceFromJSON(l,m),o=p,q=h.getAllStyleNames(),r=["value","resource","inlineStyles"].concat(o,q);return n?i.content=n:(c=e._linesFromJSON(l),i.content=c||j.createBlank()),l=l||{},i.unknown=d.omit(l,r.concat(d.keys(k.oldStyleNameMap))),i.styles=d.pick(l,q),d.extend(i,d.pick(l,o)),b.create(i)},blockToCellContent:function(a){if(a){var b,c,g,h,k,l,o=q.getType(a);switch(o){case q.PARAGRAPH:case q.CATALOGUE:c=j.create({richText:a.getText()});break;case q.IMAGE:case q.HANDWRITE:c=r.create({source:a.getSource()});break;case q.ATTACHMENT:c=s.create({source:a.getSource(),resource:a.getResource(),fileName:a.getFileName(),fileLength:a.getFileLength()});break;case q.LIST_ITEM:b=a.getText(),b.getLength()&&(l={},d.each(b.getStylesAtIndex(0),function(a,b){m.isSupportedStyle(b)&&(l[b]=a)})),h=m.makePlainMarker(a,!1),h=i.create(h,!1),l&&h.setStyles(0,h.getLength(),l),h.append(i.create(" ",!1)),g=a.getLevel()||1,k=e.repeat(" ",4*(g-1)),k=i.create(k,!1),k.append(h),k.append(b),c=j.create({richText:k});break;case q.TODO:k=n.getMarker(a),k=i.create(k,!1),b=a.getText(),a.getChecked()&&b.setStyles(0,b.getLength(),{strike:!0}),k.append(b),c=j.create({richText:k});break;default:f.warn("Failed to handle block to cell",o,a)}return c}},blockToCell:function(a){var c,d=b.blockToCellContent(a);return d&&(c=b.create({content:d})),c}})}(),yne_common_data_table_constantConfig=function(a){var b=yne_common_util_freeze,c={DEFAULT_ROW_HEIGHT:40,DEFAULT_COL_WIDTH:70,MIN_ROW_COUNT:1,MIN_COL_COUNT:1,MAX_ROW_COUNT:500,MAX_COL_COUNT:35,ATTACHMENT_MIN_WIDTH:285,ATTACHMENT_MIN_HEIGHT:64,DEFAULT_TABLE_WIDTH:620};return c=b(c,!0)}(),yne_common_data_table_tableUtil=function(a){var b=yne_underscore,c=yne_jtk_core_L,d=yne_common_data_table_TableCell;return{cellsFromJSON:function(a){var b,e,f,g=a.cellsJson,h=a.height,i=a.width,j=a.isUpdateCellId,k=a.resourceList,l=[];if(!g)return null;for(b=0;b<h;b++)for(l[b]=[],e=0;e<i;e++)f=b*i+e,g[f]||c.error("Bag json data, no cellData json, row, col: ",g,b,e),l[b][e]=d.fromJSON(g[f],j,k);return l},cellsToCollabJSON:function(a){return a?b.map(a,function(a){return b.map(a,function(a){return a.toCollabJSON?a.toCollabJSON():a})}):null},cellsFromCollabJSON:function(a){return a?b.map(a,function(a){return b.map(a,function(a){return d.fromCollabJSON(a)})}):null}}}(),yne_common_data_tableDataCheck_createBlankCell=function(){return{value:""}},yne_common_data_tableDataCheck_createBlankTable=function(a){var b=yne_common_data_table_constantConfig,c=yne_common_data_tableDataCheck_createBlankCell;return function(a,d){a=a||1,d=d||1;var e,f=[],g=[],h=[],i=a*d;for(e=0;e<a;e++)g.push(b.DEFAULT_ROW_HEIGHT);for(e=0;e<d;e++)f.push(b.DEFAULT_COL_WIDTH);for(e=0;e<i;e++)h.push(c());return{widths:f,heights:g,cells:h}}}(),yne_common_data_tableDataCheck_size=function(a){var b=yne_common_data_tableDataCheck_createBlankTable,c=yne_common_data_tableDataCheck_createBlankCell,d=yne_underscore,e=yne_common_data_table_constantConfig;return{name:"size",checkAndFix:function(a){if(!a.cells||!d.isArray(a.cells))return{errors:["The `cells` property is not Array type!"],fixedData:b(),stopCheck:!0};var f,g,h=a.cells,i=a.widths,j=a.heights,k=!0,l=!0,m=[];for(i&&d.isArray(i)||(k=!1,m.push("The `widths` property is not Array type!")),j&&d.isArray(j)||(l=!1,m.push("The `heights` property is not Array type!")),k||l?k?l||(j=[],0===i.length&&(i.length=5),j.length=Math.ceil(h.length/i.length)):(i=[],0===j.length&&(j.length=5),i.length=Math.ceil(h.length/j.length)):(i=[],i.length=5,j=[],j.length=Math.ceil(h.length/i.length)),f=i.length*j.length,g=!1;f<h.length;)j.push(e.DEFAULT_ROW_HEIGHT),f=i.length*j.length,g=!0;for(g&&m.push("The widths.length * heights.length is less than cells.length"),f=i.length*j.length,g=!1;f>h.length;)h.push(c()),g=!0;return g&&m.push("The widths.length * heights.length is greater than cells.length"),g=!1,i=d.map(i,function(a){return a&&d.isNumber(a)?a:(g=!0,e.DEFAULT_COL_WIDTH)}),g&&m.push("The `widths` has unvalid value"),g=!1,j=d.map(j,function(a){return a&&d.isNumber(a)?a:(g=!0,e.DEFAULT_ROW_HEIGHT)}),g&&m.push("The `heights` has unvalid value"),{errors:m,fixedData:{widths:i,heights:j,cells:h},stopCheck:!1}}}}(),yne_common_data_tableDataCheck_cellValue=function(a){var b=yne_common_data_tableDataCheck_createBlankCell,c=yne_underscore;return{name:"cellValue",checkAndFix:function(a){var d,e,f,g=a.cells,h=g.length,i=!1,j=!1,k=[];for(d=0;d<h;d++)e=g[d],c.isObject(e)?null==(f=e.value)||c.isString(f)||(j=!0,e.value=f+""):(i=!0,g[d]=b());return i&&k.push("Some cell is NOT Object type"),j&&k.push("The value of some cell is not String type"),{errors:k,fixedData:a,stopCheck:!1}}}}(),yne_common_data_tableDataCheck_mergeDefaults=function(a){var b=yne_underscore;return{name:"mergeDefaults",checkAndFix:function(a){var c=a.cells,d=!1,e=[];return b.each(c,function(a){a.mergeWidth&&!a.mergeHeight?(a.mergeHeight=1,d=!0):a.mergeHeight&&!a.mergeWidth&&(a.mergeWidth=1,d=!0)}),d&&e.push("Some cell has no default value for mergeHeight or mergeWidth"),{errors:e,fixedData:a,stopCheck:!1}}}}(),yne_common_data_tableDataCheck_mergeCells=function(a){var b=yne_underscore,c=function(a,c,d){var e={},f="";return b.some(a,function(c,g){if(!e[g+""]){var h,i,j,k,l,m,n,o,p,q,r,s;if(c.mergeWidth||c.mergeHeight){if(c.mergeWidth&&!b.isNumber(c.mergeWidth))return f="The mergeWidth is not Number type",!0;if(c.mergeHeight&&!b.isNumber(c.mergeHeight))return f="The mergeHeight is not Number type",!0;if(null!=c.mergePointDX||null!=c.mergePointDY)return f="The cell data is not valid, index: "+g,!0;for(h=c.mergeWidth||1,i=c.mergeHeight||1,j=Math.floor(g/d),k=g%d,p=0;p<i;p++)for(l=j+p,o=0;o<h;o++)if(p>0||o>0){if(m=k+o,n=l*d+m,q=a[n],q.mergeWidth||q.mergeHeight)return f="The merged cell should not have `mergeWidth` or `mergeHeight`, merge point cell index: "+g+", merged cell index: "+n,!0;if(q.value)return f="The `value` of merged cell should be empty string,merge point cell index: "+g+", index: "+n,!0;if(r=q.mergePointDX||0,s=q.mergePointDY||0,r!==o||s!==p)return f="The `mergePointDX` or `mergePointDY` of mergedCell is not valid, merge point cell index: "+g+",  merged cell index: "+n,!0;e[n+""]=!0}}e[g+""]=!0}}),f||!0};return{name:"mergeCells",checkAndFix:function(a){var d=a.cells,e=a.heights,f=a.widths,g=c(d,e.length,f.length),h=[];return!0!==g&&(h.push(g),b.each(d,function(a){delete a.mergeWidth,delete a.mergeHeight,delete a.mergePointDX,delete a.mergePointDY})),{errors:h,fixedData:a,stopCheck:!1}}}}(),yne_common_data_tableDataCheck_checkAndFix=function(a){var b=yne_underscore,c=[yne_common_data_tableDataCheck_size,yne_common_data_tableDataCheck_cellValue,yne_common_data_tableDataCheck_mergeDefaults,yne_common_data_tableDataCheck_mergeCells];return function(a){a=a||{};var d,e,f,g=window.JSON.parse(window.JSON.stringify(a)),h=c.length,i=g,j=[],k=function(a){j.push(e.name+".js: "+a)};for(d=0;d<h;d++){if(e=c[d],f=e.checkAndFix(i),b.each(f.errors,k),!0===f.stopCheck)return{errors:j,fixedData:f.fixedData};i=f.fixedData}return{errors:j,fixedData:i}}}(),yne_common_util_forEachTimes=function(a,b,c,d){var e,f,g;for(e=0;e<c;e++)if(g=b?c-e-1:e,null==d){if(!1===a(g))return}else for(f=0;f<d;f++)if(!1===a(g,b?d-f-1:f))return},yne_common_data_Table=function(a){var b=yne_common_data_Block,c=yne_common_data_blockTypes,d=yne_jquery,e=yne_underscore,f=yne_jtk_core_L,g=yne_jtk_web_dom_nodeType,h=yne_common_util_unknownTree,i=yne_common_util_blockStyles,j=yne_common_data_table_tableRenderer,k=yne_common_util_countText,l=yne_common_data_table_tableCellType,m=yne_common_data_table_resourceClassMap,n=yne_common_data_table_TableCell,o=yne_common_data_table_constantConfig,p=yne_common_data_RichText,q=yne_common_data_table_Lines,r=yne_common_data_table_supportedBlockStyles,s=yne_common_data_table_tableUtil,t=yne_common_data_tableDataCheck_checkAndFix,u=yne_common_constants,v=yne_common_util_forEachTimes,w=b.extend({_type:c.TABLE,_tableCells:null,_rowHeights:null,_colWidths:null,_resourceMap:null,initialize:function(a){var c=this;b.prototype.initialize.apply(c,arguments),a=a||{},c.setContentData(a.tableCells,a.rowHeights,a.colWidths),c._resourceMap=a.resourceMap,delete c.options,e.bindAll(c,"_onDetached","_onAttached","_onLockedChange"),c.on("detached",c._onDetached),c.on("attached",c._onAttached),c.on("locked-change",c._onLockedChange)},setContentData:function(a,b,c){var d=this;a&&a.length&&b&&b.length&&c&&c.length&&(d._tableCells=a,d._rowHeights=b,d._colWidths=c,setTimeout(function(){d._checkAndFixTableData()}))},_checkAndFixTableData:function(){var a,b,c=this,d=c.toJSON();try{a=t(d.data),a.errors.length&&(window.console.warn("Table data fix errors:  \n"+a.errors.join("\n")),f.log(d),b=a.fixedData,c._tableCells=s.cellsFromJSON({cellsJson:b.cells,height:b.heights.length,width:b.widths.length,resourceList:d.resourceList}),c._rowHeights=b.heights,c._colWidths=b.widths,c.trigger("content-change"))}catch(a){f.error("Table data fix failed",a)}},getRowCount:function(){var a=this._rowHeights||[],b=a.length;return Math.max(o.MIN_ROW_COUNT,b)},getColumnCount:function(){var a=this._colWidths||[],b=a.length;return Math.max(o.MIN_COL_COUNT,b)},getRowHeight:function(a){return this._rowHeights[a]||o.DEFAULT_ROW_HEIGHT},setRowHeight:function(a,b){var c=this;c.isLocked()||(c._rowHeights[a]=b,c.trigger("row-height-set",a,b))},getColumnWidth:function(a){return this._colWidths[a]||o.DEFAULT_COL_WIDTH},setColumnWidth:function(a,b){var c=this;c.isLocked()||(c._colWidths[a]=b,c.trigger("col-width-set",a,b))},_getCellAt:function(a,b){var c,d=this,e=d._tableCells;return e[a]&&e[a][b]&&(c=e[a][b]),c||f.warn("Failed to get cell at row/col",a,b),c},_findMergePoint:function(a,b){var c,d=this,e=d._getCellAt(a,b);return e&&e.isMergedCell()&&(c=e.getMergedCellAttr(),a-=c.dy,b-=c.dx,e=d._getCellAt(a,b)),e?{row:a,col:b,cell:e}:void f.warn("Failed to find merge point row/col",a,b)},getCell:function(a,b,c){c=e.defaults(c||{},{findMergePointIfNeeded:!1,withPosition:!1});var d,f,g=this;if(!c.findMergePointIfNeeded){if(!(f=g._getCellAt(a,b)))return;return!0===c.withPosition?{cell:f,row:a,col:b}:f}return d=g._findMergePoint(a,b),c.withPosition?d:d&&d.cell?d.cell:null},_getCellSize:function(a,b,c){if(a&&!a.isMergedCell()){var d,f,g=this,h=function(a,b){return a+b};if(a&&!a.isMergedCell())return a.isMergePoint()?(d=a.getMergePointAttr())&&d.width&&d.height&&(f={widths:[],heights:[],rows:[],cols:[]},v(function(a){var b=c+a,d=g.getColumnWidth(b);f.widths.push(d),f.cols.push(b)},!1,d.width),v(function(a){var c=b+a,d=g.getRowHeight(c);f.heights.push(d),f.rows.push(c)},!1,d.height)):f={widths:[g.getColumnWidth(c)],heights:[g.getRowHeight(b)],rows:[b],cols:[c]},f&&(f.width=e.reduce(f.widths,h,0),f.height=e.reduce(f.heights,h,0)),f}},getCellSize:function(a,b){var c=this,d=c.getCell(a,b,{findMergePointIfNeeded:!0,withPosition:!0});if(d&&d.cell)return c._getCellSize(d.cell,d.row,d.col)},getCellSizeById:function(a){var b=this,c=b.getCellById(a);if(c&&c.cell)return b._getCellSize(c.cell,c.row,c.col)},getCellById:function(a){if(g.isElement(a)&&(a=d(a).data("cellId")),a){var b,c,e,f=this,h=f.getRowCount(),i=f.getColumnCount();for(b=0;b<h;b++)for(c=0;c<i;c++)if((e=f.getCell(b,c))&&e.getCellId()===a)return{cell:e,row:b,col:c}}},getPosition:function(a){if(a){var b,c,d=this,e=d.getRowCount(),f=d.getColumnCount();for(b=0;b<e;b++)for(c=0;c<f;c++)if(d.getCell(b,c)===a)return{row:b,col:c}}},isMergePoint:function(a,b){var c=this.getCell(a,b);return c&&c.isMergePoint&&c.isMergePoint()},isMergedCell:function(a,b){var c=this.getCell(a,b);return c&&c.isMergedCell&&c.isMergedCell()},getMergePointAttrAt:function(a,b){var c=this._getCellAt(a,b),d={};return c?c.getMergePointAttr():d},setMergePointAttrAt:function(a,b,c,d){if(!this.isLocked()){var e=this._getCellAt(a,b);e&&(e.setMergePointAttr(c,d),this.trigger("attribute-changed"))}},getMergedCellAttrAt:function(a,b){var c=this._getCellAt(a,b),d={};return c?c.getMergedCellAttr(a,b):d},setMergedCellAttrAt:function(a,b,c,d){if(!this.isLocked()){var e=this._getCellAt(a,b);e&&(e.setMergedCellAttr(c,d),this.trigger("attribute-changed"))}},clearCellAttr:function(a,b){if(!this.isLocked()){var c=this._getCellAt(a,b);c&&(c.clearMergePointAttr(),c.clearMergedCellAttr(),this.trigger("attribute-changed"))}},getContentAt:function(a,b){var c=this.getCell(a,b);if(c)return{content:c.getContent(),type:c.getType()}},setCellContent:function(a,b,c){var d,g,h=this;if(!h.isLocked())return null==c?void f.warn("content is not valid",c):(d=h.getCell(a,b))?(e.isString(c)&&(c=p.create(c)),c instanceof p&&(c=q.create({richText:c})),g=d.setContent(c),g&&h.trigger("cell-content-change",d.getCellId()),g):void f.warn("no cell at row/col",a,b)},setCellInlineStyles:function(a){if(a&&a.styles&&!this.isLocked()){var b=this,c=a.row,d=a.col,e=a.styles,f=b._getCellAt(c,d);return f&&f.isTextNoEmptyCell()?(f.setInlineStyles(e),b.trigger("cell-inline-style-change",c,d)):f.setStylesForEmpty(e),!0}},getCellInlineStyles:function(a){var b=a.row,c=a.col,d=this._getCellAt(b,c);return d.isTextNoEmptyCell()?d.getInlineStyles(a.names):d.getStylesForEmpty(a.names)},setCellBlockStyles:function(a){if(!this.isLocked()){var b,c=a.row,d=a.col,f=a.styles,g=this._getCellAt(c,d);return!g.isMergedCell()&&(f&&!e.isEmpty(f)||g.clearStyles(),r.bulbStyles2TableStyles(f),g.setBlockStyles(f),b=g.getBlockStyles(),this.trigger("cell-block-style-change",c,d,f,b),!0)}},getCellBlockStyles:function(a){var b,c=a.row,d=a.col,f=a.names,g=this._getCellAt(c,d);return!g.isMergedCell()&&(b=g.getBlockStyles(),f&&f.length>0?e.pick(b,f):b)},insertRows:function(a,b,c){if(!this.isLocked()){var d=this,f=a;c=c||[],e.forEach(b,function(a,b){d._tableCells.splice(f,0,a),d._rowHeights.splice(f,0,c[b]||o.DEFAULT_ROW_HEIGHT),f+=1}),d.trigger("row-inserted",a)}},creatRowData:function(){var a,b=this,c=b.getColumnCount(),d=[];for(a=0;a<c;a++)d.push(b.createCell());return d},insertCols:function(a,b,c){if(!this.isLocked()){var d=this,e=d._tableCells,f=a;c=c||[],b.forEach(function(a,b){e.forEach(function(b,c){b&&b.splice(f,0,a[c])}),d._colWidths.splice(f,0,c[b]||o.DEFAULT_COL_WIDTH),f+=1}),d.trigger("col-inserted",a)}},deleteRows:function(a,b){if(!this.isLocked()){var c,d,e=this,f=[];if(!e.isLocked()){for(b=b||1,d=0;d<b;d++)f[d]=e._tableCells.splice(a,1)[0];return c=e._rowHeights.splice(a,b),e.trigger("row-deleted",a,b),{rowsData:f,heights:c}}}},deleteCols:function(a,b){if(!this.isLocked()){var c,d,e=this,f=[];if(!e.isLocked())return b=b||1,e._tableCells.forEach(function(c){for(d=0;d<b;d++)f[d]=f[d]||[],f[d].push(c.splice(a,1)[0])}),c=e._colWidths.splice(a,b),e.trigger("col-deleted",a,b),{colsData:f,widths:c}}},createCell:function(a){a=a||{};var b,c=a.content||q.createBlank(),d=a.styles;return b=n.create({content:c}),d&&b.setBlockStyles(d),b},getCells:function(){return this._tableCells},isMergeRect:function(a){var b,c=this;return!!c.isMergePoint(a.top,a.left)&&(b=c.getMergePointAttrAt(a.top,a.left),b.width>=a.width&&b.height>=a.height)},toXml:function(a){var b,c,d,f=this,g=w.__super__.toXml.apply(f,arguments),j=a.createElement("resource-list"),k=a.createElement("content"),l={},m=[];return f.forEach(function(b,c){var d=f.getCell(b,c),g=d?d.toXml(a,j,l):{},h=e.keys(g);1===h.length&&"value"===h[0]&&""===g.value&&(g={}),m.push(g)}),g.appendChild(j),c={cells:m,widths:[].concat(f._colWidths),heights:[].concat(f._rowHeights)},d=window.JSON.stringify(c),k.appendChild(a.createTextNode(d)),g.appendChild(k),b=a.createElement("styles"),i.toXml(f,b,a),g.appendChild(b),h.appendToXml(f.unknownTree,g),g},toJSON:function(a){var b=this,c=[].concat(b._colWidths),d=[].concat(b._rowHeights),e=[],f={},g={};return b.forEach(function(c,d){var h,i=b.getCell(c,d);i&&i.isAttachmentCell()&&!a&&(h=i.getContent(),f[h.getResId()]=h.getInfo()),i&&i.isImageCell()&&!a&&(h=i.getContent(),g[h.getResId()]=h.getInfo()),e.push(i?i.toJSON(a):null)}),a?{cells:e,widths:c,heights:d}:{blockType:b._type,blockId:b.getId(),resourceList:{imageMap:g,attachMap:f},data:{cells:e,widths:c,heights:d}}},toHtml:function(a,b,c){var e,f=this,g=c?f.getExtraInfo("pcResMap"):null,h=j.renderTable(f,null,g),i=document.createElement("div"),k=d(i);return k.attr("yne-bulb-block","table").css({overflow:"auto"}).append(h),e=i.outerHTML,e=e.replace(/style="(.*?)"/g,function(a){if(a)return a.replace(/\&quot;/g,"")})},forEach:function(a,b){var c=this;c.forEachRow(function(d){return c.forEachColumn(function(b){return a(d,b)},b)},b)},forEachCell:function(a,b){var c=this,d={};c.forEach(function(b,e){var f,g=c.getCell(b,e,{findMergePointIfNeeded:!0,withPosition:!0});if(g&&(f=g.row+"-"+g.col,!0!==d[f]))return d[f]=!0,a(g.cell,g.row,g.col)},b)},forEachRow:function(a,b){var c,d=this,e=0,f=d.getRowCount();for(c=0;c<f;c++)if(!1===a(b?e+f-c:e+c))return!1},forEachColumn:function(a,b){var c,d=this,e=0,f=d.getColumnCount();for(c=0;c<f;c++)if(!1===a(b?e+f-c:e+c))return!1},toPlain:function(a){var b,c=this,d=[];return a=e.defaults(a||{},{returnString:!0,withLineBreak:!1,filter:function(){return!0}}),c.forEach(function(b,e){var f=d[b],g=c.getCell(b,e),h="";f||(f=d[b]=[]),a.filter(g,b,e)&&(h=g?g.toPlain(a.withLineBreak):""),f.push(h)}),a.returnString?(b=e.map(d,function(a){return a.join(" ")}),b=b.join("\n")):d},countWords:function(){var a=this,b=a.toPlain({returnString:!1,withLineBreak:!1,filter:function(a){return a&&a.getType()===l.TEXT}}),c=0;return e.each(b,function(a){e.each(a,function(a){c+=k(a)})}),c},isEmptyContent:function(){var a=this,b=!0;return a.forEachCell(function(a){if(!a.isEmpty())return b=!1,!1}),b},getCommonInlineStyle:function(a,b){var c;return b&&b.getAsRectRange&&(b=b.getAsRectRange()),b&&b.forEachCell?(b.forEachCell(function(b){var d=b.getCommonInlineStyle(a);if(null==c)c=d;else if(c!==d)return c=u.INTERM,!1},!1),c===u.INTERM?null:c):(f.warn("Unvalid parameter",b),null)},getCommonBlockStyle:function(a,b){var c;return b&&b.getAsRectRange&&(b=b.getAsRectRange()),b&&b.forEachCell?(b.forEachCell(function(b){var d=b.getBlockStylesAsBulb()||{};if(null==c)c=d[a];else if(c!==d[a])return c=u.INTERM,!1},!1),c===u.INTERM?null:c):(f.warn("Unvalid parameter",b),null)},getAllResourceInfo:function(){var a,b,c,d,e,f=this,g=[];return f.forEach(function(h,i){var j=f.getCell(h,i),k=f.getExtraInfo("pcResMap");j&&j.isImageCell()&&(a=j.getContent(),b=a.getSource(),c=a.getSource(k),b&&c&&g.push({source:b,extraSource:c})),j&&j.isAttachmentCell()&&(a=j.getContent(),b=a.getSource(),c=a.getSource(k),d=a.getResource(),e=a.getResource(k),b&&c&&d&&e&&g.push({source:b,extraSource:c,resource:d,extraResource:e}))}),g},_onDetached:function(){},_onAttached:function(){},_onLockedChange:function(){},highlight:function(a,b,c){this.trigger("high-light",a,b,c)}},{_validateDimensionArray:function(a,b){return a?e.map(a,function(a){return a>0?a:b}):[b]},validateRowHeights:function(a){return w._validateDimensionArray(a,o.DEFAULT_ROW_HEIGHT)},validColWidths:function(a){return w._validateDimensionArray(a,o.DEFAULT_COL_WIDTH)},_resourceMapFromXml:function(a){var b={};return a?(d(a).children("resource-mono").each(function(a,c){var g=d(c),h=g.find("res-id").text();if(!h)return void f.error("<resource-mono/> node has no res-id",c);e.some(m,function(a,d){var e,f=g.children(d+":first").get(0);if(f&&a&&a.fromXml&&(e=a.fromXml(h,f,c)),e)return b[h]=e,!0})}),b):b},_tableCellsFromXml:function(a,b,c,d){var e,f,g,h=c.length,i=b.length,j=[];for(e=0;e<i;e++)for(j[e]=[],f=0;f<h;f++)g=e*h+f,j[e][f]=n.fromXml({tableBlockId:d.tableBlockId,resourceMap:d.resourceMap,rowIndex:e,colIndex:f,cellRawData:a[g]});return j},fromXml:function(a){var c,e,g,j,k,l=d(a),m=l.children("content:first").eq(0),n=d.trim(m.text()),o=w._resourceMapFromXml(l.children("resource-list:first").get(0)),p=new w({resourceMap:o});p.parseIdFromXml(a);try{c=window.JSON.parse(n)}catch(a){return void f.error(a,n)}return g=c.cells,j=w.validateRowHeights(c.heights),k=w.validateRowHeights(c.widths),e=w._tableCellsFromXml(g,j,k,{tableBlockId:p.getId(),resourceMap:o}),p.setContentData(e,j,k),l.children().each(function(a,c){switch(c.nodeName){case b.TAG_ID_NAME:case b.LEGACY_TAG_ID_NAME:case"content":case"resource-list":break;case"styles":i.fromXml(p,c);break;default:h.appendToTree(p.unknownTree,c)}}),p},fromJSON:function(a,b){if(!a||!a.blockType||a.blockType!==c.TABLE)return void f.warn("jsonObj is not valid!");var d=a.data,e=new w({rowHeights:d.heights,colWidths:d.widths,tableCells:s.cellsFromJSON({cellsJson:d.cells,height:d.heights.length,width:d.widths.length,isUpdateCellId:b,resourceList:a.resourceList})});return a.blockId&&e.setId(a.blockId),e},createBlankTable:function(a,b,c,d){var e,f,g,h=new w,i=[],j=[],k=[];for(c?h.setId(c):c=h.getId(),d&&(g=d/a),e=0;e<b;e++)for(k.push(o.DEFAULT_ROW_HEIGHT),i[e]=i[e]||[],f=0;f<a;f++)0===e&&j.push(g||o.DEFAULT_COL_WIDTH),i[e].push(n.create({content:q.createBlank(),cellId:n.makeCellId(c,e,f)}));return h.setContentData(i,k,j),h}});return w}(),yne_common_selection_table_RectRange=function(a){var b,c=yne_underscore,d=yne_jtk_core_Class,e=yne_jtk_core_L,f=yne_common_util_rect,g=yne_common_data_Table,h=["left","top","width","height"];return b=d.extend({initialize:function(a){var b=this;delete b.options,a=a||{},b.table=a.table,b._setRect(a),b._checkBoundary(),b._fixMerge()},_setRect:function(a){var b=this;c.each(h,function(c){b[c]=a[c]})},_checkBoundary:function(){var a=this,b=a.table,c=b.getColumnCount(),d=b.getRowCount();a.left<0?a.left=0:a.left>=c&&(a.left=c-1),a.top<0?a.top=0:a.top>=d&&(a.top=d-1),a.width<1&&(a.width=1),a.left+a.width>c&&(a.width=c-a.left),a.height<1&&(a.height=1),a.top+a.height>d&&(a.height=d-a.top)},_fixMerge:function(){this._walkToFixMergeCells({})},_makeMarkKey:function(a,b){return a+","+b},_markAsWalked:function(a,b){var c,d,e,f=this;for(c=0;c<a.width;c++)for(d=0;d<a.height;d++)e=f._makeMarkKey(a.top+d,a.left+c),b[e]=!0},_shouldExtend:function(a,b,c){var d,g,h,i,j=this,k=j.table;return(!c||!c[j._makeMarkKey(a,b)])&&((h=k.getCell(a,b,{findMergePointIfNeeded:!0,withPosition:!0}))&&h.cell?(i=h.cell,
i.isMergePoint()?(g=i.getMergePointAttr(),d={left:h.col,top:h.row,width:g.width,height:g.height}):d={left:b,top:a,width:1,height:1},j._markAsWalked(d,c),!f.contains(j,d)&&f.union(j,d)):(e.warn("no table cell at row/col",a,b),!1))},_walkToFixMergeCells:function(a){var b=this,c=function(c){var d,e,f=c?b.top:b.top+b.height-1;for(e=0;e<b.width;e++)if(d=b._shouldExtend(f,b.left+e,a))return d},d=function(c){var d,e,f=c?b.left:b.left+b.width-1;for(e=1;e<b.height;e++)if(d=b._shouldExtend(b.top+e,f,a))return d},e=c(!0)||c(!1)||d(!0)||d(!1);e&&(b._setRect(e),b._walkToFixMergeCells(a))},forEach:function(a,b){var c=this;c.forEachRow(function(d){return c.forEachColumn(function(b){return a(d,b)},b)},b)},forEachCell:function(a,b){var c=this,d={};c.forEach(function(b,e){var f,g=c.table.getCell(b,e,{findMergePointIfNeeded:!0,withPosition:!0});if(g&&(f=g.row+"-"+g.col,!0!==d[f]))return d[f]=!0,a(g.cell,g.row,g.col)},b)},forEachRow:function(a,b){var c,d=this;for(c=0;c<d.height;c++)if(!1===a(b?d.top+d.height-c:d.top+c))return!1},forEachColumn:function(a,b){var c,d=this;for(c=0;c<d.width;c++)if(!1===a(b?d.left+d.width-c:d.left+c))return!1},getRect:function(){var a=this,b={};return c.each(h,function(c){b[c]=a[c]}),b},overlaps:function(){},equals:function(a){var b=this;return b.table===a.table&&c.every(h,function(c){return b[c]===a[c]})},onlyOneCell:function(){var a=this;return 1===a.width&&1===a.height},isMerge:function(){},clone:function(){var a=this.getRect();return b.create(a)},toJSON:function(){return this.getRect()},toString:function(){var a=this;return"RectRange("+c.map(h,function(b){return b+":"+a[b]}).join(",")+")"},getFirstCell:function(){var a=this;return a.table.getCell(a.top,a.left,{findMergePointIfNeeded:!0,withPosition:!0})},getLastCell:function(){var a=this;return a.table.getCell(a.top+a.height-1,a.left+a.width-1,{findMergePointIfNeeded:!0,withPosition:!0})},getFirstCellRect:function(){return{row:this.top,col:this.left}},_getAsNewTable:function(){var a,b,c,d,e=this,f=e.table,h=[],i=[],j=[],k=e.top;for(k=0;k<e.height;k++)for(d=[],h.push(d),b=e.top+k,i.push(f.getRowHeight(b)),a=0;a<e.width;a++)c=e.left+a,0===k&&j.push(f.getColumnWidth(c)),d.push(f.getCell(b,c));return new g({tableCells:h,rowHeights:i,colWidths:j})},getDataAsHtml:function(){return this._getAsNewTable().toHtml()},getDataAsJSON:function(a){return this._getAsNewTable().toJSON(a)},getDataAsPlain:function(){return this._getAsNewTable().toPlain({returnString:!0})},isOnlyImgCell:function(){var a,b,c=this,d=c.table;return!(!(a=d.getCell(c.top,c.left))||!a.isImageCell())&&(a.isMergePoint()?(b=a.getMergePointAttr(),b.width===c.width&&b.height===c.height):1===c.width&&1===c.height)},isOnlyAttachCell:function(){var a,b,c=this,d=c.table;return!(!(a=d.getCell(c.top,c.left))||!a.isAttachmentCell())&&(a.isMergePoint()?(b=a.getMergePointAttr(),b.width===c.width&&b.height===c.height):1===c.width&&1===c.height)},onlyMergePointAndCell:function(){var a,b,c=this,d=c.table;return a=d.getCell(c.top,c.left),!!a.isMergePoint()&&(b=a.getMergePointAttr(),c.width===b.width&&c.height===b.height)}},{create:function(a){return!a||!a.table||null==a.left||null==a.top||!a.width||!a.height||a.left<0||a.top<0||a.width<1||a.height<1?void e.error("Failed to create RectRange",a):new b(a)}})}(),yne_common_selection_TableRange=function(a){var b=yne_common_selection_BlockRange,c=yne_common_data_blockTypes,d=yne_jtk_core_L,e=yne_underscore,f=yne_common_selection_table_RectRange,g={NORMAL:1,ALL:2,FIRST_CELL:3,LAST_CELL:4,BLANK:5},h=b.extend({_type:c.TABLE,initialize:function(a){var b=this;a=e.defaults(a||{},{type:g.FIRST_CELL,rect:null}),b.block=a.block,b._type=a.type,b._type===g.NORMAL&&(h._isValidRect(a.rect)?b._rect=a.rect:b._type=g.FIRST_CELL),delete b.options},getType:function(){return this._type},getAsRectRange:function(){var a,b=this,c=b._type,e=b.block;switch(c){case g.FIRST_CELL:case g.LAST_CELL:a=f.create({table:e,width:1,height:1,top:c===g.FIRST_CELL?0:e.getRowCount()-1,left:c===g.FIRST_CELL?0:e.getColumnCount()-1});break;case g.ALL:a=f.create({table:e,top:0,left:0,width:e.getColumnCount(),height:e.getRowCount()});break;case g.NORMAL:if(!b._rect)return void d.warn("Bad range, please check code, range:",b);a=f.create({table:e,top:b._rect.top,left:b._rect.left,width:b._rect.width,height:b._rect.height});break;case g.BLANK:return null;default:d.error("Failed to create RectRange",c)}return a},isCollapsed:function(){return this._type===g.BLANK},isFullSelected:function(){return this._type===g.ALL},isOnCellEdit:function(){var a,b=this,c=b.block;return c.trigger("get-block-view",c,function(b){a=b}),a&&a.isOnCellEdit()},isInBlank:function(){return this._type===g.BLANK},clone:function(){var a=this;return h.create({block:a.block,type:a._type,rect:a._rect})},collapse:function(){},getDataAsJSON:function(a){var b=this,c=b.getAsRectRange();return c?c.getDataAsJSON(a):null},getDataAsHtml:function(){var a=this,b=a.getAsRectRange();return b?b.getDataAsHtml():null},getDataAsPlain:function(){var a=this,b=a.getAsRectRange();return b?b.getDataAsPlain():null},canDrawedByNative:function(){return!1},toCollabJSON:function(){var a=this,b=h.__super__.toCollabJSON.apply(a);return b.simpleValue1=a.getAsRectRange()||null,b.simpleValue2=a.getType()||null,b}},{TYPES:g,_isValidRect:function(a){return a&&a.left>=0&&a.top>=0&&a.width>=1&&a.height>=1},create:function(a){return a&&a.block&&a.type?a.type!==g.NORMAL||h._isValidRect(a.rect)?new h(a):void d.error("Failed to create TableRange, rect is NOT valid",a):void d.error("Failed to create TableRange",a)},fromCollabJSON:function(a,e){var f,g=a.rangeType;return g!==c.TABLE?void d.error("wrong block type:",g):(f=b.getBlockById(a.blockId,e),f?h.create({block:f,type:a.simpleValue2,rect:a.simpleValue1}):void 0)}});return h}(),yne_common_selection_HrRange=function(a){var b,c=yne_common_selection_BlockRange,d=yne_common_data_blockTypes;return b=c.extend({_type:d.HR,initialize:function(a){this.block=a.block},clone:function(){return new b({block:this.block})},collapse:function(){},isCollapsed:function(){return!1},getDataAsHtml:function(){return this.block.toHtml()},getDataAsJSON:function(){return this.block.toJSON()},getDataAsPlain:function(){return this.block.toPlain()},canDrawedByNative:function(){return!0}})}(),yne_common_selection_UnknownRange=function(a){var b,c=yne_common_selection_BlockRange,d=yne_common_data_blockTypes;return b=c.extend({_type:d.UNKNOWN,initialize:function(a){this.block=a.block},isCollapsed:function(){return!1},clone:function(){return new b({block:this.block})},collapse:function(){},getDataAsHtml:function(){return this.block.toHtml()},getDataAsJSON:function(){return this.block.toJSON()},getDataAsPlain:function(){return this.block.toPlain()},canDrawedByNative:function(){return!1}})}(),yne_common_selection_blockRangeUtil=function(a){var b=yne_common_selection_ParagraphRange,c=yne_common_selection_ImageRange,d=yne_common_selection_AttachmentRange,e=yne_common_selection_HandWriteRange,f=yne_common_selection_TableRange,g=yne_common_selection_HrRange,h=yne_common_selection_UnknownRange,i=yne_jtk_core_L,j=yne_common_selection_HeaderFooterRange,k=yne_common_data_blockTypes,l=yne_underscore;return{createRangeByBlock:function(a){if(i.log(a),!a||!a.block)return void i.warn("arguments is not valid!");var l,m=a.block,n=m.getType(),o=0,p=0;switch(null!=a.start&&null!=a.end?(o=a.start,p=a.end):(null==a.allContent&&null==a.collapseToStart||!0===a.allContent)&&null!=m.getEndOffset?(o=0,p=m.getEndOffset()):a.collapseToStart||null==m.getEndOffset?(o=0,p=0):(o=m.getEndOffset(),p=o),n){case k.TODO:case k.PARAGRAPH:case k.LIST_ITEM:case k.CATALOGUE:case k.HEADING:l=new b({block:m,start:o,end:p});break;case k.IMAGE:l=new c({block:m});break;case k.ATTACHMENT:l=new d({block:m});break;case k.TABLE:a.allContent&&(a.type=f.TYPES.ALL,delete a.allContent),a.type||a.rect||i.warn("Bad tableRange options will select first table cell",a),l=new f({block:m,type:a.type,rect:a.rect});break;case k.HR:l=new g({block:m});break;case k.UNKNOWN:l=new h({block:m});break;case k.HEADER_FOOTER:l=new j({block:m});break;case k.HANDWRITE:l=new e({block:m});break;default:i.error("block.type ["+n+"] is not valid!")}return l},isBlockRange:function(a){return null!=a&&null!=a.getType&&null!=a.getType()&&l.contains(k.getAllBlockTypes(),a.getType())}}}(),yne_common_selection_NoteRangeWalker=function(a){var b,c=yne_jtk_core_Class,d=yne_jtk_core_L,e=yne_common_selection_blockRangeUtil,f=yne_underscore;return b=c.extend({initialize:function(a){var b,c,d=this;a=f.defaults(a||{},{note:null,noteRange:null,filter:function(){return!0}}),b=d._note=a.note,c=d._noteRange=a.noteRange,d._filter=a.filter,d._startRange=c.getStartBlockRange(),d._endRange=c.getEndBlockRange(),d._startIndex=b.getBlockIndex(d._startRange.block),d._endIndex=b.getBlockIndex(d._endRange.block),d._blockIndex=d._startIndex-1,d._blockRanges=[],d._blockRangeIndex=-1},_hasWalked:function(){var a=this;return a._blockIndex>=a._endIndex},current:function(){var a=this;return a._blockRanges[a._blockRangeIndex]},_getAtIndex:function(a){var b,c,d,f,g=this;if(d=g._blockRanges[a])return d.clone(!0);if(!g._hasWalked()){for(f=g._blockIndex+1;f<=g._endIndex&&(g._blockIndex=f,g._startIndex!==g._endIndex?f===g._startIndex?(b=g._startRange.clone(!0),b.extendToBlockEnd()):f===g._endIndex?(b=g._endRange.clone(!0),b.extendToBlockStart()):(c=g._note.getBlockAt(f),b=e.createRangeByBlock({block:c,allContent:!0})):b=g._startRange.clone(!0),!(!0===g._filter(b)&&(g._blockRanges.push(b),d=g._blockRanges[a])));f++);return d}},next:function(){var a=this;return a._blockRangeIndex++,a._getAtIndex(a._blockRangeIndex)},previous:function(){var a=this;return a._blockRangeIndex--,a._getAtIndex(a._blockRangeIndex)},first:function(){var a=this;return a._blockRangeIndex=0,a._getAtIndex(a._blockRangeIndex)},last:function(){var a=this;if(a._getAtIndex(a._endIndex),a._blockRangeIndex=a._blockRanges.length-1,-1!==a._blockRangeIndex)return a._blockRanges[a._blockRangeIndex]},reset:function(){this._blockRangeIndex=-1}},{create:function(a,c,e){return c&&a?new b({note:c,noteRange:a,filter:e}):void d.error("Failed to create NoteRangeWalker, unvalid parameters",a,c,e)}})}(),yne_common_selection_NoteRange=function(a){var b,c=yne_jtk_core_Class,d=yne_jtk_core_L,e=yne_underscore,f=yne_common_data_blockTypes,g=yne_common_constants,h=yne_common_data_ListItem,i=yne_common_data_Paragraph,j=yne_common_selection_ParagraphRange,k=yne_common_selection_HeaderFooterRange,l=yne_common_selection_NoteRangeWalker,m=yne_common_util_platform,n={JSON:1,HTML:2,PLAIN:3,isValidType:function(a){var b=this;return a===b.JSON||a===b.HTML||a===b.PLAIN},_getMethodName:function(a){var b=this,c="";switch(a){case b.JSON:c="JSON";break;case b.HTML:c="Html";break;case b.PLAIN:c="Plain"}return c},getBlockMethodName:function(a){var b=this,c=b._getMethodName(a);if(c)return"to"+c},getBlockRangeMethodName:function(a){var b=this,c=b._getMethodName(a);if(c)return"getDataAs"+c}};return b=c.extend({_type:"note",_startRange:null,_endRange:null,initialize:function(a){var b=this;a=a||{},delete b.options,a.startRange||a.endRange||!a.blockRanges?b.setBlockRanges([a.startRange,a.endRange]):b.setBlockRanges(a.blockRanges)},_checkValid:function(){var a=this,b=a._startRange,c=a._endRange;if(!b||!c)throw"starRange or endRange is not valid!";if(!b.block||!c.block)throw"starRange.block or endRange.block is not valid!";if(b.block===c.block&&b!==c)throw"startRange and endRange should be the same object when startRange.block === endRange.block"},isInSingleBlock:function(){var a=this;return a._startRange===a._endRange},isInMultiBlock:function(){return!this.isInSingleBlock()},createWalker:function(a,b){return new l.create(this,a,b)},isMatchBlockTypes:function(a,b){if(!a)return d.warn("The param note does not exist!"),!1;var c,e,g,h=this,i=h._startRange.block,j=h._endRange.block,k=a.getBlockIndex(i),l=a.getBlockIndex(j);if(-1===k||-1===l)return d.warn("startIndex or endIndex is -1!"),!1;for(c=a.getAllBlocks(),e=k;e<=l;e++)if(g=f.getType(c[e]),-1===b.indexOf(g))return!1;return!0},canDrawedByNative:function(){var a,b=this;return!b.isInSingleBlock()||(a=b.getStartBlockRange(),a.canDrawedByNative())},isCollapsed:function(){var a=this;return!(!a._startRange||!a.isInSingleBlock())&&a._startRange.isCollapsed()},getStartBlockRange:function(){return this._startRange},getEndBlockRange:function(){return this._endRange},setBlockRanges:function(a){var b=this;b._startRange=e.first(a),b._endRange=e.last(a),b._checkValid()},clone:function(a){var c,d,e=this;return!1===a?(c=e._startRange,d=e._endRange):(c=e._startRange.clone(),d=e.isInSingleBlock()?c:e._endRange.clone()),b.create({startRange:c,endRange:d})},collapse:function(a){var b=this,c=!1===a?b.getEndBlockRange():b.getStartBlockRange();c&&c.collapse?(c.collapse(a),b._startRange=c,b._endRange=c):d.warn("There is no blockRange or blockRange has no `collapse` method")},toNativeRange:function(a){var b,c,e,f,g,h=this;if(h.canDrawedByNative())return d.log("to native range",h),b=h.getStartBlockRange(),(e=b.toNativeRange(a))?h.isInSingleBlock()?e:(c=h.getEndBlockRange(),(f=c.toNativeRange(a))?(g=document.createRange(),g.setStart(e.startContainer,e.startOffset),g.setEnd(f.endContainer,f.endOffset),g):void d.warn("no native range for end block!")):void d.warn("no native range for start block!")},getDataWithType:function(a,b,c){return this._getDataWithType(a,b,c)},_getDataWithType:function(a,b,c){if(!a||!a.getBlockAt)return void d.warn("note is unvalid!");if(!n.isValidType(b))return void d.warn("type is unvalid!");c=c||function(){return!0};var e,g,i,j,k=this,l=[],o=k._startRange,p=n.getBlockRangeMethodName(b);if(n.PLAIN===b&&k._isSingleNotFullSelectedLI())return e=h.__super__.toPlain.apply(o.block,[o.start,o.end]),l.push(e),l;if(!(j=k.createWalker(a,function(a){return c(a.block)})))return[];for(i=j.next();i;)e=i[p](),null!=e?Array.isArray(e)?l=l.concat(e):(g=i.block,(m.IS_WEB_NOTE||m.IS_WEB_GROUP)&&f.isAttachment(g)&&e.resource&&!/^http/i.test(e.resource)&&(e.resource=location.protocol+"//"+location.hostname+e.resource),l.push(e)):d.warn("data is null!"),i=j.next();return l},getDataAsJSON:function(a,b){var c=this,d=c._getDataWithType(a,n.JSON,b);return d=d||[],window.JSON.stringify(d)},getDataAsHtml:function(a){var b=this,c=b._startRange;return b._isSingleNotFullSelectedLI()?h.__super__.toHtml.apply(c.block,[c.start,c.end]):a.toHtml(b)},getDataAsPlain:function(a,b){var c=this,d=c._getDataWithType(a,n.PLAIN,b),e="";return d&&d.length&&(e=d.join(g.LINE_BREAK)),e},_isSingleNotFullSelectedLI:function(){var a=this,b=a._startRange,c=!1;return a.isInSingleBlock()&&f.isListItem(b.block)&&(0!==b.start||b.end!==b.block.getLength())&&(c=!0),c},isSingleTableSelected:function(){var a=this,b=a._startRange;return!(!a.isInSingleBlock()||!f.isTable(b.block))},toCollabJSON:function(a){var b=this,c={};return c.startBlockRange=b._startRange.toCollabJSON(a),b.isInSingleBlock()?c.isInSingleBlock=!0:(c.isInSingleBlock=!1,c.endBlockRange=b._endRange.toCollabJSON(a)),c}},{create:function(a){return a&&a.startRange&&a.endRange?new b(a):void d.warn("options is unvalid!")},createMock:function(){var a={},c=new i,d=new j({start:0,end:0,block:c});return a.startRange=d,a.endRange=a.startRange,new b(a)},fromNativeRange:function(a,c){if(!a)return void d.warn("no range");if(a instanceof b)return a;d.log("NoteRange.fromNativeRange()",a);var f,g=c.parseNativeRange(a);return g&&g.length?(f=new b({startRange:e.first(g),endRange:e.last(g)}),d.log("noteRange fromNativeRange",f),f):void d.warn("Failed to parse native range to note range!")},fromCollabJSON:function(a,c){var d=null;if(a){var e=a.startBlockRange,f=a.endBlockRange,g={};g.startRange=c.buildBlockRangeFromJSON(e),a.isInSingleBlock?g.endRange=g.startRange:g.endRange=c.buildBlockRangeFromJSON(f),g.startRange&&g.endRange&&(d=b.create(g))}return d},isNoteRange:function(a){var c=!1;return a&&a._type===b.prototype._type&&a.getStartBlockRange()&&a.getEndBlockRange()&&(c=!0),c},createForHeaderFooter:function(a){return new b({blockRanges:[new k({block:a})]})},DATA_TYPES:n})}(),yne_common_selection_nativeSelection=function(a){var b=yne_jtk_core_L,c=yne_jtk_web_dom_nodeType;return{getSelection:function(a){return a=a||window,a.getSelection()},setRange:function(a,c){var d=this,e=d.getSelection(c);b.log("setRange",a,c),e&&a?(e.removeAllRanges(),e.addRange(a)):b.warn("The selection or range is null!")},getRange:function(a){var c,d=this,e=d.getSelection(a);return e?e.rangeCount>0?c=e.getRangeAt(0):b.warn("The selection has no range!"):b.warn("The selection is null!"),c},removeAllRanges:function(a){var b=this,c=b.getSelection(a);c&&c.removeAllRanges()},isRangeInNode:function(a,c){if(!a)return b.warn("The param node is unvalid!"),!1;var d,e=this,f=a.ownerDocument||document,g=f.defaultView;if(!(c=c||e.getRange(g)))return b.warn("The native range is null!"),!1;for(d=c.commonAncestorContainer;d;){if(d===a)return!0;d=d.parentNode}return!1},isRangeInSelector:function(a,b){if(!a)return!1;var d,e=this;if(b=b||e.getRange(),d=b.commonAncestorContainer,!b||!d)return!1;for(c.isText(d)&&(d=d.parentElement||d.parentNode);d&&d.webkitMatchesSelector;){if(d.webkitMatchesSelector(a))return!0;d=d.parentNode}return!1},isNodeInRange:function(a,c){if(!a)return b.warn("The param node is unvalid!"),!1;var d,e=this,f=a.ownerDocument||document,g=f.defaultView,h=g.Range;return c=c||e.getRange(g),d=f.createRange(),d.selectNode(a),c.compareBoundaryPoints(h.START_TO_START,d)<1&&c.compareBoundaryPoints(h.END_TO_END,d)>-1}}}(),yne_common_selection_CatalogueRange=function(a){var b=yne_common_selection_ParagraphRange;return b.extend({_type:"heading",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)}},{})}(),yne_common_selection_HeadingRange=function(a){var b=yne_common_selection_ParagraphRange;return b.extend({_type:"heading",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)}},{})}(),yne_common_selection_ListItemRange=function(a){var b=yne_common_selection_ParagraphRange;return b.extend({_type:"list-item",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)}},{})}(),yne_common_selection_TodoRange=function(a){var b=yne_common_selection_ParagraphRange,c=yne_common_data_blockTypes;return b.extend({_type:c.TODO,initialize:function(a){b.prototype.initialize.apply(this,[a])}},{})}(),yne_common_selection_BlockRangeMap=function(a){var b,c=yne_common_selection_AttachmentRange,d=yne_common_selection_CatalogueRange,e=yne_common_selection_HeadingRange,f=yne_common_selection_HrRange,g=yne_common_selection_ImageRange,h=yne_common_selection_ListItemRange,i=yne_common_selection_ParagraphRange,j=yne_common_selection_TableRange,k=yne_common_selection_UnknownRange,l=yne_common_selection_TodoRange,m=yne_common_selection_HandWriteRange,n=yne_common_data_blockTypes,o=yne_common_selection_HeaderFooterRange;return b={},b[n.ATTACHMENT]=c,b[n.CATALOGUE]=d,b[n.HEADING]=e,b[n.HR]=f,b[n.IMAGE]=g,b[n.LIST_ITEM]=h,b[n.PARAGRAPH]=i,b[n.TABLE]=j,b[n.TODO]=l,b[n.HANDWRITE]=m,b[n.HEADER_FOOTER]=o,b[n.UNKNOWN]=k,b}(),yne_common_jst=function(a){var b=yne_jtk_core_L,c=this&&this.JST?this:window;return{getTemplate:function(a,d){var e=a+"/"+d,f=c.JST[e];if(!f){if(b.DEBUG)throw"JST has no template: "+e;b.error("JST has no template: "+e)}return f},render:function(a,c,d){var e=this.getTemplate(a,c);if(e)return e(d);b.error("no tempalte: "+a+"/"+c+".jst","template/jst.js")}}}(),yne_common_views_PageBreakView=function(a){var b=yne_backbone,c=yne_common_constants,d=yne_common_jst,e=yne_jtk_core_L,f=yne_jquery;return b.View.extend({className:"page-break-view",templateName:"page_break_view",PLACEHOLDER_PREFIX:"p_",_$placeholder:null,_$pageBreak:null,_$container:null,_isAtViewBeginning:null,_topBlankHeight:null,_bottomBlankHeight:null,coincide:function(){var a,b,c=this;a=c._getOffsetTopPos(c.getPlaceholder()),b=a+c.getTopBlankHeight(),e.log("placeHolderTop/pageBreakTop/topBlankHeight:",a,b,c.getTopBlankHeight()),c.getPageBreak().offset({top:b})},destroy:function(){var a=this;a._$pageBreak.remove(),a._$placeholder.remove()},getPlaceholder:function(){return this._$placeholder},getPageBreak:function(){return this._$pageBreak},getTopBlankHeight:function(){return this._topBlankHeight},initialize:function(a){var b,g,h,i,j=this,k=a.pageIndex;j._topBlankHeight=a.topBlankHeight||0,j._bottomBlankHeight=a.bottomBlankHeight||0,j._$placeholder=a.placeholder||f('<div class="page-break-placeholder"></div>'),j._$pageBreak=f(d.render("common",j.templateName,{})),j._$container=a.container,j._$pageBreak.prepend(a.noteView.createHeaderFooterView(!0).$el),j._$pageBreak.append(a.noteView.createHeaderFooterView(!1).$el),i=j._$container.find('[data-page-id="'+k+'"]'),0!==i.length&&i.attr("data-page-cid")===j.cid&&(e.debugAlert("should not create existing pageBreak for same view"),i.remove()),j._topBlankHeight<0&&(e.debugAlert("topBlankHeight should not be less than 0"),j._topBlankHeight=0),j._bottomBlankHeight<0&&(e.debugAlert("bottomBlankHeight should not be less than 0"),j._bottomBlankHeight=0),j._$pageBreak.attr("data-page-id",k),j._$pageBreak.attr("data-page-cid",j.cid),j._$pageBreak.attr("contenteditable","false"),b=j._$pageBreak.find(".bottomSpan"),g=j._$pageBreak.find(".topSpan"),h=j._$pageBreak.find(".middleSpan"),g.outerHeight(c.PAGE_SPLIT_BLANK_HEIGHT),b.outerHeight(c.PAGE_SPLIT_BLANK_HEIGHT),h.outerHeight(c.PAGE_SPLIT_MIDDLE_HEIGHT),j._$pageBreak.appendTo(j._$container),j._$pageBreak.height(g.outerHeight()+h.outerHeight()+b.outerHeight()),j._$placeholder.attr("data-page-id",j.PLACEHOLDER_PREFIX+j._$pageBreak.attr("data-page-id")),j._$placeholder.attr("data-page-cid",j.PLACEHOLDER_PREFIX+j._$pageBreak.attr("data-page-cid")),j._$placeholder.attr("contenteditable","false"),j._$placeholder.height(j._$pageBreak.height()+j._topBlankHeight+j._bottomBlankHeight)},isAtViewBeginning:function(){return!0===this._isAtViewBeginning},setAtViewBeginning:function(a){this._isAtViewBeginning=!0===a},_getOffsetTopPos:function(a){return a.offset().top}})}(),yne_common_views_BlockView=function(a){var b=yne_backbone,c=yne_jquery,d=yne_underscore,e=yne_common_constants,f=yne_common_data_blockTypes,g=yne_jtk_core_L,h=yne_common_views_PageBreakView,i=c('<div class="collab-editing-view-wrapper"><div class="collab-session-view"></div></div>');return b.View.extend({className:"block-view unknown-block-view",_isReadOnly:!1,_pageInfo:null,_$pageBreakContainer:null,PAGE_HEIGHT:null,_viewHeightInlastPaging:null,block:null,_getSelector:function(){var a=this,b=a.tagName,c=a.className.split(/\s+/),e=a.id,f=a.cid,g=".note-view ";return g+=b,e&&(g+="#"+e),d.each(c,function(a){a&&(g+="."+a)}),g+='[data-yne-cid="'+f+'"]'},initialize:function(a){var b=this;b.block=a.block,b._isReadOnly=a.isReadOnly,d.bindAll(b,"_onLockedChange"),b.block.on("locked-change",b._onLockedChange),a.inlineStyleViewMapper&&(b._inlineStyleViewMapper=a.inlineStyleViewMapper),b._pageInfo={},b.PAGE_HEIGHT=a.pageSize.height,d.isNumber(b.PAGE_HEIGHT)||(g.debugAlert("invalid PAGE_HEIGHT:"+b.PAGE_HEIGHT),b.PAGE_HEIGHT=e.PAGE_TYPE_NONE_HEIGHT),b._$pageBreakContainer=a.pageBreakContainer,b.noteView=a.noteView},render:function(){var a=this;a.$el.attr("data-yne-cid",a.cid),a._updateLockState(a.isLocked()),f.isListItem(a.block)||a.trigger("view-height-changed",a.cid)},convertToNativeRange:function(){g.error("convertToNativeRange() should be implemented by subclass!")},parseNativeRange:function(){g.error("parseNativeRange() should be implemented by subclass!")},bindSelectionEvents:function(){var a=this;d.bindAll(a,"onDrawRange"),a.on("draw-range",a.onDrawRange)},onDrawRange:function(){throw"Method not implemented."},_onLockedChange:function(a){var b=this;b._updateLockState(b.isLocked()),b._updateLockIndicator(b.block.isLocked(),a),b.trigger("locked-change"),b.trigger("view-height-changed",b.cid)},isCollabLocked:function(){var a=this,b=a.block,c=!1;return b&&(c=b.isLocked()),c},isLocked:function(){var a=this,b=a.block,c=a._isReadOnly;return b&&(c=b.isLocked()||a._isReadOnly),c},_updateLockIndicator:function(a,b){var c,d,e=this,f=b&&b.lockColor,g=b&&b.nickname;c=e.$el.find(".collab-editing-view-wrapper"),null!=c&&0!==c.length||(c=i.clone(),e.$el.prepend(c)),d=c.find(".collab-session-view"),a?(e.$el.addClass("collab-editing-view"),null!=g&&d.text(g),null!=f&&d.css("background-color",f)):(e.$el.removeClass("collab-editing-view"),e.$el.find(".collab-editing-view-wrapper").remove())},_updateLockState:function(a){var b=this;a?b.$el.addClass("collab-locked"):b.$el.removeClass("collab-locked")},onDestroy:function(){g.log("onDestroy() should be implemented by subclass!")},clearPageBreaks:function(){var a=this;d.each(a._pageInfo,function(b){b&&b.pageBreak&&a._removePageBreak(b.pageBreak)}),a._pageInfo={}},coincideAllPageBreaks:function(){var a=this;if(!a._pageInfo)return void g.debugAlert("pageInfo should not be null when coincideAllPageBreaks");d.each(a._pageInfo,function(b){b&&b.pageBreak&&a._coincidePageBreak(b.pageBreak)})},disablePageMode:function(){var a=this;a.clearPageBreaks(),a.PAGE_HEIGHT=e.PAGE_HEIGHT_NONE},enablePageMode:function(a){var b=this;b.clearPageBreaks(),a===e.PAGE_TYPE_A4?b.PAGE_HEIGHT=e.PAGE_HEIGHT_A4:a===e.PAGE_TYPE_B5?b.PAGE_HEIGHT=e.PAGE_HEIGHT_B5:a===e.PAGE_TYPE_TEST?b.PAGE_HEIGHT=e.PAGE_HEIGHT_TEST:b.PAGE_HEIGHT=e.PAGE_HEIGHT_NONE},getBottomPosInPage:function(a){var b,c=this;return c._pageInfo[a]?c._pageInfo[a].pageBreak?b=-1:(b=c._pageInfo[a].topPosInPage+c._getHeightInPage(a))>c.PAGE_HEIGHT&&g.warn("Unsplitted Block whose Height is more than PAGE_HEIGHT",c._pageInfo[a].topPosInPage,b,c.PAGE_HEIGHT):(g.debugAlert("should NOT invoke the getBottomPosInPage when the view is NOT on the page"),b=0),b},getFirstTransPageIndex:function(){var a=this,b={};return a._pageInfo?(d.each(a._pageInfo,function(a){a&&(null==b.pageIndex?b=a:a.pageIndex<b.pageIndex&&(b=a))}),b.pageIndex):(g.debugAlert("pageInfo should not be null when getFirstTransPageIndex"),null)},getLastTransPageIndex:function(){var a=this,b={};return a._pageInfo?(d.each(a._pageInfo,function(a){a&&(null==b.pageIndex?b=a:a.pageIndex>b.pageIndex&&(b=a))}),b.pageIndex):(g.debugAlert("pageInfo should not be null when getLastTransPageIndex"),null)},isOnFloat:function(){var a,b=this;return a=b.$el.css("float")||"none","none"!==a.toLowerCase()},resetPageInfo:function(a,b){var c,e,f=this,h=!1;return f._pageInfo?d.isNumber(b)?null==a?(g.debugAlert("pageIndex should NOT be null"),h):null==f._$pageBreakContainer?(g.debugAlert("pageBreakContainer should not be null"),h):(f._pageInfo[a]&&(c=f._pageInfo[a].topPosInPage),b=Math.ceil(b),f.clearPageBreaks(),f._updatePageInfo(a,b),f.$el.css("height","auto"),e=f.$el.outerHeight(!0),b!==c?h=!0:f._isViewHeightChanged(e)?h=!0:f._isPagingContinue()&&(h=!0),h?f._viewHeightInlastPaging=e:g.log("No Page Pos Changed",f),g.log("resetPageInfo(cid/pageInfo/topPos/height):"+f.cid+"/"+a+"/"+b+"/"+f._viewHeightInlastPaging),h):(g.debugAlert("topPosInPage should be a number:"+b),h):(g.debugAlert("pageInfo should not be null when resetPageInfo"),h)},_coincidePageBreak:function(a){var b=this;a.coincide(),b.trigger("pageBreak-positionChanged",a.getPageBreak().attr("data-page-id")),b._showPageBreakInfo(a)},_createPageBreak:function(a,b,c,d){var e=this;return new h({pageIndex:a,topBlankHeight:b,bottomBlankHeight:c,container:e._$pageBreakContainer,noteView:e.noteView,placeholder:d})},_getContentContainer:function(){return this.$el},_getContentContainerBottomInView:function(){var a=this;return a._getOffsetTopPos(a._getContentContainer())+a._getContentContainer().outerHeight()-a._getOffsetTopPos(a.$el)},_getOffsetTopPos:function(a){return a.offset().top},_getHeightInPage:function(a){var b,c,d=this,e=d._pageInfo[a-1],h=d._pageInfo[a];return h?e&&!e.pageBreak?(g.debugAlert("previous pageBreak should NOT be null"),0):e&&0===e.pageBreak.getPlaceholder().next().length?0:f.isTable(d.block)&&0===d._getContentContainer().find("tbody").children().length?0:"none"!==d.$el.css("float")?0:e&&e.pageBreak&&h&&h.pageBreak?(g.debugAlert("_getHeightInPage: should NOT there when crossing previous/current page"),d.PAGE_HEIGHT):(b=e?d._getPageBreakBottomPosInView(a-1):0,h&&h.pageBreak?(g.debugAlert("_getHeightInPage: shoud not be there when current pageBreak ready"),c=d._getPageBreakTopPosInView(a)):c=d._getContentContainerBottomInView(),Math.ceil(c-b)):(g.debugAlert("should NOT invoke the method when not on the page"),0)},_getPageBreakBottomPosInView:function(a){var b,c,d=this;return b=d._pageInfo[a],b&&b.pageBreak?(c=b.pageBreak.getPlaceholder(),d._getOffsetTopPos(c)+c.height()-d._getOffsetTopPos(d.$el)):0},_getPageBreakTopPosInView:function(a){var b,c,d=this;return b=d._pageInfo[a],c=b.pageBreak.getPlaceholder(),d._getOffsetTopPos(c)-d._getOffsetTopPos(d.$el)},_getTopPosInPage:function(a){var b=this,c=0;return b._pageInfo[a-1]&&b._pageInfo[a-1].pageBreak?c=0:b._pageInfo[a]?c=b._pageInfo[a].topPosInPage:g.debugAlert("should NOT invoke the _getTopPosInPage when the view is NOT on the page"),c},_handlePageOverflow:function(a,b){var c,d,e=this,f=e._getHeightInPage(a),h=e._pageInfo[a-1];return d=e.PAGE_HEIGHT-b,h&&h.pageBreak&&0!==b?(g.debugAlert("toPosInPage should be 0 when crossing the previous page"),!1):(d<0&&(d=0),0===b||e.isOnFloat()||d>f?(e._setViewMaxHeight(a),c=!1):(e._insertPageBreak(a,d),c=!0),c)},_insertPageBreak:function(a,b){var c,d=this;c=d._createPageBreak(a,b),c.getPlaceholder().prependTo(d.$el),d._pageInfo[a].pageBreak=c,d.trigger("pageBreak-inserted",c.getPageBreak().attr("data-page-id")),d._coincidePageBreak(c)},_isInPageMode:function(){return this.PAGE_HEIGHT!==e.PAGE_HEIGHT_NONE},_isPagingContinue:function(){return!1},_isViewHeightChanged:function(a){var b=this,c=!1;return(!b._viewHeightInlastPaging||Math.round(Math.abs(a-b._viewHeightInlastPaging))>e.TOLERABLE_HEIGHT_CHANGE)&&(c=!0),c},_removePageBreak:function(a){a.destroy()},_setViewMaxHeight:function(){},_showPageBreakInfo:function(a){var b,c,d,e,f,h,i=this,j=a.getPageBreak();g.DEBUG&&(b=j.find(".bottomSpan"),b.css("border-bottom","2px dashed #b6b9b6"),c=j.find(".topSpan"),c.css("border-top","2px dashed #b6b9b6"),f=j.attr("data-page-id"),d=i._getOffsetTopPos(j),e=i._getOffsetTopPos(a.getPlaceholder()),h="Page:"+f+" OffsetTop(mark/placeholder):("+Math.round(d)+"/"+Math.round(e)+") TopBlank:"+c.outerHeight(),c.text(h),f*=1,h="TopOnPage:"+i._pageInfo[f].pageIndex+" BottomBlank:"+b.outerHeight(),b.text(h))},_updatePageInfo:function(a,b){var c=this;c._pageInfo[a]={pageIndex:a,topPosInPage:b},c._handlePageOverflow(a,b)&&c._updatePageInfo(a+1,0)}})}(),yne_tooltipster=function(){var a,b=window.$;if(!b&&window.require&&(b=window.require("jquery")),!b)throw"no `jquery` library";if(a=b.tooltipster,!a&&window.require&&(a=window.require("tooltipster")),!a)throw"no `tooltipster` library";return a}(),yne_common_util_userAgent=function(){var a=navigator.userAgent.toLowerCase();return{isSafari:function(){return a&&a.indexOf("applewebkit")>-1&&a.indexOf("chrome")<=-1},isEdge:function(){return a&&a.indexOf("applewebkit")>-1&&a.indexOf("edge")>-1}}}(),yne_common_util_attachmentParse=function(a){var b=yne_underscore;return{getFileType:function(a){if(b.isUndefined(a))return null;var c=a.toLowerCase().split(".");return{table:"table",pdf:"pdf",txt:"txt",text:"txt",mht:"html",doc:"word",docx:"word",excel:"excel",xls:"excel",xlsx:"excel",csv:"excel",ppt:"ppt",pps:"ppt",pptx:"ppt",ppsx:"ppt",flash:"flash",swf:"flash",flv:"flash",compress:"compress",zip:"compress",rar:"compress","7z":"compress",audio:"audio",mp3:"music",aac:"music",ogg:"music",wav:"music",flac:"music",m4a:"music",ape:"music",wma:"music",video:"video",rm:"video",rmvb:"video",avi:"video",mkv:"video",mpg:"video",mpeg:"video",wmv:"video",ts:"video",m4v:"video",mp4:"video",image:"image",jpg:"image",jpeg:"image",gif:"image",png:"image",bmp:"image",md:"md",scan:"scan",html:"html",htm:"html"}[c[c.length-1]]||"other"},getSizeString:function(a){var b=["B","KB","MB","GB","TB"],c=0,d=parseInt(a);if(d=d||0,isNaN(d))return"未知大小";if(d<=0)return""
;for(;d>=1024&&c<3;)c++,d/=1024;return String(Math.floor(100*d)/100)+b[c]},splitFileFullName:function(a){if(b.isUndefined(a))return null;var c,d,e=a.lastIndexOf(".");return e<0?(c=a,d=""):0===e?(c="",d=a):(c=a.substring(0,e-1),d=a.substring(e-1)),{fileName:c,fileType:d}},getFileIconByName:function(a){var b="src--svg--type_other_large",c=this.getFileType(a);return c&&(b="src--svg--type_"+c+"_large"),b}}}(),yne_common_views_AttachmentView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_common_jst,f=yne_common_selection_AttachmentRange,g=yne_jtk_core_L,h=yne_common_selection_nativeSelection,i=yne_common_util_userAgent,j=yne_common_util_platform,k=yne_common_util_formatLocalSource,l=yne_common_constants,m=yne_common_util_attachmentParse;return b.extend({className:"block-view attachment-view",DEFAULT_HEIGHT:100,timer:null,events:{"dblclick .attachment-container":"_onImgDblclick","mousemove .attachment-container":"_onMouseMove","mouseout .attachment-container":"_onMouseOut","click .attachment-download":"_onDownloadClick","dragstart .attachment-mask":"_onDragstart","dragend .attachment-mask":"_onDragEnd"},_isFloatSwitch:!1,_viewFrameHeight:null,initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),d.bindAll(a,"_onStyleChange","_onContentChange","_onMouseMove","_onMouseOut"),a.block.on("style-change",a._onStyleChange),a.block.on("content-change",d.debounce(a._onContentChange,100)),a.bindSelectionEvents()},render:function(){var a,d,f,h,n,o=this,p=o.block,q=p.getSource(!0),r=p.getFileName(),s=p.getFileLength(),t="attachment-view-attachment-container";j.IS_PC&&(q=k(q)),(j.IS_WEB_NOTE||j.IS_WEB_GROUP)&&!0===p.getFakeLoading()&&(q=l.LOADING_IMAGE_PATH,p.setFakeLoading(!1)),a=m.getFileType(r),d=a?"src--svg--type_"+a+"_large":"src--svg--type_other_large",h=void 0===s?"未知大小":m.getSizeString(s),n=m.splitFileFullName(r),f=e.render("common",t,{name:d,fileName:n.fileName,fileType:n.fileType,size:h,title:r,draggable:!0}),o.$el.find(".attachment-container").remove(),o.$el.append(f),o._viewFrameHeight=o.$el.outerHeight(!0)-o.$el.height(),o.$el.find(".attachment-container").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-attachment","tooltipster-attachment-customized"],side:"bottom",delay:[800,300],arrow:!1,functionPosition:function(a,b,d){var e,f,g=c(b.tooltipClone);return e=o.mousePosY+g.height()>document.body.clientHeight?o.mousePosY-g.height()+10:o.mousePosY-10,f=o.mousePosX+g.width()>document.body.clientWidth?o.mousePosX-g.width()-10:o.mousePosX+10,d.coord.top=e>0?e:0,d.coord.left=f>0?f:0,d}}),o._renderStyles(),i.isSafari()&&o.$el.find(".attachment-container").attr("contenteditable","true"),b.prototype.render.apply(o,arguments),g.log("Attachment width/height",o.$el.width(),o.$el.height())},_renderStyles:function(){var a=this,b=a.block.getBlockStyles();d.each(b,function(b,c){a._setStyle(c,b)})},_setStyle:function(a,b){var c=this,d=c.$el;switch(a){case"align":d.css("text-align",b);break;case"float":d.css("float")!==b?(c._isFloatSwitch=!0,d.css("float",b)):c._isFloatSwitch=!1}},_onStyleChange:function(a,b){var c=this;c._setStyle(a,b),c.trigger("view-height-changed",c.cid)},_onContentChange:function(){var a=this;a.render(),g.log("redraw attachment"),a.trigger("view-height-changed",a.cid)},getImgElement:function(){return this.$el.find("img").get(0)},getAttachmentContainerElm:function(){return this.$el.find(".attachment-container").get(0)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d=this;if(c||h.isNodeInRange(d.getAttachmentContainerElm(),a)||h.isRangeInNode(d.el,a)||d._isSelected())return new f({block:b})},_removeFocusedClass:function(){this.$el.removeClass("focused")},_addFocusedClass:function(){this.$el.addClass("focused")},onDrawRange:function(a){var b,c=this;a?(c._addFocusedClass(),b=document.createRange(),b.selectNodeContents(c.el.firstChild),h.setRange(b,window)):(c._removeFocusedClass(),c.selectAttachment())},_onImgDblclick:function(){var a=this,b=a.block.getResource(),c=a.block.getFileName();j.IS_PC&&a.trigger("yne-open-attachment",b,c)},_onDownloadClick:function(){var a=this,b=a.block,c=b.getResource(),d=b.getFileName();(j.IS_WEB_GROUP||j.IS_WEB_NOTE||j.IS_MAC||j.IS_PC)&&a.trigger("yne-download-attachment",c,d)},_onDragstart:function(){this.$el.find(".attachment-mask").css("opacity",1)},_onDragEnd:function(){this.$el.find(".attachment-mask").css("opacity",0)},_isSelected:function(){return this.$el.find(".attachment-container").hasClass("selected")},selectAttachment:function(a){a?this.$el.find(".attachment-container").addClass("selected"):this.$el.find(".attachment-container").removeClass("selected")},disablePageMode:function(){var a=this;b.prototype.disablePageMode.apply(a),a.$el.css("max-height","none")},_isPagingContinue:function(){return this._isFloatSwitch},_setViewMaxHeight:function(a){var b,c=this,d=c._pageInfo[a-1],e=0,f=c._getTopPosInPage(a);d&&(e=c._getPageBreakBottomPosInView(a-1)),b=c.PAGE_HEIGHT+e-c._viewFrameHeight-f,b<l.PAGE_SPLIT_BLANK_HEIGHT/2&&(b=l.PAGE_SPLIT_BLANK_HEIGHT/2),c.$el.css("max-height",b),g.log("Attachment max-height",c.$el.css("max-height"))},_onMouseMove:function(a){var b=this;clearTimeout(b.timer),b.timer=setTimeout(function(){b.mousePosX=a.originalEvent.x||a.originalEvent.layerX||0,b.mousePosY=a.originalEvent.y||a.originalEvent.layerY||0},200)},_onMouseOut:function(){clearTimeout(this.timer)}})}(),yne_common_util_noteLink=function(a){var b=yne_jquery;return{isNoteLinkUrl:function(a){return/^note:\/\/[a-z0-9\-]+$/i.test(a)},getNoteId:function(a){if(a=b.trim(a||"")){var c=/^note:\/\/([a-z0-9\-]+)$/i,d=c.exec(a);if(d&&d[1])return d[1]}},fillAsUrl:function(a){if(a=b.trim(a||"")){var c=this;if(c.isNoteLinkUrl(a)&&(a=c.getNoteId(a)),a)return"note://"+a}}}}(),yne_common_views_ParagraphView=function(a){var b=yne_underscore,c=yne_jquery,d=yne_tinycolor,e=yne_common_views_BlockView,f=yne_common_selection_ParagraphRange,g=yne_common_data_RichText,h=yne_jtk_web_dom_nodeType,i=yne_common_constants,j=yne_jtk_core_L,k=yne_common_jst,l=yne_common_data_Rich2HtmlConvertor,m=yne_common_util_toCharArrayByCodePoint,n=yne_common_util_noteLink,o=yne_common_data_supportedInlineStyles,p=yne_common_fontMaps;return e.extend({className:"block-view paragraph-view",_template:k.getTemplate("common","paragraph_view"),_tempPlaceholder:null,initialize:function(){e.prototype.initialize.apply(this,arguments);var a=this,d=a.block;b.bindAll(a,"_onContentChange","_onStyleChange","_onHighlight"),d.on("content-change",a._onContentChange),d.on("style-change",a._onStyleChange),d.on("high-light",a._onHighlight),a._tempPlaceholder=c("<div></div>"),a._tempPlaceholder.height(0),a._tempPlaceholder.width(a.$el.width()),a._tempPlaceholder.css("display","inline-block")},render:function(){var a=this;a._renderTemplate(),a._renderText(),a._renderStyles(),e.prototype.render.apply(a,arguments)},_renderTemplate:function(){var a=this;a.$el.html(a._template())},convertToNativeRange:function(a){if(!a)return void j.warn("block range is unvalid!");var b,c,d=this;return(c=d._getCharacterInfo(a.start))?(b=document.createRange(),b.setStart(c.node,c.offset),(c=d._getCharacterInfo(a.end))?(b.setEnd(c.node,c.offset),b):void j.error("_getCharacterInfo blockRange.end error!")):void j.error("_getCharacterInfo blockRange.start error!")},parseNativeRange:function(a,b,c){var d,e,g,h=this;return c?new f({start:0,end:b.getEndOffset(),block:b}):(g=h.el.querySelector(".place-holder"),g&&" "===g.innerText?d=e=0:(d=h._getCharacterIndex(a.startContainer,a.startOffset,!0),-1===(e=h._getCharacterIndex(a.endContainer,a.endOffset,!1))&&(e=b.getEndOffset())),new f({start:d,end:e,block:b}))},_getCharacterInfo:function(a){var b,d=this,e=d.$el.find(".para-text").get(0),f=document.createNodeIterator(e,NodeFilter.SHOW_TEXT),g=f.nextNode(),h=0,i=0;if(0===a||!g)return c(e).children().first().hasClass("page-break-placeholder")&&(i=1),{node:g||e,offset:i};for(;g;){if(b=m(g.nodeValue),b.length>0&&h<a&&h+b.length>=a)return{node:g,offset:b.slice(0,a-h).reduce(function(a,b){return a+b.length},0)};h+=b.length,g=f.nextNode()}},_getTextOfNode:function(a){if(h.isText(a))return a.nodeValue;var b,c=document.createNodeIterator(a,NodeFilter.SHOW_TEXT),d="";if(!c)return"";for(b=c.nextNode();b;)d+=b.nodeValue,b=c.nextNode();return d},_charArrayLengthOfNode:function(a){var b=this,c=b._getTextOfNode(a);return m(c).length},_charArrayOffset:function(a,b){var c,d=m(a);for(c=0;c<d.length&&b>0;c++)b-=d[c].length;return c},_getCharacterIndex:function(a,b,d){var e,f,g=this,i=g.$el.find(".para-text").get(0),j=0;if(!c.contains(i,a)&&a!==i)return d?0:-1;for(h.isText(a)?j+=g._charArrayOffset(a.nodeValue,b):h.isElement(a)&&b>0&&(j+=g._charArrayLengthOfNode(a)),e=a;e!==i;){for(f=e.previousSibling;f;)"page-break"!==f.className&&"page-break-placeholder"!==f.className&&(j+=g._charArrayLengthOfNode(f)),f=f.previousSibling;e=e.parentNode}return j},_createHtmlForBlankLine:function(){var a,c,d,e=this,f=" ",h=new g({text:f}),i=document.createElement("span"),k="place-holder",m={},n=function(a,b){["bold","italic","font-family","font-size"].indexOf(b)>-1&&(m[b]=a)};return b.each(e.block.getInlineStylesForEmpty(),n),h.setStyles(0,f.length,m),a=l.rich2html(h),i.innerHTML=a,c=i.getElementsByTagName("span"),c&&c.length?1===c.length?(d=c[0],d.setAttribute("class",k),a=d.outerHTML):(j.error("_createHtmlForBlankLine error",i),a='<span class="place-holder">&nbsp;</span>'):(i.setAttribute("class",k),a=i.outerHTML),a},_renderText:function(){var a,e,g=this,h=g.block,i=h.getReadOnlyText(),j=g._inlineStyleViewMapper,k=g.$el.find(".para-text");a=i.isEmpty()?this._createHtmlForBlankLine():l.rich2html(i,{styleRules:{color:function(a){var b=a.color;return a.href!==o.getDefault("href")&&d.equals(a.color,"blue")?"#003884":null!=b&&j?j.valueToView("color",b):void 0},"font-family":function(a){var b,c=a["font-family"];return null!=c&&j&&(b=j.valueToView("font-family",c)),c!==b?b:p.getAllValueByFont(c)||c}}}),k.html(a),e=h.getStyleRanges("href"),b.each(e,function(a){var b,d,e;b=new f({start:a.from,end:a.to,block:h}),d=g.convertToNativeRange(b),(e=g._findLinkNode(d.endContainer))&&(c(e).off("hover"),c(e).hover(function(){n.isNoteLinkUrl(e.href)||g.isCollabLocked()||g.trigger("link-menu-show",{linkNode:e,range:b,block:h})},function(){g.trigger("link-menu-hide")}))})},_findLinkNode:function(a){for(var b=a;b&&"A"!==b.tagName;)b=b.parentNode;return b},_renderStyles:function(){var a=this,c=a.block,d=c.getBlockStyles();b.each(d,function(b,c){a._setStyle(c,b)}),a._renderStylesFix()},_renderStylesFix:function(){this.$el.find(".para-text").css("fontSize",l.getDefaultForHtml("font-size"))},_setStyle:function(a,b){var c=this.$el,d=c.find(".para-text");switch(a){case"align":d.css("text-align",b);break;case"line-height":b>0?d.css("line-height",String(b)):d.css("line-height","normal");break;case"indent":b=b>0?b:0,c.css("margin-left",b*i.INDENT_WIDTH||"");break;case"text-indent":b=b>0?b:0,d.css("text-indent",b*i.INDENT_WIDTH||"");break;default:j.warn("unknown block style: "+a)}},_onContentChange:function(){var a=this,c=!1;b.some(a._pageInfo,function(a){return a&&a.pageBreak&&(c=!0),c}),c&&a.$el.css("height",a.$el.height()),a._renderText(),a.trigger("view-height-changed",a.cid),c&&a.$el.css("height","auto")},_onStyleChange:function(a,b){var c=this;c._setStyle(a,b),c.trigger("view-height-changed",c.cid)},_convertToData:function(a,c){var d,e=this,g=e.block;b.each(a,function(a){d=new f({block:g,start:a.start,end:a.end}),c(e.convertToNativeRange(d))})},_onHighlight:function(a,b,c){var d=this,e=d.block,f=e.getHighlight(a,b);f&&d._convertToData(f,c)},_findOverflowSpan:function(a,b){var c,d,e,f,g,h=this,i=h._pageInfo[a-1];for(i?(d=i.pageBreak.isAtViewBeginning()?h.$el.find(".para-text").children().first():i.pageBreak.getPlaceholder().next(),f=h._getOffsetTopPos(i.pageBreak.getPlaceholder())+i.pageBreak.getPlaceholder().height()):(d=h.$el.find(".para-text").children().first(),f=h._getOffsetTopPos(h.$el)),d.is("span")||(d=d.find("span").first()),c=d,e=d;c.length>0&&(c.after(h._tempPlaceholder),g=h._getOffsetTopPos(h._tempPlaceholder)-f-b,c.outerHeight(!0)>0&&(e=c),!(g>0));)c=h._tempPlaceholder.next();return h._tempPlaceholder.remove(),{textSpan:e,overflowHeight:g,isFirstSpan:d===e}},_getContentContainer:function(){return this.$el.find(".para-text")},_handlePageOverflow:function(a,b){var c,d=this,e=d._getHeightInPage(a);return!((c=d.PAGE_HEIGHT-b)>e)&&(d._insertPageBreak(a,c),!0)},_insertPageBreak:function(a,b){var c,d,e,f,g,h,i=this;i.block.isEmpty()||b<=0||i._forcePageBreakBegin?c=i._insertPageBreakAtViewBeginning(a,0):(d=i._findOverflowSpan(a,b),d.overflowHeight<=0?(c=i._createPageBreak(a,Math.abs(d.overflowHeight)),0===d.textSpan.height()?d.textSpan.before(c.getPlaceholder()):d.textSpan.after(c.getPlaceholder())):i._isSplitAvailable(d.textSpan,d.overflowHeight)?(f=d.textSpan.height()-d.overflowHeight,e=i._splitTextSpan(d.textSpan,f),c=i._createPageBreak(a,f-e[0].height()),e[0].after(c.getPlaceholder())):d.isFirstSpan?c=i._insertPageBreakAtViewBeginning(a,b):(g=i._pageInfo[a-1],h=g&&g.pageBreak?b-(i._getOffsetTopPos(d.textSpan)-i._getOffsetTopPos(g.pageBreak.getPlaceholder())-g.pageBreak.getPlaceholder().height()):b-(i._getOffsetTopPos(d.textSpan)-i._getOffsetTopPos(i.$el)),h<0&&(h=0),c=i._createPageBreak(a,h),d.textSpan.before(c.getPlaceholder()))),i._coincidePageBreak(c),i._pageInfo[a].pageBreak=c},_insertPageBreakAtViewBeginning:function(a,b){var c,d=this;return c=d._createPageBreak(a,b),c.setAtViewBeginning(!0),d.$el.prepend(c.getPlaceholder()),c},_isSplitAvailable:function(a,b){var c,d,e;if(0===a.length||""===a.text())return!1;for(d=a.height()-b,c=document.createRange(),e=a[0].firstChild;null!=e&&("#text"!==e.nodeName.toLowerCase()||0===e.textContent.length);)e=e.nextSibling;return null!=e&&(c.setStart(e,0),c.setEnd(e,1),!(c.getBoundingClientRect().height>d)&&(c.setEnd(e,e.textContent.length),!(c.getBoundingClientRect().height<d)))},_splitTextSpan:function(a,b){var c,d,e,f=a[0].firstChild,g=0,h=a.text().length,i=[];for(c=document.createRange(),c.setStart(f,0);h-g>1&&(e=Math.ceil((h+g)/2),c.setEnd(f,e),(d=c.getBoundingClientRect().height)!==b);)d>b?h=e:g=e;if(d<=b){for(;e<a.text().length&&d<=b;)e++,c.setEnd(f,e),d=c.getBoundingClientRect().height;e-=1}else for(;e>0&&d>b;)e--,c.setEnd(f,e),d=c.getBoundingClientRect().height;return i[0]=a.clone(),i[1]=a.clone(),i[0].text(a.text().substr(0,e)),i[1].text(a.text().substr(e)),a.before(i[0]),a.before(i[1]),a.remove(),i}})}(),yne_common_commands_link_LinkMatch={test:function(a){var b=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:,@]+$/i,c=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i;return a=String(a),b.test(a)||c.test(a)||!1},matchEnd:function(a){var b,c,d=/(https?:\/\/|www\.|ssh:\/\/|ftp:\/\/)[a-z0-9&_+\-\?\/\.=\#,:@%\(\)~]+$/i,e=/[a-z0-9_+\-\.]+@[a-z0-9_+\-\.]+$/i;return a=String(a),(b=d.exec(a))?(c=b[0],{mail:!1,fullURI:0===c.toLowerCase().indexOf("www.")?"http://"+c:c,result:b}):(b=e.exec(a),b?(c=b[0],{mail:!0,fullURI:"mailto:"+c,result:b}):void 0)}},yne_common_views_CatalogueView=function(a){var b=yne_jquery,c=yne_common_jst,d=yne_common_constants,e=yne_tinycolor,f=yne_common_views_ParagraphView,g=yne_common_selection_ParagraphRange,h=yne_common_data_Rich2HtmlConvertor,i=yne_common_commands_link_LinkMatch,j=yne_common_data_supportedInlineStyles,k=yne_common_fontMaps,l=yne_common_util_noteLink,m="catalogue-view",n=f.extend({className:"block-view "+m,events:{"click a":"_onAnchorClick"},_forcePageBreakBegin:!0,initialize:function(){f.prototype.initialize.apply(this,arguments);var a=this,b=a.block;b.on("sorting-change",function(){a._renderSorting()}),b.on("focus",a.focus.bind(a)),b.on("blur",a.blur.bind(a))},_renderTemplate:function(){var a=this;a.$el.html(c.render("common","catalogue_view",{isFirst:a.block.isFirst()}))},_renderText:function(){var a,c=this,d=c.block,f=d.getReadOnlyText(),g=c._inlineStyleViewMapper,i=c.$el.find(".para-text"),l=b("<a></a>");a=h.rich2html(f,{styleRules:{color:function(a){var b=a.color;return a.href!==j.getDefault("href")&&e.equals(a.color,"blue")?"#003884":null!=b&&g?g.valueToView("color-catalogue",b):void 0},"font-family":function(a){var b,c=a["font-family"];return null!=c&&g&&(b=g.valueToView("font-family",c)),c!==b?b:k.getAllValueByFont(c)||c}}}),l.html(a),i.html(l),c._renderSorting(),c._addLinkMenu()},_onAnchorClick:function(a){var b=this,c=b.block.getHref();a.stopPropagation(),i.test(c)?b.trigger("open-link",c):b.trigger("inner-goto",c)},_addLinkMenu:function(){var a,b=this,c=b.block,d=b.$el.find("a");d.off("hover"),d.hover(function(){l.isNoteLinkUrl(c.getHref())||b.isCollabLocked()||(a=new g({start:0,end:c.getLength(),block:c}),b.trigger("link-menu-show",{linkNode:d[0],href:c.getViewHref(),range:a,block:c}))},function(){b.trigger("link-menu-hide")})},_renderSorting:function(){this._renderFirst(),this._renderLast()},_renderFirst:function(){var a,b,c=this,d=c.block,e=c.$el;if(!d.isFirst())return e.removeClass("catalogue-first");e.addClass("catalogue-first"),a=e.find(".catalogue-refresh"),b=e.find(".catalogue-delete"),a.off("click"),b.off("click"),a.on("click",function(){c.trigger("command","comp.RefreshCatalogue",{ownerId:d.getOwnerId()})}),b.on("click",function(){c.trigger("command","comp.RefreshCatalogue",{ownerId:d.getOwnerId(),delete:!0})})},_renderLast:function(){var a=this;if(!a.block.isLast())return a.$el.removeClass("catalogue-last");a.$el.addClass("catalogue-last")},_setStyle:function(a,b){var c,e=this,g=e.$el,h=g.find(".para-text"),i=e.block;switch(a){case"indent":c=i.getBlockStyle("text-indent"),b=c+b,b=b>0?b:0,h.css("text-indent",b*d.INDENT_WIDTH||"");break;case"text-indent":c=i.getBlockStyle("indent"),b=c+b,b=b>0?b:0,h.css("text-indent",b*d.INDENT_WIDTH||"");break;case"href":g.find("a").attr("href",i.getViewHref());break;default:f.prototype._setStyle.call(e,a,b)}},_onLockedChange:function(a){var b=this,c=b.block.getOwnerList();f.prototype._onLockedChange.call(b,a),c.updateLockState(b.isLocked())},getOwnerId:function(){return this.block.getOwnerId()},selectCatalogue:function(a){var b=this.block;a?b.trigger("select"):b.trigger("remove-select")},focus:function(){this.$el.addClass("catalogue-focus")},blur:function(){this.$el.removeClass("catalogue-focus")},_getHeightInPage:function(a){var b=n.__super__._getHeightInPage.apply(this,[a]),c=parseInt(this.$el.css("marginTop")),d=parseInt(this.$el.css("marginBottom"));return isNaN(c)||(b+=c),isNaN(d)||(b+=d),b}});return n}();var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}();yne_common_views_HandWriteView=function(a,b,c,d,e,f){var g=function(a){function g(){return null!==a&&a.apply(this,arguments)||this}return __extends(g,a),g.prototype.initialize=function(a){var c=this;b.prototype.initialize.apply(c,arguments),c._viewProps={block:a.block},c.bindSelectionEvents()},g.prototype.convertToNativeRange=function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setStart(c,c.childNodes.length),b},g.prototype.getImgElement=function(){return this.$el.find("img").get(0)},g.prototype.onDrawRange=function(a){var b,c=this;a?(c._addFocusedClass(),b=document.createRange(),b.selectNodeContents(c.$el.children(".handwrite-copy-hack")[0]),f.setRange(b,window)):(c._removeFocusedClass(),c.selectHandWrite(!1))},g.prototype.parseNativeRange=function(a,b,c){var d=this;if(c||d._isHandWriteInNativeRange(a)||d._isNativeRangeInHandWriteView(a)||d._isSelected())return new e({block:b})},g.prototype.selectHandWrite=function(a){a?this.$el.find(".attachment-container").addClass("selected"):this.$el.find(".attachment-container").removeClass("selected")},g.prototype.render=function(){var a,e,f=this;b.prototype.render.apply(f,arguments),e=f.block.getSource(d.IS_PC),a=c.render("common","handwrite-view-container",{src:e}),f.$el.html(a)},g.prototype._addFocusedClass=function(){this.$el.addClass("focused")},g.prototype._isHandWriteInNativeRange=function(a){var b,c=this,d=c.getImgElement(),e=window.Range;return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(e.START_TO_START,b)<1&&a.compareBoundaryPoints(e.END_TO_END,b)>-1},g.prototype._isNativeRangeInHandWriteView=function(a){var b,c=this,d=c.el;return b=a.commonAncestorContainer,3===b.nodeType&&(b=b.parentNode),!(b!==d&&!$.contains(d,b))},g.prototype._isSelected=function(){return this.$el.find(".attachment-container").hasClass("selected")},g.prototype._removeFocusedClass=function(){this.$el.removeClass("focused")},g}(b);return delete g.prototype.constructor,g.prototype.className="block-view handwrite-view",b.extend(g.prototype)}(0,yne_common_views_BlockView,yne_common_jst,yne_common_util_platform,yne_common_selection_HandWriteRange,yne_common_selection_nativeSelection),yne_common_views_HeadingView=function(a){var b=yne_common_views_ParagraphView;return b.extend({initialize:function(){b.prototype.initialize.apply(this,arguments)},className:"block-view heading-view",_renderText:function(){this.$el.find(".para-text").attr("id",this.block.getId()),b.prototype._renderText.apply(this)}})}(),yne_common_views_HrView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_HrRange;return b.extend({className:"block-view hr-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},render:function(){var a=this,c=a.block,d=c.getBlockStyle("width"),e=c.getBlockStyle("height");a.$el.html('<div class="hr-container"></div>').css({"text-align":c.getBlockStyle("align")}).find(".hr-container").css({width:d+"%",height:e,backgroundColor:c.getBlockStyle("color")}),b.prototype.render.apply(a,arguments)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,d){var e=this;if(d||e._isHrInNativeRange(a))return new c({block:b})},_isHrInNativeRange:function(a){var b,c=this,d=c.$el.find(".hr-container").get(0);return b=d.ownerDocument.createRange(),b.selectNode(d),a.compareBoundaryPoints(Range.START_TO_START,b)<1&&a.compareBoundaryPoints(Range.END_TO_END,b)>-1}})}(),yne_common_util_autoAdjustMenu=function(a){var b=yne_jquery;return{adjustMenu:function(a){var c=a.find(".menu-wrapper"),d=c.width(),e=b(a.children()[0]),f=a.offsetParent().width(),g=e.position().left;g<d&&e.width()<d?c.addClass("menu-wrapper-left"):c.removeClass("menu-wrapper-left"),f-g-e.width()<d?e.width()<d?(c.addClass("menu-wrapper-mini"),c.removeClass("menu-wrapper-right")):(c.addClass("menu-wrapper-right"),c.removeClass("menu-wrapper-mini")):(c.removeClass("menu-wrapper-mini"),c.removeClass("menu-wrapper-right")),c.show()}}}(),yne_common_util_uniqueSuffix=function(a){var b=yne_underscore,c=yne_jquery;return{isDataUrl:function(a){return/^data:/i.test(a)},isHttpUrl:function(a){return/^http/i.test(a)},has:function(a){return/\?\d+$/.test(String(a))},remove:function(a){return String(a).replace(/\?\d+$/,"")},addIfNeeded:function(a,d){var e=this;if(a=String(a),a=c.trim(a),e.isHttpUrl(a))return a;if(e.isDataUrl(a))return a;if(e.has(a)){if(!0!==d)return a;a=e.remove(a)}else if(/\?/.test(a))return a;return a+"?"+b.uniqueId()}}}(),yne_common_util_httpsConvert=function(){var a=/^http[s]{0,1}:\/\/note.youdao.com/,b=!1;return{setUseConvert:function(a){b=!!a},isInnerResoures:function(b){return a.test(b)},getURL:function(c){return b&&this.isInnerResoures(c)?c.replace(a,"//note.youdao.com"):c}}}(),yne_common_util_parseImageResourceId=function(a){return function(a){var b=a.getSource();if(b.startsWith("http")){var c=b.split("/");c.length>=2&&(b=c[c.length-2])}return b}}(),yne_common_views_ImageView=function(a){var b=yne_common_views_BlockView,c=yne_jquery,d=yne_underscore,e=yne_common_jst,f=yne_common_selection_ImageRange,g=yne_jtk_core_L,h=yne_common_util_autoAdjustMenu,i=yne_common_selection_nativeSelection,j=yne_common_util_userAgent,k=yne_common_util_formatLocalSource,l=yne_common_util_uniqueSuffix,m=yne_common_util_httpsConvert,n=yne_common_util_platform,o=yne_common_constants,p=yne_common_util_parseImageResourceId;return b.extend({className:"block-view image-view",DEFAULT_HEIGHT:100,_isFloatSwitch:!1,_$imgDiv:null,_$imgTitle:null,_viewFrameHeight:null,_isImgLoaded:null,events:{"mousedown .resize-handle":"_onMouseDownResizeHandle","mousedown img":"_onMouseDownImgPreview",mouseenter:"_onMouseEnter",mouseleave:"_onMouseLeave","mouseleave .menu-wrapper":"_onMouseLeaveMenuWrapper","click .yne-button-item":"_onButtonItemClick","click .yne-popup-item":"_onPopupMenuItemClick","dblclick img":"_onImgDblclick","click img":"_onImgClick","mousedown .image-title":"_onMouseDownImageTitleHandle"},_imageResizeStartInfo:null,_imageResizeEventNS:null,_imgHeightInData:null,_imgWidthInData:null,_imgHeightBeforeLoad:null,_imgLoadWidth:null,_disableOCR:null,initialize:function(a){var c=this;b.prototype.initialize.apply(c,[a]),c._imageResizeEventNS=".img-resize-"+d.uniqueId(),d.bindAll(c,"_onStyleChange","_onContentChange","_onChangeImageTitle","_onUpdateImageTitle","_editImgTitle","_handlerImgTitle","_onWinResize","_onHighlight"),c.block.on("edit-image-title",c._editImgTitle),c.block.on("style-change",c._onStyleChange),c.block.on("content-change",c._onContentChange),c.block.on("extra-info-change",c._onContentChange),c.block.on("view-resize",c._onWinResize),c.block.on("high-light",c._onHighlight),c.bindSelectionEvents(),c.on("resize",c._onWinResize),c.on("locked-change",function(){c.isLocked()&&(c.trigger("img-title-edit-exit"),c._removeFocusedClass())}),c._disableOCR=!!a.disableOCR||!n.IS_PC},render:function(){var a,c=this,f=c.block,g=f.getSource(!0),h=f.getTitle(),i=f.getImageInfo(),p=null,q=null,r=g;i&&(g="/yws/res/thumb/"+i.resId,i.rawWide<=620?(p=i.rawWide,q=i.rawHeight):p=620),c._imgLoadWidth=p,n.IS_PC&&(g=k(g)),(n.IS_WEB_NOTE||n.IS_WEB_GROUP)&&!0===f.getFakeLoading()&&(g=o.LOADING_IMAGE_PATH,f.setFakeLoading(!1)),a=e.render("common","image-view-image-container",{randomId:d.uniqueId("img-view"),width:p,height:q,src:"",hasOCR:!c._disableOCR}),c.$el.html(a),c._isImgLoaded=!1,c._$imgDiv=c.$el.find("img"),c._$imgTitle=c.$el.find(".image-title"),c._viewFrameHeight=c.$el.outerHeight(!0)-c.$el.height(),c._imgHeightInData=f.getBlockStyle("height",!0),c._imgWidthInData=f.getBlockStyle("width",!0),c._imgHeightBeforeLoad=c._$imgDiv.height(),c._$imgDiv.load(function(){c.$el.hasClass("focused")&&c._onUpdateImageTitle(!0),c._onImgLoaded()}),c._$imgDiv.attr("src",m.getURL(l.addIfNeeded(g))),c._renderStyles(),j.isSafari()&&c.$el.find(".image-container").attr("contenteditable","true"),b.prototype.render.apply(c,arguments),c.title=h,h?c._$imgTitle.text(h):c._$imgTitle.hide(),(n.IS_WEB_NOTE||n.IS_WEB_GROUP)&&c._loadOriginImg(r)},_renderStyles:function(){var a=this,b=a.block.getBlockStyles();d.each(b,function(b,c){a._setStyle(c,b)})},_setStyle:function(a,b){var d,e=this,f=e.$el,h=c("body").find(".image-title-hidden");switch(a){case"align":f.css("text-align",b),h.length&&h.css("text-align",b);break;case"width":d=e.getImgElement(),g.log("set image width: "+b),null==b&&null==e._imgLoadWidth?c(d).css("width",""):null==b&&e._imgLoadWidth?c(d).css("width",e._imgLoadWidth):e._setImageWidth(b);break;case"float":f.css("float")!==b?(e._isFloatSwitch=!0,f.css("float",b)):e._isFloatSwitch=!1,!1===e.isOnFloat()&&e._resetImageMaxWidth();break;case"height":break;default:g.error("unkown style name:",a)}},_onStyleChange:function(a,b){var c=this;c._setStyle(a,b),c.trigger("view-height-changed",c.cid)},_onContentChange:function(){var a=this,b=a.block,c=a.$el,d=b.getTitle(),e=b.getSource(!0);n.IS_PC&&(e=k(e)),e=m.getURL(l.addIfNeeded(e)),c.find("img").attr("src",e),a._$imgTitle.text(d),a.title=d,a._handlerImgTitle(),this.trigger("img-title-edit-exit"),a.trigger("view-height-changed",a.cid)},getImgElement:function(){return this.$el.find("img").get(0)},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d=this;if(c||i.isNodeInRange(d.getImgElement(),a)||i.isRangeInNode(d.el,a))return new f({block:b})},_showButtonGroup:function(){var a=this;a._hidePopupMenu(),h.adjustMenu(a.$el)},_hideButtonGroup:function(){var a=this;a.$el.find(".menu-wrapper").hide(),a._hidePopupMenu()},_onButtonItemClick:function(a){var b=this,c=a.currentTarget,d=c.dataset.buttonName;if(!b.isLocked())switch(d){case"menu":default:b._togglePopupMenu()}},_togglePopupMenu:function(){this.$el.find(".yne-popup-menu").toggle()},_hidePopupMenu:function(){this.$el.find(".yne-popup-menu").hide()},_onMouseEnter:function(){var a=this,b=a.block;a.isLocked()||b.isReadOnly()||a._showButtonGroup()},_onMouseLeave:function(){var a=this;a.isLocked()||a._hideButtonGroup()},_onMouseLeaveMenuWrapper:function(){var a=this;a.isLocked()||a._hidePopupMenu()},_onPopupMenuItemClick:function(a){g.log("click on menu item",a.currentTarget);var b=this,e=a.currentTarget,f=c(e).attr("data-cm-name"),h={},i=b.block;if(!b.isLocked()&&!i.isReadOnly()){switch(b._hidePopupMenu(),f){case"image-title":b._editImgTitle();break;case"float-left":case"float-right":case"clear-float":h.float="float-left"===f?"left":"float-right"===f?"right":"none";break;case"clear-resize":h.width=null;break;case"delete":b.trigger("command","comp.DeleteNoteRange",{range:null,imageBlockView:b});break;case"download":b.trigger("yne-download-image",i.getSource(!0));break;case"image-ocr":b.trigger("yne-image-ocr",p(i))}d.isEmpty(h)||b.trigger("command","comp.ApplyStyles",{range:null,imageBlockView:b,blockStyles:h})}},_removeFocusedClass:function(){var a=this;!a.$el.hasClass("focused")||a.isLocked()||a.block.isReadOnly()||(a.trigger("img-title-edit-end"),a.trigger("img-title-edit-exit"),a._handlerImgTitle()),a.$el.removeClass("focused")},_onUpdateImageTitle:function(a){var b=this,c=function(){var a=b._$imgTitle.offset();return{left:a.left,top:a.top,width:b.$el.width(),height:b._$imgTitle.height(),textAlign:b.block.getStyles("align")}};if(!b.isLocked()&&!b.block.isReadOnly())return a?void b.trigger("img-title-edit-update",c):b.$el.hasClass("focused")?void 0:void b.trigger("img-title-edit-start",b.block.getTitle(),c,b._onChangeImageTitle,b._$imgTitle,b.block.getId())},_addFocusedClass:function(){var a=this;a._onUpdateImageTitle(),a.$el.addClass("focused")},_drawNativeRange:function(){var a=this,b=document.createRange(),c=a.getImgElement();b.selectNode(c),b.collapse(!0),i.setRange(b)},onDrawRange:function(a){var b,c=this;a&&!c.isLocked()?(c._addFocusedClass(),b=document.createRange(),b.selectNodeContents(c.el.lastChild),i.setRange(b,window)):c._removeFocusedClass()},_onMouseDownResizeHandle:function(a){var b,d,e=this,f=e.getImgElement(),g=a.pageX,h=a.pageY,i={centerX:0,centerY:0,startWidth:0,startHeight:0,startToCenter:0},j=e.block;e.isLocked()||j.isReadOnly()||f&&(b=c(f),i.startWidth=b.width(),i.startHeight=b.height(),d=b.offset(),i.centerX=d.left+i.startWidth/2,i.centerY=d.top+i.startHeight/2,i.startToCenter=Math.sqrt(Math.pow(i.centerX-g,2)+Math.pow(i.centerY-h,2)),e._imageResizeStartInfo=i,e._bindEventsForResize(),a.preventDefault(),e.$el.css("height",e.$el.height()))},_bindEventsForResize:function(){var a=this,b=a.el.ownerDocument,d=a._imageResizeEventNS;a._unbindEventsForResize(),c(b).bind("mousemove"+d,a._onResizeMove.bind(a)).bind("mouseup"+d,a._onResizeEnd.bind(a))},_unbindEventsForResize:function(){var a=this,b=a.el.ownerDocument;c(b).unbind(a._imageResizeEventNS)},_onResizeMove:function(a){this._handleImageResize(a.pageX,a.pageY)},_onResizeEnd:function(a){var b=this;b.$el.css("height","auto"),b._unbindEventsForResize(),b._handleImageResize(a.pageX,a.pageY,!0)},_handleImageResize:function(a,b,c){
var d,e,f=this,h=f._imageResizeStartInfo,i={};if(h){if(d=Math.sqrt(Math.pow(h.centerX-a,2)+Math.pow(h.centerY-b,2)),e=d*h.startWidth/h.startToCenter,d*h.startHeight/h.startToCenter,!f.getImgElement())return void g.warn("no image element!");if(f._setImageWidth(e),!0!==c)return void f._onUpdateImageTitle(!0);i.width=f._$imgDiv.width(),i.height=f._$imgDiv.height(),f.trigger("command","comp.ApplyStyles",{range:null,imageBlockView:f,blockStyles:i})}},_onImgDblclick:function(){var a=this,b=a.block.getSource(!0);n.IS_PC&&a.trigger("yne-open-image",b)},_onImgClick:function(a){var b=this;b.trigger("img-title-edit-end"),(n.IS_WEB_GROUP||n.IS_WEB_NOTE||n.IS_MAC)&&(b.showImgPreview||b.isLocked()||b.block.isReadOnly())&&b.trigger("get-image-items",b.block),a.preventDefault(),a.stopPropagation()},_onMouseDownImgPreview:function(){var a=this;a.showImgPreview=a.$el.hasClass("focused")},_onChangeImageTitle:function(a,b,c,e){var f=this,g=f.block,h=[],i=[],j={};return a!==g.getTitle()&&(h.push({source:g.getSource(),title:a}),i.push(g),d.extend(j,{resources:i,resProps:h}),b&&d.extend(j,{endingRange:c}),f.trigger("command","comp.ReplaceResource",j)),!a&&e&&f._$imgTitle.hide(),!0},_onMouseDownImageTitleHandle:function(a){a.preventDefault()},onDestroy:function(){this.trigger("img-title-edit-exit")},_onWinResize:function(){var a=this;a.$el.hasClass("focused")&&a._onUpdateImageTitle(!0)},_onHighlight:function(a,b,c){var d=this,e=d.block,f=e.getHighlight(a,b);f&&d._convertToData(f,c)},_convertToData:function(a,b){var c,e=this,f=e._$imgTitle.get(0).firstChild;d.each(a,function(a){c=document.createRange(),c.setStart(f,a.start),c.setEnd(f,a.end),b(c)})},_editImgTitle:function(){var a=this;setTimeout(function(){a._$imgTitle.show(),a._onUpdateImageTitle(!0),a.trigger("img-title-edit-focus")},0)},_handlerImgTitle:function(){var a=this;a.title?a._$imgTitle.show():a._$imgTitle.hide()},disablePageMode:function(){var a=this;b.prototype.disablePageMode.apply(a),a.$el.hasClass("focused")&&a._onUpdateImageTitle(!0),a.$el.css("max-height","none"),a._resetImageMaxWidth()},_contentHeightOverflowCheck:function(){var a,b,c,d,e=this,f=e._$imgTitle.height(),h=0,i=e._$imgDiv.height();return e._isInPageMode()?(a=e.getLastTransPageIndex(),null!=a&&(b=e._getTopPosInPage(a),i=Math.ceil(i),h=Math.ceil(b+i+f+e._viewFrameHeight)-e.PAGE_HEIGHT,g.log("topPos/imgHeight/imgTitleHeight/page_height:",b,i,f,e.PAGE_HEIGHT)),h>0&&(c=e._$imgDiv.height()-h,c<o.PAGE_SPLIT_BLANK_HEIGHT/2&&(c=o.PAGE_SPLIT_BLANK_HEIGHT/2),d=e._$imgDiv.width()*c/e._$imgDiv.height(),e._$imgDiv.css("max-width",d)),h):h},_isPagingContinue:function(){return this._isFloatSwitch},_onImgLoaded:function(){var a,b=this;b._isImgLoaded=!0,b.$el.height("auto"),b._$imgDiv.height("auto"),a=b._$imgDiv.height(),b._imgHeightInData!==a||null==b._imgWidthInData?(b.block.setStyles("height",a),b._imgHeightInData=a):b._imgHeightBeforeLoad!==a?b.trigger("view-height-changed",b.cid):g.log("No height change after image loaded",b)},_resetImageMaxWidth:function(){var a=this;null!=a._$imgDiv&&a._$imgDiv.css("max-width","")},_setImageWidth:function(a){var b=this;null!=a&&(a=Math.ceil(a),b._$imgDiv.width(a),b._resetImageMaxWidth(),null!=b._imgHeightInData&&!1===b._isImgLoaded&&b._$imgDiv.height(Math.ceil(b._imgHeightInData*b._$imgDiv.width()/a)))},_setViewMaxHeight:function(a){var b=this,c=b._pageInfo[a-1],d=0,e=b._getTopPosInPage(a);c&&(d=b._getPageBreakBottomPosInView(a-1)),b.$el.css("max-height",b.PAGE_HEIGHT+d-b._viewFrameHeight-e),b._contentHeightOverflowCheck()},_loadOriginImg:function(a){var b=this;a=m.getURL(l.addIfNeeded(a)),c("<img />").attr("src",a).load(function(){b._$imgDiv.attr("src",a),b._$imgDiv.removeClass("filter-blur")}).error(function(){b._$imgDiv.unbind("error")}),b._$imgDiv.error(function(){b._$imgDiv.attr("src",a),b._$imgDiv.removeClass("filter-blur")})}})}(),yne_common_views_ListItemView=function(a){var b=yne_underscore,c=yne_common_views_ParagraphView,d=yne_common_jst,e=yne_common_data_listItemMarker,f=yne_common_util_userAgent;return c.extend({className:"block-view list-item-view paragraph-view",_template:d.getTemplate("common","list_item_view"),_styleSheet:null,initialize:function(){var a=this;c.prototype.initialize.apply(a,arguments),a._initEvents()},_initEvents:function(){var a=this,c=a.block,d=c.getOwnerList();if(!d)throw"no ownerList!";b.bindAll(a,"_onLevelChange","_onIndexChange","_onTypeChange","_onStyleChange"),c.on("level-change",a._onLevelChange),c.on("index-change",a._onIndexChange),d.on("type-change",a._onTypeChange),c.on("style-change",a._onStyleChange)},_renderLevel:function(){var a=this,b=a.block,c=b.getLevel(),d=a.$el.find(".li-box"),f=e.makeHtmlMarker(b);d.attr("data-level",c),f&&f.listStyleType&&d.attr("data-style-type",f.listStyleType)},_renderText:function(){var a=this;c.prototype._renderText.apply(a,arguments),a._renderMarkerText(),a._renderAlign()},_renderMarkerText:function(){var a,b=this,c=b.block.getText(),d=b.$el.find("li");d.attr("style",""),c.getLength()?a=e.convertToCssStyle(c.getStylesAtIndex(0),b._inlineStyleViewMapper):b.trigger("get-editing-styles",function(b){a=e.convertToCssStyle(b)}),a&&d.css(a)},_renderIndex:function(){var a=this,b=a.block;a.$el.find(".li-box").attr("start",b.getIndex())},render:function(){var a=this;c.prototype.render.apply(a,arguments),a._renderLevel(),a._renderIndex(),(f.isSafari()||f.isEdge())&&a.$el.addClass("no-inline"),a.trigger("view-height-changed",a.cid)},_renderTemplate:function(){var a=this,b=a.block;a.$el.html(a._template({isOrdered:b.isOrdered()}))},_onLevelChange:function(){var a=this;a._renderLevel(),a._renderIndex(),a.trigger("view-height-changed",a.cid)},_onIndexChange:function(){var a=this;a._renderIndex(),a.trigger("view-height-changed",a.cid)},_onTypeChange:function(){this.block._locked=!1,this.render()},_onStyleChange:function(a,b){var d=this,e=d.$el.find("li");switch(c.prototype._onStyleChange.apply(d,arguments),a){case"align":e.css("text-align",b)}},_renderAlign:function(){var a=this,b=a.$el.find("li"),c=a.block.getBlockStyle("align");c&&b.css("text-align",c)},_onContentChange:function(){var a=this;0===a.$el.find(".para-text").length&&a.render(),a._renderText(),a.trigger("view-height-changed",a.cid)},_getContentContainer:function(){return this.$el.find(".li-box")}})}(),yne_common_util_events=function(a){var b=yne_jtk_core_L,c=yne_underscore;return{bubble:function(a,d,e,f){if(!a||!d||!e)return void b.log("arguments are not valid",arguments);var g=c.isArray(a);c.each(a,function(a,b){a&&(g?b=a:!0===a&&(a=b),!0===f&&d.off(b),d.on(b,e.trigger.bind(e,a)))})},addListeners:function(a,d,e,f){if(!a||!d||!e)return void b.log("arguments are not valid",arguments);c.each(a,function(a,b){!0===f&&d.off(b),d.on(b,e[a].bind(e))})}}}(),yne_jtk_core_Base=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jtk_core_Class,e=c.extend({},b.Events);return d.extend(e)}(),yne_common_util_Draggable=function(a){var b,c=yne_jtk_core_Base,d=yne_underscore;return b=c.extend({initialize:function(a){d.bindAll(this,"onMouseDown","onMouseMove","onMouseUp"),this.el=a.el,this.disableDocSelection=!0===a.disableDocSelection,this.document=this.el.ownerDocument,this._makeDraggable()},_makeDraggable:function(){var a=this,b=this.el;b.addEventListener("mousedown",this.onMouseDown),a._setUserSelect(b,"none")},_getUserSelect:function(a){return a.style.webkitUserSelect||a.style.mozUserSelect||a.style.msUserSelect||a.style.userSelect||""},_setUserSelect:function(a,b){a.style.webkitUserSelect=b,a.style.mozUserSelect=b,a.style.msUserSelect=b,a.style.userSelect=b},onMouseDown:function(a){if(1===a.which){var c=this,d=this.el,e=this.document;d.setCapture&&d.setCapture(),e.addEventListener("mousemove",this.onMouseMove),e.addEventListener("mouseup",this.onMouseUp),c.disableDocSelection&&(c._backupDocUserSelect=c._getUserSelect(e.body),c._setUserSelect(e.body,"none")),this.trigger(b.DRAG_START,a)}},onMouseMove:function(a){1===a.which&&this.trigger(b.DRAGGING,a)},cancel:function(){var a=this,b=this.el,c=this.document;b.releaseCapture&&b.releaseCapture(),c.removeEventListener("mousemove",this.onMouseMove),c.removeEventListener("mouseup",this.onMouseUp),a.disableDocSelection&&a._setUserSelect(c.body,a._backupDocUserSelect)},onMouseUp:function(a){1===a.which&&(this.cancel(),this.trigger(b.DRAG_END,a))}},{DRAG_START:"drag-start",DRAGGING:"dragging",DRAG_END:"drag-end"})}(),yne_jtk_web_dom_remove=function(a){var b=yne_jtk_web_dom_nodeType;return function(a,c){if(b.isNode(a)){if(c=!1!==c,a.removeNode&&c)return a.removeNode(a,c);if(a.parentNode&&a.parentNode.removeChild){if(!c)for(;a.firstChild;)a.parentNode.insertBefore(a.firstChild,a);return a.parentNode.removeChild(a)}}}}(),yne_common_views_table_SelectionView=function(a){var b=yne_common_util_rect;return yne_backbone.View.extend({tagName:"div",className:"selection-layer",initialize:function(a){var b=a.tableView;this._tableView=b},render:function(){this.$el.attr("contenteditable","false")},hide:function(){this.$el.hide()},_computeViewRect:function(a){if(a){var c,d,e,f,g=this,h=g._tableView,i=a.getAsRectRange();if(i&&(c=i.getFirstCell(),d=i.getLastCell(),c&&c.cell&&d&&d.cell))return e=h.getBoundingRectByCell(c.cell),f=h.getBoundingRectByCell(d.cell),b.union(e,f)}},draw:function(a){var b=this,c=b._computeViewRect(a);c&&c.width>0&&c.height>0?b.$el.css({top:c.top,left:c.left,width:c.width,height:c.height}).show():b.$el.hide()}})}(),yne_common_key_KeyHandlerManager=function(a){var b=yne_jtk_core_Base,c=yne_jtk_core_L,d=yne_underscore,e={_keyHandlerMap:{},_parseKey:function(a){return a+="",a=a.replace(/[\s\uFEFF\xA0]/g,""),a=a.toLowerCase()},_makeMapKey:function(a,b){return(a=a||"main")+"-"+b},getHandler:function(a,b){return this._keyHandlerMap[this._makeMapKey(a,b)]},register:function(a){if(!(a&&a.name&&a.key&&a.action))return void c.warn("The param is not valid!",a);var b,e,f,g=this._keyHandlerMap;return e=d.defaults({},a,{scope:"main",read:!1,preventDefault:!0}),e.key=b=this._parseKey(a.key),b?(f=this._makeMapKey(e.scope,e.name),g[f]||d.some(g,function(a){return a.key===b&&a.scope===e.scope})?void c.error("The key handler is conflict with other",e):void(g[f]=e)):void c.warn("The key is not valid!",a)},exec:function(a,b,d,e){var f=this._makeMapKey(a,b),g=this._keyHandlerMap[f];return g?d.isReadOnly&&d.isReadOnly()&&!g.read?void(e&&e.preventDefault&&e.preventDefault()):(g.preventDefault&&e&&e.preventDefault&&e.preventDefault(),void g.action.apply(g,[d,e,b])):void c.warn("No key handler for scope/name: ",a,b)},matchKey:function(a,b){if(b){var e,f=this._keyHandlerMap;return e=d.find(f,function(c){return c.key===b&&c.scope===a}),e?e.name:void c.warn("Can not find the key handler with key: "+b)}},getAllHandlerNamesOfScope:function(a){var b=[];return d.each(this._keyHandlerMap,function(c){c.scope===a&&b.push(c.name)}),b}};return b.extend({initialize:function(a){var b=this;a=d.defaults(a||{},{scope:"main"}),b._scope=a.scope,b._customMap={},delete b.options},getKey:function(a){var b=this;return(b._customMap[a]||e.getHandler(b._scope,a)||{}).key},bind:function(a){var b=this,c=b.getKey(a);c&&b.trigger("bind-key",c)},unbind:function(a){var b=this,c=b.getKey(a);c&&b.trigger("unbind-key",c)},updateKey:function(a,b){if(a&&b){var c=this;e.getHandler(c._scope,a)&&(c.unbind(a),c._customMap[a]={key:b},c.bind(a))}},hasHandler:function(a){var b=this;return!!e.getHandler(b._scope,a)},execWithKey:function(a,b,f){var g,h=this;if(d.some(h._customMap,function(b,c){if(b.key===a)return g=c,!0}),g||(g=e.matchKey(h._scope,a)),!g)return void c.warn("no handler for scope/key ",h._scope,a);e.exec(h._scope,g,b,f)},execWithName:function(a,b,c){e.exec(this._scope,a,b,c)},getAvailableHandlerNames:function(){return e.getAllHandlerNamesOfScope(this._scope)}},{register:function(a){e.register(a)}})}(),yne_common_views_table_ChangeMonitor=function(a){var b,c=yne_jtk_core_Base,d=yne_jquery,e=yne_jtk_core_L,f=window.MutationObserver||window.WebKitMutationObserver;return b=c.extend({initialize:function(a){var b=this;a=a||{},b._el=a.el,b._monitoring=!1,b._hasBindDOMSubtreeModified=!1,delete b.options,f&&(b._observer=new f(function(){b._fireChange()}))},_fireChange:function(){var a=this;!0===a._monitoring&&a.trigger("content-change")},observe:function(){var a=this;a.isMonitoring()||(a._observer?a._observer.observe(a._el,{childList:!0,attributes:!0,subtree:!0,characterData:!0,attributeFilter:["style"]}):!1===a._hasBindDOMSubtreeModified&&(a._hasBindDOMSubtreeModified=!0,d(a._el).on("DOMSubtreeModified",a._fireChange.bind(a))),a._monitoring=!0)},disconnect:function(){var a=this;a._monitoring=!1,a._observer&&a._observer.disconnect()},destroy:function(){var a=this;a._observer?(a._observer.disconnect(),a._observer=null):!0===a._hasBindDOMSubtreeModified&&d(a._el).off("DOMSubtreeModified")},isMonitoring:function(){return this._monitoring}},{create:function(a){return a&&a.el?new b(a):void e.warn("Failed to create ChangeMonitor")}})}(),yne_parser_html_handlers_tagHandlers=function(a){var b=yne_underscore,c=yne_jtk_core_L,d={h1:32,h2:24,h3:18,h4:16,h5:13,h6:12},e={1:12,2:13,3:16,4:18,5:24,6:32,7:48},f={b:function(a){a.bold=!0},i:function(a){a.italic=!0},u:function(a){a.underline=!0},strike:function(a){a.strike=!0},code:function(a){a["font-family"]="monospace"},mark:function(a){a["back-color"]="#ffff00",a.color="#000000"},font:function(a,b){var c,d=b.getAttribute("color"),f=b.getAttribute("face"),g=b.getAttribute("size");d&&(a.color=d),f&&(a["font-family"]=f),g&&(c=e[g])&&(a["font-size"]=c)},pre:function(a){a["white-space"]="pre"},a:function(a,b){b&&b.href&&(a.color="#003884",a.underline=!0)}},g=function(a,d){var e=f[a];if(!e)return void c.error("The tag handler for `"+a+"` does not exist!");b.each(d,function(a){f[a]||(f[a]=e)})};return b.each(d,function(a,b){f[b]=function(b){b.bold=!0,b["font-size"]=a}}),g("b",["strong"]),g("i",["em","cite","var","address","dfn"]),g("strike",["s","del"]),g("u",["ins"]),g("code",["tt","kbd","samp","pre","xmp","plaintext","listing"]),f}(),yne_parser_html_utils_convertColor=function(a){var b=yne_tinycolor,c=yne_underscorestring,d="null",e={};return function(a,f){var g,h;if((a=c(a).trim().toLowerCase().value())&&"inherit"!==a){if(f&&"transparent"===a)return a;if(g=e[a])return g===d?void 0:g;if(h=b(a),h.isValid())return 0===h.getAlpha()?void(e[a]=d):(g=h.toHexString(),e[a]=g,g);e[a]=d}}}(),yne_parser_html_handlers_styleHandlers=function(a){var b=yne_underscorestring,c=yne_common_constants,d=yne_underscore,e=yne_parser_html_utils_convertColor,f=["bold","bolder","700","800","900"],g=yne_common_fontMaps,h={"xx-small":12,"x-small":12,small:13,medium:16,large:18,"x-large":24,"xx-large":32};return{bold:{inheritable:!0,action:function(a){var c=a.style.fontWeight;return c=c&&b.trim(c).toLowerCase(),c&&"inherit"!==c?-1!==d.indexOf(f,c):null}},italic:{inheritable:!0,action:function(a){var b=a.style.fontStyle;return b?"italic"===b:null}},underline:{inheritable:!0,action:function(a,b,c){var d=a.style.textDecoration;return!!/(^|\s)underline($|\s)/i.test(d)||!(d&&!c)&&c}},strike:{inheritable:!0,action:function(a,b,c){var d=a.style.textDecoration;return!!/(^|\s)line-through($|\s)/i.test(d)||!(d&&!c)&&c}},"font-family":{inheritable:!0,action:function(a){var b=a.style.fontFamily;return 0===b.trim().indexOf("-apple-system")?g.DEFAULT_FONT:g.getFontFirstValue(b)}},"font-size":{inheritable:!0,action:function(a,c,d){var e=a.style.fontSize;if(e=b.trim(e+""),/^[\d.]+px$/.test(e)?e=parseInt(e,10):/^[\d.]+pt$/.test(e)?e=Math.floor(4*parseFloat(e,10)/3):/^[\d.]+em$/.test(e)?(e=parseFloat(e,10),e*=d||14,e=Math.floor(e)):/^[\d.]+rem$/.test(e)?(e=parseFloat(e,10),e*=10,e=Math.floor(e)):e=h[e],e&&!isNaN(e))return e}},color:{inheritable:!0,action:function(a){var b=a.style.color;return e(b,!1)}},"back-color":{inheritable:!0,action:function(a){var b=a.style.backgroundColor;return e(b,!0)}},align:{inheritable:!0,action:function(a){var c=a.style.textAlign||a.align;if((c=c&&b.trim(c).toLowerCase())&&"inherit"!==c)return c}},"line-height":{inheritable:!0,requireValues:["font-size"],action:function(a,c){var d=b.trim(a.style.lineHeight+""),e=c["font-size"]||14;if(/^[\d.]+$/.test(d)?d=parseFloat(d,10):/^[\d.]+px$/.test(d)?(d=parseFloat(d,10),d/=e):d=0,d&&!isNaN(d)&&d>1)return d}},indent:{inheritable:!0,action:function(a,b,c){var d=0;return"BLOCKQUOTE"===a.tagName&&(d=1),d+=c||0}},"text-indent":{inheritable:!0,action:function(a){var d=a.style.textIndent;if(d=b.trim(d+""),d=/^[\d.]+px$/.test(d)?parseFloat(d,10):/^[\d.]+pt$/.test(d)?4*parseFloat(d,10)/3:null)return(d=Math.floor(d/c.INDENT_WIDTH))||1}},width:{inheritable:!1,action:function(a){var c=a.style.width||a.width;if(c=b.trim(c+""),/^[\d.]+(px)?$/.test(c)&&(c=parseInt(c,10)),c&&!isNaN(c))return c}},float:{inheritable:!1,action:function(a){return a.style.float}},"white-space":{inheritable:!0,action:function(a){var b=a.style.whiteSpace;if(b&&"inherit"!==b)return b}}}}(),yne_parser_html_handlers_BaseHandler=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L,f=yne_parser_html_handlers_tagHandlers,g=yne_parser_html_handlers_styleHandlers;return b=c.extend({inheritStyleHandlers:null,uninheritStyleHandlers:null,tagHandler:null,el:null,parent:null,children:null,styles:null,parser:null,options:null,constructor:function(a,b,c,d,e){var f=this;f.el=a,f.children=[],f.parent=b,f.internalStylesParser=c,f.parent&&f.parent.children&&f.parent.children.push(f),f._computeStyles(),f.computeBulbStyles(),f.parser=d,f.options=e},computeBulbStyles:function(){},_findStyleHandler:function(a,c){var f,g=this,h=a?g.inheritStyleHandlers:g.uninheritStyleHandlers,i=h[c];if(d.isFunction(i))return{action:i};if(d.isObject(i)&&i.action)return i;if(!0===i&&(f=b.styleHandlers[c])&&f.action)return f.inheritable!==a?void e.error("The inheritable value of "+c+" is unvalid!"):f},_computeStyles:function(){var a=this,c=a.el,d={},e=a.tagHandler||b.tagHandlers[c.tagName.toLowerCase()];e&&e(d,c),a.styles={},a._computeInheritStyles(d),a._computeUninheritStyles(d)},_computeStyle:function(a,b){var c,e,f,g=this,h=null!=g.inheritStyleHandlers[b],i=g.parent,j=g.el;null==g.styles[b]&&(h&&!i||(c=g._findStyleHandler(h,b))&&c.action&&(c.requireValues&&c.requireValues.length&&d.each(c.requireValues,function(b){g._computeStyle(a,b)}),h?(e=(i.styles||{})[b],f=c.action(j,g.styles,e),f||!1===f||(f=a[b]),f||!1===f||(f=e)):(f=c.action(j,g.styles))||!1===f||(f=a[b]),(f||!1===f)&&(g.styles[b]=f)))},_computeInheritStyles:function(a){var b=this;b.inheritStyleHandlers&&d.each(b.inheritStyleHandlers,function(c,d){c&&b._computeStyle(a,d)})},_computeUninheritStyles:function(a){var b=this;b.uninheritStyleHandlers&&d.each(b.uninheritStyleHandlers,function(c,d){c&&b._computeStyle(a,d)})},setup:function(){},capture:function(){e.warn("Function capture should be implemented by SubClass")},finish:function(){},handleChildrenBySelf:function(){return!1},emit:function(a){var b=this;b.parent&&b.parent.capture(a)},getRoot:function(){var a=this;if(a.parent)return a.parent.getRoot()}},{tagHandlers:f,styleHandlers:g})}(),yne_common_util_headingMaps=function(a){var b,c,d,e,f=yne_underscore,g=!0,h={};b={default:{name:"普通文本","font-size":14},a:{name:"标题","font-size":32,bold:g},b:{name:"副标题","font-size":18,color:"#595959",bold:g},1:{name:"标题1","font-size":28,bold:g},2:{name:"标题2","font-size":20,bold:g},3:{name:"标题3","font-size":16,bold:g},4:{name:"标题4","font-size":14,bold:g}},c=[b.default,b.a,b.b,b[1],b[2],b[3],b[4]],d={};for(e in b)"default"!==e&&(h[e]=f.clone(b[e]),delete h[e].name,delete h[e].align);return{headingMap:b,headingArray:c,headingBlockStyles:d,headingInlineStyles:h}}(),yne_common_data_Heading=function(a){function b(a,b){var c=a.getLevel();c&&g(b).attr("level",c),g(b).attr("compat","true")}function c(a,b){var c=g(b).attr("level");a.setLevel(c)}var d,e,f,g=yne_jquery,h=yne_jtk_core_L,i=yne_underscore,j=yne_common_data_Paragraph,k=yne_common_data_RichText,l=yne_common_data_blockTypes,m=yne_common_util_headingMaps,n=yne_common_util_unknownTree,o=yne_common_util_blockStyles,p=yne_common_data_Rich2HtmlConvertor;return e={_type:l.HEADING,_level:null,initialize:function(){var a=this,b=a.options;j.prototype.initialize.apply(a,arguments),a.setLevel(b.level)},setLevel:function(a){a&&(this._level=a,this.trigger("content-change",this))},getLevel:function(){return this._level},getDefaultBlockStyles:function(){return i.extend({},d.__super__.getDefaultBlockStyles.apply(this,[]),m.headingBlockStyles[this._level])},getDefaultInlineStyles:function(){return i.extend({},d.__super__.getDefaultInlineStyles(),m.headingInlineStyles[this._level])},getBlockStyle:function(a,b){return"heading"===a?this._level:d.__super__.getBlockStyle.call(this,a,b)},getInlineStylesForEmpty:function(){return i.extend({heading:this.level},this.getDefaultInlineStyles())},toHtml:function(a,b,c){var d,e,f,h=this,i=document.createElement("div"),j=g(i);return c=!0===c,j.attr("yne-bulb-block","heading").attr("yne-bulb-level",h.getLevel()).attr("id",h.getId()).css("white-space","pre-wrap"),h._applyBlockStylesOnElement(j),a=a||0,b=null==b?h.getEndOffset():b,d=h.sliceText(a,b,!1),e=p.rich2html(d,{withDefault:c}),j.html(e),f=i.outerHTML,i=j=null,f},toXml:function(a){var c=this,e=d.__super__.toXml.apply(c,[a]);return b(c,e),e},toJSON:function(a,b){var c=this,e=c.sliceText(a,b,!1),f=d.__super__.toJSON.apply(c);return f.richText=e.toJSON(),f.level=c.getLevel(),f},toCollabJSON:function(){var a=this,b=d.__super__.toJSON.apply(a);return b.richText=a._richText.toCollabJSON(),b.level=a.getLevel(),b}},f={fromXml:function(a){var b=new d;return b.parseIdFromXml(a),b.setText(k.fromXml(a)),c(b,g(a)),g(a).children().each(function(a,c){switch(c.nodeName){case j.TAG_ID_NAME:case j.LEGACY_TAG_ID_NAME:case"text":case"inline-styles":break;case"styles":o.fromXml(b,c);break;default:n.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){return this._generalFromJSON(a,!1)},fromCollabJSON:function(a){return this._generalFromJSON(a,!0)},_generalFromJSON:function(a,b){if(!a||!a.blockType||a.blockType!==l.HEADING||!a.richText)return void h.warn("jsonObj is not valid!");var c,e=new d;return c=b?k.fromCollabJSON(a.richText):k.fromJSON(a.richText),e.setText(c),i.each(a.styles,function(a,b){e.setBlockStyle(b,a)}),a.blockId&&e.setId(a.blockId),a.level&&e.setLevel(a.level),e}},d=j.extend(e,f)}(),yne_parser_html_utils_handleParagraphSpaces=function(a){var b=yne_underscore,c=yne_underscorestring,d=["normal","nowrap","pre-line"],e=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/[ \t]+/g," "):a:a.replace(/[ \t\r\n]+/g," ")},f=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/^[ \t]+/g,""):a:a.replace(/^[ \t\r\n]+/g,"")},g=function(a,b){return b&&"normal"!==b&&"nowrap"!==b?"pre-line"===b?a.replace(/[ \t]+$/g,""):a:a.replace(/[ \t\r\n]+$/g,"")},h=function(a){var c=a.styles["white-space"];return!c||b.contains(d,c)};return function(a){var d,i,j,k,l,m;for(b.each(a,function(a){a.text=e(a.text,a.styles["white-space"])}),j=a.length,d=0;d<j&&(k=a[d],k.text=f(k.text,k.styles["white-space"]),!k.text);d++);for(d=0,i=1;i<j;i++)l=a[d],m=a[i],h(l)&&h(m)&&(c.endsWith(l.text," ")&&c.startsWith(m.text," ")&&(m.text=m.text.slice(1)),""===m.text)||(d=i);for(d=j-1;d>=0&&(k=a[d],k.text=g(k.text,k.styles["white-space"]),!k.text);d--);return a}}(),yne_common_data_Catalogues=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_Class,e=yne_jtk_core_assert,f=yne_collaboration_collabUtils,g=d.extend(b.extend({_id:null,_items:null,unknownAttrs:null,state:null,initialize:function(a){var b=this;b._id=a.id||f.newGUID(),b._items=[],b.unknownAttrs=[]},getId:function(){return this._id},getItems:function(){return this._items},getLength:function(){return this._items.length},updateIndexes:function(){var a=this,b=a._items;b.forEach(function(a,c){a.removeSorting(),0===c&&a.setFirst(),c===b.length-1&&a.setLast()})},insertBefore:function(a,b){var c=this,d=c._items,e=b?d.indexOf(b):0;c.insertItem(e,a)},insertAfter:function(a,b){var c=this,d=c._items,e=b?d.indexOf(b):-1;c.insertItem(e+1,a)},insertItem:function(a,b){var c=this,d=c._items;return e(a>0||a<=d.length),d.splice(a,0,b),c.updateIndexes(),a},removeItem:function(a){var b=this,c=b._items,d=c.indexOf(a);return d>=0&&(c.splice(d,1),b.updateIndexes()),d},select:function(){var a=this,b=a._items;a.isLock()||b[0]&&b[0].focus()},removeSelect:function(){var a=this,b=a._items;b[0]&&b[0].blur()},updateLockState:function(a){this.state=a,this.state&&this.removeSelect()},isLock:function(){return!!this.state}}),{fromXml:function(a){var d=c(a),e=d.attr("id"),f=new g({id:e});return b.each(a.attributes,function(a){switch(a.nodeName){case"id":case"type":break;default:f.unknownAttrs.push(a.cloneNode(!0))}}),f}});return g}(),yne_common_data_Catalogue=function(a){var b,c,d,e=yne_jquery,f=yne_jtk_core_L,g=yne_underscore,h=yne_common_data_Paragraph,i=yne_common_data_RichText,j=yne_common_data_blockTypes,k=yne_common_data_Catalogues,l=yne_common_util_unknownTree,m=yne_common_util_blockStyles,n=yne_common_data_Rich2HtmlConvertor,o=yne_collaboration_collabUtils;return c={_type:j.CATALOGUE,_href:null,_level:null,_isFirst:null,_isLast:null,initialize:function(){var a=this,b=a.options;h.prototype.initialize.apply(a,arguments),a.setHref(b.href),a.setIndent(b.indent),b.ownerList&&a.setOwnerList(b.ownerList),a.on("attached",a._onAttached.bind(a)),a.on("detached",a._onDetached.bind(a)),a.on("select",a._onSelect.bind(a)),a.on("remove-select",a._onRemoveSelect.bind(a))},setOwnerList:function(a){this._ownerList=a},getOwnerList:function(){return this._ownerList||f.warn('No ownerList! check have "setOwnerList"'),this._ownerList},getOwnerId:function(){return this.getOwnerList().getId()},_onAttached:function(a){var b=this,c=b.getOwnerList(),d=a.getPreBlock(b),e=a.getNextBlock(b);if(!c)return b.findAndSetOwnerList(a);d&&j.isCatalogue(d)&&d.getOwnerId()===b.getOwnerId()?c.insertAfter(b,d):e&&j.isCatalogue(e)&&e.getOwnerId()===b.getOwnerId()?c.insertBefore(b,e):c.insertAfter(b,null)},findAndSetOwnerList:function(a){var b,c=this,d=a.getPreBlock(c),e=a.getNextBlock(c),g=c._oldOwnerId;return g?j.isCatalogue(e)&&g===e.getOwnerId()?(b=e.getOwnerList(),c.setOwnerList(b),b.insertBefore(c,e)):j.isCatalogue(d)&&g===d.getOwnerId()?(b=d.getOwnerList(),c.setOwnerList(b),b.insertAfter(c,d)):(b=new k({id:g}),c.setOwnerList(b),b.insertAfter(c,null)):f.error("No oldOwnerId!")},_onDetached:function(){this.getOwnerList().removeItem(this)},_onSelect:function(){this.getOwnerList().select()},_onRemoveSelect:function(){this.getOwnerList().removeSelect()},focus:function(){this.trigger("focus")},blur:function(){this.trigger("blur")},setIndent:function(a){a>0&&this.setBlockStyle("indent",a)},setHref:function(a){this._href=a||null,this.trigger("style-change","href",a)},getHref:function(){return this._href},getViewHref:function(){var a=this._href;return o.isGUID(a)?null:a},getHtmlHref:function(){var a=this._href;return o.isGUID(a)?"#"+a:a||"#"},setFirst:function(){this._isFirst||(this._isFirst=!0,this.trigger("sorting-change"))},isFirst:function(){return this._isFirst},setLast:function(){this._isLast||(this._isLast=!0,this.trigger("sorting-change"))},isLast:function(){return this._isLast},removeSorting:function(){var a=!1;this._isFirst&&(a=!0,this._isFirst=null),this._isLast&&(a=!0,this._isLast=null),a&&this.trigger("sorting-change")},toHtml:function(a,b,c){var d,f,g,h=this,i=document.createElement("div"),j=e("<a></a>"),k=e(i),l="";return c=!0===c,k.attr("yne-bulb-block","catalogue").css("white-space","pre-wrap"),h.isFirst()&&(l="first"),h.isLast()&&(l+="last"),k.attr("yne-bulb-order",l),h._applyBlockStylesOnElement(k,!0),a=a||0,b=null==b?h.getEndOffset():b,d=h.sliceText(a,b,!1),f=n.rich2html(d,{withDefault:c}),j.attr("href",h.getHtmlHref()).html(f),k.html(j),g=i.outerHTML,i=k=j=null,g},toXml:function(a){var b,c,d,f,g=this,i=h.__super__.toXml.apply(g,[a]),j=a.createElement("text"),k=g._richText.toString(),n=a.createTextNode(k);return j.appendChild(n),i.appendChild(j),f=g._richText.toXml(a,!0),f&&i.appendChild(f),b=a.createElement("styles"),m.toXml(g,b,a),i.appendChild(b),g.getHref()&&(c=a.createElement("href"),d=a.createElement("value"),e(d).text(g.getHref()),c.appendChild(d),i.appendChild(c)),l.appendToXml(g.unknownTree,i),e(i).attr("catalogue-id",g.getOwnerId()),e(i).attr("compat","true"),i},toJSON:function(a,c){var d=this,e=d.sliceText(a,c,!1),f=b.__super__.toJSON.apply(d);return f.richText=e.toJSON(),f.href=d.getHref(),f.ownerId=d.getOwnerId(),f},toCollabJSON:function(){var a=this,c=b.__super__.toJSON.apply(a);return c.richText=a._richText.toCollabJSON(),c.href=a.getHref(),c.ownerId=a.getOwnerId(),c}},d={fromXml:function(a){var c,d=new b;return d.parseIdFromXml(a),d.setText(i.fromXml(a)),e(a).children().each(function(a,b){switch(b.nodeName){case h.TAG_ID_NAME:case h.LEGACY_TAG_ID_NAME:case"text":case"inline-styles":break;case"styles":m.fromXml(d,b);break;case"href":c=e(b).find("value").text(),d.setHref(e(b).find("value").text());break;default:l.appendToTree(d.unknownTree,b)}}),d},fromJSON:function(a){return this._generalFromJSON(a,!1)},fromCollabJSON:function(a){var b=this._generalFromJSON(a,!0);return a.ownerId&&(b._oldOwnerId=a.ownerId),b},_generalFromJSON:function(a,c){if(!a||!a.blockType||a.blockType!==j.CATALOGUE||!a.richText)return void f.warn("jsonObj is not valid!");var d,e=new b;return d=c?i.fromCollabJSON(a.richText):i.fromJSON(a.richText),e.setText(d),g.each(a.styles,function(a,b){e.setBlockStyle(b,a)}),a.blockId&&e.setId(a.blockId),a.href&&e.setHref(a.href),e}},b=h.extend(c,d)}(),yne_parser_html_handlers_ParagraphHandler=function(a){var b,c=yne_parser_html_handlers_BaseHandler,d=yne_common_data_blockTypes,e=yne_common_data_Heading,f=yne_common_data_Paragraph,g=yne_common_data_Todo,h=yne_common_data_RichText,i=yne_parser_html_utils_handleParagraphSpaces,j=yne_common_constants,k=yne_underscore,l=yne_common_data_Catalogue,m=yne_common_data_Catalogues,n=yne_jquery,o=yne_collaboration_collabUtils;return b=null,c.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0,align:!0,"line-height":!0,indent:!0,"text-indent":!0},computeBulbStyles:function(){var a,c=this,e=c.el,f=e.getAttribute("yne-bulb-block");c.bulbBlock=f,f===d.PARAGRAPH?(a=e.style.marginLeft,a=parseInt(a,10),isNaN(a)||(a=Math.ceil(a/j.INDENT_WIDTH),c.styles.indent=(c.styles.indent||0)+a)):f===d.TODO&&(a=e.querySelector("[yne-bulb-todo-content]"))?e.innerHTML=a.innerHTML:("catalogue-wrap"===e.getAttribute("yne-bulb-type")||!b&&f===d.CATALOGUE)&&(b=new m({}))},setup:function(){this.block=null},capture:function(a){var b=this;a&&!0===a.isBr?b.emitBlock(!0):a&&!0===a.isText?b._appendText(a):a&&!0===a.isEmptyPara?b.emitBlock():b.captureBlock(a),b._hasChild=!0},captureBlock:function(a){this.emitBlock(),this.emit(a)},finish:function(){this.emitBlock(),this._hasChild||this.emit({isEmptyPara:!0})},_getBlock:function(){var a=this;return a.block||(a.block=a.createBlock()),a.block},createBlock:function(){var a,c=this,h=c.el;switch(this.bulbBlock){case d.HEADING:return new e({level:h.getAttribute("yne-bulb-level"),id:h.id});case d.CATALOGUE:return a=n(h).find("a").attr("href"),/#\w+$/.test(a)&&(a=a.match(/\w+$/)[0]),new l({id:o.newGUID(),href:a,ownerList:b});case d.TODO:return new g({id:o.newGUID(),checked:"true"===h.getAttribute("yne-bulb-checked")});default:return new f}},_appendText:function(a){var b=this;b.txtList=b.txtList||[],b.txtList.push(a)},emitBlock:function(a){var b,c,e,f=this,g=f.txtList;c=f._getBlock(),g&&(f.options&&f.options.holdSpaces||(g=i(g)),k.each(g,function(a){f.bulbBlock===d.CATALOGUE&&(a.styles.href=""),a.text&&(e=new h({text:a.text}),b=e.getLength(),k.each(a.styles,function(a,c){e.setStyle(0,b,c,a)}),c.append(e))})),(a||c.getLength()>0)&&(c.setBlockStyles(f.styles),f.emit(c)),f.block=null,f.txtList=null}})}(),yne_parser_html_handlers_DocumentHandler=function(a){var b=yne_parser_html_handlers_ParagraphHandler,c=yne_common_data_Block;return b.extend({constructor:function(a){var c=this
;b.call(this,a,null),c.blocks=[]},setup:function(){var a=this;b.prototype.setup.apply(a),a.blocks=[]},emit:function(a){var b=this;a&&a instanceof c&&b.blocks.push(a)},finish:function(){this.emitBlock()},getRoot:function(){return this}})}(),yne_parser_html_handlers_UnknownHandler=function(a){return yne_parser_html_handlers_BaseHandler.extend({_computeStyles:function(){var a=this,b=a.parent;b&&(a.styles=b.styles)},capture:function(a){this.emit(a)}})}(),yne_cssom=function(){var a=window.CSSOM;if(!a&&window.require&&(a=window.require("CSSOM")),!a)throw"no `cssom` library";return a}(),yne_specificity=function(){var a=window.SPECIFICITY;if(!a&&window.require&&(a=window.require("SPECIFICITY")),!a)throw"no `specificity` library";return a}(),yne_parser_html_cssParser_CSSParser=function(a){var b=yne_underscore,c=yne_jtk_core_Class,d=yne_cssom,e=yne_specificity,f=yne_jquery,g=yne_jtk_core_L;return c.extend({_internalStyles:{},constructor:function(){this._internalStyles={}},parse:function(a){var c,e,f,h=this,i={},j={};if(!0===g.DEBUG)c=d.parse(a);else try{c=d.parse(a)}catch(a){return{}}return c.cssRules?(b.each(c.cssRules,function(a){a.selectorText&&a.style&&(j={},e=a.style,b.each(e,function(a){j[a]=e[a]}),-1!==a.selectorText.indexOf(",")?(f=a.selectorText.split(","),b.each(f,function(a){a=a.trim(),i[a]={selectorText:a,style:j}})):(a.selectorText=a.selectorText.trim(),i[a.selectorText]={selectorText:a.selectorText,style:j}))}),h._internalStyles=b.extend(h._internalStyles,i),i):{}},getInternalStyles:function(){return this._internalStyles},getStylesBySpecificity:function(a,c){var d=this,e={},g=d._internalStyles,h=[],i=0;return g?(b.each(g,function(b){try{f(a).is(b.selectorText)&&h.push(b)}catch(a){}}),h.sort(function(a,b){return-1*d._specificityCompare(a.selectorText,b.selectorText)}),b.some(h,function(a){if(a.style&&b.some(a.style,function(a,d){if(i===c.length)return!0;d in e||-1===b.indexOf(c,d)||(e[d]=a,i++)}),i===c.length)return!0}),e):{}},_specificityCompare:function(a,b){return e.compare(a,b)}})}(),yne_parser_html_Parser=function(a){var b,c=yne_underscore,d=yne_jtk_core_Class,e=yne_parser_html_handlers_DocumentHandler,f=yne_parser_html_handlers_UnknownHandler,g=yne_jtk_web_dom_parseHTML,h=yne_parser_html_cssParser_CSSParser;return b=d.extend({_mapper:{},_blackTagList:{},constructor:function(a){var b=this;b._mapper={},b._blackTagList={},c.each(a,function(a,d){!1===a?b._blackTagList[d]=!0:a&&c.isObject(a)&&b.define(d,a)})},parse:function(a,b){var d,f,i,j=this,k=new h,l=/<html[\S\s]*<\/html>/i;return a=a.replace(/<!--[\w\W]*?-->/i,""),l.test(a)&&(a=a.match(l)[0]),d=g(a,document,!0),d?f=new e(d):(d=document.createElement("div"),d.innerHTML=a,f=new e(d)),i=d.getElementsByTagName("style"),i&&c.each(i,function(a){k.parse(a.innerText)}),f.internalStylesParser=k,j._parseRecursively(f,j,b),f.blocks},_shouldBreak:function(a){return!a||!a.style||("none"===a.style.display||"hidden"===a.style.visibility)},_parseRecursively:function(a,b,d){var e,g,h,i,j,k=this,l=a.el;if(!0!==k._shouldBreak(l)){if(a.setup(),!0!==a.handleChildrenBySelf())for(e=l.firstChild;e;)1===e.nodeType?(j=e.tagName.toLowerCase(),k._blackTagList[j]||(h=k._findHandlers(e),h=c.isFunction(h)?h:f,i=new h(e,a,a.internalStylesParser,b,d),k._parseRecursively(i,b,d))):3===e.nodeType&&(g=e.textContent)&&a.capture({text:g,styles:a.styles,isText:!0}),e=e.nextSibling;a.finish()}},define:function(a,c,d){this._mapper[a]={Class:c,priority:d||b.PRIORITY.DEFAULT}},_findHandlers:function(a){var b=[],d=function(a,b){if(a)return a.matches?a.matches(b):a.webkitMatchesSelector?a.webkitMatchesSelector(b):void 0};if(c.each(this._mapper,function(c,e){d(a,e)&&b.push(c)}),0!==b.length)return b.sort(function(a,b){return b.priority-a.priority}),b[0].Class}},{PRIORITY:{HIGH:1,DEFAULT:0,LOW:-1}})}(),yne_parser_html_mathTags=["maction","math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msubsup","msup","mtable","mtd","mtext","mtr","munder","munderover","semantics"],yne_parser_html_svgTags=["a","altGlyph","altGlyphDef","altGlyphItem","animate","animateColor","animateMotion","animateTransform","circle","clipPath","color-profile","cursor","defs","desc","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","font","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignObject","g","glyph","glyphRef","hkern","image","line","linearGradient","marker","mask","metadata","missing-glyph","mpath","path","pattern","polygon","polyline","radialGradient","rect","script","set","stop","style","svg","switch","symbol","text","textPath","title","tref","tspan","use","view","vkern"],yne_parser_html_handlers_AnchorHandler=function(a){var b=yne_parser_html_handlers_BaseHandler;return b.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0},constructor:function(a,c,d){b.call(this,a,c,d)},capture:function(a){var b=this,c=b.el.getAttribute("href");if(!c||"#"===c||0===c.indexOf("javascript"))return void b.emit(a);a&&!0===a.isText?(a.styles.href=a.styles.href||c,b.emit(a)):b.emit(a)}})}(),yne_parser_html_handlers_InlineHandler=function(a){var b=yne_underscore,c=yne_parser_html_handlers_BaseHandler;return c.extend({inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0},inheritBlockStyles:{align:!0,"line-height":!0,indent:!0,"text-indent":!0},_computeInheritStyles:function(){var a=this;c.prototype._computeInheritStyles.apply(a,arguments),a._computeInheritBlockStyles()},_computeInheritBlockStyles:function(){var a,c=this,d=c.parent,e=c.inheritBlockStyles;d&&d.styles&&(a=d.styles,b.each(e,function(b,d){if(!0===b){var e=a[d];e&&(c.styles[d]=e)}}))},capture:function(a){this.emit(a)}})}(),yne_parser_html_handlers_BreakHandler=function(a){var b=yne_parser_html_handlers_InlineHandler;return b.extend({inheritStyleHandlers:!1,inheritBlockStyles:{"line-height":!0,indent:!0,"text-indent":!0},finish:function(){var a=this;a.emit({isBr:!0,styles:a.styles})}})}(),yne_common_data_Hr=function(a){var b,c,d,e=yne_common_data_Block,f=yne_common_data_blockTypes,g=yne_jtk_core_L,h=yne_underscore,i=yne_jquery,j=yne_common_util_unknownTree,k=yne_common_util_blockStyles;return c={_type:f.HR,_styles:null,initialize:function(){var a=this;e.prototype.initialize.apply(a,arguments)},toXml:function(a){var c=this,d=b.__super__.toXml.apply(c,[a]),e=a.createElement("styles");return k.toXml(c,e,a),d.appendChild(e),j.appendToXml(c.unknownTree,d),d},toHtml:function(){var a=this,b=document.createElement("hr"),c=i(b),d=a.getBlockStyles();return c.attr("yne-bulb-block","hr"),h.each(d,function(a,b){c.attr("yne-style-"+b,a)}),c.css("clear","both"),b.outerHTML},toJSON:function(){return b.__super__.toJSON.apply(this)},toPlain:function(){return new Array(81).join("-")},countWords:function(){return 0},toCollabJSON:function(){return this.toJSON()}},d={fromXml:function(a){var c=new b,d=i(a);return c.parseIdFromXml(a),d.children().each(function(a,b){switch(b.nodeName){case e.TAG_ID_NAME:case e.LEGACY_TAG_ID_NAME:break;case"styles":k.fromXml(c,b);break;default:j.appendToTree(c.unknownTree,b)}}),c},fromJSON:function(a){if(!a||a.blockType!==f.HR)return void g.error("invalid jsonObj");var c=new b;return h.each(a.styles,function(a,b){c.setBlockStyle(b,a)}),c},fromCollabJSON:function(a){var b=this.fromJSON(a);return a.blockId&&b.setId(a.blockId),b}},b=e.extend(c,d)}(),yne_parser_html_handlers_HrHandler=function(a){var b=yne_common_data_Hr,c=yne_underscore,d=yne_common_data_supportedBlockStyles,e=yne_common_data_blockTypes;return yne_parser_html_handlers_BaseHandler.extend({computeBulbStyles:function(){var a,b=this,f=b.el;"hr"===f.getAttribute("yne-bulb-block")&&(a=d.getStyleNamesOfBlock(e.HR),c.each(a,function(a){var c=f.getAttribute("yne-style-"+a);c&&(b.styles[a]=c)}))},finish:function(){var a=this,c=new b;a.styles&&c.setBlockStyles(a.styles),a.emit(c)}})}(),yne_common_data_Image=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_blockTypes,i=yne_jtk_core_L,j=yne_jtk_web_dom_parseHTML,k=yne_common_util_unknownTree,l=yne_common_util_blockStyles,m=yne_common_util_parseImgSource,n=yne_common_util_formatLocalSource,o=yne_common_util_platform;return b={_type:h.IMAGE,_source:null,_title:null,_fakeLoading:!1,_imageInfo:null,initialize:function(a){var b=this;g.prototype.initialize.apply(b,arguments),b._source=a.source,b._title=a.title,b._fakeLoading=a.fakeLoading||!1,b._resId=m.parseImgSource(b._source).resId},getHighlight:function(a){if(a&&a.length){var b=this,c=b._title,d=[];return f.each(a,function(a){for(var b=a.getLength(),e=0,f=c.indexOf(a,e);-1!==f;)d[f]={start:f,end:f+b},f=c.indexOf(a,f+b)}),d=f.compact(d),d.length?d:null}},setSource:function(a){var b=this;return!(!a||a===b._source)&&(b._source=a+"",b.trigger("content-change"),!0)},getSource:function(a){var b,c=this,d=c._source;return!0===a&&(b=c.getExtraInfo("pcResMap"))&&b[d]&&(d=b[d]),d},setTitle:function(a){var b=this;return a!==b._title&&(b._title=a+"",b.trigger("content-change"),!0)},getTitle:function(){return this._title},getResId:function(){return this._resId},getStyles:function(a){var b=this;return a?b.getBlockStyle(a):b.getBlockStyles()},setStyles:function(a,b){var c=this;return f.isString(a)?c.setBlockStyle(a,b):f.isObject(a)&&c.setBlockStyles(a),!0},setImageInfo:function(a){var b=this;a&&a.resId&&"number"==typeof a.rawWide?b._imageInfo=a:i.error("The imageInfo is not valid in image: "+b._resId)},getImageInfo:function(){return this._imageInfo},toXml:function(a){var b,c,e,f,g,h,i=this,j=i.getSource(),m=i.getTitle()||"";if(j)return b=d.__super__.toXml.apply(i,[a]),c=a.createElement("source"),e=a.createTextNode(j),c.appendChild(e),b.appendChild(c),f=a.createElement("text"),g=a.createTextNode(m),f.appendChild(g),b.appendChild(f),h=a.createElement("styles"),l.toXml(i,h,a),b.appendChild(h),k.appendToXml(i.unknownTree,b),b},toJSON:function(){var a=this,b=d.__super__.toJSON.apply(a);return b.source=a.getSource(),b.title=a.getTitle(),b},toHtml:function(a,b,c){var d,g,h,i=this,k=j("",document,!0,!0),l=k.ownerDocument,m=i.getStyles(),p=l.createElement("div"),q=e(p),r=e(l.createElement("img"));return q.attr("yne-bulb-block","image"),f.each(m,function(a,b){switch(b){case"align":q.css("text-align",a);break;case"width":null==a?r.css("width",""):r.css("width",a);break;case"float":q.css("float",a)}}),g=i.getSource(!0===c),h=i.getTitle(!0===c),o.IS_PC&&(g=n(g)),r.attr({"data-media-type":"image",src:g,alt:h}),q.append(r),d=p.outerHTML,l=p=q=r=null,d},toPlain:function(){return""},countWords:function(){return 0},setFakeLoading:function(a){this._fakeLoading=a},getFakeLoading:function(){return this._fakeLoading}},c={fromXml:function(a){var b=e(a),c=e.trim(b.find("> source:first").text()),f=e.trim(b.find("> text:first").text()),h=new d({source:c,title:f});return h.parseIdFromXml(a),b.children().each(function(a,b){switch(b.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"source":case"text":break;case"styles":l.fromXml(h,b);break;default:k.appendToTree(h.unknownTree,b)}}),h},fromJSON:function(a){if(!a||!a.blockType||a.blockType!==h.IMAGE||!a.source)return void i.warn("jsonObj or jsonObj.source does NOT exist!");var b=new d({source:a.source,title:a.title});return a.styles&&b.setStyles(a.styles),a.blockId&&b.setId(a.blockId),b}},d=g.extend(b,c)}(),yne_common_data_Attachment=function(a){var b,c,d,e=yne_jquery,f=yne_underscore,g=yne_common_data_Block,h=yne_common_data_blockTypes,i=yne_jtk_core_L,j=yne_jtk_web_dom_parseHTML,k=yne_common_util_unknownTree,l=yne_common_util_blockStyles,m=yne_common_util_formatLocalSource,n=yne_common_util_platform;return b={_type:h.ATTACHMENT,_source:null,_resource:null,_fileName:null,_fileLength:null,_fakeLoading:!1,initialize:function(a){var b=this;g.prototype.initialize.apply(b,arguments),b._source=a.source,b._resource=a.resource,b._fileName=a.fileName,b._fileLength=a.fileLength,b._fakeLoading=!!a._fakeLoading},setSource:function(a){var b=this;return!(!(a=(a||"")+"")||a===b._source)&&(b._source=a,b.trigger("content-change"),!0)},getSource:function(a){var b,c=this,d=c._source;return!0===a&&(b=c.getExtraInfo("pcResMap"))&&b[d]&&(d=b[d]),d},getResource:function(a){var b,c=this,d=c._resource;return!0===a&&(b=c.getExtraInfo("pcResMap"))&&b[d]&&(d=b[d]),d},setResource:function(a){var b=this;return!(!(a=(a||"")+"")||a===b._resource)&&(b._resource=a,b.trigger("content-change"),!0)},getFileName:function(){return this._fileName},setFileName:function(a){var b=this;return!(!(a=String(a||""))||a===b._fileName)&&(b._fileName=a,b.trigger("content-change"),!0)},getFileLength:function(){return this._fileLength},setFileLength:function(a){var b=this;return a=parseInt(a,10),isNaN(a)&&(a=0),!(!a||a===b._fileLength)&&(b._fileLength=a,b.trigger("content-change"),!0)},getStyles:function(a){var b=this;return a?b.getBlockStyle(a):b.getBlockStyles()},setStyles:function(a,b){var c=this;return f.isString(a)?c.setBlockStyle(a,b):f.isObject(a)&&f.each(a,function(a,b){c.setBlockStyle(b,a)}),!0},toXml:function(a){var b,c,e=this,g=e.getSource(),h=["Source","Resource","FileName","FileLength"];if(g)return b=d.__super__.toXml.apply(e,[a]),f.each(h,function(c){var d=a.createElement(c.toLowerCase()),f=e["get"+c](),g=a.createTextNode(f);d.appendChild(g),b.appendChild(d)}),c=a.createElement("styles"),l.toXml(e,c,a),b.appendChild(c),k.appendToXml(e.unknownTree,b),b},toJSON:function(){var a=this,b=d.__super__.toJSON.apply(a);return b.source=a.getSource(),b.resource=a.getResource(),b.fileName=a.getFileName(),b.fileLength=a.getFileLength(),b},toHtml:function(a,b,c){var d,g,h=this,i=h.getStyles(),k=j("",document,!0,!0),l=k.ownerDocument,o=l.createElement("div"),p=e(o),q=e(l.createElement("img"));return p.attr("yne-bulb-block","attachment"),f.each(i,function(a,b){switch(b){case"align":p.css("text-align",a);break;case"float":p.css("float",a)}}),g=h.getSource(!0===c),n.IS_PC&&(g=m(g)),q.attr({"data-media-type":"attachment",src:g,path:h.getResource(),filelength:h._fileLength,title:h._fileName,alt:h._fileName,filename:h._fileName}),p.append(q),d=o.outerHTML,o=p=q=null,d},toPlain:function(){return""},countWords:function(){return 0},setFakeLoading:function(a){this._fakeLoading=a},getFakeLoading:function(){return this._fakeLoading}},c={fromXml:function(a){var b,c="无文件名",f=e(a),h=e.trim(f.find("source").text()),i=e.trim(f.find("resource").text()),j=e.trim(f.find("filename").text())||c,m=e.trim(f.find("filelength").text());return m=parseInt(m,10),isNaN(m)&&(m=0),b=new d({source:h,resource:i,fileName:j,fileLength:m}),b.parseIdFromXml(a),f.children().each(function(a,c){switch(c.nodeName){case g.TAG_ID_NAME:case g.LEGACY_TAG_ID_NAME:case"source":case"resource":case"filename":case"filelength":break;case"styles":l.fromXml(b,c);break;default:k.appendToTree(b.unknownTree,c)}}),b},fromJSON:function(a){if(!(a&&a.blockType&&a.blockType===h.ATTACHMENT&&a.source&&a.resource))return void i.warn("jsonObj or jsonObj.source/resource does NOT exist!");var b=new d({source:a.source,resource:a.resource,fileName:a.fileName,fileLength:a.fileLength});return a.styles&&b.setStyles(a.styles),a.blockId&&b.setId(a.blockId),b}},d=g.extend(b,c)}();var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}();yne_common_data_HandWrite=function(a,b,c,d,e){var f=function(a){function f(){return null!==a&&a.apply(this,arguments)||this}return __extends(f,a),f.prototype.initialize=function(a){var e=this;if(null==a||null==a.source||null==a.resource)throw"props and props.source and props.resource  cannot be null";b.prototype.initialize.apply(e,[a]),e._handWriteProps=c.clone(a),e._type=d.HANDWRITE},f.prototype.getSource=function(a){var b,c=this,d=c._handWriteProps.source;return!0===a&&(b=c.getExtraInfo("pcResMap"))&&b[d]&&(d=b[d]),d},f.prototype.getResource=function(a){var b,c=this,d=c._handWriteProps.resource;return!0===a&&(b=c.getExtraInfo("pcResMap"))&&b[d]&&(d=b[d]),d},f.prototype.setStyles=function(){},f.prototype.toHtml=function(a,b,c){var d=this,f=e("",document,!0,!0),g=f.ownerDocument,h=g.createElement("div"),i=$(h),j=$(g.createElement("img"));return i.attr("yne-bulb-block","handwrite"),j.attr({"data-media-type":"handwrite",src:d.getSource(c),"data-res-handwrite":d._handWriteProps.resource}),i.append(j),h.outerHTML},f.prototype.toJSON=function(){var a=this,c=b.prototype.toJSON.apply(a);return c.source=a.getSource(!1),c.resource=a.getResource(!1),c},f.prototype.toPlain=function(){return""},f.prototype.toXml=function(){throw"HandWrite do NOT support toXml till now"},f}(b),g=function(){function a(){}return a.fromXml=function(a){throw"HandWrite do NOT support fromXml till now"},a.fromJSON=function(a){if(!(a&&a.blockType&&a.blockType===d.HANDWRITE&&a.source&&a.resource))throw"jsonObj or jsonObj.source/resource does NOT exist!";var b=new h({source:a.source,resource:a.resource});return a.blockId&&b.setId(a.blockId),b},a}();delete f.prototype.constructor;var h=b.extend(f.prototype,g);return h}(0,yne_common_data_Block,yne_underscore,yne_common_data_blockTypes,yne_jtk_web_dom_parseHTML),yne_parser_html_handlers_ImageHandler=function(a){var b,c=yne_parser_html_handlers_InlineHandler,d=yne_common_data_Image,e=yne_common_data_Attachment,f=yne_common_data_HandWrite,g=yne_common_data_Todo,h=yne_underscore;return b=c.extend({inheritStyleHandlers:!1,uninheritStyleHandlers:{width:!0,float:!0},inheritBlockStyles:{align:!0},_handleNoteLink:function(){var a,b,c,d=this,e=d.el;a=e.getAttribute("data-attr-noteid"),b=e.getAttribute("alt"),a&&b&&(c=d.parent&&d.parent.styles?h.clone(d.parent.styles):{},c.href="note://"+a,c.color="#003884",c.underline=!0,d.emit({text:b,styles:c,isText:!0}))},_handleNoteTodo:function(){var a=this,b=a.el,c=b.getAttribute("data-res-todo"),d=new g({legacyResId:c});a.emit(d)},finish:function(){var a,c,g,i,j,k=this,l=k.el,m=l.getAttribute("src"),n=function(a,b){h.each(a,function(a,c){var d=b.style[a];d&&(k.styles[c]=d)})};return b.isNoteLink(l)?void k._handleNoteLink():b.isTodo(l)?void k._handleNoteTodo():void(m&&(g=l.parentNode,g&&(i=g.getAttribute("yne-bulb-block")),b.isAttachment(l)?(c=l.getAttribute("path"),a=new e({source:m,resource:c,fileName:b.getAttachmentFileName(l),fileLength:b.getAttachmentFileLength(l)}),"attachment"===i&&n({align:"textAlign",float:"float"},g)):b.isImage(l)?("image"===i&&n({align:"textAlign",width:"width",float:"float"},g),a=new d({source:m,title:b.getImageTitle(l)}),k.styles.width&&k.styles.width>620&&(k.styles.width=620)):b.isHandWrite(l)&&(j=l.getAttribute("data-res-handwrite"),a=new f({source:m,resource:j})),a&&(a.setStyles(k.styles),k.emit(a))))}},{isAttachment:function(a){var b=a.getAttribute("path"),c=a.dataset.mediaType;return b&&("attachment"===c||!c)},isImage:function(a){var b=a.dataset.mediaType,c=a.getAttribute("path"),d=["image"];return!c&&(!b||d.indexOf(b)>-1)},isHandWrite:function(a){return"handwrite"===a.dataset.mediaType},isNoteLink:function(a){return"notelink"===a.dataset.mediaType},isTodo:function(a){return"todo"===a.dataset.mediaType},getAttachmentFileName:function(a){return a.getAttribute("filename")||a.getAttribute("alt")||a.getAttribute("title")||""},getImageTitle:function(a){return a.getAttribute("alt")||""},getAttachmentFileLength:function(a){return a.getAttribute("filelength")||""}})}(),yne_parser_html_handlers_ListHandler=function(a){var b,c=yne_parser_html_handlers_BaseHandler,d=yne_common_data_List,e=yne_common_data_ListItem,f=yne_underscore,g=yne_collaboration_collabUtils;return b=c.extend({list:null,level:null,type:null,_itemCounter:null,prevSimilar:null,inheritStyleHandlers:{bold:!0,italic:!0,underline:!0,strike:!0,"font-family":!0,"font-size":!0,color:!0,"back-color":!0,"white-space":!0,align:!0,"line-height":!0,indent:!0,"text-indent":!0},_parseTypeFromElement:function(){return"ul"===this.el.tagName.toLowerCase()?d.UNORDERED:d.ORDERED},_getStartIndexFromElement:function(){var a=this,b=a.type,c=a.el,e=-1;return b!==d.ORDERED?e:("list"===c.getAttribute("yne-block-type")&&(e=parseInt(c.getAttribute("start"),10),isNaN(e)&&(e=-1)),e)},increaseItemCounter:function(){var a,b=this,c=b.prevSimilar;c&&c.increaseItemCounter?c.increaseItemCounter():(a=b._itemCounter||0,a+=1,b._itemCounter=a)},getItemCounter:function(){var a=this,b=a.prevSimilar;return b?b.getItemCounter():a._itemCounter||0},setup:function(){var a,b,c,e=this,f=e._findParentListHandler();e.list=null,e.level=1,f&&(e.level=f.level+1),c=e._parseTypeFromElement(),e.type=c,b=e._getStartIndexFromElement(),b>1&&(a=e._getPreviousSimilar())&&a.getItemCounter()===b-1&&(e.prevSimilar=a,e.list=a.list),e.list||(e.list=new d({type:c,listId:g.newGUID()}))},capture:function(a){var b=this,c=b.level;a instanceof e&&a.getLevel()<c&&a.setLevel(c),b.emit(a)},_findParentListHandler:function(){for(var a=this.parent;a;){if(a instanceof b)return a;a=a.parent}},_getPreviousSimilar:function(){var a,c=this,d=c.level,e=c.type,g=c.parent,h=g.children;return f.some(h,function(c){if(c instanceof b&&c.level===d&&c.type===e)return a=c,!0}),a}})}(),yne_parser_html_handlers_ListItemHandler=function(a){var b=yne_parser_html_handlers_ParagraphHandler,c=yne_common_data_ListItem,d=yne_parser_html_handlers_ListHandler;return b.extend({setup:function(){var a=this;a.ownerListHandler=a._findOwnerListHandler()},captureBlock:function(a){var b=this,c=null;b.emitBlock(),!b._listed&&a.getType&&"paragraph"===a.getType()?(c=b.createBlock(),c.append(a.getText()),b.emit(c)):b.emit(a)},emit:function(a){var d=this;a instanceof c&&(d._listed=!0),b.prototype.emit.call(d,a)},createBlock:function(){var a,d,e=this,f=e.ownerListHandler;return!e._listed&&f&&f.list?(f.increaseItemCounter(),d=f.list,a=new c({list:d}),d&&d.addItem&&d.addItem(a),a):b.prototype.createBlock.call(e)},_findOwnerListHandler:function(){for(var a=this.parent;a;){if(a instanceof d)return a;a=a.parent}}})}(),yne_parser_html_utils_isWhiteColor=function(a){var b=yne_tinycolor;return function(a){return!!a&&b.equals(a,"white")}}(),yne_parser_html_handlers_TableHandler=function(a){var b=yne_parser_html_handlers_BaseHandler,c=yne_common_data_Table,d=yne_common_data_table_TableCell,e=yne_common_data_table_Lines,f=yne_common_data_table_ImageResource,g=yne_common_data_table_AttachmentResource,h=yne_common_data_table_supportedBlockStyles,i=yne_parser_html_handlers_ImageHandler,j=yne_jtk_core_L,k=yne_jquery,l=yne_underscore,m=yne_parser_html_utils_isWhiteColor,n=yne_parser_html_handlers_styleHandlers,o=yne_common_data_blockTypes,p=function(a,b){var c;if(a&&a.tagName){if((c=(a.tagName+"").toLowerCase())===b+"")return!0;if(l.contains(b,c))return!0}},q=function(a,b,c){if(!a)return c;var d=a.getAttribute(b);return d=parseInt(d||c,10),isNaN(d)&&(d=c),d},r=function(a,b,c){if(!a)return c;var d=a.style[b];return d=parseInt(d||c,10),isNaN(d)&&(d=c),d};return b.extend({DEFAULT_HEIGHT:40,DEFAULT_WIDTH:70,_styleHandlers:{bold:{tagList:["b","strong"],styleHandler:function(a){return n.bold.action(a,{},null)}},lineThrough:{tagList:["strike","s","del"],styleHandler:function(a){return n.strike.action(a,{},null)}},underline:{tagList:["u","ins"],styleHandler:function(a){return n.underline.action(a,{},null)}},italic:{tagList:["i","em","cite","var","address","dfn"],styleHandler:function(a){return n.italic.action(a,{},null)}},fontName:function(a){var b=n["font-family"].action(a,{},null);return b||("FONT"===a.tagName?(b=a.getAttribute("face"))||null:void 0)},fontSize:function(a){var b=n["font-size"].action(a,{},null);if(b)return b+"px"},textColor:function(a){var b=n.color.action(a,{},null);return b||("FONT"===a.tagName?(b=a.getAttribute("color"))||null:void 0)},backColor:function(a){return n["back-color"].action(a,{},null)},textAlign:function(a){return n.align.action(a,{},null)}},_tableStyleHandlers:{verticalAlign:function(a){var b=["THEAD","TBODY","TFOOT"];if(a)return a.style.verticalAlign||a.getAttribute("valign")||(a.tagName&&l.contains(b,a.tagName)?"middle":void 0)},textAlign:function(a){if(a)return a.style&&a.style.textAlign?a.style.textAlign:a.getAttribute("align")},textColor:function(a){return n.color.action(a,{},null)},backColor:function(a){return a.style.backgroundColor||null},bold:function(a){return a&&a.tagName&&"TH"===a.tagName?"true":n.bold.action(a,{},null)?"true":void 0},italic:function(a){if(n.italic.action(a,{},null))return"true"},underline:function(a){if(n.underline.action(a,{},null))return"true"},lineThrough:function(a){if(n.strike.action(a,{},null))return"true"},fontName:function(a){return n["font-family"].action(a,{},null)},fontSize:function(a){var b=n["font-size"].action(a,{},null);if(b)return b+"px"}},constructor:function(a,b,c,d){var e=this;e.el=a,e.parent=b,e.internalStylesParser=c,e._parser=d},handleChildrenBySelf:function(){return!0},_inheritStyles:function(a,b,c){var d=this,e={};return c=c||{},l.each(d._styleHandlers,function(d,f){var g;!1!==a[f]&&(l.isFunction(d)?g=d(b):(d.styleHandler&&(g=d.styleHandler(b)),!g&&d.tagList&&(g=p(b,d.tagList))),g&&"inherit"!==g||(g=c[f]),e[f]=g)}),e},_mergeStyles:function(a,b){var c=this,d=k.trim(a.value),e=d.length;l.each(c._styleHandlers,function(c,d){0===e?b[d]?a[d]=b[d]:a[d]=!1:a[d]&&b[d]!==a[d]&&(a[d]=!1)})},_inheritTableStyles:function(a,b){var c=this,d={},e=["TABLE","THEAD","TBODY","TFOOT","TR","TD","TH"];return l.contains(e,a.tagName+"")?(b=b||{},l.each(c._tableStyleHandlers,function(c,e){var f=c(a);null!=f&&"inherit"!==f||(f=b[e]),null!=f&&(d[e]=f)}),d):{}},_parseImage:function(a,b){var c,d,e=a.getAttribute("src");if(i.isNoteLink(a))return d=a.getAttribute("alt")||"",void(b.value+=d);e&&(i.isAttachment(a)?(c=a.getAttribute("path"),b.value=g.create({source:e,resource:c,fileLength:i.getAttachmentFileLength(a),fileName:i.getAttachmentFileName(a)})):i.isImage(a)&&(b.value=f.create({source:e})))},_shouldAddLineBreak:function(a){a=(a+"").toLowerCase();var b=["article","aside","blockquote","br","button","caption","col","colgroup","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","map","ol","output","p","pre","progress","section","textarea","tfoot","ul","video"];return l.contains(b,a)},_isLinkCell:function(a){if(!a)return!1;var b,c,d,e,f,g,h,i=a.querySelectorAll("a"),j=function(a){return!a||(1===a.nodeType?""===k.trim(a.textContent||""):3!==a.nodeType||""===k.trim(a.nodeValue||""))};if(!i||!i.length||1!==i.length)return!1;for(b=i[0],d=b,c=d.parentNode;c&&c!==a;){for(e=c.childNodes,f=e.length,g=0;g<f;g++)if((h=e[g])!==d&&!j(h))return!1;d=c,c=d.parentNode}return!0},_parseCell:function(a,b,c){var d,h,i,j,k,n=this,p={value:""},r=n.internalStylesParser,s=["font-size","font-family","font-style","font-weight","color","background-color","background","text-decoration","text-align","vertical-align","white-space","word-wrap","word-space"],t=e.createBlank(),u=!1;return k=n._parser.parse(a.innerHTML),l.any(k,o.isTextBlock.bind(o))?l.each(k,function(a){o.isTextBlock(a)?t.appendRichText(a.getText()):(o.isImage(a)||o.isAttachment(a)||o.isTable(a)||o.isHr(a))&&n._blockList.push(a)}):l.each(k,function(a){(o.isTable(a)||o.isHr(a))&&n._blockList.push(a),u?(o.isImage(a)||o.isAttachment(a))&&n._blockList.push(a):o.isImage(a)?(t=f.create({source:a.getSource(),width:a.getStyles("width"),height:a.getStyles("height")}),u=!0):o.isAttachment(a)&&(t=g.create({source:a.getSource(),resource:a.getResource(),fileLength:a.getFileLength(),fileName:a.getFileName()}),u=!0)}),d={value:t},d.value&&p.link&&(d.link=p.link),c===n.DEFAULT_HEIGHT&&(d.wrap="true"),l.each(n._styleHandlers,function(a,b){!0===p[b]?d[b]="true":p[b]&&(d[b]=p[b])}),h=q(a,"colspan",1),h>1&&(d.mergeWidth=h,d.mergeHeight=d.mergeHeight||1),h=q(a,"rowspan",1),h>1&&(d.mergeHeight=h,d.mergeWidth=d.mergeWidth||1),i=n._inheritTableStyles(a,b),l.each(i,function(a,b){null==d[b]&&a&&(d[b]=a)}),j=r.getStylesBySpecificity(a,s),l.each(j,function(b,c){var d=a.style.getPropertyValue(c);null!=d&&""!==d||a.style.setProperty(c,b)}),l.each(n._tableStyleHandlers,function(b,c){var e=b(a);null==d[c]&&null!=e&&(d[c]=e)}),m(d.backColor)&&delete d.backColor,d},_isArrayFull:function(a,b){var c;if(0===b)return!1;for(c=0;c<b;c++)if(null==a[c])return!1;return!0},_parseTbodyCells:function(a,b,c){var d,f=this,g=l.filter(b.children,f._isTableRow),h=[],i=a.widths.length,j=a.heights.length,k=0;return d=f._inheritTableStyles(b,c),l.each(g,function(b){var c=l.filter(b.children,f._isTableCell),g=f._inheritTableStyles(b,d),m=k,n=h[m];if(0!==c.length){for(;n&&f._isArrayFull(n,i);)k++,m++,n=h[m];for(n||(n=h[m]=[]),l.each(c,function(b){for(var c,d,i,k,l,o,p,r,s,t=0,u=n[t];u;)t++,u=n[t];for(c=t,k=f._parseCell(b,g,a.heights[m]),n[c]=k,d=q(b,"rowspan",1),i=q(b,"colspan",1),d>j-m&&(d=j-m,k.mergeHeight=d),l=0;l<d;l++)for(p=m+l,s=h[p],s||(s=h[p]=[]),o=0;o<i;o++)r=c+o,s[r]||(s[r]={mergePointDX:o,mergePointDY:l,value:e.createBlank(!0)})});n.length<i;)n.push({value:""});k++}}),h},_isTableCell:function(a){if(!a||!a.tagName)return!1;var b=a.tagName||"",c=["TD","TH"];return l.contains(c,b)},_isTableRow:function(a){return!(!a||!a.tagName)&&"TR"===a.tagName},_getTbodySize:function(a){var b,c,d,e,f,g,h=this,i=[],j=0,k=0,m=[];for(l.each(a,function(b){var c,d,e=k,f=i[e];if(c=l.filter(b.children,h._isTableCell),0!==c.length){for(;f&&h._isArrayFull(f,j);)e++,f=i[e];k=e,f||(f=i[e]=[],m[e]=a[e]),l.each(c,function(b,c){var g,j,k,l,n,o,p=q(b,"colspan",1),s=q(b,"rowspan",1),t=r(b,"width",0)||q(b,"width",0);for(d+=p,t=Math.max(Math.round(t/p),h.DEFAULT_WIDTH),l=c;null!=f[l];)l++;for(k=0;k<p;k++)n=l+k,f[n]=t;for(g=1;g<s;g++)for(j=e+g,o=i[j],o||(o=i[j]=[],m[j]=a[j]),k=0;k<p;k++)n=l+k,o[n]=t}),d=f.length,j<d&&(j=d)}}),b=i.length,g=[],c=0;c<j;c++){for(e=(i[0]||[])[c]||h.DEFAULT_WIDTH,d=1;d<b;d++)(f=(i[d]||[])[c])&&f>e&&(e=f);g.push(e)}return{rows:b,columns:j,columnWidthList:g,compactTrList:l.compact(m)}},_createBlankRow:function(a){for(var b=[];a>0;)b.push({value:""}),a--;return b},_parseColgroup:function(a){var b=this,c=l.filter(a.children,b._isCol);return l.map(c,function(a){return parseFloat(a.style.width)})},_isCol:function(a){return!(!a||!a.tagName)&&"COL"===a.tagName},_parseTbody:function(a,b,c){var d,e,f,g,h=this,i=l.filter(a.children,h._isTableRow),j=0,k={},m=[],n=0;for(g=h._getTbodySize(i),i=g.compactTrList,k.heights=l.map(i,function(a){if(a.style.height)return parseFloat(a.style.height);var b=l.filter(a.children,h._isTableCell),c=0;return l.some(b,function(a){if(!a.getAttribute("rowspan")){var b=r(a,"height",0)||q(a,"height",0);if(b)return c=b,!0}}),c=Math.max(c,h.DEFAULT_HEIGHT)});k.heights.length<g.rows;)k.heights.push(h.DEFAULT_HEIGHT);if(n=0,l.each(g.columnWidthList,function(a){n+=a}),n<c?(e=Math.ceil((c-n)/g.columns),m=l.map(g.columnWidthList,function(a){return a+e})):m=g.columnWidthList,k.widths=m,d=h._parseTbodyCells(k,a,b),f=d.length,(j=k.heights.length)>f)for(;f<j;)d.push(h._createBlankRow(g.columns)),f++;else if(j<f)for(;j<f;)k.heights.push(h.DEFAULT_HEIGHT),j++;return k.cells=d,k},_extendBodyInfo:function(a,b){var c,d,e,f=a.cells,g=a.heights.length,h=a.widths.length;if(!(h>=b))for(c=0;c<g;c++)for(d=f[c],e=d.length;e<b;e++)d.push({value:""})},_convertToTableCells:function(a,b){var c,f,g,i,k=a.length,m=[];for(c=0;c<k;c++)for(f=a[c],m[c]=[],g=0;g<b;g++)i=f[g],i?m[c].push(d.create({content:i.value||e.createBlank(),mergeWidth:i.mergeWidth,mergeHeight:i.mergeHeight,mergePointDX:i.mergePointDX,
mergePointDY:i.mergePointDY,styles:l.pick(i,h.getAllStyleNames())})):j.error("No tdInfo  at row, col: "+c+", "+g);return m},_mergeTbody:function(a){if(a&&a.length){var b,c=this,d=0,e=[],f=[],g={};return l.each(a,function(a){var c=a.widths.length;c>d&&(d=c,b=a.widths)}),l.each(a,function(a){c._extendBodyInfo(a,d)}),l.each(a,function(a){e=e.concat(a.heights),f=f.concat(a.cells)}),f=c._convertToTableCells(f,d),g.widths=b,g.heights=e,g.cells=f,g}},_parseTable:function(a){var b,c,d=this,e=l.toArray(a.children),f=["thead","tbody","tfoot"],g={thead:[],tbody:[],tfoot:[]},h=[],i=d._blockList.length,j=d._inheritTableStyles(a,{}),k=r(a,"width",0)||q(a,"width",0);d._blockList.push(0),l.each(e,function(a){var b,e=(a.tagName||"").toLowerCase();"colgroup"===e&&(c=d._parseColgroup(a)),l.contains(f,e)&&(b=d._parseTbody(a,j,k),l.extend(b.widths,c),g[e].push(b))}),l.each(f,function(a){var b=g[a];b&&b.length&&(h=h.concat(b))}),(b=d._mergeTbody(h))&&(d._blockList[i]=b)},setup:function(){this._blockList=[]},finish:function(){var a=this;a._parseTable(a.el),l.each(a._blockList,function(b){var d;b&&b.heights&&b.cells&&b.cells.length>0?d=new c({tableCells:b.cells,rowHeights:b.heights,colWidths:b.widths}):b&&(d=b),d&&a.emit(d)})}})}(),yne_parser_html_handlers_TodoHandler=function(a){var b=yne_underscore,c=yne_common_data_Todo;return yne_parser_html_handlers_InlineHandler.extend({finish:function(){var a,d,e=this.el;"todo"===e.getAttribute("data-media-type")&&(a=e.getAttribute("data-attr-content"),d=e.getAttribute("data-attr-checked"),b.isUndefined(a)&&b.isUndefined(d)||this.emit(new c({text:a||"",checked:"true"===d})))}})}(),yne_parser_html_handlers_handlerMap={AnchorHandler:yne_parser_html_handlers_AnchorHandler,BreakHandler:yne_parser_html_handlers_BreakHandler,HrHandler:yne_parser_html_handlers_HrHandler,ImageHandler:yne_parser_html_handlers_ImageHandler,InlineHandler:yne_parser_html_handlers_InlineHandler,ListHandler:yne_parser_html_handlers_ListHandler,ListItemHandler:yne_parser_html_handlers_ListItemHandler,ParagraphHandler:yne_parser_html_handlers_ParagraphHandler,TableHandler:yne_parser_html_handlers_TableHandler,TodoHandler:yne_parser_html_handlers_TodoHandler},yne_parser_html_tagConfig=function(a){var b=yne_underscore,c=yne_parser_html_mathTags,d=yne_parser_html_svgTags,e=!1,f=yne_parser_html_handlers_handlerMap,g={a:f.AnchorHandler,abbr:f.InlineHandler,acronym:f.InlineHandler,address:f.ParagraphHandler,applet:e,area:e,article:f.ParagraphHandler,aside:f.ParagraphHandler,audio:e,b:f.InlineHandler,base:e,basefont:e,bdi:f.InlineHandler,bdo:f.InlineHandler,bgsound:e,big:f.InlineHandler,blink:f.InlineHandler,blockquote:f.ParagraphHandler,body:f.ParagraphHandler,br:f.BreakHandler,button:e,canvas:e,center:f.ParagraphHandler,cite:f.InlineHandler,code:f.InlineHandler,command:e,content:e,data:e,datalist:e,dd:f.ParagraphHandler,del:f.InlineHandler,details:f.ParagraphHandler,dfn:f.InlineHandler,dialog:e,dir:f.InlineHandler,div:f.ParagraphHandler,dl:f.ParagraphHandler,dt:f.ParagraphHandler,element:e,em:f.InlineHandler,embed:e,fieldset:f.ParagraphHandler,figcaption:f.ParagraphHandler,figure:f.ParagraphHandler,font:f.InlineHandler,footer:f.ParagraphHandler,form:f.ParagraphHandler,frame:e,frameset:e,h1:f.ParagraphHandler,h2:f.ParagraphHandler,h3:f.ParagraphHandler,h4:f.ParagraphHandler,h5:f.ParagraphHandler,h6:f.ParagraphHandler,header:f.ParagraphHandler,hgroup:f.ParagraphHandler,hr:f.HrHandler,html:f.ParagraphHandler,i:f.InlineHandler,iframe:e,image:e,img:f.ImageHandler,input:f.TodoHandler,ins:f.InlineHandler,isindex:e,kbd:f.InlineHandler,keygen:e,label:f.InlineHandler,legend:f.ParagraphHandler,li:f.ListItemHandler,link:e,listing:e,main:f.ParagraphHandler,map:e,mark:f.InlineHandler,marquee:f.ParagraphHandler,menu:e,menuitem:e,meta:e,meter:f.InlineHandler,multicol:f.ParagraphHandler,nav:f.ParagraphHandler,nobr:f.InlineHandler,noembed:e,noframes:e,noscript:e,object:e,ol:f.ListHandler,optgroup:e,option:e,output:f.InlineHandler,p:f.ParagraphHandler,param:e,picture:e,plaintext:f.ParagraphHandler,pre:f.ParagraphHandler,progress:e,q:f.InlineHandler,rp:f.InlineHandler,rt:f.InlineHandler,rtc:f.InlineHandler,ruby:f.ParagraphHandler,s:f.InlineHandler,samp:f.InlineHandler,script:e,section:f.ParagraphHandler,select:e,shadow:e,small:f.InlineHandler,source:e,spacer:e,span:f.InlineHandler,strike:f.InlineHandler,strong:f.InlineHandler,style:e,sub:f.InlineHandler,summary:f.ParagraphHandler,sup:f.InlineHandler,table:f.TableHandler,template:e,textarea:f.ParagraphHandler,time:f.InlineHandler,title:e,track:e,tt:f.InlineHandler,u:f.InlineHandler,ul:f.ListHandler,var:f.InlineHandler,video:e,wbr:e,xmp:e},h=function(a,c){a&&a.length&&b.each(a,function(a){null==c[a]&&(c[a]=e)})};return h(c,g),h(d,g),g}(),yne_parser_html_mso_ListHandler=function(a){function b(a,b){var c=a.match(/(@[\w_\-:\s]+)\n\s*\{(.|\n)*?\}/gm);null!==c&&c.forEach(function(a){var c=/@([\w_\-:\s]+)/.exec(a)[1].trim(),d=a.substring(a.indexOf("{")+1,a.indexOf("}")).trim(),e={};d.split(";").forEach(function(a){var b;-1!==a.indexOf(":")&&(b=a.split(":"),e[b[0].trim()]=b[1].trim())}),b[c]||(b[c]={}),g.extend(b[c],e)})}var c=yne_parser_html_handlers_ParagraphHandler,d=yne_common_data_List,e=yne_common_data_ListItem,f=yne_jtk_core_L,g=yne_underscore,h=yne_collaboration_collabUtils;return c.extend({setup:function(){var a,b,e,f,g,i,j,k=this.getRoot();c.prototype.setup.call(this),(a=this.el.getAttribute("style"))&&(b=/mso-list:(l\d+) (level\d+)/.exec(a))&&(g=b[1],i=b[2],e=this._getStyles(),(f=e["list "+g+":"+i])&&(j=k["mso-"+g],j||(j=k["mso-"+g]=new d({type:"bullet"===f["mso-level-number-format"]?d.UNORDERED:d.ORDERED,listId:h.newGUID()})),this.list=j,this.level=Number(i.replace("level","")),this.el.querySelector('[style="mso-list:Ignore"]').remove()))},createBlock:function(){if(!this.list)return c.prototype.createBlock.call(this);var a=this,b=a.list,d=new e({list:b,level:a.level});return b&&b.addItem&&b.addItem(d),d},_getStyles:function(){var a,c=this.getRoot(),d=this.el.ownerDocument,e={};return c.msoStyles?c.msoStyles:(a=d.querySelectorAll("style"),g.each(a,function(a){1===a.childNodes.length&&3===a.firstChild.nodeType&&b(a.firstChild.textContent,e)}),f.log(e),c.msoStyles=e,e)}})}(),yne_parser_html_convert=function(a){var b,c=yne_parser_html_Parser,d=yne_parser_html_tagConfig,e=yne_parser_html_mso_ListHandler;return function(a,f){return b||(b=new c(d),b.define(".MsoListParagraph",e,c.PRIORITY.HIGH)),b.parse(a,f)}}(),yne_common_views_table_cellEdit_Commander=function(a){var b,c=yne_underscore,d=yne_jtk_core_L,e=yne_jtk_core_Class,f=["undo","redo","fontSize"];return b=e.extend({initialize:function(a){var b=this;a=c.defaults(a||{},{editHost:null}),b._commands={},b._editHost=a.editHost,delete b.options},addCmd:function(a){var b=this,c=b._commands;if(a&&a.name&&a.action){if(c[a.name])return void d.warn("command has defined: ",a.name);c[a.name]=a}},addCmds:function(a){var b=this;c.each(a,function(a){b.addCmd(a)})},exec:function(a){var b,c=this;return a&&a.name?(!0===a.stopSelectionChange?c._editHost.silentDocSelectionChangeDo(function(){b=c._exec(a)}):b=c._exec(a),b):(d.warn("Failed to exec cmdBall",a),!1)},_exec:function(a){var b,c,e,g=this,h=g._commands;if(b=a.name,!a.isNative){if((e=h[b])&&e.action)return c=e.action.apply(e,[a.value,g,g._editHost]),a.callback&&a.callback(c),c;if(d.warn("no command",b),!a.tryNativeIfNeeded)return!1;d.warn("try to exec native command",b)}return f.indexOf(b)>-1?(d.error("native command is unvalid",b),!1):(c=g.execNative(b,a.value),a.callback&&a.callback(c),c)},execNative:function(a,b){if(!document.queryCommandSupported(a))return void d.error("command is not supported",a);document.execCommand("styleWithCSS",!1,!0);var c=document.execCommand(a,!1,b||"");return c||d.error("Failed to exec command",a,b),c}},{create:function(a){return new b(a)}})}(),yne_common_views_table_cellEdit_CmdBall=function(a){function b(a){var b=this;b.name=a.name,b.value=a.value,b.isNative=!0===a.isNative,b.tryNativeIfNeeded=!1!==a.tryNativeIfNeeded,b.stopSelectionChange=!0===a.stopSelectionChange,b.callback=c.isFunction(a.callback)?a.callback:null}var c=yne_underscore,d=yne_jtk_core_L;return b.prototype.isCmdBall=!0,b.prototype.clone=function(){return new b(this)},b.create=function(a){return a&&a.isCmdBall?a:a&&a.name?new b(a):void d.warn("Failed to create cmdBall",a)},b}(),yne_common_views_table_cellEditCmds_fontSize=function(a){var b=yne_common_views_table_cellEdit_CmdBall;return{name:"fontSize",action:function(a,c,d){var e,f=d.getNativeRange();return!!f&&(f.collapsed?(d.execCommand(b.create({name:"insertHTML",isNative:!0,value:'<span style="font-size: '+a+'px;"> </span>'})),d.execCommand(b.create({name:"delete",isNative:!0}))):(e=b.create({name:"applyInlineStyle",value:{name:"fontSize",value:a+"px"},isNative:!1}),d.execCommand(e)))}}}(),yne_common_views_table_cellEditCmds_applyInlineStyle=function(a){var b=yne_underscore,c=yne_jtk_web_dom_nodeType,d=yne_jtk_core_L,e=function(a,b){if(a&&a.tagName)return(a.tagName+"").toLowerCase()===(b+"").toLowerCase()},f=function(a,b){for(var c=b.parentNode;null!==c;){if(c===a)return!0;c=c.parentNode}return!1},g=function(a,b,c){if(c===a)return null;if(a.firstChild&&!b)return a.firstChild;if(!a.parentNode)return null;for(var d=a.nextSibling||g(a.parentNode,!0,c);f(d,c);)d=d.firstChild;return d},h=function(a){var b=a.startContainer,c=a.endContainer,d=a.startOffset,e=a.endOffset;return b===c&&d===e},i=function(a){var b,d=a.startContainer,e=a.endContainer,f=a.startOffset,g=a.endOffset;c.isText(e)&&g!==e.length&&e.splitText(g),c.isText(d)&&0!==f&&(b=d.splitText(f),d===e&&(e=b,g=b.length),d=b,f=0),a.setStart(d,f),a.setEnd(e,g)},j=function(a,b,d){var e,f=a.startContainer,h=a.startOffset,i=a.endContainer,j=a.endOffset;for(c.isElement(f)&&0!==h&&(e=f.childNodes[h],f=e||f.nextSibling,h=0),c.isElement(i)&&j!==i.length&&(0===j?i=i.previousSibling:(e=i.childNodes[j-1],i=e||i.previousSibling),j=i.length),e=f;e;e=g(e,b,i))d(e)},k=function(a){if(a.parentNode){var c=b.toArray(a.childNodes),d=a.parentNode;e(a,"span")&&0===a.attributes.length&&(b.each(c,function(b){a.removeChild(b),d.insertBefore(b,a)}),d.removeChild(a)),b.each(c,function(a){k(a)})}},l=function(a,b){j(a,!1,function(a){c.isElement(a)&&(a.style[b]="")}),k(a.commonAncestorContainer)},m=function(a){return{startNode:a.startContainer,endNode:a.endContainer,startOffset:a.startOffset,endOffset:a.endOffset}},n=function(a,b){a.setStart(b.startNode,b.startOffset),a.setEnd(b.endNode,b.endOffset)},o=function(a,b,d){var e;i(a),e=m(a),l(a,b),j(a,!0,function(e){var f,g;c.isElement(e)?e.style[b]=d:c.isText(e)&&!/^\s*$/.test(e.data)&&(f=a.startContainer.ownerDocument,g=f.createElement("span"),g.style[b]=d,e.parentNode.insertBefore(g,e),e.parentNode.removeChild(e),g.appendChild(e))}),n(a,e)};return{name:"applyInlineStyle",action:function(a,b,c){var e=a.name,f=a.value,g=c.getNativeRange();return g&&!h(g)?(o(g,e,f),c.setNativeRange(g),!0):(d.warn("Failed to execute applyInlineStyle",g),!1)}}}(),yne_common_views_table_cellEditCmds_styleCmdMap=function(a){var b=yne_underscore,c={bold:"bold",italic:"italic",strike:"strikeThrough",underline:"underline"};return{TOGGLE_INLINE_STYLES_CMD_MAP:c,INLINE_STYLES_CMD_MAP:b.extend({"back-color":"backColor",color:"foreColor","font-family":"fontName","font-size":"fontSize"},c)}}(),yne_common_views_table_cellEditCmds_applyInlineStyles=function(a){var b=yne_underscore,c=yne_common_views_table_cellEdit_CmdBall,d=yne_common_views_table_cellEditCmds_styleCmdMap;return{name:"applyInlineStyles",action:function(a,e,f){var g=!1;return b.map(d.INLINE_STYLES_CMD_MAP,function(d,e){if(b.has(a,e)){if(null==a[e])return;f.execCommand(c.create({name:d,value:a[e],stopSelectionChange:"fontSize"===d})),g=!0}}),g}}}(),yne_common_commands_utils_href=function(a){var b=yne_jtk_core_L;return{_getHref:function(a,b){var c;if(!(b<0||b>=a.getLength()))return c=a.getTextStylesAtIndex(b)||{},c.href},_hasHref:function(a,b,c){var d=this,e=d._getHref(a,b);return c?e===c:e&&e.length>0},isAtHrefBorder:function(a,b,c){var d=this,e=c?b-1:b,f=d._getHref(a,e),g=d._getHref(a,c?e+1:e-1);return f&&f.length>0&&f!==g},findHrefBorder:function(a,c,d){if(!a||!a.getText)return b.error("param is not valid!"),-1;var e,f,g,h=this,i=-1,j=a.getText(),k=j.getLength();if(c>k)return-1;if(d){if(e=c-1,!(g=h._getHref(a,e)))return-1;for(f=e-1;f>=-1;f--)if(!h._hasHref(a,f,g)){i=f+1;break}}else{if(e=c,!(g=h._getHref(a,e)))return-1;for(f=e+1;f<=k;f++)if(!h._hasHref(a,f,g)){i=f-1;break}}return i},completeUrl:function(a){var b=/\:\/\//;return!a||b.exec(a)?a:"http://"+a}}}(),yne_common_views_table_cellEditCmds_insertLink=function(a){var b=yne_common_views_table_cellEdit_CmdBall,c=yne_common_commands_utils_href,d=yne_common_util_xssFilter;return{name:"insertLink",action:function(a,e,f){return!!(a=d.safeHref(a))&&(f.execCommand(b.create({name:"underline",value:!0})),f.execCommand(b.create({name:"createLink",value:c.completeUrl(a||"")})),!0)}}}(),yne_common_views_table_cellEditCmds_undo={name:"undo",action:function(a,b,c){return c.undo()}},yne_common_views_table_cellEditCmds_redo={name:"redo",action:function(a,b,c){return c.redo()}},yne_common_views_table_cellEdit_createCommander=function(a){var b=yne_common_views_table_cellEdit_Commander,c=yne_common_views_table_cellEditCmds_fontSize,d=yne_common_views_table_cellEditCmds_applyInlineStyle,e=yne_common_views_table_cellEditCmds_applyInlineStyles,f=yne_common_views_table_cellEditCmds_insertLink,g=yne_common_views_table_cellEditCmds_undo,h=yne_common_views_table_cellEditCmds_redo,i=[d,e,c,f,g,h];return function(a){var c=b.create(a);return c.addCmds(i),c}}(),yne_common_views_table_cellEdit_toolbarAdapter=function(a){var b=yne_common_views_table_cellEdit_CmdBall,c=yne_common_fontMaps,d=yne_underscore,e=yne_jtk_core_L,f=yne_common_views_table_cellEditCmds_styleCmdMap;return{TOGGLE_INLINE_STYLES_CMD_MAP:f.TOGGLE_INLINE_STYLES_CMD_MAP,INLINE_STYLES_CMD_MAP:f.INLINE_STYLES_CMD_MAP,getStyleNameByCmdName:function(a){var b,c=this;return d.some(c.INLINE_STYLES_CMD_MAP,function(c,d){if(c===a)return b=d,!0}),b},getCmdNameByStyleName:function(a){if(a)return this.INLINE_STYLES_CMD_MAP[a]},_createInlineStyleCmdBall:function(a){a=a||{};var e,f=this;return d.some(f.INLINE_STYLES_CMD_MAP,function(f,g){if(d.has(a,g))return"font-family"===g&&(a[g]=c.getAllValueByFont(a[g])||a[g]),e=b.create({name:f,value:a[g],stopSelectionChange:"fontSize"===f}),!0}),e},_createFormatPainterCmdBall:function(a,c){return d.map(c,function(b,d){a[d]===c[d]&&delete a[d]}),b.create({name:"applyInlineStyles",value:a})},createCmdBall:function(a,c,d){var f,g=this;switch(c=c||{},a){case"comp.RemoveFormat":f=b.create({name:"removeFormat"});break;case"comp.FormatPainter":if(!c.data||!c.data.inlineStyles)return;f=g._createFormatPainterCmdBall(c.data.inlineStyles,d);break;case"comp.ApplyStyles":c.inlineStyles&&(f=g._createInlineStyleCmdBall(c.inlineStyles));break;case"comp.InsertLink":if(!c.src)return;f=b.create({name:"insertLink",value:c.src});break;case"undo":f=b.create({name:"undo",isNative:!1,tryNativeIfNeeded:!1});break;case"redo":f=b.create({name:"redo",isNative:!1,tryNativeIfNeeded:!1})}return f?e.log("toolbarAdapter handles name/args/ball",a,c,f):e.warn("toolbarAdapter do NOT handle: ",a,c),f}}}(),yne_common_views_table_cellEdit_cellLink=function(a){var b=yne_jquery,c=yne_common_commands_link_LinkMatch,d=yne_common_selection_nativeSelection,e=yne_jtk_web_dom_nodeType;return{_container:null,getUrlInfoBeforeRange:function(a,b){var c,f,g=this,h=a.commonAncestorContainer,i={textNodeArray:[],endIndex:-1};if(d.isRangeInNode(b,a))return g._container=b,g._isInLinkElement(h)?f={alreadyUrl:!0}:(e.isElement(h)?(c=g._findLastTextNode(h))&&(i.endIndex=c.length):i.endIndex=a.endOffset,f=g._iteratorOfTextNodeBefore(i,h),g._container=null,f)},_iteratorOfTextNodeBefore:function(a,b){var c,d=this;if(e.isText(b))c=b;else{if(!e.isElement(b))return;c=d._findLastTextNode(b)}if(c)return a.textNodeArray.unshift(c),d._parseTextNodeObject(a)||d._iteratorOfTextNodeBefore(a,d._findPreviousNode(c))},_findPreviousNode:function(a){var b=this,c=a.previousSibling;return c?b._isUnvalidElement(c)?null:c:(a=a.parentNode,a?b._findPreviousNode(a):null)},_findLastTextNode:function(a){var b,c,d,f=this;if(a){if(e.isText(a))return a;if(0===(d=a.childNodes.length))return a=f._findPreviousNode(a),f._findLastTextNode(a);for(c=d-1;c>=0;c--)return b=a.childNodes[c],f._findLastTextNode(b)}return null},_parseTextNodeObject:function(a){var b,d,e,f,g,h="",i=a.textNodeArray[0].nodeValue,j=0,k="",l=a.endIndex,m=a.textNodeArray,n=a.textNodeArray.length;for(f=0;f<n-1;f++)k+=m[f].nodeValue;if(k+=m[n-1].nodeValue.slice(0,l),(b=c.matchEnd(k))&&b.result){for(e=b.result.index,g=0;g<n-1;g++){if(e-=h.length,h.length<=e&&i.length>e){j=g;break}h+=m[g].nodeValue,i+=m[g+1].nodeValue}d={uri:b.fullURI,startNode:m[j],startOffset:e,endNode:m[n-1],endOffset:l}}return d},_isUnvalidElement:function(a){var c,d,f=this;return!e.isText(a)&&(!e.isElement(a)||!b.contains(f._container,a)||(c=a.currentStyle||window.getComputedStyle(a,""),d="A"===a.nodeName,"block"===c.display||d))},_isInLinkElement:function(a){var c=this;if(b.contains(c._container,a)){for(;a&&a!==c._container;){if("A"===a.nodeName)return!0;a=a.parentNode}return!1}}}}(),yne_common_views_table_cellEdit_jsonRange=function(a){var b=yne_underscore,c=yne_jtk_web_dom_nodeType,d=yne_jtk_core_L;return{jsonlify:function(a,e){if(a&&e){var f=function(d){var e,f={};return c.isText(d)?(e=d.parentNode,f.childIndex=b.indexOf(e.childNodes,d)):e=d,f.isRoot=e===a,f.isRoot?f:(f.tagName=e.tagName,f.tagIndex=b.indexOf(a.querySelectorAll(f.tagName),e),f)},g={collapsed:e.collapsed,startContainer:f(e.startContainer),startOffset:e.startOffset};return d.log(g),g.collapsed?g:(g.endContainer=f(e.endContainer),g.endOffset=e.endOffset,g)}},parseJSON:function(a,b){if(a&&b){var c,d=function(b){var c,d;return b.isRoot?null!=b.childIndex?a.childNodes[b.childIndex]:a:(d=a.querySelectorAll(b.tagName),c=d[b.tagIndex],null!=b.childIndex?c.childNodes[b.childIndex]:c)},e=a.ownerDocument,f=e.createRange(),g=d(b.startContainer);return f.setStart(g,b.startOffset),b.collapsed?f.setEnd(g,b.startOffset):(c=d(b.endContainer),f.setEnd(c,b.endOffset)),f}}}}(),yne_common_views_table_cellEdit_History=function(a){var b,c=yne_jtk_core_Base,d=yne_jtk_core_L;return b=c.extend({initialize:function(){var a=this;delete a.options,a.reset()},reset:function(){var a=this;a._undo=[],a._redo=[],a.trigger("change")},save:function(a){if(!a||!a.snapshotBefore||!a.snapshotAfter)return d.warn("parameter is unvalid",a),!1;var b=this;return b._undo.push(a),b._redo=[],b.trigger("change"),d.log("history save operation",b._undo.length,a),!0},canUndo:function(){return this._undo.length>0},canRedo:function(){return this._redo.length>0},undo:function(a){var b,c=this;for(a=a||1,d.log("history undo",a);a&&a>0&&c.canUndo();)b=c._undo.pop(),c._redo.push(b),a--;return!!b&&(d.log("history undo",b.snapshotBefore),c.trigger("undo",b.snapshotBefore),c.trigger("change"),!0)},redo:function(a){var b,c=this;for(a=a||1,d.log("history redo",a);a&&a>0&&c.canRedo();)b=c._redo.pop(),c._undo.push(b),a--;return!!b&&(d.log("history redo",b.snapshotAfter),c.trigger("redo",b.snapshotAfter),c.trigger("change"),!0)}},{create:function(a){return new b(a)}})}(),yne_common_views_table_cellEditKey_enter=function(a){yne_common_key_KeyHandlerManager.register({name:"enter",scope:"table-cell-edit",key:"enter",action:function(a){a.blur()}})}(),yne_common_views_table_cellEditKey_altEnter=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_views_table_cellEdit_CmdBall,d=yne_common_views_table_cellEdit_cellLink,e=function(a){var b,e,f=a.getNativeRange(),g=a.getEditBox();b=d.getUrlInfoBeforeRange(f,g),b?(b.alreadyUrl||(f=document.createRange(),f.setStart(b.startNode,b.startOffset),f.setEnd(b.endNode,b.endOffset),a.setNativeRange(f),e=c.create({name:"insertLink",value:b.uri}),a.execCommand(e),f=a.getNativeRange(),f.collapse(!1),a.setNativeRange(f)),e=c.create({name:"insertHTML",value:"<div><br/></div>",isNative:!0})):e=c.create({name:"insertLineBreak",isNative:!0}),a.execCommand(e)};b.register({name:"altEnter",scope:"table-cell-edit",key:"alt+enter",action:e}),b.register({name:"shiftEnter",scope:"table-cell-edit",key:"shift+enter",action:e})}(),yne_common_views_table_cellEditKey_esc=function(a){yne_common_key_KeyHandlerManager.register({name:"esc",scope:"table-cell-edit",key:"esc",action:function(a){a.exit()}})}(),yne_common_views_table_cellEditKey_editInlineStyle=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_underscore,d={"mod+b":"bold","mod+i":"italic","mod+e":"strike","mod+u":"underline"};c.each(d,function(a,c){b.register({name:a,scope:"table-cell-edit",key:c,action:function(b){b.toggleInlineStyle(a)}})})}(),yne_common_views_table_cellEditKey_undo=function(a){var b=yne_common_views_table_cellEdit_CmdBall;yne_common_key_KeyHandlerManager.register({name:"modZ",scope:"table-cell-edit",key:"mod+z",action:function(a){var c=b.create({name:"undo",isNative:!1,tryNativeIfNeeded:!1});a.execCommand(c)}})}(),yne_common_views_table_cellEditKey_redo=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_views_table_cellEdit_CmdBall,d=function(a){var b=c.create({name:"redo",isNative:!1,tryNativeIfNeeded:!1});a.execCommand(b)};b.register({name:"modShiftZ",scope:"table-cell-edit",key:"mod+shift+z",action:d}),b.register({name:"modY",scope:"table-cell-edit",key:"mod+y",action:d})}(),yne_common_views_table_cellEditKey_save=function(a){yne_common_key_KeyHandlerManager.register({name:"save",scope:"table-cell-edit",key:"mod+s",action:function(){}})}(),yne_common_views_table_cellEditKey_keyConfig=void 0,yne_common_views_table_CellEditView=function(a){var b,c=yne_backbone,d=yne_jquery,e=yne_jtk_core_L,f=yne_underscore,g=yne_jtk_web_dom_parseHTML,h=yne_common_key_KeyMonitor,i=yne_common_util_events,j=yne_common_key_KeyHandlerManager,k=yne_common_views_table_ChangeMonitor,l=yne_common_data_table_tableCellType,m=yne_parser_html_convert,n=yne_common_data_RichText,o=yne_common_data_table_Lines,p=yne_jtk_web_dom_nodeType,q=yne_common_views_table_cellEdit_createCommander,r=yne_common_selection_nativeSelection,s=yne_common_views_table_cellEdit_CmdBall,t=yne_parser_html_tagConfig,u=yne_common_fontMaps,v=yne_tinycolor,w=yne_common_jst,x=yne_common_views_table_cellEdit_toolbarAdapter,y=yne_common_views_table_cellEdit_cellLink,z=yne_common_views_table_cellEdit_jsonRange,A=yne_common_views_table_cellEdit_History,B=yne_parser_html_handlers_styleHandlers,C=yne_common_data_table_TableCell,D=3,E=3,F="div",G="cell-edit";return b=c.View.extend({tagName:F,className:G,_editBox:null,_changeMonitor:null,_isDirty:!1,_editingCellId:null,_rangeWhenBlur:null,_editingInlineStates:null,events:{contextmenu:"_onPreventAndStop",mousedown:"_onStopPropagation",copy:"_onStopPropagation",cut:"_onStopPropagation",paste:"_onPaste",dblclick:"_onDblclick"},_onPreventAndStop:function(a){a.preventDefault(),a.stopPropagation()},_onStopPropagation:function(a){a.stopPropagation()},initialize:function(a){var b=this;b._table=a.table,b._tableView=a.tableView,b._styleRules=a.styleRules,b._mapper=a.mapper,b._isRendered=!1,b._commander=q({editHost:b}),b._uid=f.unique("cell-edit-view-"),b._eventNS="."+b._uid,delete b.options},render:function(){var a=this,b=w.render("common","table_cell_edit",{}),c=a.el;!0!==a._isRendered&&(a._isRendered=!0,c.innerHTML=b,a._editBox=c.querySelector(".cell-edit-box"),a._initEvents())},_initEvents:function(){var a=this,b=a._editBox;i.addListeners({focus:"_onFocus",blur:"_onBlur",textInput:"_onTextInput",compositionstart:"_onCompositionStart",compositionend:"_onCompositionEnd",click:"_onClick"},d(b),a),a._initKeyHandlerManager(),a._changeMonitor=k.create({el:b}),i.addListeners({"content-change":"_onContentChange"},a._changeMonitor,a),a._history=A.create(),i.addListeners({undo:"_onHistoryUndo",redo:"_onHistoryRedo",change:"_onHistoryChange"},a._history,a)},_bindKey:function(a){var b=this,c=b._keyMonitor;a&&(c||(b._keyMonitor=c=new h({el:b._editBox,beforeMatch:function(a){a.stopPropagation()}})),c.unbind(a),c.bind(a,function(c){b._keyHandlerManager&&b._keyHandlerManager.execWithKey(a,b,c)}))},_unbindKey:function(a){var b=this,c=b._keyMonitor;c&&a&&c.unbind(a)},_initKeyHandlerManager:function(){var a=this,b=new j({scope:"table-cell-edit"}),c=b.getAvailableHandlerNames();b.on("bind-key",a._bindKey.bind(a)),b.on("unbind-key",a._unbindKey.bind(a)),f.each(c,function(a){b.bind(a)}),a._keyHandlerManager=b},blur:function(){this._editBox.blur()},_onBlur:function(){var a=this;if(a._isOnToolbarLinkView())return void(a._rangeWhenBlur=a.getNativeRange());this.trigger("blur"),this._commitChange()},_onFocus:function(){e.log("on focus")},_recognizeLink:function(a){var b,c,d=this,e=d.getNativeRange(),f=d.getEditBox(),g=y.getUrlInfoBeforeRange(e,f)||{},h=d._compositionStartUriInfo||{};if(h.alreadyUrl||g.alreadyUrl)return a.preventDefault(),c=document.createElement("div"),c.innerHTML=a.data,b=s.create({name:"insertHTML",value:"<span></span>"+c.innerText,isNative:!0}),void d.execCommand(b);g.startNode&&(" "!==a.data||g.alreadyUrl||(a.preventDefault(),e=document.createRange(),e.setStart(g.startNode,g.startOffset),e.setEnd(g.endNode,g.endOffset),d.setNativeRange(e),b=s.create({name:"insertLink",value:g.uri}),d.execCommand(b),e=d.getNativeRange(),e.collapse(!1),d.setNativeRange(e),b=s.create({name:"insertHTML",value:" ",isNative:!0}),d.execCommand(b)))},_onTextInput:function(a){var b=this,c=a.originalEvent||a;c.stopPropagation(),e.log("text",c.data),b._recognizeLink(c)},_onCompositionStart:function(a){var b=this,c=b.getNativeRange(),d=b.getEditBox();a.stopPropagation(),e.log("composition start"),this._isOnComposition=!0,this._compositionStartUriInfo=y.getUrlInfoBeforeRange(c,d)},_onCompositionEnd:function(a){a.stopPropagation(),e.log("composition end"),this._isOnComposition=!1,this._compositionStartUriInfo=null},_onClick:function(a){a.stopPropagation()},_onContentChange:function(){var a=this;a._isDirty=!0,a._handleChangeWithDebounce()},_snapshot:function(){var a,b=this,c=b._editBox,d=b.getNativeRange();return d?(a=z.jsonlify(c,d),{html:c.innerHTML,jsonRange:a}):void e.warn("Failed to create snapshot",d)},_saveHistory:function(){var a=this,b=a._lastSnapshot||a._baseSnapshot,c=a._snapshot();a._history.save({snapshotBefore:b,snapshotAfter:c}),a._lastSnapshot=c},_clearTimeoutOfHandleChange:function(){var a=this;a._timeoutOfHandleChange&&(window.clearTimeout(a._timeoutOfHandleChange),a._timeoutOfHandleChange=null)},_handleChangeWithDebounce:function(){var a=this;a._clearTimeoutOfHandleChange(),a._timeoutOfHandleChange=window.setTimeout(function(){if(a._isOnComposition)return!1;a._saveHistory()},500)},_silentDo:function(a){var b=this;b._changeMonitor&&!1===b._changeMonitor.isMonitoring()?a():(b._changeMonitor.disconnect(),a(),b._changeMonitor.observe())},silentDocSelectionChangeDo:function(a){var b=this;b._stopListenerDocSelectionChange?a():(b._stopListenerDocSelectionChange=!0,a(),window.clearTimeout(b._timeoutForStopListenerDocSelectionChange),b._timeoutForStopListenerDocSelectionChange=window.setTimeout(function(){b._stopListenerDocSelectionChange=!1},0))},undo:function(){var a=this,b=a._history;return a._clearTimeoutOfHandleChange(),!!b&&b.undo()},redo:function(){var a=this,b=a._history;return a._clearTimeoutOfHandleChange(),!!b&&b.redo()},_restoreSnapshot:function(a){if(a){var b=this;b._clearTimeoutOfHandleChange(),b._silentDo(function(){var c;b._editBox.innerHTML=a.html,c=z.parseJSON(b._editBox,a.jsonRange),b.setNativeRange(c)})}},_onHistoryUndo:function(a){this._restoreSnapshot(a)},_onHistoryRedo:function(a){this._restoreSnapshot(a)},_onHistoryChange:function(){var a=this,b=a._history;a.trigger("cell-edit-view-history-change",{canUndo:b.canUndo(),canRedo:b.canRedo()})},_handleContentWhenShowAndEdit:function(a,b){var c,d,e=!1;return null!=a?a instanceof o||(c=a instanceof n?a:n.create(a+""),d=o.create({richText:c}),e=!d.isEmpty()):b.getType()===l.TEXT&&(d=b.getContent(),d.isEmpty()&&(d=null)),{lines:d,isDirty:e}},showAndEdit:function(a){if(!a||null==a.row||null==a.col)return void e.warn("Failed to show cell edit view, parameter is not valid",a);var b,c,g,h,i=this,j=i._table.getCell(a.row,a.col),k=d(i._editBox),l={};j&&(i._changeMonitor.disconnect(),i._editingCellId=j.getCellId(),(b=i._tableView.getBoundingRectAt(a.row,a.col))&&(c=i._handleContentWhenShowAndEdit(a.content,j),g=c.lines,g||(g=o.createBlank(!0),h=!0),i._isDirty=c.isDirty,k.css({left:b.left,top:b.top,minWidth:b.width-D,minHeight:b.height-E}),i._renderLines(g),i.$el.show(),i._focusEditBox(!0),h&&(f.each(j.getStylesForEmpty(),function(a,b){var c,d={};if(d[b]=a,c=x.createCmdBall("comp.ApplyStyles",{inlineStyles:d}),e.log("stylesForEmpty to cmdBall",b,a,c),!c)return!1;l[c.name]=c}),l.fontSize&&(i.execCommand(l.fontSize),delete l.fontSize),f.each(l,function(a){i.execCommand(a)})),i._changeMonitor.observe(),i._addListenerForDocSelectionChange(),i._baseSnapshot=i._snapshot(),i.trigger("cell-edit-view-enter",{canUndo:i._history.canUndo(),canRedo:i._history.canRedo()})))},_onSelectionChange:function(){var a=this,b=a.getNativeRange();a._clearEditingInlineStates(),a.trigger("cell-edit-view-selection-change",b)},_addListenerForDocSelectionChange:function(){var a=this;d(document).on("selectionchange"+a._eventNS,function(b){return a.getNativeRange()?a._stopListenerDocSelectionChange?void e.log("selection change NOT listener"):void a._onSelectionChange(b):void e.log("native range is not in cell edit view")})},_removeListenerForDocSelectionChange:function(){d(document).off("selectionchange"+this._eventNS)},_renderLines:function(a){var b=this,c=a.toHtml({styleRules:b._styleRules}),e=b._editBox;d(e).html(c)},_focusEditBox:function(a){var b,c,d=this,e=d._editBox;if(a){var f=r.getRange(),g=e.querySelector(".table-cell-line");if(!g||!f)return;b=g.lastChild,c=b||g,f.setStart(c,c.childNodes.length),f.setEnd(c,c.childNodes.length),r.setRange(f)}e.focus()},hide:function(){this.$el.hide()},_filterToLinesHtml:function(){var a=this,b=a._editBox,c=function(a){f.each(a,function(a){var b=a.style.textDecorationLine;b&&(a.style.textDecoration=b),a.hasChildNodes()&&c(a.children)})};c(b.children)},_getContentAsLines:function(){var a,b,c=this,d=o.createBlank();return c._viewStyleToData(),c._filterToLinesHtml(),a=c._editBox.innerHTML,b=m(a,{holdSpaces:!0})||[],f.each(b,function(a){var b=C.blockToCellContent(a);b instanceof o&&d.appendLines(b)}),d},_viewStyleToData:function(){var a=this,b=a._editBox,c=a._styleRules,d=a._mapper;f.map(c,function(c,e){var g,h,i;if(g=b.querySelectorAll("font"),"font-family"===e)return void f.forEach(g,function(a){h=a.getAttribute("face"),(h=u.getFontFirstValue(h))&&(i=d.valueFromView(e,h))&&a.setAttribute("face",i)});a._elsViewStyleToData(g,d,e),a._elsViewStyleToData(b.querySelectorAll("span"),d,e)})},_elsViewStyleToData:function(a,b,c){var d,e,g=!1;f.forEach(a,function(a){d=a.getAttribute(c),d?g=!0:d=a.style[c],d&&("color"===c&&(d=v(d).toHexString()),(e=b.valueFromView(c,d))&&(g?a.setAttribute(c,e):a.style[c]=e))})},_commitChange:function(){var a,b=this;e.log("commit change"),b._isDirty&&(a=b._getContentAsLines(),b.trigger("set-cell-content",b._editingCellId,a)),b.exit()},_isOnToolbarLinkView:function(){return d(".combo-menu-link .link-input").is(":visible")},isFocused:function(){var a=this,b=document.activeElement;return b===a.el||d.contains(a.el,b)},_isShow:function(){return this.$el.is(":visible")},isOnEdit:function(){var a=this;return!!a.isFocused()||a._isOnToolbarLinkView()&&a._isShow()},getNativeRange:function(){var a=this,b=r.getRange();if(r.isRangeInNode(a._editBox,b))return b;e.warn("native range is null or not in cell edit view",b)},setNativeRange:function(a){var b=this;r.isRangeInNode(b._editBox,a)?r.setRange(a):e.warn("Failed to set native range to cell edit view",a)},_formatStyles:function(a){return a},_queryStyles:function(a){var b,c,d=this,e=d.getNativeRange();if(e)return b=e.startContainer,p.isText(b)&&(b=b.parentNode),
c=window.getComputedStyle(b,null),c=d._formatStyles(c),a?c[a]:c},_queryInlineStylesForBulb:function(){var a=this,b=a._queryStyles(),c={},d={style:b},e=f.keys(x.INLINE_STYLES_CMD_MAP);return f.forEach(e,function(a){c[a]=B[a].action(d)}),c},queryInlineStylesForBulb:function(){var a,b,c,d=this,e=d.getNativeRange();if(e)return a=d._queryInlineStylesForBulb(),e.collapsed&&d._editingInlineStates?(b=f.clone(d._editingInlineStates),f.defaults(b,a),c=b):c=a,c.cellEditViewRangeCollapsed=e.collapsed,c},toggleInlineStyle:function(a){var b,c,d=this;if(-1===f.keys(x.TOGGLE_INLINE_STYLES_CMD_MAP).indexOf(a))return void e.warn("toggleInlineStyle does NOT supprot",a);c=x.getCmdNameByStyleName(a),b=s.create({name:c,tryNativeIfNeeded:!0}),d.execCommand(b)},_shouldModifyEditingInlineStates:function(a,b,c){return!!(a&&a.name&&b&&b.collapsed&&1===c)&&f.values(x.INLINE_STYLES_CMD_MAP).indexOf(a.name)>-1},_grabEditingInlineStates:function(a){if(a&&a.name){var b,c=this;c._editingInlineStates||(b=c._queryInlineStylesForBulb(),c._editingInlineStates=b)}},_updateEditingInlineStates:function(a){if(a&&a.name){var b=this,c=a.name,d=a.value,e=x.getStyleNameByCmdName(c),g=f.keys(x.TOGGLE_INLINE_STYLES_CMD_MAP);e&&b._editingInlineStates&&(g.indexOf(e)>-1&&!0!==d&&!1!==d&&(d=!b._editingInlineStates[e]),b._editingInlineStates[e]=d)}},_clearEditingInlineStates:function(){this._editingInlineStates=null},execCommand:function(a){var b,c,d=this,f=d.getNativeRange();return e.log("execCommand",a),f?(d._nestLevel||(d._nestLevel=0),d._nestLevel++,b=d._shouldModifyEditingInlineStates(a,f,d._nestLevel),1===d._nestLevel&&(b?d._grabEditingInlineStates(a):d._clearEditingInlineStates()),c=d._commander.exec(a),c&&1===d._nestLevel&&(b?d._updateEditingInlineStates(a):d._clearEditingInlineStates(),d.trigger("cell-edit-view-command-executed")),d._nestLevel--,c):(e.warn("nativeRange  is not in editBox"),!1)},exit:function(){var a=this;a._isDirty=!1,a._editingCellId=null,a._clearTimeoutOfHandleChange(),a._lastSnapshot=null,a._baseSnapshot=null,a._removeListenerForDocSelectionChange(),a._changeMonitor.disconnect(),a._history.reset(),a.trigger("cell-edit-view-exit"),a.hide()},_filterTable:function(a){var b=a.querySelectorAll("table");f.each(b,function(a){var b=a.querySelectorAll("td"),c="";f.each(b,function(a){c+=a.innerHTML}),a.innerHTML=c})},_filterHtml:function(a){var b=g(a),c=["img"];return b?(this._filterTable(b),f.each(t,function(a,b){!1===a&&c.push(b)}),f.each(c,function(a){var c=b.querySelectorAll(a);f.each(c,function(a){a&&a.parentNode&&a.parentNode.removeChild(a)})}),b.innerHTML.trim()):""},_onPaste:function(a){var b,c,d=this,e=a.originalEvent||a,g=e.clipboardData;a.stopPropagation(),a.preventDefault(),g&&g.types&&(-1!==f.indexOf(g.types,"text/html")?(b=g.getData("text/html"),b=d._filterHtml(b),c=s.create({name:"insertHTML",isNative:!0,value:b})):-1!==f.indexOf(g.types,"text/plain")&&(b=g.getData("text/plain"),c=s.create({name:"insertText",isNative:!0,value:b})),d.execCommand(c))},_onDblclick:function(a){a.stopPropagation()},editFromToolbar:function(a,b){var c,d=this,e=d.getNativeRange(),f=d.queryInlineStylesForBulb();return d._rangeWhenBlur&&(e=d._rangeWhenBlur,r.setRange(e)),!!e&&(!!(c=x.createCmdBall(a,b,f))&&(d.execCommand(c),d._rangeWhenBlur=null,!0))},getEditBox:function(){return this._editBox}},{create:function(a){return a&&a.table&&a.tableView?new b(a):void e.warn("Failed to create CellEditView",a)},isRangeIn:function(a){if(!a)return!1;var b=F+"."+G;return r.isRangeInSelector(b,a)}})}(),yne_common_views_table_HiddenInputView=function(a){var b,c=yne_backbone,d=yne_underscore,e=yne_jtk_core_L,f=yne_common_util_events,g=yne_common_key_KeyMonitor,h=yne_common_selection_nativeSelection,i=new Array(3).join(" "),j=[8,9,13,16,17,18,19,20,27,33,34,35,36,37,38,39,40,45,46,91,92,93,112,113,114,115,116,117,118,119,120,121,122,123,144,145,229],k="input",l="hidden-input";return b=c.View.extend({tagName:k,className:l,initialize:function(){var a=this;a._initEvents(),delete a.options},_initEvents:function(){var a=this;f.addListeners({textInput:"_onTextInput",compositionstart:"_onCompositionStart",compositionend:"_onCompositionEnd",copy:"_onCopyCutPaste",cut:"_onCopyCutPaste",paste:"_onCopyCutPaste"},a.$el,a)},bindKey:function(a){var b=this,c=b._keyMonitor;a&&(c||(b._keyMonitor=c=new g({el:b.el,beforeMatch:function(a){a.stopPropagation()},afterMatch:function(a,c){c||-1!==d.indexOf(j,a.keyCode)||a.ctrlKey||a.metaKey||b._onPrintableKeyDown(a)}})),c.unbind(a),c.bind(a,function(c){b.trigger("key-monitor",a,c)}))},unbindKey:function(a){var b=this,c=b._keyMonitor;c&&a&&c.unbind(a)},render:function(){this.$el.val(i)},isFocused:function(){return document.activeElement===this.el},isOnEdit:function(){var a=this;return a.isFocused()&&a.getValue()!==i},focus:function(a){var b=this,c=b.el;a&&this.setPosition(a.left,a.top),c.focus(),c.select()},blur:function(){this.el.blur()},setPosition:function(a,b){var c=this,d=c.el;d.style.left=a+"px",d.style.top=b+"px"},setWidth:function(a){this.el.style.width=a+"px"},bringToFront:function(){this.el.value="",this.el.style.zIndex=255},hideBehind:function(){this.el.style.zIndex=-255},_onPrintableKeyDown:function(a){var b=this,c=a.originalEvent||a;a.preventDefault(),b._triggerTextInput(c.key)},_onTextInput:function(a){e.log("hiddenInputView textInput",a),a.stopPropagation();var b=this,c=a.data;229===b._lastKeyDownCode&&d.contains(["·","~","！","@","#","￥","%","……","&","*","（","）","-","——","=","+","【","{","】","}","、","|","；","：","‘","’","“","”","，","《","。","》","、","？"],c)&&b._triggerTextInput(c)},_onCompositionStart:function(a){e.log("hiddenInputView compositionstart",a),a.stopPropagation();var b=this;b._compositionStartFired=!0,b.bringToFront()},_onCompositionEnd:function(a){if(e.log("hiddenInputView compositionend",a),a.stopPropagation(),!this.locked){var b=this,c=a.data||this.$el.val();b._compositionStartFired=!1,c&&d.defer(function(){b._triggerTextInput(c)}),b.hideBehind()}},_onInput:function(){e.log("hiddenInputView _onInput",event);var a,b=this,c=b.hiddenInputView;b._compositionStartFired||(a={data:c.getValue()},c.clearValue(),b.onCompositionEnd(a))},_onCopyCutPaste:function(a){var b=this,c=a.type;a.preventDefault(),a.stopPropagation(),e.log("on copy/cut/paste",c,a),b.trigger(c,a)},_triggerTextInput:function(a){var b=this;b.trigger("text-input",a),b.clearValue()},clearValue:function(){this.el.value=i},getValue:function(){return this.el.value}},{create:function(a){return new b(a)},isRangeIn:function(a){if(a){var b=k+"."+l;return h.isRangeInSelector(b,a)}}})}(),yne_common_util_direction={LEFT:1,RIGHT:2,UP:3,DOWN:4},yne_common_views_table_CellResizeView=function(a){var b=yne_backbone,c=yne_common_util_Draggable,d=yne_common_util_events,e=yne_common_util_direction,f=yne_common_jst,g=yne_underscore,h=35;return b.View.extend({className:"cell-resize-layer",initialize:function(a){var b=this,d=a.tableView,e=d.$el;b._tableView=d,b._draggable=new c({el:b.el,disableDocSelection:!0}),b._active=!0,b._onDrag=!1,b._resizeDirection=null,b._cellInfo=null,this._rowLine=e.find(".row-resize-line"),this._colLine=e.find(".col-resize-line"),b._bindEvents()},_bindEvents:function(){var a=this,b=a._draggable,e=a._tableView,f={};g.bindAll(a,"_onCellEnter"),f[c.DRAG_START]="_onDragStart",f[c.DRAGGING]="_onDragging",f[c.DRAG_END]="_onDragEnd",d.addListeners(f,b,a),e.on("cell-enter",a._onCellEnter)},render:function(){var a=this,b=f.render("common","table_cell_resize",{});a.$el.html(b),a.showAt()},showAt:function(a){var b=this;a&&null!=a.width&&b.$el.css({width:a.width,height:a.height,top:a.top,left:a.left}).show()},hide:function(){this.$el.hide()},enable:function(){this._active=!0},disable:function(){var a=this;a._active=!1,a.hide()},isActive:function(){return this._active},_parseType:function(a){var b,c=a.className;return g.some(e,function(a,d){var e=d.toLowerCase();if(c.indexOf(e)>-1)return b=a,!0}),b||e.UP},_onDragStart:function(a){var b,c=this,d=c._tableView;d&&!d.isLocked()&&(a.stopPropagation(),c._onDrag=!0,c._resizeDirection=c._parseType(a.target),b=d.getEventBoundingRect(a),c._startRect=b,c._updateResizeLine(b.left,b.top),d.focusOutTbody())},_onDragging:function(a){var b,c=this,d=c._tableView;d&&!d.isLocked()&&(a.stopPropagation(),c._onDrag=!0,b=d.getEventBoundingRect(a),c._updateResizeLine(b.left,b.top))},_onDragEnd:function(a){var b,c,d,f=this,g=f._tableView,h=f._cellInfo;g&&!g.isLocked()&&(a.stopPropagation(),f._onDrag=!1,b=g.getEventBoundingRect(a),f._updateResizeLine(b.left,b.top,!0),c=b.left-f._startRect.left,d=b.top-f._startRect.top,h&&(0===h.row&&f._resizeDirection===e.TOP&&(d=0-d),0===h.col&&f._resizeDirection===e.LEFT&&(c=0-c)),f._execResizeCommand(c,d))},_updateResizeLine:function(a,b,c){switch(this._resizeDirection){case e.UP:case e.DOWN:c?this._rowLine.hide():this._rowLine.css({top:b}).show();break;case e.RIGHT:case e.LEFT:c?this._colLine.hide():this._colLine.css({left:a}).show()}},_execResizeCommand:function(a,b){var c,d,f,i,j,k,l,m,n,o,p=this,q=p._tableView,r=q.block,s=p._cellInfo;switch(p._resizeDirection){case e.UP:case e.DOWN:c=s.row,p._resizeDirection===e.UP?c-=1:(k=r.getMergePointAttrAt(s.row,s.col).height||0)>1&&(c+=k-1),c=c<0?0:c,f=q.getRowElHeight(c),f+=b,f=g.max([f,10]),p.trigger("set-row-height",c,f);break;case e.RIGHT:case e.LEFT:if(d=s.col,p._resizeDirection===e.LEFT?d-=1:(j=r.getMergePointAttrAt(s.row,s.col).width||0)>1&&(d+=j-1),l=d+1,d=d<0?0:d,m=q.getColElWidth(d),i=g.max([m+a,h]),l>=r.getColumnCount()){p.trigger("set-col-width",d,m+a);break}l!==d?(n=m+r.getColumnWidth(l),o=g.max([n-i,h]),p.trigger("set-cells-size",[{col:l,width:o},{col:d,width:n-o}])):p.trigger("set-col-width",d,i)}},_onCellEnter:function(a){var b,c,d,e=this,f=e._tableView,g=f.block;!g.locked&&f&&e.isActive()&&!e._onDrag&&(c=f.getCellElementByTarget(a),(b=g.getCellById(c))&&(e._cellInfo={row:b.row,col:b.col},d=f.getBoundingRect(c),e.showAt(d)))}})}(),yne_common_data_table_resourceRenderer=function(a){var b=yne_common_jst,c=yne_common_util_attachmentParse;return{_renderWrap:function(a){return'<div class="resource-wrap">'+a+"</div>"},renderImage:function(a,b){var c=a.getSource(b),d=document.createElement("img");return d.setAttribute("draggable","false"),d.setAttribute("src",c||""),d.setAttribute("width","100%"),d.setAttribute("height","auto"),this._renderWrap(d.outerHTML)},renderAttachment:function(a){var d,e,f,g,h=a.getInfo(),i="attachment-view-attachment-container";return d=c.splitFileFullName(h.fileName),e=c.getSizeString(h.fileLength),g=c.getFileIconByName(h.fileName),f=b.render("common",i,{name:g,fileName:d.fileName,fileType:d.fileType,size:e,title:h.fileName,draggable:!1}),this._renderWrap(f)}}}(),yne_parser_plain_createRichText=function(a){var b=yne_common_data_RichText;return function(a,c){var d;return a+="",a=a.replace(/[\r\n]/g,""),d=new b({text:a}),c&&d.setStyles(0,d.getLength(),c),d}}(),yne_parser_plain_parseLine=function(a){var b=yne_parser_plain_createRichText,c=yne_common_data_Paragraph,d=yne_common_commands_link_LinkMatch,e=yne_underscore;return function(a,f,g,h){if(null!=a){var i,j,k=new c;return h||(i=d.matchEnd(a))&&0===i.result.index&&e.extend(f||(f={}),{href:i.fullURI,underline:!0,color:"#003884"}),j=b(a,f),k.setText(j),g&&e.each(g,function(a,b){k.setBlockStyle(b,a)}),k}}}(),yne_parser_plain_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_parser_plain_parseLine;return function(a,e,f,g){var h,i=[];return a?(h=a.split(/\r\n?|\n/))&&h.length?(c.each(h,function(a){var b=d(a,c.clone(e),c.clone(f),g);b&&i.push(b)}),b.log("to paste text",i),i):void b.warn("lines do not exist or lines.length is 0!"):void b.warn("no text when paste plain text!")}}(),yne_parser_json_createBlock=function(a){var b=yne_common_data_Attachment,c=yne_common_data_blockTypes,d=yne_common_data_Catalogue,e=yne_common_data_Heading,f=yne_common_data_Hr,g=yne_common_data_Image,h=yne_common_data_ListItem,i=yne_common_data_Paragraph,j=yne_common_data_Table,k=yne_common_data_Todo,l=yne_common_data_HandWrite,m=yne_jtk_core_L;return function(a){if(!a||!a.blockType)return void m.warn("jsonObj is null or jsonObj has no `blockType` property!");var n,o=a.blockType;switch(o){case c.PARAGRAPH:n=i.fromJSON(a);break;case c.LIST_ITEM:n=h.fromJSON(a);break;case c.IMAGE:n=g.fromJSON(a);break;case c.ATTACHMENT:n=b.fromJSON(a);break;case c.TABLE:n=j.fromJSON(a,!0);break;case c.HR:n=f.fromJSON(a);break;case c.HEADING:n=e.fromJSON(a);break;case c.CATALOGUE:n=d.fromJSON(a);break;case c.TODO:n=k.fromJSON(a);break;case c.HANDWRITE:n=l.fromJSON(a);break;default:m.warn("jsonObj.blockType = "+o)}return n}}(),yne_parser_json_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_common_data_List,e=yne_common_data_Catalogues,f=yne_common_data_blockTypes,g=yne_parser_json_createBlock,h=yne_collaboration_collabUtils;return function(a){var i,j,k,l=[],m={},n={},o={};if(c.isString(a))try{i=window.JSON.parse(a)}catch(c){b.error("parse json string error: ",a)}else c.isArray(a)&&(i=a);if(i&&i.length)return b.log("createBlocksFromJSON array: ",i),c.each(i,function(a){var b;(b=g(a))&&(a.listId&&a.listType&&f.isListItem(b)&&(j=a.listId,k=m[j],k||(k=new d({type:a.listType,listId:a.listId}),m[j]=k),b.setOwnerList(k)),a.ownerId&&f.isCatalogue(b)&&(j=a.ownerId,o[j]||(o[j]=h.newGUID(),n[o[j]]=new e({id:o[j]})),k=n[o[j]],b.setOwnerList(k)),l.push(b))}),l}}(),yne_parser_ocr_convert=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_common_data_RichText,e=yne_common_data_Paragraph,f=1.5,g={create:function(){var a={};return a.data={},a.push=function(b,c){c||(c=1),a.data[b]?a.data[b]+=c:a.data[b]=c},a.count=function(){return Object.keys(a.data).length},a.mergeKeys=function(b){var d,e,f,h,i,j=g.create(),k=a.data;return c.each(a.orderedKeys(),function(a){f&&a-f<b?(h=k[f],i=k[a],e=h+i,d=(f*h+a*i)/e,j.push(d,e),f=null):(f&&j.push(f,k[f]),f=a)}),f&&j.push(f,k[f]),j.count()!==a.count()?j.mergeKeys(b):j},a.mostFrequencyKey=function(){var b,d=0;return c.each(a.data,function(a,c){a>=d&&(d=a,b=parseInt(c))}),b},a.orderedKeys=function(){var b;return b=Object.keys(a.data),b.sort(function(a,b){return a-b})},a}},h=function(a){var b={},c=a.split(",");return b.left=parseInt(c[0]),b.top=parseInt(c[1]),b.width=parseInt(c[2]),b.height=parseInt(c[3]),b.right=b.left+b.width,b.bottom=b.top+b.height,b},i=function(a,b){var c=(b.box.bottom-a.box.top)/a.box.height,d=(b.box.bottom-a.box.top)/b.box.height;return Math.max(c,d)>.8},j=function(a){return/^[a-z][a-z\d.,\/#!$%\^&\*;:{}=\-_`~()]*$/i.test(a)},k=function(a){var b=[/Epdf/,/For Evaluation Purposes Only/],c=!1;return b.forEach(function(b){b.test(a)&&(c=!0)}),c},l=function(a,b){a.box.top=a.box.top<b.box.top?a.box.top:b.box.top,a.box.bottom=a.box.bottom>b.box.bottom?a.box.bottom:b.box.bottom,a.box.left=a.box.left<b.box.left?a.box.left:b.box.left,a.box.right=a.box.right>b.box.right?a.box.right:b.box.right,a.box.height=a.box.bottom-a.box.top,a.box.width=a.box.right-a.box.left,a.words=b.words.concat(a.words),a.text=b.text+"  "+a.text},m=function(a){var b,d,e=a.json,f=[];for(e.box=h(e.boundingBox),c.each(e.lines,function(a){var d,g="";a.box=h(a.boundingBox),c.each(a.words,function(a){a.box=h(a.boundingBox),j(a.text)&&(g+=" "),g+=a.text}),a.text=g,k(a.text)?(d=e.lines.indexOf(a),f.push(d)):(b&&i(a,b)&&(l(a,b),d=e.lines.indexOf(b),f.push(d)),b=a)}),d=f.length-1;d>=0;d-=1)e.lines.splice(f[d],1)},n=function(a){var b,d=a.json,e=g.create(),f=g.create(),h=g.create(),i=g.create(),j=g.create(),k={};c.each(d.lines,function(a){e.push(a.box.left),f.push(a.box.right),b&&h.push(a.box.bottom-b.box.bottom),b=a,c.each(a.words,function(a){j.push(a.box.height),i.push(a.box.width)})}),k.baseLineHeight=h.mostFrequencyKey(),k.baseWordWidth=i.mostFrequencyKey(),k.baseFontHeight=j.mostFrequencyKey(),k.regionLeft=e.mergeKeys(k.baseFontHeight).mostFrequencyKey(),k.regionRight=f.mergeKeys(k.baseFontHeight).mostFrequencyKey(),a.stat=k},o=function(a){var b,c,d,e,g,h,i=a.json,j=[],k=a.stat.regionLeft,l=a.stat.regionRight,m=a.stat.baseWordWidth,n=a.stat.baseLineHeight,o=!1,p=!1,q="";for(b={startLineIndex:0},g=0;g<i.lines.length;g+=1){if(e=i.lines[g],o=p,k+m*f<e.box.left&&g!==b.startLineIndex&&(o=!0),d&&e.box.bottom-d.box.bottom>n*f&&(o=!0),o){for(b.endLineIndex=g-1,b.text=q.trim(),j.push(b),c=Math.floor((e.box.bottom-d.box.bottom)/n-1),h=0;h<c;h+=1)j.push({text:""});b={startLineIndex:g},q=e.text}else q+=e.text;d=e,p=l-m*f>e.box.right}b.endLineIndex=g,b.text=q,j.push(b),a.paragraphs=j},p=function(a){var b=a.json,d=a.stat,e=a.paragraphs;c.each(e,function(a){var c,e=b.lines[a.startLineIndex];e&&(c=e.words[0])&&Math.ceil((c.box.left-d.regionLeft)/d.baseWordWidth)/2>=1&&(a.text="\t"+a.text)})},q=function(a){var b,c,f,g=new e;return f=a.fontSize,b=a.text,b=b.replace(/[\r\n]/g,""),c=new d({text:b}),c.setStyle(0,c.getLength(),"font-size",f),g.setText(c),g},r=function(a){var b={};return b.json=a,m(b),n(b),o(b),p(b),b};return function(a){var d,f,g=[];if(c.isString(a))try{d=window.JSON.parse(a)}catch(c){b.error("parse json string error: ",a)}return c.isArray(a)&&(d=a),d&&c.each(d,function(a){c.each(a.regions,function(a){var b=r(a);c.each(b.paragraphs,function(a){f=q(a),g.push(f)})}),g.push(new e)}),g}}(),yne_parser_Parser=function(a){var b=yne_parser_html_convert,c=yne_parser_plain_convert,d=yne_parser_json_convert,e=yne_parser_ocr_convert,f=yne_jtk_core_L;return{parseHtml:function(a){var c=b(a);return f.log("parseHtml OK",c),c},parsePlain:function(a,b,d,e){return c(a,b,d,e)},parseJSON:function(a){return d(a)},parseOCR:function(a){return e(a)}}}(),yne_jtk_core_str_base64={encode:function(a){return window.btoa(window.unescape(encodeURIComponent(a)))},decode:function(a){return decodeURIComponent(window.escape(window.atob(a)))}},yne_common_util_DataTransfer=function(a){var b=yne_underscore,c=yne_jtk_core_Class,d=yne_jtk_core_L,e=yne_common_util_userAgent,f=e.isEdge(),g=yne_jtk_core_str_base64,h={"text/html":!0,"text/plain":!0,"text/uri-list":!0,"text/yne-image-json":!1,"text/yne-json":!1,"text/yne-note-id":!1,"text/yne-table-json":!1},i="application/json";return c.extend({initialize:function(a){var b=this,c=a.event,d=c.originalEvent||c;b._dataTransfer=d.dataTransfer},_getCustomData:function(a){var b,c,e=this;if(!e._altData){b=e._dataTransfer.getData(i);try{c=JSON.parse(b),e._altData=c}catch(a){d.error(a),e._altData={}}}return e._altData[a]},getData:function(a){var b,c,e=this,g=e._dataTransfer;return f?(b=h[a],!0===b?(c=g.getData(a),d.log("get standard type",a,c)):!1===b?(c=e._getCustomData(a),d.log("get custom type",a,c)):d.error("type should be registered!",a),c):g.getData(a)},setDataMap:function(a){var c,e=this._dataTransfer,j=function(b,c){d.log("set data to data transfer",c,b);try{var f=b;"text/html"===c&&null!=a["text/yne-json"]&&null!=a["text/html"]&&(a["text/html"]=a["text/html"]+"\x3c!--5f39ae17-8c62-4a45-bc43-b32064c9388a:"+g.encode(a["text/yne-json"])+"--\x3e",f=a["text/html"]),e.setData(c,f)}catch(a){d.error(a)}},k={},l=0;if(f){if(b.each(a,function(a,b){var c=h[b];!0===c?j(a,b):!1===c?(d.log("set custom type",b),k[b]=a,l++):d.error("type should be registered!",b)}),l>0)try{c=JSON.stringify(k),j(c,i)}catch(a){d.error(a)}}else b.each(a,j)},clearData:function(a){return this._dataTransfer.clearData(a)},setProperty:function(a,b){this._dataTransfer[a]=b}})}(),yne_common_util_ClipboardData=function(a){return yne_common_util_DataTransfer.extend({initialize:function(a){var b=this,c=a.event,d=c.originalEvent||c;b._dataTransfer=d.clipboardData}})}(),yne_common_views_table_key_toggleInlineStyle=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_underscore,d={"mod+b":"bold","mod+i":"italic","mod+u":"underline","mod+e":"strike"};c.each(d,function(a,c){b.register({name:a,scope:"table-hidden-input",key:c,action:function(b){b.toggleInlineStyle(a)}})})}(),yne_common_views_table_key_directions=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_util_direction,d=yne_underscore,e={left:c.LEFT,right:c.RIGHT,up:c.UP,down:c.DOWN,tab:c.RIGHT,"shift+tab":c.LEFT,enter:c.DOWN};d.each(e,function(a,c){b.register({name:c,scope:"table-hidden-input",key:c,action:function(b,c){b.moveWithDirection(a,c)}})})}(),yne_common_views_table_key_clearSelection=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_underscore,d=["backspace","del"];c.each(d,function(a){b.register({name:a,scope:"table-hidden-input",key:a,action:function(a){a.clearSelectedCells()}})})}(),yne_common_views_table_key_save=function(a){yne_common_key_KeyHandlerManager.register({name:"save",scope:"table-hidden-input",key:"mod+s",action:function(a){a.trigger("save-content")}})}(),yne_common_views_table_key_selectAll=function(a){yne_common_key_KeyHandlerManager.register({name:"select-all",scope:"table-hidden-input",key:"mod+a",action:function(a){a.selectAll(!0)}})}(),yne_common_views_table_key_undoRedo=function(a){var b=yne_common_key_KeyHandlerManager;b.register({name:"undo",scope:"table-hidden-input",key:"mod+z",action:function(a){a.trigger("global-undo")}}),b.register({name:"redo",scope:"table-hidden-input",key:"mod+y",action:function(a){a.trigger("global-redo")}}),b.register({name:"redo_2",scope:"table-hidden-input",key:"mod+shift+z",action:function(a){a.trigger("global-redo")}})}(),yne_common_views_table_key_preventedKeys=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_underscore,d=yne_jtk_core_L,e=["mod+1","mod+2","mod+3","mod+4","mod+d","mod+h"];c.each(e,function(a){b.register({name:a,scope:"table-hidden-input",key:a,preventDefault:!0,action:function(){d.log("shortcut prevented on table")}}),b.register({name:a,scope:"table-cell-edit",key:a,action:function(){d.log("shortcut prevented on table")}})})}(),yne_common_views_table_key_paste=function(a){var b=yne_common_key_KeyHandlerManager;b.register({name:"paste",key:"mod+v",scope:"table-hidden-input",preventDefault:!1,action:function(a){a.setPasteAsText(!1)}}),b.register({name:"pasteAsText",key:"mod+shift+v",scope:"table-hidden-input",preventDefault:!1,action:function(a){a.setPasteAsText(!0)}})}(),yne_common_views_table_key_keyConfig=void 0,yne_common_views_TableView=function(a){var b=yne_underscore,c=yne_common_views_BlockView,d=yne_common_jst,e=yne_jquery,f=yne_tinycolor,g=yne_jtk_core_L,h=yne_common_util_events,i=yne_common_util_Draggable,j=yne_jtk_web_dom_remove,k=yne_common_views_table_SelectionView,l=yne_common_selection_TableRange,m=yne_common_selection_NoteRange,n=yne_common_data_table_tableCellType,o=yne_common_views_table_CellEditView,p=yne_common_views_table_HiddenInputView,q=yne_common_views_table_CellResizeView,r=yne_common_key_KeyHandlerManager,s=yne_common_data_table_resourceRenderer,t=yne_common_util_rect,u=yne_common_data_supportedInlineStyles,v=yne_common_fontMaps,w=yne_common_data_blockTypes,x=yne_parser_Parser,y=yne_common_data_table_TableCell,z=yne_common_util_direction,A=yne_common_util_platform,B=yne_common_selection_nativeSelection,C=yne_common_util_noteLink,D=yne_common_data_RichText,E=yne_common_util_ClipboardData,F=yne_common_data_table_ImageResource;return c.extend({className:"block-view table-view",_template:d.getTemplate("common","table_view"),_wrapperElClassName:"table-wrapper",_cellEditClassName:"cell-edit",_cellSelectedClassName:"cell-selected",_layoutElClassName:"table-layout",_layoutInnerElClassName:"table-layout-inner",_rectOnDragStart:null,_oldRangeType:null,_rending:null,_isPasteAsText:!1,events:{"mouseenter td":"_onCellMouseEnter","mouseleave td":"_onCellMouseLeave",mousedown:"_onMouseDown",dblclick:"_onDblclick",click:"_onClick","mouseenter a":"_onEnterLink","mouseleave a":"_onLeaveLink"},initialize:function(){var a=this;c.prototype.initialize.apply(a,arguments),a._draggable=new i({el:this.el,disableDocSelection:!0}),a.bindSelectionEvents(),a._initEvents()},_initEvents:function(){var a=this,c=a.block,d=a._draggable,e={};b.bindAll(a,"_onAttributeChanged","_onDragging"),h.addListeners({"cell-inline-style-change":"_onCellInlineStyleChange","cell-block-style-change":"_onCellBlockStyleChange","row-height-set":"_onRowHeightSet","col-width-set":"_onColWidthSet","row-inserted":"_onRowInserted","col-inserted":"_onColInserted","row-deleted":"_onRowDeleted","col-deleted":"_onColDeleted","cell-content-change":"_onCellContentChange","content-change":"_reRenderCells","high-light":"onHighlight"},c,a),c.on("attribute-changed",b.throttle(a._onAttributeChanged),100),e[i.DRAG_START]="_onDragStart",e[i.DRAG_END]="_onDragEnd",h.addListeners(e,d,a),d.on(i.DRAGGING,b.throttle(a._onDragging,100)),a._triggerResize=b.throttle(a._triggerResize,100)},_removeSubViews:function(){var a=this;b.each(["_cellEditView","_selectionView","_hiddenInputView","_hiddenInputView"],function(b){var c=a[b];c&&(c.destroy?c.destroy():g.error("view has no destroy()",c),a[b]=null)})},_addSubViews:function(){var a,c=this,d=c._keyHandlerManager;c._removeSubViews(),c._cellEditView=o.create({table:c.block,tableView:c,styleRules:c._getStyleRules(),mapper:this._inlineStyleViewMapper}),h.addListeners({"set-cell-content":"_onSetCellContent",blur:"_onCellEditViewBlur","cell-edit-view-exit":"_onCellEditViewExit","cell-edit-view-enter":"_onCellEditViewEnter"},c._cellEditView,c),h.bubble({"cell-edit-view-selection-change":!0,"cell-edit-view-exit":!0,"cell-edit-view-history-change":!0,"cell-edit-view-command-executed":!0},c._cellEditView,c),c.addViewToInner(c._cellEditView),c._selectionView=new k({tableView:c}),c.addViewToInner(c._selectionView),c._cellResizeView=new q({tableView:c}),c.addViewToInner(c._cellResizeView),h.addListeners({"set-row-height":"_onSetRowHeight","set-col-width":"_onSetColWidth","set-cells-size":"_setCellsSize"},c._cellResizeView,c),c._hiddenInputView=p.create({}),d||(d=c._keyHandlerManager=new r({scope:"table-hidden-input"})),d.on("bind-key",function(a){var b=c._hiddenInputView;b&&b.bindKey(a)}),d.on("unbind-key",function(a){var b=c._hiddenInputView;b&&b.unbindKey(a)}),a=d.getAvailableHandlerNames(),b.each(a,function(a){d.bind(a)}),c.addView(c._hiddenInputView),h.addListeners({"key-monitor":"_onKey",copy:"_onCopy",cut:"_onCut",paste:"_onPaste","text-input":"_onTextInput"},c._hiddenInputView,c)},_onSetCellContent:function(a,b){var c=this,d=c.block,e=d.getCellById(a);if(!e)return void g.error("Not find cell! by id:",a);c.trigger("command","comp.SetTableCellContent",{table:c.block,cellRect:{row:e.row,col:e.col},content:b})},_onCellEditViewBlur:function(){},_onCellEditViewExit:function(){this._hiddenInputView.hideBehind()},_onKey:function(a,b){var c=this;c._keyHandlerManager.execWithKey(a,c,b)},_onCopy:function(a){var b=this;a.stopPropagation(),a.preventDefault(),b.trigger("copy",a)},_onCut:function(a){var b=this,c=b._getNoteRange();a.stopPropagation(),a.preventDefault(),b.trigger("cut",a),c.isSingleTableSelected()&&b._clearSelectCells()},_pasteBlobImg:function(a){var b,c,d,e=this;b=a.originalEvent.clipboardData.items,d=e._getRectOfNoteRange(),b&&1===b.length&&0===b[0].type.indexOf("image")&&d&&(c=b[0].getAsFile(),e.trigger("yne-blob-paste",{isImg:!0,data:c},function(a){a&&a.source&&e.trigger("command","comp.SetTableCellContent",{table:e.block,cellRect:{row:d.top,col:d.left},content:F.create({source:a.source})})}))},_onPaste:function(a){a.stopPropagation(),a.preventDefault();var b,c,d,e,f,g=this,h=g._isPasteAsText;return A.IS_PC?void g.trigger("yne-on-paste",h,a):(b=new E({event:a}),h?void((f=b.getData("text/plain"))&&g._pastePlain(f)):void((c=b.getData("text/yne-json"))&&g._pasteJSON(c)||(d=b.getData("text/yne-table-json"))&&g._pasteYTableJson(d)||(e=b.getData("text/html"))&&g._pasteHTML(e)||(f=b.getData("text/plain"))&&g._pastePlain(f)||g._pasteBlobImg(a)))},_pasteHTML:function(a){var b=this,c=x.parseHtml(a);return b.pasteBlockList(c)},_pasteJSON:function(a){var b=x.parseJSON(a);return this.pasteBlockList(b)},_pasteYTableJson:function(a){var c=this;if(b.isString(a))try{a=window.JSON.parse(a)}catch(a){return void g.error("parse ytable json  string error")}return c._pasteJSON([{blockType:w.TABLE,data:a}])},_pastePlain:function(a){var b=this,c=x.parsePlain(a);return b.pasteBlockList(c)},pasteBlockList:function(a){var b=this,c=b.block,d=[],e=[];return!(!a||!a.length)&&(1===a.length&&w.isTable(a[0])?(this.trigger("command","comp.InsertTableCells",{table:c,widths:a[0]._colWidths,heights:a[0]._rowHeights,cellsData:a[0]._tableCells}),!0):(a.forEach(function(a){var b=y.blockToCell(a);b&&d.push(b)}),d.length>0?(d.forEach(function(a){e.push([a])}),b.trigger("command","comp.InsertTableCells",{table:c,cellsData:e}),!0):void 0))},_clearSelectCells:function(){var a=this,b=a.block;a.trigger("command","comp.InsertTableCells",{table:b})},_onTextInput:function(a){var b,c,d,e,f=this,h=f._getRectOfNoteRange();if(!h)return void g.warn("Failed to show cellEditView",h);f.isLocked()||(b=f.block.getCell(h.top,h.left,{findMergePointIfNeeded:!0,withPosition:!0}))&&(c=b.cell,c&&c.isEmpty()?(d=c.getStylesForEmpty(),e=D.create(a,!1),e.setStyles(0,e.getLength(),d)):e=D.create(a,!1),f._cellEditView.showAndEdit({row:b.row,col:b.col,content:e}))},moveWithDirection:function(a,b){var c,d=this,e=d.block,f=d._getRectOfNoteRange(),g=1,h=1;if(f){if(e.isMergePoint(f.top,f.left)&&(c=e.getMergePointAttrAt(f.top,f.left),h=c.height,g=c.width),a===z.UP){if(f.top-h<0)return d.trigger("move-caret",!1,b);d._setRange({top:f.top-h,left:f.left,width:1,height:1})}if(a===z.DOWN){if(f.top+h+f.height>e.getRowCount())return d.trigger("move-caret",!0,b);d._setRange({top:f.top+h,left:f.left,width:1,height:1})}a===z.LEFT&&d._setRange({top:f.top,left:Math.max(f.left-g,0),width:1,height:1}),a===z.RIGHT&&d._setRange({top:f.top,left:Math.min(f.left+g,e.getColumnCount()-1),width:1,height:1})}},toggleInlineStyle:function(a){this.trigger("command","comp.SetTableCellInlineStyle",{toggle:a})},clearSelectedCells:function(){this._clearSelectCells()},enterEditMode:function(){},selectAll:function(a){a&&this.trigger("select-all")},render:function(){var a=this,b=a.el;a._rending=!0,a._removeSubViews(),a._renderTemplate(),a.colgroupEl=b.querySelector("colgroup"),a.wrapperEl=b.querySelector("."+a._wrapperElClassName),a.tableEl=b.querySelector("table"),a._tableLayoutEl=b.querySelector("."+a._layoutElClassName),a._tableLayoutInnerEl=b.querySelector("."+a._layoutInnerElClassName),a._setHeightByData(),a._renderCells(),a._addSubViews(),c.prototype.render.apply(a,arguments),a._rending=!1,a._triggerResize()},addView:function(a){this._tableLayoutEl.appendChild(a.el),a.render()},addViewToInner:function(a){this._tableLayoutInnerEl.appendChild(a.el),a.render()},_renderTemplate:function(){var a=this;a.$el.html(a._template())},_renderCells:function(){var a,b,c,d,e,f=this,h=f.block,i=f.tableEl,j=h.getRowCount(),k=h.getColumnCount(),l=i.querySelector("tbody"),m=[];for(d=0;d<j;d++){for(a=document.createElement("tr"),e=0;e<k;e++)b=h.getCell(d,e),b||g.error("No find cell! row, col, block",d,e,h),b.isMergedCell()||(b.isAttachmentCell()&&m.push({row:d,col:e}),a.appendChild(f._renderCell(d,e)));c=h.getRowHeight(d),a.style.height=c?c+"px":"",l.appendChild(a)}f._renderColumns(f.colgroupEl.querySelectorAll("col").length,k)},_loadCellImg:function(a,b){var c=this,d=a.querySelector("img");d&&e(d).load(function(){c._triggerResize(),b&&c._redrawRange()})},_replaceBlankToSymbol:function(a){var c=a,d=function(a){!a||a.length<1||b.forEach(a,function(a){a.children&&a.children.length>0&&d(a.children),a.childNodes[0]&&3===a.childNodes[0].nodeType&&(a.innerHTML=a.innerHTML.replace(/ /g,"&nbsp;"))})};c&&d(c.children)},_renderCell:function(a,b,c){var d,e,f,g,h,i=this,j=i.block,k=j.getCell(a,b,{findMergePointIfNeeded:!0,withPosition:!0});if(k){switch(d=k.cell,e=c||document.createElement("td"),f=d.getContent(),g=d.getType(),e.setAttribute("data-cell-id",d.getCellId()),i._setMergeCell(e,d),i._setCellStyles(e,d.getBlockStyles()),g){case n.TEXT:h=f.toHtml({styleRules:i._getStyleRules()});break;case n.IMAGE:h=s.renderImage(f,j.getExtraInfo("pcResMap"));break;case n.ATTACHMENT:h=s.renderAttachment(f)}return e.innerHTML=h,i._loadCellImg(e,c),i._replaceBlankToSymbol(e),c&&i._triggerResize(),e}},_getStyleRules:function(){var a=this._inlineStyleViewMapper;return{color:function(b){var c=b.color
;return b.href!==u.getDefault("href")&&f.equals(b.color,"blue")?"#003884":null!=c&&a?a.valueToView("color",c):void 0},"font-family":function(b){var c,d=b["font-family"];return null!=d&&a&&(c=a.valueToView("font-family",d)),d!==c?c:v.getAllValueByFont(d)||d}}},_setMergeCell:function(a,b){if(b.isMergePoint()){var c=b.getMergePointAttr();c.width>0&&a.setAttribute("colspan",c.width),c.height>0&&a.setAttribute("rowspan",c.height)}},_reRenderCells:function(){var a=this,b=a.tableEl,c=b.querySelector("tbody");a._rending=!0,c.innerHTML="",a.colgroupEl.innerHTML="",a._renderCells(),a._rending=!1,a._triggerResize(),a._redrawRange()},_redrawRange:function(){var a=this,b=a._getRectOfNoteRange();a._setRange(b)},_onDownloadClick:function(a){var b,c,d,f=this,g=f.getCellElementByTarget(a.target),h=f.block;g&&(b=e(g).data("cellId"),(d=h.getCellById(b).cell)&&(c=d.getContent(),f.trigger("yne-download-attachment",c.getResource(),c.getFileName())))},_onClick:function(a){-1!==a.target.className.indexOf("attachment-download")&&this._onDownloadClick(a)},_onEnterLink:function(a){var b,c,d=this,f=e(a.target).closest("a").get(0),g=d.getCellElementByTarget(a.target),h=f.parentNode;b=e(g).data("cellId"),c=d.block.getCellById(b),!d.isOnCellEdit()&&c&&(h.innerText||"").trim()===(f.innerText||"").trim()&&(C.isNoteLinkUrl(f.href)||d.isCollabLocked()||!f||d.trigger("link-menu-show",{linkNode:f,block:d.block,range:l.create({block:d.block,type:l.TYPES.NORMAL,rect:{width:1,height:1,left:c.col,top:c.row}})}))},_onLeaveLink:function(){this.trigger("link-menu-hide")},_onMouseDown:function(a){var b=this;b.getCellElementByTarget(a)?this._handleDrag(a,i.DRAG_START,!0):b._setRange(l.TYPES.BLANK)},_onDblclick:function(){var a,b=this,c=b._getRectOfNoteRange();c&&!b.isLocked()&&(a=b.block.getCell(c.top,c.left,{findMergePointIfNeeded:!0,withPosition:!0}),b._cellEditView.showAndEdit(a))},_getTableRange:function(){var a,b=this,c=b._getNoteRange();if(c&&c.isInSingleBlock&&c.isInSingleBlock()&&(a=c.getStartBlockRange())&&a instanceof l&&a.block===b.block)return a},_getRectRange:function(){var a=this,b=a._getTableRange();if(b)return b.getAsRectRange()},_getRectOfNoteRange:function(){var a=this,b=a._getRectRange();return b&&b.getRect?b.getRect():null},_getNoteRange:function(){var a;return this.trigger("get-note-range",function(b){a=b}),a},_onDragStart:function(a){this._rectOnDragStart=null,this._handleDrag(a,i.DRAG_START)},_handleDrag:function(a,b,c){var d,f,h,j,k,l=this,m=l.getCellElementByTarget(a.target),n=a.shiftKey&&!a.ctrlKey&&!a.metaKey;if(d=e(m).data("cellId"),f=l.block.getCellById(d)){switch(j={width:1,height:1,left:f.col,top:f.row},b){case i.DRAG_START:if(n)k=l._getRectOfNoteRange(),l._rectOnDragStart=k,h=t.union(l._rectOnDragStart,j);else{if(c&&(k=l._getRectOfNoteRange(),t.contains(k,j)))return;h=l._rectOnDragStart=j}break;case i.DRAGGING:case i.DRAG_END:h=t.union(l._rectOnDragStart,j);break;default:g.error("unvalid drag type",b)}h&&l._setRange(h)}},_setRange:function(a){var b,c,d,e=this,f=l.TYPES.NORMAL;if(a)return a.width?d=a:f=a,b=l.create({block:e.block,type:f||l.TYPES.FIRST_CELL,rect:d}),c=new m({startRange:b,endRange:b}),e.trigger("set-range",c,!0,!0,!0),b},_onDragging:function(a){this._handleDrag(a,i.DRAGGING)},_onDragEnd:function(){this._handleDrag(event,i.DRAG_END),this._rectOnDragStart=null},_cancelEditMode:function(){g.log("hide cellEditView"),this._cellEditView.hide()},_setCellStyles:function(a,b){var c;c=b.textAlign,a.style.textAlign="center"===c||"right"===c||"left"===c?c:"",c=b.verticalAlign,a.style.verticalAlign="top"===c||"middle"===c||"bottom"===c?c:"",c=a.style.whiteSpace,!0===b.wrap?a.style.whiteSpace="pre-wrap":a.style.whiteSpace="nowrap",c!==a.style.whiteSpace&&this._triggerResize(),c=b.backColor,a.style.backgroundColor=c&&"inherit"!==c&&"transparent"!==c?c:""},_setRowHeight:function(a,b){var c=this,d=c._getRowElAt(a);d&&(d.style.height=b+"px",c._triggerResize())},_getRowElAt:function(a){var b=this,c=b.tableEl,d=c.tBodies[0];if(d)return d.rows[a]},getRowElHeight:function(a){var b=this._getRowElAt(a),c=0;return b?c=b.getBoundingClientRect().height:c},_renderColumns:function(a,c){if(!((a=a||0)>=c)){var d,e=this,f=e.block,g=f.getColumnCount(),h=e.colgroupEl,i=b.toArray(h.querySelectorAll("col"));for(c=c||g,d=a;d<c;++d)e._setColumnWidth(d,f.getColumnWidth(d));for(d=i.length-1;d>=g;--d)j(i[d])}},_setColumnWidth:function(a,b){var c=this,d=c._ensureColEl(a);d&&(d.style.width=b+"px",c._triggerResize())},_ensureColEl:function(a){var b,c=this,d=c._getColumnCount(),e=Math.max(a+1,d),f=c.colgroupEl,g=e-f.querySelectorAll("col").length,h=c._getColElAt(a);if(h)return h;for(b=0;b<g;++b)f.appendChild(document.createElement("col"));return c._getColElAt(a)},_getColumnCount:function(){var a=this.tableEl.rows[0];return a?a.cells.length:this.block.getColumnCount()},_getColElAt:function(a){if(!(a<0)){return this.colgroupEl.querySelectorAll("col")[a]}},getColElWidth:function(a){var b=this._getColElAt(a);return b?parseFloat(b.style.width):0},getCellElement:function(a){if(a&&a.getCellId&&(a=a.getCellId()),a)return this.$el.find('[data-cell-id="'+a+'"]:first').get(0)},getCellElementAt:function(a,b){var c=this,d=c.block.getCell(a,b,{findMergePointIfNeeded:!0});return c.getCellElement(d)},getCellTextElementAt:function(a,b){return this.getCellElementAt(a,b).querySelector(".table-cell-line > span")},getColumnIndex:function(a){var b=this,c=e(a).data("cellId"),d=b.block.getCellById(c);return d&&null!=d.col?d.col:null},getCellElementByTarget:function(a){if(a&&a.target&&(a=a.target),a)return e(a).closest("td").get(0)},getAbsoluteBoundingRectAt:function(a,b){var c=this,d=c.getBoundingRectAt(a,b),e=c._tableLayoutInnerEl.scrollLeft;if(d)return d.left-=e,d},getBoundingRectAt:function(a,b){var c=this.getCellElementAt(a,b);return this.getBoundingRect(c)},getBoundingRectByCell:function(a){var b=this,c=b.getCellElement(a);return b.getBoundingRect(c)},_triggerResize:function(){if(!this._rending){var a=this,b=a._tableLayoutEl,c=a._tableLayoutInnerEl,d=c.getBoundingClientRect().height;a._viewHeight!==d&&(a.trigger("resize",d),a._viewHeight=d,b.style.height=d+"px",a.trigger("view-height-changed",a.cid))}},getBoundingRect:function(a){if(a){var b=this,c=b.wrapperEl.getBoundingClientRect(),d=a.getBoundingClientRect();return{left:d.left-c.left,top:d.top-c.top,right:d.right-c.left,bottom:d.bottom-c.top,width:d.width,height:d.height}}},getEventBoundingRect:function(a){if(a){var b=this,c=b.wrapperEl.getBoundingClientRect();return{left:a.clientX-c.left,top:a.clientY-c.top}}},_onSetRowHeight:function(a,b){this._setCellsSize([{row:a,height:b}])},_onSetColWidth:function(a,b){this._setCellsSize([{col:a,width:b}])},_setCellsSize:function(a){this.trigger("command","comp.SetTableCellsSize",{table:this.block,sizes:a})},_onAttributeChanged:function(){this._reRenderCells()},_onRowHeightSet:function(a,b){this._setRowHeight(a,b)},_onColWidthSet:function(a,b){this._setColumnWidth(a,b)},_ensureRow:function(a){g.log("ensure the row has rendered",a)},_onColInserted:function(){this._reRenderCells()},_onColDeleted:function(){this._reRenderCells()},_onRowInserted:function(){this._reRenderCells()},_onRowDeleted:function(){this._reRenderCells()},_onCellInlineStyleChange:function(a,b){var c=this.getCellElementAt(a,b);this._renderCell(a,b,c)},_onCellBlockStyleChange:function(a,b,c,d){var e=this.getCellElementAt(a,b);e&&this._setCellStyles(e,d)},_onCellMouseEnter:function(a){var b=this;b.trigger("cell-enter",a,b)},_onCellMouseLeave:function(a){var b=this;b.trigger("cell-leave",a,b)},_onCellContentChange:function(a){var b,c=this,d=c.block.getCellById(a);return d?(c._ensureRow(d.row),(b=c.getCellElement(a))?(c._renderCell(d.row,d.col,b),void c._triggerResize()):void c._reRenderCells()):void g.error("unvalid cell info",d)},getHiddenInputView:function(){return this._hiddenInputView},getCellEditView:function(){return this._cellEditView},focusOutTbody:function(){this._setRange(l.TYPES.BLANK)},_setHeightByData:function(){var a,b=this,c=b.block,d=c.getRowCount(),e=b._tableLayoutEl,f=0;for(a=0;a<d;a++)f+=c.getRowHeight(a);b._viewHeight=f,e.style.height=f+"px"},getCellImageEl:function(a){var b=this,c=b.getCellElement(a);if(c)return c.querySelector("img")},getImageDomMapByTableRange:function(a){var b,c=a.tableRange,d=a.selectAll,e=this,f=e.block,g={};if(d&&(c=l.create({type:l.TYPES.ALL,block:f})),c&&(b=c.getAsRectRange()))return b.forEachCell(function(a){var b,c,d=a.getCellId();a.isImageCell()&&(b=e.getCellImageEl(d))&&(c=a.getContent(),g[f.getId()+"-"+c.getResId()]||(g[f.getId()+"-"+c.getResId()]={img:b,source:c.getSource()}))}),g},isLocked:function(){var a;return this._rending||this.trigger("get-read-only-status",function(b){a=b}),this.block.isLocked()||this.block.isReadOnly()||this._isReadOnly||a},selectTable:function(a){var b=this;if(!b._selectionView)return g.error("No selectionView find!");if(a){if(b._getRectOfNoteRange())return;b._selectionView.draw(l.create({block:this.block,type:l.TYPES.ALL}))}else b._selectionView.draw()},onDrawRange:function(a){var b,c,d=this;if(!d._selectionView)return g.error("No selectionView find!");if(a&&!a.isInBlank()){if(d._selectionView.draw(a),!(b=a.getAsRectRange()))return;c=b.getRect(),d._hiddenInputView.focus(d.getAbsoluteBoundingRectAt(c.top,c.left))}else d._selectionView.draw()},convertToNativeRange:function(){var a=this,b=document.createRange(),c=a.$el.get(0);return b.setStart(c,0),b.setEnd(c,c.childNodes.length),b},parseNativeRange:function(a,b,c){var d,f,g,h,i,j=this,k=j.block,m=a.startContainer,n=a.endContainer;return a.collapsed||(f=j.getCellElementByTarget(n))&&(h=k.getCellById(e(f).data("cellId"))),d=j.getCellElementByTarget(m),d&&(g=k.getCellById(e(d).data("cellId"))),g?j._setRange({top:g.row,left:g.col,height:h?h.row-g.row:1,width:h?h.col-g.col:1}):c||B.isNodeInRange(j.wrapperEl,a)||B.isRangeInNode(j.el,a)?(i=new l({block:k,type:l.TYPES.ALL}),j._selectionView.draw(i),i):void 0},onHighlight:function(a,c,d){function e(a){for(var b,e=a.getLength(),f=0,g=c.ignoreCase?a.toString().toLowerCase():a.toString(),h=j.indexOf(g,f);-1!==h;)b=document.createRange(),b.setStart(k,h),b.setEnd(k,h+e),d(b),h=j.indexOf(g,h+e)}function f(d){j=d.textContent,j=c.ignoreCase?j.toLowerCase():j,k=d,b.each(a,e)}var g,h,i,j,k,l=this,m=l.block,n=m.getRowCount(),o=m.getColumnCount();for(h=0;h<n;h++)for(i=0;i<o;i++)if(!m.isMergedCell(h,i)){if(g=m.getCell(h,i),k=l.getCellTextElementAt(h,i),!g.isTextNoEmptyCell()||!k)continue;b.map(k.childNodes,f)}},editCellFromToolbar:function(a,b){return this._cellEditView.editFromToolbar(a,b)},isOnCellEdit:function(){var a=this,b=a._cellEditView,c=a._hiddenInputView;return b&&b.isOnEdit()||c&&c.isOnEdit()},_onCellEditViewEnter:function(a){a&&(a.blockId=this.block.getId()),this.trigger("cell-edit-view-enter",a)},setPasteAsText:function(a){this._isPasteAsText=a||!1}},{isRangeInCellEditArea:function(a){return o.isRangeIn(a)||p.isRangeIn(a)}})}(),yne_common_views_TodoView=function(a){var b=yne_common_views_ParagraphView,c=yne_underscore,d=yne_common_jst;return b.extend({$checkbox:null,_checked:!1,name:"todo",className:"block-view todo-view",events:{"mousedown .todo-mark":"_onClick"},initialize:function(a){var d=this;b.prototype.initialize.apply(d,arguments),d.options=a,d.block=a.block,c.bindAll(d,"_blockCheckedChange"),d.block.on("checked-change",d._blockCheckedChange)},_renderTemplate:function(){var a=this;a.$el.html(d.render("common",a.name))},render:function(){var a=this,c=a.block;b.prototype.render.apply(a,arguments),a._blockCheckedChange(c.getChecked())},_blockCheckedChange:function(a){a?this.$el.addClass("checked"):this.$el.removeClass("checked"),this._checked=a},_onClick:function(a){a.preventDefault(),a.stopPropagation();var b=this._checked;this.trigger("command","comp.SetBlockProps",{blocks:[this.block],props:{checked:!b}})}})}(),yne_common_views_UnknownView=function(a){var b=yne_common_views_BlockView,c=yne_common_selection_UnknownRange;return b.extend({className:"block-view unknown-view",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},render:function(){var a=this;this.$el.html("<div>当前版本不支持的内容</div>"),b.prototype.render.apply(a,arguments)},convertToNativeRange:function(){},parseNativeRange:function(a,b,d){if(d)return new c({block:b})}})}(),yne_common_views_BlockViewMapper=function(a){var b=yne_common_data_blockTypes,c=yne_common_views_BlockView,d={};return d[b.ATTACHMENT]=yne_common_views_AttachmentView,d[b.CATALOGUE]=yne_common_views_CatalogueView,d[b.HANDWRITE]=yne_common_views_HandWriteView,d[b.HEADING]=yne_common_views_HeadingView,d[b.HR]=yne_common_views_HrView,d[b.IMAGE]=yne_common_views_ImageView,d[b.LIST_ITEM]=yne_common_views_ListItemView,d[b.PARAGRAPH]=yne_common_views_ParagraphView,d[b.TABLE]=yne_common_views_TableView,d[b.TODO]=yne_common_views_TodoView,d[b.UNKNOWN]=yne_common_views_UnknownView,function(a){var b=d[a];return b||c}}(),yne_common_views_HighlightView=function(a){var b=yne_backbone,c=yne_jquery,d=yne_underscore,e=yne_common_jst;return b.View.extend({className:"highlight-view",_baseRect:null,_focusIndex:-1,_list:[],initialize:function(){var a=this;d.bindAll(a,"_extractData","onHide","nextHighlight")},_extractData:function(a){var b=this,f=a.getClientRects(),g=[];d.each(f,function(a){a.width<2||g.push(c(e.render("common","high_light_item",{top:a.top-b._baseRect.top-1,left:a.left-b._baseRect.left-2,height:a.height-2,width:a.width})).appendTo(b.$el).get(0))}),b._list.push(c(g))},_reset:function(){this._list=[],this._focusIndex=-1,this.$el.empty()},showHighlight:function(a,b){var c=this;return a&&b?0===b.length?(c._reset(),void c.onHide()):(c.$el.empty(),c.$el.show(),c._list=[],c._baseRect=c.el.getBoundingClientRect(),d.each(b,c._extractData),c._focusIndex=0,c._list[c._focusIndex].addClass("focused"),void c._list[c._focusIndex].get(0).scrollIntoViewIfNeeded()):(c._reset(),void c.onHide())},nextHighlight:function(a){var b=this;0!==b._list.length&&(b.$el.show(),a=a||1,b._list[b._focusIndex].removeClass("focused"),b._focusIndex=(b._focusIndex+b._list.length+a)%b._list.length,b._list[b._focusIndex].addClass("focused"),b._list[b._focusIndex].get(0).scrollIntoViewIfNeeded())},preHighlight:function(){this.nextHighlight(-1)},onHide:function(){this.$el.hide()}})}(),yne_common_data_HeaderFooter=function(a){var b,c=yne_jtk_core_Base,d=yne_jquery,e=yne_underscore,f=yne_common_data_blockTypes,g=yne_common_util_unknownTree;return b=c.extend({_type:f.HEADER_FOOTER,_blockId:null,_locked:!1,_isReadOnly:!1,initialize:function(a){a=a||{};var b=this;b._blockId=a.isFooter?"footer-fixed-id":"header-fixed-id",b._content=a.content||"",b._align=a.align||"center",b.isFooter=!0===a.isFooter,b.unknownTree={},b.unknownStyles={}},getContent:function(a,c){return b.format(this._content,c)},getType:function(){return this._type},setAlign:function(a){this._align=a},getAlign:function(){return this._align},getBlockStyle:function(a){if("align"===a)return this.getAlign()||"center"},setContent:function(a){this._content=a},setContentAndStyle:function(a,b){var c=this;null!=a&&(this._content=a),null!=b&&(c._align=b),c.trigger("change",a,b)},toXml:function(a){var b,c=this,d=c.isFooter?"footer":"header",e=a.createElement(d),f=a.createElement("styles"),h=a.createElement("text"),i=a.createTextNode(c.getContent());return h.appendChild(i),e.appendChild(h),b=a.createElement("align"),b.appendChild(a.createTextNode(c.getAlign())),f.appendChild(b),g.appendToXml(c.unknownStyles,f),e.appendChild(f),g.appendToXml(c.unknownTree,e),e.setAttribute("compat","true"),e},getInfo:function(){var a=this;return{content:a.getContent(),align:a.getAlign(),isFooter:a.isFooter}},getId:function(){return this._blockId},setId:function(a){this._blockId=a},setLocked:function(a,b){var c=this;c._locked===a&&b&&!b.lockUpdated||(c._locked=a,c.trigger("locked-change",b))},isLocked:function(){return this._locked},isValidForCollab:function(){return!0},resetLockState:function(){this._locked=!1},toCollabJSON:function(){return{headerFooterInfo:this.getInfo()}},setReadOnly:function(a){this._isReadOnly=!!a},isReadOnly:function(){return this._isReadOnly},highlight:function(a,b,c){this.trigger("high-light",a,b,c)},getHighlight:function(a){if(a&&a.length){var b=this,c=b._content,d=[];return e.each(a,function(a){for(var b=a.getLength(),e=0,f=c.indexOf(a,e);-1!==f;)d[f]={start:f,end:f+b},f=c.indexOf(a,f+b)}),d=e.compact(d),d.length?d:null}}},{format:function(a,b){return a?(b=b||{},null!=b.pageIndex&&(a=a.replace(/:p/,b.pageIndex+1)),b.pageCount&&(a=a.replace(/:n/,b.pageCount)),a):a},parse:function(a,b){return a.replace(/\d+/,function(a){return parseInt(a,10)===b.pageIndex+1?":p":a}).replace(/\d+/,function(a){return parseInt(a)===b.pageCount?":n":a})},fromXml:function(a){var c=d(a),e=c.find(">text").text(),f=c.find("styles>align").text(),h=new b({content:e,align:f,isFooter:"footer"===a.nodeName});return c.children().each(function(a,b){switch(b.nodeName){case"text":break;case"styles":d(b).children().each(function(a,c){"align"!==c.nodeName&&g.appendToTree(h.unknownStyles,b)});break;default:g.appendToTree(h.unknownTree,b)}}),h},createBlank:function(a){return new b({content:"",isFooter:!0===a})}})}(),yne_common_util_insertTextAtCursor=function(a){var b,c;window.getSelection?(b=window.getSelection(),b.getRangeAt&&b.rangeCount&&(c=b.getRangeAt(0),c.deleteContents(),c.insertNode(document.createTextNode(a)))):document.selection&&document.selection.createRange&&(document.selection.createRange().text=a)},yne_common_views_HeaderFooterView=function(a){function b(a){var b=null;do{f.contains(a.classList,k)&&(f.contains(a.classList,"page-header")?b="header":f.contains(a.classList,"page-footer")&&(b="footer")),a=a.parentElement}while(a);return b}var c=yne_backbone,d=yne_common_jst,e=yne_jquery,f=yne_underscore,g=yne_jtk_core_L,h=yne_common_key_KeyMonitor,i=yne_common_util_insertTextAtCursor,j=e('<div class="collab-editing-view-wrapper"><div class="collab-session-view"></div></div>'),k="header-footer-view";return c.View.extend({className:k,name:"header-footer",_focus:!1,_isReadOnly:!1,$input:null,events:{"focus .header-footer-input":"_onFocus","blur .header-footer-input":"_onBlur","keydown .header-footer-input":"_onKeyDown","input .header-footer-input":"_onTextInput","paste .header-footer-input":"_onPaste"},initialize:function(a,b){a=a||{};var c=this;c.block=a,c._contentOnFocus=null,c._keyMonitor=new h({el:c.el}),c.isFooter=!0===a.isFooter,c._isReadOnly=!!b,f.bindAll(c,"_onLockedChange","_updateViewByModel","_onPaste","_onHighlight"),a.on("high-light",c._onHighlight),a.on("locked-change",c._onLockedChange),a.on("change",c._updateViewByModel),this.render()},render:function(){var a,b=this,c=b.block,e=b.$el,f="page-"+(c.isFooter?"footer":"header"),g="点击编辑"+(c.isFooter?"页脚":"页眉");a=d.render("common",b.name,{readonly:b._isReadOnly}),e.html(a),e.addClass(f).attr("title",g),b.$input=e.find(".header-footer-input"),b._updateViewByModel(c.getContent(),c.getAlign()),b._updateLockState(b.isLocked())},_updateViewByModel:function(a,b){this._focus||void 0===a||this.setContent(a),void 0!==b&&this.setAlign(b)},_onHighlight:function(a,b,c){var d=this,e=d.block,f=e.getHighlight(a,b);f&&d._convertToData(f,c)},_convertToData:function(a,b){var c,d=this,e=d.$input.get(0).firstChild;f.each(a,function(a){c=document.createRange(),c.setStart(e,a.start),c.setEnd(e,a.end),b(c)})},_onPaste:function(a){var b,c,d=a.originalEvent;a.preventDefault(),d.clipboardData&&d.clipboardData.getData?(b=d.clipboardData.getData("text/plain"),c=b&&b.replace(/\r?\n/g," "),document.execCommand("insertHTML",!1,c)):window.clipboardData&&window.clipboardData.getData&&(b=window.clipboardData.getData("Text"),i(b))},_onLockedChange:function(a){var b=this;b._updateLockState(b.isLocked()),b._updateLockIndicator(b.block.isLocked(),a),b.trigger("locked-change")},isLocked:function(){var a=this,b=a.block,c=!1;return b&&(c=b.isLocked()),c},_updateLockIndicator:function(a,b){var c=this,d=j.clone(),e=d.find(".collab-session-view"),f=b&&b.lockColor,g=b&&b.nickname;a?(c.$el.addClass("collab-editing-view"),void 0!==g&&(e.css("background-color",f),e.text(g),c.$el.find(".collab-editing-view-wrapper").remove(),c.$el.prepend(d))):(c.$el.removeClass("collab-editing-view"),c.$el.find(".collab-editing-view-wrapper").remove())},_updateLockState:function(a){var b=this;a?b.$el.addClass("collab-locked"):b.$el.removeClass("collab-locked")},_onTextInput:function(){this.trigger("text-input",this.$input.text())},_onFocus:function(){var a=this;a._focus=!0,a._contentOnFocus=a.$input.text()||"",g.log("content on focus: "+a._contentOnFocus),a.trigger("focus")},_onBlur:function(){var a=this,b=a.$input.text();a._focus=!1,g.log("content on blur: "+b),b!==a._contentOnFocus&&a.trigger("text-change",b),a.trigger("blur"),a._contentOnFocus=null},_stopPropagation:function(a){a.stopPropagation()},_onKeyDown:function(a){var b=this,c=["mod+s","mod+shift+r","mod+f"],d=!1,e=b._keyMonitor;e.isEventMatchKey(a,"enter")?(a.stopPropagation(),a.preventDefault(),b.$el.blur()):e.isEventMatchKey(a,"tab")?(a.stopPropagation(),a.preventDefault(),document.execCommand("insertHTML",!1,"&emsp;")):e.isEventMatchKey(a,"mod+z")||e.isEventMatchKey(a,"mod+y")?(a.stopPropagation(),a.preventDefault()):(d=f.some(c,function(b){return e.isEventMatchKey(a,b)}),d?a.preventDefault():a.stopPropagation())},getAlign:function(){return this.$input.css("text-align")},setAlign:function(a){var b=this,c="left"===a||"right"===a?a:"center";b.$input.css("text-align",c)},setContent:function(a){this.$input.text(a)},getContent:function(){return this.$input.text()},checkChange:function(){var a=this,b=a.$input.text()||"";null!=a._contentOnFocus&&b!==a._contentOnFocus&&(a.trigger("text-change",b),a._contentOnFocus=b)}},{isHeaderView:function(a){return"header"===b(a)},isFooterView:function(a){return"footer"===b(a)}})}(),yne_common_views_NoteView=function(a){var b=yne_underscore,c=yne_jquery,d=yne_backbone,e=yne_common_constants,f=yne_common_key_KeyMonitor,g=yne_common_selection_AttachmentRange,h=yne_common_selection_ImageRange,i=yne_common_selection_NoteRange,j=yne_common_selection_nativeSelection,k=yne_common_selection_BlockRangeMap,l=yne_common_data_blockTypes,m=yne_common_views_BlockViewMapper,n=yne_jtk_core_assert,o=yne_jtk_web_dom_nodeType,p=yne_common_util_userAgent,q=yne_jtk_core_L,r=yne_common_util_events,s=yne_common_util_noteLink,t=yne_common_util_userAgent,u=yne_common_views_HighlightView,v=yne_common_data_HeaderFooter,w=yne_common_views_HeaderFooterView,x=yne_common_views_TableView;return d.View.extend({className:"note-view",attributes:{tabIndex:1,spellcheck:!1,contenteditable:"true"},directionKeyJustMoved:!1,events:{textInput:"_onTextInput",compositionstart:"_onCompositionStart",compositionend:"_onCompositionEnd",mousedown:"_onMouseDown",selectstart:"_onSelectStart",contextmenu:"_onContextMenu",dragstart:"_onDragDropEvent",dragover:"_onDragDropEvent",drop:"_onDragDropEvent",dragend:"_onDragEnd",copy:"_onCopy",cut:"_onCut",paste:"_onPaste","click a[href]":"_onAnchorClick",click:"_onClick",blur:"_onBlur",focus:"_onFocus"},note:null,blockViews:null,tableViews:null,headerView:null,footerView:null,_keyMonitor:null,_inlineStyleViewMapper:null,isOnComposition:!1,_isSilent:!1,_noteEvents:{"insert-block":"_onInsertBlock","remove-block":"_onRemoveBlock","replace-block":"_onReplaceBlock","read-only-change":"_onReadOnlyChange","high-light":"_onHighlight","next-high-light":"_onNextHighlight","pre-high-light":"_onPreHighlight","content-parse-done":"_onContentParseDone","header-footer-changed":"_OnHeaderFooterChanged"},_docEvents:{selectionchange:"_onSelectionChange"},_shouldStopComposition:!1,_affectedViewsByComposition:null,_pageBatchTimer:null,_pageBatchPendingQueue:null,_viewMode:null,_renderBatchTimer:null,_currentZoom:null,_disableOCR:null,initialize:function(a){var b=this;b._bindEventHandlers(),b.setOptions(a),b._bindEventsForDoc(),b._bindEventsForThis(),b.highlightView=new u,b._pageBatchPendingQueue=[],a.inlineStyleViewMapper&&(b._inlineStyleViewMapper=a.inlineStyleViewMapper),b._currentZoom=1},createHeaderFooterView:function(a){var b,c,d,e;if(b=this,null!=(c=b.note))return d=c.getHeaderFooter(a),d||(d=v.createBlank(a),c.setHeaderFooter(d,a)),e=new w(d,b.isReadOnly()),e.on("focus",function(){b.trigger("set-range",i.createForHeaderFooter(d),!0,!0)}).on("blur",function(a){b.trigger("selectionchange",a)}).on("text-input",function(a){b.trigger("header-footer-view-text-change",a,e.block)}),e},_renderHeaderFooterView:function(a){a.prepend(this.headerView.$el),a.append(this.footerView.$el)},_removeHeaderFooterView:function(){null!=this.headerView&&(this.headerView.remove(),this.headerView=null),null!=this.footerView&&(this.footerView.remove(),this.footerView=null)},_OnHeaderFooterChanged:function(a){var b=this,c=b.options.noteviewFrame;b.isInPageMode()&&(a?(null!=b.footerView&&b.footerView.remove(),b.footerView=b.createHeaderFooterView(a),null!=c&&c.append(this.footerView.$el)):(null!=b.headerView&&b.headerView.remove(),b.headerView=b.createHeaderFooterView(a),null!=c&&c.prepend(this.headerView.$el)))},_bindEventHandlers:function(){var a=this,c=function(c){q.log("bindHandlers: "+c),b.bindAll(a,c)};b.each(a._noteEvents,c),b.each(a._docEvents,c)},_setNote:function(a){var b=this;b.removeNote(),b.note=a,b._bindEventsForNote()},removeNote:function(){var a=this;a.note&&a._unbindEventsForNote(),a.note=null},reset:function(){var a,b=this;if(b.removeNote(),b.$el.html(""),b.blockViews=b._clearBlockViews(b.blockViews),b.options&&(b.options.note=null,b.options.isNoteSet=!1,(a=b.options.noteviewFrame)&&(a.find(".header-footer-input").prop("contenteditable",!0),a.removeClass("has-handwrite"))),b.$el.removeClass("read-only"),b._keyMonitor&&b._keyMonitor.clearCache(),c(document.head).find("style.note-style").remove(),b._isSilent=!1,window.parent!==window){window.getSelection().removeAllRanges()}b._pageBatchTimer&&(window.clearTimeout(b._pageBatchTimer),b._pageBatchTimer=null),b._renderBatchTimer&&(clearTimeout(b._renderBatchTimer),b._renderBatchTimer=null),b._pageBatchPendingQueue=[],b._removeHeaderFooterView()},setOptions:function(a){var c=this;if(a=a||{},null==c.options)c.options=b.clone(a);else for(var d in a)a.hasOwnProperty(d)&&(c.options[d]=a[d]);null!=c.options.note&&c._setNote(c.options.note),null!=c.options.viewMode&&(c._viewMode=c.options.viewMode),c._disableOCR=!!c.options.disableOCR},render:function(){var a=this,b=a.$el,d=a.highlightView,e=a.options.noteviewFrame;a.blockViews=a.blockViews?a._clearBlockViews(a.blockViews):[],a.tableViews=[],b.html(""),c(document.head).find("style.note-style").remove(),c(document.head).append('<style class="note-style"></style>'),b.append(d.$el),a.isInPageMode()?a._enablePageMode(!1):a._disablePageMode(a._viewMode),null!=e&&e.find(".header-footer-input").prop("contenteditable",!a.isReadOnly()),null!=a._renderBatchTimer&&(clearTimeout(a._renderBatchTimer),a._renderBatchTimer=null),a._renderInBatch(0)},_renderInBatch:function(a){var b,c,d=this,e=d.note,f=Date.now();if(null!=e){for(;a<e.blocks.length&&(b=e.blocks[a],c=d._createBlockView(b),c||q.warn("Failed to create block view!"),d.blockViews.push(c),d.$el.append(c.$el),c.render(),d._bindEventsForBlockView(b,c),d._setPageInfo(a),a++,!(Date.now()-f>100)););a<e.blocks.length&&(d._renderBatchTimer=setTimeout(d._renderInBatch.bind(d,a),10))}},_repairBlockViews:function(a){var c,d,e,f=this,g=[];a&&a.length>0&&(c=a.shift(),g.push(c),a.length>0&&(d=a.pop(),g.push(d)),f._isElementExisting(c.cid)||(e=f.getBlockViewIndex(c)-1,e>=0?f.getBlockViewAt(e).$el.after(c.$el):f.getBlockViewAt(0).$el.before(c.$el)),d&&!f._isElementExisting(d.cid)&&c.$el.after(d.$el),f.reRenderTextBlockView(g),b.each(a,function(a){f._isElementExisting(a.cid)||d.$el.before(a.$el)}))},_isElementExisting:function(a){var b,c=this;return b=c.$el.find('[data-yne-cid="'+a+'"]'),b.length>0},reRenderTextBlockView:function(a){var c=this;a=a||c.blockViews,b.each(a,function(a){var b=a.block;l.isTextBlock(b)&&a.render()})},_listenerEventsForBlockView:function(a){var c={command:"onCommand","get-read-only-status":"_onGetReadOnlyStatus"};return l.isTable(a)&&(c=b.extend(c,{"select-all":"onSelectAll","save-content":"_onSaveContent"})),c},_bubbleEventsForBlockView:function(a){var c={"locked-change":!0};switch(l.getType(a)){case l.IMAGE:c=b.extend(c,{"yne-replace-image":!0,"yne-open-image":!0,"yne-download-image":!0,"get-image-items":!0,"img-title-edit-start":!0,"img-title-edit-end":!0,"img-title-edit-focus":!0,"img-title-edit-exit":!0,"img-title-edit-update":!0,"yne-image-ocr":!0});break;case l.ATTACHMENT:c=b.extend(c,{"yne-replace-attachment":!0,"yne-open-attachment":!0,"yne-download-attachment":!0});break;case l.TABLE:c=b.extend(c,{"yne-download-attachment":!0,"yne-on-paste":!0,"get-note-range":!0,"link-menu-show":!0,"link-menu-hide":!0,"move-caret":!0,"set-range":!0,"global-redo":!0,"global-undo":!0,copy:!0,cut:!0,"cell-edit-view-selection-change":!0,"cell-edit-view-enter":!0,"cell-edit-view-exit":!0,"cell-edit-view-history-change":!0,"cell-edit-view-command-executed":!0,"yne-blob-paste":!0});break;case l.PARAGRAPH:case l.HEADING:c=b.extend(c,{"link-menu-show":!0,"link-menu-hide":!0});break;case l.LIST_ITEM:c=b.extend(c,{"get-editing-styles":!0,"link-menu-show":!0,"link-menu-hide":!0});break;case l.CATALOGUE:c=b.extend(c,{"inner-goto":!0})}return c},_unbindEventsForBlockView:function(a,c){var d=this,e=function(a){a&&b.each(a,function(a,b){c.off(b)})};e(d._listenerEventsForBlockView(a)),e(d._bubbleEventsForBlockView(a))},_bindEventsForBlockView:function(a,b,c){var d,e=this;c=!1!==c,c&&e._unbindEventsForBlockView(a,b),d=e._listenerEventsForBlockView(a),r.addListeners(d,b,e),d=e._bubbleEventsForBlockView(a),r.bubble(d,b,e)},setHtmlContentEditable:function(a){this.$el.attr("contenteditable",!!a)},getHtmlContentEditable:function(){return"true"==this.el.contentEditable+""},updateFormatPainterCursorUI:function(a){a?this.$el.addClass("format-painter-active"):this.$el.removeClass("format-painter-active")},_handleNoteEvents:function(a){var c=this,d=c.note;if(!d||!d.on||!d.off)return void q.warn("Failed to bind note events!");b.each(c._noteEvents,function(b,e){a?d.on(e,c[b]):d.off(e,c[b])})},_bindEventsForNote:function(){this._handleNoteEvents(!0)},_unbindEventsForNote:function(){this._handleNoteEvents(!1)},_bindEventsForDoc:function(){var a=this,d=c(document);b.each(a._docEvents,function(b,c){q.log("bind document event: "+c+" -> "+b),q.log(a[b]),d.on(c,a[b])})},_bindEventsForThis:function(){var a=this;a.on("draw-range",a._onDrawRange.bind(a)),a.on("resize",a._onResize.bind(a))},_onChangeHandwriteBlock:function(a){var b=this.options.noteviewFrame;a?b.addClass("has-handwrite"):this.note.hasHandWriteBlock()||b.removeClass("has-handwrite")},bindKey:function(a){var b=this,c=b._keyMonitor;a&&(c||(b._keyMonitor=c=new f({el:b.el})),c.unbind(a),c.bind(a,function(c){b.trigger("key-pressed",a,c)}),b._keyMonitor=c)},unbindKey:function(a){var b=this,c=b._keyMonitor;c&&a&&c.unbind(a)},_onDrawRange:function(a,b){var c=this;c._silentDo(function(){c._drawRange(a,b)})},_updateSelectionUI:function(a){var b,c,d,e,f,g,h=this;return q.log("_updateSelectionUI....."),a?null==h.note?void q.warn("Note has been dettached."):(i.isNoteRange(a)?(d=a.getStartBlockRange(),e=a.getEndBlockRange(),b=h.note.getBlockIndex(d.block),c=h.note.getBlockIndex(e.block)):(f=h.getBlockViewContainer(a.startContainer),g=h.getBlockViewContainer(a.endContainer),b=h.getBlockViewIndex(f),c=h.getBlockViewIndex(g)),h._selectAttachments(b,c,a),void h._selectCatalogueTables(b,c)):void q.warn("The range is not valid!")},_selectAttachments:function(a,c){var d=this;if(-1===a||-1===c)return void q.warn("start or end is -1");a!==c&&b.each(d.blockViews,function(b,d){if(b){var e=d>=a&&d<=c;b.selectAttachment&&b.selectAttachment(e)}})},_selectCatalogueTables:function(a,c){var d,e=this,f=[];-1!==a&&-1!==c&&b.each(e.blockViews,function(b,e){if(b){var g=e>=a&&e<=c;if(b.selectTable)return void b.selectTable(g);if(b.selectCatalogue){if(d=b.getOwnerId(),!g&&f[d])return;f[d]=!0,
b.selectCatalogue(g)}}})},_drawRange:function(a,b){if(!a||!a.canDrawedByNative)return void q.log("note range is not valid!");q.log("on draw range",a);var c,d,e,f=this,g=a.getStartBlockRange(),h=g.block;if(b=!1!==b,f._clearCustomSelectionUI(h),a.canDrawedByNative())f.setHtmlContentEditable(!0),f._updateSelectionUI(a),c=a.toNativeRange(f),j.setRange(c,window),b&&f._scrollNativeSelectionIntoWrapper(c);else{if(f.setHtmlContentEditable(!1),a.isInMultiBlock())return void q.warn("The note range is note valid!");g=a.getStartBlockRange(),null!=f.note&&(d=f.note.getBlockIndex(g.block),(e=f.getBlockViewAt(d))&&e.trigger("draw-range",g,h))}},_isZeroRect:function(a){return!a||0===a.width&&0===a.height},_scrollNativeSelectionIntoWrapper:function(a){var b,c,d=this;return a?(a.collapsed?(b=a.getClientRects()[0],d._isZeroRect(b)&&(b=a.getBoundingClientRect())):b=a.getBoundingClientRect(),d._isZeroRect(b)&&(c=a.commonAncestorContainer,1!==c.nodeType&&(c=c.parentNode),b=c.getBoundingClientRect()),d._isZeroRect(b)?void q.error("can not get selection client rect"):void d._scrollRectIntoWrapper(b)):void q.warn("range not found")},_getWrapper:function(){for(var a=this,b=a.el.parentNode;b;){if(c(b).is(".note-view-wrapper"))return b;b=b.parentNode}},_scrollRectIntoWrapper:function(a){var b=this,c=11,d=b._getWrapper(),e=d.getBoundingClientRect(),f=e.top,g=e.bottom,h=e.height,i=e.left,j=e.right,k=a.top*b._currentZoom,l=a.bottom*b._currentZoom,m=a.height*b._currentZoom,n=a.left*b._currentZoom,o=null,p=null,q=10;b._isZeroRect(a)||(d.scrollHeight!==d.clientHeight&&(g-=c,h-=c),d.scrollBarWidth!==d.clientWidth&&(j-=11),m>h?(l<0||k>h)&&(p=l-h):k<f||k-f<=q?p=-1*Math.abs(k-f):l>g||g-l<=q?p=Math.abs(l-g):l===g&&(p=10),n>=j||j-n<=q?o=Math.abs(n-j):(n<=i||n-i<=q)&&(o=-1*Math.abs(n-i)),b._scrollWrapperBy(o,p))},_scrollWrapperBy:function(a,c){var d=this._getWrapper();a>0?a+=20:a<0&&(a-=20),c>0?c+=20:c<0&&(c-=20),b.isNumber(a)&&(d.scrollLeft+=a),b.isNumber(c)&&(d.scrollTop+=c)},parseNativeRange:function(a){if(!a||!a.startContainer)return void q.warn("no native range!");var b=this,c=a.startContainer,d=a.endContainer;if(w.isHeaderView(c))return[new k[l.HEADER_FOOTER]({block:b.note.getHeaderFooter(!1)})];if(w.isFooterView(c))return[new k[l.HEADER_FOOTER]({block:b.note.getHeaderFooter(!0)})];var e,f,g,h,i=b.getBlockViewContainer(c),j=b.getBlockViewContainer(d),m=b.getBlockViewIndex(i),n=b.getBlockViewIndex(j),o=[];if(-1===m||-1===n)return void q.warn("start/end block index is -1 !");if(null==b.note)return void q.warn("note has been dettached.");for(q.log("start/end block index "+m+"/"+n),e=m;e<=n;e++)g=b.blockViews[e],f=b.note.getBlockAt(e),h=g.parseNativeRange(a,f,e!==m&&e!==n),h?o.push(h):q.warn("Failed to parse native range to block range!");return o},_isRangeInTableBlock:function(){return j.isRangeInSelector(".block-view.table-view")},_onSelectionChange:function(a){var b=this,c=!j.isRangeInNode(b.el),d=j.getRange(),e=null;if(b._updateSelectionUI(d),c?e="The native range is not in note view!":x.isRangeInCellEditArea(d)?e="The native range is in table cell edit area":b._isSilent?e="The _isSilent flag is true!":b.isOnComposition&&(e="The isOnComposition flag is true!"),e)return q.log("XXXXXXXdocument selection change deprecated!XXXXXXXX"),void q.log(e);if(b._isRangeInTableBlock()){if(!b.directionKeyJustMoved)return e="The selection/range is in table box!",q.log("  selection change deprecated!XXXXXXX"),void q.log(e);b.directionKeyJustMoved=!1}q.log("-------------document selection change--------"),b.trigger("selectionchange",a),b._scrollNativeSelectionIntoWrapper(d)},_silentDo:function(a){var b=this;if(b._isSilent=!0,q.DEBUG)a();else try{a()}catch(a){q.warn("silent do error")}window.setTimeout(function(){b._isSilent=!1},0)},clearNativeSelectionUI:function(){j.getSelection(window).removeAllRanges()},_clearCustomSelectionUI:function(a){var c=this,d=c.blockViews;b.each(d,function(b){b.trigger("draw-range",null,a)})},_appendBlankLineIfNeed:function(){var a,b=this,c=b.note;c&&((a=c.getLastBlock())&&(!a||c.lastBlockIsEasyInput()&&!a.isLocked())||b.trigger("note-append-blankparagraph",a))},focusLastBlankLine:function(){var a=this;a._appendBlankLineIfNeed(),window.setTimeout(function(){var b=a.getLastBlockView();c(b.el).trigger("mousedown")},50)},isReadOnly:function(){var a=this,b=a.note;return null==b||b&&b.isReadOnly()},_onGetReadOnlyStatus:function(a){var b=this;a&&a(b.isReadOnly())},_isAtEndOfTextBlock:function(a,b){if(!document.caretRangeFromPoint)return!1;var d,e,f=document.caretRangeFromPoint(a.clientX,a.clientY),g=b.querySelector(".para-text");if(!g||!f||!f.collapsed)return!1;if(d=f.commonAncestorContainer,o.isText(d)){if(f.startOffset!==d.nodeValue.length)return!1;d=d.parentNode}if(!c.contains(g,d))return!1;for(;d&&d!==g;){if(e=d.parentNode,e.lastChild!==d)return!1;d=e}return!0},_onMouseDown:function(a){var b,d,e,f,g,h,j,m=this,n=3===(a.keyCode||a.which);if(m.highlightView.$el.remove(),m.$el.removeClass("highlight"),!m.isReadOnly()&&(b=m.getBlockViewContainer(a.target),d=m.getBlock(a.target),m._preventSelectStart=!1,!n||(t.isSafari()&&m._isAtEndOfTextBlock(a,b)&&(m._preventSelectStart=!0),c(b).is(".image-view, .attachment-view, .table-view")))){if(!d||d.isLocked())return q.log("_onMouseDown(): block is null or locked!"),void m.focusLastBlankLine();if(m.trigger("mouse-down",a),e=l.getType(d),h=k[e])switch(f=new h({block:d}),g=new i({startRange:f,endRange:f}),e){case l.IMAGE:case l.ATTACHMENT:case l.HANDWRITE:m.setHtmlContentEditable(!0),b.focus(),m.trigger("set-range",g,!0,!0);break;case l.TODO:case l.PARAGRAPH:case l.LIST_ITEM:case l.HEADING:case l.CATALOGUE:a.detail>2?(a.preventDefault(),f.expandToEnd(),j=!0):(j=!1,g=document.caretRangeFromPoint(a.clientX,a.clientY)),m.setHtmlContentEditable(!0),m._clearCustomSelectionUI(),m.trigger("backup-drag-range"),m.trigger("set-range",g,j,!0);break;case l.TABLE:break;case l.HR:m.trigger("set-range",g,!0,!0);break;case l.UNKNOWN:m.setHtmlContentEditable(!1),m.trigger("set-range",g,!0,!0)}else q.warn("_onMouseDown is not handled, block type is "+e);m.lastBlock=d}},_onAnchorClick:function(a){var b,c=a.currentTarget;if(a.preventDefault(),b=c&&c.getAttribute("href"))return s.isNoteLinkUrl(b)?this.trigger("open-link",s.getNoteId(b),!0):void this.trigger("open-link",b)},_onSelectStart:function(a){if(!0===this._preventSelectStart)return a.preventDefault(),a.stopPropagation(),!1;this.trigger("selectstart",a)},_onTextInput:function(a){var b,c,d=this;q.log("------------------ noteview text input event ----------"),a.preventDefault(),d.isReadOnly()||(c=a.originalEvent||a)&&(b=c.data+"")&&d.trigger("text-input",b)},_onCompositionStart:function(a){var b=this;return b.isReadOnly()?void a.preventDefault():(q.log("note view compositionstart ----------\x3e>>>>>"),window.clearTimeout(b._compositionEndTimer),b.setCompositionState(!0),b._shouldStopComposition=!1,b._affectedViewsByComposition=null,b.trigger("onCompositionStart",function(a,c){b._shouldStopComposition=a,b._affectedViewsByComposition=c}),b._shouldStopComposition?(a.preventDefault(),void a.stopPropagation()):void b.trigger("delete-selection"))},_onCompositionEnd:function(a){var b=this,c=a.originalEvent||a;if(b.isReadOnly()||b._shouldStopComposition)return a.preventDefault(),void(b._affectedViewsByComposition&&b._repairBlockViews(b._affectedViewsByComposition));q.log("note view compositionend ----------\x3e>>>>>"),c.data||b.trigger("delete-selection"),b._compositionEndTimer=window.setTimeout(function(){b.setCompositionState(!1)},0)},setCompositionState:function(a){var b,c=this;a&&(b=j.getRange(),c.trigger("set-range",b,!1,!1)),c.isOnComposition=a},_onInsertBlock:function(a,b){var c=this,d=c._createBlockView(b);n(d),c._bindEventsForBlockView(b,d),c._insertBlockView(a,d)},_onRemoveBlock:function(a,b){var c=this;c._removeBlockView(a),!1!==b&&c._setPageInfo(a)},_onReplaceBlock:function(a,b){var c=this,d=c._createBlockView(b);n(d),c._replaceBlockView(a,d)},_createBlockView:function(a){var b,c=this,d=l.getType(a),f=m(d),g={};return q.log("block Type",a,d),c.isInPageMode()?c.options.pageType===e.PAGE_TYPE_A4?(g.height=e.PAGE_HEIGHT_A4,g.width=e.PAGE_WIDTH_A4):c.options.pageType===e.PAGE_TYPE_B5?(g.height=e.PAGE_HEIGHT_B5,g.width=e.PAGE_WIDTH_B5):c.options.pageType===e.PAGE_TYPE_TEST?(g.height=e.PAGE_HEIGHT_TEST,g.width=e.PAGE_WIDTH_TEST):c.options.pageType===e.PAGE_TYPE_NONE?(g.height=e.PAGE_HEIGHT_NONE,g.width=e.PAGE_WIDTH_NONE):(q.debugAlert("Invalid pageType in PageMode:",c.options.pageType),g.height=e.PAGE_HEIGHT_NONE,g.width=e.PAGE_WIDTH_NONE):(g.height=e.PAGE_HEIGHT_NONE,g.width=e.PAGE_WIDTH_NONE),n(!!f),b=new f({editor:c.options.editor,block:a,isReadOnly:a.isReadOnly(),inlineStyleViewMapper:c._inlineStyleViewMapper,pageSize:g,pageBreakContainer:c.options.noteviewFrame,noteView:c,disableOCR:c._disableOCR}),b.on("view-height-changed",c._onBlockViewHeightChanged.bind(c)),b.on("pageBreak-inserted",c._onPageBreakInserted.bind(c)),b.on("pageBreak-positionChanged",c._onPageBreakPosChanged.bind(c)),b instanceof m(l.HANDWRITE)&&c._onChangeHandwriteBlock(!0),b},_insertBlockView:function(a,b){var c=this,d=c.blockViews,e=c.$el,f=e.children().filter(".block-view"),g=f.length;d.splice(a,0,b),a===g?e.append(b.$el):f.eq(a).before(b.$el),b.render()},_removeBlockView:function(a){var c,d,e,f,g,h=this,i=h.blockViews,j=h.$el,k=h.tableViews;c=i.splice(a,1),d=c[0],f=b.indexOf(k,d),f>=0&&k.splice(f,1),g=j.children().filter(".block-view"),e=g.eq(a),e&&(e.attr("data-yne-cid")===d.cid?g.eq(a).remove():q.warn("skip div deletion whose attr is "+e.attr("data-yne-cid"))),d instanceof m(l.HANDWRITE)&&h._onChangeHandwriteBlock(!1),d.clearPageBreaks(),d.onDestroy()},_replaceBlockView:function(a,b){var c=this,d=c.blockViews,e=c.$el;c._clearBlockViews(d.splice(a,1,b)),e.children().filter(".block-view").eq(a).replaceWith(b.$el),b.render()},getBlockViewAt:function(a){return this.blockViews[a]},getLastBlockView:function(){var a=this,b=a.blockViews;return b[b.length-1]},getBlockViewContainer:function(a){var b,d,e=this,f=".block-view";return c(a).is(".highlight-view")?(b=e.getBlockViewAt(0))&&(d=b.el):d=c(a).closest(f)[0],d},getBlockViewIndex:function(a){return a?this.$el.find(">.block-view").index(a):-1},getBlock:function(a){var b,c,d=this,e=d.note;if(null!=e)return b=d.getBlockViewContainer(a),c=d.getBlockViewIndex(b),e.getBlockAt(c)},getBlockViewByBlock:function(a){var b,c=this;if(null!=c.note)return b=c.note.getBlockIndex(a),c.getBlockViewAt(b)},onCommand:function(a,b){var c,d,e,f=this;null==b.range&&(b.imageBlockView?(c=b.imageBlockView,b.imageBlockView=null,e=new h({block:c.block}),d=new i({blockRanges:[e]}),b.range=d):b.attachmentBlockView&&(c=b.attachmentBlockView,b.attachmentBlockView=null,e=new g({block:c.block}),d=new i({blockRanges:[e]}),b.range=d)),f.trigger("command",a,b)},_onCopy:function(a){this.trigger("copy",a)},_onCut:function(a){var b=this;if(b.isReadOnly())return void a.preventDefault();b.trigger("cut",a)},_onPaste:function(a){var b=this;if(b.isReadOnly())return void a.preventDefault();b.trigger("paste",a)},_onContextMenu:function(a){var b=this;a.preventDefault(),a.stopPropagation(),b.isReadOnly()||b.trigger("contextmenu",a)},_onDragDropEvent:function(a){var b,c=this;if(!c.isReadOnly())switch(a=a.originalEvent,b=c.getBlock(a.srcElement),a.type){case"dragstart":c.trigger("dragstart",a,b);break;case"dragover":c.trigger("dragover",a,b);break;case"drop":c.trigger("drop",a)}},_onDragEnd:function(a){this.trigger("dragend",a)},_onBlur:function(){this.trigger("blur")},_onFocus:function(){window.parent!==window&&p.isSafari()&&window.parent.getSelection().removeAllRanges()},_onClick:function(){this.trigger("yne-click")},onSelectAll:function(){var a,c=this,d=document.createRange();a=l.isTodo(b.first(c.note.blocks))?c.el.firstChild.querySelector(".todo-input"):c.el.firstChild,d.setStart(a,0),d.setEnd(c.el.lastChild,1),j.setRange(d,window),c.parseNativeRange(d)},_onSaveContent:function(){this.trigger("save-content")},_onReadOnlyChange:function(){var a=this,b=a.isReadOnly(),c=a.options.noteviewFrame;a.setHtmlContentEditable(!b),b?(a.$el.addClass("read-only"),null!=c&&c.find(".header-footer-input").prop("contenteditable",!1)):(a.$el.removeClass("read-only"),null!=c&&c.find(".header-footer-input").prop("contenteditable",!0))},_checkHighlightView:function(){var a=this;a.$el.children()[0]!==a.highlightView.$el.get(0)&&a.$el.prepend(a.highlightView.$el)},_onHighlight:function(a){var b=this;a.length?(b.$el.addClass("highlight"),b._checkHighlightView()):b.$el.removeClass("highlight"),b.highlightView.showHighlight(b.el,a)},_onNextHighlight:function(){var a=this;a._checkHighlightView(),a.highlightView.nextHighlight()},_onPreHighlight:function(){var a=this;a._checkHighlightView(),a.highlightView.preHighlight()},_onResize:function(a){var c=this;b.isNumber(a)&&(c._currentZoom=a),b.each(c.blockViews,function(a){a.trigger("resize"),c.isInPageMode()&&a.coincideAllPageBreaks()}),c._scrollNativeSelectionIntoWrapper(j.getRange())},_clearBlockViews:function(a){return b.each(a,function(a){a.onDestroy()}),[]},isInPageMode:function(){return 2===this._viewMode},setViewMode:function(a,b){var c=this;c._viewMode=a,c.isInPageMode()?c._enablePageMode(b):c._disablePageMode(a)},_calcNoteViewFrameHeight:function(){var a,c,d,f,g,h=this,i=b.last(h.blockViews),j=h.options.noteviewFrame;if(null!=i){if(a=(i.getLastTransPageIndex()||0)+1,h.options.pageType===e.PAGE_TYPE_A4?c=e.PAGE_HEIGHT_A4:h.options.pageType===e.PAGE_TYPE_B5?c=e.PAGE_HEIGHT_B5:h.options.pageType===e.PAGE_TYPE_TEST&&(c=e.PAGE_HEIGHT_TEST),null!=c&&a>1){if(d=a-2,f=j.find('[data-page-id="'+d+'"]'),0===f.length)return void q.debugAlert("Failed to find pageBreak:",d);f.length>1&&(q.debugAlert("Should not find more than one pageBreak:",d),f=f.first()),g=c-(j.height()-parseInt(h.$el.css("padding-bottom"))-parseInt(f.css("top"))-f.height()),g<0&&q.log("lastPageShortHeight < 0",g),j.height(j.height()+g),i.$el.position().top-parseInt(h.$el.css("padding-top"))+i.$el.height()>h.$el.height()&&(q.debugAlert("noteview content is overflowed"),j.height("auto"))}else j.height(c+parseInt(h.$el.css("padding-top"))+parseInt(h.$el.css("padding-bottom")));h._coincideAllPageBreaks()}},_coincideAllPageBreaks:function(){var a=this;b.each(a.blockViews,function(a){a.coincideAllPageBreaks()})},_disablePageMode:function(a){var c=this,d=c.options.noteviewFrame;if(c._pageBatchTimer&&(window.clearTimeout(c._pageBatchTimer),c._pageBatchTimer=null),!d)return void q.debugAlert("noteviewFrame should NOT be null when _disablePageMode");d.removeClass(e.PAGE_CLASS_A4),d.removeClass(e.PAGE_CLASS_B5),d.removeClass(e.PAGE_CLASS_TEST),b.each(c.blockViews,function(a){a.disablePageMode()}),c._viewMode=a,c._removeHeaderFooterView(),d.css("height","auto")},_enablePageMode:function(a){var c=this,d=c.options.noteviewFrame;if(c._pageBatchTimer&&(window.clearTimeout(c._pageBatchTimer),c._pageBatchTimer=null),c._pageBatchPendingQueue=[],!d)return void q.debugAlert("noteviewFrame should NOT be null when _enablePageMode");d.removeClass(e.PAGE_CLASS_A4),d.removeClass(e.PAGE_CLASS_B5),d.removeClass(e.PAGE_CLASS_TEST),c.options.pageType===e.PAGE_TYPE_A4?d.addClass(e.PAGE_CLASS_A4):c.options.pageType===e.PAGE_TYPE_B5?d.addClass(e.PAGE_CLASS_B5):c.options.pageType===e.PAGE_TYPE_TEST&&d.addClass(e.PAGE_CLASS_TEST),c._removeHeaderFooterView(),c.headerView=c.createHeaderFooterView(!1),c.footerView=c.createHeaderFooterView(!0),c._renderHeaderFooterView(d),!0===a&&null!=c.note&&(b.each(c.blockViews,function(a){a.enablePageMode(c.options.pageType)}),c._setPageInfo(0))},_getBlockViewIndexByCID:function(a){var c,d=this;return b.some(d.blockViews,function(b,d){return b.cid===a&&(c=d,!0)}),c},_onBlockViewHeightChanged:function(a){var b,c=this;null!=(b=c._getBlockViewIndexByCID(a))&&c._setPageInfo(b)},_onContentParseDone:function(){this.isInPageMode()&&this._calcNoteViewFrameHeight()},_onPageBreakInserted:function(){},_onPageBreakPosChanged:function(){},_setPageInfo:function(a,b){var c,d,e,f,g=this;if(g.isInPageMode()&&null!=g.blockViews&&0!==g.blockViews.length&&null!=(c=g.blockViews[a])&&null!=c.cid)if(g._setPageInfoInBatch(a),!0===b&&(g._pageBatchTimer=null),g._pageBatchPendingQueue.length>0){if(null==g._pageBatchTimer){for(f=null;null==f&&g._pageBatchPendingQueue.length>0;)e=g._pageBatchPendingQueue.shift(),d=g.blockViews[e.index],f=null!=d&&d.cid===e.cid?e.index:g._getBlockViewIndexByCID(e.cid);q.log("resetPageInfo: startTimer for ",f),null!=f&&(g._pageBatchTimer=setTimeout(g._setPageInfo.bind(g,f,!0),10))}}else g._pageBatchTimer=null,g.note.isParsingData()?g.options.noteviewFrame.height("auto"):g._calcNoteViewFrameHeight()},_setPageInfoInBatch:function(a){var b,c,d,e,f,g,h,i,j=this,k=Date.now();if(null!=j.blockViews&&0!==j.blockViews.length&&null!=a&&null!=(d=j.blockViews[a]))for(q.log("Start PageInfoInBatch from:",d,a),b=0===a?0:d.getFirstTransPageIndex();a<j.blockViews.length;){if(d=j.blockViews[a],0===a)h=d.resetPageInfo(0,0),c=0;else{if(e=j.blockViews[a-1],null==(c=e.getLastTransPageIndex()))break;g=e.getBottomPosInPage(c),-1===g&&(g=0),h=d.resetPageInfo(c,g)}if(a++,null!=c&&null!=b&&c-b,!0===h){if(l.isImage(d.block)&&d.isOnFloat()&&(i=c+1),(null==i||i<=c)&&Date.now()-k>100){f=j.blockViews[a],null!=f&&j._pageBatchPendingQueue.push({cid:f.cid,index:a});break}}else if(null==i||i<=c)break}}})}(),yne_pc_views_NoteView=function(a){var b,c=yne_jtk_core_L,d=yne_common_views_NoteView;return b=d.extend({render:function(){var a=this;b.__super__.render.apply(a,arguments),a.options.noteviewFrame.off("contextmenu"),a.options.noteviewFrame.contextmenu(function(b){a._onContextMenu(b)}),c.log("PC noteview render done.")}})}(),yne_common_data_Unknown=function(a){var b,c,d,e=yne_common_data_blockTypes,f=yne_common_data_Block,g=yne_underscore,h=yne_collaboration_collabUtils;return c={_type:e.UNKNOWN,_styles:null,_xmlNode:null,initialize:function(a){var c=this;c._xmlNode=a.xmlNode,b.__super__.initialize.apply(c,arguments)},setBlockStyle:function(){},setBlockStyles:function(){},getBlockStyles:function(){},getBlockStyle:function(){},getDefaultBlockStyles:function(){},toXml:function(a){var b,c,d=this,e=!1;return g.some(d._xmlNode.childNodes,function(a){return a.nodeName===f.TAG_ID_NAME&&(e=!0),e}),e||(b=a.createElement(f.TAG_ID_NAME),c=a.createTextNode(h.newGUID()),b.appendChild(c),d._xmlNode.appendChild(b)),d._xmlNode},getType:function(){return this._type},toJSON:function(){},toHtml:function(){return""},toPlain:function(){return""},countWords:function(){return 0}},d={fromXml:function(a){var c=new b({xmlNode:a});return c.parseIdFromXml(a),c},fromJSON:function(){}},b=f.extend(c,d)}(),yne_common_data_blockMap=function(a){var b,c=yne_underscore;return b={attach:yne_common_data_Attachment,catalogue:yne_common_data_Catalogue,heading:yne_common_data_Heading,"horizontal-line":yne_common_data_Hr,"list-item":yne_common_data_ListItem,image:yne_common_data_Image,para:yne_common_data_Paragraph,table:yne_common_data_Table,todo:yne_common_data_Todo,unknown:yne_common_data_Unknown},c.each(b,function(a,b){a.prototype._xmlNodeName=b}),b}(),yne_common_util_ListItemNode=function(a){var b=yne_jtk_core_Class,c=yne_underscore,d=yne_jtk_core_L;return b.extend({constructor:function(a,b,e,f,g){var h=this;d.DEBUG&&(h._debugId=c.uniqueId()),h.level=a||0,h.block=b,h._start=e,h._end=f,h.addChildNodes(g)},addChildNodes:function(a){var b=this;a&&(c.isArray(a)||(a=[a]),c.each(a,function(a){a.parentNode=b,b.childNodes||(b.childNodes=[]),b.childNodes.push(a)}))},childrenCount:function(){var a=this,b=a.childNodes;return b?b.length:0},hasChildren:function(){return this.childrenCount()>0},isOrdered:function(){var a=this;return a.block?a.block.isOrdered():!!a.parentNode&&a.parentNode.isOrdered()},getStartIndex:function(){var a=this;return a.block?a.block.getIndex():1},isChildOrdered:function(){var a=this,b=a.childNodes||[],c=b[0];return!!c&&c.isOrdered()},getChildStartIndex:function(){var a=this,b=a.childNodes||[],c=b[0];return c?c.getStartIndex():1},toHtml:function(a){var b,d,e,f,g,h,i=this,j=i.block,k=[];return a=!0===a,i.hasChildren()?(g=j?j.toHtml(i._start,i._end,a):"",k.push(g),b=i.isChildOrdered()?"ol":"ul",e="<"+b+' yne-block-type="list"',d=i.getChildStartIndex(),d>1&&(e+=' start="'+d+'"'),e+=">",k.push(e),h=i.childNodes,c.each(h,function(b){var c=b.toHtml(a);k.push(c)}),f="</"+b+">",k.push(f)):(g=j?j.toHtml(i._start,i._end,a):"<li></li>",k.push(g)),k=k.join("")}})}(),yne_common_data_Note=function(a){var b,c,d,e=yne_underscore,f=yne_backbone,g=yne_jtk_core_Class,h=yne_jquery,i=yne_underscorestring,j=yne_common_data_blockMap,k=yne_common_data_Block,l=yne_common_data_Unknown,m=yne_parser_Parser,n=yne_common_data_Paragraph,o=yne_jtk_core_L,p=yne_common_data_List,q=yne_common_data_ListItem,r=yne_common_data_Catalogues,s=yne_common_data_HeaderFooter,t=yne_common_data_blockTypes,u=yne_common_constants,v=yne_common_data_supportedInlineStyles,w=yne_common_util_ListItemNode,x=yne_common_util_schemaVersion,y=function(a){return a instanceof n&&!a.isEmpty()||t.isTable(a)&&!a.isEmptyContent()},z=yne_collaboration_collabUtils,A=x.getDefaultAsString(),B=yne_common_util_events,C=yne_common_util_clearString,D=yne_common_data_RichText,E=function(a){var b=document.createElement("span");return b.innerHTML=a,b.textContent};return b={blocks:null,originalBlockIds:null,_extraInfo:null,_isValidForCollab:!0,_isReadOnly:!1,_noteId:null,_contentParseTimer:null,headUnknownNodeList:null,initialize:function(){var a=this;a._extraInfo={},a._noteId=z.newGUID(),a.blocks=[],a.originalBlockIds=[],a.headUnknownNodeList=[],a.schemaVersion=A,a.fileVersion=0},isEmptyContent:function(){var a,b=this,c=b.blocks;return!!(c&&1===c.length&&(a=c[0])&&a.isEmptyContent)&&a.isEmptyContent()},getNoteId:function(){return this._noteId},isSameNote:function(a){return a===this._noteId},getBlockById:function(a){return this._header&&a===this._header.getId()?this._header:this._footer&&a===this._footer.getId()?this._footer:e.find(this.blocks,function(b){return a===b.getId()})},getBlockAt:function(a){return this.blocks[a]},getBlockIndex:function(a){var b=this;return e.indexOf(b.blocks,a)},getBlockIndexById:function(a){var b,c=this,d=-1;return b=c.getBlockById(a),b&&(d=c.getBlockIndex(b)),d},getPreBlock:function(a){var b=this,c=b.getBlockIndex(a);if(c>0)return b.getBlockAt(c-1)},getNextBlock:function(a){var b=this,c=b.getBlockIndex(a);if(c>=0)return b.getBlockAt(c+1)},getLastBlock:function(){var a=this;return e.last(a.blocks)},lastBlockIsEasyInput:function(){var a=this,b=a.getLastBlock();return t.isTextBlock(b)},getInterBlocks:function(a,b,c){var d=this,e=d.blocks,f=d.getBlockIndex(a),g=d.getBlockIndex(b);return c?e.slice(f,g+1):e.slice(f+1,g)},getAllBlocks:function(){return this.blocks},getCommonInlineStyle:function(a,b){if(a&&b){var c,d=a.getStartBlockRange(),f=a.getEndBlockRange(),g=d.block,h=f.block,i=null,j=[],k=!0;return y(g)&&(j.push(g.getCommonInlineStyle(b,d)),k=!1),(g!==h&&(c=this.getInterBlocks(g,h),e.each(c,function(a){y(a)&&(j.push(a.getCommonInlineStyle(b)),k=!1)}),y(h)&&(j.push(h.getCommonInlineStyle(b,f)),k=!1)),k)?(t.isTextBlock(g)&&(i=g.getInlineStyleForEmpty(b,!0)),i||v.getDefault(b)):(e.some(j,function(a){if(null===i)i=a;else if(null!=a&&i!==a)return i=u.INTERM,!0}),i)}},getRangeBlockStyle:function(a,b){if(a&&b){var c=a.getStartBlockRange(),d=a.getEndBlockRange(),f=c.block,g=d.block,h=this.getInterBlocks(f,g,!0),i=null;return a.isSingleTableSelected()?h[0]?h[0].getCommonBlockStyle(b,c):o.warn("No table block find, need update noteRange"):(e.each(h,function(a){var c=a.getBlockStyle(b);i=null===i?c:i===c?i:u.INTERM}),i)}},isSameList:function(a,b){var c,d,e,f,g,h,i,j,k,l;if(!a)return o.error("isSameList:noteRange should not be null"),!1;for(c=a.getStartBlockRange(),d=a.getEndBlockRange(),e=c.block,f=d.block,g=this.getInterBlocks(e,f,!0),l=g.length,h=0;h<l;h++)if((i=g[h])instanceof n){if(!(i instanceof q))return!1;if(j=i.getOwnerList(),j.getType()!==b)return!1;if(k){if(k!==i.getOwnerList())return!1}else k=j}return!!k},insert:function(a,b){var c=this;if(!b)throw"cannot insert null block";c.blocks.splice(a,0,b),c._bindEventsForBlock(b),b.trigger("attached",c),c.trigger("insert-block",a,b)},append:function(a){var b=this,c=b.blocks;b.insert(c.length,a)},replace:function(a,b){var c=this,d=c.blocks.splice(a,1,b)[0];return d?(d.trigger("detached",c),c._unbindEventsForBlock(d)):o.warn("oldBlock should not be null"),b&&(c._bindEventsForBlock(b),b.trigger("attached",c)),c.trigger("replace-block",a,b,d),d},remove:function(a,b){var c=this,d=c.blocks.splice(a,1)[0];d&&(d.trigger("detached",c),c._unbindEventsForBlock(d),c.trigger("remove-block",a,b))},removeBlock:function(a){var b=this;b.remove(b.getBlockIndex(a))},removeBlockById:function(a,b){var c=this;c.remove(c.getBlockIndexById(a),b)},toXml:function(){var a,b,c,d,f,g,h,j=this,k="<?xml",l='<?xml version="1.0"?>\n',m="http://note.youdao.com",n=document.implementation,p=n.createDocument(m,"note",null),q=p.createElement("head"),r=p.createElement("body"),s={},t=j.getSchemaVersion(),u=j.getFileVersion(),v=p.documentElement,w=[];return v.appendChild(q),v.appendChild(r),t&&v.setAttribute("schema-version",t),v.setAttribute("file-version",u),e.each(j.blocks,function(a){var b,c,d,f,g,h;a&&a.toXml&&(b=a.toXml(p)),b?b.listItem?(c=b,r.appendChild(c.listItem),f=c.listId,s[f]||(s[f]=!0,d=p.createElement("list"),g=c.ownerList.unknownAttrs,e.each(g,function(a){var b=a.cloneNode(!0);d.setAttributeNode(b)}),d.setAttribute("id",f),d.setAttribute("type",c.listType),q.appendChild(d))):("catalogue"===b.tagName&&(h=b.getAttribute("catalogue-id"),-1===w.indexOf(h)&&w.push(h)),r.appendChild(b)):o.warn("block.toXml() failed!")}),e.each(j.headUnknownNodeList,function(a){if(a&&a.cloneNode){var b=a.cloneNode(!0);q.appendChild(b)}}),h=q.querySelectorAll("catalogue-wrap"),e.each(h,function(a){q.removeChild(a)}),e.each(w,function(a){a&&(g=p.createElement("catalogue-wrap"),g.setAttribute("id",a),g.setAttribute("compat","true"),q.appendChild(g))}),b=j.getHeaderFooter(!1),c=j.getHeaderFooter(!0),b&&(a=b.toXml(p))&&q.appendChild(a),c&&(a=c.toXml(p))&&q.appendChild(a),d=new window.XMLSerializer,f=d.serializeToString(p),i.startsWith(f,k)||(f=l+f),f},_parseCataloguesToHtml:function(a){var b,c,d,e=document.createElement("div"),f="";for(d=0;d<a.length;d++)b=a[d],c=b.block,f+=c.toHtml();return c.getOwnerList(),e.setAttribute("yne-bulb-type","catalogue-wrap"),e.innerHTML=f,e.outerHTML},_parseListItemsToTree:function(a){var b,c,d,e,f,g,h,i,j,k=new w(0),l=a.length;for(f=k,b=0;b<l;b++){if(c=a[b],d=c.block,e=c.range||{},i=d.getLevel(),h=new w(i,d,e.start,e.end),(j=i-f.level)>1)for(;i-f.level>1;)g=new w(f.level+1),f.addChildNodes(g),f=g;else if(j<1)for(;i-f.level<1;)f=f.parentNode;f.addChildNodes(h),f=h}return k},_toHtmlWithSameOwnerList:function(a,b){var c,d,f=this,g=e.first(a).block;return t.isListItem(g)?(c=f._parseListItemsToTree(a))&&(d=c.toHtml(!0===b)):t.isCatalogue(g)&&(d=f._parseCataloguesToHtml(a)),d||""},toHtml:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=this,s=r.blocks,u=s.length,v=[],w=[];for(b=!0===b,a?(h=a.getStartBlockRange(),i=a.getEndBlockRange(),j=h.block,k=i.block,l=r.getBlockIndex(j),m=r.getBlockIndex(k),q=a.isInSingleBlock()):(l=0,m=u-1),d=l;d<=m;d++)p=null,n=d===l,o=d===m,c=s[d],n&&h?(p=h,q||(p=p.clone(!0),p.expandToEnd())):o&&i&&(p=i,q||(p=p.clone(!0),p.expandToStart())),t.isListItem(c)||t.isCatalogue(c)?(g=c.getOwnerList(),f&&f!==g&&w.length&&(e=r._toHtmlWithSameOwnerList(w,b),v.push(e),w=[]),w.push({block:c,range:p||null}),f=g):(f=null,w.length&&(e=r._toHtmlWithSameOwnerList(w,b),v.push(e),w=[]),e=p?p.getDataAsHtml(b):c.toHtml(null,null,b),v.push(e));return w.length&&(e=r._toHtmlWithSameOwnerList(w,b),v.push(e)),v=v.join("")},toPlain:function(a){var b=this,c=a?e.filter(b.blocks,a):b.blocks,d=e.map(c,function(a){return a.toPlain()});return d=d.join("\n")},_parseWordCountInfo:function(a){var b=/[A-z0-9~!@#$%^&*()_+{}|:"<>?`\-=[\]\\;',.\/]+/g,c=/[\u4e00-\u9fa5\u3002\uff1b\uff0c\uff1a\u201c\u201d\uff08\uff09\u3001\uff1f\u300a\u300b]/g,d=/\s+/g,e=a.match(b),f=a.match(c),g=a.replace(b,"").replace(d,""),h=g.length,i=f?f.length:0,j=e?e.length:0,k=h-i;return{nonChinese:j+k,chinese:i,all:i+j+k}},countWords:function(a,b){var c,d,e=this,f=function(a){return!t.isHr(a)};return a&&(c=!0,d=e._parseWordCountInfo(a.getDataAsPlain(e,f))),(!a||!d.all&&b)&&(c=!1,d=e._parseWordCountInfo(e.toPlain(f))),{count:d.all,isSelected:c,detail:d}},destroy:function(){var a=this;e.each(a.blocks,function(b){a._unbindEventsForBlock(b)}),a.blocks=null,a._isReadOnly=!1,a._isValidForCollab=!0},_listenerEventsForBlock:function(){return{"get-extra-info":"_onGetExtraInfo","get-default-set-font":"_onGetDefaultSetFont"}},_bubbleEventsForBlock:function(a){var b={};return t.isTable(a)&&(b=e.extend(b,{"color-picker-show":!0,"yne-user-action-collection":!0,"get-block-view":!0})),b},_bindEventsForBlock:function(a){var b,c=this;a&&(c._unbindEventsForBlock(a),b=c._listenerEventsForBlock(a),B.addListeners(b,a,c),b=c._bubbleEventsForBlock(a),B.bubble(b,a,c))},_unbindEventsForBlock:function(a){if(a){var b=this,c=function(b){b&&e.each(b,function(b,c){a.off(c)})};c(b._listenerEventsForBlock(a)),c(b._bubbleEventsForBlock(a))}},getFileVersion:function(){return this.fileVersion},setFileVersion:function(a){this.fileVersion=a},setSchemaVersion:function(a){if(x.isLessThanDefault(a))return void o.warn("schema version is older than current, need upgrade!");this.schemaVersion=a||A},getSchemaVersion:function(){return this.schemaVersion||A},getAllResouceIds:function(){var a=this,b=[];return e.each(a.blocks,function(a){var c=a.getResourceIds();c&&c.length&&(b=b.concat(c))}),b=e.uniq(b)},getAllResourceInfo:function(a,b){var c,d,f,g,h=[];return a=a||this.blocks,b=b||[t.IMAGE,t.ATTACHMENT,t.HANDWRITE,t.TABLE],e.each(this.blocks,function(a){t.isAttachment(a)&&b.indexOf(t.ATTACHMENT)>-1||t.isHandWrite(a)&&b.indexOf(t.HANDWRITE)>-1?(c=a.getSource(!1),d=a.getSource(!0),f=a.getResource(!1),g=a.getResource(!0),c&&d&&f&&g&&h.push({source:c,extraSource:d,resource:f,extraResource:g})):t.isImage(a)&&b.indexOf(t.IMAGE)>-1?(c=a.getSource(!1),d=a.getSource(!0),c&&d&&h.push({blockId:a.getId(),source:c,extraSource:d})):t.isTable(a)&&b.indexOf(t.TABLE)>-1&&(h=h.concat(a.getAllResourceInfo()))}),h},getImageBySource:function(a,b){return e.filter(this.blocks,function(c){return t.isImage(c)&&c.getSource(b)===a})},findAttachmentByResource:function(a,b){return e.filter(this.blocks,function(c){return t.isAttachment(c)&&c.getResource(b)===a})},_triggerExtraInfoChange:function(){var a=this;e.each(a.blocks,function(a){a.trigger("extra-info-change")})},setExtraInfo:function(a){var b=this;b._extraInfo=a,b._triggerExtraInfoChange()},getExtraInfo:function(a){var b=this;return a?(b._extraInfo||{})[a]:b._extraInfo},setExtraInfoWithKey:function(a,b,c,d){var e=this,f=e._extraInfo,g=f[a];f||(f={},d=!0),g||(f[a]=g={}),g[b]=c,!0===d?e.setExtraInfo(f):e._extraInfo=f},highlight:function(a,b){var c,d,f=this,g=[];b=e.defaults(b||{},{ignoreCase:!1}),a&&a.length?(c=[],e.each(a,function(a){a&&!/\s/.test(a)&&(a=new D({text:a}),c.push(a))}),c=c.length?c:null,d=f.blocks.slice(),f._header&&d.unshift(f._header),f._footer&&d.push(f._footer),e.each(d,function(a){a.highlight(c,b,function(a){g.push(a)})}),f.trigger("high-light",g),e.isFunction(b.callback)&&b.callback(g.length)):f.trigger("high-light",[])},nextHighlight:function(){this.trigger("next-high-light")},preHighlight:function(){this.trigger("pre-high-light")},setReadOnly:function(a){var b=this;(a=!!a)!==b._isReadOnly&&(b._isReadOnly=a,b.trigger("read-only-change",a),e.each(b.blocks,function(b){b.setReadOnly(a)}))},isReadOnly:function(){return this._isReadOnly},_setBlockLocked:function(a,b,c){var d,f=this;d=e.isArray(a)?a:[a],e.each(d,function(d){var g;if(!(g=e.isString(d)?f.getBlockById(d):d))return void o.log("BlockLock: skip non-existing block",a);g.setLocked(b,c)})},lockBlock:function(a,b){this._setBlockLocked(a,!0,b)},unlockBlock:function(a){this._setBlockLocked(a,!1)},_onGetExtraInfo:function(a,b){b(this.getExtraInfo(a))},
_onGetDefaultSetFont:function(a){this.trigger("get-default-set-font",function(b){a(b)})},isValidForCollab:function(){return this._isValidForCollab},setValidForCollab:function(a){this._isValidForCollab=a},reset:function(){var a=this;a.destroy(),a._noteId=z.newGUID(),a.headUnknownNodeList=[],a.blocks=[],a.originalBlockIds=[],null!=a._contentParseTimer&&(clearTimeout(a._contentParseTimer),a._contentParseTimer=null),a._header=null,a._footer=null},isBlank:function(){var a=this;return!a.blocks||0===a.blocks.length},getHeaderFooter:function(a){return a?this._footer:this._header},setHeaderFooter:function(a,b,c){b?this._footer=a:this._header=a,c&&this.trigger("header-footer-changed",b)},updateContentParseTimer:function(a){this._contentParseTimer!==a&&(clearTimeout(this._contentParseTimer),this._contentParseTimer=a),null==a&&this.trigger("content-parse-done")},isParsingData:function(){return null!=this._contentParseTimer},hasHandWriteBlock:function(){var a=this,b=!1;return e.some(a.blocks,function(a){return t.isHandWrite(a)&&(b=!0),b}),b}},c={fromXml:function(a,b,f,g){var i,j,k,l,m,q,t={},v={};return b||(b=new d),g=e.defaults(g||{},{progressCallBack:function(){},isAsync:!1}),q=g.progressCallBack,e.isString(a)?(a=C.clear(a),i=h.parseXML(a)):i=a,q({percent:.1}),o.log(i),j=h(i).find("note:first"),k=j.attr("schema-version"),k&&b.setSchemaVersion(k),l=j.attr("file-version"),l=l||0,b.setFileVersion(l),j&&j.get(0)?(j.find("head").children().each(function(a,c){var d,e=c.nodeName;switch(e){case"list":d=p.fromXml(c),t[h(c).attr("id")]=d;break;case"catalogue-wrap":d=r.fromXml(c),v[h(c).attr("id")]=d;break;case"header":d=s.fromXml(c),b.setHeaderFooter(d,!1,!0);break;case"footer":d=s.fromXml(c),b.setHeaderFooter(d,!0,!0);break;default:d=h(c).attr(u.COMPAT),x.isCompatible(d)&&(d=c.cloneNode(!0),b.headUnknownNodeList.push(d))}}),q({percent:.15}),m=j.find("body").children(),c._parseXMLBodyInBatch(m,0,b,t,v,f,q,g.isAsync),b):(b.isBlank()&&b.append(n.createBlank()),q({percent:1}),b.updateContentParseTimer(null),b)},fromHtml:function(a,b,f,g){var h,i=m.parseHtml(a);return b||(b=new d),g=e.defaults(g||{},{progressCallBack:function(){},isAsync:!1}),h=g.progressCallBack,c._parseHTMLInBatch(i,0,b,f,h,g.isAsync)?b:null},fromOCR:function(a,b){var c=m.parseOCR(a),f=0;return b=b||new d,e.each(c,function(a){a&&(b.append(a),f++)}),f?b:null},createBlank:function(a,b){var c=n.createBlank(a);return b||(b=new d),b.append(c),b},_parseHTMLInBatch:function(a,b,d,f,g,h){var i,j,k,l=Date.now(),m=!1,n=d.getExtraInfo("pcTodoMap");if(null==a&&0===a.length)return g({percent:1}),d.updateContentParseTimer(null),!1;for(;b<a.length;)if(i=a[b],t.isImage(i)&&f&&f.length>0&&e.each(f,function(a){if(a.resId===i.getResId())return void i.setImageInfo(a)}),t.isTodo(i)&&i.isFromOldTodo()&&(k=i.getLegacyResId(),k&&n&&n[k]?(i.setText(E(window.JSON.parse(n[k]).content)),i.setChecked(window.JSON.parse(window.JSON.parse(n[k]).checked))):i=null),i&&(d.append(i),m=!0),b++,b>=a.length?(g({percent:1}),d.updateContentParseTimer(null)):g({percent:.15+b/a.length*.85}),h&&Date.now()-l>100){j=setTimeout(c._parseHTMLInBatch.bind(null,a,b,d,f,g,h),10),d.updateContentParseTimer(j);break}return m},_parseXMLBodyInBatch:function(a,b,d,f,g,i,m,n){var o,p,q,r,s,v,w,y,A=Date.now();if(null==a||0===a.length)return m({percent:1}),void d.updateContentParseTimer(null);for(;b<a.length;){if(o=a[b],p=o.nodeName,q=j[p],r=h(o).attr(u.COMPAT),(!q&&x.isCompatible(r)||q&&r&&!x.isCompatible(r))&&(q=l),q&&q.fromXml){if(!(s=q.fromXml(o)))throw d.updateContentParseTimer(null),o;for(v=k.parseResourceList(o),s.setResourceIds(v),t.isListItem(s)&&s.setOwnerList(f[h(o).attr("list-id")]),t.isImage(s)&&i&&i.length>0&&e.each(i,function(a){if(a.resId===s.getResId())return void s.setImageInfo(a)}),t.isCatalogue(s)&&s.setOwnerList(g[h(o).attr("catalogue-id")]),d.append(s),s.isValidForCollab()||d.setValidForCollab(!1),y=s.getId();d.originalBlockIds.indexOf(y)>-1;)y=z.newGUID();y!==s.getId()&&(d.setValidForCollab(!1),s.setId(y)),d.originalBlockIds.push(y)}if(++b>=a.length)m({percent:1}),d.updateContentParseTimer(null);else if(m({percent:.15+b/a.length*.85}),n&&Date.now()-A>100){w=setTimeout(c._parseXMLBodyInBatch.bind(null,a,b,d,f,g,i,m,n),10),d.updateContentParseTimer(w);break}}}},e.extend(b,f.Events),d=g.extend(b,c)}(),yne_common_selection_SelectionChangeEvent=function(a){var b,c=yne_jtk_core_Class,d={COMMAND:1,USER:2};return b=c.extend({_type:null,_data:null,initialize:function(a){this._type=a.type,this._data=a.data,delete this.options},getType:function(){return this._type},getData:function(){return this._data},isCommandType:function(){return this._type===d.COMMAND},isUserType:function(){return this._type===d.USER}},{EVENT_TYPES:d,createCommandTypeEvent:function(a){return new b({type:d.COMMAND,data:a})},createUserTypeEvent:function(a){return new b({type:d.USER,data:a})}})}(),yne_common_selection_NoteSelection=function(a){var b,c=yne_jtk_core_Class,d=yne_backbone,e=yne_underscore,f=yne_common_selection_NoteRange,g=yne_jtk_core_L,h=yne_common_selection_nativeSelection,i=yne_common_selection_SelectionChangeEvent,j=yne_common_util_events;return b={noteView:null,_noteRange:null,initialize:function(a){var b=this;b.noteView=a.noteView,b._bindEvents()},_bindEvents:function(){var a=this,b=a.noteView;j.addListeners({selectionchange:"_onDocSelectionChange","set-range":"_onSetRange"},b,a)},_onDocSelectionChange:function(){g.log("on doc selection change!");var a=this,b=h.getRange(),c=a._convertToNoteRange(b);if(a._noteRange=c,g.log("NoteSelection -> contentchange"),c&&!c.canDrawedByNative())return void a.setRange(c);a.trigger("doc-change-selection",c),a._triggerSelectionChange()},_triggerSelectionChange:function(a){var b=this;a||(a=i.createUserTypeEvent()),g.log("---------note-selection-change---------"),b.trigger("selection-change",a)},_onSetRange:function(a,b,c,d){this._setRange(a,{toDraw:b,trigger:c,selectionChangeEvent:d})},_setRange:function(a,b){var c=this,d=c._convertToNoteRange(a);if(!d||!d.getStartBlockRange()||!d.getEndBlockRange())return void g.warn("Failed convert native range to note range!");b=b||{},c._noteRange=d,b.toDraw&&c._drawRange(b.scrollIntoView),b.trigger&&c._triggerSelectionChange(b.selectionChangeEvent)},_drawRange:function(a){var b=this,c=b._noteRange;a=!1!==a,b.noteView.trigger("draw-range",c,a)},_convertToNoteRange:function(a){var b=this,c=b.noteView;return f.fromNativeRange(a,c)},setRange:function(a,b,c){this._setRange(a,{toDraw:!0,trigger:!0,selectionChangeEvent:b,scrollIntoView:c})},getRange:function(){return this._noteRange},getNativeRange:function(){return h.getRange(window)},isCollapsed:function(){var a=this,b=a._noteRange;return!!b&&b.isCollapsed()},collapseToStart:function(){var a=this,b=a._noteRange;b&&b.collapse&&(b.collapse(!0),a._drawRange(),a._triggerSelectionChange())},collapseToEnd:function(){var a=this,b=a._noteRange;b&&b.collapse&&(b.collapse(!1),a._drawRange(),a._triggerSelectionChange())},reset:function(){this._noteRange=null}},e.extend(b,d.Events),c.extend(b)}(),yne_common_commands_Command=function(a){var b=yne_jtk_core_Class,c=yne_common_constants,d=yne_collaboration_collabUtils,e=yne_jtk_core_L;return b.extend({name:"UnknownCommand",isSimple:!1,cmdError:null,cmdId:null,isCollabRedo:!1,isCollabUndo:!1,rangeIsRequired:null,initialize:function(){var a=this,b=a.options.args||{};d.isCollabCommand(b)?a.fromCollabJSON(b.collabProperties.cmdJSON):a.cmdId=d.newGUID()},apply:function(){throw"Method not implemented."},doReapply:function(){throw"Method not implemented."},doUnapply:function(){throw"Method not implemented."},fromCollabJSON:function(){var a,b=this,c=b.options.args,d=c.collabProperties.cmdJSON;a=d.cmdId,null!=a?b.cmdId=d.cmdId:e.debugAlert("cmdJSON.cmdId should NOT be null")},getCmdId:function(){var a=this.cmdId;return null==a&&e.debugAlert("cmdId should NOT be null"),a},setCollabRedo:function(a){this.isCollabRedo=a},setCollabUndo:function(a){this.isCollabUndo=a},toCollabJSON:function(){var a=this,b={};return b[c.CJSON_ACTION]=a.name,b.cmdId=a.getCmdId(),b}})}(),yne_common_selection_rangeUtil=function(a){var b=yne_common_selection_NoteRange,c=yne_common_selection_TableRange,d=yne_common_data_blockTypes,e=yne_common_selection_blockRangeUtil;return{buildNoteRangeFromJSON:function(a,c){return b.fromCollabJSON(a,c)},buildNoteRangeFromNonTextBlock:function(a){var f,g={};return g.block=a,d.isTable(a)&&(g.type=c.TYPES.ALL),f=e.createRangeByBlock(g),b.create({startRange:f,endRange:f})},buildNoteRangeFromParagraph:function(a,c,d){var f=e.createRangeByBlock({block:a,start:c,end:d});return b.create({startRange:f,endRange:f})}}}(),yne_common_commands_CompositeCommand=function(a){var b,c=yne_underscore,d=yne_common_commands_Command,e=yne_collaboration_collabUtils,f=yne_jtk_core_L,g=yne_common_selection_NoteRange,h=yne_common_selection_ParagraphRange,i=yne_common_selection_rangeUtil;return b=d.extend({name:"UnknownCompositeCommand",_args:null,_cmds:null,_affectedBlockIds:null,_note:null,isSimple:!1,startingRange:null,endingRange:null,effected:!1,isLocalExecutedCmd:null,finalNoteVersion:null,originalNoteVersion:null,skipBlockLocking:!1,isOriginalCmd:!1,sendingToCollabServerMillis:null,isReadyToApply:null,initialize:function(){var a,c=this;c._args=c.options.args||{},c._args.collabProperties=c._args.collabProperties||{},a=c._args.collabProperties,c._cmds=[],c._affectedBlockIds=[],b.__super__.initialize.apply(c),!0===a.isCollabEnabled&&(a.isCollabCmd&&(c.finalNoteVersion=a.finalNoteVersion),c._initializeAffectedBlocks(),c.rangeIsRequired=!0,c.isReadyToApply=!0,c._args.isOriginalCmd&&(c.isOriginalCmd=!0))},finilize:function(){},_applyCommandToComposite:function(a,b){var c,d=this,e=d._cmds;e||(e=d._cmds=[]),c=a.apply(),a.isSimple?d.effected=!1!==c:(d.effected=d.effected||a.effected,d._affectedBlockIds||f.error("_affectedBlockIds cannot be null. please check the cmd("+d.name+") initialize has invoked its parent method")),b?d.setEndingRange(b):!a.isSimple&&a.getEndingRange()&&d.setEndingRange(a.getEndingRange()),e.push(a)},apply:function(){throw"Method not implemented."},doReapply:function(a){var b,c,d=this,g=d._cmds;if(f.log("doReapply(): `"+d.name+"`"),e.isCollabCommand(a))return d._reapplyCollabCmd(a);if(!g||!g.length)return f.warn("doReapply(): the composite command `"+d.name+"`no _cmds"),!0;for(b=g.length,c=0;c<b;++c)g[c].doReapply(a);return!0},doUnapply:function(a){var b,c=this,d=c._cmds;if(f.log("doUnapply(): `"+c.name+"`"),e.isCollabCommand(a))return c._unapplyCollabCmd(a);if(!d||!d.length)return f.warn("doUnapply(): the composite command `"+c.name+"`no _cmds"),!0;for(b=d.length-1;b>=0;--b)d[b].doUnapply(a);return!0},setStartingRange:function(a){var b=this;if(!g.isNoteRange(a))return void f.warn("noteRange is not a NoteRange",a);b.startingRange=a,b.options.args.range=b.startingRange},setEndingRange:function(a){var b=this,c=[];if(!g.isNoteRange(a))return void f.warn("noteRange is not a NoteRange",a);b.endingRange=a,c=b._getAffectedBlockIdsFromRange(b.options.note,b.endingRange),b.pushAffectedBlockIds(c)},getStartingRange:function(){return this.startingRange},getEndingRange:function(){return this.endingRange},canBeMerged:function(a){var b=this,d=["comp.KeyTextInput"];return!!c.contains(d,b.name)&&(!b.isCollabUndo&&!b.isCollabRedo&&a.name===b.name&&a.getCmdId()!==b.getCmdId()&&a.isLocalExecutedCmd===b.isLocalExecutedCmd)},executeAtomicCommand:function(a,b){this._applyCommandToComposite(a,b)},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON,e=c.collabProperties.coreEditor;b.__super__.fromCollabJSON.apply(a),d&&(d.startNoteRange&&(c.range=i.buildNoteRangeFromJSON(d.startNoteRange,e),c.range?a.setStartingRange(c.range):f.warn("Failed to re-build the startNoteRange",d.startNoteRange)),d.endNoteRange&&(c.endRange=i.buildNoteRangeFromJSON(d.endNoteRange,e),c.endRange&&a.setEndingRange(c.endRange)),d.cmdNoteVersion&&(a.originalNoteVersion=d.cmdNoteVersion),a.skipBlockLocking=d.skipBlockLocking)},getAffectedBlockIds:function(){return c.clone(this._affectedBlockIds)},getCmdFinalNoteVersion:function(){return this.finalNoteVersion},getCmdOriginalNoteVersion:function(){return this.originalNoteVersion},getCollabProps:function(){return this._args.collabProperties},getLockedBlockIds:function(){var a=this,b=[],c=a.endingRange;return a.isCollabUndo?c=a.startingRange:a.skipBlockLocking&&(c=null),g.isNoteRange(c)?b.push(c.getEndBlockRange().getBlockId()):c&&f.error("locked targetRange should be a NOTE range",c),b},getIgnoreUndoRedo:function(){return this._args.ignoreUndoRedo},isSingleBlockAffected:function(){var a=this,b=!0;return a._args.range?g.isNoteRange(a._args.range)&&a._args.range.isInMultiBlock()&&(b=!1):b=!1,b},isValidStartNoteRange:function(){return!0},mergeLocalCmd:function(a){f.log("targetCmd:",a)},pushAffectedBlockIds:function(a){var b=this;a&&(b._affectedBlockIds=c.union(b._affectedBlockIds,a))},resetAffectedBlockIds:function(a){var b=this;b._affectedBlockIds=[],b.pushAffectedBlockIds(a)},setCmdFinalNoteVersion:function(a){this.finalNoteVersion=a},setCmdOriginalNoteVersion:function(a){this.originalNoteVersion=a},setIgnoreUndoRedo:function(a){this._args.ignoreUndoRedo=a},toCollabJSON:function(){var a,d=this,h=b.__super__.toCollabJSON.apply(d),i=[],j=d.getStartingRange(),k=!1;if(d.isOriginalCmd)if(g.isNoteRange(j))h.startNoteRange=j.toCollabJSON();else if(d.rangeIsRequired)return f.error("startingRange should be noteRange",j),null;if(d.isCollabUndo&&(h.isCollabUndo=d.isCollabUndo),d.isCollabRedo&&(h.isCollabRedo=d.isCollabRedo),d.originalNoteVersion&&(h.cmdNoteVersion=d.originalNoteVersion),d.isCollabUndo||d.isCollabRedo){if(d.cmdId=e.newGUID(),h.cmdId=d.cmdId,d.isOriginalCmd)if(g.isNoteRange(d.endingRange))h.endNoteRange=d.endingRange.toCollabJSON();else if(d.rangeIsRequired)return f.error("endingRange should be a noteRange:",d.endingRange),null;c.each(d._cmds,function(b){k||(b.rangeIsRequired=!1,d.isCollabUndo?(b.setCollabRedo(!1),b.setCollabUndo(!0)):(b.setCollabRedo(!0),b.setCollabUndo(!1)),a=b.toCollabJSON(),a?i.push(a):(k=!0,f.error("Failed to get cmdJSON",b)))}),h.affectedBlockIds=d._affectedBlockIds.join(",")}return k?null:(i.length>0&&(h.innerCmds=i),d.isLocalExecutedCmd&&(h.isLocalExecutedCmd=!0),h.skipBlockLocking=d.skipBlockLocking,h)},_getAffectedBlockIdsFromRange:function(a,b){var d=[],e=[];if(a&&b){switch(b._type){case g.prototype._type:d=a.getInterBlocks(b.getStartBlockRange().block,b.getEndBlockRange().block,!0);break;case h.prototype._type:b.block&&d.push(b.block);break;default:f.error("pending supported range type:"+b._type)}d&&d.length>0&&c.each(d,function(a){e.push(a.getId())})}return e},_initializeAffectedBlocks:function(){var a=this,b=[],c=a.options.note,d=a._args.range;d&&(b=a._getAffectedBlockIdsFromRange(c,d),a.pushAffectedBlockIds(b))},_reapplyCollabCmd:function(a){var b=a.collabProperties.cmdJSON;if(b&&b.innerCmds){var c,d=b.innerCmds,e=d.length;for(c=0;c<e;++c){var f=a.collabProperties.coreEditor.buildInnerCommandFromJSON(d[c],a);f&&(f.doReapply(f._args),f.isSimple&&(a.collabProperties.redoUndoEffected=!0))}}},_unapplyCollabCmd:function(a){var b=a.collabProperties.cmdJSON;if(b&&b.innerCmds){var c,d=b.innerCmds,e=d.length;for(c=e-1;c>=0;--c){var f=a.collabProperties.coreEditor.buildInnerCommandFromJSON(d[c],a);f&&(f.doUnapply(f._args),f.isSimple&&(a.collabProperties.redoUndoEffected=!0))}}}})}(),yne_common_commands_commandClassMap=function(a){var b=yne_jtk_core_L,c=yne_underscore;return{_map:{},add:function(a){var c=this,d=a.prototype.name,e=c._map;return d?e[d]?void b.error("Command class ["+d+"] exists!"):void(e[d]=a):void b.error("The Command class has no name!",a)},get:function(a){var c=this,d=c._map,e=d[a];return e||b.error("Command class ["+a+"] does not exist!"),e},getAllNames:function(){var a=this;return c.keys(a._map)}}}(),yne_common_commands_ManagerAdapter=function(a){var b=yne_common_commands_CompositeCommand,c=yne_common_commands_commandClassMap,d=yne_common_constants,e=yne_jtk_core_L,f=yne_common_selection_NoteRange,g=yne_common_selection_TableRange,h=yne_collaboration_collabUtils,i=b.extend({name:"ManagerAdapter",effected:!0,_block:null,_dataBefore:null,_dataAfter:null,_args:null,initialize:function(a){var b,c=this;a.args=a.args||{},c._args=a.args,i.__super__.initialize.apply(c,arguments),h.isCollabCommand(c._args)||(c._block=a.block,c._dataBefore=a.dataBefore,c._dataAfter=a.dataAfter,(b=c._args.range)&&b.clone&&(c.setStartingRange(b),c.setEndingRange(b.clone(!0))))},apply:function(){var a=this,b=a._args,c=b.collabProperties||{},e=c.coreEditor;e.isCollabEnabled()&&c.isCollabCmd&&(a._block?a._NeedToSetData(e)&&a._block.setInnerData(a._dataAfter):(c.dataCmdError="Table block has been deleted",c.isOwnCmd&&e.notifyErrorToHost(d.INVALIDACTION_BLOCKS_DIRTY,c.coreEditor),a.effected=!1))},doReapply:function(a){var b,c,e=this,f=e._block,g=a.collabProperties,h=g.coreEditor;if(f&&(b=f.getInnerCommandManager()),!h.isCollabEnabled())return void(b&&b.redo());g.redoUndoEffected=!0,g.isCollabCmd?f?(f.setInnerData(e._dataAfter),g.isOwnCmd&&b&&(c=b.redoStack.pop())&&b.undoStack.push(c)):(g.dataCmdError="Table block has been deleted",g.isOwnCmd&&g.coreEditor.notifyErrorToHost(d.INVALIDACTION_BLOCKS_DIRTY,h),g.redoUndoEffected=!1):b&&b.redo()},sendInfoToInner:function(a){var b=this,c=b._block;if(!c||!c.sendInfoToInner)return void e.error("The block or sendInfoToInner() method is not valid!");c.sendInfoToInner(a)},doUnapply:function(a){var b,c,e=this,f=e._block,g=a.collabProperties||{},h=g.coreEditor;if(f&&(b=f.getInnerCommandManager()),!h.isCollabEnabled())return void(b&&b.undo());g.isCollabCmd?f?(f.setInnerData(e._dataBefore),g.isOwnCmd&&b&&(c=b.undoStack.pop())&&b.redoStack.push(c)):(g.dataCmdError="Table block has been deleted",g.isOwnCmd&&h.notifyErrorToHost(d.INVALIDACTION_BLOCKS_DIRTY,h),g.redoUndoEffected=!1):b&&b.undo()},fromCollabJSON:function(){var a=this,b=a._args,c=b.collabProperties,d=c.cmdJSON,e=c.coreEditor,f=e.getBlockById(d.blockId);a._block=f,a._dataBefore=d.dataBefore,a._dataAfter=d.dataAfter,i.__super__.fromCollabJSON.apply(a)},getBlockId:function(){var a=this,b=null;return a._block&&(b=a._block.getId()),b},toCollabJSON:function(){var a,b=this,c=b._block.getId();return b.rangeIsRequired=!1,a=i.__super__.toCollabJSON.apply(b),a.blockId=c,a.dataBefore=b._dataBefore,a.dataAfter=b._dataAfter,a},_NeedToSetData:function(a){var b=this,c=b._args.collabProperties||{},d=a.getLastNotOwnExecCmd(),f=!0;return c.isOwnCmd&&(d?d.name!==b.name?(e.log(b.name+": lastNotOwnCmd.name is "+d.name),f=!1):b._block.getId()!==b.getBlockId()?(e.log(b.name+": lastNotOwnCmd do NOT operate same table"),f=!1):b.getCmdOriginalNoteVersion()!==d.getCmdOriginalNoteVersion()?(e.log(b.name+": lastNotOwnCmd originalNoteVersion NOT same"),f=!1):e.log(b.name+": Need to set data again to resolve conflict"):(e.log(b.name+": lastNotOwnCmd is null"),f=!1)),f}},{create:function(a,b,c){var d,h,j={};return a&&a.getInnerCommandManager&&a.setInnerData?(d=new g({block:a}),h=new f({startRange:d,endRange:d}),j.range=h,new i({args:j,block:a,dataBefore:b,dataAfter:c})):void e.error("The block is not valid: ",a)}});return c.add(i),i}(),yne_common_commands_CommandManager=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_jtk_core_L,f=yne_backbone,g=yne_common_constants,h=yne_common_commands_ManagerAdapter,i=function(a){return a&&a.name===h.prototype.name},j=yne_common_selection_rangeUtil,k=yne_common_selection_NoteRange;return b={_editor:null,_undoStack:null,_redoStack:null,_notOwnManagerAdapterStack:null,initialize:function(a){var b=this;b._undoStack=[],b._redoStack=[],b._notOwnManagerAdapterStack=[],b._editor=a.editor},exec:function(a,b,c){var d,f,g,h,j=this,l=!1,m=!0,n=!1;return a?j._editor.isCollabEnabled()&&(l=c.collabProperties.isCollabCmd&&c.collabProperties.isOwnCmd,m=!c.collabProperties.isCollabCmd,l&&(i(a)?j._localManagerAdapterOverriden(a)?a.setIgnoreUndoRedo(!0):n=!0:c.collabProperties.cmdJSON.isLocalExecutedCmd&&(n=!0)),n)?(e.log("Skip local-executed collab command and update noteVersion",a),j._updateUndoCmdFinalVersion(a.cmdId,c.collabProperties.finalNoteVersion),j.trigger("command-exec",a,c),!0):(h=a.apply(),f={cmdName:a.name,cmdType:"do"},d=a.getEndingRange(),!1!==h&&!k.isNoteRange(d)&&a.getStartingRange()&&(e.warn("endingRange should be a noteRange, so set it to be same as startEndingRange:",d),d=a.getStartingRange(),a.setEndingRange(d)),g=m||l,d&&g&&!a.updateSelectionDisabled&&j.trigger("update-selection",d,f),g&&!a.effected?(j.trigger("command-exec",a,c),h):(i(a)&&(a.sendInfoToInner({canUndo:j.canUndo(),canRedo:j.canRedo()}),g||j._notOwnManagerAdapterStack.push(a)),j._editor.isCollabEnabled()?c.collabProperties.dataCmdError?(j.trigger("command-exec",a,c),!1):(g&&(a.getIgnoreUndoRedo()||j._pushToUndoStack(a),j._redoStack=[]),j.trigger("command-exec",a,c),!0):(a.getIgnoreUndoRedo()||j._undoStack.push(a),j._redoStack=[],j.trigger("command-exec",a,c),!0))):(e.log("Skip empty local command"),!1)},canUndo:function(){return 0!==this._undoStack.length},undo:function(){if(!this.canUndo())return e.warn("Can Not undo"),!1;var a,b=this,c=b._undoStack,d=b._redoStack,f=c.pop();return f.doUnapply(),d.push(f),b.trigger("command-exec",f),a={cmdName:f.name,cmdType:"undo"},b.trigger("update-selection",f.getStartingRange(),a),!0},canRedo:function(){return 0!==this._redoStack.length},redo:function(){if(!this.canRedo())return!1;var a,b=this,c=b._undoStack,d=b._redoStack,e=d.pop();return e.doReapply(),c.push(e),b.trigger("command-exec",e),a={cmdName:e.name,cmdType:"redo"},b.trigger("update-selection",e.getEndingRange(),a),!0},reset:function(){var a=this;a._undoStack=[],a._redoStack=[],a._notOwnManagerAdapterStack=[]},registerManager:function(a,b){var c,d=this;if(!a||!a.on)return void e.warn("commandManager is not Valid!");d.unregisterManager(a),a.on("command-executed",function(f,g){var i=h.create(b,f,g);if(!i)return void e.warn("ManagerAdapter failed to create command!");i.isOriginalCmd=!0,i.isLocalExecutedCmd=!0,i.setCmdOriginalNoteVersion(d._editor.getNoteVersion()),d._pushToUndoStack(i),d._redoStack=[],d.trigger("command-exec",i),a.triggerGlobalUndoStatus(d.canUndo(),d.canRedo()),d._editor.isCollabEnabled()&&(c=window.JSON.parse(g))&&0!==c.colWidths.length&&0!==c.rowHeights.length&&d._editor.pushLocalDataCommand(i,!0)})},unregisterManager:function(a){a&&a.on&&a.off("command-executed")},applyCollabCmdRedoUndo:function(a){var b,c=this,d=a.options.args,f=d.collabProperties.cmdJSON,h=d.collabProperties.isOwnCmd;if(h&&d.collabProperties.isLocalExecutedCmd)return e.log("skip local-executed-own redo/undo",a),void c.trigger("command-exec",a,d);d.collabProperties.isCollabUndo?(a.setCollabUndo(!0),a.setCollabRedo(!1),b=a.doUnapply(d)):d.collabProperties.isCollabRedo&&(a.setCollabUndo(!1),a.setCollabRedo(!0),b=a.doReapply(d)),!1!==b?(d.collabProperties.isCollabUndo&&a.setStartingRange(j.buildNoteRangeFromJSON(f.startNoteRange,c._editor)),d.collabProperties.isCollabRedo&&a.setEndingRange(j.buildNoteRangeFromJSON(f.endNoteRange,c._editor)),h&&(d.collabProperties.isCollabUndo?(c._pushToRedoStack(c._undoStack.pop()),c.trigger("update-selection",a.getStartingRange())):d.collabProperties.isCollabRedo&&(c._pushToUndoStack(c._redoStack.pop()),c.trigger("update-selection",a.getEndingRange())))):h&&(d.collabProperties.isCollabUndo?c.dropUndoCmds():d.collabProperties.isCollabRedo&&c.dropRedoCmd(),c._editor.notifyErrorToHost(g.INVALIDACTION_FAILED_COLLABCMD,d.collabProperties.coreEditor)),h&&i(a)&&a.sendInfoToInner({canUndo:c.canUndo(),canRedo:c.canRedo()}),c.trigger("command-exec",a,d)},dropRedoCmd:function(){e.log("Drop Redo Command"),this._redoStack.pop(),this.trigger("redo-stack-change")},dropUndoCmds:function(a,b,c){var d,f=this;e.log("Drop Undo Command:",a,b,c),a?(d=f._getUndoCmdIndexById(a))>=0&&(c?f._undoStack.splice(d,b,c):f._undoStack.splice(d,b)):f._undoStack.pop(),this.trigger("undo-stack-change")},getRedoCmd:function(){return d.last(this._redoStack)},getUndoCmd:function(){return d.last(this._undoStack)},_getUndoCmdIndexById:function(a){var b=this,c=-1,e=0;return d.some(b._undoStack,function(b){return b.getCmdId()===a&&(c=e),c>=0||(e++,!1)}),c},_pushToRedoStack:function(a){var b=this;if(!a)return void e.log("null command should NOT be pushed to Redo Stack");b._redoStack.push(a)},_pushToUndoStack:function(a){var b=this;return a?a.getIgnoreUndoRedo()?void e.log("this command no need undo redo."):(b._undoStack.push(a),void(b._undoStack.length>g.MAX_UNDO_STACK_SIZE&&b._undoStack.shift())):void e.log("null command should NOT be pushed to Undo Stack")},_localManagerAdapterOverriden:function(a){var b,c=this,d=!1,e=0;for(c._notOwnManagerAdapterStack&&(e=c._notOwnManagerAdapterStack.length);e>0&&(b=c._notOwnManagerAdapterStack[e-1],b.getCmdOriginalNoteVersion()===a.getCmdOriginalNoteVersion());e--)if(a.getBlockId()===b.getBlockId()){d=!0;break}return d},_updateUndoCmdFinalVersion:function(a,b){var c=this;d.some(c._undoStack,function(c){if(c.cmdId===a)return c.setCmdFinalNoteVersion(b),!0})}},d.extend(b,f.Events),c.extend(b)}(),yne_common_commands_SimpleCommand=function(a){var b,c=yne_common_commands_Command,d=yne_jtk_core_L;return b=c.extend({name:"UnknownSimpleCommand",isSimple:!0,initialize:function(){b.__super__.initialize.apply(this)},apply:function(){throw"Method not implemented."},doReapply:function(a){var b=this;return d.log("doReapply(): `"+b.name+"`"),b.apply(a)},doUnapply:function(){var a=this;throw d.log("doReapply(): `"+a.name+"`"),"Method not implemented."},isCollabCommand:function(){var a=this,b=a.options.args;return null!=b&&null!=b.collabProperties&&!0===b.collabProperties.isCollabCmd}})}(),yne_common_commands_atomicCommands_DeleteBlockText=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_RichText,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.DeleteBlockText",_textBlock:null,_start:null,_end:null,_deletedText:null,initialize:function(){var a=this,c=a.options.args;f.isCollabCommand(c)||(a._textBlock=a.options.block,a._start=a.options.start,a._end=a.options.end),b.__super__.initialize.apply(a)},apply:function(){var a=this,b=a._textBlock,c=b.sliceText(a._start,a._end);return!!c&&(a._deletedText=c,b.deleteText(a._start,a._end),!0)},doUnapply:function(){var a=this,b=a._deletedText;a._textBlock&&a._deletedText&&a._textBlock.insertText(a._start,b)},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),d&&(a._deletedText=e.fromCollabJSON(d.richText),a._textBlock=c.collabProperties.coreEditor.getBlockById(d.blockId),a._start=d.startPosition,a._end=d.endPosition)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._textBlock.getId(),c.richText=a._deletedText.toCollabJSON(),c.startPosition=a._start,c.endPosition=a._end,c}}),d.add(b),b}(),yne_common_data_blockUtils=function(a){var b=yne_common_data_blockTypes,c=yne_common_data_Paragraph,d=yne_common_data_Hr,e=yne_common_data_Image,f=yne_common_data_Attachment,g=yne_common_data_Table,h=yne_common_data_ListItem,i=yne_common_data_Heading,j=yne_common_data_Catalogue,k=yne_common_data_Todo;return{buildBlockFromJSON:function(a,l){var m,n=null,o=a.blockType;switch(o){case b.PARAGRAPH:n=c.fromCollabJSON(a);break;case b.IMAGE:n=e.fromJSON(a);break;case b.ATTACHMENT:n=f.fromJSON(a);break;case b.LIST_ITEM:n=h.fromCollabJSON(a),m=h.getOrCreateListById(l.getNote().getAllBlocks(),n.getListId(),n.getListType()),n.setOwnerList(m);break;case b.TABLE:n=g.fromJSON(a);break;case b.HR:n=d.fromCollabJSON(a);break;case b.HEADING:n=i.fromCollabJSON(a);break;case b.CATALOGUE:n=j.fromCollabJSON(a);break;case b.TODO:n=k.fromCollabJSON(a);break;default:throw"unsupported type [ "+o+"] in buildBlockFromJSON"}return n}}}(),yne_common_commands_atomicCommands_DeleteBlocks=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_underscore,g=yne_common_data_blockUtils,h=yne_collaboration_collabUtils;return b=c.extend({name:"atom.DeleteBlocks",_note:null,_deletedBlocks:null,_deletedBlockIds:null,_preBlockId:null,initialize:function(){var a=this,c=a.options.args;h.isCollabCommand(c)||(a._note=a.options.note,a._deletedBlocks=f.sortBy(a.options.blocks,function(b){return a._note.getBlockIndex(b)}),a._deletedBlockIds=[],f.each(a._deletedBlocks,function(b){a._deletedBlockIds.push(b.getId())})),b.__super__.initialize.apply(a)},apply:function(){var a,b,c=this;return c._deletedBlockIds&&0!==c._deletedBlockIds.length?(b=c._note.getBlockById(c._deletedBlockIds[0]),a=c._note.getPreBlock(b),c._preBlockId=a?a.getId():0,f.each(c._deletedBlockIds,function(a,b){c._note.removeBlockById(a,c._deletedBlockIds.length===b+1)}),!0):(e.error("没有指定要删除的段落"),!1)},doUnapply:function(){var a=this,b=0;a._preBlockId&&(b=a._note.getBlockIndexById(a._preBlockId)+1),f.each(a._deletedBlocks,function(c){a._note.insert(b,c),b++})},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties,e=d.cmdJSON;b.__super__.fromCollabJSON.apply(a),a._note=d.coreEditor.getNote(),e&&e.preBlockId&&(a._preBlockId=e.preBlockId),d.isCollabUndo?(a._deletedBlocks=[],f.each(e.deletedBlocks,function(b){a._deletedBlocks.push(g.buildBlockFromJSON(b,d.coreEditor))})):d.isCollabRedo&&(a._deletedBlockIds=[],f.each(e.deletedBlocks,function(b){a._deletedBlockIds.push(b)}))},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a),d=[];return a.isCollabUndo?f.each(a._deletedBlocks,function(a){d.push(a.toCollabJSON())}):a.isCollabRedo&&f.each(a._deletedBlockIds,function(a){d.push(a)}),c.preBlockId=a._preBlockId,c.deletedBlocks=d,c}}),d.add(b),b}(),yne_common_commands_atomicCommands_InsertBlocks=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_common_data_blockUtils,g=yne_collaboration_collabUtils;return b=c.extend({name:"atom.InsertBlocks",_note:null,_newBlks:null,_newBlkIds:null,_preBlkId:null,initialize:function(){var a=this,c=a.options.args;g.isCollabCommand(c)||(a._note=a.options.note,a._newBlks=a.options.newBlks,a.options.preBlk&&(a._preBlkId=a.options.preBlk.getId()),a._newBlkIds=[],e.each(a._newBlks,function(b){a._newBlkIds.push(b.getId())})),b.__super__.initialize.apply(a)},apply:function(){var a,b=this,c=0;if(b._preBlkId){if(-1===(a=b._note.getBlockIndexById(b._preBlkId)))return!1;c=a+1}return e.each(b._newBlks,function(a){b._note.insert(c,a),c++}),!0},doUnapply:function(){var a=this;e.each(a._newBlkIds,function(b){a._note.remove(a._note.getBlockIndexById(b))})},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties,g=d.cmdJSON;b.__super__.fromCollabJSON.apply(a),a._note=d.coreEditor.getNote(),g.preBlockId&&(a._preBlkId=g.preBlockId),d.isCollabUndo?a._newBlkIds=g.insertedBlocks:d.isCollabRedo&&(a._newBlks=[],e.each(g.insertedBlocks,function(b){a._newBlks.push(f.buildBlockFromJSON(b,d.coreEditor))}))},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a),d=[];return a.isCollabUndo?e.each(a._newBlks,function(a){d.push(a.getId())}):a.isCollabRedo&&e.each(a._newBlks,function(a){d.push(a.toCollabJSON())}),c.insertedBlocks=d,a._preBlkId&&(c.preBlockId=a._preBlkId),c}}),d.add(b),b}(),yne_common_commands_atomicCommands_InsertBlockText=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_RichText,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.InsertBlockText",_textBlock:null,_start:null,_insertedText:null,initialize:function(){var a=this,c=a.options.args;f.isCollabCommand(c)||(a._textBlock=a.options.block,a._start=a.options.start,a._insertedText=a.options.text),b.__super__.initialize.apply(a)},apply:function(){var a=this;return!!a._insertedText&&(a._textBlock.insertText(a._start,a._insertedText),!0)},doUnapply:function(){var a=this;a._textBlock&&a._insertedText&&a._textBlock.deleteText(a._start,a._start+a._insertedText.getLength())},fromCollabJSON:function(){
var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),d&&(a._insertedText=e.fromCollabJSON(d.richText),a._textBlock=c.collabProperties.coreEditor.getBlockById(d.blockId),a._start=d.startPosition)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._textBlock.getId(),c.richText=a._insertedText.toCollabJSON(),c.startPosition=a._start,c}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetInlineStyle=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetInlineStyle",_selectedBlocks:null,_start:null,_end:null,_isFullText:!1,_oldStyleNameValues:{},_styleNameValues:null,initialize:function(){var a=this,c=a.options.args;a._oldStyleNameValues={},f.isCollabCommand(c)||(a._selectedBlocks=a.options.blocks,a._styleNameValues=a.options.styleNameValues,a._start=a.options.start,a._end=a.options.end,a._isFullText=a.options.fullText),b.__super__.initialize.apply(a)},apply:function(){var a=this;e.each(a._styleNameValues,function(b,c){a._setStyleToSelectedBlocks(c,b)})},doUnapply:function(){var a,b=this;e.each(b._selectedBlocks,function(c){a=b._oldStyleNameValues[c.getId()],b._isFullText&&(b._start=c.getStartOffset(),b._end=c.getEndOffset()),e.each(a,function(a,d){c.setTextStyle(d,a,b._start,b._end)})})},fromCollabJSON:function(){var a,c=this,d=c.options.args,f=d.collabProperties,g=f.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=f.coreEditor.getNote(),g&&(c._selectedBlocks=[],e.each(g.blockIds,function(b){c._selectedBlocks.push(a.getBlockById(b))}),c._styleNameValues=g.styleNameValues,c._oldStyleNameValues=g.oldStyleNameValues,c._start=g.startPosition,c._end=g.endPosition,c._isFullText=g.simpleValue1)},toCollabJSON:function(){var a=this,c=[],d=b.__super__.toCollabJSON.apply(a);return a._selectedBlockIds=[],e.each(a._selectedBlocks,function(a){c.push(a.getId())}),d.blockIds=c,d.styleNameValues=a._styleNameValues,d.oldStyleNameValues=a._oldStyleNameValues,d.startPosition=a._start,d.endPosition=a._end,a._isFullText&&(d.simpleValue1=!0),d},_setStyleToSelectedBlocks:function(a,b){var c,d,f=this;e.each(f._selectedBlocks,function(e){d=e.getId(),f._isFullText&&(f._start=e.getStartOffset(),f._end=e.getEndOffset()),c=e.getTextStyle(a,f._start,f._end),f._oldStyleNameValues[d]||(f._oldStyleNameValues[d]={}),f._oldStyleNameValues[d][a]=c,e.setTextStyle(a,b,f._start,f._end)})}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetBlockStyle=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetBlockStyle",_selectedBlocks:null,_oldStyleNameValues:{},_styleNameValues:null,initialize:function(a){var c=this,d=c.options.args;c._oldStyleNameValues={},f.isCollabCommand(d)||(c._selectedBlocks=a.blocks,c._styleNameValues=c.options.styleNameValues),b.__super__.initialize.apply(c,arguments)},apply:function(){var a=this;e.each(a._styleNameValues,function(b,c){a._setStyleToSelectedBlocks(c,b)})},doUnapply:function(){var a,b=this;e.each(b._selectedBlocks,function(c){a=b._oldStyleNameValues[c.getId()],e.each(a,function(a,b){c.setBlockStyle(b,a)})})},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties,f=d.cmdJSON;b.__super__.fromCollabJSON.apply(a),a._note=d.coreEditor.getNote(),f&&(a._selectedBlocks=[],e.each(f.blockIds,function(b){a._selectedBlocks.push(a._note.getBlockById(b))}),a._styleNameValues=f.styleNameValues,a._oldStyleNameValues=f.oldStyleNameValues)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a),d=[];return e.each(a._selectedBlocks,function(a){d.push(a.getId())}),c.blockIds=d,c.styleNameValues=a._styleNameValues,c.oldStyleNameValues=a._oldStyleNameValues,c},_setStyleToSelectedBlocks:function(a,b){var c,d,f=this;e.each(f._selectedBlocks,function(e){d=e.getId(),c=e.getBlockStyle(a),f._oldStyleNameValues[d]||(f._oldStyleNameValues[d]={}),f._oldStyleNameValues[d][a]=c,e.setBlockStyle(a,b)})}}),d.add(b),b}(),yne_common_commands_atomicCommands_table_SetTableCellInlineStyle=function(a){var b,c=yne_underscore,d=yne_common_commands_SimpleCommand,e=yne_common_commands_commandClassMap,f=yne_common_selection_TableRange,g=yne_collaboration_collabUtils;return b=d.extend({name:"atom.SetTableCellInlineStyle",_table:null,_rect:null,_type:null,effected:!1,_oldStyles:{},_styles:null,initialize:function(){var a=this,c=a.options.args;a._oldStyles={},g.isCollabCommand(c)||(a._table=a.options.table,a._styles=a.options.styles,a._rect=a.options.rect,a._type=a.options.type,a._toggle=a.options.toggle),a.type===f.TYPES.ALL&&(a._rect=a._rect||{top:0,left:0,width:a._table.getColumnCount(),height:a._table.getRowCount()}),b.__super__.initialize.apply(a)},apply:function(){var a,b,d,e,g,h=this._table,i=this._rect,j=this._styles||{},k=this._toggle,l=i.top+i.height,m=i.left+i.width;if(!i)return this.effected;if(k){if(e=f.create({block:h,type:f.TYPES.NORMAL,rect:i})){if(!(g=e.getAsRectRange()))return this.effected;a=h.getCommonInlineStyle(k,g)}j[k]=null==a||!a}for(b=i.top;b<l;b++)for(d=i.left;d<m;d++)this._oldStyles[b+"-"+d]=h.getCellInlineStyles({row:b,col:d,names:c.keys(j)}),h.setCellInlineStyles({row:b,col:d,styles:j})&&(this.effected=!0);return this.effected},doUnapply:function(){var a,b,c=this._table,d=this._rect,e=d.top+d.height,f=d.left+d.width;for(a=d.top;a<e;a++)for(b=d.left;b<f;b++)c.setCellInlineStyles({row:a,col:b,styles:this._oldStyles[a+"-"+b]})},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._styles=f.styleNameValues,c._oldStyles=f.oldStyleNameValues,c._rect=f.simpleValue1,c._type=f.simpleValue2,c._toggle=f.newBlkId)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.styleNameValues=a._styles||null,c.oldStyleNameValues=a._oldStyles,c.simpleValue1=a._rect,c.simpleValue2=a._type,c.newBlkId=a._toggle||null,c}}),e.add(b),b}(),yne_common_commands_atomicCommands_table_SetTableCellBlockStyle=function(a){var b,c=yne_underscore,d=yne_common_commands_SimpleCommand,e=yne_common_commands_commandClassMap,f=yne_common_selection_TableRange,g=yne_collaboration_collabUtils;return b=d.extend({name:"atom.SetTableCellBlockStyle",_table:null,_rect:null,_type:null,effected:!1,_oldStyles:{},_styles:null,initialize:function(){var a=this,c=a.options.args;a._oldStyles={},g.isCollabCommand(c)||(a._table=a.options.table,a._styles=a.options.styles,a._toggle=a.options.toggle,a._rect=a.options.rect,a._type=a.options.type),a.type===f.TYPES.ALL&&(a._rect=a._rect||{top:0,left:0,width:a._table.getColumnCount(),height:a._table.getRowCount()}),b.__super__.initialize.apply(a)},apply:function(){var a,b,d,e,g,h,i,j,k=this,l=k._table,m=k._rect,n=k._styles||{},o=k._toggle,p=!1;if(!m)return k.effected;if(a=m.top+m.height,b=m.left+m.width,o){if(!(g=f.create({block:l,type:f.TYPES.NORMAL,rect:m})))return k.effected;if(!(h=g.getAsRectRange()))return k.effected;d=l.getCommonBlockStyle(o,h),n[o]=null==d||!d}for(e=c.keys(n),i=m.top;i<a;i++)for(j=m.left;j<b;j++)this._oldStyles[i+"-"+j]=l.getCellBlockStyles({row:i,col:j,names:e}),l.setCellBlockStyles({row:i,col:j,styles:n})&&(p=!0);return k.effected=p,k.effected},doUnapply:function(){var a,b,c=this._table,d=this._rect,e=d.top+d.height,f=d.left+d.width;for(a=d.top;a<e;a++)for(b=d.left;b<f;b++)c.setCellBlockStyles({row:a,col:b,styles:this._oldStyles[a+"-"+b]})},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._styles=f.styleNameValues,c._oldStyles=f.oldStyleNameValues,c._rect=f.simpleValue1,c._type=f.simpleValue2,c._toggle=f.newBlkId)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.styleNameValues=a._styles||null,c.oldStyleNameValues=a._oldStyles,c.simpleValue1=a._rect,c.simpleValue2=a._type,c.newBlkId=a._toggle||null,c}}),e.add(b),b}(),yne_common_commands_atomicCommands_table_SetTableCellAttr=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_collaboration_collabUtils,f={POINT:"point",CELL:"cell"};return b=c.extend({name:"atom.SetTableCellAttr",_table:null,_rect:null,_type:null,_value:null,_oldValue:null,effected:!1,initialize:function(){var a=this,c=a.options.args;e.isCollabCommand(c)||(a._table=a.options.table,a._rect=a.options.rect,a._type=a.options.type,a._value=a.options.value),b.__super__.initialize.apply(a)},apply:function(){var a=this,b=a._type,c=a._table,d=a._rect,e=a._value;return e?b===f.POINT?(a._oldValue=a._getOldAttr(d.row,d.col),c.setMergePointAttrAt(d.row,d.col,e.width,e.height),void(a.effected=!0)):b===f.CELL?(a._oldValue=a._getOldAttr(d.row,d.col),c.setMergedCellAttrAt(d.row,d.col,e.dx,e.dy),void(a.effected=!0)):void 0:void((c.isMergePoint(d.row,d.col)||c.isMergedCell(d.row,d.col))&&(a._oldValue=a._getOldAttr(d.row,d.col),c.clearCellAttr(d.row,d.col),a.effected=!0))},_getOldAttr:function(a,b){var c=this,d=c._table;return d.isMergedCell(a,b)?d.getMergedCellAttrAt(a,b):d.isMergePoint(a,b)?d.getMergePointAttrAt(a,b):null},doUnapply:function(){var a=this,b=a._table,c=a._rect,d=a._oldValue;if(!d)return void b.clearCellAttr(c.row,c.col);(d.width||d.height)&&b.setMergePointAttrAt(c.row,c.col,d.width,d.height),(d.dx||d.dy)&&b.setMergedCellAttrAt(c.row,c.col,d.dx,d.dy)},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._value=f.styleNameValues,c._oldValue=f.oldStyleNameValues,c._rect=f.simpleValue1,c._type=f.simpleValue2)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.styleNameValues=a._value,c.oldStyleNameValues=a._oldValue,c.simpleValue1=a._rect,c.simpleValue2=a._type,c}},{TYPES:f}),d.add(b),b}(),yne_common_commands_utils_CompCmdUtils=function(a){var b=yne_common_selection_rangeUtil,c=yne_common_selection_blockRangeUtil,d=yne_common_data_blockTypes,e=yne_common_commands_link_LinkMatch,f=yne_common_data_supportedInlineStyles,g=yne_common_util_headingMaps,h=yne_underscore,i=yne_common_data_RichText,j=yne_jtk_core_L,k=yne_common_data_Paragraph,l=yne_common_data_ListItem,m=yne_common_data_Heading,n=yne_common_data_Catalogue,o=yne_common_data_Todo,p=yne_common_commands_atomicCommands_DeleteBlockText,q=yne_common_commands_atomicCommands_DeleteBlocks,r=yne_common_commands_atomicCommands_InsertBlocks,s=yne_common_commands_atomicCommands_InsertBlockText,t=yne_common_commands_atomicCommands_SetInlineStyle,u=yne_common_commands_atomicCommands_SetBlockStyle,v=yne_common_commands_atomicCommands_table_SetTableCellInlineStyle,w=yne_common_commands_atomicCommands_table_SetTableCellBlockStyle,x=yne_common_commands_atomicCommands_table_SetTableCellAttr,y=yne_common_constants,z=yne_common_selection_NoteRange,A=yne_common_selection_TableRange;return{createNewListItem:function(a,b,c){var d=new l({id:b,level:a.getLevel(),list:a.getOwnerList(),text:c});return d.setBlockStyles(a.getBlockStyles()),d},createNewParagraph:function(a,b,c,e){var f=new k({id:b,text:e?new i({text:c.toString()}):c});return!a||d.isHeading(a)||d.isCatalogue(a)||f.setBlockStyles(a.getBlockStyles()),f},createNewTodo:function(a,b){var c=new o(b);return a&&c.setBlockStyles(a.getBlockStyles()),c},createNewHeading:function(a,b,c,e,f){var h,i;return c.getLength&&!f&&(i=c.getLength(),d.isHeading(a)&&"b"===a.getLevel()&&(c=this._clearHeadingInlineStyle("color",a,c)),c.setStyles(0,i,g.headingInlineStyles[e])),h=new m({id:b,text:c,level:e}),h.setBlockStyles(a.getBlockStyles()),g.headingBlockStyles[e]&&!f&&h.setBlockStyles(g.headingBlockStyles[e]),h},_clearHeadingInlineStyle:function(a,b,c){var d,e=b.getLevel(),f=g.headingInlineStyles[e],h=f[a];for(d=0;d<c.getLength();d++)h===c.getStylesAtIndex(d)[a]&&delete c._data[d].styles[a];return c},createNewCatalogue:function(a,b){var c=new n(b);return!b.ownerList&&d.isCatalogue(a)&&(b.ownerList=a.getOwnerList()),c=new n(b),a&&c.setBlockStyles(a.getBlockStyles()),c},isForCatalogueBlock:function(a){return d.isHeading(a)&&a.getLevel()<4&&!a.isEmpty()&&a.getText().toString().trim()},deleteSelectedContent:function(a,b,c){var e,f,g,h,i;if(!z.isNoteRange(c))return void j.error("deleteSelectedContent: selectedNoteRange should be a NoteRange",c);e=c.getStartBlockRange(),g=c.getEndBlockRange(),f=e.block,h=g.block,d.isTextBlock(f)&&a.executeAtomicCommand(new p({block:f,start:e.start,end:e.end})),c.isInMultiBlock()&&(i=b.getInterBlocks(f,h),i&&i.length>0&&a.executeAtomicCommand(new q({note:b,blocks:i})),d.isTextBlock(h)&&a.executeAtomicCommand(new p({block:h,start:g.start,end:g.end})))},getBackwardBlockRange:function(a,b){var d=a.getPreBlock(b);if(d)return c.createRangeByBlock({block:d,allContent:!1,collapseToStart:!1})},getForwardBlockRange:function(a,b){var d=a.getNextBlock(b);if(d)return c.createRangeByBlock({block:d,allContent:!1,collapseToStart:!0})},insertTabChar:function(a,b,c,d){var e;e=new i({text:"\t"}),e.setStyles(0,e.getLength(),d),a.executeAtomicCommand(new s({block:b,start:c,text:e}))},isInSameList:function(a){var b,c=!1;return d.isListItem(a[0])?c=h.every(a,function(a,c){if(d.isListItem(a)){if(0===c)return b=a.getOwnerList(),!0;if(a.getOwnerList()===b)return!0}return!1}):c},recogLink:function(a,b,c,d){var f,g,h={color:"#003884",underline:!0};f=b.getText().toString().slice(c,d);for(var i=d-1;i>=c;i--)if(b.getTextStyle("href",i,i+1)[0]){c=i;break}f=f.slice(c,d),(g=e.matchEnd(f))&&g.result&&(h.href=g.fullURI,a.executeAtomicCommand(new t({blocks:[b],styleNameValues:h,start:c+g.result.index,end:d})))},replaceBlockWithListItem:function(a,b,c,d,e,f){var g,h=this,i=d.getId();return a.executeAtomicCommand(new q({note:b,blocks:[d]})),g=h.createNewListItem(c,i,e),a.executeAtomicCommand(new r({note:b,newBlks:[g],preBlk:f})),g},replaceBlockWithParagraph:function(a,b,c,d,e){var f,g=this,h=c.getId(),i=b.getPreBlock(c);return f=g.createNewParagraph(c,h,d,e),a.executeAtomicCommand(new q({note:b,blocks:[c]})),a.executeAtomicCommand(new r({note:b,newBlks:[f],preBlk:i})),f},replaceBlockWithHeading:function(a,b,c,d,e){var f,g=this,h=c.getId(),i=b.getPreBlock(c);return f=g.createNewHeading(c,h,d,e),a.executeAtomicCommand(new q({note:b,blocks:[c]})),a.executeAtomicCommand(new r({note:b,newBlks:[f],preBlk:i})),f},deleteHref:function(a,b,c,d){var e={href:"",color:"#393939",underline:!1};a.executeAtomicCommand(new t({blocks:[b],styleNameValues:e,start:c,end:d}))},resetAllStyles:function(a,b,c){this.setStylesOnNoteRange(a,b,c)},setNonTextBlockAsEndingRange:function(a,c){var d=b.buildNoteRangeFromNonTextBlock(c);a.setEndingRange(d)},setBlockStyleByPreBlock:function(a,b){var c,e;a&&a.setInlineStylesForEmpty&&a.isEmpty()&&b&&b.getText&&!d.isHeading(b)&&(b.isEmptyContent()?e=b.getInlineStylesForEmpty():(c=b.getText(),e=c.getStylesAtIndex(c.getLength()-1),e=h.clone(e)),a.setInlineStylesForEmpty(e))},setStylesOnNoteRange:function(a,b,c,e,g){var i,j=this,k=c.getStartBlockRange(),l=k.block,m=c.getEndBlockRange(),n=m.block,o=[],p=[],q=[],r=[];return void 0===e&&void 0===g&&(i=!0,g=f.getAllDefault(["href"])),e=e||{},g=g||{},j._isFullSelected(k)?p.push(l):(i&&(e=l.getDefaultBlockStyles()),j._setBlocksBlockStyles(a,[l],e)),c.isInMultiBlock()&&(o=b.getInterBlocks(l,n),p=h.union(p,o),j._isFullSelected(m)?p.push(n):(i&&(e=n.getDefaultBlockStyles()),j._setBlocksBlockStyles(a,[n],e))),h.each(p,function(b){i&&(e=b.getDefaultBlockStyles()),j._setBlocksBlockStyles(a,[b],e),d.isTextBlock(b)&&q.push(b),d.isTable(b)&&r.push(b)}),h.isEmpty(g)||(d.isTextBlock(l)&&!j._isFullSelected(k)&&a.executeAtomicCommand(new t({blocks:[l],styleNameValues:i&&d.isHeading(l)?l.getDefaultInlineStyles():g,start:k.start,end:k.end})),c.isInMultiBlock()&&d.isTextBlock(n)&&!j._isFullSelected(m)&&a.executeAtomicCommand(new t({blocks:[n],styleNameValues:i&&d.isHeading(n)?n.getDefaultInlineStyles():g,start:m.start,end:m.end})),p.length>0&&(q=j._filterHeadingBlock(a,q,g,i),a.executeAtomicCommand(new t({blocks:q,styleNameValues:g,fullText:!0})))),this._filterTableBlocks({isStyleReset:i,startBlockRange:k,endBlockRange:m,noteRange:c,fullSelectedTableBlocks:r,inlineStyles:g,blockStyles:e,targetCmd:a})},_filterHeadingBlock:function(a,b,c,e){if(!e)return b;var f=b.filter(function(a){if(!d.isHeading(a))return a}),g=b.filter(function(a){if(d.isHeading(a))return a});return g.length>0&&g.forEach(function(b){a.executeAtomicCommand(new t({blocks:[b],styleNameValues:b.getDefaultInlineStyles(),fullText:!0}))}),f},_filterTableBlocks:function(a){var b=this,c=a.startBlockRange,e=a.endBlockRange,f=a.noteRange,g=a.fullSelectedTableBlocks,i=a.inlineStyles,j=a.blockStyles,k=a.targetCmd,l=c.block,m=e.block;c.isOnCellEdit&&c.isOnCellEdit()||b._adaptTableStylesInlineToBlock(i,j,a.isStyleReset),h.isEmpty(i)||(d.isTable(l)&&b._setTableCellInlineStyles({table:l,range:c,styles:i,cmd:k}),f.isInMultiBlock()&&d.isTable(m)&&b._setTableCellInlineStyles({table:m,range:e,styles:i,cmd:k}),g.forEach(function(a){b._setTableCellInlineStyles({table:a,styles:i,isAll:!0,cmd:k})})),h.isEmpty(j)||(d.isTable(l)&&b._setTableCellBlockStyles({table:l,range:c,styles:j,cmd:k}),f.isInMultiBlock()&&d.isTable(m)&&b._setTableCellBlockStyles({table:m,range:e,styles:j,cmd:k}),g.forEach(function(a){b._setTableCellBlockStyles({block:a,isAll:!0,styles:j,cmd:k})}))},_adaptTableStylesInlineToBlock:function(a,b,c){!h.isEmpty(a)&&a["back-color"]&&(b.backColor=a["back-color"],c||delete a["back-color"])},_setTableCellInlineStyles:function(a){var b,c,d=a.isAll,e=a.range,f=a.cmd,g=d?A.TYPES.ALL:A.TYPES.NORMAL;e?b=e.getAsRectRange():g===A.TYPES.ALL&&(e=A.create({block:a.table,type:A.TYPES.ALL}),b=e.getAsRectRange()),c=b?b.getRect():null,f.executeAtomicCommand(new v({table:a.table,styles:a.styles,type:g,rect:c}))},_setTableCellBlockStyles:function(a){var b=a.isAll,c=a.range,d=a.cmd,e=c.getAsRectRange(),f=b?A.ALL:A.NORMAL,g=c&&e?e.getRect():null;d.executeAtomicCommand(new w({table:a.table,styles:a.styles,type:f,rect:g}))},setTextBlockAsEndingRange:function(a,c,d,e){var f=b.buildNoteRangeFromParagraph(c,d,e);a.setEndingRange(f)},updateBlocksIndentLevel:function(a,b,c){var d,e,f={},g={};h.each(b,function(a){d=a.getBlockStyle("indent"),!h.isNumber(d)||0===d&&c<0||(e=parseInt(a.getBlockStyle("text-indent"),10)||0,d=d<0?0:d+c,d=Math.min(d,y.MAX_LIST_ITEM_LEVEL-e),f[d]||(f[d]=[]),f[d].push(a))}),h.each(f,function(b,c){g.indent=c,a.executeAtomicCommand(new u({blocks:b,styleNameValues:g}))})},updateBlockTextIndentLevel:function(a,b,c){var d,e,f;d=b.getBlockStyle("text-indent"),f=parseInt(b.getBlockStyle("indent"),10)||0,d||(d=0),e=d+c,(e=Math.min(e,y.MAX_LIST_ITEM_LEVEL-f))>=0&&a.executeAtomicCommand(new u({blocks:[b],styleNameValues:{"text-indent":e}}))},_isFullSelected:function(a){var b=a.block;return d.isTextBlock(b)?0===a.start&&a.end===b.getLength()||void 0:!d.isTable(b)||a.isFullSelected()},_setBlocksBlockStyles:function(a,b,c){h.isEmpty(c)||a.executeAtomicCommand(new u({blocks:b,styleNameValues:c}))},fixMergeCellBeforeRowColChange:function(a){a.isCol?this._fixMergeCellColChange(a):this._fixMergeCellRowChange(a)},_fixMergeCellRowChange:function(a){var b,c,d,e,f=this,g=a.table,h=a.isCol,i=a.insertData,k=a.isDelete,l=a.index,m=g.getCells();if(m[l])for(c=0;c<m[l].length;c++)if((b=g.getCell(l,c))&&(b.isMergePoint()&&k&&(e=f._fixMergePointCellWhenDel({cell:b,row:l,col:c,table:g,isCol:h,cmd:a.cmd})),b.isMergedCell())){if(d=f._findMergePointCell({cell:b,row:l,col:c,table:g}),d.row===l)continue;if(e=f._fixMergePointWithMergeCell({pointCellInfo:d,table:g,isCol:h,isDelete:k,insertData:i,cmd:a.cmd,cellInfo:{row:l,col:c}}),e.col<c)return void j.error("New index should more then i");c=e.col}},_fixMergeCellColChange:function(a){var b,c,d,e,f=this,g=a.table,h=a.isCol,i=a.insertData,k=a.isDelete,l=a.index,m=g.getCells();for(c=0;c<m.length;c++)if((b=g.getCell(c,l))&&(b.isMergePoint()&&k&&(e=f._fixMergePointCellWhenDel({cell:b,row:c,col:l,table:g,isCol:h,cmd:a.cmd}),c=e.row),b.isMergedCell())){if(d=f._findMergePointCell({cell:b,row:c,col:l,table:g}),d.col===l)continue;if(e=f._fixMergePointWithMergeCell({pointCellInfo:d,table:g,isCol:h,isDelete:k,insertData:i,cmd:a.cmd,cellInfo:{row:c,col:l}}),e.row<c)return void j.error("New index should more then i");c=e.row}},_findMergePointCell:function(a){var b=a.row,c=a.col,d=a.table;return d.getCell(b,c,{findMergePointIfNeeded:!0,withPosition:!0})},_fixMergePointWithMergeCell:function(a){var b,c,d,e,f=a.table,g=a.pointCellInfo,h=a.cellInfo,i=a.isDelete,j=a.isCol,k=a.cmd,l=a.insertData,m=g.cell,n=g.row,o=g.col,p=m.getMergePointAttr(),q=h.row,r=h.col,s=0,t=0;for(i?j?s=-1:t=-1:j?s=1:t=1,k.executeAtomicCommand(new x({table:f,type:x.TYPES.POINT,value:{width:p.width+s,height:p.height+t,fireChange:!1},rect:{row:n,col:o}})),b=q;b<n+p.height;b++)for(c=r;c<o+p.width;c++)d=f.getCell(b,c),e=d.getMergedCellAttr(),c===r&&!i&&j&&l[b]&&l[b].setMergedCellAttr(e.dx,e.dy),b!==q||i||j||!l[c]||l[c].setMergedCellAttr(e.dx,e.dy),k.executeAtomicCommand(new x({table:f,type:x.TYPES.CELL,value:{dx:e.dx+s,dy:e.dy+t,fireChange:!1},rect:{row:b,col:c}}));return{row:n+p.height-1,col:o+p.width-1}},_fixMergePointCellWhenDel:function(a){var b,c,d,e,f=a.cell,g=a.row,h=a.col,i=a.table,j=a.isCol,k=a.cmd,l=f.getMergePointAttr(),m=0,n=0;for(j?n=1:m=1,b=g+m;b<g+l.height;b++)for(c=h+n;c<h+l.width;c++)(d=i.getCell(b,c))&&(b!==g+m||c!==h+n?(e=d.getMergedCellAttr(),k.executeAtomicCommand(new x({table:i,type:x.TYPES.CELL,value:{dx:e.dx-n,dy:e.dy-m},rect:{row:b,col:c}}))):k.executeAtomicCommand(new x({table:i,type:x.TYPES.POINT,value:{width:l.width-n,height:l.height-m},rect:{row:b,col:c}})));return{row:g+l.height-1,col:h+l.width-1}}}}(),yne_common_commands_compCommands_AppendBlank=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_utils_CompCmdUtils,f=yne_common_commands_atomicCommands_InsertBlocks,g=yne_common_selection_rangeUtil,h=yne_collaboration_collabUtils;return b=c.extend({name:"comp.AppendBlank",_cmdArgs:null,_note:null,_newBlkId:null,_preBlkId:null,_preBlock:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},h.isCollabCommand(a._cmdArgs)||(a._newBlkId=h.newGUID(),a._preBlock=a._note.getLastBlock(),a._preBlock&&(a._preBlkId=a._preBlock.getId())),b.__super__.initialize.apply(a,arguments)},apply:function(){var a,b,c=this;return a=e.createNewParagraph(c._preBlock,c._newBlkId,""),e.setBlockStyleByPreBlock(a,c._preBlock),!1!==c.executeAtomicCommand(new f({note:c._note,newBlks:[a],preBlk:c._preBlock}))&&(b=g.buildNoteRangeFromParagraph(a,0,0),c.setEndingRange(b),!0)},fromCollabJSON:function(){var a=this,c=a.options.args.collabProperties.cmdJSON;c&&(a._newBlkId=c.newBlkId,c.preBlkId&&(a._preBlock=a._note.getBlockById(c.preBlkId))),b.__super__.fromCollabJSON.apply(a)},toCollabJSON:function(){var a,c=this;return c.rangeIsRequired=!1,c.resetAffectedBlockIds(),a=b.__super__.toCollabJSON.apply(c),a.newBlkId=c._newBlkId,c._preBlkId&&(a.preBlkId=c._preBlkId),a}}),d.add(b),b}(),yne_common_commands_compCommands_ApplyStyles=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_underscore,g=yne_common_commands_utils_CompCmdUtils,h=yne_collaboration_collabUtils;return b=c.extend({name:"comp.ApplyStyles",_note:null,_cmdArgs:null,_blockStyleNameValues:null,_inlineStyleNameValues:null,initialize:function(){var a,c=this;if(c._note=c.options.note,c._cmdArgs=c.options.args,a=c._cmdArgs.range,b.__super__.initialize.apply(c),!h.isCollabCommand(c._cmdArgs)){if(!a)return e.error("note range should NOT be null:",c.name),void(c.isReadyToApply=!1);c._blockStyleNameValues=c._cmdArgs.blockStyles,c._inlineStyleNameValues=c._cmdArgs.inlineStyles}},apply:function(){var a=this,b=a._cmdArgs.range;return!g.setStylesOnNoteRange(a,a._note,b,a._blockStyleNameValues,a._inlineStyleNameValues)&&(a.setEndingRange(b),!0)},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;c&&(c.blockStyles&&(a._blockStyleNameValues=c.blockStyles),c.inlineStyles&&(a._inlineStyleNameValues=c.inlineStyles)),b.__super__.fromCollabJSON.apply(a)},isInlineStateSet:function(){var a=this,b=a._cmdArgs.range,c=!1;return b&&b.isCollapsed()&&(!a._blockStyleNameValues||f.isEmpty(a._blockStyleNameValues))&&a._inlineStyleNameValues&&!f.isEmpty(a._inlineStyleNameValues)&&(c=!0),c},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c&&(a._blockStyleNameValues&&!f.isEmpty(a._blockStyleNameValues)&&(c.blockStyles=a._blockStyleNameValues),a._inlineStyleNameValues&&!f.isEmpty(a._inlineStyleNameValues)&&(c.inlineStyles=a._inlineStyleNameValues)),c}}),d.add(b),b}(),yne_common_commands_abstractCommands_DeleteNoteRange=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_utils_CompCmdUtils,f=yne_common_data_blockTypes,g=yne_jtk_core_L,h=yne_common_commands_atomicCommands_DeleteBlocks,i=yne_common_commands_atomicCommands_DeleteBlockText,j=yne_common_commands_atomicCommands_InsertBlockText,k=yne_common_commands_atomicCommands_SetInlineStyle,l=yne_common_commands_utils_href,m=yne_common_selection_rangeUtil;return b=c.extend({name:"abstract.comp.DeleteNoteRange",_cmdArgs:null,_note:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args,b.__super__.initialize.apply(a)},apply:function(){var a,b,c,d,i,k=this,l=k._cmdArgs.range,m=[];if(!l)return g.error(this.name+":note range should NOT be null"),!1;if(a=l.getStartBlockRange(),b=a.block,c=l.getEndBlockRange(),d=c.block,i=k._note.getNextBlock(d),!l.isCollapsed()&&(e.deleteSelectedContent(k,k._note,l),l.isInSingleBlock()&&f.isTextBlock(b)))return e.setTextBlockAsEndingRange(k,b,a.start,a.start),!0;if(l.isInSingleBlock()){if(f.isTextBlock(b)){if(l.isCollapsed())return a.start===b.getLength()?k._deleteAtTextBlockEnd(i,b):k._deleteAtTextBlockMiddle(b,a.start);e.setTextBlockAsEndingRange(k,b,a.start,a.start)}else i&&!f.isTable(i)?(k.executeAtomicCommand(new h({note:k._note,blocks:[b]})),b=i):b=e.replaceBlockWithParagraph(k,k._note,b,""),f.isTextBlock(b)?e.setTextBlockAsEndingRange(k,b,0,0):e.setNonTextBlockAsEndingRange(k,b);return!0}return l.isInMultiBlock(d)?(f.isTextBlock(b)&&f.isTextBlock(d)?(k.executeAtomicCommand(new j({block:b,start:b.getLength(),text:d.getText()})),m.push(d),e.setTextBlockAsEndingRange(k,b,a.start,a.start)):f.isTextBlock(b)?(m.push(d),e.setTextBlockAsEndingRange(k,b,a.start,a.start)):f.isTextBlock(d)?(m.push(b),e.setTextBlockAsEndingRange(k,d,0,0)):(m.push(b),i?m.push(d):d=e.replaceBlockWithParagraph(k,k._note,d,""),e.setTextBlockAsEndingRange(k,d,0,0)),k.executeAtomicCommand(new h({note:k._note,blocks:m})),!0):void 0},_deleteAtTextBlockEnd:function(a,b){var c,d=this;return!(a&&!f.isTable(a))||(f.isAttachment(a)||f.isImage(a)?(d.setEndingRange(m.buildNoteRangeFromNonTextBlock(a)),!0):(c=b.getLength(),f.isTextBlock(a)&&d.executeAtomicCommand(new j({block:b,start:b.getLength(),text:a.getText()})),d.executeAtomicCommand(new h({note:d._note,blocks:[a]})),e.setTextBlockAsEndingRange(d,b,c,c),!0))},_deleteAtTextBlockMiddle:function(a,b){var c=this;if(l.isAtHrefBorder(a,b,!1))return c._deleteHref(a,b,!1),!0;c.executeAtomicCommand(new i({block:a,start:b,end:b+1})),e.setTextBlockAsEndingRange(c,a,b,b)},_deleteHref:function(a,b){var c,d=this,e={href:"",color:"#393939",underline:!1};-1!==(c=l.findHrefBorder(a,b,!1))&&d.executeAtomicCommand(new k({blocks:[a],styleNameValues:e,start:b,end:c+1}))},isSingleBlockAffected:function(){var a,c,d=this,e=d._args.range,f=b.__super__.isSingleBlockAffected.apply(d),g=0;return f&&e&&e.isCollapsed()&&(c=e.getStartBlockRange(),a=c.block,g=c.start,d._note.getNextBlock(a)&&g===a.getEndOffset()&&(f=!1)),f}}),d.add(b),b}(),yne_common_commands_compCommands_DeleteNoteRange=function(a){var b,c=yne_common_commands_abstractCommands_DeleteNoteRange,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_collaboration_collabUtils;return b=c.extend({name:"comp.DeleteNoteRange",_cmdArgs:null,_note:null,initialize:function(){var a,c=this;if(c._note=c.options.note,c._cmdArgs=c.options.args,b.__super__.initialize.apply(c),!f.isCollabCommand(c._cmdArgs)){if(!(a=c._cmdArgs.range))return c.isReadyToApply=!1,void e.error("note range should NOT be null",this.name);if(a.isCollapsed()&&!c._cmdArgs.isTableDelete)return c.isReadyToApply=!1,e.error("should NOT trigger the cmd when NoteRange is collapsed",a),!1}},isSingleBlockAffected:function(){var a,c,d=this,e=d._args.range,f=b.__super__.isSingleBlockAffected.apply(d),g=0;return f&&e&&e.isCollapsed()&&(c=e.getStartBlockRange(),a=c.block,g=c.start,d._note.getNextBlock(a)&&g===a.getEndOffset()&&(f=!1)),f}}),d.add(b),b}(),yne_common_commands_compCommands_DragBlocks=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_underscore,g=yne_common_data_blockTypes,h=yne_common_commands_utils_CompCmdUtils,i=yne_common_selection_NoteRange,j=yne_common_commands_atomicCommands_InsertBlocks,k=yne_common_commands_atomicCommands_InsertBlockText,l=yne_common_commands_atomicCommands_DeleteBlockText,m=yne_common_commands_atomicCommands_DeleteBlocks,n=yne_common_selection_blockRangeUtil,o=yne_common_data_blockUtils,p=yne_collaboration_collabUtils;return b=c.extend({name:"comp.DragBlocks",_note:null,_cmdArgs:null,_dropBlockRange:null,_insertedBlocks:null,_newEndBlankParaId:null,_insertedBlocksJSON:null,initialize:function(){var a,c=this;if(c._note=c.options.note,c._cmdArgs=c.options.args,b.__super__.initialize.apply(c),!p.isCollabCommand(c._cmdArgs)){if(!(a=c._cmdArgs.range))return e.error(c.name+":note range should NOT be null"),void(c.isReadyToApply=!1);if(c._dropBlockRange=c._cmdArgs.dropRange,c._insertedBlocks=[],c._insertedBlocksJSON=[],f.each(c._cmdArgs.blocks,function(a){c._insertedBlocks.push(a),c._insertedBlocksJSON.push(a.toCollabJSON())}),c._newEndBlankParaId=p.newGUID(),!(c._dropBlockRange&&c._dropBlockRange.block&&g.isTextBlock(c._dropBlockRange.block)&&c._dropBlockRange.isCollapsed()))return c.isReadyToApply=!1,void e.error("drag destination should be a single pos in text block",c._dropBlockRange);if(c._isDropRangeInStartNoteRange(c._dropBlockRange))return c.isReadyToApply=!1,void e.error("dropBlockRange should not be in the startNoteRange",a,c._dropBlockRange)}},apply:function(){var a,b=this;return a=n.createRangeByBlock({block:b._dropBlockRange.block,start:b._dropBlockRange.start,end:b._dropBlockRange.end}),a=b._handleStartNoteRangeData(a),b._insertDraggedData(a),!0},_handleStartNoteRangeData:function(a){var b,c,d,e,i,j,l,n=this,o=n._cmdArgs.range,p=[];return b=o.getStartBlockRange(),c=b.block,d=o.getEndBlockRange(),e=d.block,l=n._isFullSelectionInTextBlock(b),o.isCollapsed()||h.deleteSelectedContent(n,n._note,o),o.isInMultiBlock()?(g.isTextBlock(c)&&!c.isEmpty()||(p.push(c),c=null),g.isTextBlock(e)&&!e.isEmpty()||(p.push(e),e=null),f.isEmpty(p)&&(a.block.getId()===e.getId()&&(a=n._rebuildDropRangeWhenNoteRangeMerge(b,d,a)),n.executeAtomicCommand(new k({block:c,start:c.getLength(),text:e.getText()})),p.push(e)),n.executeAtomicCommand(new m({note:n._note,blocks:p}))):g.isTextBlock(c)?l&&(i=n._note.getPreBlock(c),j=n._note.getNextBlock(c),g.isImage(i)||g.isImage(j)||g.isAttachment(i)||g.isAttachment(j)||g.isTable(i)||g.isTable(j)||(n.executeAtomicCommand(new m({note:n._note,blocks:[c]})),c=null)):(h.replaceBlockWithParagraph(n,n._note,c,""),c=null),a},_insertDraggedData:function(a){var b,c,d,e,o,p,q=this,r=q._cmdArgs.range,s=q._insertedBlocks[0],t=f.last(q._insertedBlocks),u=a.block;b=r.getStartBlockRange(),b.block.getId(),c=r.getEndBlockRange(),c.block.getId(),q._tuneDropBlockRange(a,b,c),
g.isTextBlock(s)&&!g.isHeading(s)?(q._insertedBlocks.shift(),q.executeAtomicCommand(new k({block:a.block,start:a.start,text:s.getText()})),o=n.createRangeByBlock({block:a.block,start:a.start,end:a.start+s.getLength()}),p=o,a.start+=s.getLength(),a.end=a.start):(o=n.createRangeByBlock({block:q._insertedBlocks[0]}),p=o),f.isEmpty(q._insertedBlocks)||(d=a.block.sliceText(a.start,a.block.getLength()),r.isInMultiBlock()&&(p=g.isTextBlock(t)?n.createRangeByBlock({block:t,start:0,end:t.getLength()}):n.createRangeByBlock({block:t})),0===a.start?(u=q._note.getPreBlock(a.block),g.isTextBlock(t)?(t.append(d),q.executeAtomicCommand(new m({note:q._note,blocks:[a.block]}))):0===a.block.getLength()&&q.executeAtomicCommand(new m({note:q._note,blocks:[a.block]}))):a.start<a.block.getLength()&&(q.executeAtomicCommand(new l({block:a.block,start:a.start,end:a.block.getLength()})),g.isTextBlock(t)?t.append(d):(e=g.isListItem(a.block)?h.createNewListItem(a.block,q._newEndBlankParaId,d):g.isHeading(a.block)?h.createNewHeading(a.block,q._newEndBlankParaId,d,a.block.getLevel()):g.isTodo(a.block)?h.createNewTodo(a.block,{id:q._newEndBlankParaId,text:d,checked:a.block.getChecked()}):h.createNewParagraph(a.block,q._newEndBlankParaId,d),q._insertedBlocks.push(e),r.isInMultiBlock()&&(p=n.createRangeByBlock({block:e,start:0,end:0})))),q.executeAtomicCommand(new j({note:q._note,newBlks:q._insertedBlocks,preBlk:u}))),q.setEndingRange(i.create({startRange:o,endRange:p}))},_isDropRangeInStartNoteRange:function(a){var b,c=this,d=c._cmdArgs.range,e=d.getStartBlockRange(),g=d.getEndBlockRange(),h=a,i=h.block.getId(),j=!1;return i===e.block.getId()&&h.start>=e.start&&h.start<=e.end&&(j=!0),!j&&d.isInMultiBlock()&&(i===g.block.getId()&&h.start>=g.start&&h.start<=g.end?j=!0:(b=c._note.getInterBlocks(e.block,g.block),f.some(b,function(a){return i===a.getId()&&(j=!0),j}))),j},_isFullSelectionInTextBlock:function(a){var b=!1,c=0;return g.isTextBlock(a.block)&&(c=a.block.getLength()),c>0&&0===a.start&&a.end===c&&(b=!0),b},_rebuildDropRangeWhenNoteRangeMerge:function(a,b,c){var d;return d=c.start+a.start-b.end,n.createRangeByBlock({block:a.block,start:d,end:d})},_tuneDropBlockRange:function(a,b,c){var d=b.block.getId(),e=c.block.getId();a.block.getId()===d&&a.start>b.end&&(a.start-=b.end-b.start,a.end-=a.start),d!==e&&a.block.getId()===e&&a.start>c.end&&(a.start-=c.end-c.start,a.end-=a.start)},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON,e=c.collabProperties.coreEditor;b.__super__.fromCollabJSON.apply(a),d&&(a._newEndBlankParaId=d.newEndBlkId,a._dropBlockRange=e.buildBlockRangeFromJSON(d.dropRange),a._insertedBlocks=[],f.each(d.insertedBlocks,function(b){a._insertedBlocks.push(o.buildBlockFromJSON(b,e))}))},isSingleBlockAffected:function(){var a=this,b=a._cmdArgs.range,c=b.getStartBlockRange();return!(!b.isInSingleBlock()||a._dropBlockRange.block.getId()!==c.block.getId())},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c&&(c.newEndBlkId=a._newEndBlankParaId,c.dropRange=a._dropBlockRange.toCollabJSON(),c.insertedBlocks=a._insertedBlocksJSON),c}}),d.add(b),b}(),yne_common_commands_compCommands_FormatPainter=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_utils_CompCmdUtils,f=yne_common_constants,g=yne_underscore,h=yne_jtk_core_L,i=yne_collaboration_collabUtils;return b=c.extend({name:"comp.FormatPainter",_cmdArgs:null,_note:null,_inlineStyles:null,_blockStyles:null,initialize:function(){var a,c=this;if(c._note=c.options.note,c._cmdArgs=c.options.args||{},a=c._cmdArgs.range,b.__super__.initialize.apply(c,arguments),!i.isCollabCommand(c._cmdArgs)){if(!a)return h.error(c.name+":note range should NOT be null"),void(c.isReadyToApply=!1);c._inlineStyles=c._cmdArgs.data.inlineStyles,c._blockStyles=c._cmdArgs.data.blockStyles}},apply:function(){var a=this,b=a._cmdArgs.range,c={},d={};return!!b.isCollapsed()||(g.each(a._inlineStyles,function(a,b){"href"!==b&&a!==f.INTERM&&null!==a&&void 0!==a&&(c[b]=a)}),g.each(a._blockStyles,function(a,b){a!==f.INTERM&&null!==a&&void 0!==a&&(d[b]=a)}),g.isEmpty(d)&&g.isEmpty(c)||(e.resetAllStyles(a,a._note,b),e.setStylesOnNoteRange(a,a._note,b,d,c)),a.setEndingRange(b),!0)},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;c&&(a._inlineStyles=c.inlineStyles,a._blockStyles=c.blockStyles),b.__super__.fromCollabJSON.apply(a)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a.inlineStyles=c._inlineStyles,a.blockStyles=c._blockStyles,a}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetListItemLevel=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetListItemLevel",_listItems:null,_newLevels:null,_oldLevels:null,initialize:function(){var a=this,c=a.options,d=c.args;f.isCollabCommand(d)||(a._listItems=c.listItems,a._newLevels={},c.newLevel?e.each(a._listItems,function(b,d){a._newLevels[d]=c.newLevel}):c.deltaLevel&&e.each(a._listItems,function(b,d){a._newLevels[d]=b.getLevel()+c.deltaLevel})),b.__super__.initialize.apply(a)},apply:function(){var a=this;return a._oldLevels={},e.each(a._newLevels,function(b,c){a._oldLevels[c]=a._listItems[c].getLevel(),a._listItems[c].setLevel(b)}),!0},doUnapply:function(){var a=this;return e.each(a._oldLevels,function(b,c){a._listItems[c].setLevel(b)}),!0},fromCollabJSON:function(){var a,c=this,d=c.options.args,f=d.collabProperties.cmdJSON;f&&(a=d.collabProperties.coreEditor.getNote(),f.oldLevels&&(c._oldLevels=f.oldLevels),c._newLevels=f.newLevels,c._listItems=[],e.each(f.listItemIds,function(b){c._listItems.push(a.getBlockById(b))})),b.__super__.fromCollabJSON.apply(c)},toCollabJSON:function(){var a=this,c=[],d=b.__super__.toCollabJSON.apply(a);return a._oldLevels&&(d.oldLevels=a._oldLevels),d.newLevels=a._newLevels,e.each(a._listItems,function(a){c.push(a.getId())}),d.listItemIds=c,d}}),d.add(b),b}(),yne_common_commands_compCommands_IndentOutdent=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_blockTypes,f=yne_common_commands_utils_CompCmdUtils,g=yne_jtk_core_L,h=yne_common_commands_atomicCommands_SetListItemLevel,i=yne_collaboration_collabUtils;return b=c.extend({name:"comp.IndentOutdent",_cmdArgs:null,_note:null,_indentStep:null,initialize:function(){var a,c,d,f=this;if(f._note=f.options.note,f._cmdArgs=f.options.args||{},b.__super__.initialize.apply(f,arguments),!i.isCollabCommand(f._cmdArgs)){if(a=f._cmdArgs.range,f._indentStep=f._cmdArgs.indentStep,!a||!a.canDrawedByNative())return g.error(f.name+":note range should NOT be null or cannot be Drawed by native"),void(f.isReadyToApply=!1);if(c=a.getStartBlockRange(),d=c.block,a.isInSingleBlock()&&!e.isTextBlock(d))return void(f.isReadyToApply=!1)}},apply:function(){var a,b,c,d,g,i=this,j=i._cmdArgs.range;return a=j.getStartBlockRange(),b=a.block,c=j.getEndBlockRange(),d=c.block,j.isInMultiBlock()?(g=i._note.getInterBlocks(b,d,!0),f.isInSameList(g)?i._isFirstListItem(g[0])?f.updateBlocksIndentLevel(i,g[0].getOwnerList().getItems(),i._indentStep):i.executeAtomicCommand(new h({listItems:g,deltaLevel:i._indentStep})):f.updateBlocksIndentLevel(i,g,i._indentStep),i.setEndingRange(j),!0):(e.isListItem(b)?i._isFirstListItem(b)?f.updateBlocksIndentLevel(i,b.getOwnerList().getItems(),i._indentStep):i.executeAtomicCommand(new h({listItems:[b],deltaLevel:i._indentStep})):f.updateBlocksIndentLevel(i,[b],i._indentStep),i.setEndingRange(j),!0)},_isFirstListItem:function(a){return 1===a.getLevel()&&1===a.getIndex()},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;c&&(a._indentStep=c.indentStep),b.__super__.fromCollabJSON.apply(a)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.indentStep=c._indentStep),a}}),d.add(b),b}(),yne_common_commands_abstractCommands_InsertResource=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_blockTypes,f=yne_common_commands_utils_CompCmdUtils,g=yne_jtk_core_L,h=yne_common_commands_atomicCommands_DeleteBlocks,i=yne_common_commands_atomicCommands_DeleteBlockText,j=yne_collaboration_collabUtils;return b=c.extend({name:"abstract.comp.InsertResource",_cmdArgs:null,_note:null,_newStartBlkId:null,_newEndBlkId:null,_resourceBlock:null,_retainStartBlock:null,insertResource:function(a,b,c){throw g.error("Method not implemented with:",a,b,c),"Method not implemented"},initialize:function(){var a,c=this;c._note=c.options.note,a=c._cmdArgs=c.options.args||{},b.__super__.initialize.apply(c,arguments),j.isCollabCommand(a)||(c._newStartBlkId=j.newGUID(),c._newEndBlkId=j.newGUID(),1===a.retainStartBlock||"1"===a.retainStartBlock||!0===a.retainStartBlock?c._retainStartBlock=!0:c._retainStartBlock=!1)},apply:function(){var a=this,b=a._cmdArgs.range,c=b.getStartBlockRange(),d=c.block;return b?(b.isCollapsed()||b.isSingleTableSelected()||f.deleteSelectedContent(a,a._note,b),b.isInMultiBlock()?a._handleMultiBlockSelection(b):e.isTable(d)?a._handleSingleTableSelection(b,d):a._handleSingleBlockSelection(b)):(g.error(this.name+":note range should NOT be null"),!1)},_deleteBlocks:function(a){var b=this;b.executeAtomicCommand(new h({note:b._note,blocks:a}))},_deleteBlockText:function(a,b,c){var d=this,e="";return b<c&&(e=a.sliceText(b,c),d.executeAtomicCommand(new i({block:a,start:b,end:c}))),e},_handleMultiBlockSelection:function(a){var b,c,d,g,h,i,j,k,l,m=this,n=[],o=[];return b=a.getStartBlockRange(),c=b.block,h=a.getEndBlockRange(),i=h.block,e.isListItem(c)?(l=m._note.getNextBlock(i),h.start!==i.getLength()?(k=i.getText?i.getText():"",j=f.createNewListItem(c,i.getId(),k),o.push(j.getId())):e.isTextBlock(l)||(j=f.createNewParagraph(i,i.getId(),"")),m._deleteBlocks([i]),m._resourceBlock=m.insertResource(c,null,j),o.push(i.getId(),m._resourceBlock.getId()),j||(j=l)):e.isTextBlock(c)?e.isListItem(i)||!e.isTextBlock(i)?(k=i.getText?i.getText():"",j=f.createNewParagraph(i,i.getId(),k),m._deleteBlocks([i]),m._resourceBlock=m.insertResource(c,null,j),o.push(i.getId(),m._resourceBlock.getId())):(j=i,m._resourceBlock=m.insertResource(c),o.push(m._resourceBlock.getId())):(g=m._note.getPreBlock(c),e.isTextBlock(g)||(d=f.createNewParagraph(g,m._newStartBlkId,""),o.push(m._newStartBlkId)),n.push(c),o.push(c.getId()),e.isTextBlock(i)||(n.push(i),j=f.createNewParagraph(i,i.getId(),""),o.push(i.getId())),m._deleteBlocks(n),m._resourceBlock=m.insertResource(g,d,j),o.push(m._resourceBlock.getId()),j||(j=i)),f.setTextBlockAsEndingRange(m,j,0,0),m.pushAffectedBlockIds(o),!0},_handleSingleBlockSelection:function(a){var b,c,d,g,h,i,j,k=this,l=[];return b=a.getStartBlockRange(),c=b.block,h=a.getEndBlockRange(),h.block,!e.isTextBlock(c)||c.isEmpty()?(g=k._note.getPreBlock(c),i=k._note.getNextBlock(c),i&&e.isTextBlock(i)||(j=f.createNewParagraph(c,k._newEndBlkId,""),l.push(k._newEndBlkId)),k._retainStartBlock&&(e.isTable(c)||e.isAttachment(c)||e.isImage(c))||e.isCatalogue(c)?(g=c,d=f.createNewParagraph(c,k._newStartBlkId,""),l.push(k._newStartBlkId)):(g&&e.isTextBlock(g)||(d=f.createNewParagraph(c,k._newStartBlkId,""),l.push(k._newStartBlkId)),k._deleteBlocks([c]),l.push(c.getId())),k._resourceBlock=k.insertResource(g,d,j)):(i=k._note.getNextBlock(c),b.start!==c.getLength()?j=k._handleSingleParaBlock(b,c):e.isTextBlock(i)||(j=f.createNewParagraph(c,k._newEndBlkId,"")),l.push(k._newEndBlkId),k._resourceBlock=k.insertResource(c,null,j)),l.push(k._resourceBlock.getId()),j||(j=i),f.setTextBlockAsEndingRange(k,j,0,0),k.pushAffectedBlockIds(l),!0},_handleSingleParaBlock:function(a,b){var c,d=this;return c=d._deleteBlockText(b,a.start,b.getLength()),e.isHeading(b)?f.createNewHeading(b,d._newEndBlkId,c,b.getLevel()):e.isCatalogue(b)?f.createNewCatalogue(b,{paraId:d._newEndBlkId,text:c,href:b.getHref()}):e.isListItem(b)?f.createNewListItem(b,d._newEndBlkId,c):e.isTodo(b)?f.createNewTodo(b,{id:d._newEndBlkId,text:c,checked:!1}):f.createNewParagraph(b,d._newEndBlkId,c)},_handleSingleTableSelection:function(a,b){var c=this;return c._resourceBlock=c.insertResource(b),c.setEndingRange(a),!0},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._newStartBlkId=c.newStartBlkId,a._newEndBlkId=c.newEndBlkId,a._retainStartBlock=c.abstractSimpleValue1)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.newStartBlkId=c._newStartBlkId,a.newEndBlkId=c._newEndBlkId,a.abstractSimpleValue1=c._retainStartBlock),a}}),d.add(b),b}(),yne_common_commands_atomicCommands_table_SetTableCellContent=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_common_data_table_constantConfig,g=yne_common_data_table_AttachmentResource,h=yne_collaboration_collabUtils,i=yne_common_data_table_tableCellUtil;return b=c.extend({name:"atom.SetTableCellContent",_table:null,_cellRect:null,_oldContent:null,effected:!1,initialize:function(){var a=this,c=a.options.args;h.isCollabCommand(c)||(a._table=a.options.table,a._cellRect=a.options.cellRect,a._content=a.options.content),b.__super__.initialize.apply(a)},_computeSizeChange:function(a){if(a){var b=this,c=b._table,d=c.getCellSize(a.row,a.col),e={rowHeight:0,rowIndex:-1,colWidth:0,colIndex:-1};if(d)return d.height<f.ATTACHMENT_MIN_HEIGHT&&(e.rowHeight=d.heights[0]+f.ATTACHMENT_MIN_HEIGHT-d.height,e.rowIndex=d.rows[0]),d.width<f.ATTACHMENT_MIN_WIDTH&&(e.colWidth=d.widths[0]+f.ATTACHMENT_MIN_WIDTH-d.width,e.colIndex=d.cols[0]),e.rowHeight||e.colWidth?e:null}},apply:function(){var a,b=this,c=b._table,d=b._getCellInfo(b._cellRect)||{},e=b._contentInfo||c.getContentAt(d.row,d.col);return!!e&&(!!c.setCellContent(d.row,d.col,b._content)&&(b._content instanceof g&&(a=b._sizeChanged||b._computeSizeChange(d)),a&&a.rowHeight&&(b._oldSize={rowIndex:a.rowIndex,rowHeight:c.getRowHeight(a.rowIndex)},c.setRowHeight(a.rowIndex,a.rowHeight)),a&&a.colWidth&&(b._oldSize=b._oldSize||{},b._oldSize.colIndex=a.colIndex,b._oldSize.colWidth=c.getColumnWidth(a.colIndex),c.setColumnWidth(a.colIndex,a.colWidth)),b._sizeChanged=a,b._oldContent=e.content,b.effected=!0,b.effected))},doUnapply:function(){var a,b=this,c=b._table,d=b._getCellInfo(b._cellRect),e=b._oldSize;if(d)return a=c.setCellContent(d.row,d.col,b._oldContent),e&&e.rowHeight&&c.setRowHeight(e.rowIndex,e.rowHeight),e&&e.colWidth&&c.setColumnWidth(e.colIndex,e.colWidth),a},_getCellInfo:function(a){var b=this,c=b._table;if(null!=a.row&&null!=a.col)return{row:a.row,col:a.col,cell:c.getCell(a.row,a.col)};e.error("No cellRect!")},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._content=i.contentFromCollabJSON(f.simpleValue1),c._oldContent=i.contentFromCollabJSON(f.simpleValue2),c._sizeChanged=f.sizeChanged,c._oldSize=f.oldSize,c._cellRect=f.newBlkId)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=i.contentToCollabJSON(a._content),c.simpleValue2=i.contentToCollabJSON(a._oldContent),c.sizeChanged=a._sizeChanged,c.oldSize=a._oldSize,c.newBlkId=a._cellRect,c}}),d.add(b),b}(),yne_common_commands_compCommands_InsertAttachment=function(a){var b,c=yne_common_commands_abstractCommands_InsertResource,d=yne_common_commands_commandClassMap,e=yne_common_data_blockTypes,f=yne_common_data_Attachment,g=yne_common_data_table_AttachmentResource,h=yne_common_commands_atomicCommands_InsertBlocks,i=yne_common_commands_atomicCommands_table_SetTableCellContent,j=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertAttachment",_cmdArgs:null,_note:null,_attachBlkId:null,_attachSrc:null,_attachRes:null,_attachFileName:null,_attchFileLen:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},b.__super__.initialize.apply(a,arguments),j.isCollabCommand(a._cmdArgs)||(a._attachBlkId=j.newGUID(),a._attachSrc=a._cmdArgs.src,a._attachRes=a._cmdArgs.resource,a._attachFileName=a._cmdArgs.fileName,a._attchFileLen=a._cmdArgs.fileLength)},insertResource:function(a,b,c){var d,g=this,i=g._cmdArgs.range,j=[];return e.isTable(a)&&i.isSingleTableSelected()?g._insertAttachmentInTable(a):(d=new f({source:g._attachSrc,resource:g._attachRes,fileName:g._attachFileName,fileLength:g._attchFileLen}),b&&j.push(b),j.push(d),c&&j.push(c),d.setId(g._attachBlkId),g.executeAtomicCommand(new h({note:g._note,newBlks:j,preBlk:a})),d)},_insertAttachmentInTable:function(a){var b,c=this,d=c._cmdArgs.range,e=d.getStartBlockRange(),f=e.getAsRectRange();if(f)return b=f.getFirstCellRect(),c.executeAtomicCommand(new i({table:a,cellRect:b,content:new g({source:c._attachSrc,resource:c._attachRes,fileName:c._attachFileName,fileLength:c._attchFileLen})})),a},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._attachBlkId=c.newBlkId,a._attachSrc=c.src,a._attachRes=c.attachRes,a._attachFileName=c.fileName,a._attchFileLen=c.fileLen)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.newBlkId=c._attachBlkId,a.src=c._attachSrc,a.attachRes=c._attachRes,a.fileName=c._attachFileName,a.fileLen=c._attchFileLen),a}}),d.add(b),b}(),yne_common_commands_compCommands_InsertBlocks=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_underscore,g=yne_common_data_blockTypes,h=yne_common_commands_utils_CompCmdUtils,i=yne_common_selection_NoteRange,j=yne_common_commands_atomicCommands_InsertBlocks,k=yne_common_commands_atomicCommands_InsertBlockText,l=yne_common_commands_atomicCommands_DeleteBlocks,m=yne_common_commands_atomicCommands_DeleteBlockText,n=yne_common_selection_blockRangeUtil,o=yne_common_data_blockUtils,p=yne_common_data_RichText,q=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertBlocks",_note:null,_cmdArgs:null,_insertedBlocks:null,_newEndBlankParaId:null,_insertedBlocksJSON:null,initialize:function(){var a=this;if(a._note=a.options.note,a._cmdArgs=a.options.args,b.__super__.initialize.apply(a),!q.isCollabCommand(a._cmdArgs)){if(!a._cmdArgs.range)return e.error(a.name+":note range should NOT be null"),void(a.isReadyToApply=!1);a._insertedBlocks=[],a._insertedBlocksJSON=[],f.each(a._cmdArgs.blocks,function(b){a._insertedBlocks.push(b),a._insertedBlocksJSON.push(b.toCollabJSON())}),a._newEndBlankParaId=q.newGUID()}},apply:function(){var a,b,c,d=this,e=d._note,i=d._cmdArgs.range,j=f.last(d._insertedBlocks);return d._getCollabRequiredData(d._insertedBlocks),g.isTextBlock(j)?b=n.createRangeByBlock({block:j,start:j.getLength(),end:j.getLength()}):(c=e.getNextBlock(d.startingRange._endRange.block),g.isTextBlock(c)&&(b=n.createRangeByBlock({block:c,start:c.getLength(),end:c.getLength()}))),i.isCollapsed()||h.deleteSelectedContent(d,d._note,i),a=i.isInMultiBlock()?d._handleMultiBlockSelection(b):d._handleSingleBlockSelection(b),d.setEndingRange(a),!0},_handleMultiBlockSelection:function(a){var b=this,c=b._cmdArgs.range,d=c.getStartBlockRange(),e=d.block,f=c.getEndBlockRange(),h=f.block,j=b._insertedBlocks[0];return 1===b._insertedBlocks.length&&g.isTextBlock(j)&&g.isTextBlock(e)&&g.isTextBlock(h)?(b._insertedBlocks.shift(),a=n.createRangeByBlock({block:e,start:e.getLength()+j.getLength(),end:e.getLength()+j.getLength()}),j.append(h.getText()),b.executeAtomicCommand(new l({note:b._note,blocks:[h]})),b.executeAtomicCommand(new k({block:e,start:e.getLength(),text:j.getText()}))):a=b._insertBlocksBetweenStartEndBlock(d,f,a),i.create({startRange:a,endRange:a})},_getCollabRequiredData:function(a){var b=this,c=[];a&&a.length>0&&f.each(a,function(a){c.push(a.getId())}),c.push(b._newEndBlankParaId),b.pushAffectedBlockIds(c)},_handleSingleBlockSelection:function(a){var b,c=this,d=c._cmdArgs.range,e=d.getStartBlockRange(),h=e.block;return b=g.isTextBlock(h)?c._handleSingleTextStartBlock(h,a):c._handleSingleNonTextStartBlock(h,a),f.isEmpty(c._insertedBlocks)||(b.needToRebuildLIs&&c._rebuildListItems(c._insertedBlocks,b.refBlockForInsert,b.deltaLevel),c.executeAtomicCommand(new j({note:c._note,newBlks:c._insertedBlocks,preBlk:b.refBlockForInsert}))),i.create({startRange:b.newEndBlockRange,endRange:b.newEndBlockRange})},_handleSingleNonTextStartBlock:function(a,b){var c=this,d=c._insertedBlocks[0],e=f.last(c._insertedBlocks),i=c._note.getPreBlock(a),j=c._note.getNextBlock(a),k={};return k.refBlockForInsert=i,k.newEndBlockRange=b,k.needToRebuildLIs=!1,c.executeAtomicCommand(new l({note:c._note,blocks:[a]})),g.isTextBlock(d)||g.isTextBlock(i)||c._insertedBlocks.unshift(h.createNewParagraph(a,a.getId(),"")),g.isTextBlock(e)||g.isTextBlock(j)||(c._insertedBlocks.push(h.createNewParagraph(a,c._newEndBlankParaId,"")),k.newEndBlockRange=n.createRangeByBlock({block:f.last(c._insertedBlocks),start:0,end:0})),k},_handleSingleTextStartBlock:function(a,b){var c,d=this,e=d._cmdArgs.range,h=e.getStartBlockRange(),i=d._note.getPreBlock(a),j=d._note.getNextBlock(a),o=d._insertedBlocks[0],q=f.last(d._insertedBlocks),r="",s=1===d._insertedBlocks.length,t={};return t.refBlockForInsert=a,t.newEndBlockRange=b,t.needToRebuildLIs=!1,t.deltaLevel=0,h.start<a.getLength()&&(r=a.sliceText(h.start,a.getLength())),s&&g.isTextBlock(o)||(g.isTextBlock(q)?(c=r instanceof p?r:p.createBlank(),q.append(c),d.executeAtomicCommand(new m({block:a,start:h.start,end:a.getLength()}))):""===r&&g.isTextBlock(j)?t.newEndBlockRange=n.createRangeByBlock({block:j,start:0,end:0}):(d._insertedBlocks.push(d._buildNewBlockFromStartBlock(a,d._newEndBlankParaId,r)),t.newEndBlockRange=n.createRangeByBlock({block:f.last(d._insertedBlocks),start:0,end:0}),d.executeAtomicCommand(new m({block:a,start:h.start,end:a.getLength()})))),g.isTextBlock(o)?a.getLength()>0||g.isListItem(a)||!g.isListItem(o)&&!g.isHeading(o)&&!g.isCatalogue(o)&&!g.isTodo(o)?(d._insertedBlocks.shift(),s&&(t.newEndBlockRange=n.createRangeByBlock({block:a,start:h.start+o.getLength(),end:h.start+o.getLength()})),d.executeAtomicCommand(new k({block:a,start:h.start,text:o.getText()})),g.isListItem(a)&&g.isListItem(d._insertedBlocks[0])&&(t.needToRebuildLIs=!0,g.isListItem(o)&&(t.deltaLevel=d._insertedBlocks[0].getLevel()-o.getLevel()))):(t.refBlockForInsert=i,d.executeAtomicCommand(new l({note:d._note,blocks:[a]})),g.isListItem(i)&&(t.needToRebuildLIs=!0,t.deltaLevel=1-i.getLevel())):0===a.getLength()&&g.isTextBlock(i)&&(t.refBlockForInsert=i,d.executeAtomicCommand(new l({note:d._note,blocks:[a]}))),t},_buildNewBlockFromStartBlock:function(a,b,c){return g.isHeading(a)?h.createNewHeading(a,b,c,a.getLevel()):g.isCatalogue(a)?h.createNewCatalogue(a,{paraId:b,text:c,href:a.getHref()}):g.isListItem(a)?h.createNewListItem(a,b,c):g.isTodo(a)?h.createNewTodo(a,{id:b,text:c,checked:a.getChecked()}):h.createNewParagraph(a,b,c)},_insertBlocksBetweenStartEndBlock:function(a,b,c){var d=this,e=a.block,i=b.block,j=d._note.getPreBlock(e),m=d._note.getNextBlock(i),o=d._insertedBlocks[0],p=f.last(d._insertedBlocks),q=e,r=[],s=0;return g.isTextBlock(i)?g.isTextBlock(p)?(r.push(i),p.append(i.getText())):g.isTextBlock(p)||(c=n.createRangeByBlock({block:i,start:0,end:0})):(r.push(i),g.isTextBlock(m)||g.isTextBlock(p)?g.isTextBlock(p)||(c=n.createRangeByBlock({block:m,start:0,end:0})):(d._insertedBlocks.push(h.createNewParagraph(i,i.getId(),"")),c=n.createRangeByBlock({block:f.last(d._insertedBlocks),start:0,end:0}))),g.isTextBlock(e)?g.isTextBlock(o)?e.getLength()>0||g.isListItem(e)||!g.isListItem(o)?(d._insertedBlocks.shift(),d.executeAtomicCommand(new k({block:e,start:e.getLength(),text:o.getText()})),g.isListItem(o)&&g.isListItem(d._insertedBlocks[0])&&(s=d._insertedBlocks[0].getLevel()-o.getLevel())):(q=j,d.executeAtomicCommand(new l({note:d._note,blocks:[e]}))):0===e.getLength()&&g.isTextBlock(j)&&(q=j,d.executeAtomicCommand(new l({note:d._note,blocks:[e]}))):(r.push(e),q=j,g.isTextBlock(j)||g.isTextBlock(o)||d._insertedBlocks.unshift(h.createNewParagraph(e,e.getId(),""))),f.isEmpty(r)||d.executeAtomicCommand(new l({note:d._note,blocks:r})),d._insertedRemainedBlocks(q,s),c},_insertedRemainedBlocks:function(a,b){var c=this;f.isEmpty(c._insertedBlocks)||(g.isListItem(c._insertedBlocks[0])&&g.isListItem(a)&&c._rebuildListItems(c._insertedBlocks,a,b),c.executeAtomicCommand(new j({note:c._note,newBlks:c._insertedBlocks,preBlk:a})))},_rebuildListItems:function(a,b,c){var d,e,h=a[0],i=0;isNaN(c)&&(c=0),e=h.listId,d=b.getOwnerList(),i=b.getLevel()-h.getLevel()+c,f.chain(a).groupBy(function(a){if(g.isListItem(a))return a.listId}).each(function(a,b){a.length>0&&b===e&&f.each(a,function(a){0!==i&&a.setLevel(a.getLevel()+i),a.setOwnerList(d)})})},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON,e=c.collabProperties.coreEditor;b.__super__.fromCollabJSON.apply(a),d&&(a._newEndBlankParaId=d.newEndBlkId,a._insertedBlocks=[],f.each(d.insertedBlocks,function(b){a._insertedBlocks.push(o.buildBlockFromJSON(b,e))}))},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c&&(c.newEndBlkId=a._newEndBlankParaId,c.insertedBlocks=a._insertedBlocksJSON),c}}),d.add(b),b}(),yne_common_commands_compCommands_InsertCatalogue=function(a){var b,c=yne_underscore,d=yne_common_commands_abstractCommands_InsertResource,e=yne_common_commands_commandClassMap,f=yne_common_data_Catalogue,g=yne_common_data_Catalogues,h=yne_common_constants,i=yne_common_commands_utils_CompCmdUtils,j=yne_common_commands_atomicCommands_InsertBlocks,k=yne_collaboration_collabUtils;return b=d.extend({name:"comp.InsertCatalogue",_cmdArgs:null,_note:null,_blkId:null,_ownerId:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},b.__super__.initialize.apply(a,arguments),a._initBlocks()},_initBlocks:function(){var a,b,d=this,e=d._note,j=e.blocks,l=[],m=[];d._ownerId=d._ownerId||k.newGUID(),b=new g({id:d._ownerId}),c.each(j,function(a){i.isForCatalogueBlock(a)&&l.push(a)}),d._catalogueIds=d._catalogueIds||[],c.each(l,function(c,e){a=new f({indent:c.getLevel()-1,text:c.getText().toString().trim(),href:c.getId(),ownerList:b}),m.push(a),d._catalogueIds[e]?a.setId(d._catalogueIds[e]):d._catalogueIds[e]=a.getId()}),0===l.length&&(a=new f({indent:0,text:h.INSERT_BLANK_CATALOGUE_TEXT,ownerList:b}),m.push(a),d._catalogueIds[0]?a.setId(d._catalogueIds[0]):d._catalogueIds[0]=a.getId()),d._newCatalogues=m},insertResource:function(a,b,c){var d=this,e=d._newCatalogues,f=e[e.length-1];return e.length<1?a:(b&&e.unshift(b),c&&e.push(c),d.executeAtomicCommand(new j({note:d._note,newBlks:e,preBlk:a})),f)},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._ownerId=c.listId,a._catalogueIds=c.blockIds)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.listId=c._ownerId,a.blockIds=c._catalogueIds),a}}),e.add(b),b}(),yne_common_commands_compCommands_InsertHeading=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_utils_CompCmdUtils,e=yne_common_commands_commandClassMap,f=yne_common_selection_NoteRange,g=yne_common_selection_blockRangeUtil,h=yne_collaboration_collabUtils,i=yne_common_data_blockTypes;return b=c.extend({name:"comp.InsertHeading",_cmdArgs:null,_note:null,_blkId:null,_level:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},a._level=a._cmdArgs.level,b.__super__.initialize.apply(a,arguments),h.isCollabCommand(a._cmdArgs)||(a._blkId=h.newGUID())},apply:function(){var a,b,c,e=this,h=e._cmdArgs.range,j=h.getStartBlockRange(),k=h.getEndBlockRange(),l=j.block,m=k.block;if(h.isInMultiBlock()){if(c=e._note.getInterBlocks(l,m,!0),c.some(function(a){return!i.isTextBlock(a)}))return!1;c.forEach(function(d,f){return 0===f?void(a=e._helpSetBlock(d)):f===c.length-1?void(b=e._helpSetBlock(d)):void e._helpSetBlock(d)}),e.setEndingRange(new f({startRange:g.createRangeByBlock({block:a,start:j.start,end:j.end}),endRange:g.createRangeByBlock({block:b,start:k.start,end:k.end})}))}else{if(!i.isTextBlock(m))return!1;b=e._helpSetBlock(m),d.setTextBlockAsEndingRange(e,b,k.start,k.end)}},_helpSetBlock:function(a){var b=this;return"default"===b._level||i.isHeading(a)&&a.getLevel()===b._level?d.replaceBlockWithParagraph(b,b._note,a,a.getText(),!0):d.replaceBlockWithHeading(b,b._note,a,a.getText(),b._level)},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._blkId=c.blockId,a._level=c.listType)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.blockId=c._blkId,a.listType=c._level),a}}),e.add(b),b}(),yne_common_commands_compCommands_InsertHorizontalRule=function(a){var b,c=yne_common_commands_abstractCommands_InsertResource,d=yne_common_commands_commandClassMap,e=yne_common_data_Hr,f=yne_common_commands_atomicCommands_InsertBlocks,g=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertHorizontalRule",_cmdArgs:null,_note:null,_hLineBlkId:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},b.__super__.initialize.apply(a,arguments),g.isCollabCommand(a._cmdArgs)||(a._hLineBlkId=g.newGUID())},insertResource:function(a,b,c){var d,g=this,h=[];return d=new e,d.setId(g._hLineBlkId),b&&h.push(b),h.push(d),c&&h.push(c),g.executeAtomicCommand(new f({note:g._note,newBlks:h,preBlk:a})),d},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._hLineBlkId=c.newBlkId)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.newBlkId=c._hLineBlkId),a}}),d.add(b),b}(),yne_common_commands_compCommands_InsertImage=function(a){var b,c=yne_common_commands_abstractCommands_InsertResource,d=yne_common_commands_commandClassMap,e=yne_common_data_blockTypes,f=yne_common_data_table_ImageResource,g=yne_common_data_Image,h=yne_common_commands_atomicCommands_InsertBlocks,i=yne_common_commands_atomicCommands_table_SetTableCellContent,j=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertImage",_cmdArgs:null,_note:null,_imgBlkId:null,_imgSrc:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},b.__super__.initialize.apply(a,arguments),j.isCollabCommand(a._cmdArgs)||(a._imgBlkId=j.newGUID(),a._imgSrc=a._cmdArgs.src)},insertResource:function(a,b,c){var d,f=this,i=f._cmdArgs.range,j=[];return e.isTable(a)&&i.isSingleTableSelected()?f._insertImageInTable(a):(d=new g({source:f._imgSrc}),b&&j.push(b),j.push(d),c&&j.push(c),d.setId(f._imgBlkId),f.executeAtomicCommand(new h({note:f._note,newBlks:j,preBlk:a})),d)},_insertImageInTable:function(a){var b,c=this,d=c._cmdArgs.range,e=d.getStartBlockRange(),g=e.getAsRectRange();if(g)return b=g.getFirstCellRect(),c.executeAtomicCommand(new i({table:a,cellRect:b,content:new f({source:c._imgSrc})})),a},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._imgBlkId=c.newBlkId,a._imgSrc=c.src)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.newBlkId=c._imgBlkId,a.src=c._imgSrc),a}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetCatalogueHref=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetCatalogueHref",_href:null,_block:null,_oldHref:null,initialize:function(){var a=this,c=a.options,d=c.args;e.isCollabCommand(d)||(a._block=c.block||d.block,a._href=c.href||d.href),b.__super__.initialize.apply(a,arguments)},apply:function(){var a=this,b=a._href,c=a._block;c.setHref&&(a._oldHref=c.getHref(),c.setHref(b))},doUnapply:function(){var a=this;a._block.setHref(a._oldHref)},
getEndingRange:function(){return this.options.args.range},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._block=a.getBlockById(f.blockId),c._href=f.styleNameValues,c._oldHref=f.oldStyleNameValues)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.blockId=c._block.getId(),a.styleNameValues=c._href,a.oldStyleNameValues=c._oldHref),a}}),d.add(b),b}(),yne_common_commands_compCommands_InsertLink=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_RichText,f=yne_common_commands_utils_CompCmdUtils,g=yne_jtk_core_L,h=yne_underscore,i=yne_common_data_blockTypes,j=yne_common_commands_utils_href,k=yne_common_commands_atomicCommands_InsertBlockText,l=yne_common_commands_atomicCommands_SetInlineStyle,m=yne_common_commands_atomicCommands_SetCatalogueHref,n=yne_common_commands_atomicCommands_table_SetTableCellContent,o=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertLink",_cmdArgs:null,_note:null,_linkSrc:null,initialize:function(){var a,c,d,e=this;if(e._note=e.options.note,e._cmdArgs=e.options.args,b.__super__.initialize.apply(e,arguments),!o.isCollabCommand(e._cmdArgs)){if(a=e._cmdArgs.range,c=a.getStartBlockRange(),d=c.block,!e._cmdArgs.src)return void(e.isReadyToApply=!1);if(!i.isTable(d)){if(!a||!a.canDrawedByNative())return g.error(e.name+":note range should NOT be null or cannot be Drawed by native"),void(e.isReadyToApply=!1);if(a.isInMultiBlock()||!i.isTextBlock(d))return e.isReadyToApply=!1,void g.error("Cannot be executed in multi-selected blocks or non-text blocks:",e.name)}e._linkSrc=j.completeUrl(e._cmdArgs.src||""),e._linkStyles=e._cmdArgs.styles||{}}},apply:function(){var a,b,c,d,j,n=this,o=n._cmdArgs.range,p=h.extend(n._linkStyles,{color:"#003884",underline:!0,href:n._linkSrc});return(a=o.getStartBlockRange())?(b=a.block,i.isTable(b)?(n._setTableBlock(p,o),void n.setEndingRange(o)):i.isCatalogue(b)?(0===b.getLength()?(c=new e({text:n._linkSrc}),d=c.getLength(),n.executeAtomicCommand(new k({block:b,start:a.start,text:c})),n.executeAtomicCommand(new m({block:b,href:n._linkSrc})),f.setTextBlockAsEndingRange(n,b,d,d)):(n.executeAtomicCommand(new m({block:b,href:n._linkSrc})),n.setEndingRange(o)),!0):(a.isCollapsed()?(c=new e({text:n._linkSrc}),d=c.getLength(),c.setStyle(0,d,"href",n._linkSrc),h.each(p,function(a,b){c.setStyle(0,d,b,a)}),j=a.start+d,n.executeAtomicCommand(new k({block:b,start:a.start,text:c})),f.setTextBlockAsEndingRange(n,b,j,j)):(p.href=n._linkSrc,n.executeAtomicCommand(new l({blocks:[b],styleNameValues:p,start:a.start,end:a.end})),n.setEndingRange(o)),!0)):(g.error(n.name+":startBlockRange should not be null"),!1)},_setTableBlock:function(a,b){var c=this,d=c._linkSrc,f=b.getStartBlockRange(),g=f.block,h=f.getAsRectRange();h&&h.forEach(function(b,f){var h,i,j,k,l;j=g.getCell(b,f),j.isMergedCell()||(h=j.getContent(b,f),j.isTextNoEmptyCell()&&(i=h.toRichText(),l=i.getLength()),l=l||d.length,k=i||new e({text:d}),k.setStyles(0,l,a),c.executeAtomicCommand(new n({table:g,content:k,cellRect:{row:b,col:f}})))})},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),d&&(a._linkSrc=d.src,a._linkStyles=d.inlineStyles)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c&&(c.src=a._linkSrc,c.inlineStyles=a._linkStyles),c}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetListType=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_common_data_List,g=yne_common_data_blockTypes,h=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetListType",_lists:null,_newTypes:null,_oldTypes:null,initialize:function(){var a=this,c=a.options,d=c.args;b.__super__.initialize.apply(a),h.isCollabCommand(d)||(a._lists=c.lists,a._newTypes={},c.newType?e.each(a._lists,function(b,d){a._newTypes[d]=c.newType}):c.isToggle&&e.each(a._lists,function(b,c){a._newTypes[c]=b.isOrdered()?f.UNORDERED:f.ORDERED}))},apply:function(){var a=this;return a._oldTypes={},e.each(a._newTypes,function(b,c){a._oldTypes[c]=a._lists[c].getType(),b!==a._lists[c].getType()&&a._lists[c].setType(b)}),!0},doUnapply:function(){var a=this;return e.each(a._oldTypes,function(b,c){a._lists[c].getType()!==b&&a._lists[c].setType(b)}),!0},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties.cmdJSON;e&&(a=d.collabProperties.coreEditor.getNote(),e.dataBefore&&(c._oldTypes=e.dataBefore),c._newTypes=e.dataAfter,c._lists=c._getListByIds(a,e.listId)),b.__super__.fromCollabJSON.apply(c)},toCollabJSON:function(){var a=this,c=[],d=b.__super__.toCollabJSON.apply(a);return a._oldTypes&&(d.dataBefore=a._oldTypes),d.dataAfter=a._newTypes,e.each(a._lists,function(a){c.push(a.getId())}),d.listId=c,d},_getListByIds:function(a,b){var c=[];return e.some(a.getAllBlocks(),function(a){return g.isListItem(a)&&a.getOwnerList()&&e.contains(b,a.getOwnerList().getId())&&c.push(a.getOwnerList()),c.length===b.length}),c}}),d.add(b),b}(),yne_common_commands_compCommands_InsertList=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_utils_CompCmdUtils,f=yne_jtk_core_L,g=yne_common_data_blockTypes,h=yne_underscore,i=yne_common_selection_NoteRange,j=yne_common_selection_blockRangeUtil,k=yne_common_data_List,l=yne_common_data_ListItem,m=yne_common_commands_atomicCommands_DeleteBlocks,n=yne_common_commands_atomicCommands_InsertBlocks,o=yne_common_commands_atomicCommands_SetListType,p=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertList",_cmdArgs:null,_note:null,_listType:null,_listId:null,initialize:function(){var a,c,d=this;if(d._note=d.options.note,d._cmdArgs=d.options.args,a=d._cmdArgs.range,b.__super__.initialize.apply(d,arguments),!p.isCollabCommand(d._cmdArgs)){if(!a)return d.isReadyToApply=!1,void f.error(d.name+":note range should NOT be null");if(c=a.getStartBlockRange().block,a.isInSingleBlock()&&!g.isTextBlock(c))return d.isReadyToApply=!1,void f.error("Single Block must be text block:",d.name,a);if(a.isInSingleBlock()&&g.isListItem(c)&&h.some(c.getOwnerList().getItems(),function(a){return a.isLocked()}))return void(d.isReadyToApply=!1);d._listType=d._cmdArgs.type,d._listId=p.newGUID()}},apply:function(){var a=this;return a._cmdArgs.range.isInSingleBlock()?a._handleSingleBlockSelection():a._handleMultiBlockSelection(),!0},_handleMultiBlockSelection:function(){var a,b,c,d,f,o,p,q,r=this,s=r._cmdArgs.range,t=s.getStartBlockRange(),u=t.block,v=r._note.getPreBlock(u),w=s.getEndBlockRange(),x=w.block,y=r._note.getInterBlocks(u,x,!0),z=[],A=!0;for(d=0;d<y.length;++d)if(a=y[d],g.isListItem(a)){if(b=a.getOwnerList(),c&&c.getId()!==b.getId()){A=!1;break}c=b}else if(g.isTextBlock(a)){A=!1;break}A&&c.getType()===r._listType?h.each(y,function(a){"getLevel"in a&&a.getLevel()&&a.setBlockStyle("indent",a.getLevel()-1),g.isTextBlock(a)?z.push(e.createNewParagraph(a,a.getId(),a.getText())):z.push(a)}):(o=g.isListItem(v)&&v.getType===r._listType?v.getOwnerList():new k({type:r._listType,listId:r._listId}),h.each(y,function(a){a.resetLockState(),g.isTextBlock(a)?g.isListItem(a)?(f=new l({id:a.getId(),level:a.getLevel(),list:o,text:a.getText()}),z.push(f)):(f=new l({id:a.getId(),level:1,list:o,text:a.getText()}),f.setBlockStyles(a.getBlockStyles()),p=f.getBlockStyle("indent")||0,q=f.getBlockStyle("text-indent")||0,0!==p&&(f.setLevel(p+f.getLevel()),f.setBlockStyle("indent",0)),0!==q&&(f.setLevel(q+f.getLevel()),f.setBlockStyle("text-indent",0)),z.push(f)):z.push(a)})),h.isEmpty(z)||(r.executeAtomicCommand(new m({note:r._note,blocks:y})),r.executeAtomicCommand(new n({note:r._note,newBlks:z,preBlk:v})),g.isTextBlock(t.block)&&(t=j.createRangeByBlock({block:z[0],start:t.start,end:t.end})),w=z.length>1&&g.isTextBlock(w.block)?j.createRangeByBlock({block:h.last(z),start:w.start,end:w.end}):t,s=i.create({startRange:t,endRange:w})),r.setEndingRange(s)},_handleSingleBlockSelection:function(){var a,b,c,d,f=this,h=f._cmdArgs.range,i=h.getStartBlockRange(),j=i.block;g.isListItem(j)?(c=j.getOwnerList(),c.getType()!==f._listType?(f.executeAtomicCommand(new o({lists:[c],isToggle:!0})),f.setEndingRange(h)):(d=e.replaceBlockWithParagraph(f,f._note,j,j.getText()),e.setTextBlockAsEndingRange(f,d,d.getLength(),d.getLength()))):(a=f._note.getPreBlock(j),b=f._note.getNextBlock(j),a&&g.isListItem(a)&&a.getOwnerList().getType()===f._listType?d=e.replaceBlockWithListItem(f,f._note,a,j,j.getText(),a):b&&g.isListItem(b)&&b.getOwnerList().getType()===f._listType?d=e.replaceBlockWithListItem(f,f._note,b,j,j.getText(),a):(c=new k({type:f._listType,listId:f._listId}),d=new l({id:j.getId(),level:1,list:c,text:j.getText()}),d.setBlockStyles(j.getBlockStyles()),f.executeAtomicCommand(new m({note:f._note,blocks:[j]})),f.executeAtomicCommand(new n({note:f._note,newBlks:[d],preBlk:a}))),e.setTextBlockAsEndingRange(f,d,d.getLength(),d.getLength()))},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),d&&(a._listId=d.listId,a._listType=d.listType)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c&&(c.listId=a._listId,c.listType=a._listType),c}}),d.add(b),b}(),yne_common_commands_compCommands_InsertTable=function(a){var b,c=yne_common_commands_abstractCommands_InsertResource,d=yne_common_commands_commandClassMap,e=yne_common_data_Table,f=yne_common_commands_atomicCommands_InsertBlocks,g=yne_collaboration_collabUtils,h=yne_common_data_table_constantConfig;return b=c.extend({name:"comp.InsertTable",_cmdArgs:null,_note:null,_tableBlkId:null,_columnNums:null,_rowNums:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},b.__super__.initialize.apply(a,arguments),g.isCollabCommand(a._cmdArgs)||(a._tableBlkId=g.newGUID(),a.skipBlockLocking=!0,a._columnNums=1,a._rowNums=1,a._cmdArgs.cols&&(a._columnNums=a._cmdArgs.cols),a._cmdArgs.rows&&(a._rowNums=a._cmdArgs.rows))},insertResource:function(a,b,c){var d,g=this,i=[];return d=e.createBlankTable(g._columnNums,g._rowNums,g._tableBlkId,h.DEFAULT_TABLE_WIDTH),b&&i.push(b),i.push(d),c&&i.push(c),g.executeAtomicCommand(new f({note:g._note,newBlks:i,preBlk:a})),d},_initArray:function(a,b){for(var c=[];a--;)c[a]=b;return c},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._tableBlkId=c.newBlkId,a._columnNums=c.colNums,a._rowNums=c.rowNums)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.newBlkId=c._tableBlkId,a.colNums=c._columnNums,a.rowNums=c._rowNums),a}}),d.add(b),b}(),yne_common_commands_compCommands_InsertTodo=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_selection_blockRangeUtil,f=yne_common_selection_NoteRange,g=yne_common_commands_atomicCommands_InsertBlocks,h=yne_common_commands_atomicCommands_DeleteBlocks,i=yne_collaboration_collabUtils,j=yne_common_commands_utils_CompCmdUtils,k=yne_common_data_blockTypes;return b=c.extend({name:"comp.InsertTodo",_cmdArgs:null,_note:null,_todoBlkId:null,_checked:!1,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},b.__super__.initialize.apply(a,arguments),i.isCollabCommand(a._cmdArgs)||(a._todoBlkId=i.newGUID(),a._checked=a._cmdArgs.checked)},apply:function(){var a,b,c,d,g=this,h=g._cmdArgs.range,i=h.getStartBlockRange(),l=h.getEndBlockRange(),m=i.block,n=l.block;h.isInMultiBlock()?(d=g._note.getInterBlocks(m,n,!0),c=d.every(function(a){return k.isTodo(a)||!k.isTextBlock(a)}),d.forEach(function(e,f){return 0===f?void(a=g._helpSetBlock(e,c)):f===d.length-1?void(b=g._helpSetBlock(e,c)):void g._helpSetBlock(e,c)}),i=e.createRangeByBlock({block:a,start:i.start,end:i.end}),l=e.createRangeByBlock({block:b,start:l.start,end:l.end}),h=f.create({startRange:i,endRange:l}),g.setEndingRange(h)):(b=g._helpSetBlock(n,!0),j.setTextBlockAsEndingRange(g,b,l.start,l.end))},_helpSetBlock:function(a,b){var c,d,e=this,f=e._note,i=a.getId();return k.isTodo(a)?b&&(c=j.replaceBlockWithParagraph(e,e._note,a,a.getText())):k.isTextBlock(a)&&(d=f.getPreBlock(a),c=j.createNewTodo(a,{id:i,text:a.getText(),checked:e._checked}),e.executeAtomicCommand(new h({note:f,blocks:[a]})),e.executeAtomicCommand(new g({note:f,newBlks:[c],preBlk:d}))),c},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._todoBlkId=c.newBlkId,a._checked=c.simpleValue1)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.newBlkId=c._todoBlkId,a.simpleValue1=c._checked),a}}),d.add(b),b}(),yne_common_commands_compCommands_KeyBackspace=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_common_data_blockTypes,g=yne_common_commands_utils_CompCmdUtils,h=yne_common_commands_atomicCommands_DeleteBlocks,i=yne_common_commands_atomicCommands_DeleteBlockText,j=yne_common_commands_atomicCommands_InsertBlockText,k=yne_common_commands_atomicCommands_SetBlockStyle,l=yne_common_commands_atomicCommands_SetListItemLevel,m=yne_common_commands_utils_href,n=yne_common_selection_rangeUtil,o=yne_collaboration_collabUtils;return b=c.extend({name:"comp.KeyBackspace",_cmdArgs:null,_note:null,initialize:function(){var a,c,d,g=this;if(g._note=g.options.note,g._cmdArgs=g.options.args,b.__super__.initialize.apply(g),!o.isCollabCommand(g._cmdArgs)){if(a=g._cmdArgs.range,c=a.getStartBlockRange(),d=c.block,!a)return g.isReadyToApply=!1,void e.error(g.name+":note range should NOT be null");if(a.isInSingleBlock()&&f.isTable(d))return g.isReadyToApply=!1,void e.error("should NOT trigger the cmd when in Table.")}},apply:function(){var a,b,c,d,e,i,k,l=this,m=l._cmdArgs.range,o=[];return a=m.getStartBlockRange(),b=a.block,b,c=m.getEndBlockRange(),d=c.block,e=d,i=l._note.getPreBlock(b),m.isCollapsed()||g.deleteSelectedContent(l,l._note,m),m.isCollapsed()&&f.isTextBlock(b)?0===a.start?l._deleteAtTextBlockStart(i,b):l._deleteAtTextBlockMiddle(b,a.start):m.isInSingleBlock()&&f.isTextBlock(b)?(g.setTextBlockAsEndingRange(l,b,a.start,a.start),!0):(f.isTextBlock(b)||(i&&!f.isTable(i)?(o.push(b),e=i,f.isTextBlock(i)&&(k=i.getLength())):(e=g.replaceBlockWithParagraph(l,l._note,b,""),k=0)),m.isInMultiBlock(d)&&(f.isTextBlock(d)?f.isTextBlock(b)?(l.executeAtomicCommand(new j({block:b,start:b.getLength(),text:d.getText()})),o.push(d),k=a.start,e=b):(k=0,e=d):o.push(d)),o.length>0&&l.executeAtomicCommand(new h({note:l._note,blocks:o})),f.isTextBlock(e)?g.setTextBlockAsEndingRange(l,e,k,k):l.setEndingRange(n.buildNoteRangeFromNonTextBlock(e)),!0)},_deleteAtTextBlockStart:function(a,b){var c,d,e,i=this;return f.isListItem(b)?(b.getIndex()>0&&b.getLevel()>1?i.executeAtomicCommand(new l({listItems:[b],newLevel:b.getLevel()-1})):b=g.replaceBlockWithParagraph(i,i._note,b,b.getText()),g.setTextBlockAsEndingRange(i,b,0,0),!0):f.isTodo(b)?(b=g.replaceBlockWithParagraph(i,i._note,b,b.getText()),g.setTextBlockAsEndingRange(i,b,0,0),!0):(d=b.getBlockStyle("text-indent"))&&d>0?(i.executeAtomicCommand(new k({blocks:[b],styleNameValues:{"text-indent":d-1}})),g.setTextBlockAsEndingRange(i,b,0,0),!0):(c=b.getBlockStyle("indent"))&&c>0?(i.executeAtomicCommand(new k({blocks:[b],styleNameValues:{indent:c-1}})),g.setTextBlockAsEndingRange(i,b,0,0),!0):a?f.isTextBlock(a)?(e=a.getLength(),i.executeAtomicCommand(new j({block:a,start:a.getLength(),text:b.getText()})),i.executeAtomicCommand(new h({note:i._note,blocks:[b]})),g.setTextBlockAsEndingRange(i,a,e,e),!0):(f.isHr(a)?(i.executeAtomicCommand(new h({note:i._note,blocks:[a]})),g.setTextBlockAsEndingRange(i,b,0,0)):i.setEndingRange(n.buildNoteRangeFromNonTextBlock(a)),!0):(g.setTextBlockAsEndingRange(i,b,0,0),!0)},_deleteAtTextBlockMiddle:function(a,b){var c=this;if(m.isAtHrefBorder(a,b,!0))return void c._deleteHrefAtCursorPos(a,b);c.executeAtomicCommand(new i({block:a,start:b-1,end:b})),g.setTextBlockAsEndingRange(c,a,b-1,b-1)},_deleteHrefAtCursorPos:function(a,b){var c,d=this;-1!==(c=m.findHrefBorder(a,b,!0))&&g.deleteHref(d,a,c,b)},isSingleBlockAffected:function(){var a,c=this,d=c._args.range,e=b.__super__.isSingleBlockAffected.apply(c),f=0;return e&&d.isCollapsed()&&(a=d.getStartBlockRange(),f=a.start,c._note.getPreBlock(a.block)&&0===f&&(e=!1)),e}}),d.add(b),b}(),yne_common_commands_compCommands_KeyDelete=function(a){var b,c=yne_common_commands_abstractCommands_DeleteNoteRange,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_common_data_blockTypes,g=yne_collaboration_collabUtils;return b=c.extend({name:"comp.KeyDelete",_cmdArgs:null,_note:null,initialize:function(){var a,c,d,h,i,j=this;if(j._note=j.options.note,j._cmdArgs=j.options.args,b.__super__.initialize.apply(j),!g.isCollabCommand(j._cmdArgs)){if(a=j._cmdArgs.range,c=a.getStartBlockRange(),h=c.block,d=a.getEndBlockRange(),i=d.block,!a)return j.isReadyToApply=!1,void e.error(j.name+":note range should NOT be null");if(a.isInSingleBlock()&&f.isTable(h))return j.isReadyToApply=!1,void e.error("should NOT trigger the cmd when in Table.");if(a.isInSingleBlock()&&f.isTextBlock(h)&&a.isCollapsed()&&c.start===h.getLength()&&!j._note.getNextBlock(h))return j.isReadyToApply=!1,void e.warn("do NOT support the command at the end of note:",j.name);f.isTextBlock(i)&&d.end===i.getLength()&&f.isCatalogue(j._note.getNextBlock(i))&&(j.isReadyToApply=!1,e.warn("do NOT support when next is Catalogue block."))}},isSingleBlockAffected:function(){var a,c,d=this,e=d._args.range,f=b.__super__.isSingleBlockAffected.apply(d),g=0;return f&&e.isCollapsed()&&(c=e.getStartBlockRange(),a=c.block,g=c.start,d._note.getNextBlock(a)&&g===a.getEndOffset()&&(f=!1)),f},isValidStartNoteRange:function(){var a,b,c=this,d=!0;return a=c.getStartingRange(),a&&a.isInSingleBlock()&&(b=a.getStartBlockRange().block,f.isTable(b)&&(d=!1)),d}}),d.add(b),b}(),yne_common_commands_compCommands_KeyEnter=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_underscore,g=yne_common_data_blockTypes,h=yne_common_commands_utils_CompCmdUtils,i=yne_common_commands_atomicCommands_InsertBlocks,j=yne_common_commands_atomicCommands_DeleteBlockText,k=yne_common_commands_atomicCommands_DeleteBlocks,l=yne_common_commands_atomicCommands_SetListItemLevel,m=yne_common_commands_utils_href,n=yne_collaboration_collabUtils;return b=c.extend({name:"comp.KeyEnter",_note:null,_cmdArgs:null,_newBlkId:null,initialize:function(){var a,c,d,f=this;if(f._note=f.options.note,f._cmdArgs=f.options.args,b.__super__.initialize.apply(f),!n.isCollabCommand(f._cmdArgs)){if(a=f._cmdArgs.range,c=a.getStartBlockRange(),d=c.block,!a)return f.isReadyToApply=!1,void e.error(f.name+":note range should NOT be null");if(a.isInSingleBlock()&&g.isTable(d))return f.isReadyToApply=!1,void e.error("should NOT trigger the cmd when in Table.");f._newBlkId=n.newGUID()}},apply:function(){var a,b,c,d,e,i,k,l=this,n=l._cmdArgs.range,o=!1,p=[];return a=n.getStartBlockRange(),b=a.block,i=b,c=n.getEndBlockRange(),d=c.block,k=d,n.isCollapsed()||h.deleteSelectedContent(l,l._note,n),g.isTextBlock(b)&&(i=h.createNewParagraph(b,b.getId(),b.getText()),m.isAtHrefBorder(i,a.start,!0)&&h.deleteHref(l,i,0,b.getLength()),h.recogLink(l,b,0,b.getLength())),n.isInMultiBlock()?(g.isTextBlock(b)||(i=h.replaceBlockWithParagraph(l,l._note,b,"")),g.isTextBlock(d)||(k=h.replaceBlockWithParagraph(l,l._note,d,"")),g.isListItem(i)?k=l._replaceBlockWithListItem(k,i,k.getText()):g.isTextBlock(i)&&g.isListItem(k)&&(k=h.replaceBlockWithParagraph(l,l._note,k,k.getText())),h.setTextBlockAsEndingRange(l,k,0,0),!0):(g.isTextBlock(b)?(e=b.sliceText(a.start,b.getLength()),l.executeAtomicCommand(new j({block:b,start:a.start,end:b.getLength()}))):i=h.replaceBlockWithParagraph(l,l._note,b,""),g.isListItem(b)?b.isEmpty()&&0===e.getLength()?(i=l._reduceListItemLevel(b),k=i):(k=l._insertListItem(b,l._newBlkId,e),o=!0):(k=g.isHeading(b)?e.toString().length>0?l._insertHeading(i,l._newBlkId,e,b.getLevel()):l._insertParagraph(i,l._newBlkId,e,!0):g.isCatalogue(b)?l._insertCatalogueHelp(i,{startBlock:b,paraId:l._newBlkId,text:e}):g.isTodo(b)?b.isEmpty()&&0===e.getLength()?h.replaceBlockWithParagraph(l,l._note,b,""):l._insertTodo(i,{startBlock:b,id:l._newBlkId,text:e,checked:!1}):l._insertParagraph(i,l._newBlkId,e),o=!0),h.setTextBlockAsEndingRange(l,k,0,0),f.each(l._note.getInterBlocks(b,d,!0),function(a){p.push(a.getId())}),o&&p.push(l._newBlkId),l.pushAffectedBlockIds(p),!0)},_insertListItem:function(a,b,c){var d,e=this;return d=h.createNewListItem(a,b,c),h.setBlockStyleByPreBlock(d,a),e.executeAtomicCommand(new i({note:e._note,newBlks:[d],preBlk:a})),d},_insertParagraph:function(a,b,c,d){var e,f=this;if(e=h.createNewParagraph(a,b,c,d))return d||h.setBlockStyleByPreBlock(e,a),f.executeAtomicCommand(new i({note:f._note,newBlks:[e],preBlk:a})),e},_insertHeading:function(a,b,c,d){var e,f=this;return e=h.createNewHeading(a,b,c,d,!0),f.executeAtomicCommand(new i({note:f._note,newBlks:[e],preBlk:a})),e},_insertTodo:function(a,b){var c,d=this;return c=h.createNewTodo(a,b),h.setBlockStyleByPreBlock(c,a),d.executeAtomicCommand(new i({note:d._note,newBlks:[c],preBlk:a})),c},_insertCatalogueHelp:function(a,b){var c=this,d=b.startBlock;return b.text.getLength()<1?b.href="":b.href=d.getHref(),c._insertCatalogue(a,b)},_insertCatalogue:function(a,b){var c,d=this;return c=h.createNewCatalogue(a,b),d.executeAtomicCommand(new i({note:d._note,newBlks:[c],preBlk:a})),c},_reduceListItemLevel:function(a){var b=this,c=a;return a.getLevel()<=1?c=h.replaceBlockWithParagraph(b,b._note,a,""):b.executeAtomicCommand(new l({listItems:[a],newLevel:a.getLevel()-1})),c},_replaceBlockWithListItem:function(a,b,c){var d=this;return d.executeAtomicCommand(new k({note:d._note,blocks:[a]})),d._insertListItem(b,a.getId(),c)},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),d&&(a._newBlkId=d.newBlkId)},isSingleBlockAffected:function(){return!1},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.newBlkId=a._newBlkId,c}}),d.add(b),b}(),yne_common_commands_compCommands_KeyTab=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_common_data_blockTypes,g=yne_common_commands_utils_CompCmdUtils,h=yne_common_commands_atomicCommands_DeleteBlockText,i=yne_common_commands_atomicCommands_SetListItemLevel,j=yne_collaboration_collabUtils;return b=c.extend({name:"comp.KeyTab",_cmdArgs:null,_note:null,_withShiftKey:!1,initialize:function(){var a,c,d,g=this;if(g._note=g.options.note,g._cmdArgs=g.options.args,b.__super__.initialize.apply(g),!j.isCollabCommand(g._cmdArgs)){if(a=g._cmdArgs.range,g._cmdArgs.withShiftKey&&(g._withShiftKey=!0),!a||!a.canDrawedByNative())return e.error(g.name+":note range should NOT be null"),void(g.isReadyToApply=!1);if(c=a.getStartBlockRange(),d=c.block,a.isInSingleBlock()&&!f.isTextBlock(d))return void(g.isReadyToApply=!1)}},apply:function(){var a,b,c,d,e,h,j,k=this,l=k._cmdArgs.range,m=1;if(a=l.getStartBlockRange(),b=a.block,c=l.getEndBlockRange(),d=c.block,k._withShiftKey&&(m=-1),(h=l.isInMultiBlock())||0===a.start&&a.end===b.getLength())return j=!h,e=k._note.getInterBlocks(b,d,!0),g.isInSameList(e)?k._isFirstListItem(e[0])?g.updateBlocksIndentLevel(k,e[0].getOwnerList().getItems(),m):k.executeAtomicCommand(new i({listItems:e,deltaLevel:m})):k._withShiftKey&&j?b.getBlockStyle("text-indent")?k._updateBlockTextIndent(b,m):g.updateBlocksIndentLevel(k,[b],m):j&&0===a.end?k._updateBlockTextIndent(b,m):g.updateBlocksIndentLevel(k,e,m),k.setEndingRange(l),!0;0===a.start?f.isListItem(b)?k._isFirstListItem(b)?(g.updateBlocksIndentLevel(k,b.getOwnerList().getItems(),m),k.setEndingRange(l)):(k.executeAtomicCommand(new i({listItems:[b],deltaLevel:m})),k.setEndingRange(l)):k._withShiftKey?b.getBlockStyle("text-indent")?k._updateBlockTextIndent(b,m):(g.updateBlocksIndentLevel(k,[b],m),k.setEndingRange(l)):k._updateBlockTextIndent(b,m):k._withShiftKey?k._handleShiftTabNotAtStart(a):k._insertTabChar()},_handleShiftTabNotAtStart:function(a){var b,c,d,e,f=this,i=a.block,j=!0;for(b=i.getText().getReadOnlyData(),c=a.start,e=c-1;e>=0;e--)if("\t"!==b[e].char){if(" "!==b[e].char){j=!1;break}c-e==4&&(d=e)}else d||(d=e);j?(d=d||0,f.executeAtomicCommand(new h({block:i,start:d,end:c})),g.setTextBlockAsEndingRange(f,i,d,d)):f._insertTabChar()},_insertTabChar:function(){var a=this,b=a._cmdArgs.inlineStyles,c=a._cmdArgs.range,d=c.getStartBlockRange();g.deleteSelectedContent(a,a._note,c),g.insertTabChar(a,d.block,d.start,b),g.setTextBlockAsEndingRange(a,d.block,d.start+1,d.start+1)},_isFirstListItem:function(a){return 1===a.getLevel()&&1===a.getIndex()},_updateBlockTextIndent:function(a,b){var c=this;g.updateBlockTextIndentLevel(c,a,b),c.setEndingRange(c._cmdArgs.range)},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;d&&d.simpleValue1&&(a._withShiftKey=!0),b.__super__.fromCollabJSON.apply(a)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return a._withShiftKey&&(c.simpleValue1=!0),c}}),d.add(b),b}(),yne_common_commands_compCommands_KeyTextInput=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_RichText,f=yne_common_commands_utils_CompCmdUtils,g=yne_jtk_core_L,h=yne_common_data_blockTypes,i=yne_common_commands_atomicCommands_DeleteBlocks,j=yne_common_commands_atomicCommands_InsertBlockText,k=yne_common_commands_atomicCommands_table_SetTableCellContent,l=yne_collaboration_collabUtils;return b=c.extend({name:"comp.KeyTextInput",_cmdArgs:null,_note:null,_inputtedText:null,_recogLink:!1,initialize:function(){var a,c=this;if(c._note=c.options.note,c._cmdArgs=c.options.args,a=c._cmdArgs.range,b.__super__.initialize.apply(c,arguments),!l.isCollabCommand(c._cmdArgs)){if(!a)return c.isReadyToApply=!1,void g.error(c.name+":note range should NOT be null");c._recogLink=c._cmdArgs.recogLink,c._inputtedText=c._cmdArgs.text}},apply:function(){var a,b,c,d,e,g,k,l,m=this,n=m._cmdArgs.range;return a=n.getStartBlockRange(),b=a.block,c=b,g=a.start,d=n.getEndBlockRange(),e=d.block,n.isInSingleBlock()&&h.isTable(b)?m._insertTextInTable(a,b,m._inputtedText):(n.isCollapsed()||f.deleteSelectedContent(m,m._note,n),h.isTextBlock(b)||(c=f.replaceBlockWithParagraph(m,m._note,b,""),g=0),n.isInMultiBlock()&&(h.isTextBlock(e)&&(l=e.getText()),m.executeAtomicCommand(new i({note:m._note,blocks:[e]}))),k=g+m._inputtedText.getLength(),l&&m._inputtedText.append(l),m.executeAtomicCommand(new j({block:c,start:g,text:m._inputtedText})),m._recogLink&&f.recogLink(m,c,0,g),f.setTextBlockAsEndingRange(m,c,k,k),!0)},_insertTextInTable:function(a,b,c){var d,e,f=this;(d=a.getAsRectRange())&&(e=d.getFirstCell(),f.executeAtomicCommand(new k({table:b,cellRect:{row:e.row,col:e.col},content:c})))},canBeMerged:function(a){var c,d,e,f=this;if(b.__super__.canBeMerged.apply(f,[a])){if(!f.startingRange||!a.getStartingRange())return!1;if(c=f.startingRange.getStartBlockRange(),e=a.getStartingRange().getStartBlockRange(),!a.getStartingRange().isCollapsed())return!1;if(f.isLocalExecutedCmd){if(!f.endingRange)return!1;if(d=f.endingRange.getEndBlockRange(),!h.isTextBlock(d))return!1;if(e.getBlockId()!==d.getBlockId())return!1;if(d.end!==e.start)return!1}else{if(c.getBlockId()!==e.getBlockId())return!1;if(c.start!==e.start)return!1}return" "!==a.getInputtedText().toString()}return!1},fromCollabJSON:function(){var a=this,c=a.options.args,d=c.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),d&&(a._inputtedText=e.fromCollabJSON(d.richText),d.recogLink&&(a._recogLink=!0))},getInputtedText:function(){return this._inputtedText},mergeLocalCmd:function(a){var b,c,d=this,e=a.getInputtedText();d.endingRange&&(b=d.endingRange.getEndBlockRange()),e&&e.getLength()>0&&(d._inputtedText.append(e),d.isLocalExecutedCmd&&(c=b.end+e.getLength(),f.setTextBlockAsEndingRange(d,b.block,c,c)))},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c&&(c.richText=a._inputtedText.toCollabJSON(),a._recogLink&&(c.recogLink=a._recogLink)),c}}),d.add(b),b}(),yne_common_commands_compCommands_RemoveFormat=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_jtk_core_L,f=yne_common_commands_utils_CompCmdUtils;return b=c.extend({name:"comp.RemoveFormat",_note:null,_cmdArgs:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args,b.__super__.initialize.apply(a)},apply:function(){var a=this,b=a._cmdArgs.range;return!b||b.isCollapsed()?(e.error("collapsed时应该修改编辑器当前样式状态，不应进入此命令",b),!1):(f.resetAllStyles(a,a._note,b),a.setEndingRange(b),!0)}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetResourceProps=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_common_data_blockTypes,g=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetResourceProps",_resources:null,_newResProps:null,_oldResProps:null,initialize:function(){var a=this,c=a.options,d=c.args;b.__super__.initialize.apply(a),g.isCollabCommand(d)||(a._resources=c.resources,a._newResProps=c.newResProps)},apply:function(){var a=this;return a._oldResProps={},e.each(a._resources,function(b,c){a._oldResProps[c]={},f.isImage(b)?(a._newResProps[c].source&&(a._oldResProps[c].source=b.getSource(),b.setSource(a._newResProps[c].source)),e.isUndefined(a._newResProps[c].title)||(a._oldResProps[c].title=b.getTitle(),b.setTitle(a._newResProps[c].title))):f.isAttachment(b)&&(a._newResProps[c].source&&(a._oldResProps[c].source=b.getSource(),b.setSource(a._newResProps[c].source)),a._newResProps[c].resource&&(a._oldResProps[c].resource=b.getResource(),b.setResource(a._newResProps[c].resource)),a._newResProps[c].fileName&&(a._oldResProps[c].fileName=b.getFileName(),b.setFileName(a._newResProps[c].fileName)),a._newResProps[c].fileLength&&(a._oldResProps[c].fileLength=b.getFileLength(),b.setFileLength(a._newResProps[c].fileLength)))}),!0},doUnapply:function(){var a=this;return e.each(a._resources,function(b,c){f.isImage(b)?(a._oldResProps[c].source&&b.setSource(a._oldResProps[c].source),e.isUndefined(a._oldResProps[c].title)||b.setTitle(a._oldResProps[c].title)):f.isAttachment(b)&&(a._oldResProps[c].source&&b.setSource(a._oldResProps[c].src),a._oldResProps[c].resource&&b.setResource(a._oldResProps[c].resource),a._oldResProps[c].fileName&&b.setFileName(a._oldResProps[c].fileName),a._oldResProps[c].fileLength&&b.setFileLength(a._oldResProps[c].fileLength))}),!0},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties.cmdJSON;e&&(a=d.collabProperties.coreEditor.getNote(),e.dataBefore&&(c._oldResProps=e.dataBefore),c._newResProps=e.dataAfter,c._resources=c._getResByIds(a,e.resIds)),b.__super__.fromCollabJSON.apply(c)},toCollabJSON:function(){var a=this,c=[],d=b.__super__.toCollabJSON.apply(a);return a._oldResProps&&(d.dataBefore=a._oldResProps),d.dataAfter=a._newResProps,e.each(a._resources,function(a){c.push(a.getId())}),d.resIds=c,d},_getResByIds:function(a,b){var c=[];return e.some(a.getAllBlocks(),function(a){return e.contains(b,a.getId())&&c.push(a),b.length===c.length}),c}}),d.add(b),b}(),yne_common_commands_compCommands_ReplaceResource=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_underscore,f=yne_common_commands_atomicCommands_SetResourceProps,g=yne_collaboration_collabUtils;return b=c.extend({name:"comp.ReplaceResource",_note:null,_cmdArgs:null,_resources:null,_resProps:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args,b.__super__.initialize.apply(a),
g.isCollabCommand(a._cmdArgs)||(a._resources=a._cmdArgs.resources,a._resProps=a._cmdArgs.resProps,a.endingRange=a._cmdArgs.endingRange)},apply:function(){var a=this;return a.executeAtomicCommand(new f({resources:a._resources,newResProps:a._resProps}),a.endingRange),!0},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.coreEditor,d=a._cmdArgs.collabProperties.cmdJSON;d&&(a._resProps=d.simpleValue1,a._resources=[],e.each(d.resIds,function(b){a._resources.push(c.getBlockById(b))}),d.simpleValue2&&(a._cmdArgs.ignoreUndoRedo=!0),d.endNoteRange&&(a.endingRange=d.endNoteRange)),b.__super__.fromCollabJSON.apply(a)},isSingleBlockAffected:function(){return!1},toCollabJSON:function(){var a=this,c=[],d=b.__super__.toCollabJSON.apply(a);return d&&(e.each(a._resources,function(a){c.push(a.getId())}),d.simpleValue1=a._resProps,d.resIds=c,a._cmdArgs.ignoreUndoRedo&&(d.simpleValue2=!0),d.endNoteRange=a.endingRange),d}}),d.add(b),b}(),yne_common_commands_compCommands_RefreshCatalogue=function(a){var b,c=yne_underscore,d=yne_common_commands_CompositeCommand,e=yne_common_commands_commandClassMap,f=yne_common_data_blockTypes,g=yne_common_commands_utils_CompCmdUtils,h=yne_common_data_Catalogue,i=yne_common_data_Catalogues,j=yne_common_data_RichText,k=yne_common_constants,l=yne_common_commands_atomicCommands_DeleteBlocks,m=yne_common_commands_atomicCommands_InsertBlocks,n=yne_collaboration_collabUtils;return b=d.extend({name:"comp.RefreshCatalogue",_cmdArgs:null,_note:null,_ownerId:null,_delete:!1,_catalogueIds:null,_catalogues:null,_newCatalogues:null,_blankParaId:null,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args||{},a._ownerId=a._cmdArgs.ownerId,a._delete=a._cmdArgs.delete,b.__super__.initialize.apply(a,arguments),a._initBlocks()},_initBlocks:function(){var a,b,d=this,e=d._note,j=e.blocks,l=[],m=[],o=[];c.each(j,function(a){f.isCatalogue(a)&&a.getOwnerId()===d._ownerId&&l.push(a),g.isForCatalogueBlock(a)&&m.push(a)}),(l.length>0||!d._ownerId)&&(d._catalogueIds=d._catalogueIds||[],d._ownerId=d._ownerId||n.newGUID(),b=new i({id:d._ownerId}),c.each(m,function(c,e){a=new h({indent:c.getLevel()-1,text:c.getText().toString().trim(),href:c.getId(),ownerList:b}),o.push(a),d._catalogueIds[e]?a.setId(d._catalogueIds[e]):d._catalogueIds[e]=a.getId()}),0===m.length&&(a=new h({indent:0,text:k.INSERT_BLANK_CATALOGUE_TEXT,ownerList:b}),o.push(a),d._catalogueIds[0]?a.setId(d._catalogueIds[0]):d._catalogueIds[0]=a.getId())),d._catalogues=l,d._newCatalogues=o,(0===o.length||d._delete)&&(d._blankParaId=d._blankParaId||n.newGUID())},apply:function(){var a=this,b=a._catalogues,c=a._newCatalogues,d=c[c.length-1];a._blankParaId?(d=g.createNewParagraph(null,a._blankParaId,new j({text:""})),a.executeAtomicCommand(new m({note:a._note,newBlks:[d],preBlk:b[b.length-1]}))):a.executeAtomicCommand(new m({note:a._note,newBlks:c,preBlk:b[b.length-1]||a.startingRange._endRange.block})),b.length>0&&a.executeAtomicCommand(new l({note:a._note,blocks:a._note.getInterBlocks(b[0],b[b.length-1],!0)})),g.setTextBlockAsEndingRange(a,d,d.getLength(),d.getLength())},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties.cmdJSON;b.__super__.fromCollabJSON.apply(a),c&&(a._ownerId=c.listId,a._catalogueIds=c.blockIds,a._delete=c.simpleValue1,a._blankParaId=c.newBlkId)},toCollabJSON:function(){var a,c=this;return a=b.__super__.toCollabJSON.apply(c),a&&(a.listId=c._ownerId,a.blockIds=c._catalogueIds,a.simpleValue1=c._delete,a.newBlkId=c._blankParaId),a}}),e.add(b),b}(),yne_common_commands_compCommands_SetHeaderFooter=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_collaboration_collabUtils;return b=c.extend({_cmdArgs:null,_oldData:null,_content:null,_align:null,_headerFooter:null,name:"comp.SetHeaderFooter",initialize:function(a){var c=this;c._oldData={},c._cmdArgs=a.args,e.isCollabCommand(c._cmdArgs)||(c._content=c._cmdArgs.content,c._align=c._cmdArgs.align,c._headerFooter=c._cmdArgs.headerFooter),c.startingRange=a.args.range,c.endingRange=a.args.endingRange,b.__super__.initialize.apply(c)},apply:function(){var a=this,b=a._align,c=a._content,d=a._headerFooter;d&&(null!=b&&(a._oldData.align=d.getAlign()),null!=c&&(a._oldData.content=d.getContent(!1)),d.setContentAndStyle(c,b),a.effected=!0)},doReapply:function(){var a=this,b=a._align,c=a._content;a._headerFooter.setContentAndStyle(c,b)},doUnapply:function(){var a=this,b=a._headerFooter,c=a._oldData;c&&b.setContentAndStyle(c.content,c.align)},fromCollabJSON:function(){var a=this,c=a._cmdArgs.collabProperties,d=c.cmdJSON,e=c.coreEditor.note;b.__super__.fromCollabJSON.apply(a),d&&(a._content=d.headerFooterInfo.content,a._align=d.headerFooterInfo.align,a._headerFooter=e.getHeaderFooter(d.headerFooterInfo.isFooter))},toCollabJSON:function(){var a,c=this,d=b.__super__.toCollabJSON.apply(c);return d&&(a={},a.content=c._content,a.align=c._align,a.isFooter=c._headerFooter.isFooter,d.headerFooterInfo=a),d}}),d.add(b),b}(),yne_common_commands_atomicCommands_SetBlockProps=function(a){function b(a){return a.charAt(0).toUpperCase()+a.slice(1)}function c(a){return"set"+b(a)}function d(a){return"get"+b(a)}var e,f=yne_common_commands_SimpleCommand,g=yne_common_commands_commandClassMap,h=yne_underscore,i=yne_collaboration_collabUtils;return e=f.extend({name:"atom.SetBlockProps",_blocks:null,_oldPropsMap:{},_props:null,initialize:function(a){var b=this,c=b.options.args;b._oldPropsMap={},i.isCollabCommand(c)||(b._blocks=a.blocks,b._props=a.props),e.__super__.initialize.apply(b,arguments)},apply:function(){var a,b=this;h.each(b._blocks,function(e){a={},h.each(b._props,function(b,f){a[f]=e[d(f)](),e[c(f)](b)}),b._oldPropsMap[e.getId()]=a})},doUnapply:function(){var a,b=this;h.each(b._blocks,function(d){a=b._oldPropsMap[d.getId()],h.each(a,function(a,b){d[c(b)](a)})})},fromCollabJSON:function(){var a=this,b=a.options.args,c=b.collabProperties,d=c.cmdJSON;e.__super__.fromCollabJSON.apply(a),a._note=c.coreEditor.getNote(),d&&(a._blocks=[],h.each(d.blockIds,function(b){a._blocks.push(a._note.getBlockById(b))}),a._props=d.simpleValue1,a._oldPropsMap=d.simpleValue2)},toCollabJSON:function(){var a=this,b=e.__super__.toCollabJSON.apply(a),c=[];return h.each(a._blocks,function(a){c.push(a.getId())}),b.blockIds=c,b.simpleValue1=a._props,b.simpleValue2=a._oldPropsMap,b}}),g.add(e),e}(),yne_common_commands_compCommands_SetBlockProps=function(a){var b,c=yne_underscore,d=yne_common_commands_CompositeCommand,e=yne_common_commands_commandClassMap,f=yne_common_commands_atomicCommands_SetBlockProps,g=yne_common_selection_TodoRange,h=yne_common_selection_NoteRange,i=yne_collaboration_collabUtils;return b=d.extend({name:"comp.SetBlockProps",_cmdArgs:null,_note:null,_blocks:null,_props:null,updateSelectionDisabled:!0,initialize:function(){var a=this;a._note=a.options.note,a._cmdArgs=a.options.args,b.__super__.initialize.apply(a),i.isCollabCommand(a._cmdArgs)||(a._blocks=a._cmdArgs.blocks,a._props=a._cmdArgs.props)},apply:function(){var a=this,b=a._blocks[0],c=new g({block:b,start:b.getEndOffset(),end:b.getEndOffset()});return a.executeAtomicCommand(new f({blocks:this._blocks,props:this._props}),new h({startRange:c,endRange:c})),!0},fromCollabJSON:function(){var a=this,d=a._cmdArgs.collabProperties.cmdJSON;d&&(a._blocks=[],c.each(d.blockIds,function(b){a._blocks.push(a._note.getBlockById(b))}),a._props=d.simpleValue1),b.__super__.fromCollabJSON.apply(a)},toCollabJSON:function(){var a=this,d=b.__super__.toCollabJSON.apply(a),e=[];return c.each(a._blocks,function(a){e.push(a.getId())}),d.blockIds=e,d.simpleValue1=a._props,d}}),e.add(b),b}(),yne_common_commands_atomicCommands_table_SetTableCellSize=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_collaboration_collabUtils;return b=c.extend({name:"atom.SetTableCellSize",_table:null,_size:null,_oldSize:null,effected:!1,initialize:function(){var a=this,c=a.options.args;this._oldSize={},b.__super__.initialize.apply(a),e.isCollabCommand(c)||(a._table=a.options.table,a._size=a.options.size)},apply:function(){var a=this._table,b=this._size;return null!=b.row&&(this._oldSize.row=b.row,this._oldSize.height=a.getRowHeight(b.row),a.setRowHeight(b.row,b.height),this.effected=!0),null!=b.col&&(this._oldSize.col=b.col,this._oldSize.width=a.getColumnWidth(b.col),a.setColumnWidth(b.col,b.width),this.effected=!0),this.effected},doUnapply:function(){var a=this._table,b=this._oldSize;null!=b.row&&a.setRowHeight(b.row,b.height),null!=b.col&&a.setColumnWidth(b.col,b.width)},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._size=f.simpleValue1,c._oldSize=f.simpleValue2)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._size,c.simpleValue2=a._oldSize,c}}),d.add(b),b}(),yne_common_commands_compCommands_table_SetTableCellsSize=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_table_SetTableCellSize,f=yne_collaboration_collabUtils;return b=c.extend({name:"comp.SetTableCellsSize",_table:null,_sizes:null,initialize:function(){var a=this,c=a.options.args;f.isCollabCommand(c)||(a._table=c.table,a._sizes=c.sizes),b.__super__.initialize.apply(a)},apply:function(){var a=this,b=a._table,c=a._sizes;return!(c.length<1)&&(c.forEach(function(c){a.executeAtomicCommand(new e({table:b,size:c}))}),!0)},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._sizes=f.simpleValue1)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._sizes,c}}),d.add(b),b}(),yne_common_commands_atomicCommands_table_InsertTableRowCol=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_table_tableUtil,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.InsertTableRowCol",_table:null,_rect:null,_cellsData:null,_dataLength:null,effected:!1,initialize:function(){var a=this,c=a.options,d=c.args;f.isCollabCommand(d)||(this._cellsData=c.cellsData,this._sizes=c.sizes,this._rect=c.rect,this._table=c.table,this._dataLength=this._cellsData.length),b.__super__.initialize.apply(a)},apply:function(){var a=this,b=a._rect,c=a._table,d=a._cellsData,e=a._sizes;null!=b.row&&(c.insertRows(b.row,d,e),this.effected=!0),null!=b.col&&(c.insertCols(b.col,d,e),this.effected=!0)},doUnapply:function(){var a=this,b=a._rect,c=a._table,d=a._dataLength;null!=b.row&&c.deleteRows(b.row,d),null!=b.col&&c.deleteCols(b.col,d)},fromCollabJSON:function(){var a,c=this,d=c.options.args,f=d.collabProperties,g=f.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=f.coreEditor.getNote(),g&&(c._table=a.getBlockById(g.blockId),c._cellsData=e.cellsFromCollabJSON(g.dataBefore),c._rect=g.simpleValue1,c._dataLength=g.simpleValue2)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.dataBefore=e.cellsToCollabJSON(a._cellsData),c.simpleValue1=a._rect,c.simpleValue2=a._dataLength,c}}),d.add(b),b}(),yne_common_commands_compCommands_table_InsertTableRowCol=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_utils_CompCmdUtils,f=yne_common_util_direction,g=yne_common_data_table_tableUtil,h=yne_common_commands_atomicCommands_table_InsertTableRowCol,i=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertTableRowCol",_table:null,_rect:null,_cellsData:null,effected:!1,initialize:function(){var a,c=this,d=c.options.args;this._rect={},b.__super__.initialize.apply(c),i.isCollabCommand(d)||(this._cellsData=d.cellsData||[[]],this._sizes=d.sizes,a=d.range,a?c._transformRangeToData(a,d):(this._rect=d.rect,this._table=d.table))},_transformRangeToData:function(a,b){var c,d=a.getStartBlockRange(),e=d.getAsRectRange(),g=b.describe;e&&(c=e.getRect(),null!=g.row&&(this._rect.row=g.row===f.UP?c.top:c.top+c.height),null!=g.col&&(this._rect.col=g.col===f.LEFT?c.left:this._rect.col=c.left+c.width),this._table=d.block)},apply:function(){var a=this,b=a._rect,c=a._cellsData,d=a._sizes;null!=b.row&&(a._insertRows(b.row,c,d),this.effected=!0),null!=b.col&&(a._insertCols(b.col,c,d),this.effected=!0)},_insertRows:function(a,b,c){var d=this,f=d._table;b.forEach(function(c,g){0===c.length&&(c=f.creatRowData(a+g)),b[g]=c,e.fixMergeCellBeforeRowColChange({index:a+g,table:f,cmd:d,insertData:c})}),d.executeAtomicCommand(new h({cellsData:b,sizes:c,rect:this._rect,table:f}))},_insertCols:function(a,b,c){var d=this,f=d._table,g=f.getCells();b.forEach(function(c,h){g.forEach(function(a,b){c[b]=c[b]||f.createCell()}),b[h]=c,e.fixMergeCellBeforeRowColChange({index:a+h,table:f,cmd:d,isCol:!0,insertData:c})}),d.executeAtomicCommand(new h({cellsData:b,sizes:c,rect:this._rect,table:f}))},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._rect=f.simpleValue1,c._sizes=f.simpleValue2,c._cellsData=g.cellsFromCollabJSON(f.dataBefore))},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._rect,c.simpleValue2=a._sizes,c.dataBefore=g.cellsToCollabJSON(a._cellsData),c}}),d.add(b),b}(),yne_common_commands_atomicCommands_table_DeleteTableRowCol=function(a){var b,c=yne_common_commands_SimpleCommand,d=yne_common_commands_commandClassMap,e=yne_common_data_table_tableUtil,f=yne_collaboration_collabUtils;return b=c.extend({name:"atom.DeleteTableRowCol",_table:null,_rect:null,_oldCellsData:null,_count:null,effected:!1,initialize:function(){var a=this,c=a.options,d=c.args;f.isCollabCommand(d)||(this._count=c.count,this._rect=c.rect,this._table=c.table),b.__super__.initialize.apply(a)},apply:function(){var a=this,b=a._rect,c=a._table,d=a._count;null!=b.row&&(a._oldCellsData=c.deleteRows(b.row,d),this.effected=!0),null!=b.col&&(a._oldCellsData=c.deleteCols(b.col,d),this.effected=!0)},doUnapply:function(){var a=this,b=a._rect,c=a._table,d=a._oldCellsData;null!=b.row&&c.insertRows(b.row,d.rowsData,d.heights),null!=b.col&&c.insertCols(b.col,d.colsData,d.widths)},fromCollabJSON:function(){var a,c,d=this,f=d.options.args,g=f.collabProperties,h=g.cmdJSON;b.__super__.fromCollabJSON.apply(d),c=g.coreEditor.getNote(),h&&(d._table=c.getBlockById(h.blockId),d._rect=h.simpleValue1,d._count=h.simpleValue2,(a=h.dataBefore)&&(d._oldCellsData=a,a.rowsData&&(d._oldCellsData.rowsData=e.cellsFromCollabJSON(a.rowsData)),a.colsData&&(d._oldCellsData.colsData=e.cellsFromCollabJSON(a.colsData))))},toCollabJSON:function(){var a,c=this,d=b.__super__.toCollabJSON.apply(c);return d.blockId=c._table.getId(),d.simpleValue1=c._rect,d.simpleValue2=c._count,a=c._oldCellsData,a&&(d.dataBefore=a,a.rowsData&&(d.dataBefore.rowsData=e.cellsToCollabJSON(a.rowsData)),a.colsData&&(d.dataBefore.colsData=e.cellsToCollabJSON(a.colsData))),d}}),d.add(b),b}(),yne_common_commands_compCommands_table_DeleteTableRowCol=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_DeleteBlocks,f=yne_common_commands_atomicCommands_table_DeleteTableRowCol,g=yne_common_commands_utils_CompCmdUtils,h=yne_common_selection_NoteRange,i=yne_common_selection_TableRange,j=yne_collaboration_collabUtils;return b=c.extend({name:"comp.DeleteTableRowCol",_table:null,_rect:null,_oldData:null,_count:null,_range:null,effected:!1,initialize:function(){var a,c=this,d=c.options.args;this._rect={},b.__super__.initialize.apply(c),j.isCollabCommand(d)||(a=d.range,a?c._transformRangeToData(a,d):(this._rect=d.rect,this._count=d.count,c._table=d.table))},_transformRangeToData:function(a,b){var c,d,e=this,f=a.getStartBlockRange(),g=b.describe;(c=f.getAsRectRange())&&(d=c.getRect(),g.row&&(this._rect.row=d.top,this._count=d.height),g.col&&(this._rect.col=d.left,this._count=d.width),e._rectOfRectRange=d,this._table=f.block)},apply:function(){var a,b,c,d,e,j,k=this,l=k._count,m=k._rect,n=k._table;if(null!=m.row){if(a=n.getRowCount(),0===m.row&&a===l)return k._deleteTable();for(c=0;c<l;c++)g.fixMergeCellBeforeRowColChange({index:m.row,table:n,cmd:k,isDelete:!0}),k.executeAtomicCommand(new f({count:1,rect:m,table:n}));this.effected=!0}if(null!=m.col){if(b=n.getColumnCount(),0===m.col&&b===l)return k._deleteTable();for(c=0;c<l;c++)g.fixMergeCellBeforeRowColChange({index:m.col,table:n,cmd:k,isDelete:!0,isCol:!0}),k.executeAtomicCommand(new f({count:1,rect:m,table:n}));this.effected=!0}k._rectOfRectRange&&(d=i.create({block:n,type:i.TYPES.NORMAL,rect:k._rectOfRectRange}),d&&(e=d.getAsRectRange()),e||(d=i.create({block:n,type:i.TYPES.FIRST_CELL})),j=h.create({startRange:d,endRange:d}),k.setEndingRange(j))},_deleteTable:function(){this._applyCommandToComposite(new e({blocks:[this._table],note:this.options.note})),this.setEndingRange(h.createMock()),this.effected=!0},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._rect=f.simpleValue1,c._count=f.simpleValue2)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._rect,c.simpleValue2=a._count,c}}),d.add(b),b}(),yne_common_commands_compCommands_table_SetTableCellContent=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_table_SetTableCellContent,f=yne_collaboration_collabUtils,g=yne_common_data_table_tableCellUtil;return b=c.extend({name:"comp.SetTableCellContent",_table:null,_cellRect:null,_oldContent:null,initialize:function(){var a=this,c=a.options.args;f.isCollabCommand(c)||(a._table=c.table,a._cellRect=c.cellRect,a._content=c.content),b.__super__.initialize.apply(a)},apply:function(){var a=this;a.executeAtomicCommand(new e({table:a._table,cellRect:a._cellRect,content:a._content}))},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._content=g.contentFromCollabJSON(f.simpleValue1),c._oldContent=g.contentFromCollabJSON(f.simpleValue2),c._cellRect=f.newBlkId)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=g.contentToCollabJSON(a._content),c.simpleValue2=g.contentToCollabJSON(a._oldContent),c.newBlkId=a._cellRect,c}}),d.add(b),b}(),yne_common_commands_compCommands_table_ToggleMergeTableCell=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_table_SetTableCellAttr,f=yne_common_commands_atomicCommands_table_SetTableCellBlockStyle,g=yne_common_commands_compCommands_table_SetTableCellContent,h=yne_collaboration_collabUtils;return b=c.extend({name:"comp.ToggleMergeTableCell",_table:null,_rect:null,_oldData:null,_range:null,effected:!1,initialize:function(){var a,c=this,d=c.options.args;h.isCollabCommand(d)||(a=d.range,a?c._transformRangeToData(a,d):(this._rect=d.rect,c._table=d.table)),b.__super__.initialize.apply(c)},_transformRangeToData:function(a){var b,c,d=a.getStartBlockRange();(b=d.getAsRectRange())&&(c=b.getRect(),this._range=a,this._rect=c,this._table=d.block)},apply:function(){var a,b,c,d=this,h=d._rect,i=d._table,j=!1,k=!1,l=null;if(h&&(1!==h.width||1!==h.height)){for(i.isMergeRect(h)&&(j=!0),b=h.top;b<h.top+h.height;b++)for(c=h.left;c<h.left+h.width;c++)a=i.getCell(b,c),b===h.top&&c===h.left?(a.isEmpty()||(k=!0),d.executeAtomicCommand(new e({table:i,type:e.TYPES.POINT,value:j?null:{width:h.width,height:h.height},rect:{row:b,col:c}}))):(k||l||a.isEmpty()||(l=a.getContent()),j||(d._applyCommandToComposite(new g({args:{table:i,content:"",range:d._range,cellRect:{row:b,col:c}}})),d.executeAtomicCommand(new f({table:i,styles:null,rect:{width:1,height:1,top:b,left:c}}))),d.executeAtomicCommand(new e({table:i,type:e.TYPES.CELL,value:j?null:{dy:b-h.top,dx:c-h.left},rect:{row:b,col:c}})));l&&d._applyCommandToComposite(new g({args:{table:i,content:l,cellRect:{row:h.top,col:h.left}}})),d.effected=!0}},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._rect=f.simpleValue1)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._rect,c}}),d.add(b),b}(),yne_common_commands_compCommands_table_SetTableCellBlockStyle=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_table_SetTableCellBlockStyle,f=yne_collaboration_collabUtils;return b=c.extend({name:"comp.SetTableCellBlockStyle",_table:null,_styles:null,_rect:null,_toggle:null,effected:!1,initialize:function(){var a,c=this,d=c.options.args;b.__super__.initialize.apply(c),f.isCollabCommand(d)||(a=d.range,c._styles=d.styles,c._toggle=d.toggle,c._transformRangeToData(a,d))},_transformRangeToData:function(a){var b,c,d=a.getStartBlockRange();(b=d.getAsRectRange())&&(c=b.getRect(),this._rect=c,this._table=d.block)},apply:function(){var a=this;if(!a._rect)return a.effected;a.executeAtomicCommand(new e({table:a._table,rect:a._rect,styles:a._styles,toggle:a._toggle})),a.effected=!0},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._rect=f.simpleValue1,c._styles=f.simpleValue2||null,c._toggle=f.newBlkId||null)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._rect,c.simpleValue2=a._styles||null,c.newBlkId=a._toggle||null,c}}),d.add(b),b}(),yne_common_commands_compCommands_table_InsertTableCells=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_table_InsertTableRowCol,f=yne_common_commands_atomicCommands_table_SetTableCellContent,g=yne_common_commands_atomicCommands_table_SetTableCellAttr,h=yne_common_commands_atomicCommands_table_SetTableCellBlockStyle,i=yne_common_data_table_tableUtil,j=yne_collaboration_collabUtils;return b=c.extend({name:"comp.InsertTableCells",_table:null,_widths:null,_heights:null,_cellsData:null,_rect:null,effected:!1,initialize:function(){var a=this,c=a.options.args;b.__super__.initialize.apply(a),j.isCollabCommand(c)||(a._table=c.table,a._widths=c.widths,a._heights=c.heights,a._cellsData=c.cellsData,a._transformRangeToData(c.range))},_transformRangeToData:function(a){var b,c=a.getStartBlockRange();c.getAsRectRange&&(b=c.getAsRectRange(),this._rect=b.getRect())},apply:function(){var a,b,c,d,e,g,i,j=this,k=j._table,l=j._rect,m=j._cellsData;if(!m)return j._clearCellsData();if(!m[0]||m[0].length<1)return!1;for(a=m.length,b=m[0].length,j._handleExtendCol(),j._handleExtendRow(),d=0;d<a;d++)for(g=d+l.top,e=0;e<b;e++)i=e+l.left,c=m[d][e],j._handleOldMergePoint(k.getCell(g,i),g,i),j._handleMergePointCell(c,d,e),c.isMergedCell()||(j.executeAtomicCommand(new f({content:c.getContent(),table:k,cellRect:{row:d+l.top,col:e+l.left}})),j.executeAtomicCommand(new h({rect:{top:l.top+d,left:l.left+e,width:1,height:1},styles:c.getBlockStyles(),table:k})),this.effected=!0)},_handleExtendCol:function(){var a,b,c,d=this,f=d._table,g=d._rect,h=d._widths,i=d._cellsData,j=i[0].length,k=f.getColumnCount(),l=f.getRowCount(),m=[];if((a=g.left+j-k)>0){for(i.forEach(function(b,c){b.slice(-a).forEach(function(a,b){m[b]=m[b]||[],m[b][g.top+c]=a})}),b=0;b<l;b++)for(c=0;c<m.length;c++)m[c][b]=m[c][b]||f.createCell({row:b,col:g.left+c});d.executeAtomicCommand(new e({rect:{col:k},table:f,cellsData:m,sizes:h?h.slice(-a):null})),d.effected=!0}},_handleExtendRow:function(){var a,b,c,d=this,f=d._table,g=d._rect,h=d._heights,i=d._cellsData,j=i.length,k=f.getColumnCount(),l=f.getRowCount(),m=[];if((a=g.top+j-l)>0){for(i.slice(-a).forEach(function(a,b){m[b]=m[b]||[],a.forEach(function(a,c){m[b][g.left+c]=a})}),b=0;b<m.length;b++)for(c=0;c<k;c++)m[b][c]=m[b][c]||f.createCell({row:g.top+g.height,col:c});d.executeAtomicCommand(new e({rect:{row:l},table:f,cellsData:m,sizes:h?h.slice(-a):null})),d.effected=!0}},_handleMergePointCell:function(a,b,c){var d=this,e=d._table,f=d._rect;a.isMergePoint()?(a.getMergePointAttr(),d.executeAtomicCommand(new g({rect:{row:f.top+b,col:f.left+c},value:a.getMergePointAttr(),type:g.TYPES.POINT,table:e}))):a.isMergedCell()&&d.executeAtomicCommand(new g({rect:{row:f.top+b,col:f.left+c},value:a.getMergedCellAttr(),type:g.TYPES.CELL,table:e}))},_handleOldMergePoint:function(a,b,c){var d,e,f=this,g=f._table,h=f._rect,i=f._cellsData,j=i.length,k=i[0].length;if(a&&(a.isMergePoint()&&(d=a.getMergePointAttr(),this._clearCellsAttr(b,c,d.width,d.height)),a.isMergedCell())){if(!(e=g.getCell(b,c,{findMergePointIfNeeded:!0,withPosition:!0}))||h.top+j>=e.row&&h.top<=e.row&&h.left+k>e.col&&h.left<=e.col)return;d=e.cell.getMergePointAttr(),this._clearCellsAttr(e.row,e.col,d.width,d.height)}},_clearCellsAttr:function(a,b,c,d){var e,f,h=this,i=h._table;for(e=0;e<d;e++)for(f=0;f<c;f++)h.executeAtomicCommand(new g({table:i,rect:{row:a+e,col:b+f}}))},_clearCellsData:function(){var a,b,c=this,d=c._rect,e=c._table;for(a=0;a<d.height;a++)for(b=0;b<d.width;b++)c.executeAtomicCommand(new f({content:"",table:e,cellRect:{row:a+d.top,col:b+d.left}}));c.executeAtomicCommand(new h({rect:d,table:e}))},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._rect=f.simpleValue1,c._widths=f.simpleValue2.widths,c._heights=f.simpleValue2.heights,c._cellsData=i.cellsFromCollabJSON(f.dataBefore))},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._rect,c.simpleValue2={widths:a._widths,height:a._heights},c.dataBefore=i.cellsToCollabJSON(a._cellsData),c}}),d.add(b),b}(),yne_common_commands_compCommands_table_SetTableCellInlineStyle=function(a){var b,c=yne_common_commands_CompositeCommand,d=yne_common_commands_commandClassMap,e=yne_common_commands_atomicCommands_table_SetTableCellInlineStyle,f=yne_collaboration_collabUtils;return b=c.extend({name:"comp.SetTableCellInlineStyle",_table:null,_styles:null,_rect:null,_toggle:null,initialize:function(){var a,c=this,d=c.options.args;b.__super__.initialize.apply(c),f.isCollabCommand(d)||(a=d.range,c._styles=d.styles,c._toggle=d.toggle,c._transformRangeToData(a,d))},_transformRangeToData:function(a){var b,c,d=a.getStartBlockRange();(b=d.getAsRectRange())&&(c=b.getRect(),this._rect=c,this._table=d.block)},apply:function(){var a=this;a._rect&&a.executeAtomicCommand(new e({table:a._table,rect:a._rect,styles:a._styles,toggle:a._toggle}))},fromCollabJSON:function(){var a,c=this,d=c.options.args,e=d.collabProperties,f=e.cmdJSON;b.__super__.fromCollabJSON.apply(c),a=e.coreEditor.getNote(),f&&(c._table=a.getBlockById(f.blockId),c._rect=f.simpleValue1,c._styles=f.simpleValue2||null,c._toggle=f.newBlkId||null)},toCollabJSON:function(){var a=this,c=b.__super__.toCollabJSON.apply(a);return c.blockId=a._table.getId(),c.simpleValue1=a._rect,c.simpleValue2=a._styles||null,c.newBlkId=a._toggle||null,c}}),d.add(b),b}(),yne_common_commands_exportCommands=void 0,yne_common_commands_CommandFactory=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L,d=yne_common_commands_commandClassMap,e=yne_common_selection_NoteRange,f=yne_collaboration_collabUtils;return b.extend({_editor:null,initialize:function(a){this._editor=a.editor},create:function(a,b,g){var h,i=null;if(g.collabProperties=g.collabProperties||{},a+="",h=d.get(a)){if(i=new h({note:b,args:g}),!this._editor.isCollabEnabled())return i.isSimple||i.setStartingRange(g.range),i;if(g.collabProperties.dataCmdError)return c.error(g.collabProperties.dataCmdError),null;if(i.isSimple)return i;!f.isCollabCommand(g)&&i.isOriginalCmd&&(e.isNoteRange(g.range)?i.setStartingRange(g.range):(g.collabProperties.dataCmdError="original cmd args.range should be noteRange",i=null))}else c.warn("No class for `"+a+"` command");return i}})}(),yne_common_util_base64Helper=function(a){function b(a,b){var d=[];return c.each(a,function(a){if(e.isImage(a)){var c=a.getSource(),f=b[c];f&&f.base64&&(d.push(a),f.imgBlockIds?f.imgBlockIds.push(a.getId()):f.imgBlockIds=[a.getId()])}}),d}var c=yne_underscore,d=yne_jtk_core_L,e=yne_common_data_blockTypes,f=function(a){var b=document.createElement("CANVAS"),c=b.getContext("2d"),e=null,f="image/jpeg";if(!a)return null;b.height=a.naturalHeight,b.width=a.naturalWidth,c.fillStyle="white",c.fillRect(0,0,b.width,b.height),c.drawImage(a,0,0);try{e=b.toDataURL(f,1)}catch(a){d.error(a.message)}return e};return{getBase64Data:function(a){if(!a)return{};var b,d={data:{}},e=d.data;return c.each(a,function(a){(b=f(a.img))&&(e[a.source]={base64:b})}),d},parseImageJson:function(a){var b=null;if(!a)return null;try{b=JSON.parse(a)}catch(a){return d.error("no imagejson or parse imagejson error"),null}return b},base64ToBlob:function(a){for(var b=a.split(","),c=b[0].match(/:(.*?);/)[1],d=atob(b[1]),e=d.length,f=new Uint8Array(e);e--;)f[e]=d.charCodeAt(e);return new Blob([f],{type:c})},imgToBase64:f,setBlockIds:b}}(),yne_common_key_backspace=function(a){yne_common_key_KeyHandlerManager.register({name:"backspace",key:"backspace",action:function(a){a.execDeleteBackward()}})}(),yne_common_key_del=function(a){yne_common_key_KeyHandlerManager.register({name:"del",key:"del",action:function(a){a.execDeleteForward()}})}(),yne_common_key_down=function(a){var b=yne_common_key_KeyHandlerManager,c=function(a,b,c){var d=a.noteView;d&&(d.directionKeyJustMoved=!0),a._moveCaretWithDirection(!0,b);var e=a.getNoteRange(),f=e.getEndBlockRange(),g=f.block;if(!g.isEmpty())switch(c){case"right":g.getLength()===f.end&&a.note.getLastBlock()===g&&a.execCommand("comp.AppendBlank");break;case"down":a.note.getLastBlock()===g&&a.execCommand("comp.AppendBlank")}};b.register({name:"down",key:"down",preventDefault:!1,action:c}),b.register({name:"right",key:"right",preventDefault:!1,action:c})}(),yne_common_key_enter=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_data_blockTypes,d=function(a){var b,d;b=a.getNoteRange(),d=b.getEndBlockRange(),b.isInSingleBlock()&&c.isHeading(d.block)&&d.isCollapsed()&&d.start===d.block.getLength()&&a.resetEditingInlineStates(),a.execCommand("comp.KeyEnter",{inlineStyles:a.getEditingInlineState()})};b.register({name:"enter",key:"enter",action:d}),b.register({name:"alt+enter",key:"alt+enter",action:d}),b.register({name:"shift+enter",key:"shift+enter",action:d})}(),yne_common_key_esc=function(a){yne_common_key_KeyHandlerManager.register({name:"esc",key:"esc",preventDefault:!1,action:function(a){a.trigger("esc")}})}(),yne_common_key_space=function(a){var b=yne_common_data_blockTypes,c=yne_jtk_core_L;yne_common_key_KeyHandlerManager.register({name:"space",key:"space",action:function(a){var d,e=a.getNoteRange();if(e&&(d=e.getStartBlockRange().block,e.isInSingleBlock()&&d&&b.isTable(d)))return void c.error("should NOT trigger insertText when select only Table.");a.insertText(" ",!1)}})}(),yne_common_key_tab=function(a){yne_common_key_KeyHandlerManager.register({name:"tab",key:"tab",action:function(a){var b=a.getEditingInlineState();a.execCommand("comp.KeyTab",{inlineStyles:b})}})}(),yne_common_key_up=function(a){
var b=yne_common_key_KeyHandlerManager,c=function(a,b){var c=a.noteView;c&&(c.directionKeyJustMoved=!0),a._moveCaretWithDirection(!1,b)};b.register({name:"up",key:"up",preventDefault:!1,action:c}),b.register({name:"left",key:"left",preventDefault:!1,action:c})}(),yne_common_key_shortcut_bold=function(a){yne_common_key_KeyHandlerManager.register({name:"bold",key:"mod+b",action:function(a){a.toggleInlineStyle("bold")}})}(),yne_common_key_shortcut_insertDate=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_underscorestring,d=function(a){return c.pad(a,2,"0","left")};b.register({name:"insertDate",key:"alt+shift+d",action:function(a){var b=new Date,c=b.getFullYear()+"/"+d(b.getMonth()+1)+"/"+d(b.getDate())+" "+d(b.getHours())+":"+d(b.getMinutes());a.insertText(" "+c+" ",!1)}})}(),yne_common_key_shortcut_italic=function(a){yne_common_key_KeyHandlerManager.register({name:"italic",key:"mod+i",action:function(a){a.toggleInlineStyle("italic")}})}(),yne_common_key_shortcut_redo=function(a){var b=yne_common_key_KeyHandlerManager,c=function(a){a.redo()};b.register({name:"redo",key:"mod+y",action:c}),b.register({name:"redo_2",key:"mod+shift+z",action:c})}(),yne_common_key_shortcut_reloadPage=function(a){var b=yne_jtk_core_L;yne_common_key_KeyHandlerManager.register({name:"reloadPage",key:"mod+shift+r",preventDefault:!1,action:function(){if(b.DEBUG){window.clearJstCache&&(window.clearJstCache(),window.alert("Clear JST cache... Done!"));var a=window.location.href;window.location.href=a}}})}(),yne_common_key_shortcut_save=function(a){yne_common_key_KeyHandlerManager.register({name:"save",key:"mod+s",action:function(a){a.trigger("yne-save-content")}})}(),yne_common_key_shortcut_underline=function(a){yne_common_key_KeyHandlerManager.register({name:"underline",key:"mod+u",action:function(a){a.toggleInlineStyle("underline")}})}(),yne_common_key_shortcut_undo=function(a){yne_common_key_KeyHandlerManager.register({name:"undo",key:"mod+z",action:function(a){a.undo()}})}(),yne_common_key_shortcut_selectAll=function(a){yne_common_key_KeyHandlerManager.register({name:"selectAll",key:"mod+a",read:!0,action:function(a){a.selectAll()}})}(),yne_common_key_shortcut_copy_cut=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_data_blockTypes,d=function(a){var b,d,e,f,g=a.getNoteRange(),h=a.noteView;(b=h.getHtmlContentEditable())||g&&g.isInSingleBlock()&&g.isMatchBlockTypes(a.note,[c.IMAGE,c.ATTACHMENT])&&(e=g.getStartBlockRange(),d=e.block,(f=h.getBlockViewByBlock(d))&&(h.setHtmlContentEditable(!0),f.el.focus(),window.setTimeout(function(){h.setHtmlContentEditable(!1)},0)))};b.register({name:"copy",key:"mod+c",preventDefault:!1,read:!0,action:d}),b.register({name:"cut",key:"mod+x",preventDefault:!1,action:d})}(),yne_common_key_shortcut_paste=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_util_platform;b.register({name:"paste",key:"mod+v",preventDefault:!1,action:function(a,b){var d=a.editor;a.setPasteAsText(!1),c.IS_MAC&&(b.preventDefault(),d.callMacNativeApi("menuPaste"))}}),b.register({name:"pasteAsText",key:"mod+shift+v",preventDefault:!1,action:function(a){a.setPasteAsText(!0)}}),b.register({name:"pasteAsText_alternative",key:"mod+shift+option+v",preventDefault:!1,action:function(a){a.setPasteAsText(!0)}})}(),yne_common_key_shortcut_find=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_common_util_platform,d=!0;(c.IS_WEB_NOTE||c.IS_WEB_GROUP)&&(d=!1),b.register({name:"find",key:"mod+f",read:!0,preventDefault:d,action:function(a){a.trigger("find")}})}(),yne_common_key_shortcut_shiftTab=function(a){yne_common_key_KeyHandlerManager.register({name:"shiftTab",key:"shift+tab",action:function(a){var b=a.getEditingInlineState();a.execCommand("comp.KeyTab",{withShiftKey:!0,inlineStyles:b})}})}(),yne_common_key_shortcut_zoomIn=function(a){var b=yne_common_key_KeyHandlerManager;yne_common_util_platform.IS_PC&&(b.register({name:"zoomIn_0",key:"mod+plus",action:function(a){a.zoomInEditor()}}),b.register({name:"zoomIn_1",key:"mod+shift+plus",action:function(a){a.zoomInEditor()}}),b.register({name:"zoomIn_2",key:"mod+=",action:function(a){a.zoomInEditor()}}),b.register({name:"zoomIn_3",key:"mod+shift+=",action:function(a){a.zoomInEditor()}}))}(),yne_common_key_shortcut_zoomOut=function(a){var b=yne_common_key_KeyHandlerManager;yne_common_util_platform.IS_PC&&(b.register({name:"zoomOut_0",key:"mod+-",action:function(a){a.zoomOutEditor()}}),b.register({name:"zoomOut_1",key:"mod+shift+-",action:function(a){a.zoomOutEditor()}}),b.register({name:"zoomOut_2",key:"mod+0",action:function(a){a.zoomEditor(1,!0)}}))}(),yne_common_key_shortcut_modBackspace=function(a){yne_common_key_KeyHandlerManager.register({name:"modeBackspace",key:"mod+backspace",preventDefault:!0,action:function(){}})}(),yne_common_key_shortcut_modDel=function(a){yne_common_key_KeyHandlerManager.register({name:"modeDel",key:"mod+del",preventDefault:!0,action:function(){}})}(),yne_common_key_shortcut_deleteToEnd=function(a){var b=yne_common_util_platform;yne_common_key_KeyHandlerManager.register({name:"deleteToEnd",key:"ctrl+k",action:function(a){b.IS_MAC&&a.execDeleteToEnd()}})}(),yne_common_key_shortcut_deleteForward=function(a){var b=yne_common_util_platform;yne_common_key_KeyHandlerManager.register({name:"deleteForward",key:"ctrl+d",action:function(a){b.IS_MAC&&a.execDeleteForward()}})}(),yne_common_key_shortcut_insertHeading=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_jtk_core_L,d={insertHeading_1:"1",insertHeading_2:"2",insertHeading_3:"3",insertHeading_4:"4"},e=function(a,b,e){if(c.log(b),null==d[e])return void c.warn("Unsupported shortKey:",e);a.execCmdByShortCut("comp.InsertHeading",{level:d[e]})};b.register({name:"insertHeading_1",key:"mod+1",preventDefault:!0,action:e}),b.register({name:"insertHeading_2",key:"mod+2",preventDefault:!0,action:e}),b.register({name:"insertHeading_3",key:"mod+3",preventDefault:!0,action:e}),b.register({name:"insertHeading_4",key:"mod+4",preventDefault:!0,action:e})}(),yne_common_key_shortcut_strike=function(a){yne_common_key_KeyHandlerManager.register({name:"strikeout",key:"mod+e",action:function(a){a.toggleInlineStyle("strike")}})}(),yne_common_key_shortcut_insertList=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_jtk_core_L,d=yne_common_data_List,e=function(a,b,e){var f;if(c.log(b),"insertOrderList"===e)f=d.ORDERED;else{if("insertUnorderList"!==e)return void c.warn("Unsupported shortKey:",e);f=d.UNORDERED}a.execCmdByShortCut("comp.InsertList",{type:f})};b.register({name:"insertUnorderList",key:"mod+l",preventDefault:!0,action:e}),b.register({name:"insertOrderList",key:"mod+shift+l",preventDefault:!0,action:e})}(),yne_common_key_shortcut_insertTodo=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_jtk_core_L,d=function(a,b,d){c.log(b,d),a.execCmdByShortCut("comp.InsertTodo",{checked:!1})};b.register({name:"insertTodo",key:"mod+d",preventDefault:!0,action:d})}(),yne_common_key_shortcut_insertHR=function(a){var b=yne_common_key_KeyHandlerManager,c=yne_jtk_core_L,d=function(a,b,d){c.log(b,d),a.execCmdByShortCut("comp.InsertHorizontalRule")};b.register({name:"insertHR",key:"mod+h",preventDefault:!0,action:d})}(),yne_common_key_keyConfig=void 0,yne_common_core_Controller=function(a){var b,c=yne_jtk_core_Class,d=yne_common_selection_NoteSelection,e=yne_common_commands_CommandManager,f=yne_common_commands_CommandFactory,g=yne_common_selection_NoteRange,h=yne_common_data_RichText,i=yne_parser_Parser,j=yne_common_data_Paragraph,k=yne_common_constants,l=yne_underscore,m=yne_underscorestring,n=yne_backbone,o=yne_common_selection_blockRangeUtil,p=yne_common_data_blockTypes,q=yne_jtk_core_L,r=yne_common_data_supportedInlineStyles,s=yne_common_data_supportedBlockStyles,t=yne_common_data_table_supportedBlockStyles,u=yne_common_key_KeyHandlerManager,v=yne_common_selection_SelectionChangeEvent,w=yne_collaboration_collabUtils,x=yne_common_util_platform,y=yne_common_data_ListItem,z=yne_common_util_events,A=yne_common_util_base64Helper,B=yne_common_util_ClipboardData,C=yne_common_util_DataTransfer,D=yne_common_selection_nativeSelection;return b={note:null,noteSelection:null,keyHandlerManager:null,_isPasteAsText:null,_isReadOnly:!1,editor:null,_dragRange:null,_defaultFont:null,initialize:function(a){var b=this,c=a.noteView;b.cmdManager=new e(a),b.cmdFactory=new f(a),b._removeLocalImg=a.removeLocalImg||!1,b.setOptions(a),b.noteView=c,b.noteSelection=new d({noteView:c}),b._initKeyHandlerManager(a.keyHandlerNames),b.editor=a.editor,b.imgTitleInput=a.imgTitleInput,b._bindEvents()},isCollabEnabled:function(){var a=this.editor;return a&&a.isCollabEnabled&&a.isCollabEnabled()},reset:function(){var a=this;a.cmdManager&&a.cmdManager.reset(),a.noteSelection&&a.noteSelection.reset(),a.resetEditingInlineStates(),a._isReadOnly=!1,a._defaultFont=null},setOptions:function(a){var b,c=this;c.reset(),c._isReadOnly=a.isReadOnly,b=c.note=a.note,z.bubble(["color-picker-show","yne-user-action-collection"],b,c,!0),z.addListeners({"get-block-view":"_onGetBlockView","get-default-set-font":"_onGetDefaultSetFont"},b,c,!0)},_initKeyHandlerManager:function(a){var b,c=this;b=c.keyHandlerManager=new u,b.on("bind-key",function(a){var b=c.noteView;b&&b.bindKey(a)}),b.on("unbind-key",function(a){var b=c.noteView;b&&b.unbindKey(a)}),a=a||b.getAvailableHandlerNames(),l.each(a,function(a){b.bind(a)})},hasKeyHandler:function(a){return this.keyHandlerManager.hasHandler(a)},_bindEvents:function(){var a=this,b=a.cmdManager,c=a.noteView;z.addListeners({"update-selection":"onUpdateSelection","command-exec":"_onCommandExec"},b,a),z.bubble(["redo-stack-change","undo-stack-change"],b,a),z.addListeners({"selection-change":"_onSelectionChange"},a.noteSelection,a),z.bubble({contextmenu:!0,selectstart:!0,"mouse-down":!0,"yne-replace-image":!0,"yne-replace-attachment":!0,"yne-download-image":!0,"yne-preview-image":!0,"yne-download-attachment":!0,"yne-open-image":!0,"yne-open-attachment":!0,"yne-on-paste":!0,"yne-blob-paste":!0,"open-link":"yne-open-link","cell-edit-view-exit":!0,"cell-edit-view-history-change":!0,"yne-image-ocr":!0},c,a),z.bubble(["link-menu-hide","locked-change"],c,a.editor.linkView),z.addListeners({"delete-selection":"_onDeleteSelection","text-input":"_onTextInput","key-pressed":"_onKey",command:"onCommand",copy:"_onCopy",cut:"_onCut",paste:"onPaste",dragstart:"_onDragStart",dragover:"_onDragOver",drop:"_onDrop",dragend:"_onDragEnd","note-append-blankparagraph":"_onAppendBlankParagraph",onCompositionStart:"_onCompositionStart","inner-goto":"innerGoto","header-footer-view-text-change":"_onHeaderFooterViewTextChange","backup-drag-range":"_onBackupDragRange","get-note-range":"_onGetNoteRange","move-caret":"_moveCaretWithDirection","global-redo":"redo","global-undo":"undo","cell-edit-view-enter":"_onEnterTableEdit","cell-edit-view-selection-change":"_onCellEditViewSelectionChange","cell-edit-view-command-executed":"_onCellEditViewSelectionChange","save-content":"_onSaveContent"},c,a),c.on("get-editing-styles",function(b){b(a._editingInlineStates)}),a.editor&&a.editor.onDocSelectionChange&&a.noteSelection.on("doc-change-selection",a.editor.onDocSelectionChange,a.editor),c.on("yne-click",function(){a.editor.recoverFromIdleTimeout(a.editor.getNoteRange()),a.trigger("yne-click")}),c.on("link-menu-show",function(b){a.editor.linkView.trigger("link-menu-show",b)}),c.on("get-image-items",a._getImgItems),a.imgTitleInput&&z.bubble(["img-title-edit-start","img-title-edit-end","img-title-edit-focus","img-title-edit-exit","img-title-edit-update","locked-change"],c,a.imgTitleInput)},execCommand:function(a,b){q.log("execCommand",a,b);var c,d,e=this;return b=b||{},b.collabProperties||(b.collabProperties=e.editor.buildCollabProperties()),d=b.collabProperties.isCollabCmd,e.isReadOnly()&&!d?void e.editor.notifyErrorToHost(k.INVALIDACTION_EDIT_READ_ONLY,e.editor):(b.isOriginalCmd=!0,!(c=e._createCmd(a,b))||c.cmdError?void q.error("Failed to create/initialize command:"+a):w.isInlineStateSetCommand(c)?void l.each(b.inlineStyles,function(a,b){e.setEditingInlineState(b,a)}):e.isCollabEnabled()?(c.isOriginalCmd=!0,d?e._executeCollabCmd(c,b):e._handleLocalCmdInCollabMode(c,b),b.collabProperties.dataCmdError&&q.error(b.collabProperties.dataCmdError),c):e._executeLocalCmd(c,b))},execCmdByShortCut:function(a,b){this.editor.execCommandByToolbar(a,b)},_createCmd:function(a,b){var c=this,d=c.cmdFactory;return b.range||w.isCollabCommand(b)||(b.range=c.getNoteRange()||g.createMock()),d.create(a,c.note,b)},undo:function(){var a=this,b=a.cmdManager,c={};return a.isCollabEnabled()?(c.collabProperties={},c.collabProperties.isCollabUndo=!0,this._redoUndoLocalCmdInCollabMode(c)):b.undo()},redo:function(){var a=this,b=a.cmdManager,c={};return a.isCollabEnabled()?(c.collabProperties={},c.collabProperties.isCollabRedo=!0,this._redoUndoLocalCmdInCollabMode(c)):b.redo()},canUndo:function(){return this.cmdManager.canUndo()},canRedo:function(){return this.cmdManager.canRedo()},_onSelectionChange:function(a){var b=this;b.lastDeleteInlineStates?(b.setEditingInlineStates(b.lastDeleteInlineStates),b.lastDeleteInlineStates=null):b._shouldKeepEditingStates(a)||b._updateEditingStates(),b._notifyEditingStatesChange(),b.trigger("yne-selection-change")},_onCellEditViewSelectionChange:function(){var a,b,c=this,d=c.getNoteRange(),e=d.getStartBlockRange(),f=e.block,g=c.noteView.getBlockViewByBlock(f);g&&(a=g.getCellEditView(),b=a.queryInlineStylesForBulb(),c.trigger("yne-editing-state-change",b))},_shouldKeepEditingStates:function(a){var b,c,d,e={do:["key.Space","key.Enter","comp.ApplyStyles","comp.IndentOutdent","comp.InsertAttachment","comp.InsertHorizontalRule","comp.InsertImage","comp.InsertList","comp.InsertTable","comp.KeyTab","comp.KeyTextInput"],undo:["comp.ApplyStyles","comp.IndentOutdent","comp.InsertList"],redo:["comp.ApplyStyles","comp.IndentOutdent","comp.InsertList"]};return!!(a&&a.isCommandType&&a.isCommandType())&&(b=a.getData()||{},c=b.cmdType,d=b.cmdName,l.contains(e[c],d))},_onDeleteSelection:function(){var a=this,b=a.getNoteRange();b&&!b.isCollapsed()&&a.execDeleteBackward(b)},onUpdateSelection:function(a,b){this.noteSelection.setRange(a,v.createCommandTypeEvent(b))},_onCommandExec:function(a,b){this.trigger("command-exec",a,b)},getNoteRange:function(){var a=this,b=a.noteSelection.getRange();return b||(b=a.defaultNoteRange()),b},_onKey:function(a,b){var c=this,d=c.noteView,e=c.keyHandlerManager;d&&(d.directionKeyJustMoved=!1),e.execWithKey(a,c,b)},execKeyHandler:function(a){var b=this;b.keyHandlerManager.execWithName(a,b,{})},execDeleteBackward:function(a){var b,c,d=this;if(a=a||d.getNoteRange(),b=a.getStartBlockRange(),c=b.block,!a)return void q.error("noteRange not found");p.isHeading(c)&&a.isCollapsed()&&b.isCollapsed()&&0===b.start?d.resetEditingInlineStates():d._updateDeleteInlineStates(d.queryBackwardFirstInlineStyles(a)),d.execCommand("comp.KeyBackspace")},execDeleteForward:function(){var a=this,b=a.getNoteRange();if(!b)return void q.error("noteRange not found");a._updateDeleteInlineStates(a.queryForwardFirstInlineStyles(b)),a.execCommand("comp.KeyDelete")},execInsertDate:function(){var a,b=this,c=new Date,d=function(a){return m.pad(a,2,"0","left")};a=" "+c.getFullYear()+"/"+d(c.getMonth()+1)+"/"+d(c.getDate())+" "+d(c.getHours())+":"+d(c.getMinutes())+" ",b.insertText(a,!1)},execBackTab:function(){var a=this;a.execCommand("comp.KeyTab",{withShiftKey:!0,inlineStyles:a._editingInlineStates})},_updateDeleteInlineStates:function(a){a&&a.href&&(a=null),this.lastDeleteInlineStates=a},_enterKeyDown:function(){this.execCommand("comp.KeyEnter",{inlineStyles:this._editingInlineStates})},_tabKeyDown:function(){var a=this;a.execCommand("comp.KeyTab",{inlineStyles:a._editingInlineStates})},_spaceKeyDown:function(){this.insertText(" ",!0)},_onTextInput:function(a){this.insertText(a,!1)},insertText:function(a,b){var c,d,e=this;q.log("===> insertText...",a),a instanceof h?c=a:(d=e._editingInlineStates,c=new h({text:a}),c.setStyles(0,c.getLength(),d)),e.execCommand("comp.KeyTextInput",{text:c,recogLink:b})},_onAppendBlankParagraph:function(){this.execCommand("comp.AppendBlank")},_moveCaretWithDirection:function(a,b){var c,d,e,f,h,i,j,k=this;return(c=k.getNoteRange())?c.canDrawedByNative()?void q.log("The noteRange can be drawed by native selection!"):(e=c.getStartBlockRange(),d=e.block,void((p.isImage(d)||p.isAttachment(d)||p.isTable(d)||p.isHr(d)||p.isUnknown(d)||p.isHandWrite(d))&&(a?(f=k._getNextCaretBlock(d),h=!0):(f=k._getPreCaretBlock(d),h=!1),f?(i=o.createRangeByBlock({block:f,allContent:!1,collapseToStart:h}),j=new g({startRange:i,endRange:i}),k.noteSelection.setRange(j),b&&b.preventDefault()):a&&k.noteView.focusLastBlankLine()))):void q.log("The noteRange is null!")},_getNextCaretBlock:function(a){for(var b=this.note.getNextBlock(a);b&&(!this._isCaretBlock(b)||b.isLocked());)b=this.note.getNextBlock(b);return b},_getPreCaretBlock:function(a){for(var b=this.note.getPreBlock(a);b&&(!this._isCaretBlock(b)||b.isLocked());)b=this.note.getPreBlock(b);return b},getNextCaretBlockRange:function(){var a,b,c,d=this,e=d.getNoteRange(),f=e.getStartBlockRange(),h=f.block;return p.isTextOrTableBlock(h)||(a=d._getNextCaretBlock(h))&&(b=o.createRangeByBlock({block:a,allContent:!1,collapseToStart:!0}),c=new g({startRange:b,endRange:b}),d.noteSelection.setRange(c)),c},_isCaretBlock:function(a){return p.isTextBlock(a)||p.isImage(a)||p.isAttachment(a)||p.isTable(a)},setDefaultFont:function(a,b){this._defaultFont=this._defaultFont||{},a&&(this._defaultFont["font-family"]=a,this.setEditingInlineState("font-family",a)),b&&(this._defaultFont["font-size"]=b,this.setEditingInlineState("font-size",b))},getDefaultFont:function(){return this._defaultFont},_onGetDefaultSetFont:function(a){a(this.getDefaultFont())},toggleInlineStyle:function(a){var b,c=this,d=c.getNoteRange(),e={};if(!d)return void q.warn("noteRange not found");d.isCollapsed()?b=!c._editingInlineStates[a]:(b=c.querySelectionInlineStyle(a),b=!0!==b),e[a]=b,c.execCommand("comp.ApplyStyles",{inlineStyles:e})},setEditingInlineStates:function(a){var b=this;b._editingInlineStates=a,b.isLinkStylesChanged=!1},toggleEditingInlineState:function(a){var b=this,c=!(b._editingInlineStates||{})[a];b.setEditingInlineState(a,c)},setEditingInlineState:function(a,b){var c=this,d={};c.isReadOnly()||(c._editingInlineStates||(c._editingInlineStates={}),c._editingInlineStates[a]=b,d[a]=b,c.trigger("yne-editing-state-change",d),c.isLinkStylesChanged=c._isLinkStyles(a))},resetEditingInlineStates:function(){var a=this,b=r.getAllDefault();a.setEditingInlineStates(null),a.trigger("yne-editing-state-change",b)},getEditingInlineState:function(a){var b=this,c=b._editingInlineStates||{};return a?c[a]:c},_isLinkStyles:function(a){return l.contains(["color","underline"],a)},_updateEditingStates:function(){var a,b=this,c=b.getNoteRange();a=b.queryBackwardFirstInlineStyles(c),b.setEditingInlineStates(a)},_notifyEditingStatesChange:function(){var a,b,c,d=this,e=d.getNoteRange(),f=d._editingInlineStates||{},g=!1;!d.isReadOnly()&&e&&(a=e.getStartBlockRange(),e.isInSingleBlock()&&p.isTextBlock(a.block)&&a.block.getLength()<a.start&&(g=!0),(g||f&&e.isCollapsed())&&(!e.isSingleTableSelected()||a.getAsRectRange())||(f=d.querySelectionInlineStyles(e)||{}),c=l.clone(f),b=e.clone(!0),b.collapse(!0),l.each(["font-family","font-size"],function(a){var c;f[a]===k.INTERM&&(c=d.querySelectionInlineStyle(a,b),f[a]=c)}),f.heading=null,d.trigger("yne-editing-state-change",f,c))},queryBackwardFirstInlineStyles:function(a){var b,c,d,e,f;return(a=a||this.getNoteRange())?(b=a.getStartBlockRange(),c=b.block,p.isTextBlock(c)?c.isEmptyContent()?c.getInlineStylesForEmpty()||r.getAllDefault():(e=b.start,f=c.getLength(),(a.isCollapsed()||e>=f)&&(e=e>0?e-1:0),d=c.getTextStylesAtIndex(e),this._omitLinkStylesIfNeeded(d,a)):void 0):void q.warn("noteRange is null")},queryForwardFirstInlineStyles:function(a){var b,c,d,e,f;return(a=a||this.getNoteRange())?(b=a.getEndBlockRange(),c=b.block,p.isTextBlock(c)?c.isEmptyContent()?c.getInlineStylesForEmpty()||r.getAllDefault():(e=b.end,f=c.getLength(),(!a.isCollapsed()||e>=f)&&(e=e>0?e-1:0),d=c.getTextStylesAtIndex(e),this._omitLinkStylesIfNeeded(d,a)):void 0):void q.error("noteRange is null")},_omitLinkStylesIfNeeded:function(a,b){return a&&a.href&&this._isPartlyOverlapWithAnchor(b)&&(a.href=void 0,this.isLinkStylesChanged||(a.color="#393939",a.underline=!1)),a},_isPartlyOverlapWithAnchor:function(a){var b,c,d,e,f,g,h;return!(!a||!a.isInSingleBlock())&&(b=a.getStartBlockRange(),(c=b.block)instanceof j&&(d=b.start,e=b.end,d===e?(d>0&&(g=c.getTextStyle("href",d-1,d)[0]),d<c.getLength()&&(h=c.getTextStyle("href",d,d+1)[0]),(g||h)&&g!==h):(f=c.getCommonInlineStyle("href",{start:d,end:e}))&&f===k.INTERM))},querySelectionInlineStyle:function(a,b){var c=this,d=c.note;return b=b||c.getNoteRange(),b?d.getCommonInlineStyle(b,a):void q.warn("noteRange not found")},querySelectionBlockStyle:function(a,b){var c=this,d=c.note;return b=b||c.getNoteRange(),b?d.getRangeBlockStyle(b,a):void q.warn("noteRange not found")},querySelectionInlineStyles:function(a){var b,c,d,e,f=this,g={},h=r.getStyleNames();return(a=a||f.getNoteRange())?(b=a.getStartBlockRange(),a.isSingleTableSelected()&&b.isOnCellEdit()&&(c=b.block,d=f.noteView.getBlockViewByBlock(c))?(e=d.getCellEditView(),g=e.queryInlineStylesForBulb()):(l.each(h,function(b){g[b]=f.querySelectionInlineStyle(b,a)}),g)):void q.warn("noteRange not found")},querySelectionBlockStyles:function(a){var b,c,d=this,e={};return(a=a||d.getNoteRange())?(b=s.getAllStyleNames(),c=t.getAllStyleNames(),b=b.concat(c),l.each(b,function(b){e[b]=d.querySelectionBlockStyle(b,a)}),e):void q.warn("noteRange not found")},isSameList:function(a){var b=this,c=b.note,d=b.getNoteRange();return!!d&&c.isSameList(d,a)},onCommand:function(a,b){this.execCommand(a,b)},_onCut:function(a){var b=this,c=b.getNoteRange();a.preventDefault(),q.log("on cut!"),b._setClipboardByRange(c,a),!c||c.isCollapsed()||c.isSingleTableSelected()||b.execCommand("comp.DeleteNoteRange",{range:c})},_onCopy:function(a){var b=this,c=b.getNoteRange();q.DEBUG&&(q.profile("on-copy"),q.time("on-copy")),a.preventDefault(),q.log("on copy!"),b._setClipboardByRange(c,a),q.DEBUG&&(q.timeEnd("on-copy"),q.profileEnd("on-copy"))},_getRangeData:function(a){var b=this,c=b.note,d={"text/yne-json":a.getDataAsJSON(c),"text/html":'<meta charset="utf-8">'+a.getDataAsHtml(c),"text/plain":a.getDataAsPlain(c),"text/yne-note-id":c.getNoteId()},e=b._getImgDomInRange(a);return d["text/yne-image-json"]=b._getImageDataAsJson(e),b._addYneTableData(c,a,d),d},_getImgDomInRange:function(a){var b,c,d,e,f=this,g=f.note,h=f.noteView,i=a._startRange,j=a._endRange,k=g.getBlockIndex(i.block),m=g.getBlockIndex(j.block),n={};for(b=k;b<=m;b++)c=null,d=g.getBlockAt(b),p.isImage(d)&&(e=h.blockViews[b].getImgElement(),n[d.getId()]={img:e,source:d.getSource()}),p.isTable(d)&&(b===k&&(c=i),b===m&&(c=j),l.extend(n,h.blockViews[b].getImageDomMapByTableRange({tableRange:c,selectAll:!c})));return n},_getImageDataAsJson:function(a){var b=A.getBase64Data(a);return JSON.stringify(b)},_addYneTableData:function(a,b,c){if(b.isSingleTableSelected()){var d=b.getStartBlockRange(),e=d.getDataAsJSON(!0);e&&(c["text/yne-table-json"]=window.JSON.stringify(e))}},_getUploadData:function(a,b,c){var d,e=0,f=[],g={},h={};if(!(l.isEmpty(a)||l.isEmpty(b)&&l.isEmpty(c)))return d=A.setBlockIds(c,a),l.each(a,function(a,b){a.base64&&(f.push({id:e,url:b,blob:A.base64ToBlob(a.base64),isGroup:x.isFromWebGroup(b)}),g[e]=a.imgBlockIds,e++)}),l.each(b,function(a){var b=a.getSource(),c=a.getResource(),d=b+"_"+c,i=a.getId();l.isUndefined(h[d])?(h[d]=e,g[e]=[i],f.push({id:e,source:b,resource:a.getResource(),isGroup:x.isFromWebGroup(b)}),e++):g[h[d]].push(i)}),{data:f,map:g,replaceImgList:d}},_uploadImageData:function(a,b,c){if(!(l.isEmpty(a)||l.isEmpty(b)&&l.isEmpty(a.data))){var d,e,f=this,g=[],h={},i=a.data,j=f.note,k=f.editor;if(d=f._getUploadData(i,b,c))return g=d.data,h=d.map,e=d.replaceImgList,k.trigger("yne-upload-image",{data:g,isImg:!0},function(a){setTimeout(function(){var b=[],c=[];l.each(a,function(a,d){l.each(h[d],function(d){var e=j.getBlockById(d);e&&(b.push(e),p.isImage(e)?c.push(l.defaults(a,{source:e.getSource()||"uploadfail"})):p.isAttachment(e)&&c.push(l.defaults(a,{source:e.getSource(),resource:e.getResource()})))})}),b.length>0&&(f.execCommand("comp.ReplaceResource",{resources:b,resProps:c,ignoreUndoRedo:!0}),l.each(b,function(a){a.trigger("content-change")}))})},function(){l.each(l.union(b,e),function(a){a.setFakeLoading(!0)})}),e}},_setClipboardByRange:function(a,b){var c,d,e,f=this;if(!a||a.isCollapsed())return void q.log("no note range or note range is collapsed!");c=f._getRangeData(a,!0),e=new B({event:b}),e.setDataMap(c),d=a.isInSingleBlock()&&p.isAttachment((a.getStartBlockRange()||{}).block),f.trigger("yne-clipboard-set",d)},setPasteAsText:function(a){this._isPasteAsText=a},_pasteBlobImg:function(a){var b,c,d=this;(b=a.originalEvent.clipboardData.items)&&1===b.length&&0===b[0].type.indexOf("image")&&(c=b[0].getAsFile(),d.trigger("yne-blob-paste",{isImg:!0,data:c},function(a){a&&a.source&&d.insertImage(a.source)}))},pasteForTable:function(a){var b,c=this.getNoteRange(),d=c.getStartBlockRange(),e=c.getEndBlockRange(),f=d.block,g=e.block,h=this.noteView;return!(!p.isTable(f)||f.getId()!==g.getId())&&(!(!(b=h.getBlockViewByBlock(f))||!b.pasteBlockList)&&b.pasteBlockList(a))},onPaste:function(a){var b,c,d,e,f,g,h,i=this;if(a.preventDefault(),x.IS_MAC)return void i._pasteForMac();if(b=new B({event:a}),i._isPasteAsText)return h=b.getData("text/plain"),void i._pastePlain(h,i._isPasteAsText);if(c=b.getData("text/yne-json"),d=b.getData("text/yne-image-json"),f=b.getData("text/yne-note-id"),!(c&&i._pasteJSON(c,d,f)||(e=b.getData("text/yne-table-json"))&&i._pasteYTableJson(e))){if((g=b.getData("text/html"))&&i._pasteHTML(g))return void q.log("paste html ok");if(h=b.getData("text/plain"))return void i._pastePlain(h,i._isPasteAsText);i._pasteBlobImg(a)}},_pasteForMac:function(){var a,b,c,d,e,f,g,h=this,i=h.editor,j=window.ynote;if(j&&j.macClipboardData||q.error("YNote does not exist!"),h._isPasteAsText)return a=i.callMacNativeApi("macClipboardData",["text/plain"]),void h._pastePlain(a,h._isPasteAsText);if(!((b=i.callMacNativeApi("macClipboardData",["text/yne-table-json"]))&&h._pasteYTableJson(b)||(c=i.callMacNativeApi("macClipboardData",["text/yne-json"]),d=i.callMacNativeApi("macClipboardData",["text/yne-image-json"]),e=i.callMacNativeApi("macClipboardData",["text/yne-note-id"]),c&&h._pasteJSON(c,d,e)))){if((f=i.callMacNativeApi("macClipboardData",["text/html"]))&&h._pasteHTML(f))return void q.log("mac paste html ok");if(!(g=i.callMacNativeApi("macClipboardData",["image"])))return a=i.callMacNativeApi("macClipboardData",["text/plain"]),a?void h._pastePlain(a,h._isPasteAsText):void 0;g=JSON.parse(g);for(var k=0;k<g.length;k++)h.insertImage(g[k])}},_pasteJSON:function(a,b,c){q.log("Paste JSON\n",a);var d,e,f=this,g={},h=A.parseImageJson(b),j=i.parseJSON(a),k=[],m=[],n={},o={};return l.each(j,function(a){p.isHeading(a)&&(n[a.getId()]=a)}),l.each(j,function(a){var b,c;p.isCatalogue(a)?(b=n[a.getHref()])&&(a.setIndent(b.getLevel()-1),c=w.newGUID(),o[c]=!0,b.setId(c),a.setHref(c)):p.isHeading(a)||(a.setId(w.newGUID()),p.isListItem(a)?(d=a.getListId(),g[d]||(g[d]=y.getOrCreateListById(f.note.getAllBlocks(),d,a.getListType())),a.setOwnerList(g[d])):p.isAttachment(a)?k.push(a):p.isImage(a)&&m.push(a))}),l.each(n,function(a){o[a.getId()]||a.setId(w.newGUID())}),f.note.isSameNote(c)||(e=f._uploadImageData(h||{},k,m)),f._pasteBlockList(j,e)},_pasteHTML:function(a){q.log("Paste HTML\n",a);var b=this,c={},d={},e=i.parseHtml(a);return l.each(e,function(a){p.isHeading(a)&&(c[a.getId()]=a)}),l.each(e,function(a){var b,e;p.isCatalogue(a)&&(b=c[a.getHref()])&&(a.setIndent(b.getLevel()-1),e=w.newGUID(),d[e]=!0,b.setId(e),a.setHref(e))}),l.each(c,function(a){d[a.getId()]||a.setId(w.newGUID())}),b._pasteBlockList(e)},_pastePlain:function(a,b){var c,d,e,f=this,g=f.getNoteRange();return b&&(d=f.querySelectionInlineStyles(g),e=f.querySelectionBlockStyles(g)),c=i.parsePlain(a,d,e,b),f._pasteBlockList(c)},_pasteYTableJson:function(a){var b=this;if(l.isString(a))try{a=window.JSON.parse(a)}catch(a){return void q.error("parse ytable json  string error")}return b._pasteJSON([{blockType:p.TABLE,data:a}])},_pasteBlockList:function(a,b){var c,d=this;if(a&&a.length&&(!0===d._removeLocalImg&&(a=l.filter(a,function(a){var c=/^http:\/\/|https:\/\/|\/\//i;return p.isImage(a)&&-1===l.indexOf(b||[],a)?c.test(a.getSource()):!p.isAttachment(a)||c.test(a.getResource())})),a&&a.length))return c=d._editingInlineStates,d._editingInlineStates=null,d.execCommand("comp.InsertBlocks",{blocks:a}),d._editingInlineStates=c,!0},_onBackupDragRange:function(){var a=this.getNoteRange();a&&!a.isCollapsed()&&(this._dragTextRange=a)},_onDragStart:function(a,b){var c,d,e,f=this;if(c=p.isTextBlock(b)?f._dragTextRange:f.getNoteRange(),f.startNoteRange=c,!c||c.isCollapsed())return void q.log("no note range or note range is collapsed!");e=new C({event:a}),d={"text/yne-json":c.getDataAsJSON(f.note),"text/html":c.getDataAsHtml(f.note),"text/plain":c.getDataAsPlain(f.note)},e.setDataMap(d),e.clearData("text/uri-list"),e.setProperty("effectAllowed","move")},getRangeByPoint:function(a,b){var c,d;return c=document.caretRangeFromPoint(a,b),d=document.createRange(),d.setStart(c.startContainer,c.startOffset),d},addDragHint:function(a,b){var c,d,e=this,f=e.getRangeByPoint(a,b),g=e.noteView,h=g.parseNativeRange(f)[0];return e.getNoteRange()?(c=e.getNoteRange().getStartBlockRange())&&h?!(h.block===c.block&&h.start>=c.start&&h.start<c.end)&&(e.lastDragOver?d=e.lastDragSpace.parentNode.removeChild(e.lastDragSpace):(d=document.createElement("span"),d.id="drop-hint",e.lastDragOver={}),e.lastDragOver.x=a,e.lastDragOver.y=b,e.lastDragSpace=d,void f.insertNode(d)):(q.error("addDragHint:startRange and dragRange should not be null",c,h),!1):(q.error("addDragHint:Failed to get NoteRange"),!1)},removeDragHint:function(){var a;this.lastDragSpace&&this.lastDragSpace.parentNode&&(a=this.lastDragSpace.parentNode,a.removeChild(this.lastDragSpace)),this.lastDragOver=this.lastDragSpace=null},_onDragOver:function(a,b){var c=this,d=a.clientX,e=a.clientY,f=a.dataTransfer.types;if(!l.contains(f,"text/yne-json"))return l.contains(f,"Files")&&(a.preventDefault(),a.stopPropagation()),!0;if(a.preventDefault(),a.stopPropagation(),!this.lastDragOver||c.lastDragOver.x!==d||c.lastDragOver.y!==e){if(!p.isTextBlock(b)&&!p.isListItem(b))return a.dataTransfer.dropEffect="none",void c.removeDragHint();a.dataTransfer.dropEffect="move",!1===c.addDragHint(d,e)&&(a.dataTransfer.dropEffect="none")}},_onDrop:function(a){var b,c,d,e,f=this,g=a.dataTransfer,h=g.types,j=f.noteView,k=f.getRangeByPoint(a.clientX,a.clientY);a.preventDefault(),a.stopPropagation(),l.contains(h,"text/yne-json")&&(b=g.getData("text/yne-json"),c=i.parseJSON(b),l.map(c,function(a){a.setId(w.newGUID())}),d=j.parseNativeRange(k),(e=d[0])&&e.isCollapsed()&&j.trigger("command","comp.DragBlocks",{range:f.startNoteRange,dropRange:e,blocks:c})),l.contains(h,"Files")&&f.noteSelection.setRange(k),f.removeDragHint()},_onDragEnd:function(){this.removeDragHint()},selectAll:function(){return this.noteView.onSelectAll()},canRemoveFormat:function(){var a=this,b=a.getNoteRange();return b&&!b.isCollapsed()},defaultNoteRange:function(){var a,b,c=this,d=c.note;if(d&&(a=d.getBlockAt(0)))return b=o.createRangeByBlock({block:a,allContent:!1,collapseToStart:!0}),new g({startRange:b,endRange:b})},isValidNoteRange:function(a){var b=this,c=function(a){var c;return!(!a||!a.block)&&(c=a.block,b.note.getBlockIndex(c)>-1)};return!!a&&(b.isValidHeaderFooterRange(a)||c(a.getStartBlockRange())&&c(a.getEndBlockRange()))},isValidHeaderFooterRange:function(a){var b=this.note,c=a.getStartBlockRange(),d=a.getEndBlockRange();return l.all([c,d],function(a){if(!a||!a.block)return!1;var c=a.block
;return b.getHeaderFooter(!0)===c||b.getHeaderFooter(!1)===c})},setReadOnly:function(a){var b=this;a=!!a,b.isReadOnly()!==a&&(b._isReadOnly=a,l.each(["note"],function(c){var d=b[c];d&&d.setReadOnly&&d.setReadOnly(a)}))},isReadOnly:function(){return this._isReadOnly},updateShortCut:function(a,b){var c=this.keyHandlerManager;c&&c.updateKey(a,b)},removeShortCut:function(a){var b=this.keyHandlerManager;b&&b.unbind(a)},resizeSpecialBlock:function(){var a=this,b=a.note;l.each(b.blocks,function(a){(p.isTable(a)||p.isImage(a))&&a.trigger("view-resize")})},zoomInEditor:function(){this.editor.setZoomPercent(1)},zoomOutEditor:function(){this.editor.setZoomPercent(-1)},zoomEditor:function(){this.editor.zoomEditor(1,!0)},_executeCollabCmd:function(a,b){var c,d=this,e=d.getNoteRange();!1===(c=d.cmdManager.exec(a,e,b))&&b.collabProperties.isOwnCmd&&d.editor.notifyErrorToHost(k.INVALIDACTION_FAILED_COLLABCMD,d.editor)},_executeLocalCmd:function(a,b){var c,d=this;if(!a||!1!==a.isReadyToApply)return c=d.getNoteRange(),d.cmdManager.exec(a,c,b)},_handleLocalCmdInCollabMode:function(a,b){var c,d,e,f=this,g=!0,h=!0;if(c=f.getNoteRange(),a.setCmdOriginalNoteVersion(f.note.getFileVersion()),!f.editor.isValidLocalDataCmd(a))return void q.warn("skip invalid local command");d=f.noteView.isOnComposition&&"comp.KeyBackspace"===a.name,e=a.isSingleBlockAffected()&&f.editor.isMyOwnLockedBlock(b.range)&&f.editor.isLastOwnDataCmdExecuted(),d||e?(g=f.cmdManager.exec(a,c,b),!1===g?(h=!1,f.editor.notifyErrorToHost(k.INVALIDACTION_FAILED_LOCALCMD,f.editor)):a.effected?a.isLocalExecutedCmd=!0:h=!1):a.isLocalExecutedCmd=!1,h?f.editor.pushLocalDataCommand(a,d):q.warn("NotReadyToSend:",a)},_onCompositionStart:function(a){var b,c,d=this,e=d.getNoteRange(),f=[],g=!1;if(!e)return void q.error("_onCompositionStart:noteRange should not be null");if(d.isCollabEnabled()){if(c=d.note.getInterBlocks(e.getStartBlockRange().block,e.getEndBlockRange().block,!0),l.each(c,function(a){var b=d.noteView.getBlockViewByBlock(a);f.push(b),b.isCollabLocked()&&(g=!0)}),a(g,f),g)return;b=e.getStartBlockRange(),b&&e.isInSingleBlock()&&p.isTextBlock(b.block)&&!d.editor.isMyOwnLockedBlock(b)&&(d.editor.sendCachedDataCommand(),d._sendBlockLockInfo(b.block.getId()))}},_redoUndoLocalCmdInCollabMode:function(a){var b,c=this;return a.collabProperties.isCollabUndo?b=c.cmdManager.getUndoCmd():a.collabProperties.isCollabRedo&&(b=c.cmdManager.getRedoCmd()),b?(b=l.clone(b),b.setCmdOriginalNoteVersion(c.note.getFileVersion()),b.isLocalExecutedCmd=!1,a.collabProperties.isCollabUndo?(b.setCollabUndo(!0),b.setCollabRedo(!1)):a.collabProperties.isCollabRedo&&(b.setCollabRedo(!0),b.setCollabUndo(!1)),c.editor.isValidLocalDataCmd(b)?void(w.isInlineStateSetCommand(b)||c.editor.pushLocalDataCommand(b,!0)):void q.warn("skip invalid redo/undo local command")):void q.warn("skip empty redo/undo local command")},_sendBlockLockInfo:function(a){var b=this;b.editor.hasCachedDataCmd()?window.setTimeout(b._sendBlockLockInfo.bind(b,a),100):b.editor.sendBlockLockInfo(a)},insertImage:function(a){var b=this,c=b.getNoteRange();a&&(b.noteSelection.setRange(c),b.execCommand("comp.InsertImage",{src:a}))},insertAttachment:function(a){var b,c=this,d=c.getNoteRange();if(!a||!a.src)return q.log("Error: attachment data is invald! "+a);switch(b=a.resource&&a.fileName?"attachment":"image",c.noteSelection.setRange(d),b){case"attachment":c.execCommand("comp.InsertAttachment",{src:a.src,resource:a.resource,fileName:a.fileName,fileLength:a.fileLength});break;case"image":c.insertImage(a.src)}},execDeleteToEnd:function(){var a,b,c=this,d=c.getNoteRange();if(d){if(!d.isCollapsed())return c._onDeleteSelection();a=d.clone(!0),b=d.getEndBlockRange(),b.expandToEnd(),c.execDeleteBackward(a)}},_getImgItems:function(a){var b=this,c=b.note.blocks,d=[],e=0;l.each(c,function(b){if(b&&p.isImage(b)){var c=b.getSource().replace(location.protocol+"//"+location.hostname,"");a===b&&(e=d.length),d.push({index:d.length,preSrc:c,src:c,name:b.getTitle()})}}),b.trigger("yne-preview-image",[e,d])},lockBlockById:function(a){this.isCollabEnabled()&&this._sendBlockLockInfo(a)},innerGoto:function(a){var b,c;if(this.note.getBlockById(a),b=document.getElementById(a),this.pageViewManager&&!b&&(this.pageViewManager.activePageByBlockId(a),b=document.getElementById(a)),!b)return q.warn("No find the block!");window.location.hash="#"+a,c=document.createRange(),c.setStart(b.lastChild,1),c.setEnd(b.lastChild,1),D.setRange(c,window),window.location.hash=""},_onHeaderFooterViewTextChange:function(a,b){this.onCommand("comp.SetHeaderFooter",{content:a,headerFooter:b,range:g.createForHeaderFooter(b)})},_onGetNoteRange:function(a){a(this.getNoteRange())},_onGetBlockView:function(a,b){var c=this,d=c.noteView;d&&b(d.getBlockViewByBlock(a))},_onEnterTableEdit:function(a){a.blockId&&(this.editor.sendCachedDataCommand(),this._sendBlockLockInfo(a.blockId)),this.trigger("cell-edit-view-enter",a)},_onSaveContent:function(){this.trigger("yne-save-content")}},l.extend(b,n.Events),c.extend(b)}(),yne_pc_util_convertHtmlWithResMap=function(a){var b=yne_underscore,c=yne_jtk_web_dom_parseHTML;return function(a,d){if(!a||!d)return a;var e=c(a),f=e.querySelectorAll("img[data-media-type=attachment]"),g=e.querySelectorAll("img[data-media-type=image]"),h=function(a,c){b.each(a,function(a,b){a&&c.setAttribute(b,a)})};return b.each(f,function(a){var b=a.getAttribute("src"),c=a.getAttribute("path"),e=a.getAttribute("filelength"),f=a.getAttribute("filename"),g={"data-res-id":c,src:d[b],"data-attr-org-src-id":b,"data-attr-org-img-file":d[b],"data-file-name":f,"data-file-length":e,class:"editor-attachment"};h(g,a)}),b.each(g,function(a){var b=a.getAttribute("src"),c={src:d[b],"data-attr-org-src-id":b};h(c,a)}),e.innerHTML}}(),yne_pc_core_PcController=function(a){var b=yne_common_core_Controller,c=yne_jtk_core_L,d=yne_pc_util_convertHtmlWithResMap;return b.extend({initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments)},reset:function(){var a=this;b.prototype.reset.apply(a,arguments)},_bindEvents:function(){var a=this;b.prototype._bindEvents.apply(a,arguments)},_getRangeData:function(){var a,c=this,e=b.prototype._getRangeData.apply(c,arguments),f=e["text/html"],g=c.note.getExtraInfo("pcResMap");return a=d(f,g),e["text/html"]=a,e},onPaste:function(a){var b,c,d=this,e=a.originalEvent,f=e.clipboardData;if(a.preventDefault(),d._isPasteAsText)return void d.trigger("yne-on-paste",!0,a);c=f.getData("text/yne-json"),b=f.getData("text/yne-table-json"),!c&&b&&d._pasteYTableJson(b)||d.trigger("yne-on-paste",!1,a)},focusEditor:function(){var a=this,b=a.getNoteRange();c.log("focusEditor",b),a._isReadOnly||(a.isValidNoteRange(b)||(b=a.defaultNoteRange()),a.noteSelection.setRange(b,null,!1))}})}(),yne_pc_toolbar_Panel=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jtk_core_L;return b.View.extend({class:"bulb-panel",events:{mousedown:"_onMouseDown"},initialize:function(a){var b=this;b._editor=a.editor,b._items=[],b.isRendered=!1},addItems:function(a){var b=this;a=c.isArray(a)?a:[a],c.each(a,function(a){b._items.push(a),b.isRendered&&b.$el.append(a.$el)})},getItemByName:function(a){var b=this;return c.find(b._items,function(b){return b.name===a})},render:function(){var a=this;a.isRendered||(a.isRendered=!0,c.each(a._items,function(b){a.$el.append(b.$el)}))},_onMouseDown:function(a){a.preventDefault()},show:function(){this.$el.show()},hide:function(){this.$el.hide()},_invoke:function(a){var b=this;c.each(b._items,function(b){b[a]?b[a]():d.error("item."+a+" is not method",b)})},enable:function(){var a=this;a.$el.removeClass("disabled"),a._invoke("enable")},disable:function(){var a=this;a.$el.addClass("disabled"),a._invoke("disable")},reset:function(){this._invoke("reset")}})}(),yne_pc_toolbar_CommonButton=function(a){return yne_backbone.View.extend({editorEvents:{"yne-editing-state-change":"onEditingStateChange","yne-selection-change":"onSelectionChange"},isVisible:!0,show:function(){this.$el.css("display","inline-block"),this.isVisible=!0},hide:function(){this.$el.hide(),this.$el.css("display","none"),this.isVisible=!1},enable:function(){this.$el.removeClass("disabled")},disable:function(){this.$el.addClass("disabled")},onEditingStateChange:function(){},onSelectionChange:function(){}})}(),yne_jtk_core_fn_noop=function(){return function(){}}(),yne_pc_toolbar_BaseSplit=function(a){var b=yne_pc_toolbar_CommonButton,c=yne_jtk_core_fn_noop;return b.extend({name:"base-split",className:"toolbar-item toolbar-split",initialize:c,render:c,enable:c,disable:c,reset:c})}(),yne_pc_toolbar_BaseButton=function(a){var b=yne_underscore,c=yne_jtk_core_L,d=yne_common_jst;return yne_pc_toolbar_CommonButton.extend({className:"toolbar-item toolbar-button",events:{click:"onClick",mousedown:"onMouseDown"},name:"unknown",label:"",text:!1,defaultState:!1,state:!1,templateName:"toolbar-button-template",shortcut:null,editorEvents:{"yne-editing-state-change":"onEditingStateChange","yne-selection-change":"onSelectionChange"},initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.setState(b.defaultState),b.bindEditorEvents(),b.bindEvents()},render:function(){var a,b=this,c=b.$el,e=b.label;c.addClass("button-"+b.name),a=d.render("pc",b.templateName,{name:b.name,label:b.label,text:b.text,defaultState:b.defaultState}),c.html(a),null!=b.shortcut&&(e="<div><span>"+b.label+'</span><span class="split"></span><span>'+b.shortcut+"</span><div>"),c.find(".button-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300],content:e,contentAsHTML:!0}),b.isVisible||b.hide()},bindEvents:function(){},bindEditorEvents:function(){var a=this,c=a.editor,d=a.editorEvents;d&&b.each(d,function(b,d){c.on(d,a[b].bind(a))})},onMouseDown:function(a){a.preventDefault()},onClick:function(){},setState:function(a){var b=this,c=b.$el;a=!0===a,b.state=a,a?c.find(".button").addClass("active"):c.find(".button").removeClass("active")},reset:function(){var a=this;c.warn("Button ["+a.name+"] reset(): do nothing!")},onSelectionChange:function(){}})}(),yne_pc_toolbar_TextButton=function(a){var b=yne_pc_toolbar_BaseButton;return b.extend({className:b.prototype.className+" toolbar-text-button",state:!0,editorEvents:null,render:function(){var a=this;a.$el.addClass("text-button-"+a.name).text(a.text),a.setState(a.state)},setState:function(a){var b=this,c=b.$el;a=!0===a,b.state=a,a?c.addClass("active"):c.removeClass("active")},onClick:function(){this.trigger("on-click")}})}(),yne_pc_toolbar_FullScreenButton=function(a){var b=yne_pc_toolbar_TextButton;return b.extend({name:"full-screen",text:"退出全屏",label:"退出全屏",onClick:function(){this.trigger("exit-full-screen")},show:function(){this.$el.show()},hide:function(){this.$el.hide()},disable:function(){}})}(),yne_pc_toolbar_ToggleTabButton=function(a){var b=yne_pc_toolbar_BaseButton;return b.extend({name:"toggle-tab",label:"收缩/展开工具栏",onClick:function(){var a=this;a.trigger("toggle-tab"),a.$el.toggleClass("reverse")}})}(),yne_pc_toolbar_ToggleAllItems=function(a){var b=yne_pc_toolbar_BaseButton;return b.extend({name:"toggle-allItems",label:"收缩/展开工具栏",onClick:function(){var a=this;a.$el.toggleClass("reverse"),a.trigger("toggle-allItems")},isCollapsed:function(){return!this.$el.hasClass("reverse")}})}(),yne_pc_toolbar_BaseComboBox=function(a){var b=yne_pc_toolbar_CommonButton,c=yne_underscore,d=yne_jquery,e=yne_common_jst;return b.extend({className:"toolbar-item toolbar-combo-box",events:{"click .combo-value-wrapper":"onValueWrapperElClick","click .combo-expand-wrapper":"onExpandWrapperElClick","click .combo-menu-wrapper":"onMenuWrapperClick","click .combo-display-wrapper":"onClickDisplayWrapper",mousedown:"onMouseDown"},name:"unknown",label:"unknown",defaultValue:"",items:{},value:"",templateName:"toolbar-combo-box-template",_isForceSelectWhenClick:!1,initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.defaultSetValue?b.select(b.defaultSetValue):b.select(b.defaultValue),b.bindEvents(),b.bindDocumentEvents(),b.bindEditorEvents()},render:function(){var a,b=this,c=b.$el;if(c.addClass("combo-box-"+b.name),a=e.render("pc",b.templateName,{name:b.name,label:b.label,defaultValue:b.defaultValue,items:b.items,text:!1}),c.html(a),b.valueWrapperEl=c.find(".combo-value-wrapper")[0],b.expandWrapperEl=c.find(".combo-expand-wrapper")[0],b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],b.displayWrapperEl=c.find(".combo-display-wrapper")[0],d(b.displayWrapperEl).tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]}),b.isVisible||b.hide(),"heading"===b.name)for(var f=3;f<=6;f++)d(d(b.menuWrapperEl).find("li[data-value="+f+"]")[0]).tooltipster({animation:"",animationDuration:0,theme:["tooltipster-heading","tooltipster-heading-customized"],side:"right",delay:[800,300],content:"Ctrl+"+(f-2)})},bindEvents:function(){},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},bindEditorEvents:function(){var a=this,b=a.editor,d=a.editorEvents;d&&c.each(d,function(c,d){b.on(d,a[c].bind(a))})},onValueWrapperElClick:function(){this.toggleMenu()},onExpandWrapperElClick:function(){this.toggleMenu()},onClickDisplayWrapper:function(){var a=this;a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")},onMenuWrapperClick:function(a){var b=this,c=a.target,e=d(c).closest(".combo-item")[0];e&&(b.hideMenu(),b.onItemClick(e))},onItemClick:function(a){var b=this,c=d(a).data("value");!c||c===b.value&&!0!==b._isForceSelectWhenClick||(b._isForceSelectWhenClick=!1,b.select(c),b.onChange(c))},select:function(a){var b=this;b.value=a,b.updateValueUI(a)},updateValueUI:function(){},onChange:function(){},showMenu:function(){var a,b=this,c=b.menuWrapperEl;d(c).removeClass("menu-position-fix"),d(c).addClass("show"),a=c.getBoundingClientRect(),a.right>document.documentElement.offsetWidth&&d(c).addClass("menu-position-fix")},hideMenu:function(){d(this.menuWrapperEl).removeClass("show")},toggleMenu:function(){var a=this;d(a.menuWrapperEl).hasClass("show")?a.hideMenu():a.showMenu()},onDocumentMouseDown:function(a){var b=this,c=a.target;d.contains(b.el,c)||b.hideMenu()},onMouseDown:function(a){a.preventDefault()},reset:function(){var a=this;a.hideMenu(),a.defaultSetValue?a.select(a.defaultSetValue):a.select(a.defaultValue)}})}(),yne_pc_toolbar_block_BaseBlockComboBox=function(a){return yne_pc_toolbar_BaseComboBox.extend({editorEvents:{"yne-selection-change":"onSelectionChange"},onChange:function(a){var b=this,c={};c[b.name]=a,b.editor.execCommandByToolbar("comp.ApplyStyles",{blockStyles:c})}})}(),yne_pc_toolbar_block_Align=function(a){var b=yne_pc_toolbar_block_BaseBlockComboBox,c=yne_common_data_blockTypes,d=yne_common_jst,e=yne_underscore,f=yne_jquery,g=b.extend({name:"align",label:"对齐方式",defaultValue:"left",items:{justify:"两端对齐",left:"左对齐",center:"居中对齐",right:"右对齐"},templateName:"toolbar-combo-box-align",render:function(){var a,b=this,c=b.$el;c.addClass("combo-box-"+b.name),a=d.render("pc",b.templateName,{name:b.name,label:b.label,defaultValue:b.defaultValue,text:!1,items:b.items}),c.html(a),b.valueWrapperEl=c.find(".combo-value-wrapper")[0],b.expandWrapperEl=c.find(".combo-expand-wrapper")[0],b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],c.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]})},onChange:function(a){var b,d,e,f,h=this;if(b=h.editor,(e=b.getNoteRange())&&(d=e.getStartBlockRange(),(f=d.block)&&c.isHeaderFooter(f)))return void b.execCommandByToolbar("comp.SetHeaderFooter",{align:a,headerFooter:f,range:d});g.__super__.onChange.apply(h,arguments)},updateValueUI:function(a){var b=this,c=f(b.valueWrapperEl).find(".combo-value")[0];f(c).removeClass(e.keys(b.items).join(" ")),f(c).addClass(a)},onSelectionChange:function(){var a,b=this,d=b.editor.getNoteRange(),e=d&&d.getStartBlockRange().block;b.$el.hasClass("disabled")||(a=e&&c.isHeaderFooter(e)?e.getAlign():b.editor.querySelectionBlockStyle(b.name),b.items[a]?b.select(a):this.select(b.defaultValue))}});return g}(),yne_pc_toolbar_block_Indent=function(a){return yne_pc_toolbar_BaseButton.extend({name:"indent",label:"增加缩进",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.execCommandByToolbar("comp.IndentOutdent",{indentStep:1}),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_block_LineHeight=function(a){var b=yne_pc_toolbar_block_BaseBlockComboBox,c=yne_underscore,d=yne_common_constants,e=yne_jquery;return b.extend({name:"line-height",label:"行高",defaultValue:d.PLATFORM_LINE_HEIGHT,keys:[1,1.25,1.5,1.75,2,2.5,3],items:[{key:1,value:"1.0"},{key:1.25,value:"1.25"},{key:1.5,value:"1.5"},{key:1.75,value:"1.75"},{key:2,value:"2.0"},{key:2.5,value:"2.5"},{key:3,value:"3.0"}],templateName:"toolbar-combo-box-line-height",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),a._keys=c.map(a.items,function(a){return a.key})},updateValueUI:function(a){var b=this,d=e(b.menuWrapperEl),f=c.indexOf(b._keys,a);d.find(".active").removeClass("active svg-common"),-1!==f&&d.find(".line-height-"+f).addClass("active svg-common")},onSelectionChange:function(){var a,b,d,e,f=this;f.$el.hasClass("disabled")||(a=f.editor.querySelectionBlockStyle(f.name),e=c.indexOf(f._keys,a),-1!==e?f.select(a):parseFloat(a)==a?(b=parseFloat(a),c.each(f.keys,function(c){var e=Math.abs(c-a);e<b&&(d=c,b=e)}),f.select(d)):(f.select(f.defaultValue),f._isForceSelectWhenClick=!0))}})}(),yne_pc_toolbar_block_BaseBlockButton=function(a){return yne_pc_toolbar_BaseButton.extend({editorEvents:{"yne-selection-change":"onSelectionChange"},onSelectionChange:function(){var a=this;a.$el.hasClass("disabled")||a.setState(a.querySelectionState())},querySelectionState:function(){var a=this;return a.editor.querySelectionInlineStyle(a.name)}})}(),yne_pc_toolbar_block_OrderedList=function(a){var b=yne_common_data_List;return yne_pc_toolbar_block_BaseBlockButton.extend({name:"ordered-list",label:"项目编号",defaultState:!1,state:!1,templateName:"toolbar-button-template",shortcut:"Ctrl+Shift+L",querySelectionState:function(){return this.editor.isSameList("ordered")},onClick:function(){var a=this;a.editor.execCommandByToolbar("comp.InsertList",{type:b.ORDERED}),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_block_Outdent=function(a){return yne_pc_toolbar_BaseButton.extend({name:"outdent",label:"减少缩进",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.execCommandByToolbar("comp.IndentOutdent",{indentStep:-1}),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_block_UnorderedList=function(a){var b=yne_common_data_List;return yne_pc_toolbar_block_BaseBlockButton.extend({name:"unordered-list",label:"无序列表",defaultState:!1,state:!1,templateName:"toolbar-button-template",shortcut:"Ctrl+L",querySelectionState:function(){return this.editor.isSameList("unordered")},onClick:function(){var a=this;a.editor.execCommandByToolbar("comp.InsertList",{type:b.UNORDERED}),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_config_colors={theme:["#ffffff","#000000","#eeece0","#1c487f","#4d80bf","#c24f4a","#9abc52","#7b5ba1","#46acc8","#f9963b"],other:[["#f2f2f2","#808080","#ddd9c2","#c5d9f2","#dce6f3","#f3dcdb","#ebf1dd","#e6e0ec","#daeef4","#feead9"],["#d9d9d9","#595959","#c4be95","#8db3e5","#b8cde6","#e7b9b7","#d7e5bb","#ccc0db","#b6dee9","#fdd5b3"],["#bfbfbf","#404040","#948b50","#528cd8","#94b2d9","#da9693","#c3d798","#b3a1c8","#91cdde","#fbc08c"],["#a6a6a6","#262626","#4a4528","#15365f","#355f94","#973632","#769436","#60487c","#2c859d","#e66c00"],["#808080","#0d0d0d","#1e1c10","#0f2340","#243f62","#642422","#4f6324","#403053","#1e5969","#994800"]],standard:["#df402a","#f77567","#fad4d3","#fae220","#b19067","#77c94b","#98dede","#184e87","#9896a4","#90a7d1"]},yne_pc_toolbar_BaseColorComboBox=function(a){var b=yne_pc_toolbar_BaseComboBox,c=yne_jquery,d=yne_pc_toolbar_config_colors;return b.extend({name:"color",defaultValue:"#000000",items:d,templateName:"toolbar-combo-box-color",editorEvents:{"yne-selection-change":"onSelectionChange"},onValueWrapperElClick:function(){var a=this,b=a.value;a.hideMenu(),b!==a.selectedValue&&a.onChange(b)},onChange:function(a){this.doAction(a)},doAction:function(){},onItemClick:function(a){var b=this,d=c(a).data("value");if(c(a).hasClass("color-section-other"))return b.editor.trigger("color-picker-show",b),void b.hideMenu();b.changeValue(d)},changeValue:function(a){var b=this;a&&a!==b.value&&b.select(a),a&&a!==b.selectedValue&&b.onChange(a)},updateValueUI:function(a){var b=this,d=c(b.valueWrapperEl).find(".combo-value-buttom-color")[0];c(d).css("background-color",a)},onSelectionChange:function(){var a,b=this;b.$el.hasClass("disabled")||(a=b.editor.querySelectionInlineStyle(b.name),b.selectedValue=a)}})}(),yne_pc_toolbar_inline_BaseInlineColorComboBox=function(a){var b=yne_pc_toolbar_BaseColorComboBox,c=yne_underscore;return b.extend({editorEvents:{"yne-editing-state-change":"onEditingStateChange"},onEditingStateChange:function(a){var b=this;c.has(a,b.name)&&(b.selectedValue=a[b.name])}})}(),yne_pc_toolbar_inline_BackColor=function(a){return yne_pc_toolbar_inline_BaseInlineColorComboBox.extend({name:"back-color",label:"背景色",defaultValue:"transparent",defaultSetValue:"#FAE220",templateName:"toolbar-combo-box-back-color",doAction:function(a){var b=this,c={};c[b.name]=a||b.value,b.editor.execCommandByToolbar("comp.ApplyStyles",{inlineStyles:c})}})}(),yne_pc_toolbar_inline_BaseInlineButton=function(a){var b=yne_pc_toolbar_BaseButton,c=yne_underscore;return b.extend({editorEvents:{"yne-editing-state-change":"onEditingStateChange"},onEditingStateChange:function(a){var b=this;c.has(a,b.name)&&b.setState(a[b.name])},onClick:function(){var a=this,b={};b[a.name]=!a.state,a.editor.execCommandByToolbar("comp.ApplyStyles",{inlineStyles:b}),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_inline_Bold=function(a){return yne_pc_toolbar_inline_BaseInlineButton.extend({name:"bold",label:"加粗",shortcut:"Ctrl+B"})}();yne_pc_toolbar_inline_Color=function(a){var b=yne_jtk_core_L,c=yne_tinycolor;return yne_pc_toolbar_inline_BaseInlineColorComboBox.extend({name:"color",label:"文字颜色",defaultValue:"#000000",defaultSetValue:"#DF402A",doAction:function(a){var d=this,e={},f=a||d.value,g=c(f);if(!g||!1===g.isValid())return void b.error("tiny color object is not valid",g);e[d.name]=g.toHexString(),d.editor.execCommandByToolbar("comp.ApplyStyles",{inlineStyles:e})}})}(),yne_pc_toolbar_inline_BaseInlineComboBox=function(a){var b=yne_pc_toolbar_BaseComboBox,c=yne_jquery,d=yne_underscore;return b.extend({editorEvents:{"yne-editing-state-change":"onEditingStateChange"},onChange:function(a){var b=this,c={};c[b.name]=a,b.editor.execCommandByToolbar("comp.ApplyStyles",{inlineStyles:c})},updateValueUI:function(a){var b=this,d=c(b.valueWrapperEl).find(".combo-value")[0];b.items[a]?c(d).text(b.items[a]):c(d).text(b.getUnlistedText(a)||"")},getUnlistedText:function(){return""},onEditingStateChange:function(a,b){var c=this;c._isForceSelectWhenClick=!1,d.has(a,c.name)&&(b&&d.has(b,c.name)&&a[c.name]!==b[c.name]&&(c._isForceSelectWhenClick=!0),c.select(a[c.name]))}})}(),yne_pc_toolbar_inline_FontFamily=function(a){var b,c=yne_pc_toolbar_inline_BaseInlineComboBox,d=yne_common_constants,e=yne_common_fontMaps,f=yne_jquery;return b=c.extend({name:"font-family",label:"字体",defaultValue:e.DEFAULT_FONT,items:e.getItems(),templateName:"toolbar-combo-box-font-family",getUnlistedText:function(a){var b;return a&&a!==d.INTERM&&(b=e.getFont(a)),b=b||e.splitFontFamily(a)[0]||"微软雅黑"},render:function(){var a,c=this;b.__super__.render.apply(c,arguments),a=c.$el.find(".combo-value-font-family"),f(a).hover(function(){f(c.displayWrapperEl).tooltipster({animation:"",animationDuration:0,content:a.text(),delay:[800,300]})},function(){f(c.displayWrapperEl).tooltipster({animation:"",animationDuration:0,content:c.label,delay:[800,300]})})}})}(),yne_common_fontSize=function(a){var b=yne_underscore;return{getAsArray:function(){return[9,12,14,16,18,22,26,30,36,42]},getAsList:function(){var a=this,c=a.getAsArray(),d={};return b.each(c,function(a){d[a]=a}),d},getMin:function(){return this.getAsArray()[0]},getMax:function(){var a=this.getAsArray();return a[a.length-1]}}}(),yne_pc_toolbar_inline_FontSize=function(a){var b=yne_pc_toolbar_inline_BaseInlineComboBox,c=yne_common_fontSize;return b.extend({name:"font-size",label:"字号",defaultValue:"14",items:c.getAsList(),templateName:"toolbar-combo-box-font-size",getUnlistedText:function(a){var b=this,c=parseInt(a,10);return c&&!isNaN(c)?c+"":b.defaultValue+""}})}(),yne_pc_toolbar_inline_Italic=function(a){return yne_pc_toolbar_inline_BaseInlineButton.extend({name:"italic",label:"斜体",shortcut:"Ctrl+I"})}(),yne_pc_toolbar_inline_Strike=function(a){return yne_pc_toolbar_inline_BaseInlineButton.extend({name:"strike",label:"删除线",shortcut:"Ctrl+E"})}(),yne_pc_toolbar_inline_Underline=function(a){return yne_pc_toolbar_inline_BaseInlineButton.extend({name:"underline",label:"下划线",shortcut:"Ctrl+U"})}(),yne_pc_toolbar_insert_BaseInsertButton=function(a){return yne_pc_toolbar_BaseButton.extend({editorEvents:{"yne-editing-state-change":"onEditingStateChange"},onEditingStateChange:function(){}})}(),yne_pc_toolbar_insert_InsertAttachment=function(a){return yne_pc_toolbar_insert_BaseInsertButton.extend({name:"attachment",label:"插入附件",text:"附件",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){var a=this;a.editor.trigger("yne-insert-attachment"),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_insert_InsertHorizontalRule=function(a){return yne_pc_toolbar_insert_BaseInsertButton.extend({name:"hr",label:"水平线",text:"横线",defaultState:!1,state:!1,templateName:"toolbar-button-template",shortcut:"Ctrl+H",onClick:function(){var a=this;a.editor.execCommandByToolbar("comp.InsertHorizontalRule"),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_insert_InsertImage=function(a){return yne_pc_toolbar_insert_BaseInsertButton.extend({name:"img",label:"插入图片",text:"图片",defaultState:!1,state:!1,onClick:function(){var a=this;a.editor.trigger("yne-insert-photo"),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")}})}(),yne_pc_toolbar_insert_InsertLink=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst,f=yne_common_util_xssFilter,g=yne_common_key_keyCodeMap;return b.View.extend({className:"toolbar-item toolbar-combo-box toolbar-combo-link",name:"link",label:"插入链接",text:"链接",templateName:"toolbar-combo-box-insert-link",events:{"mousedown .combo-value-wrapper-link":"onValueWrapperMouseDown","click .combo-value-wrapper-link":"onValueWrapperClick","click .link-button":"onConfirmButtonClick",mousedown:"onMouseDown"},initialize:function(a){var b=this;b.editor=a.editor,b.items=a.items,b.render(),b.bindDocumentEvents(),b.bindEditorEvents()},render:function(){var a,b=this,c=b.$el;a=e.render("pc",b.templateName,{name:b.name,label:b.label,text:b.text}),c.html(a),b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],b.menuItemContainer=c.find(".combo-menu")[0],b.input=c.find(".link-input"),d(b.input).keydown(function(a){a.stopPropagation(),g.isMatch("enter",a.keyCode)&&(a.preventDefault(),b.onConfirmButtonClick())}),c.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]})},bindEditorEvents:function(){var a=this,b=a.editor,d=a.editorEvents;d&&c.each(d,function(c,d){b.on(d,a[c].bind(a))})},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},onDocumentMouseDown:function(){this.hideMenu()},onMouseDown:function(a){a.stopPropagation(),a.preventDefault()},onConfirmButtonClick:function(){var a=this,b=f.safeHref(d(a.input).val().trim());b&&a.editor.execCommandByToolbar("comp.InsertLink",{src:b,styles:a.editor.controller.getEditingInlineState()}),window.focus(),a.hideMenu()},onValueWrapperMouseDown:function(a){a.preventDefault()},onValueWrapperClick:function(){this.toggleMenu(),this.editor.trigger("yne-user-action-collection","tab-body-"+this.name+"-click")},toggleMenu:function(){d(this.menuWrapperEl).toggleClass("show")},showMenu:function(){var a=this,b=a.menuWrapperEl;d(b).addClass("show")},hideMenu:function(){var a=this,b=a.menuWrapperEl;d(b).removeClass("show"),d(a.input).val("")},show:function(){return this.$el.show(),!0},enable:function(){this.$el.removeClass("disabled")},disable:function(){this.$el.addClass("disabled")},reset:function(){this.hideMenu()}})}(),yne_pc_toolbar_insert_InsertTable=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst,f=8;return b.View.extend({className:"toolbar-item toolbar-combo-box toolbar-combo-box-table",events:{"click .combo-value-wrapper":"onValueWrapperClick","mouseleave .combo-menu":"onMenuMouseLeave","mouseenter .combo-item":"onItemMouseEnter","click .combo-item":"onItemClick",mousedown:"onMouseDown"},editorEvents:{"yne-editing-state-change":"onEditingStateChange","yne-selection-change":"onSelectionChange"},name:"table",label:"表格",text:"表格",templateName:"toolbar-combo-box-table",initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.bindDocumentEvents(),b.bindEditorEvents()},render:function(){var a,b=this,c=b.$el;a=e.render("pc",b.templateName,{name:b.name,label:b.label,text:b.text,maxRows:6,maxCols:f}),c.html(a),b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],b.menuLabelEl=c.find(".combo-menu-label-table")[0],b.comboItems=c.find(".combo-item"),c.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]})},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},bindEditorEvents:function(){var a=this,b=a.editor,d=a.editorEvents;d&&c.each(d,function(c,d){b.on(d,a[c].bind(a))})},onDocumentMouseDown:function(a){var b=this,c=a.target;d.contains(b.el,c)||b.hideMenu()},onValueWrapperClick:function(){this.toggleMenu(),this.editor.trigger("yne-user-action-collection","tab-body-"+this.name+"-click")},onItemMouseEnter:function(a){var b=a.target,c=this.getItemCoordinate(b);this.selectItems(c.row+1,c.col+1)},onItemClick:function(a){var b=this,c=a.target,d=b.getItemCoordinate(c);b.insertTable(d.row+1,d.col+1),b.hideMenu()},onMenuMouseLeave:function(){this.resetSelected()},onMouseDown:function(a){a.preventDefault()},getItemCoordinate:function(a){var b=d(a);return{row:b.data("row"),col:b.data("col")}},resetSelected:function(){this.selectItems(0,0)},selectItems:function(a,b){this.updateSelectedLabelText(a,b),this.updateSelectedItemsUI(a,b)},updateSelectedLabelText:function(a,b){var c=d(this.menuLabelEl);a>0&&b>0?c.html(a+" 行 "+b+" 列"):c.html("插入表格")},updateSelectedItemsUI:function(a,b){var c,e,g=this;for(d(g.comboItems).removeClass("selected"),c=0;c<a;c++)for(e=0;e<b;e++)d(g.comboItems[c*f+e]).addClass("selected")},insertTable:function(a,b){this.editor.execCommandByToolbar("comp.InsertTable",{rows:a,cols:b})},toggleMenu:function(){var a=this;d(a.menuWrapperEl).hasClass("show")?a.hideMenu():a.showMenu()},showMenu:function(){var a,b=this,c=b.menuWrapperEl;d(c).removeClass("menu-position-fix"),d(c).addClass("show"),a=c.getBoundingClientRect(),a.right>document.documentElement.offsetWidth&&d(c).addClass("menu-position-fix")},hideMenu:function(){var a=this
;d(a.menuWrapperEl).removeClass("show"),a.resetSelected()},isVisible:!0,show:function(){this.$el.show(),this.isVisible=!0},hide:function(){this.$el.hide(),this.isVisible=!1},enable:function(){this.$el.removeClass("disabled")},disable:function(){this.$el.addClass("disabled")},reset:function(){var a=this;a.resetSelected(),a.hideMenu()},onEditingStateChange:function(){}})}(),yne_pc_toolbar_insert_InsertHeading=function(a){var b=yne_jquery,c=yne_pc_toolbar_inline_BaseInlineComboBox,d=yne_common_util_headingMaps;return c.extend({name:"heading",label:"标题",defaultValue:"default",items:d.headingArray,templateName:"toolbar-combo-box-heading",editorEvents:{"yne-editing-state-change":"onEditingStateChange","yne-selection-change":"onSelectionChange"},updateValueUI:function(a){var c=this,e=b(c.valueWrapperEl).find(".combo-value")[0];d.headingMap[a]?b(e).text(d.headingMap[a].name):b(e).text(c.getUnlistedText(a)||"")},getUnlistedText:function(a){var b=this;return a?d.headingMap[a].name:d.headingMap[b.defaultValue].name+""},onItemClick:function(a){var b,c,e=this;for(b in d.headingMap)if(d.headingMap[b].name===a.innerText){c=b;break}e.editor.execCommandByToolbar("comp.InsertHeading",{level:c})},onEditingStateChange:function(){var a=this,b=a.editor.querySelectionBlockStyle(a.name);d.headingMap[b]?a.select(b):a.select(a.defaultValue)}})}(),yne_pc_toolbar_insert_InsertCatalogue=function(a){return yne_pc_toolbar_insert_BaseInsertButton.extend({name:"catalogue",label:"目录",text:"目录",defaultState:!1,state:!1,templateName:"toolbar-button-template",onClick:function(){this.editor.execCommandByToolbar("comp.InsertCatalogue")}})}(),yne_pc_toolbar_insert_InsertTodo=function(a){return yne_pc_toolbar_insert_BaseInsertButton.extend({name:"todo",label:"待办",defaultState:!1,state:!1,templateName:"toolbar-button-template",shortcut:"Ctrl+D",onClick:function(){this.editor.execCommandByToolbar("comp.InsertTodo",{checked:!1})}})}(),yne_pc_toolbar_other_ExportPdf=function(a){return yne_pc_toolbar_BaseButton.extend({name:"export-pdf",label:"导出为PDF",text:"导出为PDF",defaultState:!1,state:!1,onClick:function(){this.editor.trigger("yne-export-pdf")}})}(),yne_pc_toolbar_other_ExportWord=function(a){return yne_pc_toolbar_BaseButton.extend({name:"export-word",label:"导出为Word",text:"导出为Word",defaultState:!1,state:!1,onClick:function(){this.editor.trigger("yne-export-word")}})}(),yne_pc_toolbar_other_DownloadOriginFile=function(a){var b=yne_pc_toolbar_BaseButton;return b.extend({name:"download-file",label:"下载原始文件",text:"下载原始文件",defaultState:!1,state:!1,enable:function(){var a=this;b.prototype.enable.apply(a),a._updateVisibleState()},disable:function(){var a=this;b.prototype.disable.apply(a),a._updateVisibleState()},onClick:function(){this.editor.trigger("yne-download-file")},_updateVisibleState:function(){var a=this,b=a.editor.getNoteProps();null!=b&&!0===b.hasOriginFile?this.$el.removeClass("hidden"):this.$el.addClass("hidden")}})}(),yne_common_util_FormatPainterManager=function(a){var b,c=yne_jtk_core_Class,d=yne_jquery,e=yne_backbone,f=yne_underscore,g=yne_common_constants,h=yne_tinycolor,i={NONE:0,ONCE:1,REPEAT:2};return b={state:null,data:null,initialize:function(a){var b=this;b._editor=a.editor,b.state=i.NONE,f.bindAll(b,"stash","_paintWithDebounce","reset","_onSelectStart","_onCommandExec")},_isLinkStyle:function(a){return a&&a.color&&a.color!==g.INTERM&&h.equals(a.color,"blue")&&!0===a.underline},stash:function(a){var b,c=this,d=c._editor;c.reset(),b=d.querySelectionInlineStyles(),c._isLinkStyle(b)&&b.href&&(delete b.color,delete b.underline),c.data={inlineStyles:b,blockStyles:d.querySelectionBlockStyles()},a?c.setState(i.ONCE):c.setState(i.REPEAT),c.bindEvents()},paint:function(){var a=this;a.data&&a._editor.execCommandByToolbar("comp.FormatPainter",{data:a.data}),a.state===i.ONCE&&a.reset()},reset:function(){var a=this;a._clearPaintTimeout(),a.data=null,a.setState(i.NONE),a.unbindEvents()},setState:function(a){var b=this;b.state!==a&&(b.state=a,b.trigger("formatpainter-state-change",!!a),b.updateFormatPainterCursorUI(!!a))},updateFormatPainterCursorUI:function(a){this._editor.updateFormatPainterCursorUI(a)},bindEvents:function(){var a=this,b=a._editor;a.unbindEvents(),b.on("selectstart",a._onSelectStart),b.on("mouse-down",a._onSelectStart),b.on("esc",a.reset),b.on("command-exec",a._onCommandExec)},unbindEvents:function(){var a=this,b=a._editor;b.off("selectstart",a._onSelectStart),b.off("mouse-down",a._onSelectStart),b.off("esc",a.reset),b.off("command-exec",a._onCommandExec),d(document).off("mouseup",a._paintWithDebounce)},_onSelectStart:function(){var a=this;d(document).one("mouseup",a._paintWithDebounce)},_clearPaintTimeout:function(){var a=this;a._paintTimeout&&(window.clearTimeout(a._paintTimeout),a._paintTimeout=null)},_paintWithDebounce:function(){var a=this;a._clearPaintTimeout(),a._paintTimeout=window.setTimeout(function(){a.paint()},100)},_onCommandExec:function(a){"comp.FormatPainter"!==(a||{}).name&&this.reset()}},f.extend(b,e.Events),c.extend(b)}(),yne_pc_toolbar_other_FormatPainter=function(a){var b=yne_pc_toolbar_BaseButton,c=yne_common_util_FormatPainterManager;return b.extend({name:"format-painter",label:"格式刷",events:{click:"onClick",dblclick:"onDblClick",mousedown:"onMouseDown"},defaultState:!1,state:!1,templateName:"toolbar-button-template",initialize:function(){var a=this;b.prototype.initialize.apply(a,arguments),a._initFormatPainterManager()},_initFormatPainterManager:function(){var a=this;a._formatPainterManager=new c({editor:a.editor}),a._formatPainterManager.on("formatpainter-state-change",a.onFormatPainterStateChange.bind(a))},clickAction:function(){var a=this;!0===a.state?a.reset():a.stash(!0)},onClick:function(){var a=this;clearTimeout(a._timer),a._timer=setTimeout(function(){a.clickAction()},300),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click")},onDblClick:function(){var a=this;clearTimeout(a._timer),a.stash()},stash:function(a){this._formatPainterManager.stash(a)},reset:function(){this._formatPainterManager.reset()},onFormatPainterStateChange:function(a){this.setState(!!a)}})}(),yne_pc_toolbar_other_PageMode=function(a){var b=yne_pc_toolbar_block_BaseBlockComboBox,c=yne_common_jst,d=yne_underscore,e=yne_jquery;return b.extend({editorEvents:{"view-mode-change":"_onViewModeChange"},name:"view-mode",label:"视图模式",defaultValue:"read",items:{normal:"普通视图",read:"阅读视图",page:"文档视图"},templateName:"toolbar-combo-box-align",_itemsKeyMap:{0:"normal",1:"read",2:"page"},render:function(){var a,b=this,d=b.$el;d.addClass("combo-box-"+b.name),a=c.render("pc",b.templateName,{name:b.name,label:b.label,defaultValue:b.defaultValue,text:b.items[b.defaultValue],items:b.items}),d.html(a),b.valueWrapperEl=d.find(".combo-value-wrapper")[0],b.expandWrapperEl=d.find(".combo-expand-wrapper")[0],b.menuWrapperEl=d.find(".combo-menu-wrapper")[0],d.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]})},updateValueUI:function(a){var b=this,c=e(b.valueWrapperEl);c.find(".combo-value").removeClass(d.keys(b.items).join(" ")).addClass(a),c.find(".combo-text").text(b.items[a])},onChange:function(a){var b=this,c=1;d.some(b._itemsKeyMap,function(b,d){return b===a&&(c=d,!0)}),b.editor.setViewMode(c,!1,!0),b.editor.trigger("yne-user-action-collection","tab-body-pagemode-"+a+"-click")},_onViewModeChange:function(a){var b=this,c=b._itemsKeyMap[a];b.select(c)},reset:function(){this.hideMenu()}})}(),yne_pc_toolbar_other_Redo=function(a){return yne_pc_toolbar_BaseButton.extend({name:"redo",label:"重做",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:{"command-exec":"_onHistoryChange","redo-stack-change":"_onHistoryChange","cell-edit-view-exit":"_onHistoryChange","cell-edit-view-enter":"_onCellEditViewHistoryChange","cell-edit-view-history-change":"_onCellEditViewHistoryChange"},_onHistoryChange:function(){var a=this;a.setState(a.editor.canRedo())},_onCellEditViewHistoryChange:function(a){this.setState(a.canRedo)},onClick:function(){var a=this;!0===a.state&&(a.editor.execCommandByToolbar("redo"),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click"))},reset:function(){this.setState(!1)}})}(),yne_pc_toolbar_other_RemoveFormat=function(a){return yne_pc_toolbar_BaseButton.extend({name:"remove-format",label:"清除格式",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:{"yne-selection-change":"_onSelectionChange","yne-editing-state-change":"_onEditingStateChange"},_onEditingStateChange:function(a){var b=this;b.$el.hasClass("disabled")||(a&&null!==a.cellEditViewRangeCollapsed?b.setState(!1===a.cellEditViewRangeCollapsed):b.setState(!0))},_onSelectionChange:function(){var a=this;a.$el.hasClass("disabled")||a.setState(!0)},onClick:function(){var a,b=this;if(!(a=b.editor.getNoteRange())||a.isCollapsed())return void b.editor.resetEditingInlineStates();b.editor.execCommandByToolbar("comp.RemoveFormat"),b.editor.trigger("yne-user-action-collection","tab-body-"+b.name+"-click")}})}(),yne_pc_toolbar_other_SaveAndSync=function(a){return yne_pc_toolbar_BaseButton.extend({name:"save-and-sync",label:"保存并同步",text:"保存并同步",defaultState:!1,state:!1,onClick:function(){this.editor.trigger("yne-save-and-sync")},rotateSyncIcon:function(a){this.$el.find(".button-save-and-sync").toggleClass("rotating",a),this.editor.trigger("yne-user-action-collection","tab-body-"+this.name+"-click")}})}(),yne_pc_toolbar_other_SnapScreen=function(a){var b=yne_pc_toolbar_block_BaseBlockComboBox,c=yne_common_jst,d=yne_underscore,e=yne_jquery;return b.extend({name:"snap-screen",text:"截图",label:"截图",defaultValue:"snap",items:{snap:"截图","snap-x":"截图并隐藏当前窗口"},templateName:"toolbar-combo-box-align",editorEvents:{"yne-editing-state-change":"onEditingStateChange"},render:function(){var a,b=this,d=b.$el;d.addClass("combo-box-"+b.name),a=c.render("pc",b.templateName,{name:b.name,label:b.label,defaultValue:b.defaultValue,text:b.items[b.defaultValue],items:b.items}),d.html(a),b.valueWrapperEl=d.find(".combo-value-wrapper")[0],b.expandWrapperEl=d.find(".combo-expand-wrapper")[0],b.menuWrapperEl=d.find(".combo-menu-wrapper")[0],d.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]})},updateValueUI:function(a){var b=this,c=e(b.valueWrapperEl),f=c.find(".combo-value"),g=b.items[a];f.removeClass(d.keys(b.items).join(" ")).addClass(a),c.find(".combo-text").text(g),b.$el.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,content:g,delay:[800,300]})},onValueWrapperElClick:function(){var a=this,b=a.value;a.hideMenu(),a.select(b),a._snapScreen()},onItemClick:function(a){var b=this,c=e(a).data("value");c&&c!==b.value&&b.select(c),b._snapScreen()},onChange:function(){},_snapScreen:function(){var a=this;a.editor.trigger("yne-snap-screen",a.value)},reset:function(){var a=this;a.hideMenu(),a.value=a.defaultValue,a.updateValueUI(a.value)},onEditingStateChange:function(){}})}(),yne_pc_toolbar_other_Undo=function(a){return yne_pc_toolbar_BaseButton.extend({name:"undo",label:"撤销",defaultState:!1,state:!1,templateName:"toolbar-button-template",editorEvents:{"command-exec":"_onHistoryChange","undo-stack-change":"_onHistoryChange","cell-edit-view-exit":"_onHistoryChange","cell-edit-view-enter":"_onCellEditViewHistoryChange","cell-edit-view-history-change":"_onCellEditViewHistoryChange"},_onHistoryChange:function(){var a=this;a.setState(a.editor.canUndo())},_onCellEditViewHistoryChange:function(a){this.setState(a.canUndo)},onClick:function(){var a=this;!0===a.state&&(a.editor.execCommandByToolbar("undo"),a.editor.trigger("yne-user-action-collection","tab-body-"+a.name+"-click"))},reset:function(){this.setState(!1)}})}(),yne_pc_toolbar_other_showMore=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst;return b.View.extend({className:"toolbar-item toolbar-combo-box toolbar-combo-more",name:"showmore",label:"查看更多",templateName:"toolbar-combo-box-show-more",events:{"click .combo-value-wrapper-showmore":"onValueWrapperClick",mousedown:"onMouseDown"},initialize:function(a){var b=this;b.editor=a.editor,b.items=a.items,b.render(),b.bindDocumentEvents()},render:function(){var a,b=this,c=b.$el;a=e.render("pc",b.templateName,{name:b.name,label:b.label}),c.html(a),b.menuWrapperEl=c.find(".combo-menu-wrapper")[0],b.menuItemContainer=c.find(".combo-menu")[0],b.$split=c.find(".toolbar-more-split"),c.find(".combo-display-wrapper").tooltipster({animation:"",animationDuration:0,theme:["tooltipster-borderless","tooltipster-borderless-customized"],side:"bottom",delay:[800,300]})},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},onDocumentMouseDown:function(a){var b=this,c=a.target;d.contains(b.el,c)||b.hideMenu()},onMouseDown:function(a){a.preventDefault()},onValueWrapperClick:function(){this.toggleMenu()},toggleMenu:function(){d(this.menuWrapperEl).toggleClass("show")},showMenu:function(){var a=this,b=a.menuWrapperEl;d(b).addClass("show")},hideMenu:function(){var a=this,b=a.menuWrapperEl;d(b).removeClass("show")},resetMenu:function(){var a,b=this,e=b.items,f=d(b.menuItemContainer);c.map(e,function(a){f.append(a.$el)}),f.children().length>0?(a=b.$el.prev(),a.is(".toolbar-split")?a.hide():a.show(),b.$el.show()):b.$el.hide()},enable:function(){this.$el.removeClass("disabled")},disable:function(){this.$el.addClass("disabled")},reset:function(){this.hideMenu()}})}(),yne_pc_toolbar_other_Zoom=function(a){var b=yne_pc_toolbar_BaseComboBox,c=yne_jtk_core_L,d=yne_jquery;return b.extend({name:"zoom",label:"缩放",defaultValue:100,items:{100:"100%",125:"125%",150:"150%",175:"175%",200:"200%",225:"225%",250:"250%",275:"275%",300:"300%"},templateName:"toolbar-combo-box-zoom",editorEvents:{"yne-editing-zoom-change":"onEditingZoomChange"},getUnlistedText:function(a){var b=this,c=parseInt(a,10);return c&&!isNaN(c)?c+"%":b.defaultValue+"%"},onChange:function(a){var b=this;c.log("selected item is ",a),b.editor.zoomEditor(a/100)},onEditingZoomChange:function(a){this.select(100*a)},reset:function(){var a,b=this;b.hideMenu(),a=b.editor.getCurrentZoomValue(),b.select(100*a)},updateValueUI:function(a){var b=this,e=d(b.valueWrapperEl).find(".combo-value")[0];b.items[a]?d(e).text(b.items[a]):(c.warn("unexpected zoom value:",a),d(e).text(b.getUnlistedText(a)||""))}})}(),yne_common_util_typeConverter=function(a){var b=yne_underscore,c=yne_common_constants;return{parseToBoolean:function(a,c){var d=null;return b.isBoolean(a)?d=a:b.isNumber(a)?0===a?d=!1:1===a&&(d=!0):b.isString(a)&&("0"===a.toLowerCase()||"false"===a.toLowerCase()?d=!1:"1"!==a.toLowerCase()&&"true"!==a.toLowerCase()||(d=!0)),null===d&&b.isBoolean(c)&&(d=c),d},parseToNumber:function(a,c){var d=null;return b.isNumber(a)?d=a:b.isString(a)&&(d=window.parseInt(a)),(isNaN(d)||null===d)&&b.isNumber(c)&&(d=c),d},parseToPageType:function(a){var b=c.PAGE_TYPE_NONE;return a&&(a.trim().toUpperCase()===c.PAGE_TYPE_B5?b=c.PAGE_TYPE_B5:a.trim().toUpperCase()===c.PAGE_TYPE_A4?b=c.PAGE_TYPE_A4:a.trim().toUpperCase()===c.PAGE_TYPE_TEST&&(b=c.PAGE_TYPE_TEST)),b}}}(),yne_pc_toolbar_other_SetBackground=function(a){var b=yne_pc_toolbar_BaseComboBox,c=yne_jquery,d=yne_underscore,e=yne_common_constants,f=yne_jtk_core_L,g=yne_common_util_typeConverter;return b.extend({name:"set-background",defaultValue:e.DEFAULT_BACKGROUND,label:"笔记背景",items:{},templateName:"toolbar-combo-box-set-background",editorEvents:{"set-all-backgrounds":"onAllBackgroundsSet","set-background":"onBackgroundChanged","yne-background-changed":"onBackgroundChanged"},_isAllBackgroundsReady:!1,_isVIPUser:!1,_normalBackground:null,_vipBackground:null,_CSS_SHADOW:"0px 0px 0px 1.5px #4C98EF",enable:function(){this._updateEnableState()},disable:function(){this._updateEnableState()},render:function(){var a=this;d.isEmpty(a.items)&&a._isAllBackgroundsReady&&(a.items={normalUser:a._normalBackground,VIP:a._vipBackground}),b.prototype.render.apply(a)},onAllBackgroundsSet:function(a,b){var c,e=this,f=0,h=0,i={};e._isVIPUser=!!b,e._normalBackground=[],e._vipBackground=[],i.URI=e.defaultValue,i.isForVIP="false",c=JSON.parse(a),c.unshift(i),d.each(c,function(a){g.parseToBoolean(a.isForVIP,!1)?(e._vipBackground[h]||(e._vipBackground[h]=[]),e._vipBackground[h].push(a.URI),3===e._vipBackground[h].length&&h++):(e._normalBackground[f]||(e._normalBackground[f]=[]),e._normalBackground[f].push(a.URI),3===e._normalBackground[f].length&&f++)}),e.items={},e._isAllBackgroundsReady=!0,e.render(),e.show()},onBackgroundChanged:function(a,b){var e,g,h,i=this,j=[b,i.defaultValue];i._resetAllSelection(),d.some(j,function(a){return g=i.$el.find('[data-value="'+a+'"]'),0!==g.length&&(e=a,!0)}),c(g[0]).css("box-shadow",i._CSS_SHADOW),h=c(g[0]).find(".background-cell-check-mark"),c(h).css("visibility","visible"),i.value=e,e!==b&&(f.error("failed to find specified URI:",b),i.editor.trigger("background-failed-update",1,e))},onChange:function(a){this.editor.updateBackground(a)},onItemClick:function(a){var d=this,e=c(a).data("value");if(d.editor.trigger("yne-is-vip-user",function(a){null!==a&&(d._isVIPUser=!!a)}),!d._isVIPUser&&d._isVIPBackground(e))return void d.editor.trigger("background-failed-update",0);b.prototype.onItemClick.apply(d,[a])},show:function(){var a=this,b=!1;return a._isAllBackgroundsReady?(b=!0,a.$el.show(),a._updateEnableState()):a.$el.hide(),b},reset:function(){var a=this;a.value=null,a.$el.find(".background-cell").css("box-shadow",""),a.$el.find(".background-cell-check-mark").css("visibility","hidden"),a._updateEnableState()},_isBackgroundDisabled:function(){return(this.editor.getEditorProps()||{}).disableBackground},_isVIPBackground:function(a){var b=this,c=!0;return d.some(b._normalBackground,function(b){if(d.contains(b,a))return c=!1,!0}),c},_resetAllSelection:function(){var a=this;a.$el.find(".background-cell-check-mark").css("visibility","hidden"),a.$el.find(".background-cell").css("box-shadow","")},_updateEnableState:function(){var a=this;a._isBackgroundDisabled()?b.prototype.disable.apply(a):b.prototype.enable.apply(a)}})}(),yne_pc_toolbar_textButton_Edit=function(a){var b=yne_pc_toolbar_TextButton;return b.extend({name:"edit",text:"编辑"})}(),yne_pc_toolbar_textButton_Insert=function(a){var b=yne_pc_toolbar_TextButton;return b.extend({name:"insert",text:"插入"})}(),yne_pc_toolbar_textButton_More=function(a){var b=yne_pc_toolbar_TextButton;return b.extend({name:"more",text:"更多"})}(),yne_pc_toolbar_textButton_View=function(a){var b=yne_pc_toolbar_TextButton;return b.extend({name:"view",text:"视图"})}(),yne_pc_toolbar_textButton_Export=function(a){var b=yne_pc_toolbar_TextButton;return b.extend({name:"export",text:"导出"})}(),yne_pc_toolbar_table_Justify=function(a){var b=yne_pc_toolbar_block_BaseBlockComboBox,c=yne_underscore,d=yne_jquery;return b.extend({name:"table-justify",label:"垂直对齐",defaultValue:"middle",isVisible:!1,items:{top:"顶端对齐",middle:"水平居中",bottom:"底端对齐"},templateName:"toolbar-combo-box-align",updateValueUI:function(a){var b=this,e=d(b.valueWrapperEl).find(".combo-value")[0];d(e).removeClass(c.keys(b.items).join(" ")),d(e).addClass(a)},onEditingStateChange:function(){this.enable()},onChange:function(a){var b=this,c=b.editor;a&&c.execCommandByToolbar("comp.SetTableCellBlockStyle",{styles:{verticalAlign:a}})},onSelectionChange:function(){var a,b=this;a=b.editor.querySelectionBlockStyle("verticalAlign"),b.items[a]?b.select(a):b.select(b.defaultValue)}})}(),yne_pc_toolbar_table_Wrap=function(a){return yne_pc_toolbar_BaseButton.extend({name:"table-wrap",label:"自动换行",defaultState:!1,isVisible:!1,templateName:"toolbar-button-template",onEditingStateChange:function(){var a,b=this;a=b.editor.querySelectionBlockStyle("wrap"),b.setState(a||!1)},onClick:function(){this.editor.execCommandByToolbar("comp.SetTableCellBlockStyle",{toggle:"wrap"})}})}(),yne_pc_toolbar_table_OperateTable=function(a){var b=yne_pc_toolbar_block_BaseBlockComboBox,c=yne_common_util_direction,d=yne_underscore,e=yne_jquery;return b.extend({name:"table-operate",label:"操作表格",defaultValue:"",isVisible:!1,items:{insertRowUp:"在上方插入行",insertRowDown:"在下方插入行",deleteRow:"删除整行",insertColLeft:"在左侧插入列",insertColRight:"在右侧插入列",deleteCol:"删除整列",deleteTable:"删除整个表格"},templateName:"toolbar-combo-box-align",updateValueUI:function(a){var b=this,c=e(b.valueWrapperEl).find(".combo-value")[0];e(c).removeClass(d.keys(b.items).join(" ")),e(c).addClass(a)},onChange:function(a){var b,d,e=this,f=e.editor;a&&("insertRowUp"===a&&(b=c.UP),"insertRowDown"===a&&(b=c.DOWN),"insertColLeft"===a&&(d=c.LEFT),"insertColRight"===a&&(d=c.RIGHT),b&&f.execCommandByToolbar("comp.InsertTableRowCol",{describe:{row:b}}),d&&f.execCommandByToolbar("comp.InsertTableRowCol",{describe:{col:d}}),"deleteRow"===a&&f.execCommandByToolbar("comp.DeleteTableRowCol",{describe:{row:!0}}),"deleteCol"===a&&f.execCommandByToolbar("comp.DeleteTableRowCol",{describe:{col:!0}}),"deleteTable"===a&&f.execCommandByToolbar("comp.DeleteNoteRange",{isTableDelete:!0}),e.value="")}})}(),yne_pc_toolbar_table_TableSplit=function(a){var b=yne_underscore;return yne_pc_toolbar_BaseSplit.extend({name:"table-split",isVisible:!1,initialize:function(a){this.editor=a.editor,this.bindEditorEvents(),this.isVisible||this.hide()},editorEvents:{"yne-selection-change":"onSelectionChange"},bindEditorEvents:function(){var a=this,c=a.editor,d=a.editorEvents;d&&b.each(d,function(b,d){c.on(d,a[b].bind(a))})}})}(),yne_pc_toolbar_table_MergeCell=function(a){return yne_pc_toolbar_BaseButton.extend({name:"table-merge",label:"合并单元格",defaultState:!1,isVisible:!1,templateName:"toolbar-button-template",onClick:function(){this.editor.execCommandByToolbar("comp.ToggleMergeTableCell")}})}(),yne_pc_toolbar_other_NotTableSplit=function(a){var b=yne_underscore;return yne_pc_toolbar_BaseSplit.extend({name:"no-table-split",isVisible:!1,initialize:function(a){this.editor=a.editor,this.bindEditorEvents(),this.isVisible||this.hide()},editorEvents:{"yne-selection-change":"onSelectionChange"},bindEditorEvents:function(){var a=this,c=a.editor,d=a.editorEvents;d&&b.each(d,function(b,d){c.on(d,a[b].bind(a))})}})}(),yne_pc_toolbar_buttonClassMap=function(a){var b=yne_jtk_core_L,c=yne_underscore,d=yne_underscorestring,e={_map:{},add:function(a){var c=this,d=a.prototype.name,e=c._map;return d?e[d]?void b.error("Button class ["+d+"] exists!"):void(e[d]=a):void b.error("The Button class has no name!",a)},get:function(a){d.startsWith(a,"---")&&(a="base-split");var c=this,e=c._map,f=e[a];return f||b.error("Button class ["+a+"] does not exist!"),f},getAllNames:function(){var a=this;return c.keys(a._map)}};return c.each([yne_pc_toolbar_BaseSplit,yne_pc_toolbar_FullScreenButton,yne_pc_toolbar_ToggleTabButton,yne_pc_toolbar_ToggleAllItems,yne_pc_toolbar_block_Align,yne_pc_toolbar_block_Indent,yne_pc_toolbar_block_LineHeight,yne_pc_toolbar_block_OrderedList,yne_pc_toolbar_block_Outdent,yne_pc_toolbar_block_UnorderedList,yne_pc_toolbar_inline_BackColor,yne_pc_toolbar_inline_Bold,yne_pc_toolbar_inline_Color,yne_pc_toolbar_inline_FontFamily,yne_pc_toolbar_inline_FontSize,yne_pc_toolbar_inline_Italic,yne_pc_toolbar_inline_Strike,yne_pc_toolbar_inline_Underline,yne_pc_toolbar_insert_InsertAttachment,yne_pc_toolbar_insert_InsertHorizontalRule,yne_pc_toolbar_insert_InsertImage,yne_pc_toolbar_insert_InsertLink,yne_pc_toolbar_insert_InsertTable,yne_pc_toolbar_insert_InsertHeading,yne_pc_toolbar_insert_InsertCatalogue,yne_pc_toolbar_insert_InsertTodo,yne_pc_toolbar_other_ExportPdf,yne_pc_toolbar_other_ExportWord,yne_pc_toolbar_other_DownloadOriginFile,yne_pc_toolbar_other_FormatPainter,yne_pc_toolbar_other_PageMode,yne_pc_toolbar_other_Redo,yne_pc_toolbar_other_RemoveFormat,yne_pc_toolbar_other_SaveAndSync,yne_pc_toolbar_other_SnapScreen,yne_pc_toolbar_other_Undo,yne_pc_toolbar_other_showMore,yne_pc_toolbar_other_Zoom,yne_pc_toolbar_other_SetBackground,yne_pc_toolbar_textButton_Edit,yne_pc_toolbar_textButton_Insert,yne_pc_toolbar_textButton_More,yne_pc_toolbar_textButton_View,yne_pc_toolbar_textButton_Export,yne_pc_toolbar_table_Justify,yne_pc_toolbar_table_Wrap,yne_pc_toolbar_table_OperateTable,yne_pc_toolbar_table_TableSplit,yne_pc_toolbar_table_MergeCell,yne_pc_toolbar_other_NotTableSplit],function(a){e.add(a)}),e}(),yne_pc_toolbar_ToolPanel=function(a){var b=yne_pc_toolbar_Panel,c=yne_pc_toolbar_buttonClassMap,d=yne_underscore,e=yne_jquery;return b.extend({className:"tool-panel",buttonConfig:[],initialize:function(a){var c=this;c._editor=a.editor,b.prototype.initialize.apply(c,arguments),c._shrinkOffset=a.shrinkOffset,c._addButtons(),c.hide(),c.render(),c._bindEvents()},_bindEvents:function(){var a=this,b=a._items;e(window).on("resize",d.throttle(function(){a.isRendered&&a._reShrink()},100)),d.each(b,function(b){b.on("re-shrink",d.throttle(a._reShrink.bind(a),100))})},_getShrinkOffset:function(){var a=this;return d.isFunction(a._shrinkOffset)?a._shrinkOffset():a._shrinkOffset},_reShrink:function(){var a=this,b=a._items,c=a.$el;d.each(b,function(a){c.append(a.$el)}),a._shrink()},_shrink:function(){var a,b=this,c=b._items,e=b.$el.parent(),f=e.width()+b._getShrinkOffset(),g=d.last(c).$el,h=g.outerWidth(!0),i=h,j=[];return d.each(c,function(b,d){if(a=b.isVisible,d===c.length-1)return void("showmore"===b.name&&(b.items=j,b.resetMenu()));a&&(i+=b.$el.outerWidth(!0)),f<i&&j.push(b)}),j},_addButtons:function(a){var b,e,f=this;b=d.map(f.buttonConfig,function(a){return new(c.get(a))({editor:f._editor})}),!1!==a&&f._editor.isLegacyHost()&&(e=c.get("showmore"),b.push(new e({editor:f._editor,items:[]}))),f.addItems(b)},show:function(){var a=this;b.prototype.show.apply(a,arguments),a._reShrink()}})}(),yne_pc_toolbar_TabHead=function(a){var b=yne_pc_toolbar_ToolPanel,c=yne_underscore,d=yne_jquery,e=yne_common_util_events,f=["edit","insert","view","export","full-screen","save-and-sync"];return b.extend({className:"bulb-tab-head",buttonConfig:f,initialize:function(a){var c=this;b.prototype.initialize.apply(c,arguments),d(a.parentEl).append(c.$el),c.show()},_bindEvents:function(){var a=this,b=a._getTextButtons(),d=a._getFullScreenButton();c.each(b,function(b){b.bind("on-click",function(){var b=this;a.trigger("request-switch",b.name,b),a.trigger("user-action-collection","tab-head-"+b.name+"-click")})}),d&&e.bubble(["exit-full-screen"],d,a)},_shrink:function(){},_addButtons:function(){b.prototype._addButtons.call(this,!1)},_getTextButtons:function(){var a=this,b=["edit","insert","view","export"];return a._textButtonList||(a._textButtonList=[],c.each(a._items,function(c){b.indexOf(c.name)>-1&&a._textButtonList.push(c)})),a._textButtonList},_getFullScreenButton:function(){var a=this;return a._fullScreenButton||(a._fullScreenButton=a.getItemByName("full-screen")),a._fullScreenButton},_enableTextButtons:function(a){var b=this._getTextButtons();c.each(b,function(b){a?b.enable():b.disable()})},_activeTextButton:function(a){var b=this._getTextButtons();c.each(b,function(b){b.setState(b.name===a)})},switchTo:function(a){var b=this;b._enableTextButtons(!0),b._activeTextButton(a)},toggle:function(){this.$el.toggle()},enterFullScreen:function(){var a=this,b=a._getFullScreenButton();a.show(),b&&b.show()},exitFullScreen:function(){var a=this,b=a._getFullScreenButton();a.show(),b&&b.hide()},reset:function(){var a=this;a._invoke("reset"),a.switchTo("edit")}})}(),yne_pc_toolbar_buttonStateMap=function(a){var b=yne_underscore,c={ACTION_SHOW_ENABLE:1,ACTION_HIDE:2,ACTION_ENABLE:3,ACTION_DISABLE:4},d={RANGE_DEFAULT:1,RANGE_HEADER_FOOTER:2,RANGE_TABLE_CELL:3,RANGE_CATALOGUE:4,RANGE_IMAGE:5,RANGE_ATTACHMENT:6,HANDWRITE_DEFAULT:11},e={EDITOR_BUTTON_STATE_MAP:{undo:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE}],redo:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE}],"remove-format":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"format-painter":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"base-split":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE}],heading:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.HANDWRITE_DEFAULT,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"no-table-split":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE}],"font-family":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"font-size":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],bold:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],italic:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],underline:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],strike:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],color:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"back-color":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"unordered-list":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.RANGE_CATALOGUE,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"ordered-list":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.RANGE_CATALOGUE,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],todo:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.RANGE_CATALOGUE,action:c.ACTION_DISABLE},{on:d.HANDWRITE_DEFAULT,action:c.ACTION_DISABLE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],align:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE}],"table-justify":[{on:d.RANGE_DEFAULT,action:c.ACTION_HIDE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_SHOW_ENABLE}],indent:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],outdent:[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{
on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"line-height":[{on:d.RANGE_DEFAULT,action:c.ACTION_SHOW_ENABLE},{on:d.RANGE_HEADER_FOOTER,action:c.ACTION_DISABLE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_HIDE},{on:d.RANGE_IMAGE,action:c.ACTION_DISABLE},{on:d.RANGE_ATTACHMENT,action:c.ACTION_DISABLE}],"table-wrap":[{on:d.RANGE_DEFAULT,action:c.ACTION_HIDE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_SHOW_ENABLE}],"table-operate":[{on:d.RANGE_DEFAULT,action:c.ACTION_HIDE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_SHOW_ENABLE}],"table-split":[{on:d.RANGE_DEFAULT,action:c.ACTION_HIDE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_SHOW_ENABLE}],"table-merge":[{on:d.RANGE_DEFAULT,action:c.ACTION_HIDE},{on:d.RANGE_TABLE_CELL,action:c.ACTION_SHOW_ENABLE}]},NATIVE_HEADER_FOOTER_DISABLED_MAP:{attachment:!0,catalogue:!0,hr:!0,img:!0,link:!0,table:!0},NATIVE_TABLE_DISABLED_MAP:{catalogue:!0,table:!0,hr:!0},NATIVE_HANDWRITE_DISABLED_MAP:{catalogue:!0},NATIVE_CATALOGUE_DISABLED_MAP:{catalogue:!0,img:!0,attachment:!0,hr:!0,link:!0,table:!0}};return b.extend(e,c,d)}(),yne_pc_toolbar_EditPanel=function(a){var b=yne_pc_toolbar_ToolPanel,c=yne_common_data_blockTypes,d=yne_pc_toolbar_buttonClassMap,e=yne_pc_toolbar_buttonStateMap,f=yne_underscore,g=yne_jquery,h=["undo","redo","remove-format","format-painter","---","heading","no-table-split","font-family","---","font-size","bold","italic","underline","strike","---","color","back-color","no-table-split","unordered-list","ordered-list","todo","---","align","table-justify","indent","outdent","line-height","table-wrap","table-operate","table-split","table-merge"],i=b.extend({className:"tool-panel tool-panel-edit",buttonConfig:h,_morePanelName:".tool-panel-edit-more",_btnToggleAllItems:null,_$morePanel:null,_lastRangeType:null,initialize:function(){i.__super__.initialize.apply(this,arguments),this._bindEvents()},_bindEvents:function(){var a=this,b=a._editor,d=e.EDITOR_BUTTON_STATE_MAP;i.__super__._bindEvents.apply(a,arguments),b.on("yne-editing-state-change",function(){var g,h=b.getNoteRange(),i=b.hasHandWriteBlock(),j=e.RANGE_DEFAULT;h&&(g=h.getStartBlockRange().block,c.isHeaderFooter(g)?j=i?e.HANDWRITE_DEFAULT:e.RANGE_HEADER_FOOTER:c.isImage(g)?j=e.RANGE_IMAGE:c.isAttachment(g)?j=e.RANGE_ATTACHMENT:c.isCatalogue(g)?j=i?e.HANDWRITE_DEFAULT:e.RANGE_CATALOGUE:h.isSingleTableSelected()&&(j=e.RANGE_TABLE_CELL)),a._lastRangeType!==j&&(a._$morePanel.css("height",a._$morePanel.height()),a._lastRangeType=j,f.each(a._items,function(a){var b,c=d[a.name],g=e.ACTION_SHOW_ENABLE;switch(f.each(c,function(a){a.on===e.RANGE_DEFAULT&&(g=a.action),a.on===j&&(b=a.action)}),null==b&&(b=g),b){case e.ACTION_SHOW_ENABLE:a.show(),a.enable();break;case e.ACTION_HIDE:a.hide();break;case e.ACTION_ENABLE:a.enable();break;case e.ACTION_DISABLE:a.show(),a.disable()}}),a._reShrink())})},_addButtons:function(a){var b,c=this;i.__super__._addButtons.apply(c,[a]),c._editor.isLegacyHost()||(b=d.get("toggle-allItems"),this._btnToggleAllItems=new b({editor:c._editor}),c.addItems(this._btnToggleAllItems),this._btnToggleAllItems.bind("toggle-allItems",c._onToggleAllItems.bind(c)))},_shrink:function(){var a,b=this;a=i.__super__._shrink.apply(b),b._editor.isLegacyHost()||(null==b._$morePanel&&(b.$el.after('<div class="tool-panel tool-panel-edit-more"></div>'),b._$morePanel=g(b._morePanelName),b._$morePanel.hide()),0===a.length?(b._$morePanel.slideUp(500,function(){b._editor.updateNoteViewWrapperSize()}),b._btnToggleAllItems.hide()):(b._$morePanel.empty(),f.each(a,function(a){b._$morePanel.append(a.$el)}),b._btnToggleAllItems.show()),b._onToggleAllItems())},_onToggleAllItems:function(){var a=this;null!=a._$morePanel&&null!=a._btnToggleAllItems&&(a._btnToggleAllItems.isCollapsed()||!1===a._btnToggleAllItems.isVisible?a._$morePanel.slideUp(500,function(){a._editor.updateNoteViewWrapperSize()}):(a._$morePanel.css("height","auto"),a._$morePanel.slideDown(250,function(){a._editor.updateNoteViewWrapperSize()})))}});return i}(),yne_pc_toolbar_InsertPanel=function(a){var b=yne_pc_toolbar_ToolPanel,c=["undo","redo","img","attachment","table","hr","link","catalogue","snap-screen"];return b.extend({className:"tool-panel tool-panel-insert",buttonConfig:c})}(),yne_pc_toolbar_MorePanel=function(a){var b=yne_pc_toolbar_ToolPanel,c=["undo","redo","zoom","view-mode","export-pdf","set-background"];return b.extend({className:"tool-panel tool-panel-more",buttonConfig:c})}(),yne_pc_toolbar_ViewPanel=function(a){var b=yne_pc_toolbar_ToolPanel,c=["undo","redo","view-mode","zoom","set-background"];return b.extend({className:"tool-panel tool-panel-view",buttonConfig:c})}(),yne_pc_toolbar_ExportPanel=function(a){var b=yne_pc_toolbar_ToolPanel,c=["undo","redo","export-pdf","export-word","download-file"];return b.extend({className:"tool-panel tool-panel-export",buttonConfig:c})}(),yne_pc_toolbar_TabBody=function(a){var b=yne_pc_toolbar_Panel,c=yne_pc_toolbar_buttonClassMap,d=c.get("toggle-tab"),e=yne_pc_toolbar_EditPanel,f=yne_pc_toolbar_InsertPanel,g=yne_pc_toolbar_MorePanel,h=yne_pc_toolbar_ViewPanel,i=yne_pc_toolbar_ExportPanel,j=yne_underscore,k=yne_jquery,l=yne_common_util_typeConverter;return b.extend({className:"bulb-tab-body",initialize:function(a){var b,c=this;c._editor=a.editor,c._parentEl=a.parentEl,c.isRendered=!1,c._toggleTabButton=null,c._current=null,b={editor:a.editor,shrinkOffset:c.shrinkOffsetForPanel.bind(c)},c._toolPanels={edit:new e(b)},c._editor.isLegacyHost()&&(c._toolPanels.insert=new f(b),c._toolPanels.view=new h(b),c._toolPanels.export=new i(b),c._toolPanels.more=new g(b)),c.render(),c.switchTo("edit")},shrinkOffsetForPanel:function(){var a=this;return a._toggleTabButton?0-a._toggleTabButton.$el.outerWidth(!0):0},render:function(){var a=this;a.isRendered||(a.isRendered=!0,k(a._parentEl).append(a.$el),a._editor.isLegacyHost()&&(a._toggleTabButton=new d({editor:a._editor}),a.$el.append(a._toggleTabButton.$el),a._toggleTabButton.on("toggle-tab",function(){a.trigger("toggle-tab")})),j.each(a._toolPanels,function(b,c){if(!b)throw"No panel objecet for "+c;a.$el.append(b.$el)}))},switchTo:function(a){var b=this,c=b._toolPanels;b._current!==a&&c[a]&&j.each(c,function(c,d){d===a?(c.show(),b._current=a):c.hide()})},_setEnable:function(a){var b=this;j.each(b._toolPanels,function(b){b&&(a&&b.enable?b.enable():!a&&b.disable&&b.disable())})},enable:function(){this._setEnable(!0)},disable:function(){this._setEnable(!1)},reset:function(){var a=this;j.each(a._toolPanels,function(a){a.reset()}),a._current=null,a.switchTo("edit")},enterFullScreen:function(){var a=this;a._toggleTabButton&&a._toggleTabButton.hide()},exitFullScreen:function(){var a=this;a._toggleTabButton&&a._toggleTabButton.show()},getCurrentTabName:function(){return this._current},toggle:function(a){var b=this;null!=a?(a=l.parseToBoolean(a,!0),b.$el.toggle(a)):b.$el.toggle()}})}(),yne_pc_toolbar_BigToolbar=function(a){var b=yne_pc_toolbar_Panel,c=yne_underscore,d=yne_jquery,e=yne_pc_toolbar_TabHead,f=yne_pc_toolbar_TabBody;return b.extend({className:"bulb-big-toolbar",_tabHead:null,_tabBody:null,initialize:function(a){var b=this;b._editor=a.editor,b._parentEl=a.parentEl,b.render(),b._editor.isLegacyHost()&&(b._tabHead=new e({editor:a.editor,parentEl:b.el})),b._tabBody=new f({editor:a.editor,parentEl:b.el}),b._bindEvents()},_bindEvents:function(){var a=this;c.bindAll(a,"_onRequestSwitch","_onExitFullScreen","_onToggleTab"),a._editor.isLegacyHost()&&(a._tabHead.bind("request-switch",a._onRequestSwitch),a._tabHead.bind("exit-full-screen",a._onExitFullScreen),a._tabHead.bind("user-action-collection",a._onUserActionCollection),a._tabBody.bind("toggle-tab",a._onToggleTab))},_canSwitchTab:function(){return!0},_onRequestSwitch:function(a){this.switchTo(a)},_onExitFullScreen:function(){this._editor.trigger("yne-exit-full-screen")},_onUserActionCollection:function(a){this._editor.trigger("yne-user-action-collection",a)},_onToggleTab:function(){var a=this;a._tabHead.toggle(),a.trigger("resize"),"none"===a._tabHead.$el.css("display")?a.trigger("tab-toggled",!1):a.trigger("tab-toggled",!0)},switchTo:function(a){var b=this;b._canSwitchTab()&&(b._tabHead&&b._tabHead.switchTo(a),b._tabBody.switchTo(a))},render:function(){var a=this;a.isRendered||(a.isRendered=!0,d(a._parentEl).append(a.$el))},enable:function(){var a=this;a.$el.removeClass("disabled"),a._tabHead&&a._tabHead.enable(),a._tabBody.enable()},disable:function(){var a=this;a.$el.removeClass("disabled"),a._tabHead&&a._tabHead.disable(),a._tabBody.disable()},reset:function(){var a=this;a._tabHead&&a._tabHead.reset(),a._tabBody.reset(),a.enable()},enterFullScreen:function(){var a=this;a._tabHead&&a._tabHead.enterFullScreen(),a._tabBody.enterFullScreen(),a.trigger("resize")},exitFullScreen:function(){var a=this;a._tabHead&&a._tabHead.exitFullScreen(),a._tabBody.exitFullScreen(),a.trigger("resize")},showSaveSyncButton:function(a){var b,c=this;if(c._tabHead){if(!(b=c._tabHead.getItemByName("save-and-sync")))return;a?b.show():b.hide()}},rotateSaveSyncIcon:function(a){var b,c=this;c._tabHead&&(b=c._tabHead.getItemByName("save-and-sync"))&&b.rotateSyncIcon(a)},toggleToolbar:function(a){var b=this;b._tabBody&&b._tabBody.toggle(a)},getCurrentTabName:function(){var a=this,b=a._tabBody;if(b&&b.getCurrentTabName)return b.getCurrentTabName()}})}(),yne_common_contextMenu_ContextMenuItem=function(a){var b=yne_underscore,c=yne_jtk_core_Class,d=yne_common_constants,e=yne_jtk_core_L,f={ITEM:0,SUBMENU:1,SPLIT:2},g=d.IS_MAC?"meta":"ctrl";return c.extend({index:-1,editor:null,initialize:function(a){var c=this,d=function(){e.error("The queryAction() of "+c.name+" should be implemented by options!")},g=function(){e.error("The selectAction() of "+c.name+" should be implemented by options!")};b.defaults(c,a,{name:null,label:null,type:f.ITEM,queryAction:d,selectAction:g,isDefault:!1,isDisabled:!1,isHidden:!1,key:"",keyHandlerName:"",items:null})},reset:function(){this._resetStatus()},_resetStatus:function(){var a=this;a.isDefault=!1,a.isDisabled=!1,a.isHidden=!1},checkStatus:function(a,c){var d=this;d._resetStatus(),!1===d.queryAction(a,c)&&(d.isDisabled=d.isHidden=!0),d.isHidden||d.type===f.SUBMENU&&(b.invoke(d.items,"checkStatus",a,c),d.isDisabled=0===d.items.filter(function(a){return!a.isHidden&&!a.isDisabled}).length)},_getKey:function(){var a=this,c=a.key||"",f={meta:"⌘",ctrl:"⌃",alt:"⌥",shift:"⇧"},h=a.editor.controller.keyHandlerManager;return a.keyHandlerName&&h&&(c=h.getKey(a.keyHandlerName)),c?(c=c.replace(/[\s\uFEFF\xA0]/g,""))?(c=c.toLowerCase(),c=c.replace(/mod/,g),d.IS_MAC&&b.each(f,function(a,b){c=c.replace(b,a)}),c=c.replace(/^([a-z])/g,function(a,b){return b.toUpperCase()}),c=c.replace(/\+([a-z])/g,function(a,b){return"+"+b.toUpperCase()})):"":(e.warn("no key for ContextMenuItem: "+a.name),"")},select:function(){this.onSelected()},onSelected:function(){var a=this;if(a.keyHandlerName)return void a.editor.controller.execKeyHandler(a.keyHandlerName);a.selectAction()},simplify:function(){var a=this,c=a.items,d={index:a.index,type:a.type,isDisabled:a.isDisabled,isHidden:a.isHidden,isDefault:a.isDefault,label:a.label,key:a._getKey()};return c&&c.length&&(d.items=b.map(a.items,function(a){if(a&&a.simplify)return a.simplify()})),d}},{TYPE:f})}(),yne_common_contextMenu_ContextMenu=function(a){var b=yne_underscore,c=yne_jtk_core_Class,d=yne_jtk_core_L,e=yne_common_contextMenu_ContextMenuItem,f=c.extend({initialize:function(){var a=this,b=a.options;a.editor=b.editor,a.items=[],a.indexArray=[]},addItems:function(a){var c=this;c.items=c.items.concat(a),b.each(a,c.prepareItem.bind(c))},prepareItem:function(a){var c=this,f=c.editor,g=a.keyHandlerName;a.index=c.indexArray.length,a.editor=f,g&&!f.controller.hasKeyHandler(g)&&d.error("The keyHandlerName ["+g+"] of ContextMenuItem ["+a.name+"] does not exist!"),c.indexArray.push(a),a.type===e.TYPE.SUBMENU&&b.each(a.items,c.prepareItem.bind(c))},select:function(a){var b=this,c=b.indexArray[a];if(c&&!c.items&&c.select)return c.select()},resetAll:function(){var a,c=this;b.map(c.items,function(c){if((a=c.reset)&&b.isFunction(a))return a.apply(c)})},onContextMenu:function(a,c){var d,e=this,g=e.editor,h={top:a.pageY,left:a.pageX};e.resetAll(),b.invoke(e.items,"checkStatus",a,c||{}),d=f.filterItems(e.items),g.trigger("yne-context-menu",h,d,function(a){e.select(a),e.resetAll()})}},{filterItems:function(a){var c=!1,d=[];return b.each(a,function(a){var g;switch(a&&a.simplify&&(a=a.simplify()),a.type){case e.TYPE.SPLIT:c||(c=!0,d.push(a));break;case e.TYPE.SUBMENU:a.isHidden||(c=!1,g=b.extend({},a,{items:f.filterItems(a.items)}),d.push(g));break;default:a.isHidden||(c=!1,d.push(a))}}),d}});return f}(),yne_common_contextMenu_split=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_jtk_core_fn_noop,d=new b({name:"split",label:"---",queryAction:c,selectAction:c,type:b.TYPE.SPLIT});return function(){return d}}(),yne_pc_contextMenu_undo=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"undo",label:"撤销",keyHandlerName:"undo",queryAction:function(){var a=this,b=a.editor;a.isDisabled=!b.canUndo()}})}}(),yne_pc_contextMenu_redo=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"redo",label:"重做",keyHandlerName:"redo",queryAction:function(){var a=this,b=a.editor;a.isDisabled=!b.canRedo()}})}}(),yne_pc_contextMenu_removeNoteLink=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_noteLink;return function(){return new b({name:"removeNoteLink",label:"清除引用链接",queryAction:function(a,b){var d=this,e=b.hrefInfo;if(d._hrefInfo=null,!e||!c.isNoteLinkUrl(e.href))return!1;d._hrefInfo=e},selectAction:function(){var a=this;a._hrefInfo&&(a.editor.execCommand("comp.ApplyStyles",{range:a._hrefInfo.noteRange,inlineStyles:{href:"",color:"#393939",underline:!1}}),a._hrefInfo=null)}})}}(),yne_common_contextMenu_cut=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_platform;return function(){return new b({name:"cut",label:"剪切",key:"mod+x",queryAction:function(a,b){var c=this,d=a.target,e=d.ownerDocument;if(b.isRangeCollapsed)return void(c.isDisabled=!0);c._targetEl=d,c._doc=e},selectAction:function(){var a,b,d,e,f,g,h=this,i=h._doc,j=h.editor,k=h._targetEl;if(a=j.getNoteRange(),c.IS_MAC){if(!a||a.isCollapsed())return;return j.callMacNativeApi("menuCopy"),void j.execCommand("comp.DeleteNoteRange",{range:a})}a.isSingleTableSelected()&&(b=a.getStartBlockRange(),d=b.block,e=j.controller.noteView,f=e.getBlockViewByBlock(d),k=f.getHiddenInputView()),k.focus();try{g=i.execCommand("cut")}catch(a){g=!1}g||j.trigger("yne-clipboard-error","cut",function(){j.focus()})},reset:function(){this._doc=null,this._targetEl=null}})}}(),yne_common_contextMenu_copy=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_platform;return function(){return new b({name:"copy",label:"复制",key:"mod+c",queryAction:function(a,b){var c=this,d=a.target,e=d.ownerDocument;if(b.isRangeCollapsed)return void(c.isDisabled=!0);c._targetEl=d,c._doc=e},selectAction:function(){var a,b,d,e,f,g,h=this,i=h._doc,j=h.editor,k=h._targetEl;if(c.IS_MAC)return void j.callMacNativeApi("menuCopy");a=j.getNoteRange(),a.isSingleTableSelected()&&(b=a.getStartBlockRange(),d=b.block,e=j.controller.noteView,f=e.getBlockViewByBlock(d),k=f.getHiddenInputView()),k.focus();try{g=i.execCommand("copy")}catch(a){g=!1}g||j.trigger("yne-clipboard-error","copy",function(){j.focus()})},reset:function(){this._doc=null,this._targetEl=null}})}}(),yne_pc_contextMenu_paste=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"paste",label:"粘贴",key:"mod+v",queryAction:function(){var a=this;a.editor.trigger("yne-clipboard-status",function(b,c){a.isDisabled=!b,a.isHidden=c})},selectAction:function(){this.editor.trigger("yne-require-paste",!1,!1)}})}}(),yne_pc_contextMenu_pasteNoteLink=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"pasteNoteLink",label:"粘贴引用链接",key:"mod+v",queryAction:function(){var a=this;a.editor.trigger("yne-clipboard-status",function(b,c){a.isDisabled=a.isHidden=!c})},selectAction:function(){this.editor.trigger("yne-require-paste",!0,!1)}})}}(),yne_pc_contextMenu_pasteAsText=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"pasteAsText",label:"纯文本粘贴",key:"mod+shift+v",queryAction:function(){var a=this,b=a.editor;a.isHidden=!1,b.trigger("yne-clipboard-status",function(b){a.isDisabled=!b})},selectAction:function(){this.editor.trigger("yne-require-paste",!1,!0)}})}}(),yne_common_contextMenu_ImageTitle=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"imageTitle",label:"标题",queryAction:function(a,b){return this._block=b.imgBlock,!!b.imgBlock},selectAction:function(){var a=this;a._block&&a._block.trigger("edit-image-title")},reset:function(){this._block=null}})}}(),yne_common_util_imgSize={_sizeCache:{},_downloadImg:function(a,b){var c=this,d=new window.Image;d.onload=function(){var e={width:d.width,height:d.height};d.onload=d.onerror=d.onabort=null,d=null,c._sizeCache[a]=e,b(e)},d.onerror=d.onabort=function(){d.onload=d.onerror=d.onabort=null,d=null,b()},d.src=a},get:function(a,b,c){var d,e=this;c||e._clearCache(a),d=e._sizeCache[a],d&&b(d),e._downloadImg(a,b)},clearCache:function(a){var b=this;a?delete b._sizeCache[a]:b._sizeCache={}}},yne_common_contextMenu_ImageZoomMenuItem=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_imgSize,d=yne_common_selection_blockRangeUtil,e=yne_common_selection_NoteRange;return b.extend({percent:null,_imgBlock:null,queryAction:function(a,b){var c=this;b&&b.imgBlock&&(c._imgBlock=b.imgBlock)},selectAction:function(){var a=this,b=a.editor,f=a._imgBlock;b&&f&&c.get(f.getSource(!0),function(c){var g,h,i,j;c&&c.width&&(g=Math.round(c.width*a.percent/100),null!=c.height&&(h=Math.round(c.height*a.percent/100)),i=d.createRangeByBlock({block:f}),j=new e({startRange:i,endRange:i}),b.execCommand("comp.ApplyStyles",{range:j,blockStyles:{width:g,height:h}})),a._imgBlock=null},!0)},initialize:function(a){var c=this;a=a||{percent:100},c.percent=a.percent,b.prototype.initialize.apply(c,[a])},_resetStatus:function(){var a=this;a._imgBlock=null,b.prototype._resetStatus.apply(a,arguments)}})}(),yne_pc_contextMenu_imageZoom=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_contextMenu_ImageZoomMenuItem,d=yne_jtk_core_fn_noop,e=yne_underscore;return function(){var a=[10,25,50,75,100,125,150,200],f=e.map(a,function(a){return new c({name:"imageZoom-"+a+"%",label:a+"%",percent:a})});return new b({name:"imageZoom",label:"图片缩放",type:b.TYPE.SUBMENU,queryAction:function(a,b){var c=this;if(!c.editor||!b||!b.imgBlock)return void(c.isHidden=c.isDisabled=!0)},selectAction:d,items:f})}}(),yne_pc_contextMenu_imageClearZoom=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_selection_blockRangeUtil,d=yne_common_selection_NoteRange;return function(){return new b({name:"imageClearZoom",label:"清除缩放",queryAction:function(a,b){var c=this;if(!c.editor||!b||!b.imgBlock)return void(c.isHidden=c.isDisabled=!0);c._imgBlock=b.imgBlock},selectAction:function(){var a,b,e=this,f=e.editor,g=e._imgBlock;f&&g&&(a=c.createRangeByBlock({block:g}),b=new d({startRange:a,endRange:a}),f.execCommand("comp.ApplyStyles",{range:b,blockStyles:{width:null}}),e._imgBlock=null)}})}}(),yne_common_contextMenu_ImageRotationMenuItem=function(a){var b,c=yne_common_contextMenu_ContextMenuItem,d=yne_common_util_platform;return b=c.extend({_direction:null,_imgBlock:null,initialize:function(a){var c=this;b.__super__.initialize.apply(c,arguments),c._direction=a.direction||0},queryAction:function(a,b){var c,e=this,f=e.editor,g=!1;f&&b&&b.imgBlock?d.IS_PC&&f.isCollabEnabled()?e.isHidden=e.isDisabled=!0:(c=b.imgBlock.getSource(!0),c&&(g=c.toLocaleLowerCase().endsWith("gif")),e.isDisabled=g,e._imgBlock=b.imgBlock):e.isHidden=e.isDisabled=!0},reset:function(){this._imgBlock=null},selectAction:function(){var a=this;a.editor.trigger("yne-rotate-image",a._imgBlock.getId(),a._imgBlock.getSource(),a._direction)}})}(),yne_pc_contextMenu_imageLeftRotation=function(a){var b=yne_common_contextMenu_ImageRotationMenuItem;return function(){return new b({name:"imageLeftRotation",label:"向左转",direction:0})}}(),yne_pc_contextMenu_imageRightRotation=function(a){var b=yne_common_contextMenu_ImageRotationMenuItem;return function(){return new b({name:"imageRightRotation",label:"向右转",direction:1})}}(),yne_common_contextMenu_AttachmentFloatMenuItem=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_selection_blockRangeUtil,d=yne_common_selection_NoteRange;return b.extend({float:"",_attachmentBlock:null,queryAction:function(a,b){var c=this;return b&&b.attachmentBlock&&(c._attachmentBlock=b.attachmentBlock),!!c._attachmentBlock},selectAction:function(){var a,b,e=this,f=e.editor,g=e._attachmentBlock,h=e.float,i=["left","right","none"];f&&g&&-1!==i.indexOf(h)&&(a=c.createRangeByBlock({block:g}),b=new d({startRange:a,endRange:a}),f.execCommand("comp.ApplyStyles",{range:b,blockStyles:{float:h}}),e._attachmentBlock=null)},initialize:function(a){var c=this;a=a||{percent:100},c.float=a.float,b.prototype.initialize.apply(c,[a])},reset:function(){var a=this;a._attachmentBlock=null,b.prototype.reset.apply(a,arguments)}})}(),yne_pc_contextMenu_attachmentFloat=function(a){var b=yne_common_contextMenu_AttachmentFloatMenuItem,c=yne_underscore;return function(){var a=["left","right","none"],d={left:"左浮动",right:"右浮动",none:"清除浮动"};return c.map(a,function(a){return new b({name:"attachmentFloat-"+a,label:d[a],float:a})})}}(),yne_common_contextMenu_selectAll=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"selectAll",label:"全选",keyHandlerName:"selectAll",queryAction:function(a,b){return!b.isImgAttachBlock&&!b.tableInfo},selectAction:function(){this.editor.selectAll()}})}}(),yne_common_contextMenu_removeFormat=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"removeFormat",label:"清除格式",queryAction:function(a,b){var c=this,d=c.editor,e=d.canRemoveFormat()&&!b.isImgAttachBlock&&!b.tableInfo;return c.isDisabled=!e,!b.tableInfo&&!b.isImgAttachBlock},selectAction:function(){this.editor.execCommand("comp.RemoveFormat")}})}}(),yne_common_contextMenu_recogOCR=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_parseImageResourceId;return function(){return new b({name:"recogOCR",label:"文本识别OCR",_imgBlock:null,queryAction:function(a,b){var c=this.editor.getNoteProps(),d=!!c.disableOCR;return this._imgBlock=b.imgBlock,!d&&null!=this._imgBlock},selectAction:function(){if(null!=this._imgBlock){var a=c(this._imgBlock);this.editor.imageOCR(a)}}})}}(),yne_pc_contextMenu_attachmentSaveAs=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_data_table_tableCellType;return function(){return new b({name:"attachmentSaveAs",label:"另存为",_fileName:null,queryAction:function(a,b){var d,e=this,f=e.editor,g=b.tableInfo;if(!(f&&b&&(b.attachmentBlock||g&&g.type===c.ATTACHMENT)))return void(e.isHidden=e.isDisabled=!0);d=g?g.cell.getContent():b.attachmentBlock,e._resource=d.getResource(),e._fileName=d.getFileName()},selectAction:function(){var a=this,b=a.editor,c=a._resource,d=a._fileName;a._resource=null,a._fileName=null,c&&b.trigger("yne-download-attachment",c,d)}})}}(),yne_pc_contextMenu_imageSaveAs=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_data_table_tableCellType;return function(){return new b({name:"imageSaveAs",label:"另存为",queryAction:function(a,b){var d,e=this,f=e.editor,g=b.tableInfo;return f&&b&&(b.imgBlock||g&&g.type===c.IMAGE)?g?(d=g.cell.getContent(),void(e._imgSrc=d.getSource(f.getExtraInfo("pcResMap")))):(d=b.imgBlock,void(e._imgSrc=d.getSource(!0))):void(e.isHidden=e.isDisabled=!0)},selectAction:function(){var a=this,b=a.editor,c=a._imgSrc;a._imgSrc=null,c&&b.trigger("yne-download-image",c)}})}}(),yne_pc_contextMenu_share=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_jtk_core_fn_noop;return function(){return new b({name:"share",label:"分享链接",queryAction:c,selectAction:function(){this.editor.trigger("yne-share-note")}})}}(),yne_pc_contextMenu_insertDate=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_data_blockTypes;return function(){return new b({name:"insertDate",label:"插入当前时间",keyHandlerName:"insertDate",queryAction:function(){var a=this,b=a.editor,d=b.getNoteRange(),e=[c.PARAGRAPH,c.LIST_ITEM,c.ATTACHMENT,c.IMAGE];d&&d.isMatchBlockTypes(b.getNote(),e)||(a.isDisabled=!0)}})}}(),yne_common_contextMenu_countWords=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"countWords",label:"统计字数",queryAction:function(a,b){return!b.isImgAttachBlock&&!b.tableInfo},selectAction:function(){var a=this,b=a.editor,c=b.countWords(!0),d=c.count,e=c.isSelected,f=c.detail;b.trigger("yne-show-words",d,e,f)}})}}(),yne_common_contextMenu_table_insertRowUp=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_direction;return function(){return new b({name:"insertRowUp",label:"在上方插入行",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.InsertTableRowCol",{range:b,describe:{row:c.UP}})}})}}(),yne_common_contextMenu_table_insertRowDown=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_direction;return function(){return new b({name:"insertRowDown",label:"在下方插入行",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.InsertTableRowCol",{range:b,describe:{row:c.DOWN}})}})}}(),yne_common_contextMenu_table_deleteRow=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"deleteCol",label:"删除整行",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.DeleteTableRowCol",{range:b,describe:{row:!0}})}})}}(),yne_common_contextMenu_table_insertColLeft=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_direction;return function(){return new b({name:"insertColLeft",label:"在左侧插入列",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.InsertTableRowCol",{range:b,describe:{col:c.LEFT}})}})}}(),yne_common_contextMenu_table_insertColRight=function(a){var b=yne_common_contextMenu_ContextMenuItem,c=yne_common_util_direction;return function(){return new b({name:"insertColRight",label:"在右侧插入列",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.InsertTableRowCol",{range:b,describe:{col:c.RIGHT}})}})}}(),yne_common_contextMenu_table_deleteCol=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"deleteCol",label:"删除整列",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.DeleteTableRowCol",{range:b,describe:{col:!0}})}})}}(),yne_common_contextMenu_table_toggleMergeCell=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"mergeCell",label:"合并单元格",queryAction:function(a,b){return!!b.tableInfo&&(b.tableInfo.onlyMergePointAndCell?(this.label="取消合并单元格",!0):!1===b.tableInfo.onlyOneCell&&(this.label="合并单元格",!0))},selectAction:function(){var a=this,b=a._range;a.editor.execCommand("comp.ToggleMergeTableCell",{range:b})}})}}(),yne_common_contextMenu_table_deleteTable=function(a){var b=yne_common_contextMenu_ContextMenuItem;return function(){return new b({name:"deleteTable",label:"删除整个表格",queryAction:function(a,b){return!!b.tableInfo},selectAction:function(){this.editor.execCommand("comp.DeleteNoteRange",{isTableDelete:!0})}})}}(),yne_pc_contextMenu_config=function(a){var b=yne_common_contextMenu_split;return[yne_pc_contextMenu_undo,yne_pc_contextMenu_redo,b,yne_pc_contextMenu_removeNoteLink,b,yne_common_contextMenu_cut,yne_common_contextMenu_copy,yne_pc_contextMenu_paste,yne_pc_contextMenu_pasteNoteLink,yne_pc_contextMenu_pasteAsText,b,yne_common_contextMenu_ImageTitle,yne_pc_contextMenu_imageZoom,yne_pc_contextMenu_imageClearZoom,yne_pc_contextMenu_imageLeftRotation,yne_pc_contextMenu_imageRightRotation,b,yne_pc_contextMenu_attachmentFloat,b,yne_common_contextMenu_selectAll,yne_common_contextMenu_removeFormat,yne_common_contextMenu_recogOCR,b,yne_pc_contextMenu_attachmentSaveAs,yne_pc_contextMenu_imageSaveAs,b,yne_pc_contextMenu_share,b,yne_pc_contextMenu_insertDate,yne_common_contextMenu_countWords,b,yne_common_contextMenu_table_insertRowUp,yne_common_contextMenu_table_insertRowDown,yne_common_contextMenu_table_deleteRow,b,yne_common_contextMenu_table_insertColLeft,yne_common_contextMenu_table_insertColRight,yne_common_contextMenu_table_deleteCol,b,yne_common_contextMenu_table_toggleMergeCell,yne_common_contextMenu_table_deleteTable]}();var __extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])};return function(b,c){function d(){this.constructor=b}a(b,c),b.prototype=null===c?Object.create(c):(d.prototype=c.prototype,new d)}}();yne_YEvent=function(a){Object.defineProperty(a,"__esModule",{value:!0});var b=function(){function a(){this._listeners=[],this._maxListeners=null}return a.prototype.addListener=function(a,b){return this.on(a,b)},a.prototype.emit=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];var d=this._filterMatchedEvent(this._listeners,a);return d.length>0&&(this._invokeListeners.apply(this,[d].concat(b)),this._listeners=this._filterNotMatchedEvent(this._listeners,a,!0)),d.length>0},a.prototype.getMaxListeners=function(){return null===this._maxListeners?a.defaultMaxListeners:this._maxListeners},a.prototype.listenerCount=function(a){return this._filterMatchedEvent(this._listeners,a).length},a.prototype.on=function(a,b){return this._register({event:a,listener:b,once:!1}),this},a.prototype.off=function(a,b){return this._unregister({event:a,listener:b}),this},a.prototype.once=function(a,b){return this._register({event:a,listener:b,once:!0}),this},a.prototype.removeAllListeners=function(a){return this._listeners=null!=a?this._filterNotMatchedEvent(this._listeners,a):[],this},a.prototype.removeListener=function(a,b){return this._listeners=this._filterNotMatchedEvent(this._listeners,a,null,b),this},a.prototype.setMaxListeners=function(a){return this._maxListeners=a,this},a.prototype._invokeListeners=function(a){for(var b=[],c=1;c<arguments.length;c++)b[c-1]=arguments[c];a.map(function(a){return a.listener.apply(a,b)})},a.prototype._register=function(a){if(!this._checkListenerLimitReached(a.event))return void this._listeners.unshift(a);throw"Listner Limit Reached:"+this._maxListeners},a.prototype._unregister=function(a){this._listeners=this._filterNotMatchedEvent(this._listeners,a.event,null,a.listener)},a.prototype._returnListenerLimit=function(){return null===this._maxListeners?a.defaultMaxListeners:this._maxListeners},a.prototype._checkListenerLimitReached=function(a){return this.listenerCount(a)===this._returnListenerLimit()},a.prototype._filterMatchedEvent=function(a,b,c){var d=function(a,d,e){return null==c?a.event===b:a.event===b&&a.once===c};return a.filter(d,this)},a.prototype._filterNotMatchedEvent=function(a,b,c,d){var e=function(a,e,f){var g=a.event!==b;return!1===g&&null!=c&&(g=a.once!==c),!1===g&&null!=d&&(g=a.listener!==d),g};return a.filter(e,this)},a.defaultMaxListeners=10,a}();return a.YEvent=b,a}(yne_YEvent),yne_DataTypes_ICollabJSON=function(a){Object.defineProperty(a,"__esModule",{value:!0});var b=function(){
function a(){}return a.SESSION_INIT_DONE="done",a.SESSION_INIT_COLLABSTARTED="collabStarted",a.SESSION_INIT_TIMEOUT="timeout",a.SESSION_INIT_INVALID="notValidForCollab",a}();return a.ConstValueInJSON=b,a}(yne_DataTypes_ICollabJSON),yne_DataTypes_DataTypes=function(a){Object.defineProperty(a,"__esModule",{value:!0});var b=function(){function a(){}return a.NONDATACMD_BLOCKSELECTION="nb_BlkSelection",a.NONDATACMD_CLINTPONG="nb_clientPong",a.NONDATACMD_COLLABCLOSE="nb_CollabClose",a.NONDATACMD_COLLABINFO="nb_CollabInfo",a.NONDATACMD_DATACMDFAILED="nb_dataCmdFailed",a.NONDATACMD_GETMODIFIERS="nb_getModifiers",a.NONDATACMD_NOTESAVE="nb_noteSave",a.NONDATACMD_LOCKRELEASE="nb_lockRelease",a.NONDATACMD_SESSIONINITIALIZED="nb_sessionInitialized",a.NONDATACMD_SEVERPING="nb_serverPing",a}();a.CmdNames=b;!function(a){a[a.EXCEPTION=0]="EXCEPTION",a[a.NO_ERROR=1]="NO_ERROR",a[a.TIME_OUT=100]="TIME_OUT",a[a.STOP_CALL=101]="STOP_CALL"}(a.CustomResultCode||(a.CustomResultCode={}));!function(a){a[a.FAILED_RECEIVE_COLLAB_CMD=4001]="FAILED_RECEIVE_COLLAB_CMD",a[a.FAILED_SEND_LOCAL_CMD=4002]="FAILED_SEND_LOCAL_CMD",a[a.MESSAGE_TOO_BIG=4003]="MESSAGE_TOO_BIG",a[a.SESSION_NOT_OPENED=4004]="SESSION_NOT_OPENED",a[a.CLOSED_BY_HOST=4500]="CLOSED_BY_HOST",a[a.COLLAB_SERVER_UNREACHABLE=9e3]="COLLAB_SERVER_UNREACHABLE",a[a.COLLAB_SERVER_SHUTDOWN=9003]="COLLAB_SERVER_SHUTDOWN",a[a.COLLAB_SESSION_CLOSED=9004]="COLLAB_SESSION_CLOSED"}(a.WSCustomCode||(a.WSCustomCode={}));return function(a){a[a.LOCAL_INVALID_STARTRANGE=5001]="LOCAL_INVALID_STARTRANGE",a[a.LOCAL_INVALID_CMDJSON=5002]="LOCAL_INVALID_CMDJSON",a[a.LOCAL_TARGET_BLOCK_LOCKED=5003]="LOCAL_TARGET_BLOCK_LOCKED",a[a.LOCAL_EMPTY_CMD=5004]="LOCAL_EMPTY_CMD",a[a.LOCAL_CMD_TOO_FAST=5005]="LOCAL_CMD_TOO_FAST",a[a.LOCAL_INVALID_FOR_COLLAB=5006]="LOCAL_INVALID_FOR_COLLAB",a[a.LOCAL_BLOCKS_MISSING=5008]="LOCAL_BLOCKS_MISSING",a[a.LOCAL_NOT_READY_APPLY=5009]="LOCAL_NOT_READY_APPLY",a[a.LOCAL_DIRTY_BLOCKS=5010]="LOCAL_DIRTY_BLOCKS",a[a.COLLAB_TARGET_BLOCK_LOCKED=5500]="COLLAB_TARGET_BLOCK_LOCKED",a[a.COLLAB_NOTEVERSION_MISMATCH=5507]="COLLAB_NOTEVERSION_MISMATCH",a[a.COLLAB_BLOCKS_MISSING=5508]="COLLAB_BLOCKS_MISSING",a[a.COLLAB_DIRTY_BLOCKS=5510]="COLLAB_DIRTY_BLOCKS"}(a.DataCmdFailureCode||(a.DataCmdFailureCode={})),a}(yne_DataTypes_DataTypes),yne_ExternalLibs=function(a){Object.defineProperty(a,"__esModule",{value:!0});var b=function(){function b(){}return b.setUnderscore=function(b){a.underscoreInst=b},b.setLogger=function(b){a.loggerInst=b},b}();return a.ExternalLibs=b,a}(yne_ExternalLibs),yne_YEventNames=function(a){return function(){function a(){}return a.WS_OPENED="WS_OPENED",a.WS_MESSAGE="WS_MESSAGE",a.WS_CLOSED="WS_CLOSED",a.SESSION_CHNAGED="SESSION_CHNAGED",a.SESSION_JOINED="SESSION_JOINED",a.SESSION_QUIT="SESSION_QUIT",a.SESSION_PROP_UPDATE="SESSION_PROP_UPDATE",a.SESSION_LOCK_UPDATE="SESSION_LOCK_UPDATE",a.SESSION_INIT_DONE="SESSION_INIT_DONE",a.SESSION_INIT_BUILT="SESSION_INIT_BUILT",a.NONDATACMD_MODIFIERS_RESULT="NONDATACMD_MODIFIERS_RESULT",a.LOCK_RELEASED="LOCK_RELEASED",a.LOCK_LOCKED="LOCK_LOCKED",a.LOCK_PROP_UPDATE="LOCK_PROP_UPDATE",a.CONFLICT_LOCKED_BY_ME="CONFLICT_LOCKED_BY_ME",a.CONFLICT_LOCKED_BY_OTHERS="CONFLICT_LOCKED_BY_OTHERS",a.CONFLICT_BLOCK_CHANGED="CONFLICT_BLOCK_CHANGED",a.DATACMD_FAILURE="DATACMD_FAILURE",a.DATACMD_NO_PENDING="DATACMD_NO_PENDING",a.DATACMD_SUCCESS="DATACMD_SUCCESS",a.ENGINE_EXCEPTION="ENGINE_EXCEPTION",a}()}(),yne_Utils=function(a){Object.defineProperty(a,"__esModule",{value:!0});var b=function(){function a(){}return a.isCmdVersionMatchNoteVersion=function(a,b){return a-b==1},a.isMessageTooLarge=function(a){return a>5e3},a.newGUID=function(){var a="";return a+=Math.floor(10*Math.random()).toString().substr(0,1),a+=Math.floor(10*Math.random()).toString().substr(0,1),a+="-",a+=Date.now().toString()},a}();return a.Utils=b,a}(yne_Utils),yne_CollabKeyTranslator=function(a,b,c){Object.defineProperty(a,"__esModule",{value:!0});var d=function(a){function b(){var b=a.call(this)||this;return b.KEY_MAP_DECODE={a:{key:"sessionId",type:0},b:{key:"finalVersion",type:0},c:{key:"cmdOwner",type:0},d:{key:"collabCmds",type:1},e:{key:"dataCommands",type:1},f:{key:"action",type:0},g:{key:"cmdId",type:0},h:{key:"nondataCmds",type:1},i:{key:"updateVersion",type:0},j:{key:"startNoteRange",type:1},k:{key:"startBlockRange",type:1},l:{key:"rangeType",type:0},m:{key:"startPosition",type:0},n:{key:"endPosition",type:0},o:{key:"isInSingleBlock",type:0},p:{key:"cmdNoteVersion",type:0},q:{key:"isLocalExecutedCmd",type:0},r:{key:"skipBlockLocking",type:0},s:{key:"blockId",type:0},t:{key:"richText",type:0},u:{key:"newBlkId",type:0},v:{key:"inlineStyles",type:0},w:{key:"blockStyles",type:0},x:{key:"newStartBlkId",type:0},y:{key:"newEndBlkId",type:0},z:{key:"dropRange",type:1},0:{key:"colNums",type:0},1:{key:"rowNums",type:0},2:{key:"simpleValue1",type:0},3:{key:"src",type:0},4:{key:"simpleValue2",type:0},5:{key:"recogLink",type:0},6:{key:"attachRes",type:0},7:{key:"fileName",type:0},8:{key:"fileLen",type:0},9:{key:"innerCmds",type:1},A:{key:"affectedBlockIds",type:0},B:{key:"endNoteRange",type:1},C:{key:"isCollabUndo",type:0},D:{key:"preBlockId",type:0},E:{key:"deletedBlocks",type:0},F:{key:"insertedBlocks",type:0},G:{key:"isCollabRedo",type:0},H:{key:"resIds",type:0},J:{key:"dataBefore",type:0},K:{key:"dataAfter",type:0},L:{key:"endBlockRange",type:1},N:{key:"blockIds",type:0},O:{key:"styleNameValues",type:0},P:{key:"oldStyleNameValues",type:0},Q:{key:"abstractSimpleValue1",type:0},R:{key:"indentStep",type:0},S:{key:"listId",type:0},T:{key:"listType",type:0},U:{key:"abstractSimpleValue2",type:0},V:{key:"oldLevels",type:0},W:{key:"newLevels",type:0},X:{key:"listItemIds",type:0},Y:{key:"headerFooterInfo",type:0}},b._assembleEncodeMap(),b}return __extends(b,a),b.prototype.destroy=function(){},b.prototype.decode=function(a){var b,d,e=this;if(!1===e._isValidKeyMap)return void c.loggerInst.error("KeyMap is not valid, skip decode.");if(c.underscoreInst.isArray(a))return void c.underscoreInst.each(a,function(a){e.decode(a)});if(null!==a&&"object"==typeof a){b=c.underscoreInst.keys(a);for(var f=0;f<b.length;f++)a.hasOwnProperty(b[f])&&b[f]in this.KEY_MAP_DECODE&&(d=this.KEY_MAP_DECODE[b[f]].key,a[d]=a[b[f]],delete a[b[f]],null!==a[d]&&"object"==typeof a[d]&&1===this.KEY_MAP_DECODE[b[f]].type&&e.decode(a[d]))}},b.prototype.encode=function(a){var b,d,e=this;if(!1===e._isValidKeyMap)return void c.loggerInst.error("KeyMap is not valid, skip encode.");if(c.underscoreInst.isArray(a))return void c.underscoreInst.each(a,function(a){e.encode(a)});if(null!==a&&"object"==typeof a){b=c.underscoreInst.keys(a);for(var f=0;f<b.length;f++)a.hasOwnProperty(b[f])&&(b[f]in this.KEY_MAP_ENCODE?(d=this.KEY_MAP_ENCODE[b[f]].key,a[d]=a[b[f]],delete a[b[f]],null!==a[d]&&"object"==typeof a[d]&&1===this.KEY_MAP_ENCODE[b[f]].type&&e.encode(a[d])):(c.loggerInst.log("key:",typeof b[f]),c.loggerInst.error('Key - "',b[f],'" does NOT exist in COLLAB_MAP_ENCODE!')))}},b.prototype._assembleEncodeMap=function(){var a,b,d=this;d._isValidKeyMap=!0,d.KEY_MAP_ENCODE={};for(b in d.KEY_MAP_DECODE)if(d.KEY_MAP_DECODE.hasOwnProperty(b)){if(a=d.KEY_MAP_DECODE[b].key,c.underscoreInst.has(d.KEY_MAP_DECODE,a)){d._isValidKeyMap=!1,c.loggerInst.error("original JSON key is conflict with encoded key, please rename it",a);break}if(c.underscoreInst.has(d.KEY_MAP_ENCODE,a)){d._isValidKeyMap=!1,c.loggerInst.error("original JSON key is duplicated, please rename them",a);break}d.KEY_MAP_ENCODE[a]={},d.KEY_MAP_ENCODE[a].key=b,d.KEY_MAP_ENCODE[a].type=d.KEY_MAP_DECODE[b].type}},b}(b.YEvent);return a.CollabKeyTranslator=d,a}(yne_CollabKeyTranslator,yne_YEvent,yne_ExternalLibs),yne_CmdCollabPropsHandler=function(a,b){Object.defineProperty(a,"__esModule",{value:!0});var c=function(a){function b(b,c,d){var e=a.call(this)||this;return e._clientId=b,e._collabKeyTranslator=c,e._coreEditor=d,e}return __extends(b,a),b.prototype.destroy=function(){this.removeAllListeners(null)},b.prototype.buildCollabProperties=function(a){var b,c,d,e,f={coreEditor:this._coreEditor};return a?(f.cmdSessionId=a.sessionId,b=f.cmdSessionId===this._clientId,f.isOwnCmd=b,f.finalNoteVersion=parseInt(a.finalVersion),f.ownerName=a.cmdOwner,f.isCollabCmd=!0,f.isServerCmd=!1,c=a.collabCmds,c.nondataCmds?e=c.nondataCmds[0]:(this._collabKeyTranslator.decode(c),d=c.dataCommands[0]),null!=e?f.isServerCmd=!0===e.isServerCmd:null!=d&&(f.isLocalExecutedCmd=!0===d.isLocalExecutedCmd,f.cmdId=d.cmdId)):f.cmdSessionId=this._clientId,f},b}(b.YEvent);return a.CmdCollabPropsHandler=c,a}(yne_CmdCollabPropsHandler,yne_YEvent),yne_WebSocketClient=function(a,b,c,d,e,f){Object.defineProperty(a,"__esModule",{value:!0});var g,h=function(){function a(){}return a.COLLABID="collabId",a.NICKNAME="nickname",a.NOTEVERSION="noteVersion",a.PORTRAIT="portraitUrl",a.SESSIONTYPE="sessionType",a.SESSIONID="sessionId",a.USERID="userId",a.BUILDVERSION="buildVersion",a.RECONNECT="reconn",a}();!function(a){a[a.normal=0]="normal",a[a.readonly=1]="readonly",a[a.owner=2]="owner"}(g||(g={}));var i=function(a){function c(b){var c=a.call(this)||this;if("undefined"==typeof window&&"undefined"!=typeof global){global.WebSocket=yne_websocket.w3cwebsocket}return c._collabPropsHandler=b,c}return __extends(c,a),c.prototype.connect=function(a){var c,d=a.useWSS?"wss":"ws";if("undefined"==typeof WebSocket)throw"There is NO WebSocket type in Context.";if(null==a.collabServer)throw"Param of options.collabServer should not be null";if(null==a.shareKey)throw"Param of options.shareKey should not be null";if(null==a.nickname)throw"Param of options.nickname should not be null";if(null==a.portraitUrl)throw"Param of options.portraitUrl should not be null";if(null==a.userId)throw"Param of options.userId should not be null";if(null==a.sessionId)throw"Param of options.sessionId should not be null";if(null==a.sessionType)throw"Param of options.sessionType should not be null";if(null==a.buildVersion)throw"Param of options.buildVersion should not be null";c=d+"://"+a.collabServer+"?"+h.COLLABID+"="+a.shareKey+"&"+h.NICKNAME+"="+a.nickname+"&"+h.PORTRAIT+"="+a.portraitUrl+"&"+h.USERID+"="+a.userId+"&"+h.SESSIONTYPE+"="+a.sessionType+"&"+h.SESSIONID+"="+a.sessionId+"&"+h.BUILDVERSION+"="+a.buildVersion,this._sessionOptions=a,b.loggerInst.log("Connect to",c),this._wsInst=new WebSocket(c),this._wsInst.onopen=this._onOpen.bind(this),this._wsInst.onclose=this._onClose.bind(this),this._wsInst.onmessage=this._onMessage.bind(this),this._wsInst.onerror=this._onError.bind(this)},c.prototype.getSessionId=function(){return this._sessionOptions.sessionId},c.prototype.getNickname=function(){return this._sessionOptions.nickname},c.prototype.getPortraitUrl=function(){return this._sessionOptions.portraitUrl},c.prototype.getUserId=function(){return this._sessionOptions.userId},c.prototype.getCollabId=function(){return this._sessionOptions.shareKey},c.prototype.isReadOnlySession=function(){return this._sessionOptions.sessionType===g.readonly},c.prototype.isOpened=function(){return null!=this._wsInst&&this._wsInst.readyState===this._wsInst.OPEN},c.prototype.send=function(a){var c,d=f.CustomResultCode.NO_ERROR;return c=2*a.length/1024,e.Utils.isMessageTooLarge(c)?d=f.WSCustomCode.MESSAGE_TOO_BIG:this._wsInst&&this._wsInst.readyState===WebSocket.OPEN?(b.loggerInst.log("sending message:",a),this._wsInst.send(a)):d=f.WSCustomCode.SESSION_NOT_OPENED,d},c.prototype.close=function(a,b){var c=this;c._wsInst&&c._wsInst.readyState===WebSocket.OPEN&&(c._wsInst.onopen=null,c._wsInst.onclose=null,c._wsInst.onmessage=null,c._wsInst.onerror=null,c._wsInst.close(a,b),a!==f.WSCustomCode.CLOSED_BY_HOST&&c.emit(d.WS_CLOSED,c._assembleSessionError(a,a)))},c.prototype.sendDataCmdErrorCode=function(a){this.send(a.toString())},c.prototype._onOpen=function(a){b.loggerInst.log("Connection is opened.");var c={resultCode:f.CustomResultCode.NO_ERROR};this.emit(d.WS_OPENED,c)},c.prototype._onClose=function(a){b.loggerInst.log("Connection is closed."),this.emit(d.WS_CLOSED,this._assembleSessionError(a.code,parseInt(a.reason)))},c.prototype._onMessage=function(a){b.loggerInst.log("Received Message in WSClient:",a.data);try{if(null!=a.data&&""!==a.data){var c=JSON.parse(a.data),e=this._collabPropsHandler.buildCollabProperties(c);e.rawWSMessage=a.data;var g={resultCode:f.CustomResultCode.NO_ERROR,collabCmdsJSON:c.collabCmds,collabProps:e};this.emit(d.WS_MESSAGE,g)}}catch(a){b.loggerInst.error("Exception in WebSocketClient._onMessage:",a)}},c.prototype._onError=function(a){b.loggerInst.log("Caught Error:",a)},c.prototype._assembleSessionError=function(a,c){var d;switch(b.underscoreInst.isNaN(c)&&(c=1006===a?f.WSCustomCode.COLLAB_SERVER_UNREACHABLE:1005===a?f.WSCustomCode.COLLAB_SERVER_SHUTDOWN:1001===a?f.WSCustomCode.COLLAB_SESSION_CLOSED:a),c){case 2e3:d="连接总数超过上限";break;case 2001:d="单个文件连接总数超过上限";break;case 2002:d="重复的session链接";break;case 2003:d="所有者链接超过上限";break;case 3e3:d="转发命令失败";break;case 3001:d="添加链接失败";break;case 3003:d="命令转发进程无响应";break;case 3004:d="创建链接失败";break;case 3005:d="创建命令转发进程失败";break;case 3006:d="广播命令失败";break;case 3007:d="初始化链接失败";break;case 3008:d="未转发命令总数超上限";break;case 4001:d="等待命令返回超时";break;case 4002:d="发送命令失败";break;case 8e3:d="笔记长时间无操作";break;case 9e3:d="链接协同服务器失败";break;case 9003:d="协同服务器被强制关闭";break;case 9004:d="协同链接异常关闭，请检测session是否初始化成功";break;case 9100:d="当前编辑器版本太低";break;case 9101:d="链接被主动强制关闭";break;case 9102:d="协同命令执行失败";break;case 9103:d="重连次数超限";break;default:d="未知错误"}return{resultCode:a,code:a,customCode:c,shareKey:this._sessionOptions.shareKey,reason:d}},c}(c.YEvent);return a.WebSocketClient=i,a}(yne_WebSocketClient,yne_ExternalLibs,yne_YEvent,yne_YEventNames,yne_Utils,yne_DataTypes_DataTypes),yne_NonDataCmdHandler=function(a,b,c,d,e,f){Object.defineProperty(a,"__esModule",{value:!0});var g=function(a){function b(b){var d=a.call(this)||this;if(d._retryIntervalMilliSec=1e3,d._retryMaxCount=2,null==b)throw"wsClient should NOT be null";return d._wsClient=b,d._callback_WS_OnMessage=d._execCollabNondataCommand.bind(d),d._wsClient.on(c.WS_MESSAGE,d._callback_WS_OnMessage),d}return __extends(b,a),b.prototype.destroy=function(){this._wsClient.off(c.WS_MESSAGE,this._callback_WS_OnMessage),this._wsClient=null,this.removeAllListeners(null)},b.prototype.getModifiers=function(a){var b=this;return this._wsClient.isOpened()?b._modifiers&&1===b._modifiers.status&&b._modifiers.endVersion===a||(b._modifiers={resultCode:f.CustomResultCode.NO_ERROR,status:0},this._requestModifiers(a)||(b._modifiers.status=2)):b._modifiers={resultCode:f.WSCustomCode.SESSION_NOT_OPENED,status:2},b._modifiers},b.prototype.sendCollabNonDataCommand=function(a,b){var c,d=!0;return c=this._buildCollabCmdJSON(a,b),a===f.CmdNames.NONDATACMD_GETMODIFIERS?this._isModifiersReqeustSent(b.endNoteVersion)||(this._clearRetryQueueByAction(a),d=this._queueCollabCmdJSON(c)):d=a===f.CmdNames.NONDATACMD_COLLABINFO||a===f.CmdNames.NONDATACMD_NOTESAVE?this._queueCollabCmdJSON(c):this._sendCollabJSON(c),d},b.prototype._execCollabNondataCommand=function(a){var b,d=a.collabCmdsJSON,e=a.collabProps,g=e.cmdSessionId;if(null!=d.nondataCmds){switch(b=d.nondataCmds[0],b.action){case f.CmdNames.NONDATACMD_BLOCKSELECTION:break;case f.CmdNames.NONDATACMD_COLLABCLOSE:var h={resultCode:f.CustomResultCode.NO_ERROR,sessionId:g};this.emit(c.SESSION_QUIT,h);break;case f.CmdNames.NONDATACMD_COLLABINFO:this._handleCollabInfo(b,e);break;case f.CmdNames.NONDATACMD_SESSIONINITIALIZED:var i={resultCode:1,result:b.initResult,collabId:this._wsClient.getCollabId(),sessionId:this._wsClient.getSessionId(),nickname:this._wsClient.getNickname(),userId:this._wsClient.getUserId(),isReadOnly:this._wsClient.isReadOnlySession(),collabVersion:b.collabVersion};this.emit(c.SESSION_INIT_DONE,i);break;case f.CmdNames.NONDATACMD_LOCKRELEASE:var j={resultCode:f.CustomResultCode.NO_ERROR,sessionId:g,unlockedBlockId:null};this.emit(c.LOCK_RELEASED,j);break;case f.CmdNames.NONDATACMD_SEVERPING:this._handleServerPing(b);break;case f.CmdNames.NONDATACMD_GETMODIFIERS:this._handleModifiers(b);break;case f.CmdNames.NONDATACMD_NOTESAVE:this._handleNoteSave(b);break;default:throw"unknown nondata cmd:"+b.action}this._removeFromRetryQueue(b.cmdId)}},b.prototype._queueCollabCmdJSON=function(a){var b;return b=this._sendCollabJSON(a),b&&(a.sendingToCollabServerMillis=Date.now(),a.retryRemainedCount=this._retryMaxCount,this._retriableCmdsQueue.push(a),null==this._retryCollabJSONDispatcher&&(this._retryCollabJSONDispatcher=setTimeout(this._handleCollabJSONRetry.bind(this),this._retryIntervalMilliSec))),b},b.prototype._requestModifiers=function(a){var b={};return b.endNoteVersion=a,this.sendCollabNonDataCommand(f.CmdNames.NONDATACMD_GETMODIFIERS,b)},b.prototype._handleCollabJSONRetry=function(){var a,b,c=this,d=!1;e.underscoreInst.each(this._retriableCmdsQueue,function(g){if(!0===d||null==c._wsClient||!1===c._wsClient.isOpened())return void(d=!0);(a=Date.now()-g.sendingToCollabServerMillis)>c._retryIntervalMilliSec&&(b=g.retryRemainedCount,b>0?(e.loggerInst.log("NonDataCmd-Resend:",g),delete g.sendingToCollabServerMillis,delete g.retryRemainedCount,c._sendCollabJSON(g),g.sendingToCollabServerMillis=Date.now(),g.retryRemainedCount=b-1):(e.loggerInst.error("NondataCmd-Send Failed after retry:",g),c._wsClient&&c._wsClient.isOpened()&&c._wsClient.close(f.WSCustomCode.FAILED_RECEIVE_COLLAB_CMD,f.WSCustomCode[f.WSCustomCode.FAILED_RECEIVE_COLLAB_CMD]),d=!0))}),d&&(c._retriableCmdsQueue=[]),c._retriableCmdsQueue.length>0?c._retryCollabJSONDispatcher=setTimeout(c._handleCollabJSONRetry.bind(c),c._retryIntervalMilliSec):(clearTimeout(c._retryCollabJSONDispatcher),c._retryCollabJSONDispatcher=null)},b.prototype._sendCollabJSON=function(a){return null!=a&&this._wsClient.send(JSON.stringify(a)),!0},b.prototype._isModifiersReqeustSent=function(a){var b,c=!1;return e.underscoreInst.some(this._retriableCmdsQueue,function(d){return b=d.nondataCmds[0],b.action===f.CmdNames.NONDATACMD_GETMODIFIERS&&b.endVersion===a&&(c=!0,!0)}),c},b.prototype._buildCollabCmdJSON=function(a,b){var c,e=[],g={};switch(c={action:a,cmdId:d.Utils.newGUID()},e.push(c),g.nondataCmds=e,a){case f.CmdNames.NONDATACMD_BLOCKSELECTION:c.blockId=b.selectedBlockId;break;case f.CmdNames.NONDATACMD_COLLABINFO:var h={sessionId:b.sessionId};void 0!==b.nickname&&(h.nickname=b.nickname),void 0!==b.lockedBlockId&&(h.lockedBlkIds=[],h.lockedBlkIds.push(b.lockedBlockId)),void 0!==b.portraitUrl&&(h.portraitUrl=b.portraitUrl),this._buildSessionInfoJSON(c,h);break;case f.CmdNames.NONDATACMD_DATACMDFAILED:c.dataCmdError=b.dataCmdErrorCode,c.errToClose=!!b.errToClose;break;case f.CmdNames.NONDATACMD_CLINTPONG:c.versionUpdate=b.noteVersion;break;case f.CmdNames.NONDATACMD_GETMODIFIERS:c.endVersion=b.endNoteVersion;break;case f.CmdNames.NONDATACMD_NOTESAVE:c.versionUpdate=b.noteVersion,c.isHistorySave=b.isHistorySave;break;default:throw g=null,"Unsupported NondataCmd:"+a}return g},b.prototype._buildSessionInfoJSON=function(a,b){var c={sessionId:b.sessionId};null!=b.nickname&&(c.nickname=b.nickname),null!=b.portraitUrl&&(c.portraitUrl=b.portraitUrl),null!=b.lockedBlkIds&&b.lockedBlkIds.length>0&&(c.lockedBlkId=b.lockedBlkIds[0]),a.sessionProp=[],a.sessionProp.push(c)},b.prototype._handleCollabInfo=function(a,b){var d=a.sessionProp,f=[];e.underscoreInst.each(d,function(a){var c={sessionId:null};null!=a.lockedBlkId&&(c.lockedBlkIds=[a.lockedBlkId],delete a.lockedBlkId),e.underscoreInst.extend(c,a),null==c.sessionId&&(c.sessionId=b.cmdSessionId),f.push(c)}),this.emit(c.SESSION_CHNAGED,f)},b.prototype._handleServerPing=function(a){if(null!=a.collabNoteReady){var b={resultCode:f.CustomResultCode.NO_ERROR,isCollabStarted:a.collabNoteReady,sessionId:this._wsClient.getSessionId()};this.emit(c.SESSION_INIT_BUILT,b)}},b.prototype._handleModifiers=function(a){var b=this;b._modifiers.status=1,b._modifiers.startVersion=a.startVersion,b._modifiers.endVersion=a.endVersion,b._modifiers.modifiers=[],e.underscoreInst.each(a.modifiers,function(a){var c={userId:a.userId};b._modifiers.modifiers.push(c)}),this._clearRetryQueueByAction(f.CmdNames.NONDATACMD_GETMODIFIERS),this.emit(c.NONDATACMD_MODIFIERS_RESULT,b._modifiers)},b.prototype._clearRetryQueueByAction=function(a){var b,c=this;c._retriableCmdsQueue=e.underscoreInst.reject(c._retriableCmdsQueue,function(c){return b=c.nondataCmds[0],b.action===a&&(e.loggerInst.log("remove cmd from retryQueue by actionName:",a),!0)})||[]},b.prototype._removeFromRetryQueue=function(a){var b,c=this;c._retriableCmdsQueue=e.underscoreInst.reject(c._retriableCmdsQueue,function(c){return b=c.nondataCmds[0],b.cmdId===a&&(e.loggerInst.log("remove cmd from retryQueue:",a),!0)})||[]},b.prototype._handleNoteSave=function(a){e.loggerInst.log("SaveNotification:",a)},b}(b.YEvent);return a.NonDataCmdHandler=g,a}(yne_NonDataCmdHandler,yne_YEvent,yne_YEventNames,yne_Utils,yne_ExternalLibs,yne_DataTypes_DataTypes),yne_CollabSessionHandler=function(a,b,c,d){Object.defineProperty(a,"__esModule",{value:!0});var e=function(a){function c(b,c){var e=a.call(this)||this;return e._sessionsMap={},e._ownSessionId=b,e._nondataCmdHandler=c,e._nondataCmdHandler.on(d.SESSION_CHNAGED,e._onSessionChanged.bind(e)),e._nondataCmdHandler.on(d.SESSION_QUIT,e._onSessionQuit.bind(e)),e}return __extends(c,a),c.prototype.destroy=function(){this._sessionsMap=null,this.removeAllListeners(null)},c.prototype.getSessionCount=function(){return b.underscoreInst.size(this._sessionsMap)},c.prototype.getSessionPropertiesBy=function(a){var c=this._sessionsMap[a];if(c)return b.underscoreInst.clone(c)},c.prototype._onSessionChanged=function(a){var c,e,f=this,g=[],h=[],i=!1;a.length>0&&(b.underscoreInst.each(f._sessionsMap,function(a){a.propUpdated=!1,h.push(a)}),b.underscoreInst.each(a,function(a){if(null==f._sessionsMap[a.sessionId]&&(f._sessionsMap[a.sessionId]={sessionId:a.sessionId},h.push(f._sessionsMap[a.sessionId]),i=!0),e=a.lockedBlkIds,delete a.lockedBlkIds,c=f._sessionsMap[a.sessionId],c.propUpdated=!1,b.underscoreInst.each(Object.keys(a),function(b){c[b]!==a[b]&&(c[b]=a[b],c.propUpdated=!0,i=!0)}),null!=e&&e.length>0){var d={sessionId:a.sessionId,lockedBlkIds:e};b.underscoreInst.defaults(d,c),g.push(d)}}),i&&f.emit(d.SESSION_CHNAGED,h),g.length>0&&f.emit(d.SESSION_LOCK_UPDATE,g))},c.prototype._onSessionQuit=function(a){var c=[];delete this._sessionsMap[a.sessionId],this.emit(d.SESSION_QUIT,a),b.underscoreInst.each(this._sessionsMap,function(a){a.propUpdated=!1,c.push(a)}),this.emit(d.SESSION_CHNAGED,c)},c}(c.YEvent);return a.CollabSessionHandler=e,a}(yne_CollabSessionHandler,yne_ExternalLibs,yne_YEvent,yne_YEventNames),yne_BlockLockHandler=function(a,b,c,d,e){Object.defineProperty(a,"__esModule",{value:!0});var f=function(a){function d(b,c,d){var f=a.call(this)||this,g=f;if(null==b)throw"ownSID cannot be null in BlockLockHandler";return g._lockedBlocksMap={},g._sessionId=b,g._sessionHandler=c,g._nonDataCmdHandler=d,g._sessionHandler.on(e.SESSION_LOCK_UPDATE,g._onSessionLockChanged.bind(g)),g._sessionHandler.on(e.SESSION_QUIT,g._onSessionQuit.bind(g)),g._nonDataCmdHandler.on(e.LOCK_RELEASED,function(a){g._releaseLockOf(a.sessionId)}),f}return __extends(d,a),d.prototype.destroy=function(){this._lockedBlocksMap=null,this._sessionHandler=null,this._nonDataCmdHandler=null,this.removeAllListeners(null)},d.prototype.isBlockLockedBy=function(a,b){var c,d=!1;return null!=a&&null!=b&&null!=(c=this._lockedBlocksMap[a])&&c===b&&(d=!0),d},d.prototype.getOwnBlockIds=function(){var a=this,b=[];return c.underscoreInst.each(a._lockedBlocksMap,function(c,d){c===a._sessionId&&b.push(d)}),b},d.prototype.getLockedBlockIdsBy=function(a){var b=[];return c.underscoreInst.each(this._lockedBlocksMap,function(c,d){a===c&&b.push(d)}),b},d.prototype.updateLockByDataCmd=function(a){var b,c=a.getCollabProps();if(null!=(b=a.isCollabUndo?a.getStartingRange():a.getEndingRange())){var d=b.getEndBlockRange();if(null!=d){var e=d.block.getId();if(null!=e&&(this._releaseLockOf(c.cmdSessionId),null==this._lockedBlocksMap[e])){var f=this._sessionHandler.getSessionPropertiesBy(c.cmdSessionId);null!=f&&(f.lockedBlkIds=[e],this._lockBlock(f))}}}},d.prototype._releaseLockOf=function(a){var b=this,d=[];c.underscoreInst.each(this._lockedBlocksMap,function(b,c){b===a&&d.push(c)}),c.underscoreInst.each(d,function(c){b._unlockBlock(c,a)})},d.prototype._onSessionQuit=function(a){this._releaseLockOf(a.sessionId)},d.prototype._onSessionLockChanged=function(a){var b=this,d=!1;c.underscoreInst.each(a,function(a){d=!1,null!=a.lockedBlkIds&&a.lockedBlkIds.length>0&&(c.underscoreInst.some(a.lockedBlkIds,function(c){return b._lockedBlocksMap[c]!==a.sessionId&&(d=!0),d}),d&&(b._releaseLockOf(a.sessionId),b._lockBlock(a)))})},d.prototype._unlockBlock=function(a,c){delete this._lockedBlocksMap[a];var d={resultCode:b.CustomResultCode.NO_ERROR,sessionId:c,unlockedBlockId:a};this.emit(e.LOCK_RELEASED,d)},d.prototype._lockBlock=function(a){var b=this,d={resultCode:1,sessionId:a.sessionId,sessionProps:a},f=!1;c.underscoreInst.each(a.lockedBlkIds,function(c){b._lockedBlocksMap[c]!==a.sessionId&&(b._lockedBlocksMap[c]=a.sessionId,f=!0)}),f&&this.emit(e.LOCK_LOCKED,d)},d}(d.YEvent);return a.BlockLockHandler=f,a}(yne_BlockLockHandler,yne_DataTypes_DataTypes,yne_ExternalLibs,yne_YEvent,yne_YEventNames),yne_CmdMergeHandler=function(a,b,c){Object.defineProperty(a,"__esModule",{value:!0});var d=function(a){function c(){return a.call(this)||this}return __extends(c,a),c.prototype.destroy=function(){this.removeAllListeners(null)},c.prototype.mergeLocalCommands=function(a){var c,d,e=null,f=0;if(a&&a.length>0)if(1===a.length)e=a[0];else{for(e=a.shift();a.length>0&&(c=a[0],e.canBeMerged(c));)b.loggerInst.log("merge pending command:",e,c),e.mergeLocalCmd(c),a.shift(),f++;f>0&&a[0]&&a[0].isCollabUndo&&(d=b.underscoreInst.clone(e),d.isLocalExecutedCmd=a[0].isLocalExecutedCmd,d.setCollabUndo(!0),d.setCollabRedo(!1),a[0]=d),a.unshift(e)}},c}(c.YEvent);return a.CmdMergeHandler=d,a}(yne_CmdMergeHandler,yne_ExternalLibs,yne_YEvent),yne_CollabConflictHandler=function(a,b,c,d){Object.defineProperty(a,"__esModule",{value:!0});var e=function(a){function b(b,c){var d=a.call(this)||this;return d._coreEditor=b,d._lockHandler=c,d}return __extends(b,a),b.prototype.destroy=function(){this._lockHandler=null,this.removeAllListeners(null)},b.prototype.isConflictWithOwnLockedBlock=function(a,b,e){var f,g,h,i,j=!1,k=this._lockHandler.getOwnBlockIds();return null!=k&&k.length>0&&(i=k[0]),d.loggerInst.log("LOCK/UNLOCK: isConflictWithOwnLockedBlock Enter"),"comp.AppendBlank"!==b&&i&&(f=this._coreEditor.getBlockById(i),f&&!this._coreEditor.isTable(f)&&(g=this._coreEditor.getInnerBlocksWithEdge(a),g&&0!==g.length?d.underscoreInst.some(g,function(a){return a.getId()===i&&(e.collabProperties.dataCmdError="协同命令执行失败：编辑目标段落被锁定",e.collabProperties.errorToClose=!!e.collabProperties.isLocalExecutedCmd,e.collabProperties.errorCode=c.DataCmdFailureCode.COLLAB_TARGET_BLOCK_LOCKED,j=!0),j}):d.loggerInst.warn("Failed to get the blocks from range",a)),j||null==e.dropRange||null==e.dropRange.block||(h=e.dropRange.block.getId())&&(j=h===i)&&(e.collabProperties.dataCmdError="协同命令执行失败：拖拽目标段落被锁定",e.collabProperties.errorToClose=!!e.collabProperties.isLocalExecutedCmd,e.collabProperties.errorCode=c.DataCmdFailureCode.COLLAB_TARGET_BLOCK_LOCKED)),d.loggerInst.log("LOCK/UNLOCK: isConflictWithOwnLockedBlock Exit"),j},b.prototype.isNoteRangeConflict=function(a,b,e){var f,g,h,i,j,k=this,l=!1;return d.loggerInst.log("LOCK/UNLOCK: isNoteRangeConflict Enter"),g=e.cmdSessionId,j=!e.isCollabCmd||e.isOwnCmd,"comp.SetBlockProps"!==b&&"comp.AppendBlank"!==b&&"ManagerAdapter"!==b&&(f=this._coreEditor.getInnerBlocksWithEdge(a),f&&0!==f.length?(d.underscoreInst.some(f,function(a){return d.loggerInst.log("LOCK/UNLOCK: "+a.getId()+" LockState:"+a.isLocked()),a.isLocked()&&(l=j||!k._lockHandler.isBlockLockedBy(a.getId(),g))&&(e.dataCmdError="目标段落已被其他session锁定",e.isCollabCmd?(e.errorToClose=!!e.isLocalExecutedCmd,e.errorCode=c.DataCmdFailureCode.COLLAB_TARGET_BLOCK_LOCKED):e.errorCode=c.DataCmdFailureCode.LOCAL_TARGET_BLOCK_LOCKED),l}),l||(l=k._isConflictWithNeighborBlock(b,a,e))):(e.dataCmdError="目标段落不存在",e.isCollabCmd?(e.errorToClose=!0,e.errorCode=c.DataCmdFailureCode.COLLAB_BLOCKS_MISSING):e.errorCode=c.DataCmdFailureCode.LOCAL_BLOCKS_MISSING,l=!0),l||null==e.cmdJSON||null==e.cmdJSON.dropRange||(h=e.cmdJSON.dropRange.blockId,h&&(i=k._coreEditor.getBlockById(h)),i&&i.isLocked()&&(l=j||!k._lockHandler.isBlockLockedBy(h,g)))),d.loggerInst.log("LOCK/UNLOCK: isNoteRangeConflict Exit"),l},b.prototype._isConflictWithNeighborBlock=function(a,b,e){var f,g,h,i,j=this,k=!1,l=e.cmdSessionId;if(!b)return d.loggerInst.warn("_isConflictWithNeighborBlock:noteRange should not be null"),!1;switch(f=b.getStartBlockRange(),g=!e.isCollabCmd||e.isOwnCmd,a){case"comp.KeyBackspace":f&&0===f.start&&!j._coreEditor.isTodo(f.block)&&(h=j._coreEditor.getPreBlockById(f.getBlockId()))&&b.isCollapsed()&&!this._coreEditor.isListItem(f.block)&&0===f.block.getBlockStyle("text-indent")&&h.isLocked()&&(k=g||!j._lockHandler.isBlockLockedBy(h.getId(),l))&&(e.dataCmdError="目标段落已被其他session锁定",e.isCollabCmd?(e.errorToClose=!0,e.errorCode=c.DataCmdFailureCode.COLLAB_TARGET_BLOCK_LOCKED):e.errorCode=c.DataCmdFailureCode.LOCAL_TARGET_BLOCK_LOCKED);break;case"comp.KeyDelete":b.isCollapsed()&&f.end===f.block.getLength(!1)&&(i=j._coreEditor.getNextBlockById(f.getBlockId()))&&i.isLocked()&&(k=g||!j._lockHandler.isBlockLockedBy(i.getId(),l))&&(e.dataCmdError="目标段落已被其他session锁定",e.isCollabCmd?(e.errorToClose=!0,e.errorCode=c.DataCmdFailureCode.COLLAB_TARGET_BLOCK_LOCKED):e.errorCode=c.DataCmdFailureCode.LOCAL_TARGET_BLOCK_LOCKED)}return k},b}(b.YEvent);return a.CollabConfilctHandler=e,a}(yne_CollabConflictHandler,yne_YEvent,yne_DataTypes_DataTypes,yne_ExternalLibs),yne_RedoUndoHandler=function(a,b,c){Object.defineProperty(a,"__esModule",{value:!0});var d=function(a){function c(b,c){var d=a.call(this)||this;return d._coreEditor=b,d._blockLockHandler=c,d._executedNotOwnCmdQueue=[],d}return __extends(c,a),c.prototype.destroy=function(){this.removeAllListeners(null)},c.prototype.applyCollabRedoUndo=function(a,b){var c,d=this,e=b.collabProperties.cmdJSON,f=e.isCollabUndo,g=e.isCollabRedo;return f?(b.collabProperties.isCollabUndo=!0,b.collabProperties.isCollabRedo=!1):g&&(b.collabProperties.isCollabUndo=!1,b.collabProperties.isCollabRedo=!0),c=d._coreEditor.createDataCommand(a,b),c&&(c.isOriginalCmd=!0,d._coreEditor.applyCollabCmdRedoUndo(c)),c},c.prototype.pushNotOwnExecCmd=function(a){this._executedNotOwnCmdQueue.push(a)},c.prototype.ValidateLocalRedoUndo=function(a){var c,d=this,e=!0,f=!1;return a.isCollabUndo?c=d.lastValidUndoCmd:a.isCollabRedo&&(c=d.lastValidRedoCmd),e&&((e=!this._isConflicted(a.getAffectedBlockIds(),a.getCmdFinalNoteVersion()))||(f=!0)),e&&c&&c.cmdId===a.cmdId&&(e=!1,b.loggerInst.warn("skip duplicated redo/undo command")),e?a.isCollabRedo?(d.lastValidRedoCmd=a,d.lastValidUndoCmd=null):a.isCollabUndo&&(d.lastValidUndoCmd=a,d.lastValidRedoCmd=null):(b.loggerInst.warn("Skip invalid Redo/Undo"),f&&(b.loggerInst.warn("Drop invalid Redo/Undo"),a.isCollabRedo?d._coreEditor.dropRedoCmd():a.isCollabUndo&&d._coreEditor.dropUndoCmds())),e},c.prototype.ValidateCollabRedoUndo=function(a,b){var c=this;return!c._isConflicted(a,b)},c.prototype._isConflicted=function(a,c){var d,e,f=this,g=!1;return e=b.underscoreInst.filter(f._executedNotOwnCmdQueue,function(a){return a.getCmdFinalNoteVersion()>c}),e=e||[],e.length>0&&b.underscoreInst.some(e,function(c){if(f._isNoteRangeOverlap(a,c.getAffectedBlockIds()))return g=!0,d=c.getCollabProps(),b.loggerInst.log("Conflict: data has been edited by "+d.ownerName),!0}),g},c.prototype._isNoteRangeOverlap=function(a,c){var d=!1;return a&&a.length>0&&c&&c.length>0&&b.underscoreInst.some(a,function(a){return b.underscoreInst.some(c,function(b){return a===b&&(d=!0),d}),d}),d},c}(c.YEvent);return a.RedoUndoHandler=d,a}(yne_RedoUndoHandler,yne_ExternalLibs,yne_YEvent),
yne_DataCmdHandler=function(a,b,c,d,e,f){Object.defineProperty(a,"__esModule",{value:!0});var g=function(a){function b(b,d,e,f,g,h,i){var j=a.call(this)||this;return j._regularCmdSendIntervalMS=2e3,j._pendingSentCmdsQueue=[],j._coreEditor=b,j._blockLockHandler=d,j._conflictHandler=e,j._redoundoHandler=f,j._cmdMergeHandler=g,j._keyTranslator=h,j._wsClient=i,j._callback_WS_OnMessage=j._execCollabDataCommand.bind(j),j._wsClient.on(c.WS_MESSAGE,j._callback_WS_OnMessage),j}return __extends(b,a),b.prototype.destroy=function(){this._wsClient.off(c.WS_MESSAGE,this._callback_WS_OnMessage),this._wsClient=null,this.removeAllListeners(null),this._pendingSentCmdsQueue=[]},b.prototype.getLastNotOwnExecCmd=function(){return this._lastNotOwnExecCmd},b.prototype.hasPendingCmds=function(){return this._pendingSentCmdsQueue&&this._pendingSentCmdsQueue.length>0},b.prototype.isLastOwnCmdExecuted=function(){var a=!0;return this._pendingSentCmdsQueue.length>0&&(a=this._pendingSentCmdsQueue[0].isLocalExecutedCmd),a},b.prototype.getCachedCmdCount=function(){return this._pendingSentCmdsQueue.length},b.prototype.getCmdDelay=function(){var a=0,b=this._pendingSentCmdsQueue[0];return null!=b&&null!=b.sendingToCollabServerMillis&&(a=Date.now()-b.sendingToCollabServerMillis),a},b.prototype.pushLocalDataCommand=function(a,b){var c=this,f=d.CustomResultCode.NO_ERROR;return a.isLocalExecutedCmd||0!==c._pendingSentCmdsQueue.length||(e.loggerInst.log("Process: sending non-local-executed first command"),f=c._sendCollabDataCommand(a,!1)),!b&&a.isLocalExecutedCmd&&0===c._pendingSentCmdsQueue.length&&(e.loggerInst.log("Process: delay sending local-executed first command"),c.sendCachedDataCommand(!0)),f===d.CustomResultCode.NO_ERROR&&(c._pendingSentCmdsQueue.push(a),!c._pendingSentCmdsQueue[0].sendingToCollabServerMillis&&(b||c._pendingSentCmdsQueue.length>1&&!a.isLocalExecutedCmd)&&(f=c.sendCachedDataCommand(!1)),e.loggerInst.log("Process: enqueue Command:(len:"+c._pendingSentCmdsQueue.length+")",a)),!0===a.isLocalExecutedCmd&&c._blockLockHandler.updateLockByDataCmd(a),f},b.prototype.sendCachedDataCommand=function(a){var b=this,c=d.CustomResultCode.NO_ERROR;return a?b._cmdSendingTimer=setTimeout(b._dispatchCachedDataCommand.bind(b),b._regularCmdSendIntervalMS):(clearTimeout(b._cmdSendingTimer),c=b._dispatchCachedDataCommand()),c},b.prototype._execCollabDataCommand=function(a){var b,d=a.collabCmdsJSON,e=a.collabProps,f={collabProperties:e};try{if(this._keyTranslator.decode(d),null==d.dataCommands)return null;if(null!=this._lastCmdId&&this._lastCmdId===e.cmdId)return null;null!=e.cmdId&&(this._lastCmdId=e.cmdId);var g=d.dataCommands[0],h=!1,i=g.action,j=!1,k=void 0,l=void 0,m=void 0,n=this._coreEditor.getDefaultNoteRange();k=this._coreEditor.getNoteRange(),f.collabProperties.cmdJSON=g,h=this._validateCollabDataCmd(d,f),h&&(b=this._executeDataCommand(i,f)),!f.collabProperties.isOwnCmd&&"comp.DeleteNoteRange"===i&&f.range.isInSingleBlock()&&k.isInSingleBlock()&&(m=f.range.getStartBlockRange().block,l=k.getStartBlockRange().block,this._coreEditor.isTable(m)&&l.getId()===m.getId()&&(j=!0)),j&&n&&this._coreEditor.setNoteRange(n),this._postCollabDataCmdExecution(b,f)}finally{this._pendingSentCmdsQueue.length>0?this.sendCachedDataCommand(!1):this.emit(c.DATACMD_NO_PENDING)}return b},b.prototype._dispatchCachedDataCommand=function(){for(var a,b,c=this;c._pendingSentCmdsQueue.length>0&&(e.loggerInst.log("Process: sending cached command from queue"),a=c._pendingSentCmdsQueue[0],this._cmdMergeHandler.mergeLocalCommands(c._pendingSentCmdsQueue),(b=c._sendCollabDataCommand(a,!0))!==d.CustomResultCode.NO_ERROR)&&!a.isLocalExecutedCmd;)e.loggerInst.warn("skip failed-sent command and try next",a),c._pendingSentCmdsQueue.shift();return b},b.prototype._sendCollabDataCommand=function(a,b){var f,g,h,i=this,j=[],k=null,l={},m=i._coreEditor;if(b){if(a.sendingToCollabServerMillis)return e.loggerInst.warn("current cmd has been sent",a),d.CustomResultCode.NO_ERROR;if(a.isLocalExecutedCmd||a.isCollabRedo||a.isCollabUndo)e.loggerInst.log("Update-Range: NoUpdate");else{if(g=i._updateLocalCmdStartRange(a),!a.isValidStartNoteRange())return i.emit(c.DATACMD_FAILURE,d.DataCmdFailureCode.LOCAL_INVALID_STARTRANGE),d.DataCmdFailureCode.LOCAL_INVALID_STARTRANGE;if(g&&i._conflictHandler.isNoteRangeConflict(g,a.name,a.getCollabProps()))return e.loggerInst.log("Do NOT send Conflict Local Command"),a.getCollabProps().errorCode}}if(m.getNoteVersion(),k=a.toCollabJSON())j[0]=k,l.dataCommands=j,e.loggerInst.log("_sendCollabDataCommand(original):",JSON.stringify(l)),this._keyTranslator.encode(l),f=JSON.stringify(l),e.loggerInst.log("_sendCollabDataCommand(compressd):",f),(h=this._wsClient.send(f))===d.CustomResultCode.NO_ERROR&&(a.sendingToCollabServerMillis=Date.now());else{h=d.DataCmdFailureCode.LOCAL_INVALID_CMDJSON;var n={resultCode:h,closeSession:a.isLocalExecutedCmd,message:"无效的命令格式，无法协同"};i.emit(c.DATACMD_FAILURE,n)}return h===d.CustomResultCode.NO_ERROR&&a.isLocalExecutedCmd&&(e.loggerInst.log("Update-Range: set local command as last executed command"),i._setLastOwnExecutedCmd(a)),h},b.prototype._updateLocalCmdStartRange=function(a){var b,c=this;return c._lastOwnExecCmd?c._lastOwnExecCmd.isLocalExecutedCmd?e.loggerInst.log("Update-Range: last own executed command is local executed"):null!=(b=c._lastOwnExecCmd.getEndingRange())&&(a.setStartingRange(b),e.loggerInst.log("Update-Range: UpdateTo-",b.getStartBlockRange())):e.loggerInst.log("Update-Range: No last own executed command"),b},b.prototype._postCollabDataCmdExecution=function(a,b){var f,g=this,h=(b.collabProperties.cmdSessionId,b.collabProperties.isLocalExecutedCmd),i=b.collabProperties.isOwnCmd;b.collabProperties.cmdJSON;if(i&&(f=g._pendingSentCmdsQueue.shift()),b.collabProperties.dataCmdError){e.loggerInst.error(b.collabProperties.dataCmdError),a&&(a.effected||h)&&(b.collabProperties.errorToClose=!0);var j={resultCode:b.collabProperties.errorCode,closeSession:b.collabProperties.errorToClose,message:b.collabProperties.dataCmdError};return i&&g.emit(c.DATACMD_FAILURE,j),void(null==a&&g._coreEditor.setNoteVersion(b.collabProperties.finalNoteVersion))}if(!a)return void e.loggerInst.error("execCommand should NOT be null when no dataCmdError");if(i&&g._coreEditor.isReadyForEdit()&&(e.loggerInst.log("clear sendingToCollabServerMillis:",a,f),a.sendingToCollabServerMillis=null,f.sendingToCollabServerMillis=null,e.loggerInst.log("Process: Dequeue Command(len:"+g._pendingSentCmdsQueue.length+")")),a.setCmdFinalNoteVersion(g._coreEditor.getNoteVersion()),!i&&a.effected&&(g._redoundoHandler.pushNotOwnExecCmd(a),g._lastNotOwnExecCmd=a),i){var k={resultCode:d.CustomResultCode.NO_ERROR,rawCollabJSON:b.collabProperties.rawWSMessage};g.emit(c.DATACMD_SUCCESS,k),h||g._setLastOwnExecutedCmd(a)}g._blockLockHandler.updateLockByDataCmd(a)},b.prototype._setLastOwnExecutedCmd=function(a){this._lastOwnExecCmd=a},b.prototype._executeDataCommand=function(a,b){var c=this,d=b.collabProperties.cmdJSON,f=d.isCollabUndo,g=d.isCollabRedo;return e.loggerInst.log("Executing "+a),f||g?c._redoundoHandler.applyCollabRedoUndo(a,b):c._coreEditor.execCommand(a,b)},b.prototype._validateCollabDataCmd=function(a,b){var c,g=b.collabProperties,h=g.cmdJSON,i=this._coreEditor.getNoteVersion(),j=g.finalNoteVersion,k=!this._coreEditor.isReadyForEdit(),l=g.isLocalExecutedCmd,m=!0,n=h.startNoteRange;return e.loggerInst.log("Executing Validation Enter"),k?0===j?(m=!1,e.loggerInst.log("Executing Validation - ignore cmd whose finalVersion is 0")):e.loggerInst.log("Executing Validation - executing unsaved cmd"):f.Utils.isCmdVersionMatchNoteVersion(j,i)?l||(c=this._coreEditor.buildNoteRangeFromJSON(n),g.isOwnCmd||(m=!this._conflictHandler.isConflictWithOwnLockedBlock(c,h.action,b)),m&&(h.isCollabUndo||h.isCollabRedo?(m=this._redoundoHandler.ValidateCollabRedoUndo(h.affectedBlockIds,h.cmdNoteVersion))||(g.errorToClose=!0,g.errorCode=d.DataCmdFailureCode.COLLAB_DIRTY_BLOCKS,g.dataCmdError="协同：目标区域已经被修改，不能撤销或重做"):m=!this._conflictHandler.isNoteRangeConflict(c,h.action,g))):(m=!1,g.errorToClose=!0,g.errorCode=d.DataCmdFailureCode.COLLAB_NOTEVERSION_MISMATCH,g.dataCmdError="命令对应版本和本地笔记版本不匹配:("+i+"/"+j+")"),e.loggerInst.log("Executing Validation Exit"),m},b}(b.YEvent);return a.DataCmdHandler=g,a}(yne_DataCmdHandler,yne_YEvent,yne_YEventNames,yne_DataTypes_DataTypes,yne_ExternalLibs,yne_Utils),yne_CollabEngine=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return function(a){function d(d,e,f){var g=a.call(this)||this;if(g._localCmdPerSec=0,null==e)throw"Missing underscorejs";if(null==f)throw"Missing logger instance";return c.ExternalLibs.setUnderscore(e),c.ExternalLibs.setLogger(f),g._isLocalCmdTooFast=!1,g._sessionInitDone=!1,g._coreEditor=d,g._clientId=g._coreEditor.getClientId(),g._keyTranslator=new m.CollabKeyTranslator,g._collabPropsHandler=new o.CmdCollabPropsHandler(g._clientId,g._keyTranslator,g._coreEditor),g._wsClient=new b.WebSocketClient(g._collabPropsHandler),g._cmdMergeHandler=new l.CmdMergeHandler,g._nondataCmdHandler=new n.NonDataCmdHandler(g._wsClient),g._sessionHandler=new h.CollabSessionHandler(g._clientId,g._nondataCmdHandler),g._blockLockHandler=new p.BlockLockHandler(g._clientId,g._sessionHandler,g._nondataCmdHandler),g._conflictHandler=new j.CollabConfilctHandler(g._coreEditor,g._blockLockHandler),g._redoundoHandler=new k.RedoUndoHandler(g._coreEditor,g._blockLockHandler),g._dataCmdHandler=new i.DataCmdHandler(g._coreEditor,g._blockLockHandler,g._conflictHandler,g._redoundoHandler,g._cmdMergeHandler,g._keyTranslator,g._wsClient),g._createEventEmitter(),g}return __extends(d,a),d.prototype.buildCollabProperties=function(a){return this._collabPropsHandler.buildCollabProperties(a)},d.prototype.buildCollabSession=function(a,b){var d,g,h=this,i={resultCode:f.CustomResultCode.NO_ERROR};a.sessionId=h._clientId,b=b||function(){},null!=h._callback_buildCollabSession&&(i.resultCode=f.CustomResultCode.STOP_CALL,i.message="StopPreviousCall",h._callback_buildCollabSession(i)),h._callback_buildCollabSession=function(a){clearTimeout(h._timeout_buildCollabSession),h._wsClient.off(e.SESSION_INIT_BUILT,d),h._wsClient.off(e.WS_CLOSED,g),b(a)};try{g=function(a){c.loggerInst.log("WS_CLOSED Callback in buildCollabSession"),h._callback_buildCollabSession(a)},h._wsClient.once(e.WS_CLOSED,g),d=function(a){c.loggerInst.log("SESSION_INIT_BUILT Callback in buildCollabSession"),h._callback_buildCollabSession(a)},h._nondataCmdHandler.once(e.SESSION_INIT_BUILT,d),this._wsClient.connect(a),this._timeout_buildCollabSession=setTimeout(function(){var a={resultCode:f.CustomResultCode.TIME_OUT};a.message="TimeOut",h._callback_buildCollabSession(a)},5e3)}catch(a){i.resultCode=f.CustomResultCode.EXCEPTION,i.message=a.message||a,h._callback_buildCollabSession(i)}},d.prototype.closeCollabSession=function(a,b,c){var d={resultCode:f.CustomResultCode.NO_ERROR};c=c||function(){};try{this._wsClient.close(a,b),this._blockLockHandler.destroy(),this._blockLockHandler=null,this._collabPropsHandler.destroy(),this._collabPropsHandler=null,this._conflictHandler.destroy(),this._conflictHandler=null,this._cmdMergeHandler.destroy(),this._cmdMergeHandler=null,this._dataCmdHandler.destroy(),this._dataCmdHandler=null,this._nondataCmdHandler.destroy(),this._nondataCmdHandler=null,this._redoundoHandler.destroy(),this._redoundoHandler=null,this._sessionHandler.destroy(),this._sessionHandler=null}catch(a){d.resultCode=f.CustomResultCode.EXCEPTION,d.message=a.message||a}c(d)},d.prototype.isLastOwnDataCmdExecuted=function(){return this._dataCmdHandler.isLastOwnCmdExecuted()},d.prototype.sendContentSetInfo=function(a,b){var c=this,d={resultCode:f.CustomResultCode.NO_ERROR,result:g.ConstValueInJSON.SESSION_INIT_DONE,collabId:this._wsClient.getCollabId(),sessionId:this._wsClient.getSessionId(),nickname:this._wsClient.getNickname(),userId:this._wsClient.getUserId(),isReadOnly:this._wsClient.isReadOnlySession()},h={};b=b||function(){},null!=c._callback_sendContentSetInfo&&(d.resultCode=f.CustomResultCode.STOP_CALL,d.message="StopPreviousCall",c._callback_sendContentSetInfo(d)),c._callback_sendContentSetInfo=function(a){clearTimeout(c._timeout_sendContentSetInfo),c._nondataCmdHandler.off(e.SESSION_INIT_DONE,c._callback_sendContentSetInfo),b(a)},c._coreEditor.isNoteValidForCollab()?(h.noteVersion=a,c._nondataCmdHandler.once(e.SESSION_INIT_DONE,c._callback_sendContentSetInfo),c._nondataCmdHandler.sendCollabNonDataCommand(f.CmdNames.NONDATACMD_CLINTPONG,h),c._timeout_sendContentSetInfo=setTimeout(function(){d.resultCode=f.CustomResultCode.TIME_OUT,null!=c._callback_sendContentSetInfo&&c._callback_sendContentSetInfo(d)},5e3)):(d.result=g.ConstValueInJSON.SESSION_INIT_INVALID,c._callback_sendContentSetInfo(d))},d.prototype.getCollabContent=function(a){var b=this,c={resultCode:0},d=function(c){c.resultCode===f.CustomResultCode.NO_ERROR&&(c.version=b._coreEditor.getNoteVersion(),c.content=b._coreEditor.getXmlContent(),c.sessionCount=b._sessionHandler.getSessionCount()),null!=b._callback_getCollabContent&&b._dataCmdHandler.off(e.DATACMD_NO_PENDING,b._callback_getCollabContent),b._callback_getCollabContent=null,clearTimeout(b._timeout_getCollabContent),a(c)};return a=a||function(){},b._coreEditor.isSettingContent()?(c.resultCode=0,d(c)):b._dataCmdHandler.hasPendingCmds()?b._wsClient.isOpened()?(c.resultCode=0,null==b._callback_getCollabContent&&(b._callback_getCollabContent=function(a){null==a&&(a={resultCode:f.CustomResultCode.NO_ERROR}),d(a)},b._dataCmdHandler.once(e.DATACMD_NO_PENDING,b._callback_getCollabContent),b._timeout_getCollabContent=setTimeout(function(){c.resultCode=f.CustomResultCode.TIME_OUT,c.message="TimeOut",null!=b._callback_getCollabContent&&b._callback_getCollabContent(c)},5e3))):(c.resultCode=f.WSCustomCode.COLLAB_SESSION_CLOSED,d(c)):(c.resultCode=f.CustomResultCode.NO_ERROR,d(c)),c},d.prototype.getModifiers=function(a,b){var c=this,d={status:0,resultCode:f.CustomResultCode.NO_ERROR};return b=b||function(){},null!=c._callback_getModifiers&&(d.resultCode=f.CustomResultCode.STOP_CALL,d.status=2,d.message="StopPreviousCall",c._callback_getModifiers(d)),c._callback_getModifiers=function(a){c._nondataCmdHandler.off(e.NONDATACMD_MODIFIERS_RESULT,c._callback_getModifiers),c._callback_getModifiers=null,clearTimeout(c._timeout_getModifiers),b(a)},d=c._nondataCmdHandler.getModifiers(a),0!==d.status?(b(d),d):(c._nondataCmdHandler.once(e.NONDATACMD_MODIFIERS_RESULT,c._callback_getModifiers),c._timeout_getModifiers=setTimeout(function(){null!=c._callback_getModifiers&&(d.resultCode=f.CustomResultCode.TIME_OUT,d.status=2,d.message="TimeOut",c._callback_getModifiers(d))},5e3),d)},d.prototype.saveNotification=function(a,b){var c=this,d={};d.noteVersion=a,d.isHistorySave=!!b,c._nondataCmdHandler.sendCollabNonDataCommand(f.CmdNames.NONDATACMD_NOTESAVE,d)},d.prototype.getLastNotOwnExecCmd=function(){return this._dataCmdHandler.getLastNotOwnExecCmd()},d.prototype.getMyOwnBlockIds=function(){return this._blockLockHandler.getOwnBlockIds()},d.prototype.sendOwnLockInfo=function(a){var b={};b.lockedBlockId=a,b.sessionId=this._clientId,this._nondataCmdHandler.sendCollabNonDataCommand(f.CmdNames.NONDATACMD_COLLABINFO,b)},d.prototype.sendCachedDataCmd=function(a){this._dataCmdHandler.sendCachedDataCommand(a)},d.prototype.hasCachedDataCmd=function(){return this._dataCmdHandler.hasPendingCmds()},d.prototype.pushLocalDataCommand=function(a,b){var c=this,e=f.CustomResultCode.NO_ERROR;return e=this._dataCmdHandler.pushLocalDataCommand(a,b),e===f.CustomResultCode.NO_ERROR&&1===this._dataCmdHandler.getCachedCmdCount()&&(c._checkCommandSendDelay(),c._updateCmdSpeed(!0)),e===f.CustomResultCode.NO_ERROR&&a.isLocalExecutedCmd&&++c._localCmdPerSec>d.LACAL_CMD_SPEED_LIMITATION&&(c._isLocalCmdTooFast=!0),e},d.prototype.isValidLocalDataCmd=function(a){var b=this,c=!0,d={resultCode:f.CustomResultCode.NO_ERROR,closeSession:!1};return c&&(c=b._isLocalCommandTooFast()),c&&!1===a.isReadyToApply&&(d.message="命令不满足执行条件",d.resultCode=f.DataCmdFailureCode.LOCAL_NOT_READY_APPLY,b.emit(e.DATACMD_FAILURE,d),c=!1),c&&!b._wsClient.isOpened()&&(d.resultCode=f.WSCustomCode.SESSION_NOT_OPENED,d.message="协同链接已断开",b.emit(e.DATACMD_FAILURE,d),c=!1),c&&!b._coreEditor.isNoteValidForCollab()&&(d.resultCode=f.DataCmdFailureCode.LOCAL_INVALID_FOR_COLLAB,d.message="笔记不满足协同条件",b.emit(e.DATACMD_FAILURE,d),c=!1),c&&!a&&(d.message="空的本地命令，已被忽略",d.resultCode=f.DataCmdFailureCode.LOCAL_EMPTY_CMD,b.emit(e.DATACMD_FAILURE,d),c=!1),!c||a.isCollabRedo||a.isCollabUndo||(c=!b._isLocalCommandConflict(a)),c&&(a.isCollabRedo||a.isCollabUndo)&&!1===(c=b._redoundoHandler.ValidateLocalRedoUndo(a))&&(d.message="目标区域已经被修改，不能撤销或重做",d.resultCode=f.DataCmdFailureCode.LOCAL_DIRTY_BLOCKS,b.emit(e.DATACMD_FAILURE,d)),c},d.prototype.updateSessionInfos=function(a){this._nondataCmdHandler.sendCollabNonDataCommand(f.CmdNames.NONDATACMD_COLLABINFO,a)},d.prototype.sendMessageToCollabServer=function(a){this._wsClient.send(a)},d.prototype.getCollabId=function(){return this._wsClient.getCollabId()},d.prototype._sendDataCmdFailedMessage=function(a,b){var c={};c.errToClose=b,c.dataCmdErrorCode=a.toString(),this._nondataCmdHandler.sendCollabNonDataCommand(f.CmdNames.NONDATACMD_DATACMDFAILED,c)},d.prototype._createEventEmitter=function(){var a=this;a._wsClient.on(e.WS_CLOSED,function(b){a.emit(e.WS_CLOSED,b)}),a._nondataCmdHandler.on(e.SESSION_INIT_BUILT,function(b){a.emit(e.SESSION_INIT_BUILT,b)}),a._nondataCmdHandler.on(e.SESSION_INIT_DONE,function(b){a._sessionInitDone=!0,a.emit(e.SESSION_INIT_DONE,b)}),a._sessionHandler.on(e.SESSION_CHNAGED,function(b){c.underscoreInst.each(b,function(b){if(b.propUpdated){var c=a._blockLockHandler.getLockedBlockIdsBy(b.sessionId);null!=c&&c.length>0&&(b.lockedBlkIds=c)}}),a.emit(e.SESSION_CHNAGED,b)}),a._blockLockHandler.on(e.LOCK_LOCKED,function(b){var c;b.sessionProps&&b.sessionProps.lockedBlkIds&&b.sessionProps.lockedBlkIds.length>0&&(c=b.sessionProps.lockedBlkIds[0]),null!=c&&(b.sessionId===a._wsClient.getSessionId()?a.sendOwnLockInfo(c):a.emit(e.LOCK_LOCKED,b))}),a._blockLockHandler.on(e.LOCK_RELEASED,function(b){b.sessionId!==a._wsClient.getSessionId()&&a.emit(e.LOCK_RELEASED,b)}),a._dataCmdHandler.on(e.DATACMD_FAILURE,function(b){a._sendDataCmdFailedMessage(b.resultCode,b.closeSession),a.emit(e.DATACMD_FAILURE,b)}),a._dataCmdHandler.on(e.DATACMD_SUCCESS,function(b){a.emit(e.DATACMD_SUCCESS,b)})},d.prototype._checkCommandSendDelay=function(){!this._isLocalCmdTooFast&&null!=this._dataCmdHandler&&this._dataCmdHandler.getCmdDelay()>d.MAX_CMD_DELAY_MILLIS?this._wsClient.close(f.WSCustomCode.FAILED_SEND_LOCAL_CMD,"ExceedMaxSendDelay"):null!=this._dataCmdHandler&&this._dataCmdHandler.getCachedCmdCount()>0&&this._wsClient.isOpened()&&window.setTimeout(this._checkCommandSendDelay.bind(this),d.MAX_CMD_DELAY_MILLIS)},d.prototype._isLocalCommandConflict=function(a){var b=!1,c=a.getStartingRange(),d=a.getCollabProps();if(c&&(b=this._conflictHandler.isNoteRangeConflict(c,a.name,d))){var f={resultCode:d.errorCode,closeSession:d.errorToClose,message:d.dataCmdError};this.emit(e.DATACMD_FAILURE,f)}return b},d.prototype._isLocalCommandTooFast=function(){var a=this,b=!0,c=a._dataCmdHandler.getCachedCmdCount();if(a._isLocalCmdTooFast&&c>0){b=!1,c=a._dataCmdHandler.getCachedCmdCount();var d={resultCode:f.DataCmdFailureCode.LOCAL_CMD_TOO_FAST,message:"命令输入过快，等待执行命令个数："+c,closeSession:!1};a.emit(e.DATACMD_FAILURE,d),a.sendCachedDataCmd(!1)}return b},d.prototype._updateCmdSpeed=function(a){var b,c=this,e=0;null!=c._dataCmdHandler&&(e=c._dataCmdHandler.getCachedCmdCount()),a&&(c._isLocalCmdTooFast=!1),e>0?(b=e/d.LACAL_CMD_SPEED_LIMITATION,b<1&&(b=1),c._localCmdPerSec=0,c._wsClient.isOpened()&&window.setTimeout(c._updateCmdSpeed.bind(c,!1),1e3*b)):c._isLocalCmdTooFast=!1},d.LACAL_CMD_SPEED_LIMITATION=20,d.MAX_CMD_DELAY_MILLIS=4e3,d}(d.YEvent)}(0,yne_WebSocketClient,yne_ExternalLibs,yne_YEvent,yne_YEventNames,yne_DataTypes_DataTypes,yne_DataTypes_ICollabJSON,yne_CollabSessionHandler,yne_DataCmdHandler,yne_CollabConflictHandler,yne_RedoUndoHandler,yne_CmdMergeHandler,yne_CollabKeyTranslator,yne_NonDataCmdHandler,yne_CmdCollabPropsHandler,yne_BlockLockHandler),yne_collaboration_editorCollabExtension=function(a){var b,c,d,e=yne_CollabEngine,f=yne_YEventNames,g=yne_common_constants,h=yne_underscore,i=yne_jtk_core_L,j=yne_common_data_blockTypes,k=yne_common_util_typeConverter,l=yne_common_selection_HeaderFooterRange,m=yne_common_util_platform,n=yne_common_selection_rangeUtil,o=yne_common_selection_blockRangeUtil,p=yne_common_selection_NoteRange,q={};return b={_collabEngine:null,_isSessionInitDone:!1,buildCollabProperties:function(){var a=this,b={};return null!=a._collabEngine?b=this._collabEngine.buildCollabProperties(null):b.coreEditor=a,b.isCollabEnabled=a.isCollabEnabled(),b},buildCollabSession:function(a,b){var c=this,d=a.collabServer,e=a.userInfo;null!=c._collabEngine&&(c._collabEngine.closeCollabSession(),c._collabEngine=null),c._initCollabEngine(),a.collabServer=d.address,a.useWSS=!!d.useWSS,a.nickname=e.nickname,a.userId=e.userId,a.portraitUrl=e.portraitUrl,c._collabEngine.buildCollabSession(a,function(a){1===a.resultCode&&c.trigger("yne-session-built",a.isCollabStarted),b(a)})},closeCollabSession:function(a,b){var c=this;null!=c._collabEngine&&c._collabEngine.closeCollabSession(a,b),c._collabEngine=null},getCollabId:function(){if(null!=this._collabEngine)return this._collabEngine.getCollabId()},getCollabSessionCount:function(){return null!=this._collabEngine?this._collabEngine.getLastNotOwnExecCmd():{status:g.ERRORID_COLLAB_ENGINE_NULL}},getLastNotOwnExecCmd:function(){if(null!=this._collabEngine)return this._collabEngine.getLastNotOwnExecCmd()},getModifiers:function(a,b){return null!=this._collabEngine?this._collabEngine.getModifiers(a,b):{status:g.ERRORID_COLLAB_ENGINE_NULL}},getCollabContent:function(a,b){var c;return null!=this._collabEngine?(b&&(this.isReadOnly()||this._makeReadOnly(!0),this.noteView.removeNote()),c=this._collabEngine.getCollabContent(a),c.status=c.resultCode,c):{status:g.ERRORID_COLLAB_ENGINE_NULL}},hasCachedDataCmd:function(){return null!=this._collabEngine&&this._collabEngine.hasCachedDataCmd()},isLastOwnDataCmdExecuted:function(){if(null!=this._collabEngine)return this._collabEngine.isLastOwnDataCmdExecuted()},isValidLocalDataCmd:function(a){if(null!=this._collabEngine)return this._collabEngine.isValidLocalDataCmd(a)},noteSetNotification:function(){var a=this;null!=a._collabEngine&&a._collabEngine.sendContentSetInfo(a.note.getFileVersion(),function(b){b.result===g.CJSON_INITIALIZE_DONE&&(a._isSessionInitDone=!0),a.trigger("yne-session-initialized",b.result,b)})},pushLocalDataCommand:function(a,b){null!=this._collabEngine&&this._collabEngine.pushLocalDataCommand(a,b)},saveNotification:function(a,b){null!=this._collabEngine&&this._collabEngine.saveNotification(a,b)},sendBlockLockInfo:function(a){null!=this._collabEngine&&this._collabEngine.sendOwnLockInfo(a)},sendCachedDataCommand:function(){null!=this._collabEngine&&this._collabEngine.sendCachedDataCmd(!1)},updateUserInfo:function(a){var b=this,c=b.getEditorProps();null!=a&&(h.extend(c.userInfo,a),null!=b._collabEngine&&b._collabEngine.updateSessionInfos(a))},_initCollabEngine:function(){var a=this;a._isIdleTimeout=!1,a._isSessionInitDone=!1,a._collabEngine=new e(a,h,i),a._collabEngine.on(f.WS_CLOSED,function(b){8e3===b.customCode&&m.IS_PC?a.setIdleTimeout(!0):a.trigger("yne-session-closed",b)}),a._collabEngine.on(f.DATACMD_FAILURE,function(b){a.trigger("yne-useraction-failed",b.message)}),a._collabEngine.on(f.DATACMD_SUCCESS,function(b){a.trigger("yne-datacommand-success",b.rawCollabJSON)}),a._collabEngine.on(f.LOCK_LOCKED,function(b){var c,d=b.sessionProps;null!=d&&null!=d.lockedBlkIds&&d.lockedBlkIds.length>0&&(c=d.lockedBlkIds[0],a._lockBlock(c,d))}),a._collabEngine.on(f.LOCK_RELEASED,function(b){a._unlockBlock(b.unlockedBlockId)}),a._collabEngine.on(f.SESSION_CHNAGED,function(b){null!=b&&b.length>0&&h.each(b,function(b){b.propUpdated&&null!=b.nickname&&null!=b.lockedBlkIds&&b.lockedBlkIds.length>0&&b.sessionId!==a._clientId&&(b.lockUpdated=!0,a._lockBlock(b.lockedBlkIds[0],b))}),a.trigger("yne-collabsession-change",b)})},_lockBlock:function(a,b){var c=this,d=c.note,e=c.getBlockById(a);null==e||c.isTable(e)||d.lockBlock(a,b)},_unlockBlock:function(a){this.note.unlockBlock(a)}},c={applyCollabCmdRedoUndo:function(a){this.controller.cmdManager.applyCollabCmdRedoUndo(a)},buildNoteRangeFromJSON:function(a){return n.buildNoteRangeFromJSON(a,this)},createDataCommand:function(a,b){return this.controller._createCmd(a,b)},dropRedoCmd:function(){this.controller.cmdManager.dropRedoCmd()},dropUndoCmds:function(a,b,c){this.controller.cmdManager.dropUndoCmds(a,b,c)},getClientId:function(){return this._clientId},getDefaultNoteRange:function(){return this.controller.defaultNoteRange()},getInnerBlocksWithEdge:function(a){var b,c,d,e=this;return a&&l.isHeaderFooterRange(a.getStartBlockRange())?[a.getStartBlockRange().block]:(p.isNoteRange(a)&&(b=a.getStartBlockRange().block,c=a.getEndBlockRange().block,d=e.note.getInterBlocks(b,c,!0)),d)},getNextBlockById:function(a){var b=null,c=this.getBlockById(a);return c&&(b=this.note.getNextBlock(c)),b},getNoteVersion:function(){var a=this;return a.note?a.note.getFileVersion():null},getPreBlockById:function(a){var b=null,c=this.getBlockById(a);return c&&(b=this.note.getPreBlock(c)),b},isListItem:function(a){return j.isListItem(a)},isNoteValidForCollab:function(){return this.controller.note.isValidForCollab()},isReadyForEdit:function(){return!0===this._isSessionInitDone},isSettingContent:function(){return!0===this._isSettingContent},isTable:function(a){return j.isTable(a)},isTodo:function(a){return j.isTodo(a)},setNoteVersion:function(a){i.log("SetNoteVersion:"+a),this.note.setFileVersion(a),this.trigger("yne-note-version-change",a)}},d={_isIdleTimeout:null,_recoverNoteRange:null,buildBlockRangeFromJSON:function(a){var b,c,d=this;return a&&a.blockId?(b=a.blockId,c=d.getBlockById(b),c?o.createRangeByBlock({block:c,start:a.startPosition,end:a.endPosition,rect:a.simpleValue1,type:a.simpleValue2}):void i.log("block is NOT existing:",a)):void i.error("The blockRangeJSON.blockId is not valid!")},buildInnerCommandFromJSON:function(a,b){var c=a[g.CJSON_ACTION],d={};return d.collabProperties=h.clone(b.collabProperties),d.collabProperties.cmdJSON=a,this.createDataCommand(c,d)},getBlockById:function(a){return this.note.getBlockById(a)},getEditorProps:function(){return this._editorProps},getNoteProps:function(){return this._noteProps},getNote:function(){return this.note},isCollabEnabled:function(){var a=this;return!(null==a._noteProps||!a._noteProps.isCollabEnabled)},isIdleTimeout:function(){return this._isIdleTimeout},isMyOwnLockedBlock:function(a){var b,c=!1,d=this._getMyOwnBlockId();return null!=a&&null!=d&&""!==d&&(p.isNoteRange(a)&&a.isInSingleBlock()?b=a.getStartBlockRange().getBlockId():o.isBlockRange(a)&&(b=a.getBlockId()),b&&b===d&&!this.isTable(this.getBlockById(b))&&(c=!0)),c},notifyErrorToHost:function(a){this.trigger("yne-useraction-failed",a)},onDocSelectionChange:function(){i.log("TODO: onDocSelectionChange Event")},recoverFromIdleTimeout:function(a){var b,c=this;c._recoverNoteRange=a,c._isIdleTimeout&&c.isCollabEnabled()&&(b={code:0,customCode:8e3,shareKey:c.getCollabId()},this.trigger("yne-session-closed",b))},setIdleTimeout:function(a){var b,c=this,d=c.getNoteRange();a&&(d&&d.isInSingleBlock()&&(b=d.getStartBlockRange().block,this.isTable(b)&&(b.hideTableToolbar(),c.showToolbar())),c.noteView.render(),c.setReadOnly(!0)),c._isIdleTimeout=a},updateEditorOptions:function(a){var b=this;if(b.options||(b.options=a?h.clone(a):{}),a)for(var c in a)a.hasOwnProperty(c)&&("shareKey"===c&&b.options[c]!==a[c]&&(b._isIdleTimeout=!1),b.options[c]=a[c]);b.options.isCollabEnabled=k.parseToBoolean(b.options.isCollabEnabled,!0),b.options.isCollabEnabled||(b._isIdleTimeout=!1),b.options.hideAttendeeHint=k.parseToBoolean(b.options.hideAttendeeHint,!1),b.options.disableBackground=k.parseToBoolean(b.options.disableBackground,!1),b.options.useWSS=k.parseToBoolean(b.options.useWSS,!1),b.options.pageType=k.parseToPageType(b.options.pageType),b.options.sessionId||(b.options.sessionId=b._clientId),b.options.readOnly=k.parseToBoolean(b.options.readOnly,!1),b.options.hasOriginFile=k.parseToBoolean(b.options.hasOriginFile,!1),h.extend(b._editorProps,b.options)},_getMyOwnBlockId:function(){var a=this._collabEngine.getMyOwnBlockIds();return null!=a&&a.length>0?a[0]:null},testSendMsgToCollabServer:function(a){null!=this._collabEngine&&this._collabEngine.sendMessageToCollabServer(a)}},h.extend(q,b,c,d),q}(),yne_common_core_Editor=function(a){var b,c=yne_jtk_core_Class,d=yne_underscore,e=yne_common_constants,f=yne_jtk_core_L,g=yne_backbone,h=yne_common_util_unknownInlineStyles,i=yne_common_data_supportedInlineStyles,j=yne_common_data_Rich2HtmlConvertor,k=yne_common_util_events,l=yne_collaboration_editorCollabExtension,m=yne_collaboration_collabUtils,n=yne_common_util_platform,o=yne_common_util_typeConverter,p=yne_jquery;return b={_isNotSetContent:!0,currentBackground:e.DEFAULT_BACKGROUND,_editorProps:null,_noteProps:null,_clientId:null,_$progressBarContainer:null,_progressBar:null,_contentSetStartTime:null,_getXmlContentTimer:null,_getHtmlContentTimer:null,_contentChanged:null,_isSettingContent:null,initialize:function(){var a=this;a._clientId=m.newGUID(),a._isNotSetContent=!0,a._bindEventsForController(),a.on("background-failed-update",function(b,c){null!=c&&a._updateContainerBackground(c),0===b&&a.trigger("yne-background-failed-update",b)}),a._contentChanged=!1,a._isSettingContent=!1},reset:function(){var a=this,b=a.getNoteViewWrapper();a.controller&&a.controller.reset(),a.noteView&&a.noteView.reset(),a.note&&a.note.reset(),h.reset(),a._isNotSetContent=!0,b&&a.noteView.isInPageMode()&&b.find(".page-break").remove(),null!=a._$progressBarContainer&&a._$progressBarContainer.hide(),null!=a._getHtmlContentTimer&&(clearTimeout(a._getHtmlContentTimer),a._getHtmlContentTimer=null),null!=a._getXmlContentTimer&&(clearTimeout(a._getXmlContentTimer),a._getXmlContentTimer=null),a._contentChanged=!1,a._isSettingContent=!1,a.currentBackground=null},setHtmlContent:function(){},setXmlContent:function(){},getXmlContent:function(a,b){var c,d=this;if(null!=d._getXmlContentTimer&&(clearTimeout(d._getXmlContentTimer),d._getXmlContentTimer=null),!d._isSettingContent||null==a)return c=d.note.toXml(),null!=a&&a({status:1,content:c}),c;b&&(d.isReadOnly()||d._makeReadOnly(!0),d.noteView.removeNote()),d._getXmlContentTimer=setTimeout(d.getXmlContent.bind(d,a,b),100),a({status:0})},getHtmlContent:function(a,b,c){var d,e=this;if(null!=e._getHtmlContentTimer&&(clearTimeout(e._getHtmlContentTimer),e._getHtmlContentTimer=null),!e._isSettingContent||null==b)return d=e.note.toHtml(null,!0===a),null!=b&&b({status:1,content:d}),d;c&&(e.isReadOnly()||e._makeReadOnly(!0),e.noteView.removeNote()),e._getHtmlContentTimer=setTimeout(e.getHtmlContent.bind(e,a,b,c),100),b({status:0})},isLegacyHost:function(){throw"Should be overridden by sub-editor-class"},getPlainContent:function(){return this.note.toPlain()},render:function(){var a=this;null!=a._noteProps&&(a._noteProps.sessionType?(a._noteProps.sessionType=parseInt(a._noteProps.sessionType),1===a._noteProps.sessionType?a.setReadOnly(!0):a.setReadOnly(!1)):a._noteProps.readOnly?a.setReadOnly(!0):a.setReadOnly(!1)),a.isCollabEnabled()||a.updateNoteViewVisibility(!0)},_getTableOnCellEdit:function(a){var b,c=a&&a.isSingleTableSelected();if(c)return b=a.getStartBlockRange(),b&&b.isOnCellEdit&&b.isOnCellEdit()?b.block:void 0},execCommandByToolbar:function(a,b){var c,d,e=this,f=e.getNoteRange(),g=e._getTableOnCellEdit(f);g&&(c=e.noteView.getBlockViewByBlock(g))&&c.editCellFromToolbar&&(d=c.editCellFromToolbar(a,b)),d||("undo"===a?e.undo():"redo"===a?e.redo():e.execCommand(a,b))},execCommand:function(a,b){return this.controller.execCommand(a,b)},undo:function(){return this.controller.undo()},redo:function(){
return this.controller.redo()},canUndo:function(){return this.controller.canUndo()},canRedo:function(){return this.controller.canRedo()},countWords:function(a){var b=this,c=b.getNoteRange();return b.note.countWords(c,a)},selectAll:function(){return this.controller.selectAll()},setReadOnly:function(a){var b=this;a=!!a,b._noteProps.isReadOnly=a,b._makeReadOnly(a)},isReadOnly:function(){return this.controller.isReadOnly()},getNoteRange:function(){return this.controller.getNoteRange()},setNoteRange:function(a){this.controller.noteSelection.setRange(a)},getSchemaVersion:function(){return this.note.getSchemaVersion()},highlight:function(a,b){var c=this,d=c.note;d&&d.highlight(a,b)},clearHighlight:function(){var a=this,b=a.note;b&&b.highlight("")},nextHighlight:function(){var a=this,b=a.note;b&&b.nextHighlight()},preHighlight:function(){var a=this,b=a.note;b&&b.preHighlight()},setFont:function(a,b){if(a||b){var c,d=this,e={};a&&(c=i.getDefault("font-size"),e["font-size"]=function(b){var d=b["font-size"];if(null!=d)return Math.round(a*d/c)+"px"},j.setCssRules(e)),b&&(i.setDefault("font-family",b),j.resetInlineStyleDefaultForHtml("font-family")),d.noteView.reRenderTextBlockView()}},resetFont:function(){var a=this;j.resetCssRules(),i.reset(),a.noteView.reRenderTextBlockView()},focus:function(){this.noteView.$el.focus()},setBackground:function(a){var b=this,c=b.currentBackground;b._updateContainerBackground(a)&&b.trigger("set-background",c,a)},updateBackground:function(a){var b=this,c=b.currentBackground;b._updateContainerBackground(a)&&(c||(c=e.DEFAULT_BACKGROUND),b.trigger("yne-background-changed",c,a))},_updateContainerBackground:function(a){return this.currentBackground=a,f.log("need be overrided by different hosts: Web/PC",a),!1},setAllBackgrounds:function(a,b){var c=this;c.trigger("set-all-backgrounds",d.clone(a),b),c.currentBackground=e.DEFAULT_BACKGROUND},isNotSetContent:function(){return this._isNotSetContent},_bindEventsForController:function(){var a=this,b=a.controller;b.on("command-exec",function(b,c){if(!b||!b.name)return void f.error("The command is not valid",b);a.isCollabEnabled()?(c=c||{},c.collabProperties=c.collabProperties||{},c.collabProperties.finalNoteVersion&&a.setNoteVersion(c.collabProperties.finalNoteVersion),b&&b.effected&&(!c.collabProperties.isCollabCmd||c.collabProperties.isCollabCmd&&c.collabProperties.isOwnCmd&&!c.collabProperties.isLocalExecutedCmd)&&(a._contentChanged=!0,a.trigger("yne-content-change"))):b&&b.effected?(a._contentChanged=!0,a.trigger("yne-content-change")):f.warn("The command has no effected",b)}),k.bubble(["redo-stack-change","undo-stack-change","selectstart","mouse-down","command-exec","esc","yne-clipboard-status","yne-clipboard-error","yne-get-clipboard","yne-clipboard-set","color-picker-show","yne-user-action-collection","cell-edit-view-enter","cell-edit-view-exit","cell-edit-view-history-change"],b,a)},querySelectionInlineStyle:function(a){return this.controller.querySelectionInlineStyle(a)},querySelectionBlockStyle:function(a){return this.controller.querySelectionBlockStyle(a)},querySelectionInlineStyles:function(){return this.controller.querySelectionInlineStyles()},querySelectionBlockStyles:function(){return this.controller.querySelectionBlockStyles()},setPasteAsText:function(a){this.controller.setPasteAsText(a)},insertImage:function(a){return this.controller.insertImage(a)},insertAttachment:function(a){return this.controller.insertAttachment(a)},rerenderNoteView:function(){this.noteView.render()},resetEditingInlineStates:function(){return this.controller.resetEditingInlineStates()},updateNoteViewVisibility:function(a){a?this.noteView.$el.css("visibility","visible"):this.noteView.$el.css("visibility","hidden")},getNoteViewWrapper:function(){return null},getNoteViewFrame:function(){return null},setViewMode:function(a,b,c){var d=this;a=n.IS_PC?o.parseToNumber(a,1):o.parseToNumber(a,0),d.updateEditorProps({viewMode:a}),n.IS_PC&&(1===a?p(d._noteViewWrapper).toggleClass("read-mode",!0):p(d._noteViewWrapper).toggleClass("read-mode",!1)),d.noteView.setViewMode(a,!d._isNotSetContent),!0===b&&d.trigger("view-mode-change",a),!0===c&&d.trigger("yne-view-mode-change",a),d.controller.resizeSpecialBlock()},_makeReadOnly:function(a){var b=this;b.controller.setReadOnly(a),n.IS_PC?a?b._toolbar.toggleToolbar(!1):b._toolbar.toggleToolbar(!0):a?b._toolbar.disable():b._toolbar.enable()},updateEditorProps:function(a){null==this._editorProps&&(this._editorProps={}),d.extend(this._editorProps,a),d.extend(this.options,a)},hasHandWriteBlock:function(){return this.note.hasHandWriteBlock()}},d.extend(b,g.Events,l),c.extend(b)}(),yne_common_contextMenu_queryCache=function(a){var b=yne_common_data_blockTypes,c=yne_underscore,d=yne_underscorestring,e=yne_jquery,f=yne_common_selection_NoteRange,g=yne_common_data_table_tableCellType,h=function(a,b){return a=e.trim(a||""),b=e.trim(b||""),!(!a||!b)&&(a===b||(d.startsWith(b,a)||d.endsWith(b,a)||d.startsWith(a,b)||d.endsWith(a,b)))},i={imageBlock:function(a,c,d){var e,f,g=a.getNoteRange();g&&g.isInSingleBlock()&&(e=g.getStartBlockRange(),f=e.block,b.isImage(f)&&(d.imgBlock=f,d.isImgAttachBlock=!0))},attachmentBlock:function(a,c,d){var e,f,g=a.getNoteRange();g&&g.isInSingleBlock()&&(e=g.getStartBlockRange(),f=e.block,b.isAttachment(f)&&(d.attachmentBlock=f,d.isImgAttachBlock=!0))},tableBlock:function(a,d,e){var f,h,i,j,k=a.getNoteRange();if(k&&k.isInSingleBlock()&&(h=k.getStartBlockRange(),j=h.block,b.isTable(j))){if(!(i=h.getAsRectRange()))return;f={},i.onlyMergePointAndCell()&&(f.onlyMergePointAndCell=!0),i.isOnlyImgCell()&&c.extend(f,{cell:i.getFirstCell().cell,type:g.IMAGE}),i.isOnlyAttachCell()&&c.extend(f,{cell:i.getFirstCell().cell,type:g.ATTACHMENT}),e.tableInfo=f}},hrefInfo:function(a,b,c){var d,g,i,j,k,l,m,n,o,p=b.target,q=e(p),r=function(a,b){if(a&&a.parentNode)for(var c=a.parentNode;c;){if(c.webkitMatchesSelector&&c.webkitMatchesSelector(b))return c;c=c.parentNode}};q.is(".block-view a *")&&(d=r(p,"a"))&&(g=document.createRange(),g.selectNodeContents(d),i=f.fromNativeRange(g,a.noteView),g.detach(),i&&i.isInSingleBlock()&&(j=i.getStartBlockRange(),k=j.block,k&&k.getCommonInlineStyle&&(l=k.getCommonInlineStyle("href",j)),l&&(m=j.getDataAsPlain(),n=h(l,m),n&&(o=k.getCommonInlineStyles(j)),c.hrefInfo={noteRange:i,href:l,hrefAsLinkText:n,commonStyles:o})))},isRangeCollapsed:function(a,b,c){var d=a.getNoteRange();d&&(c.isRangeCollapsed=d.isCollapsed())}};return function(a){var b={};return c.each(i,function(c){c(a,event,b)}),b}}(),yne_common_util_attachmentPresentProcess=function(a){var b=yne_jquery,c=yne_underscore,d=yne_common_util_attachmentParse;return{processHtmlContent:function(a){var e=a.attr("title")||a.attr("filename");if(e){var f=a.attr("filelength"),g=b('<div class="attachment-container"></div>'),h=d.getFileType(e),i=d.getSizeString(f),j=d.splitFileFullName(e),k=h?"src--svg--type_"+h+"_large":"src--svg--type_other_large",l=b('<div class="attachment-icon svg-common '+k+'"></div>'),m=b('<div class="attachment-title"><p class="attachment-title-name">'+c.escape(j.fileName)+'</p><p class="attachment-title-type">'+c.escape(j.fileType)+"</p></div>"),n=b('<div class="attachment-size">'+i+"</div>");return g.append(l).append(m).append(n),a.replaceWith(g),g}},elementAppendAttchCss:function(a,b){var c=this,d=function(b){a.append("<style>"+b.css+"</style>")};c._loadAttachCssFile(b,d)},getAttachStyle:function(a,b){var c=this,d=function(b){a.innerTag="<style>"+b.css+"</style>"};c._loadAttachCssFile(b,d)},_loadAttachCssFile:function(a,c){var d=this,e="../css/presenter_attachment.less";window.less?d._loadAttachLessFile(e,a,c):b.ajax({url:"../../../node_modules/less/dist/less.js",async:!1===a}).done(function(){d._loadAttachLessFile(e,a,c)})},_loadAttachLessFile:function(a,c,d){b.ajax({url:a,async:!1===c}).done(function(a){window.less.render(a,{sync:!0===c},function(a,b){d(b)})})}}}(),yne_pc_presenter_Presenter=function(a){var b=yne_jquery,c=yne_underscore,d=yne_common_constants,e=yne_jtk_core_L,f=yne_jtk_core_Base,g=yne_common_jst,h=yne_common_key_keyCodeMap,i=yne_common_util_attachmentPresentProcess,j=yne_collaboration_collabUtils;return f.extend({_contentDoc:null,_contentWin:null,initialize:function(a){var d,f,h,i=this;c.isUndefined(a.el)&&e.error("options.el is needed"),d=i.$el=b(a.el),f=g.render("pc","presenter_page",{}),d.hide().html(f),h=d.find("iframe")[0],i._contentDoc=h.contentDocument,i._contentWin=h.contentWindow,i._insertNoteCss(),i._bindEvents()},_insertNoteCss:function(){var a=this,c=[];!0===e.DEBUG?(c=["../css/presenter_note.css"],i.elementAppendAttchCss(b("head",a._contentDoc))):c=["./presenter_note.css","./presenter.css"],a._loadCssFile(c,0,function(c){b("head",a._contentDoc).append("<style>"+c+"</style>")})},_loadCssFile:function(a,c,d){var e=this,f=a[c];f&&b.ajax({url:f,dataType:"text"}).done(function(b){d(b),c++,e._loadCssFile(a,c,d)}).fail(function(){c++,e._loadCssFile(a,c,d)})},_bindEvents:function(){var a=this,c=b("body",a._contentDoc);a.$el.find(".demo-mode-icon").on("click",a._onClick.bind(a)),c.delegate("a","click",function(c){var d,e,f=b(c.currentTarget);if("catalogue"===f.parent().attr("yne-bulb-block")&&(e=f.attr("href"),/^#/.test(e)&&j.isGUID(e.replace(/^#/,"")))){try{d=c.currentTarget.ownerDocument.defaultView,d.location.hash=e,d.location.hash="#!"}catch(a){}return c.preventDefault(),void c.stopPropagation()}f.attr("target","_blank"),a.trigger("open-link",f[0].href)}),c.delegate("img","click",function(c){var d=b(c.currentTarget);if(!d.attr("path"))return void b(document.activeElement).blur();a.trigger("open-attachment",d.attr("path"),d.attr("filename"))}),c.on("keydown",a._escKeyHandler.bind(a)),b(document).on("keydown",a._escKeyHandler.bind(a))},_processAttachment:function(){var a=this,c=b("body",a._contentDoc);b('img[data-media-type="attachment"]',c).each(function(c,d){var e=b(d);i.processHtmlContent(e).click(function(){if(!e.attr("path"))return void b(document.activeElement).blur();a.trigger("open-attachment",e.attr("path"),e.attr("filename"))})})},_processImage:function(){var a=this,c=b("body",a._contentDoc);b('img[data-media-type="image"]',c).each(function(a,c){var d,e=b(c);e.attr("alt")&&(d=document.createElement("div"),d.className="img-title",d.appendChild(document.createTextNode(e.attr("alt"))),e.after(d)),e.parent().css("padding","5px 0")})},_render:function(a,c){var d=this,e=b("body",d._contentDoc),f=g.render("pc","presenter_article",{content:c,title:a});e.empty().append(f),e.find("article").css("zoom",1.5)},_onClick:function(a){var c=this;switch(b(a.target).data("action")){case"zoom-in":c.zoomIn();break;case"zoom-out":c.zoomOut();break;case"esc":c._exitFullscreen()}},_close:function(a){var b=this;a&&b.exit()},enter:function(a,c,e){var f,g=this,h=document.documentElement,i=h.requestFullScreen||h.webkitRequestFullScreen||h.mozRequestFullScreen;f=e&&e!==d.DEFAULT_BACKGROUND?'url("'+e+'")':"",g.$el.find(".demo-page").css("background-image",f),i.call(h),g._render(a,c),b("body").addClass("presentation"),g._processAttachment(),g._processImage(),g.$el.show(),b("body",g._contentDoc).focus(),g._contentWin.scrollTo(0,0)},exit:function(){var a=this;a.$el.hide(),b("body").removeClass("presentation"),a.trigger("exit")},zoomIn:function(){var a,d=this,e=b("article",d._contentDoc);c.isUndefined(e)||0===e.length||(a=Number(e.css("zoom")))>=3||(a+=.25,a>3&&(a=3),e.css("zoom",a))},zoomOut:function(){var a,d=this,e=b("article",d._contentDoc);c.isUndefined(e)||0===e.length||(a=Number(e.css("zoom")))<=1||(a-=.25,a<1&&(a=1),e.css("zoom",a))},_exitFullscreen:function(){var a=this;document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen(),a._close(a.isPresenting())},isPresenting:function(){return b("body").hasClass("presentation")},_escKeyHandler:function(a){var b=this;b.isPresenting()&&a&&!a.ctrlKey&&!a.metaKey&&!a.shiftKey&&h.isMatch("esc",a.keyCode)&&b._exitFullscreen()}})}(),yne_common_views_LinkView=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst,f=yne_common_key_keyCodeMap,g=yne_common_util_platform,h=yne_common_data_blockTypes,i=yne_common_util_xssFilter,j=yne_common_selection_NoteRange;return b.View.extend({className:"link-view",templateName:"link_view",zoom:1,events:{"click .link-confirm-button":"onConfirmButtonClick","click .link-modify-button":"onModifyButtonClick","click .link-remove-button":"onRemoveButtonClick","keydown .link-input":"onKeyDown",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},initialize:function(a){var b=this;b.editor=a.editor,b.on("link-menu-show",b.timeoutToShowMenu),b.on("link-menu-hide",b.timeoutToHideMenu),b.bindDocumentEvents(),b.modifyMode=!1,b.on("locked-change",b.recalPosition),d(window).on("resize",b.recalPosition.bind(b))},render:function(){var a,b=this,c=b.$el;a=e.render("common",b.templateName,{link:i.safeHref(b.link),isReadOnly:b.editor.isReadOnly()}),c.html(a),b.menuPreviewLink=c.find(".hover-menu-show-link"),b.menuModifyLink=c.find(".hover-menu-modify-link"),b.input=c.find(".link-input"),b.hideModifyMenu()},bindDocumentEvents:function(){var a=this;c.bindAll(a,"onDocumentMouseDown"),d(document).on("mousedown",a.onDocumentMouseDown)},onKeyDown:function(a){var b=this;a.stopPropagation(),f.isMatch("enter",a.keyCode)&&(a.preventDefault(),b.onConfirmButtonClick())},onDocumentMouseDown:function(){this.fadeOutMenu()},onMouseDown:function(a){a.stopPropagation()},onConfirmButtonClick:function(){var a=this,b=a.range,c=i.safeHref(d(a.input).val());if(c===a.link)return void a.fadeOutMenu();window.focus(),c&&a.editor.execCommand("comp.InsertLink",{src:c,range:b}),a.fadeOutMenu()},onRemoveButtonClick:function(){var a=this,b=a.range,c={href:"",color:"#393939",underline:!1};h.isCatalogue(a.block)?a.editor.execCommand("atom.SetCatalogueHref",{range:b,block:a.block,href:null}):a.editor.execCommand("comp.ApplyStyles",{range:b,inlineStyles:c}),a.fadeOutMenu()},onModifyButtonClick:function(){var a=this;a.hidePreviewMenu(),a.showModifyMenu()},showMenu:function(a){var b=this,c=a.range.clone(),d=a.linkNode.href;if(h.isCatalogue(a.block)&&(d=a.block.getViewHref()),!b.modifyMode&&d){var e=new RegExp("^note://");d.match(e)||(b.hideTimerId&&(clearTimeout(b.hideTimerId),b.hideTimerId=null),b.link&&b.hideMenu(),b.linkNode=a.linkNode,b.link=d,b.block=a.block,b.blockId=a.block.getId(),b.range=new j({startRange:c,endRange:c}),b.render(),b.showPreviewMenu())}},recalPosition:function(){var a=this;a.link&&a.modifyMode&&a.setPosition()},setPosition:function(){var a,b,e,f,h,i,j,k,l,m,n,o,p,q=this,r=q.linkNode,s=15,t=30,u=q.editor.noteView,v=q.editor.getNoteViewWrapper(),w=this.editor.getNoteViewWrapper(),x=g.IS_PC?this.editor.getNoteViewFrame().offset():this.editor.noteView.$el.offset();a=d(r).offset(),a.left=a.left-w.offset().left+w.scrollLeft()/q.zoom,a.top=a.top-x.top,b=a.top+d(r).outerHeight(),e=a.left+d(r).outerWidth()/2,j=a.left,n=q.$el.find(".hover-menu-before"),h=d(n[0]).outerWidth()/2,i=d(n[0]).outerHeight(),k=b+i,e-j-h<s&&(j=e-s-h),l=q.modifyMode?q.$el.find(".hover-menu-modify-link .hover-menu-body").outerWidth():q.$el.find(".hover-menu-show-link .hover-menu-body").outerWidth(),m=u.$el.outerWidth()-t,v.hasClass("read-mode")&&(m+=parseInt(v.find(".note-view-frame").css("margin-left"))),j+l>m&&(j=m-l),f=e-j-h,o=d(r).outerHeight(),p=parseFloat(d(r).css("line-height")),o>p&&(j=a.left-s-h,f=s),q.$el.css("left",j),q.$el.css("top",k),c.each(n,function(a){d(a).css("left",f)})},setZoom:function(a){var b=this;b.zoom=a,b.$el.css("zoom",b.zoom)},showPreviewMenu:function(){var a=this,b=a.menuPreviewLink;a.setPosition(),d(b).show()},hidePreviewMenu:function(){var a=this,b=a.menuPreviewLink;d(b).hide()},fadeOutPreviewMenu:function(){var a=this,b=a.menuPreviewLink;d(b).fadeOut()},showModifyMenu:function(){var a=this,b=a.menuModifyLink;a.modifyMode=!0,a.editor.controller.lockBlockById(a.blockId),a.setPosition(),d(b).show()},hideModifyMenu:function(){var a=this,b=a.menuModifyLink;d(b).hide(),a.modifyMode=!1},fadeOutModifyMenu:function(){var a=this,b=a.menuModifyLink;d(b).fadeOut(),a.modifyMode=!1},hideMenu:function(){var a=this;a.stay||(a.hideModifyMenu(),a.hidePreviewMenu(),a.link=null)},fadeOutMenu:function(){var a=this;a.fadeOutModifyMenu(),a.fadeOutPreviewMenu(),a.link=null,a.range=null,a.linkNode=null,a.hideTimerId=null,a.blockId=null,a.block=null,a.showTimerId&&(clearTimeout(a.showTimerId),a.showTimerId=null)},onMouseEnter:function(a){var b=this;a.stopPropagation(),b.hideTimerId&&(clearTimeout(b.hideTimerId),b.hideTimerId=null)},onMouseLeave:function(){this.trigger("link-menu-hide")},timeoutToHideMenu:function(){var a=this;a.modifyMode||a.hideTimerId||(a.hideTimerId=setTimeout(function(){a.fadeOutMenu()},100))},timeoutToShowMenu:function(a){var b=this;b.showTimerId||(b.showTimerId=setTimeout(function(){b.showMenu(a)},500))}})}(),yne_common_views_ColorPicker=function(a){var b=yne_backbone,c=yne_underscore,d=yne_jquery,e=yne_common_jst,f=yne_tinycolor,g=yne_common_key_keyCodeMap,h=200,i=150,j=[["r","g","b"],["h","s","v"],["h","s","l"]],k=[[255,255,255],[360,100,100],[360,100,100]];return b.View.extend({className:"color-picker",name:"colorpicker",label:"选色器",templateName:"color_picker",events:{mousedown:"onMouseDown","mousedown .color-picker-panel":"onPanelMouseDown","mousedown .color-picker-panel-board":"onBoardMousedown","mousedown .color-picker-panel-alpha":"onAlphaMousedown","mousedown .color-picker-panel-ribbon":"onRibbonMousedown","click .color-picker-panel-params-lable-number":"onParamsLabelClick"},initialize:function(a){var b=this;b.editor=a.editor,b.render(),b.hidePicker(),b.mode=0,c.bindAll(b,"onDocumentMouseDown","onBoardMousedown","onBoardDrag","onBoardDragEnd","onAlphaMousedown","onAlphaDrag","onAlphaDragEnd","onRibbonMousedown","onRibbonDrag","onRibbonDragEnd","onParamsLabelClick"),b.on("color-picker-show",b.showPicker),d(document).on("mousedown",b.onDocumentMouseDown)},render:function(){var a,b=this,c=b.$el;a=e.render("common",b.templateName),c.html(a),b.panel=c.find(".color-picker-panel")[0],b.board=c.find(".color-picker-panel-board")[0],b.boardBg=d(b.board).find(".color-picker-panel-board-hsv"),b.ribbon=c.find(".color-picker-panel-ribbon")[0],b.alpha=c.find(".color-picker-panel-alpha")[0],b.preview=c.find(".color-picker-panel-preview")[0],b.inputs=c.find(".color-picker-panel-params-input"),b.inputHex=d(b.inputs).find("input")[0],b.inputR=d(b.inputs).find("input")[1],b.inputG=d(b.inputs).find("input")[2],b.inputB=d(b.inputs).find("input")[3],b.inputA=d(b.inputs).find("input")[4],b.labelR=c.find(".color-picker-panel-params-lable-number")[0],b.labelG=c.find(".color-picker-panel-params-lable-number")[1],b.labelB=c.find(".color-picker-panel-params-lable-number")[2],b.bindEvents()},bindEvents:function(){var a=this;c.bindAll(a,"onHexChange","onRedChange","onGreenChange","onBlueChange","onAlphaChange","updateInputHex","updateInputR","updateInputG","updateInputB","updateInputA","onKeyDown","onLastInputKeyDown"),d(a.inputHex).on("input propertychange",a.onHexChange),d(a.inputHex).on("blur",a.updateInputHex),d(a.inputHex).on("keydown",a.onKeyDown),d(a.inputR).on("input propertychange",a.onRedChange),d(a.inputR).on("blur",a.updateInputR),d(a.inputR).on("keydown",a.onKeyDown),d(a.inputG).on("input propertychange",a.onGreenChange),d(a.inputG).on("blur",a.updateInputG),d(a.inputG).on("keydown",a.onKeyDown),d(a.inputB).on("input propertychange",a.onBlueChange),d(a.inputB).on("blur",a.updateInputB),d(a.inputB).on("keydown",a.onKeyDown),d(a.inputA).on("input propertychange",a.onAlphaChange),d(a.inputA).on("blur",a.updateInputA),d(a.inputA).on("keydown",a.onLastInputKeyDown)},showPicker:function(a){var b=this,c=b.solidColor(a.selectedValue);c.isValid()||(c=b.solidColor(a.value)),c.isValid()||(c=f("#393939")),b.color=c,b.mode=0,b.item=a,b.$el.show(),b.updateUI()},solidColor:function(a){var b=f(a),c=b.toRgb();return 0===c.r&&0===c.g&&0===c.b&&0===c.a&&b.setAlpha(1),b},hidePicker:function(){var a,b=this;b.removeWindowListeners(),b.$el.hide(),b.item&&(a=b.color.toRgbString(),b.item.changeValue(a),b.item=null)},removeWindowListeners:function(){var a=this;d(window).off("mousemove",a.onBoardDrag),d(window).off("mouseup",a.onBoardDragEnd),d(window).off("mousemove",a.onAlphaDrag),d(window).off("mouseup",a.onAlphaDragEnd),d(window).off("mousemove",a.onRibbonDrag),d(window).off("mouseup",a.onRibbonDragEnd)},onDocumentMouseDown:function(){this.hidePicker()},onMouseDown:function(a){this.hidePicker(),a.stopPropagation(),a.preventDefault()},onPanelMouseDown:function(a){a.stopPropagation()},onBoardMousedown:function(a){var b=this;b.onBoardDrag(a),b.removeWindowListeners(),d(window).on("mousemove",b.onBoardDrag),d(window).on("mouseup",b.onBoardDragEnd)},onBoardDrag:function(a){var b=this,c=a.clientX,d=a.clientY;a.preventDefault(),b.pointMoveTo({x:c,y:d})},onBoardDragEnd:function(a){var b=this;b.onBoardDrag(a),b.removeWindowListeners()},pointMoveTo:function(a){var b,c,e=this,g=e.board.getBoundingClientRect(),j=a.x-g.left,k=a.y-g.top,l=e.color.toHsv(),m=d(e.boardBg).css("background-color"),n=l.h;b=f(m),b.isValid()&&(n=b.toHsv().h),j=Math.max(0,j),j=Math.min(j,h),k=Math.max(0,k),k=Math.min(k,i),c=f.fromRatio({h:n/360,s:j/h,v:1-k/i,a:l.a}),c.isValid()&&(e.color=c,e.updateBoardPoint(j-4,k-4),e.updatePreview(),e.updateAlpha(),e.updateInputHex(),e.updateInputG(),e.updateInputB(),e.updateInputR())},onAlphaMousedown:function(a){var b=this;b.onAlphaDrag(a),b.removeWindowListeners(),d(window).on("mousemove",b.onAlphaDrag),d(window).on("mouseup",b.onAlphaDragEnd)},onAlphaDrag:function(a){var b=this,c=a.clientX,d=a.clientY;a.preventDefault(),b.alphaMoveTo({x:c,y:d})},onAlphaDragEnd:function(a){var b=this;b.onAlphaDrag(a),b.removeWindowListeners()},alphaMoveTo:function(a){var b,c=this,d=c.alpha.getBoundingClientRect(),e=d.width,f=a.x-d.left;f=Math.max(0,f),f=Math.min(f,e),b=f/e,c.color.setAlpha(b),c.updateAlpha(100*b),c.updatePreview(),c.updateInputA()},onRibbonMousedown:function(a){var b=this;b.onRibbonDrag(a),b.removeWindowListeners(),d(window).on("mousemove",b.onRibbonDrag),d(window).on("mouseup",b.onRibbonDragEnd)},onRibbonDrag:function(a){var b=this,c=a.clientX,d=a.clientY;a.preventDefault(),b.ribbonMoveTo({x:c,y:d})},onRibbonDragEnd:function(a){var b=this;b.onRibbonDrag(a),b.removeWindowListeners()},ribbonMoveTo:function(a){var b,c,d=this,e=d.ribbon.getBoundingClientRect(),g=e.width,h=a.x-e.left,i=d.color.toHsv();h=Math.max(0,h),h=Math.min(h,g),b=h/g,c=f.fromRatio({h:b,s:i.s,v:i.v,a:i.a}),c.isValid()&&(d.color=c,d.updateRibbon(100*b),d.updateBoardBg(360*b),d.updatePreview(),d.updateAlpha(),d.updateInputHex(),d.updateInputR(),0===d.mode&&(d.updateInputG(),d.updateInputB()))},onHexChange:function(){var a,b=this,c=d(b.inputHex).val();c.length>0&&c.length<6&&(c=c.concat("0".repeat(6-c.length))),a=f(c),a.isValid()&&(a.setAlpha(b.color.getAlpha()),b.color=a,b.updateOnHexChange())},updateOnHexChange:function(){var a=this;a.updateBoardPoint(),a.updateBoardBg(),a.updatePreview(),a.updateAlpha(),a.updateRibbon(),a.updateInputR(),a.updateInputG(),a.updateInputB()},onRedChange:function(){var a=this,b=d(a.inputR).val(),e=a.mode,g=a.color.toHsv(),h=a.color.toRgb(),i=a.color.toHsl();b=parseInt(b),c.isNumber(b)&&!c.isNaN(b)&&(b<0||b>k[e][0]||(a.color=1===e?f.fromRatio({h:b/360,s:g.s,v:g.v,a:g.a}):2===e?f.fromRatio({h:b/360,s:i.s,l:i.l,a:i.a}):f({r:b,g:h.g,b:h.b,a:h.a}),a.updateOnRedChange()))},updateOnRedChange:function(){var a=this;0===a.mode&&a.updateBoardPoint(),a.updateBoardBg(),a.updatePreview(),a.updateAlpha(),a.updateRibbon(),a.updateInputHex()},onGreenChange:function(){var a=this,b=d(a.inputG).val(),e=a.mode,g=a.color.toHsv(),h=a.color.toRgb(),i=a.color.toHsl();b=parseInt(b),c.isNumber(b)&&!c.isNaN(b)&&(b<0||b>k[e][1]||(a.color=1===e?f.fromRatio({h:g.h,s:b/100,v:g.v,a:g.a}):2===e?f.fromRatio({h:i.h,s:b/100,l:i.l,a:i.a}):f({r:h.r,g:b,b:h.b,a:h.a}),a.updateOnGreenChange()))},updateOnGreenChange:function(){var a=this;a.updateBoardPoint(),0===a.mode&&(a.updateBoardBg(),a.updateRibbon()),a.updatePreview(),a.updateAlpha(),a.updateInputHex()},onBlueChange:function(){var a=this,b=d(a.inputB).val(),e=a.mode,g=a.color.toHsv(),h=a.color.toRgb(),i=a.color.toHsl();b=parseInt(b),c.isNumber(b)&&!c.isNaN(b)&&(b<0||b>k[e][2]||(a.color=1===e?f.fromRatio({h:g.h,s:g.s,v:b/100,a:g.a}):2===e?f.fromRatio({h:i.h,s:i.s,l:b/100,a:i.a}):f({r:h.r,g:h.g,b:b,a:h.a}),a.updateOnBlueChange()))},updateOnBlueChange:function(){var a=this;a.updateBoardPoint(),0===a.mode&&(a.updateBoardBg(),a.updateRibbon()),a.updatePreview(),a.updateAlpha(),a.updateInputHex()},onAlphaChange:function(){var a=this,b=d(a.inputA).val();b=parseInt(b),c.isNumber(b)&&!c.isNaN(b)&&(b<0||b>100||(a.color.setAlpha(b/100),a.updateOnAlphaChange()))},updateOnAlphaChange:function(){var a=this;a.updatePreview(),a.updateAlpha()},onParamsLabelClick:function(){var a=this,b=a.mode;b+=1,b%=3,a.mode=b,a.updateInputR(),a.updateInputB(),a.updateInputG()},onKeyDown:function(a){var b=this;g.isMatch("enter",a.keyCode)&&(a.stopPropagation(),a.preventDefault(),b.hidePicker(),b.editor.focus())},onLastInputKeyDown:function(a){var b=this;(g.isMatch("enter",a.keyCode)||g.isMatch("tab",a.keyCode))&&(a.stopPropagation(),a.preventDefault(),b.hidePicker(),b.editor.focus())},inputValue:function(a,b){var c,d=this,e=d.color,f=e.toRgb(),g=e.toHsv(),h=e.toHsl(),i=1;switch(a){case 0:c=f;break;case 1:c=g;break;case 2:c=h;break;default:c=f}return(0===a||1!==b&&2!==b)&&3!==b||(i=100),Math.round(c[j[a][b]]*i)},updateInputHex:function(){var a=this,b=a.color;d(a.inputHex).val(b.toHex().toUpperCase())},updateInputR:function(){var a=this,b=a.mode;d(a.labelR).text(j[b][0].toUpperCase()),d(a.inputR).val(a.inputValue(b,0))},updateInputG:function(){var a=this,b=a.mode;d(a.labelG).text(j[b][1].toUpperCase()),d(a.inputG).val(a.inputValue(b,1))},updateInputB:function(){var a=this,b=a.mode;d(a.labelB).text(j[b][2].toUpperCase()),d(a.inputB).val(a.inputValue(b,2))},updateInputA:function(){var a=this,b=a.color,c=b.getAlpha();d(a.inputA).val(Math.round(100*c))},updateBoardBg:function(a){var b,c=this,d=c.color,e=d.toHsv(),g=c.boardBg;a>=0&&a<=360||(a=e.h),b=f.fromRatio({h:a/360,s:1,v:1}),g.css("background-color",b.toHexString())},updateBoardPoint:function(a,b){var c=this,e=c.color,f=e.toHsv(),g=d(c.board).find("span");a>=0&&a<=h||(a=f.s*h-4),b>=0&&b<=i||(b=(1-f.v)*i-4),g.css("left",a+"px"),g.css("top",b+"px")},updatePreview:function(){var a=this,b=a.color,c=b.getAlpha(),e=d(a.preview).find("span");e.css("background-color",b.toHexString()),e.css("opacity",c)},updateAlpha:function(a){var b,c=this,e=c.color,g=e.toRgb(),h=d(c.alpha).find(".color-picker-panel-alpha-bg"),i=d(c.alpha).find("span");a>=0&&a<=100||(a=100*g.a),b="linear-gradient(to right, "+f({r:g.r,g:g.g,b:g.b,a:0}).toRgbString()+", "+f({r:g.r,g:g.g,b:g.b,a:1}).toRgbString()+")",h.css("background",b),i.css("left",a+"%")},updateRibbon:function(a){var b=this,c=b.color,e=c.toHsv(),f=e.h,g=d(b.ribbon).find("span");a>=0&&a<=100||(a=Math.round(f/360*100)),g.css("left",a+"%")},updateUI:function(){var a=this;a.updateBoardBg(),a.updateBoardPoint(),a.updatePreview(),a.updateAlpha(),a.updateRibbon(),a.updateInputHex(),a.updateInputA(),a.updateInputR(),a.updateInputB(),a.updateInputG(),a.updateInputHex()},reset:function(){this.$el.hide()}})}(),yne_common_views_ImageTitleInputView=function(a){var b=yne_common_jst,c=yne_backbone,d=yne_underscore,e=yne_common_key_keyCodeMap,f=yne_common_util_platform,g=yne_jtk_core_L,h=yne_common_util_insertTextAtCursor,i=function(){};return c.View.extend({className:"image-title-input-wrapper",name:"ImageTitleInputView",events:{"keydown .image-title-input":"_onKeyDown","paste .image-title-input":"_onPaste","input .image-title-input":"_onInput"},zoom:1,initialize:function(a){var b=this;b.editor=a.editor,d.bindAll(b,"_onEditStart","_onEditEnd","_onKeyDown","_onExit","_onUpdate","_getPosition","_onPaste","_show","_hide","_onInput","_handlerPlaceholder","_onLockedChange"),b.on("img-title-edit-start",b._onEditStart),b.on("img-title-edit-end",b._onEditEnd),b.on("img-title-edit-focus",b._onFocus),b.on("img-title-edit-exit",b._onExit),b.on("img-title-edit-update",b._onUpdate),b.on("locked-change",b._onLockedChange),b._callback=i},render:function(){var a=b.render("common","image-title-input",{title:""});this.$el.html(a)},_getPosition:function(a){var b=this.editor.getNoteViewWrapper(),c=f.IS_PC?this.editor.getNoteViewFrame():this.editor.noteView.$el,d=c.offset(),e=parseInt(c.css("margin-top"));a.left=a.left-b.offset().left+b.scrollLeft(),a.top=a.top-d.top+e},_show:function(){var a=this._origialNode;this.$el.show(),a&&a.css("color","transparent")},_hide:function(){var a=this._origialNode;a&&(a.css("color",""),a.css("height","auto")),this.$el.hide()},_onEditStart:function(a,c,e,f,g){var h,j=this,k=c();j.getOffset=c,j._getPosition(k),j._callback!==i&&j._onEditEnd(),a||(a=""),h=b.render("common","image-title-input",d.defaults({title:a},k)),j.$el.html(h),j.$input=this.$el.find(".image-title-input"),j.$placeholder=this.$el.find(".image-title-placeholder"),j.$input.on("blur",function(){j._handlerPlaceholder(),j._onEditEnd()}).on("focus",function(){j._handlerPlaceholder(),j.editor.controller.lockBlockById(g)}),j._callback=e||i,j._origialNode=f,j._handlerPlaceholder(),a&&j._show(),j.$placeholder.click(function(){j.$input.focus()})},_onEditEnd:function(a,b){if(this.$input&&this.$input.is(":visible")){var c=this.$input.text();this._callback(c,a,b,this.$el.is(":visible"))}},_onKeyDown:function(a){if(this.$input.is(":visible")&&e.isMatch("enter",a.keyCode)&&d.isFunction(this._onEditEnd))return a.preventDefault(),this._onEditEnd(!0,this.editor.controller.getNextCaretBlockRange()),void this._onExit();(a.ctrlKey||a.metaKey)&&["B","b","U","u","I","i"].forEach(function(b){if(e.isMatch(b,a.keyCode))return void a.preventDefault()})},_onFocus:function(){var a=this.$input;a&&a.is(":visible")||this._show(),a.focus()},_onExit:function(){this._hide(),this._callback=i},_onUpdate:function(a){var b=a();this.getOffset=a,this._getPosition(b),this.$input.css({left:b.left,top:b.top,width:b.width+"px","min-height":b.height+"px"}),this.$placeholder.css({left:b.left,top:b.top,width:b.width+"px"})},_handlerPlaceholder:function(){var a=this;a.$input.text()?a.$placeholder.hide():a.$placeholder.show()},setZoom:function(a){var b=this;b.zoom=a,b.$el.css("zoom",b.zoom)},_transferString:function(a){var b=a;try{b=b.replace(/\r\n/g," "),b=b.replace(/\n/g," ")}catch(a){g.log("replace image title line break failed!")}return b},_onPaste:function(a){var b,c,d=a.originalEvent;a.preventDefault(),d.clipboardData&&d.clipboardData.getData?(b=d.clipboardData.getData("text/plain"),c=this._transferString(b),document.execCommand("insertHTML",!1,c)):window.clipboardData&&window.clipboardData.getData&&(b=window.clipboardData.getData("Text"),h(b))},_onInput:function(){var a=this.$input.height();a!==this._origialNode.height()&&this._origialNode.height(a),this._handlerPlaceholder()},_onLockedChange:function(){this.getOffset&&this._onUpdate(this.getOffset)}})}(),yne_common_views_StyleViewMapper=function(a){var b=yne_jtk_core_Class,c=yne_jtk_core_L;return b.extend({initialize:function(){var a=this;a._mappingRules={},delete a.options},_isValidMappingRule:function(a){return!(!a||!a.name||null==a.value||null==a.valueInView)},addMappingRule:function(a){var b,d=this,e=d._mappingRules;return d._isValidMappingRule(a)?(b=a.name,e[b]?void c.error("Failed to add mapping rule, mapping rule do exists",a):void(d._mappingRules[b]=a)):void c.error("Failed to add mapping rule, parameter is not valid",a)},valueFromView:function(a,b){var d=this._mappingRules[a],e=b;return d&&(d.compareEqual?d.compareEqual(b,d.valueInView):b===d.valueInView)&&(e=d.value),c.log("valueFromView name/valueInView => value: "+a+"/"+b+" => "+e),e},valueToView:function(a,b){var d=this._mappingRules[a],e=b;return d&&(d.compareEqual?d.compareEqual(b,d.value):b===d.value)&&(e=d.valueInView),
c.log("valueToView name/value => valueInView: "+a+"/"+b+" => "+e),e}})}(),yne_common_views_InlineStyleViewMapper=function(a){var b=yne_common_views_StyleViewMapper;return b.extend({name:"InlineStyleViewMapper"})}(),yne_pc_views_inlineStyleViewMapper=function(a){var b=yne_common_views_InlineStyleViewMapper,c=yne_common_data_supportedInlineStyles,d=yne_underscore,e=yne_tinycolor,f=new b({}),g={color:{valueInView:"#393939",compareEqual:function(a,b){return e.equals(a,b)}},"font-family":{valueInView:["-apple-system","BlinkMacSystemFont","PingFang SC","Helvetica","Tahoma","Arial","Hiragino Sans GB","Microsoft YaHei","微软雅黑","SimSun","宋体","Heiti","黑体","sans-serif"].join(",")},"color-catalogue":{valueInView:"#003884",value:c.getDefault("color"),compareEqual:function(a,b){return e.equals(a,b)}}};return d.each(g,function(a,b){var d={name:b,valueInView:a.valueInView,value:c.getDefault(b)||a.value,compareEqual:a.compareEqual};f.addMappingRule(d)}),f}(),yne_ProgressBar=function(){var a=window.ProgressBar;if(!a&&window.require&&(a=window.require("ProgressBar")),!a)throw"no `ProgressBar` library";return a}(),yne_pc_core_PcEditor=function(a){var b,c=yne_pc_views_NoteView,d=yne_common_data_Note,e=yne_pc_core_PcController,f=yne_jquery,g=yne_underscore,h=yne_common_constants,i=yne_jtk_core_L,j=yne_pc_toolbar_BigToolbar,k=yne_common_contextMenu_ContextMenu,l=yne_pc_contextMenu_config,m=yne_common_core_Editor,n=yne_common_data_blockTypes,o=yne_common_contextMenu_queryCache,p=yne_pc_presenter_Presenter,q=yne_common_fontMaps,r=yne_common_fontSize,s=yne_common_selection_NoteRange,t=yne_common_key_keyCodeMap,u=yne_common_util_events,v=yne_common_jst,w=yne_common_util_typeConverter,x=yne_common_views_LinkView,y=yne_common_views_ColorPicker,z=yne_common_views_ImageTitleInputView,A=yne_pc_views_inlineStyleViewMapper,B=yne_ProgressBar,C=yne_collaboration_collabUtils;return b=m.extend({_toolbar:null,_defaultFontName:null,_defaultFontSize:null,_zoomHintCloser:null,_attendeeListCloser:null,_$zoomHintDiv:null,_isZoomHintShown:!1,_$attendeesHintDiv:null,_$statsIFrame:null,_attendeeHintDivDefaultStyle:null,_noteViewWrapper:null,_noteViewFrame:null,_resMap:null,initialize:function(a){var h=this;h._editorProps=g.extend({},a),h.parentEl=h._editorProps.parentEl,f(h.parentEl).html(""),g.bindAll(h,"_onWinResize"),h.note=d.createBlank(!0),h.noteView=new c({editor:h,note:h.note,inlineStyleViewMapper:A}),h.linkView=new x({editor:h}),h.imgTitleInput=new z({editor:h}),h.controller=new e({note:h.note,noteView:h.noteView,editor:h,imgTitleInput:h.imgTitleInput}),h._initToolbar(),h._initContextMenu(),h._bindEventsForDoc(),h._bindEventsForThis(),h._initZoomHint(),h._initAttendeesHint(),b.__super__.initialize.apply(h,arguments),h.colorpicker=new y({editor:h}),f(h.parentEl).append(h.colorpicker.$el),u.bubble(["color-picker-show"],h,h.colorpicker),h._$statsIFrame=f('<iframe id="iframe_stats" style="display:none"></iframe>'),h._$statsIFrame.appendTo("html")},_initZoomHint:function(){f('<div id="ycm-zoomHint" class="yne-zoom-hint">100%</div>').appendTo(document.body)},_initAttendeesHint:function(){var a=this,b=v.render("pc","float-modifiers",{});a._$attendeesHintDiv=f(b),a._$attendeesHintDiv.appendTo(document.body),a._attendeeHintDivDefaultStyle={},a._attendeeHintDivDefaultStyle.top=a._$attendeesHintDiv.css("top"),a._attendeeHintDivDefaultStyle.right=a._$attendeesHintDiv.css("right"),a._$attendeesHintDiv.find("#attendee-hint").on("click",function(){a._toggleAttendees()}),a._$attendeesHintDiv.mouseleave(function(){a._attendeeListCloser=window.setTimeout(function(){a._toggleAttendees(!1),a._isZoomHintShown=!1},2e3)}),a._$attendeesHintDiv.mouseenter(function(){window.clearTimeout(a._attendeeListCloser)}),a._toolbar.on("tab-toggled",function(b){b?a._$attendeesHintDiv.css("visibility","visible"):a._$attendeesHintDiv.css("visibility","hidden")})},_initToolbar:function(){var a=this;a._toolbar=new j({editor:a,parentEl:a.parentEl}),a._toolbar.on("resize",function(){a._onWinResize()})},_initContextMenu:function(){var a,b=this,c=[];b._contextMenu||(a=b._contextMenu=new k({editor:b}),g.each(l,function(a){var b=a();g.isArray(b)?c=c.concat(b):c.push(b)}),a.addItems(c),b.on("contextmenu",function(c){var d=o(b,c);a.onContextMenu(c,d)}))},reset:function(){var a=this;b.__super__.reset.apply(a,arguments),a._toolbar&&a._toolbar.isRendered&&(a._toolbar.reset(),a._toolbar.show()),a.colorpicker&&a.colorpicker.reset(),a._clearScrollTimeout(),a._toggleAttendees(!1),a.setIdleTimeout(!1)},imageOCR:function(a){this.trigger("yne-image-ocr",a)},setHtmlContent:function(a,b,c,d){var e=this;e._setContent(!1,a,b,c,d),e.isLegacyHost()&&e.trigger("yne-content-change")},setXmlContent:function(a,b,c,d){this._setContent(!0,a,b,c,d)},_setContent:function(a,b,c,e,f){var g=this,h=!0===e.isAsync,i=function(a){a.isAsync=h,g._updateContentSetProgress(a),a.percent>=1&&null!=f&&f({resultCode:1})};g._contentSetStartTime=Date.now(),g._updateContentSetProgress({percent:0,message:"加载中",isAsync:h}),g.reset(),g._isSettingContent=!0,g._noteProps=null==e?g.options||{}:e,g._resMap=c||{},g.note.setExtraInfo({pcResMap:g._resMap,pcTodoMap:g._noteProps.todoContents}),g.controller.setOptions({note:g.note}),g.noteView.setOptions({note:g.note,pageType:g._editorProps.pageType,isNoteSet:!0,disableOCR:g._noteProps.disableOCR}),g.setViewMode(g._editorProps.viewMode,!0,!1),g.setReadOnly(g._noteProps.isReadOnly),g.setBackground(g._noteProps.bgImageId),!g._noteProps.isReadOnly&&g.isLegacyHost()&&g._makeReadOnly(!0),g.noteView.render(),g._updateContentSetProgress({percent:.05,isAsync:h}),a?d.fromXml(b,g.note,null,{progressCallBack:i,isAsync:h}):e.isOCR?(d.fromOCR(b,g.note),i({percent:1})):null==d.fromHtml(b,g.note,null,{progressCallBack:i,isAsync:h})&&(d.createBlank(!0,g.note),i({percent:1})),g._isNotSetContent=!1},_updateContentSetProgress:function(a){var b=this;a.isAsync&&null!=a.message&&b._progressBar.setText(a.message),g.isNumber(a.percent)&&(a.isAsync&&b._progressBar.set(a.percent),a.percent>=1?(a.isAsync&&b._$progressBarContainer.fadeOut({duration:1500}),b._isSettingContent=!1,b.isLegacyHost()&&!b._noteProps.isReadOnly&&b._makeReadOnly(!1),b.isCollabEnabled()||b.trigger("yne-content-set",b.note.getNoteId(),b.note.getAllResourceInfo(null,[n.IMAGE])),b.focusEditor()):a.isAsync&&Date.now()-b._contentSetStartTime>h.LATENCY_TO_SHOW_SET_CONTENT_PROGRESS&&b._$progressBarContainer.fadeIn({duration:1500}))},render:function(){var a=this,c=a.noteView;a._renderCallCounter?(a._renderCallCounter++,i.error("The PcEditor - render() should be called only once: "+a._renderCallCounter)):a._renderCallCounter=1,c&&(a.initNoteViewWrapper(),f(a._noteViewFrame).append(c.$el),f(a._noteViewWrapper).append(a.linkView.$el),a.setViewMode(a._editorProps.viewMode,!0,!1),c.setOptions({pageType:a._editorProps.pageType}),c.render(),f(a._noteViewWrapper).append(a.imgTitleInput.$el),a.isCollabEnabled()&&!1===a._noteProps.hideAttendeeHint?a.toggleAttendeeHint(!0):a.toggleAttendeeHint(!1),b.__super__.render.apply(a,arguments))},initNoteViewWrapper:function(){var a,b,c=this,d=f(c.parentEl),e="c-"+C.newGUID();c._noteViewWrapper||(b='<div class="note-view-wrapper"><div class="note-view-frame"></div></div>',c._noteViewWrapper=f(b).get(0),a=f(c._noteViewWrapper),c._$progressBarContainer=f('<div class="progressbar-container"></div>'),c._$progressBarContainer.attr("id",e),c._noteViewFrame=a.find("div").get(0),a.bind("mousedown",function(a){var b=a.target;b!==c._noteViewFrame&&b!==c._noteViewWrapper||a.preventDefault()}),a.bind("scroll",function(){}),d.append(c._noteViewWrapper),d.append(c._$progressBarContainer),c._progressBar=new B.Circle("#"+e,{strokeWidth:6,color:"#4C9900",trailColor:"#4C9900",trailWidth:1,svgStyle:null,fill:"rgba(255, 255, 255, 0.6)",text:{autoStyleContainer:!1}}),null!=c.noteView&&c.noteView.setOptions({noteviewWrapper:c.getNoteViewWrapper(),noteviewFrame:c.getNoteViewFrame()})),c.updateNoteViewWrapperSize()},_onWinResize:function(){var a=this;i.log("_onWinResize"),a.updateNoteViewWrapperSize(),a.noteView&&a.noteView.trigger("resize")},_bindEventsForDoc:function(){var a=this;f(window).on("resize",a._onWinResize),f(document.body).on("contextmenu",function(a){a.preventDefault()}).on("keydown",function(b){a.isFullScreen()&&b&&!b.ctrlKey&&!b.metaKey&&!b.shiftKey&&t.isMatch("esc",b.keyCode)&&a.trigger("yne-exit-full-screen")}),function(){var b,c=window.devicePixelRatio,d=500;b=function(){var e=!1;c!==window.devicePixelRatio&&(e=!0,c=window.devicePixelRatio),e&&a._onWinResize(),setTimeout(b,d)},setTimeout(b,d)}()},_bindEventsForThis:function(){var a=this;a.on("yne-exit-full-screen",function(){a.exitFullScreen()})},updateNoteViewWrapperSize:function(){var a,b,c=this;c._toolbar&&c._noteViewWrapper&&(a=f(window).height(),b=c._toolbar.$el.outerHeight(),f(c._noteViewWrapper).outerHeight(a-b),c._$progressBarContainer.css("left",(f(c.parentEl).width()-c._$progressBarContainer.width())/2),c._$progressBarContainer.css("top",(f(c.parentEl).height()-c._$progressBarContainer.height())/2))},_bindEventsForController:function(){var a=this,c=a.controller;if(!c)return void i.warn("no controller!");b.__super__._bindEventsForController.apply(a,arguments),u.bubble(["contextmenu","yne-click","yne-download-attachment","yne-download-image","yne-editing-state-change","yne-on-paste","yne-open-attachment","yne-open-image","yne-open-link","yne-replace-attachment","yne-replace-image","yne-save-content","yne-selection-change","yne-show-words","yne-image-ocr"],c,a),u.bubble({find:"yne-find"},c,a),c.on("ytable-key-esc",function(){a.isFullScreen()&&a.trigger("yne-exit-full-screen")})},querySelectionInlineStyle:function(a){return this.controller.querySelectionInlineStyle(a)},querySelectionBlockStyle:function(a){return this.controller.querySelectionBlockStyle(a)},querySelectionInlineStyles:function(){return this.controller.querySelectionInlineStyles()},querySelectionBlockStyles:function(){return this.controller.querySelectionBlockStyles()},isSameList:function(a){return this.controller.isSameList(a)},canRemoveFormat:function(){return this.controller.canRemoveFormat()},updateFormatPainterCursorUI:function(a){this.noteView.updateFormatPainterCursorUI(a)},setStyles:function(a){this.noteView.$el.css(a)},getScrollPercent:function(){var a=this,b=a._noteViewWrapper;return b.scrollTop/b.scrollHeight},_clearScrollTimeout:function(){var a=this;a._scrollTimeout&&(window.clearTimeout(a._scrollTimeout),a._scrollTimeout=null)},setScrollPercentWithDelay:function(a,b){var c=this;b=b||50,c._clearScrollTimeout(),c._scrollTimeout=window.setTimeout(function(){c._setScrollPercent(a)},b)},_setScrollPercent:function(a){var b,c,d=this,e=d._noteViewWrapper;a=a||0,c=e.scrollHeight,b=Math.round(a*c),f(e).scrollTop(b)},focusEditor:function(){this.controller.focusEditor()},getNote:function(){return this.note},insertText:function(){var a=this,b=a.controller;b.insertText.apply(b,arguments)},updateResMapWithKey:function(a,b,c){this.note.setExtraInfoWithKey("pcResMap",a,b,c)},getExtraInfo:function(a){return this.note.getExtraInfo(a)},getPcResMap:function(){return this.getExtraInfo("pcResMap")},enterFullScreen:function(){var a=this;f(document.body).addClass("full-screen"),a._toolbar.enterFullScreen(),a.isCollabEnabled()&&(a._$attendeesHintDiv.css("top","6px"),a._$attendeesHintDiv.css("right","140px"))},exitFullScreen:function(){var a=this;f(document.body).removeClass("full-screen"),a._toolbar.exitFullScreen(),a.isCollabEnabled()&&(a._$attendeesHintDiv.css("top",a._attendeeHintDivDefaultStyle.top),a._$attendeesHintDiv.css("right",a._attendeeHintDivDefaultStyle.right))},isFullScreen:function(){return f(document.body).hasClass("full-screen")},updateShortCut:function(){var a=this.controller;a.updateShortCut.apply(a,arguments)},removeShortCut:function(){var a=this.controller;a.removeShortCut.apply(a,arguments)},enterPresentation:function(a){var b=this,c=b._getPresenter(),d=b.getHtmlContent(!0);c.enter(a,d,b.currentBackground)},_getPresenter:function(){var a=this;return a._presenter||(f('<div id="presenter"></div>').appendTo("html"),a._presenter=new p({el:"#presenter"}),a._presenter.on("exit",function(){a.trigger("yne-exit-presentation")}),a._presenter.on("open-link",function(b){a.trigger("yne-open-link",b)}),a._presenter.on("open-attachment",function(b,c){a.trigger("yne-open-attachment",b,c)})),a._presenter},setDefaultFont:function(a,b){var c=this,d=q.getFontFirstValue(a),e=r.getAsArray();d&&(c._defaultFontName=d),e.indexOf(b)>-1&&(c._defaultFontSize=b),c.note&&c.note.isEmptyContent()&&c.useDefaultFontAsEditingStyle()},useDefaultFontAsEditingStyle:function(){var a=this;a.controller.setDefaultFont(a._defaultFontName,a._defaultFontSize)},showSaveSyncButton:function(a){this._toolbar.showSaveSyncButton(!0===a)},rotateSaveSyncIcon:function(a){this._toolbar.rotateSaveSyncIcon(a)},toggleToolbar:function(a){this._toolbar.toggleToolbar(a),this.updateNoteViewWrapperSize()},setCaretPosition:function(a,b){var c,d=this,e=document.caretRangeFromPoint(a,b);return!!e&&(!!(c=s.fromNativeRange(e,d.noteView))&&(d.setNoteRange(c),!0))},_firstNotEmptyTextBlockIndex:function(){var a,b,c=this,d=c.note.blocks,e=d.length,f=-1;for(a=0;a<e;a++)if(b=d[a],n.isTextOrTableBlock(b)&&!b.isEmptyContent()){f=a;break}return f},isCaretInFirstTextLine:function(a){(!g.isNumber(a)||a<=0||a>500)&&(a=80),i.log("limit: "+a);var b,c,d,e,f,h=this,j=h.note,k=h._firstNotEmptyTextBlockIndex(),l=0;if(-1===k)return!1;if(b=h.getNoteRange(),c=b.getEndBlockRange(),(d=j.getBlockIndex(c.block))>k)return!1;for(e=0;e<d-1;e++)(f=j.getBlockAt(e))&&n.isTextOrTableBlock(f)&&(l+=f.countWords());return f=j.getBlockAt(d),n.isTextBlock(f)?l+=c.end:n.isTable(f)&&(l+=f.countWords()),l<=a},getFirstLineTextContent:function(){var a,b=this,c=b._firstNotEmptyTextBlockIndex(),d="";return-1===c?"":(a=b.note.getBlockAt(c),a&&(d=a.toPlain()),d)},getCurrentZoomValue:function(){var a,b=this,c=b._getEditArea();return a=Number(c.css("zoom")),g.isNumber(a)||(a=1),a},setZoomPercent:function(a,b){var c=this;if(c._getPresenter().isPresenting())return void(a>0?c._getPresenter().zoomIn():c._getPresenter().zoomOut());b?c.zoomEditor(a/100,!0):a>0?c._zoomInEditor():c._zoomOutEditor()},zoomEditor:function(a,b){var c,d=this;g.isNumber(a)&&(c=d._getEditArea(),c.css("zoom",a),d.imgTitleInput.setZoom(a),d.linkView.setZoom(a),b&&d.trigger("yne-editing-zoom-change",a),d.trigger("yne-zoom-changed",100*a),d.noteView.trigger("resize",a),d._showZoomHint(100*a+"%"))},_getEditArea:function(){return f(this._noteViewFrame)},_zoomInEditor:function(){var a,b=this,c=b._getEditArea();if(a=Number(c.css("zoom")),g.isNumber(a)){if(a>=3)return}else a=1;a+=.25,a>3&&(a=3),b.zoomEditor(a,!0)},_zoomOutEditor:function(){var a,b=this,c=b._getEditArea();a=Number(c.css("zoom")),!g.isNumber(a)||a<=1||(a-=.25,a<1&&(a=1),b.zoomEditor(a,!0))},_showZoomHint:function(a){var b=this;b._isZoomHintShown?b._zoomHintCloser&&window.clearTimeout(b._zoomHintCloser):(b._getZoomHintDiv().show("slow"),b._isZoomHintShown=!0),b._zoomHintCloser=window.setTimeout(function(){b._getZoomHintDiv().hide("slow"),b._isZoomHintShown=!1},2e3),b._getZoomHintDiv().text(a)},_getZoomHintDiv:function(){var a=this;return a._$zoomHintDiv||(a._$zoomHintDiv=f("#ycm-zoomHint")),a._$zoomHintDiv},_updateContainerBackground:function(a){var b=this,c=b.noteView.$el.parent(),d=c.css("background-image");return!(b.currentBackground===a&&d.indexOf(a)>0)&&(a&&a!==h.DEFAULT_BACKGROUND?(c.css("background-image",'url("'+a+'")'),b.currentBackground=a):(c.css("background-image",""),b.currentBackground=h.DEFAULT_BACKGROUND),!0)},_toggleAttendees:function(a){var b,c=this;b=c._$attendeesHintDiv.find("#attendee-list"),!0===a?b.css("display","inline-block"):!1===a?b.css("display","none"):b.slideToggle(10,function(){f(this).is(":visible")&&f(this).css("display","inline-block")})},showToolbar:function(){this._toolbar&&this._toolbar.isRendered&&this._toolbar.show()},toggleAttendeeHint:function(a){var b=this;a?b._$attendeesHintDiv.show():b._$attendeesHintDiv.hide()},updateAttendees:function(a){var b,c,d,e=this,f=[],h="";g.each(a,function(a){(d=w.parseToBoolean(a.readOnly,!1))||(b={},b.SID=a.sessionId,b.portrait=a.portraitUrl,b.color=a.lockColor,b.nickname=a.nickname,f.push(b))}),c=g.size(f),e._$attendeesHintDiv.find("#attend-num-span").html(c),c>0&&(h=v.render("pc","float-modifiers-li",{allAttendees:f})),e._$attendeesHintDiv.find("#attendee-list").html(h)},setIdleTimeout:function(a){var c=this;b.__super__.setIdleTimeout.apply(c,arguments),a&&c.toggleAttendeeHint(!1)},getNoteViewWrapper:function(){return f(this._noteViewWrapper)},getNoteViewFrame:function(){return f(this._noteViewFrame)},isLegacyHost:function(){var a=this,b=!0,c=a.getEditorProps();return null==c.pcVersion&&null!=window.YNote&&null!=window.YNote.GetVersion&&(c.pcVersion=parseInt(window.YNote.GetVersion())),null!=c.pcVersion&&c.pcVersion>=parseInt("060000000000")&&(b=!1),b},toggleStats:function(a){var b,c=this;b=i.DEBUG?"http://test.note.youdao.com/editor/collab/pcCollabStats_debug.html":"https://note.youdao.com/editor/collab/pcCollabStats.html",a?c._$statsIFrame.attr("src",b):c._$statsIFrame.attr("src","")},_makeReadOnly:function(a){b.__super__._makeReadOnly.apply(this,[a]),this.updateNoteViewWrapperSize()}})}(),yne_common_util_plainizeBlockList=function(a){var b=yne_common_data_blockTypes,c=yne_common_data_Paragraph,d=yne_underscore;return function(a){var e=d.filter(a,function(a){return!b.isImage(a)&&!b.isAttachment(a)&&!b.isHandWrite(a)});return e=d.map(e,function(a){var d;return a.removeAllStyles(),b.isListItem(a)||b.isHeading(a)||b.isCatalogue(a)||b.isTodo(a)?(d=c.createBlank(!1),d.setText(a.getText())):d=a,d})}}(),yne_common_util_isXml=function(a){var b=yne_jquery;return function(a){return!!a&&(a=b.trim(a+""),/^<\?xml /i.test(a))}}(),yne_common_util_addPrintStyle=function(a){var b=yne_underscore,c=yne_jquery,d=yne_jtk_core_L,e=yne_jtk_web_dom_parseHTML,f=yne_common_util_attachmentPresentProcess;return function(a){var g=e(a),h=g.querySelectorAll("img[data-media-type=attachment]"),i=g.querySelectorAll("img[data-media-type=image]"),j=g.querySelectorAll("div[yne-bulb-block=paragraph]"),k=g.querySelectorAll("ol"),l=g.querySelectorAll("ul"),m={};return b.each([j,k,l],function(a){b.each(a,function(a){a.style.fontFamily='"宋体", sans-serif',a.style.zoom="1.15"})}),b.each(h,function(a){f.processHtmlContent(c(a))}),b.each(i,function(a){var b,d=c(a);d.attr("alt")&&(b=document.createElement("div"),b.className="img-title",b.appendChild(document.createTextNode(d.attr("alt"))),d.after(b))}),!0===d.DEBUG?f.getAttachStyle(m,!0):c.ajax({url:"./presenter.css",dataType:"text",async:!1}).done(function(a){m.innerTag="<style>"+a+"</style>"}).fail(function(){d.error("load presenter.css file failed")}),a="<head>"+m.innerTag+"</head>"+g.outerHTML}}(),yne_collaboration_collabAPI=function(a){var b=yne_common_constants,c=yne_jtk_core_L;return{buildCollabSession:function(a,b){var c,d=this,e=0;try{if(b=b||function(){},c=d._editor.getEditorProps(),null==a&&(a={},a.shareKey=c.shareKey,a.sessionType=c.sessionType,null!=c.sessionId&&(a.sessionId=c.sessionId)),a.buildVersion=c.buildVersion,a.userInfo=c.userInfo,a.collabServer=c.collabServer,null==a.shareKey||"undefined"===a.shareKey)return b({resultCode:0,message:"shareKey should NOT be null"}),0;d.closeCollabSession(),d._editor.buildCollabSession(a,b),e=1}catch(a){b({resultCode:0,message:a.message})}return e},closeCollabSession:function(){this._editor.closeCollabSession(b.WSEVENTID_HOST_CLOSE,"NormalQuit")},getCollabContent:function(a,b){var c,d=this;a=a||function(){};try{return d._editor&&d._editor.isCollabEnabled()?c=d._editor.getCollabContent(a,b):(c={status:2,resultCode:2,message:"Not-Collab-Enabled"},a(c),c)}catch(b){return c={status:3,resultCode:3,message:b.message},a(c),c}},getModifiers:function(a,b){var c,d=this;b=b||function(){};try{return d._editor&&d._editor.isCollabEnabled()?d._editor.getModifiers(a,b):(c={status:2,resultCode:2,message:"Not-Collab-Enabled"},b(c),c)}catch(a){return c={status:3,resultCode:3,message:a.message},b(c),c}},isReadyToClose:function(){var a=this,b=!0;return a._editor.isLegacyHost()?(a._editor&&a._editor.isCollabEnabled()&&(b=!a._editor.hasCachedDataCmd()),b):(c.debugAlert("isReadyToClose should NOT be called in new host"),!1)},resetEditorOptions:function(a){var b=this;if(!b._editor.isLegacyHost())return void c.debugAlert("resetEditorOptions should NOT be called in new Host");b._editor.updateEditorOptions(a)},reset:function(){this._editor.reset()},saveNotification:function(a,b){var c=this;c._editor&&c._editor.isCollabEnabled()&&c._editor.saveNotification(a,b)},toggleAttendeeHint:function(a){var b=this;if(!b._editor.isLegacyHost())return void c.debugAlert("toggleAttendeeHint should NOT be called in New Host");b._editor.toggleAttendeeHint(a)},destroyCollabEngine:function(){var a=this;a.closeCollabSession(),a._editor.destroyCollabEngine()},isNotSetContent:function(){return this._editor.isNotSetContent()},saveFile:function(a){this._editor.testSendMsgToCollabServer(a)}}}(),yne_common_io_editorApi=function(a){var b,c=yne_underscore,d=yne_jtk_core_L,e=yne_jtk_core_Class,f=yne_collaboration_collabAPI,g=yne_common_constants;return b={setContent:function(a,b,e,f,h){var i=this,j=i._editor;try{null==f&&(f=i.options||{}),f=c.defaults(f,{isCollabEnabled:!1,isReadOnly:!1,disableBackground:!1,bgImageId:g.DEFAULT_BACKGROUND}),!0===b?j.setHtmlContent(a,e,f,h):j.setXmlContent(a,e,f,h),j.isCollabEnabled()&&j.noteSetNotification()}catch(a){d.error(a),null!=h&&h({resultCode:0,message:a.message})}},getContent:function(a,b,c,d){var e=this,f=e._editor;a=!!a||e._editor.hasHandWriteBlock(),d=!!d;try{return!0===a?f.getHtmlContent(d,b,c):f.getXmlContent(b,c)}catch(a){null!=b&&b({status:2,resultCode:2,message:a.message})}},getNoteVersion:function(){return this._editor.getNoteVersion()},getSchemaVersion:function(){return this._editor.getSchemaVersion()},setFont:function(a,b){return this._editor.setFont(a,b)},resetFont:function(){return this._editor.resetFont()},focus:function(){return this._editor.focus()},setBackground:function(a){var b=this;return!b._editor.isLegacyHost()&&b._editor.isNotSetContent()?void d.debugAlert("setBackground shoud NOT be called before setContent"):b._editor.setBackground(a)},setAllBackgrounds:function(a,b){var c=this;return c._editor.isLegacyHost()?c._editor.setAllBackgrounds(a,b):void d.debugAlert("setAllBackgrounds shoud NOT be called in new host")},setReadOnly:function(a){var b=this,c=b._editor;if(!b._editor.isLegacyHost())return void d.debugAlert("setReadOnly shoud NOT be called in new host");c.setReadOnly(a)}},c.extend(b,f),e.extend(b)}(),yne_pc_io_editorApi=function(a){var b,c,d=yne_jtk_core_L,e=yne_underscore,f=yne_jquery,g=yne_common_data_blockTypes,h=yne_common_data_RichText,i=yne_common_util_plainizeBlockList,j=yne_common_key_keyCodeMap,k=yne_parser_Parser,l=yne_jtk_web_dom_parseHTML,m=yne_pc_util_convertHtmlWithResMap,n=yne_pc_toolbar_buttonStateMap,o=yne_common_util_noteLink,p=yne_jtk_web_dom_nodeType,q=yne_collaboration_collabUtils,r=yne_common_util_typeConverter,s=yne_common_util_isXml,t=yne_common_util_addPrintStyle,u=yne_common_io_editorApi,v=yne_common_constants,w=yne_common_data_Image,x={PLAIN:1,HTML:2,YNE_JSON:3},y=1e4,z=function(a,b){e.each(a,function(a,c){a&&b.setAttribute(c,a)})},A=function(a){var b,c=document.createElement("img");return c.setAttribute("src",a),b=c.src,c=null,b},B=function(a,b){if(!a||!b)return a;var c=l(a),d="img[data-media-type=attachment]",f=e.toArray(c.querySelectorAll(d));return e.each(f,function(a){var c,d,f=a.getAttribute("data-res-id"),g=a.getAttribute("src");if(g=A(g),e.some(b,function(a,b){if((a=A(a))===g)return c=b,!0}),!c)return void a.parentNode.removeChild(a);d={filelength:a.getAttribute("data-file-length"),src:c,path:f},z(d,a)}),f=e.toArray(c.querySelectorAll("img[data-media-type=image]")),e.each(f,function(a){var b,c=a.getAttribute("data-attr-org-src-id");if(!c)return void a.parentNode.removeChild(a);b={src:c},z(b,a)}),a=c.innerHTML};return c={getResourceMap:function(){var a,b,c,d=this._editor,f=d.note,g={},h=function(a){a&&(a.source&&a.extraSource&&(g[a.source]=a.extraSource),a.resource&&a.extraResource&&(g[a.resource]=a.extraResource))};return b=f.getAllResourceInfo(),e.each(b,h),c=f.getAllResouceIds(),c&&c.length&&(a=d.getPcResMap()||{},e.each(c,function(b){var c=a[b];c&&(g[b]=c)})),window.JSON.stringify(g)},setContent:function(a,b,c,g){var h,i,j,k,l,m,n,o=this,p=o._editor;try{p.trigger("bridge-off-events"),null!=g&&(n=function(a){a.isXml=h,a.callbackUID=g,a.hasHandWrite=p.hasHandWriteBlock(),o._setContentCallBack(a)}),null!=b&&e.isString(b)&&""!==b.trim()&&(k=window.JSON.parse(b)),null==c||e.isNumber(c)?(l=o.options||{},l.scrollPercent=c):l=window.JSON.parse(c),l=e.defaults(l,{isCollabEnabled:!1,hideAttendeeHint:!1,disableBackground:!1,hasOriginFile:!1,bgImageId:v.DEFAULT_BACKGROUND,isReadOnly:!1,scrollPercent:0,todoContents:{},isOCR:!1,disableOCR:!1}),a=f.trim(a),h=s(a),i=!a,h?p.setXmlContent(a,k,l,n):(p.setHtmlContent(a,k,l,n),p.getNote().setValidForCollab(!1)),j=(l.scrollPercent||0)/y,p.setScrollPercentWithDelay(j),i&&p.useDefaultFontAsEditingStyle(),p.isCollabEnabled()&&p.noteSetNotification()}catch(a){if(m=a.message,d.DEBUG)throw a;d.error(m),p.trigger("yne-log-to-native",0,m),null!=n&&n({resultCode:0,message:m})}},getScrollPercent:function(){var a=this,b=a._editor,c=b.getScrollPercent();return c=Math.round(c*y)},getContent:function(a,b){var d,e=this;return null!=a&&(d=function(b){0!==b.status&&e.trigger("callback-to-native",a,[{status:b.status,resultCode:b.status,content:b.content}])}),c.__super__.getContent.apply(e,[!1,d,b])},getHtmlContent:function(a,b){var d,e,f=this,g=f._editor,h=function(b){0!==b.status&&(d=b.content,null!=d&&(e=g.getPcResMap(),d=m(d,e),d=t(d)),f.trigger("callback-to-native",a,[{status:b.status,resultCode:b.status,content:d}]))};return d=c.__super__.getContent.apply(f,[!0,h,b,!0])},insertAttachment:function(a){var b=window.JSON.parse(a),c=this._editor;c.updateResMapWithKey(b.source,b.localSource),c.updateResMapWithKey(b.resource,b.localResource),c.execCommand("comp.InsertAttachment",{src:b.source,resource:b.resource,fileName:b.fileName,fileLength:b.fileLength,retainStartBlock:b.retained})},updateAttachment:function(a,b,c,f){var h,i,j,k,l=window.JSON.parse(b),m=this._editor,n=m.note,o=[];if(f){if(!(h=n.getBlockById(f))||!g.isAttachment(h))return;o=[h]}else o=n.getAttachmentByResource(a);if(!o||!o.length)return void d.warn("Can not find attachment by resource: "+a);c=!1!==c,e.each(o,function(a){j=l.source||a.getSource(),k=l.resource||a.getResource(),l.localSource&&m.updateResMapWithKey(j,l.localSource),l.localResource&&m.updateResMapWithKey(k,l.localResource),c?m.execCommand("attachment.Replace",{src:j,resource:k,fileName:l.fileName||a.getFileName(),fileLength:l.fileLength||a.getFileLength(),attachment:a}):(i=["Source","Resource","FileName","FileLength"],e.each(i,function(b){var c="set"+b,d=b.substring(0,1).toLowerCase()+b.substring(1),e=l[d];e&&a[c](e)}))})},insertImage:function(a,b,c,d,e){var f=this._editor;f.updateResMapWithKey(a,b,!1),f.execCommand("comp.InsertImage",{src:a,retainStartBlock:c,width:d,height:e})},insertHorizontalLine:function(){return this._editor.execCommand("comp.InsertHorizontalRule"),1},insertHyperlink:function(a){var b=this,c=0;return null!=a&&e.isString(a)&&""!==a&&(b._editor.execCommand("comp.InsertLink",{src:a,styles:b._editor.controller.getEditingInlineState()}),c=1),c},insertTable:function(a,b){var c=this,d=0;return a=r.parseToNumber(a,0),b=r.parseToNumber(b,0),null!=a&&a>0&&null!=b&&b>0&&(c._editor.execCommand("comp.InsertTable",{rows:a,cols:b}),d=1),d},insertCatalogue:function(){return this._editor.execCommand("comp.InsertCatalogue"),1},updateImage:function(a,b,c,e,f,g,h){var i=this;if(!i._editor.isLegacyHost())return void d.debugAlert("updateImage should NOT be called after PC 6.0");i._updateImage(a,b,c,e,f,g,h)},updateImageV2:function(a){var b=this,c=window.JSON.parse(a);b._updateImage(c.source,c.newSource,c.newLocalSource,c.triggerContentChange,c.blockId,c.width,c.height)},triggerEvent:function(a){d.log("editor api trigger: "+a);var b=this,c=e.toArray(arguments);b.trigger("bridge-event",c)},insertNoteLink:function(a,b){if(a&&b){var c,d,e=this,f=e._editor,g=o.fillAsUrl(a);c=new h({text:b}),d=c.getLength(),c.setStyles(0,d,{href:g,color:"rgb(0, 56, 132)",underline:!0}),f.insertText(c,!1)}},selectCtxMenu:function(a){this.trigger("select-context-menu",a)},doPaste:function(a,b,c,d,f,h){var j,l,m,n=this._editor,o=n.controller,p=n.note,s=function(a,b,c){if(!a||!a.isAttachmentCell())return!1;if(b)return!0;if(!c){var d=a.getContent();if(d&&/^http/i.test(d.getResource()))return!0}return!1},t=function(a,b,c){var d;return(1!==a.getRowCount()||1!==a.getColumnCount()||!s(a.getCell(0,0),b,c))&&(a.forEach(function(e,f){d=a.getCell(e,f),s(d,b,c)&&a.setCellContent(e,f,"")}),!0)},u=function(a){var b,c;if(a&&a.length){if(b=e.filter(a,function(a){if(c=n.isCollabEnabled(),g.isAttachment(a)){if(h)return!1;if(!c&&/^http/i.test(a.getResource()))return!1}return a&&a.setId&&a.setId(q.newGUID()),!g.isTable(a)||t(a,h,c)}),(b=e.map(b,function(a){return g.isHandWrite(a)?new w({source:a.getSource(!1)}):a}))&&b.length>0){if(o.pasteForTable&&o.pasteForTable(b))return;n.execCommand("comp.InsertBlocks",{range:n.getNoteRange(),blocks:b})}return b}};a&&(o.setPasteAsText(c),h=r.parseToBoolean(h,!1),b===x.PLAIN?j=k.parsePlain(a,c?null:n.querySelectionInlineStyles(),c?null:n.querySelectionBlockStyles(),c):b!==x.YNE_JSON&&b!==x.HTML||(f&&(m=window.JSON.parse(f)),b===x.HTML?(a=B(a,m),j=k.parseHtml(a)):j=k.parseJSON(a),c?j=i(j):e.each(m,function(a,b){n.updateResMapWithKey(b,a,!0)})),j&&(l=u(j))&&l.length>0&&n.trigger("yne-check-image",p.getNoteId(),p.getAllResourceInfo(j,[g.IMAGE])))},highlight:function(a){var b=a.split(/\s+/);this._editor.highlight(b)},clearHighlight:function(){this._editor.clearHighlight()},enterFullScreen:function(){this._editor.enterFullScreen()},exitFullScreen:function(){this._editor.exitFullScreen()},enterPresentation:function(a){this._editor.enterPresentation(a)},setPageMode:function(a){var b=this;if(!b._editor.isLegacyHost()&&b._editor.isNotSetContent())return void d.debugAlert("setPageMode should NOT be called before setContent");b._editor.setViewMode(a,!0,!1)},setShortCut:function(a){var b,c=this;b=JSON.parse(a),c._setShortCut(b)},setDefaultFont:function(a,b){var c=this,d=c._editor;b=parseInt(b+"",10),d.setDefaultFont(a,b)},showSaveSyncButton:function(a){var b=this,c=b._editor;if(!b._editor.isLegacyHost())return void d.debugAlert("setDefaultFont should not be invoked after PC6.0");a=!!a,c.showSaveSyncButton(a)},rotateSaveSyncIcon:function(a){var b=this,c=b._editor;if(!b._editor.isLegacyHost())return void d.debugAlert("rotateSaveSyncIcon should not be invoked after PC6.0");c.rotateSaveSyncIcon(!!a)},setCaretPosition:function(a,b){this._editor.setCaretPosition(a,b)},isCaretInFirstTextLine:function(a){return this._editor.isCaretInFirstTextLine(a)},getFirstLineTextContent:function(){return this._editor.getFirstLineTextContent()},focusEditor:function(){this._editor.focusEditor()},getWordInfoFromPosition:function(a,b){var c,d,f;return(c=document.caretRangeFromPoint(a,b))&&p.isText(c.commonAncestorContainer)?(d=document.createRange(),d.selectNode(c.commonAncestorContainer),f=d.getClientRects(),e.some(f,function(c){return c.top<b&&c.left<a&&c.bottom>b&&c.right>a})?c.startOffset+"|"+c.commonAncestorContainer.nodeValue:""):""},setZoomPercent:function(a,b){var c=this;if(c._editor.isLegacyHost())return void d.debugAlert("method of setZoomPercent CAN NOT be called in less-than-6.0 PC version");c._editor.setZoomPercent(a,b)},buildCollabSession:function(a,b){var f,g,h=this,i=function(a){h.trigger("callback-to-native",b,[{resultCode:a.resultCode,message:a.message}])};try{null!=a?g=JSON.parse(a):h._editor.isLegacyHost()||(f="propsJSONStr should NOT be Null",d.debugAlert(f),h.trigger("callback-to-native",b,[{resultCode:0,message:f}])),e.isObject(g)||(g={}),
c.__super__.buildCollabSession.apply(h,[g,i])}catch(a){f=a.message,h.trigger("callback-to-native",b,[{resultCode:0,message:f}])}},getCollabContent:function(a,b){var d,e=this,f=function(b){e.trigger("callback-to-native",a,[window.JSON.stringify(b)])};return d=c.__super__.getCollabContent.apply(this,[f,b]),window.JSON.stringify(d)},getModifiers:function(a,b){var d,f=this,g=r.parseToNumber(a),h=function(a){f.trigger("callback-to-native",b,[window.JSON.stringify(a)])};return e.isNaN(g)&&f.trigger("callback-to-native",b,[window.JSON.stringify({status:2,errorCode:1})]),d=c.__super__.getModifiers.apply(f,[g,h]),window.JSON.stringify(d)},isReadyToClose:function(){return this._editor.isLegacyHost()?c.__super__.isReadyToClose.apply(this):void d.debugAlert("isReadyToClose should not be invoked after PC6.0")},resetEditorOptions:function(a){var b=this,f=a;if(!b._editor.isLegacyHost())return void d.debugAlert("resetEditorOptions should not be invoked after PC6.0");e.isString(f)&&(f=window.JSON.parse(a)),e.isString(f.collabServer)&&(f.collabServer=window.JSON.parse(f.collabServer)),e.isString(f.userInfo)&&(f.userInfo=window.JSON.parse(f.userInfo)),f.isCollabEnabled=r.parseToBoolean(f.isCollabEnabled,!1),c.__super__.resetEditorOptions.apply(b,[f])},reset:function(a){var b=this;c.__super__.reset.apply(this),a&&b._editor.isLegacyHost()&&b.resetEditorOptions(a)},saveNotification:function(a,b){var d=this,f=r.parseToNumber(a),g=r.parseToBoolean(b);if(e.isNaN(f)||null===g)throw"invalid format of savedNoteVersion/isHistorySave"+a+"/"+b;c.__super__.saveNotification.apply(d,[f,g])},toggleAttendeeHint:function(a){var b=this,e=r.parseToBoolean(a);if(!b._editor.isLegacyHost())return void d.debugAlert("toggleAttendeeHint should not be invoked after PC6.0");null===e&&(e=!0),c.__super__.toggleAttendeeHint.apply(b,[e])},toggleToolbar:function(a){this._editor.toggleToolbar(a)},initializeEditor:function(a){var b,c,f=this,g=0,h=f._editor;try{if(!0===f._initializedByPC)return b="initializeEditor should only be called for one time",void d.debugAlert(b);c=window.JSON.parse(a),isNaN(f.options.buildVersion)&&(d.error("Invalid buildVersion:",f.options.buildVersion),f.options.buildVersion=922337203685477e4),c=e.defaults(c,{buildVersion:f.options.buildVersion,backgroundURIJSON:[],shortCutsJSON:[],viewMode:0,pageType:v.PAGE_TYPE_A4,sessionId:q.newGUID()}),c.defaultFontSize=r.parseToNumber(c.defaultFontSize),h.updateEditorProps(c),h.setDefaultFont(c.defaultFontName,c.defaultFontSize),h.setAllBackgrounds(JSON.stringify(c.backgroundURIJSON),c.isVIPUser),f._setShortCut(c.shortCutsJSON),h.setViewMode(c.viewMode,!0,!1),h.showSaveSyncButton(!!c.showSaveSyncButton),h.setZoomPercent(c.zoomValue,c.isZoomPercent),g=1,f._initializedByPC=!0}catch(a){b="initializeEditor API:"+a.message,d.error(b),h.trigger("yne-log-to-native",0,b)}return g},closeCollabSession:function(){var a=this;c.__super__.closeCollabSession.apply(a),a._editor.toggleStats(!1)},updateUserInfo:function(a){var b=JSON.parse(a);this._editor.updateUserInfo(b)},_setContentCallBack:function(a){var b=this;b._editor.isLegacyHost()||b.trigger("callback-to-native",a.callbackUID,[{resultCode:a.resultCode,message:a.message,isXml:!!a.isXml,hasHandWrite:!!a.hasHandWrite}])},_setShortCut:function(a){var b=this,c=b._editor,d=function(a){var b=[],c=a.keyCode,d=e.isNumber(c)?j.getKey(c):c;if(d)return d=(d+"").toLowerCase(),e.each(["ctrl","alt","shift"],function(c){!0===a[c]&&b.push(c)}),b.push(d),b.join("+")};a&&a.length&&e.each(a,function(a){if(a.name){if(0===a.keyCode)return void c.removeShortCut(a.name);var b=d(a);b&&c.updateShortCut(a.name,b)}})},_updateImage:function(a,b,c,f,h,i,j){if(b||c){var k,l=this._editor,m=l.note,n=[];if(h){if(!(k=m.getBlockById(h))||!g.isImage(k))return;n=[k]}else n=m.getImageBySource(a,!1);if(!n||!n.length)return void d.warn("Can not find image by source: "+a);f=!1!==f,e.each(n,function(a){f?(b=b||a.getSource(),c&&l.updateResMapWithKey(b,c,!1),l.execCommand("comp.ReplaceResource",{resources:[a],resProps:[{source:b}],heights:[j],widths:[i]})):(b&&a.setSource(b),c&&l.updateResMapWithKey(b||a.getSource(),c,!0))})}},insertTodo:function(){this._editor.execCommand("comp.InsertTodo",{checked:!1})},getNativeDisabledToolbarItemNames:function(){var a,b,c=this._editor.getNoteRange(),d={};return c&&(b=c.getStartBlockRange().block,g.isHeaderFooter(b)?e.extend(d,n.NATIVE_HEADER_FOOTER_DISABLED_MAP):c.isSingleTableSelected()?a=!0:g.isCatalogue(b)&&e.extend(d,n.NATIVE_CATALOGUE_DISABLED_MAP)),this._editor.hasHandWriteBlock()&&e.extend(d,n.NATIVE_HANDWRITE_DISABLED_MAP),a&&e.extend(d,n.NATIVE_TABLE_DISABLED_MAP),JSON.stringify(e.keys(d))}},b=c,c=u.extend(b)}(),yne_common_io_eventList=["content-change","insert-photo","insert-link","insert-attachment","replace-image","replace-attachment","open-link","download-attachment","download-image","preview-image","context-menu","show-words","save-content","blob-paste","upload-image","clipboard-error","background-failed-update","background-changed","is-vip-user","table-click","image-ocr","collabsession-change","datacommand-success","session-built","session-closed","session-initialized","useraction-failed","user-action-collection","view-mode-change","note-version-change"],yne_pc_io_eventList=function(a){var b=yne_underscore,c=yne_common_io_eventList,d=["content-set","open-image","open-attachment","on-paste","snap-screen","clipboard-status","require-paste","edit-link","click","find","check-image","export-pdf","export-word","download-file","exit-full-screen","exit-presentation","save-and-sync","get-clipboard","share-note","clipboard-set","rotate-image","zoom-changed","log-to-native","user-action-collection","image-ocr"];return b.union(d,c)}(),yne_pc_BulbEditor=function(a){var b=yne_backbone,c=yne_pc_core_PcEditor,d=yne_underscore,e=yne_jtk_core_L,f=yne_pc_io_editorApi,g=yne_pc_io_eventList,h={};return d.extend(h,{_initializedByPC:!1,initialize:function(a){var b,f=this,h=[];if(a=d.defaults(a||{},{parentEl:null,render:!0}),a.render&&!a.parentEl)throw"BulbEditor need `parentEl`!";f._editor=b=new c({parentEl:a.parentEl}),a.render&&b.render(),d.each(g,function(a){if(h.indexOf(a)>-1)return void e.error("The event ["+a+"] has already bound");var c="yne-"+a;"collabsession-change"===a&&b.isLegacyHost()?b.bind(c,function(a){b.updateAttendees(a)}):b.bind(c,function(){f.trigger.bind(f,a).apply(f,arguments)}),h.push(a)})},updateResMapWithKey:function(){var a=this._editor;a.updateResMapWithKey.apply(a,arguments)},getBlockById:function(){var a=this._editor,b=a.note;return b.getBlockById.apply(b,arguments)},toggleStats:function(a){this._editor.toggleStats(a)}},b.Events),f.extend(h)}(),yne_pc_io_nativeApiInterface={Ready:function(a,b){},PasteAsText:function(){},PasteNoteLink:function(){},ClipboardAvailable:function(){},IsNoteLinkInClipboard:function(){},OnDocumentChange:function(){},OnAreaClick:function(){},OpenLink:function(a){},OpenNote:function(a){},OpenImage:function(a){},Paste:function(){},CtxMenu:function(a){},InsertAttachments:function(a){},ReplaceAttachments:function(a,b,c){},FindText:function(){},OpenAttachment:function(a,b,c){},SaveImage:function(a){},SaveAsAttachment:function(a){},CloneAttachmentAsync:function(a,b){},SaveImageToNote:function(a,b){},IsImageSavedToNote:function(a,b){},ShowInsertLinkDialogAsync:function(a){},GetFocus:function(){},ReloadEditor:function(){},SnapScreen:function(a){},OnCopy:function(a){},Log:function(a,b){},NoteEditorActionCollection:function(a){},LOG_TEST:4,LOG_DEBUG:3,LOG_INFO:2,LOG_WARN:1,LOG_FATAL:0,ShowNoteCharNum:function(a,b){},OnDrop:function(a,b){},ShowShareMenu:function(){},Export2PDF:function(){},Export2Word:function(){},DownloadOriginFile:function(){},ExitFullScreen:function(){},ExitPresentation:function(){},PageModeChanged:function(a){},StartSync:function(){},GetClipboardData:function(a){},RotateImage:function(a,b,c){},OnChangeZoomByEditor:function(a){},ChangeBGImage:function(a,b){},ChangeBGImageFailed:function(a){},IsVIPUser:function(){},OnCollabSessionChange:function(){},OnDataCommandSuccess:function(a){},OnSessionBuilt:function(a){},OnSessionClosed:function(a){},OnSessionInitialized:function(a,b){},OnUserActionFailed:function(a){},EditorCallBack:function(a){},GetVersion:function(){},ImageOCR:function(a){}},yne_pc_io_Bridge=function(a){var b,c=yne_underscore,d=yne_jtk_core_Class,e=yne_backbone,f=yne_jtk_core_L,g=yne_pc_io_nativeApiInterface,h=c.keys(g),i=function(a){return a=a.toString(),a=a.substr(0,100),a.replace(/%/g,function(){return"%%"})};return b=c.extend({_legacyAPIs:["ExitFullScreen"],initialize:function(a){var b=this;b._editor=a.editor,b._hasReadyRun=!1,b._nativeApiObj=window.YNote||{}},execEditorApi:function(a,b){var c,d,e=this,g=e._editor,h=Date.now(),i="EditorApi."+a;if(f.log("execEditorApi "+a,b),!g[a])return d="Editor does not implement api: "+a,f.error(d),e.callNativeApi("Log",[e._nativeApiObj.LOG_FATAL,d]),c;if(f.DEBUG)f.profile(i),f.time(i),c=g[a].apply(g,b);else try{c=g[a].apply(g,b)}catch(b){d="Failed to execute EditorAPI:"+a,f.error(d,b),e.callNativeApi("Log",[e._nativeApiObj.LOG_FATAL,d])}return f.DEBUG&&(f.timeEnd(i),f.profileEnd(i)),e.callNativeApi("Log",[e._nativeApiObj.LOG_TEST,"@@ANALYSIS@@ javascript:"+a+"="+(Date.now()-h)]),c},callNativeApi:function(a,b){var c,d,e=this,g=e._nativeApiObj,j="nativeApi."+a;return-1===h.indexOf(a)?void f.error("The native api ["+a+"] is not in nativeApiInterface.js"):(f.log("Executing native Api:"+a,b),c=g[a],c?(f.DEBUG&&(f.profile(j),f.time(j)),"Log"===a?b[1]=i(b[1]):e._logMethodInfoToNative(a,b),d=c.apply(g,b||[]),f.DEBUG&&(f.timeEnd(j),f.profileEnd(j))):f.error("no native api: "+a),d)},asyncCallNativeApi:function(a,b,c){var d,e=this,f="on"+a;e.off(f),"function"==typeof b&&(c=b,b=[]),d=function(){e.off(f,d),c.apply(null,arguments)},e.on(f,d,e),e._nativeApiObj[a].apply(e._nativeApiObj,b)},ready:function(){var a=this;a._hasReadyRun||(a._hasReadyRun=!0,a._checkNativeApi(),a._nativeApiObj.Ready(a.execEditorApi.bind(a),document))},_checkNativeApi:function(){var a=this,b=a._nativeApiObj,d=[];c.each(h,function(c){null==b[c]&&(a._editor._editor.isLegacyHost()||-1===a._legacyAPIs.indexOf(c))&&(d.push(c),f.error("Native does not implement api: "+c))}),f.DEBUG&&d.length>0&&(d=d.join("\n - "),window.alert("No native apis: \n - "+d))},_logMethodInfoToNative:function(a,b){var d=this,e="NativeAPI:"+a;b&&b.length>0&&c.each(b,function(a){e=e+"#"+i(a)}),d._nativeApiObj.Log.apply(d._nativeApiObj,[4,e])}},e.Events),d.extend(b)}(),yne_pc_io_ImageSaver=function(a){var b=yne_underscore,c=yne_jtk_core_Base,d=function(a){var b=a.lastIndexOf("\\");if(-1!==b)return{path:a.substring(0,b+1),fileName:a.substring(b+1)}};return c.extend({_noteId:null,_xhr:null,_fileReader:null,_queue:null,_savingItem:null,_cacheData:null,initialize:function(){var a=this;a._queue=[],a._cacheData={}},updateNoteId:function(a){var c=this;a&&(c._noteId=a,c._queue=b.filter(c._queue,function(b){return b.noteId===a}),c._cacheData={},c._resetSaveProgress())},addImgInfo:function(a,c){if(c&&a){var d=this;d._noteId===c&&(b.isArray(a)||(a=[a]),b.each(a,function(a){if(a&&a.source&&a.extraSource&&a.blockId){var e=b.find(d._queue,function(b){return a.blockId===b.blockId});e?(e.source=a.source,e.extraSource=a.extraSource,e.encode=!1):d._queue.push({source:a.source,extraSource:a.extraSource,blockId:a.blockId,noteId:c,encode:!1})}}))}},startSave:function(){var a,b,c,d=this;if(!d._savingItem){for(a=d._queue;a&&a.length&&(!b||b.noteId!==d._noteId);)b=a.shift();if(b){if(c=d._cacheData[b.extraSource])return d.trigger("save-image",c,b),void d.startSaveWithDelay();d._loadItem(b)}}},startSaveWithDelay:function(a){var b=this;a=a||100,window.setTimeout(function(){b.startSave()},a)},_resetSaveProgress:function(){var a=this;a._xhr&&(a._xhr.onload=null,a._xhr.abort(),a._xhr=null),a._fileReader&&(a._fileReader.onload=null,a._fileReader.abort(),a._fileReader=null),a._savingItem=null},_loadItem:function(a){var b,c=this;c._resetSaveProgress(),c._xhr=b=new XMLHttpRequest,b.responseType="blob",c._savingItem=a,b.onload=c._xhrOnLoadEnd.bind(c),b.open("GET",a.extraSource,!0),b.send()},_xhrOnLoadEnd:function(){var a,b=this,c=b._xhr,e=b._savingItem,f=e.noteId,g=b._noteId===f;if(!c.response||!g)return g&&!1===e.encode&&(a=d(e.extraSource))&&b._queue.unshift({source:e.source,extraSource:a.path+window.encodeURIComponent(a.fileName),blockId:e.blockId,noteId:f,encode:!0}),b._resetSaveProgress(),void b.startSaveWithDelay();b._fileReader=new FileReader,b._fileReader.onload=function(){var a=this;a.result&&b._noteId===f&&b._saveData(a.result,e),b._resetSaveProgress(),b.startSaveWithDelay()},b._fileReader.readAsDataURL(c.response)},_saveData:function(a,b){var c=this;c._cacheData[b.extraSource]=a,c.trigger("save-image",a,b)},stopSave:function(){this._resetSaveProgress()}})}(),yne_pc_init_pc=function(a){var b,c,d,e,f=yne_jtk_core_L,g=yne_pc_BulbEditor,h=yne_pc_io_Bridge,i=yne_pc_io_ImageSaver,j=yne_common_data_blockTypes,k=yne_underscore,l=yne_jquery,m=function(a){if(a){a+="";var b,c,d=a.indexOf(":");if(-1!==d&&(b=a.substring(0,d),c=a.substring(d+1),b&&c))return{source:b,localSource:c}}},n=/^http/i.test(window.location.href);b=new g({parentEl:document.body,render:!0,buildVersion:"1508402138000"}),c=new h({editor:b}),d=new i,d.on("save-image",function(a,d){var e,f=c.callNativeApi("SaveImageToNote",[d.extraSource,a]),g=m(f);g&&(e=b.getBlockById(d.blockId))&&j.isImage(e)&&(b.updateResMapWithKey(g.source,g.localSource,!1),e.setSource(g.source),c.callNativeApi("OnDocumentChange"))}),b.on("content-set",function(a,b){d.updateNoteId(a);var e=k.filter(b,function(a){return!c.callNativeApi("IsImageSavedToNote",[a.extraSource,a.source])});d.addImgInfo(e,a),d.startSaveWithDelay()}).on("check-image",function(a,b){var e=k.filter(b,function(a){return!c.callNativeApi("IsImageSavedToNote",[a.extraSource,a.source])});d.addImgInfo(e,a),d.startSave()}).on("content-change",k.debounce(function(){c.callNativeApi("OnDocumentChange")},100)).on("context-menu",function(a,b,d){e=d;var f={ITEM:0,SUBMENU:1,CHECK:2,SPAN:3},g={ITEM:0,SUBMENU:1,SPLIT:2};k.each(b,function(a){a.type===g.SPLIT&&(a.type=f.SPAN),a.key||(a.key="")}),c.callNativeApi("CtxMenu",[b])}).on("insert-photo",function(){c.callNativeApi("InsertAttachments",["image"])}).on("insert-attachment",function(){c.callNativeApi("InsertAttachments",[])}).on("insert-link",function(a){c.asyncCallNativeApi("ShowInsertLinkDialogAsync",["http://"],a)}).on("show-words",function(a,b){c.callNativeApi("ShowNoteCharNum",[a,b])}).on("download-image",function(a){c.callNativeApi("SaveImage",[a])}).on("download-attachment",function(a,b){c.callNativeApi("SaveAsAttachment",[a,b])}).on("replace-attachment",function(a,b,d){c.callNativeApi("ReplaceAttachments",[d,"",b])}).on("replace-image",function(a,b,d){c.callNativeApi("ReplaceAttachments",[d,"image",b])}).on("on-paste",function(a,b){var d=[];f.DEBUG&&n&&d.push(b),a?c.callNativeApi("PasteAsText",d):c.callNativeApi("Paste",d)}).on("snap-screen",function(a){var b={snap:"normal","snap-x":"hide"},d=b[a]||b.snap;c.callNativeApi("SnapScreen",[d])}).on("clipboard-status",function(a){a(c.callNativeApi("ClipboardAvailable"),c.callNativeApi("IsNoteLinkInClipboard"))}).on("require-paste",function(a,b){if(!0===b)return void c.callNativeApi("PasteAsText",[]);!0===a?c.callNativeApi("PasteNoteLink",[]):c.callNativeApi("Paste",[])}).on("open-link",function(a,b){a=l.trim(a),b?c.callNativeApi("OpenNote",[a]):c.callNativeApi("OpenLink",[a])}).on("open-image",function(a){c.callNativeApi("OpenImage",[a])}).on("open-attachment",function(a,b){c.callNativeApi("OpenAttachment",[a,"",b])}).on("edit-link",function(a,b){var d=a.href;c.asyncCallNativeApi("ShowInsertLinkDialogAsync",[d],b)}).on("click",function(){c.callNativeApi("OnAreaClick")}).on("find",function(){c.callNativeApi("FindText")}).on("export-pdf",function(){c.callNativeApi("Export2PDF")}).on("export-word",function(){c.callNativeApi("Export2Word")}).on("download-file",function(){c.callNativeApi("DownloadOriginFile")}).on("exit-full-screen",function(){c.callNativeApi("ExitFullScreen")}).on("exit-presentation",function(){c.callNativeApi("ExitPresentation")}).on("view-mode-change",function(a){c.callNativeApi("PageModeChanged",[a])}).on("save-and-sync",function(){c.callNativeApi("StartSync")}).on("clipboard-error",function(a){f.warn("clipboard error: "+a)}).on("get-clipboard",function(a,b){var d={};k.each(a,function(a){d[a]=c.callNativeApi("GetClipboardData",[a])}),b(d)}).on("share-note",function(){c.callNativeApi("ShowShareMenu")}).on("clipboard-set",function(a){window.setTimeout(function(){c.callNativeApi("OnCopy",[!0===a])},25)}).on("rotate-image",function(a,b,d){c.callNativeApi("RotateImage",[a,b,d])}).on("zoom-changed",function(a){c.callNativeApi("OnChangeZoomByEditor",[a])}).on("background-changed",function(a,b){c.callNativeApi("ChangeBGImage",[a,b])}).on("background-failed-update",function(a){c.callNativeApi("ChangeBGImageFailed",[a])}).on("is-vip-user",function(a){a(c.callNativeApi("IsVIPUser"))}).on("log-to-native",function(a,b){b="EDITOR_LOG:"+b,c.callNativeApi("Log",[a,b])}).on("user-action-collection",function(a){c.callNativeApi("NoteEditorActionCollection",[a])}),b.on("bridge-event",function(a){c.trigger.apply(c,a)}).on("select-context-menu",function(a){e&&e(a)}).on("bridge-off-events",function(){c.off()}).on("callback-to-native",function(a,b){null!=a&&""!==a&&(b=b||[],b.unshift(a),c.callNativeApi("EditorCallBack",b))}).on("image-ocr",function(a){c.callNativeApi("ImageOCR",[a])}),b.on("collabsession-change",function(a){var b=window.JSON.stringify(a);c.callNativeApi("OnCollabSessionChange",[b])}),b.on("datacommand-success",function(a){c.callNativeApi("OnDataCommandSuccess",[a])}),b.on("session-built",function(a){f.log("session-built:",a),c.callNativeApi("OnSessionBuilt",[a]),b.toggleStats(!0)}),b.on("session-closed",function(a){f.log("session-closed:",a),c.callNativeApi("OnSessionClosed",[window.JSON.stringify(a)]),b.toggleStats(!1)}),b.on("session-initialized",function(a,b){f.log("session-initialized:",a,b),c.callNativeApi("OnSessionInitialized",[a,window.JSON.stringify(b)])}),b.on("useraction-failed",function(a){f.log("useraction-failed:",a),c.callNativeApi("OnUserActionFailed",[a])}),f.DEBUG&&(window.debugBridge=c,window.debugEditor=b),c.ready(document,b)}();